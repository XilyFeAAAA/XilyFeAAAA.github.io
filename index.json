[{"categories":null,"content":"PPO ç®—æ³•æˆ‘ä»¬ä¹‹å‰èŠè¿‡ï¼Œå®ƒéœ€è¦åŒæ—¶åŠ è½½å››ä¸ªæ¨¡å‹ï¼ˆActorã€Criticã€Reward Modelã€Ref Modelï¼‰ï¼Œæ˜¾å­˜éœ€æ±‚æå¤§ï¼Œè¿˜éœ€è¦å•ç‹¬è®­ç»ƒ Reward Model å’Œ Critic Modelã€‚ è€Œ DPO åªéœ€ 2 ä¸ªæ¨¡å‹ï¼šå¾…ä¼˜åŒ–çš„ Actor Model ($Ï€_Î¸$) å’Œå†»ç»“çš„ Reference Model ($Ï€_{ref}$)ã€‚DPO ä¸å¯¹ prompt+response æ‰“åˆ†ï¼Œè€Œæ˜¯ç›´æ¥è®©æ¨¡å‹å­¦ä¹ åŒºåˆ† good answer ($y_w$) å’Œ bad answer ($y_l$)ã€‚DPO çš„æœ¬è´¨å°±æ˜¯æŠŠ reward model éšå¼åœ°å‚æ•°åŒ–è¿›äº† policy æœ¬èº«ï¼Œä»è€Œä¸€æ­¥åˆ°ä½å®Œæˆå¯¹é½ã€‚ DPO å’Œ PPO ç®—æ³•çš„æ ¸å¿ƒä¼˜åŒ–ç›®æ ‡éƒ½æ˜¯ï¼š maxâ¡Ï€Exâˆ¼D,yâˆ¼Ï€[rÏ•(x,y)]âˆ’Î²DKL[Ï€(yâˆ£x)âˆ¥Ï€ref(yâˆ£x)] \\max_{\\pi} \\mathbb{E}_{x \\sim \\mathcal{D}, y \\sim \\pi} \\left[ r_\\phi(x, y) \\right] - \\beta \\mathbb{D}_{\\text{KL}} \\left[ \\pi(y | x) \\| \\pi_{\\text{ref}}(y | x) \\right] Ï€maxâ€‹Exâˆ¼D,yâˆ¼Ï€â€‹[rÏ•â€‹(x,y)]âˆ’Î²DKLâ€‹[Ï€(yâˆ£x)âˆ¥Ï€refâ€‹(yâˆ£x)]æˆ‘ä»¬å¸Œæœ›æœ€å¤§åŒ–å¾—åˆ°å¥–åŠ±çš„æœŸæœ›ï¼Œå¹¶ä¸”è®©æ–°è®­ç»ƒçš„æ¨¡å‹å°½å¯èƒ½å’ŒåŸºå‡†æ¨¡å‹åˆ†å¸ƒä¸€è‡´ã€‚æ¥ç€æˆ‘ä»¬å¯¹ä¸Šé¢çš„å¼å­è¿›è¡Œä¸€ç³»åˆ—å˜åŒ–ï¼š maxâ¡Ï€E[r(x,y)âˆ’Î²logâ¡Ï€(yâˆ£x)Ï€ref(yâˆ£x)]â€…âŸºâ€…minâ¡Ï€E[logâ¡Ï€(yâˆ£x)Ï€ref(yâˆ£x)âˆ’r(x,y)Î²]â€…âŸºâ€…minâ¡Ï€E[logâ¡Ï€(yâˆ£x)Ï€ref(yâˆ£x)expâ¡â€‰â£(r(x,y)/Î²)] \\begin{align} \u0026\\max_{\\pi} \\mathbb{E}\\Big[ r(x,y) - \\beta\\log\\frac{\\pi(y|x)}{\\pi_{\\rm ref}(y|x)} \\Big] \\\\ \u0026\\iff \\min_{\\pi} \\mathbb{E}\\Big[ \\log\\frac{\\pi(y|x)}{\\pi_{\\rm ref}(y|x)} - \\frac{r(x,y)}{\\beta} \\Big] \\\\ \u0026\\iff \\min_{\\pi} \\mathbb{E}\\Big[ \\log\\frac{\\pi(y|x)}{\\pi_{\\rm ref}(y|x)\\exp\\!\\big(r(x,y)/\\beta\\big)} \\Big] \\end{align} â€‹Ï€maxâ€‹E[r(x,y)âˆ’Î²logÏ€refâ€‹(yâˆ£x)Ï€(yâˆ£x)â€‹]âŸºÏ€minâ€‹E[logÏ€refâ€‹(yâˆ£x)Ï€(yâˆ£x)â€‹âˆ’Î²r(x,y)â€‹]âŸºÏ€minâ€‹E[logÏ€refâ€‹(yâˆ£x)exp(r(x,y)/Î²)Ï€(yâˆ£x)â€‹]â€‹â€‹åœ¨æ¨å¯¼çš„è¿‡ç¨‹ä¸­æ„å¤–çš„å‘ç°ï¼Œè¿™ä¸ªå½¢å¼å¾ˆåƒ KL æ•£åº¦ï¼Œä½†æ˜¯åˆ†æ¯ $\\sum_y \\pi_{\\text{ref}}(y|x)\\exp(\\tfrac{1}{\\beta}r_\\phi(x,y)) \\neq 1$ ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯ä¸€ä¸ªåˆæ³•æ¦‚ç‡åˆ†å¸ƒã€‚æ‰€ä»¥æˆ‘ä»¬å¸Œæœ›å¯¹åˆ†æ¯è¿›è¡Œå¤„ç†ï¼Œä½¿å®ƒæ»¡è¶³ $\\sum_y q(y|x)=1$ã€‚ =minâ¡Ï€Exâˆ¼D,yâˆ¼Ï€[logâ¡Ï€(yâˆ£x)Ï€ref(yâˆ£x)expâ¡(1Î²rÏ•(x,y))1Z(x)Z(x)]=minâ¡Ï€Exâˆ¼D,yâˆ¼Ï€[logâ¡Ï€(yâˆ£x)1Z(x)Ï€ref(yâˆ£x)expâ¡(1Î²rÏ•(x,y))âˆ’logâ¡Z(x)] \\begin{align} \u0026= \\min_{\\pi} \\mathbb{E}_{x \\sim \\mathcal{D}, y \\sim \\pi} \\left[ \\log\\frac{\\pi(y\\mid x)}{\\pi_{\\text{ref}}(y\\mid x)\\exp(\\frac{1}{\\beta} r_\\phi(x, y))\\frac{1}{Z(x)}Z(x)} \\right] \\\\ \u0026= \\min_{\\pi} \\mathbb{E}_{x \\sim \\mathcal{D}, y \\sim \\pi} \\left[ \\log\\frac{\\pi(y\\mid x)}{\\frac{1}{Z(x)}\\pi_{\\text{ref}}(y\\mid x)\\exp(\\frac{1}{\\beta} r_\\phi(x, y))}-\\log{Z(x)} \\right] \\end{align} â€‹=Ï€minâ€‹Exâˆ¼D,yâˆ¼Ï€â€‹[logÏ€refâ€‹(yâˆ£x)exp(Î²1â€‹rÏ•â€‹(x,y))Z(x)1â€‹Z(x)Ï€(yâˆ£x)â€‹]=Ï€minâ€‹Exâˆ¼D,yâˆ¼Ï€â€‹[logZ(x)1â€‹Ï€refâ€‹(yâˆ£x)exp(Î²1â€‹rÏ•â€‹(x,y))Ï€(yâˆ£x)â€‹âˆ’logZ(x)]â€‹â€‹æˆ‘ä»¬å¸Œæœ›åˆ†æ¯ä¸ºåˆæ³•çš„æ¦‚ç‡åˆ†å¸ƒ $\\sum_y\\frac{1}{Z(x)}\\pi_{\\text{ref}}(y\\mid x)\\exp(\\frac{1}{\\beta} r_\\phi(x, y))=1$ï¼Œç„¶åå°±èƒ½å¾—åˆ°ï¼š Z(x)=âˆ‘yÏ€ref(yâˆ£x)expâ¡â€‰â£(1Î²rÏ•(x,y)) Z(x)=\\sum_y\\pi_{\\text{ref}}(y|x)\\exp\\!\\left(\\frac{1}{\\beta}r_{\\phi}(x,y)\\right) Z(x)=yâˆ‘â€‹Ï€refâ€‹(yâˆ£x)exp(Î²1â€‹rÏ•â€‹(x,y))å› æ­¤åˆ†æ¯å°±å˜æˆäº†ï¼š Ï€âˆ—(yâˆ£x)=1Z(x)â€‰Ï€ref(yâˆ£x)expâ¡â€‰â£(1Î²r(x,y)) \\pi^*(y|x)=\\frac{1}{Z(x)}\\,\\pi_{\\text{ref}}(y|x)\\exp\\!\\left(\\frac{1}{\\beta}r(x,y)\\right) Ï€âˆ—(yâˆ£x)=Z(x)1â€‹Ï€refâ€‹(yâˆ£x)exp(Î²1â€‹r(x,y))ä¼˜åŒ–ç›®æ ‡çš„è¡¨è¾¾å¼å˜æˆäº†ï¼š minâ¡Ï€Exâˆ¼D,yâˆ¼Ï€[logâ¡Ï€(yâˆ£x)Ï€âˆ—(yâˆ£x)âˆ’logâ¡Z(x)] \\min_{\\pi} \\mathbb{E}_{x \\sim \\mathcal{D}, y \\sim \\pi} \\left[ \\log\\frac{\\pi(y\\mid x)}{\\pi^*(y\\mid x)}-\\log{Z(x)} \\right] Ï€minâ€‹Exâˆ¼D,yâˆ¼Ï€â€‹[logÏ€âˆ—(yâˆ£x)Ï€(yâˆ£x)â€‹âˆ’logZ(x)]ç”±äº $Z(x)$ å’Œæˆ‘ä»¬å‡†å¤‡ä¼˜åŒ–çš„æ¨¡å‹ $\\pi$ æ²¡æœ‰å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠåé¢é‚£ä¸€é¡¹ $\\log{Z(x)}$ ç›´æ¥å»æ‰å¾—åˆ°ï¼š =minâ¡Ï€Exâˆ¼D,yâˆ¼Ï€[logâ¡Ï€(yâˆ£x)Ï€âˆ—(yâˆ£x)]=minâ¡Ï€Exâˆ¼D,yâˆ¼Ï€[DKL[Ï€(yâˆ£x)âˆ¥Ï€âˆ—(yâˆ£x)]] \\begin{align} \u0026= \\min_{\\pi} \\mathbb{E}_{x \\sim \\mathcal{D}, y \\sim \\pi} \\left[ \\log\\frac{\\pi(y\\mid x)}{\\pi^*(y\\mid x)}\\right] \\\\ \u0026= \\min_{\\pi} \\mathbb{E}_{x \\sim \\mathcal{D}, y \\sim \\pi} \\left[ \\mathbb{D}_{\\text{KL}} \\left[ \\pi(y | x) \\| \\pi^*(y | x) \\right] \\right] \\end{align} â€‹=Ï€minâ€‹Exâˆ¼D,yâˆ¼Ï€â€‹[logÏ€âˆ—(yâˆ£x)Ï€(yâˆ£x)â€‹]=Ï€minâ€‹Exâˆ¼D,yâˆ¼Ï€â€‹[DKLâ€‹[Ï€(yâˆ£x)âˆ¥Ï€âˆ—(yâˆ£x)]]â€‹â€‹ ä¸ºä»€ä¹ˆè¯´ $\\log Z(x)$ å¯ä»¥ç›´æ¥å»æ‰ï¼Ÿ å› ä¸º $Z(x)$ å’Œæˆ‘ä»¬éœ€è¦ä¼˜åŒ–å¾—åˆ°çš„ $\\pi$ æ²¡æœ‰å…³ç³»ã€‚ä½†æ˜¯æœ‰äººä¼šé—®äº†ï¼Œ$Z(x)$ é‡Œé¢ä¸æ˜¯æœ‰ $r(x,y)$ å—ï¼Ÿå¦‚æœ $r(x,y)$ ä¹Ÿå’Œ $\\pi$ æ— å…³ï¼Œé‚£æˆ‘ä»¬ä¸æ˜¯å¯ä»¥ç›´æ¥åœ¨å‰ä¸€æŠŠç›´æ¥æŠŠ $\\exp!\\left(\\frac{1}{\\beta}r_{\\phi}(x,y)\\right)$ ä»åˆ†æ¯å»æ‰äº†å—ï¼Ÿç¡®å®ï¼Œ$r_{\\phi}$ â€‹ ä¸ä¾èµ–å‚æ•° $Î¸$ï¼Œä½†å®ƒä¾èµ–é‡‡æ ·å˜é‡ $y$ã€‚æˆ‘ä»¬æŠŠç›®æ ‡æ‹†å¼€ï¼š =minâ¡Ï€Exâˆ¼D,yâˆ¼Ï€[logâ¡Ï€(yâˆ£x)Ï€ref(yâˆ£x)expâ¡(1Î²rÏ•(x,y))1Z(x)Z(x)]=minâ¡Ï€Exâˆ¼D,yâˆ¼Ï€[logâ¡Ï€Î¸(yâˆ£x)âˆ’logâ¡Ï€ref(yâˆ£x)âˆ’1Î²rÏ•(x,y)]\\begin{align}\u0026= \\min_{\\pi} \\mathbb{E}_{x \\sim \\mathcal{D}, y \\sim \\pi} \\left[ \\log\\frac{\\pi(y\\mid x)}{\\pi_{\\text{ref}}(y\\mid x)\\exp(\\frac{1}{\\beta} r_\\phi(x, y))\\frac{1}{Z(x)}Z(x)} \\right]\\\\\u0026= \\min_{\\pi} \\mathbb{E}_{x \\sim \\mathcal{D}, y \\sim \\pi}\\left[\\log\\pi_\\theta(y|x)-\\log\\pi_{\\text{ref}}(y|x)-\\frac{1}{\\beta}r_\\phi(x,y)\\right]\\end{align}â€‹=Ï€minâ€‹Exâˆ¼D,yâˆ¼Ï€â€‹[logÏ€refâ€‹(yâˆ£x)exp(Î²1â€‹rÏ•â€‹(x,y))Z(x)1â€‹Z(x)Ï€(yâˆ£x)â€‹]=Ï€minâ€‹Exâˆ¼D,yâˆ¼Ï€â€‹[logÏ€Î¸â€‹(yâˆ£x)âˆ’logÏ€refâ€‹(yâˆ£x)âˆ’Î²1â€‹rÏ•â€‹(x,y)]â€‹â€‹å¯ä»¥çœ‹åˆ° ç¬¬ä¸‰é¡¹ $\\frac{1}{\\beta}r_\\phi(","date":"2026-02-26","objectID":"/posts/rlhf-dpo/:0:0","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šDPO","uri":"/posts/rlhf-dpo/#"},{"categories":null,"content":" å‰ç½®çŸ¥è¯†","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:1:0","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#å‰ç½®çŸ¥è¯†"},{"categories":null,"content":" è¿‘ç«¯ç­–ç•¥ä¼˜åŒ–PPO ç®—æ³•å¯ä»¥çœ‹æˆ A2C çš„ä¼˜åŒ–ç‰ˆã€‚A2Cçš„è®­ç»ƒç­–ç•¥æ˜¯ â€œé‡‡æ ·ä¸€æ¬¡ï¼Œæ›´æ–°ä¸€æ¬¡ï¼Œç„¶åæ‰”æ‰æ•°æ®â€ï¼Œè¿™å°±å¯¼è‡´æ•ˆç‡å¾ˆä½ï¼Œæ¯æ‰¹æ•°æ®åªèƒ½ç”¨ä¸€æ¬¡ã€‚PPO é‡‡ç”¨ è¿‘ç«¯ç­–ç•¥ä¼˜åŒ–ï¼Œå®ƒä¼šå¯¹ä¸€æ‰¹æ•°æ®å…ˆè¿›è¡Œé‡‡æ ·å¾—åˆ° logprobï¼Œref_logprobï¼Œrewardsï¼Œadvantages ç­‰æ•°æ®ï¼Œç„¶åè¿›è¡Œ ppo_epochs æ¬¡å¾ªç¯ã€‚æ¯æ¬¡å¾ªç¯å†…ï¼Œå˜åŒ–çš„åªæœ‰æ¦‚ç‡åˆ†å¸ƒ logprob å’Œ ref_logprob å’Œ valuesï¼Œä¼˜åŠ¿å¥–åŠ±è¿™äº›éƒ½å›ºå®šé‡‡ç”¨ç¬¬ä¸€æ¬¡å¾—åˆ°çš„æ•°æ®ã€‚ ä¸¾ä¸ªä¾‹å­ï¼šA2C å°±åƒåœ¨è¡¨æ¼”ç°åœºï¼Œä½ ä¸€è¾¹æ¼”ï¼Œå¯¼æ¼”ä¸€è¾¹å–Šâ€œå¥½â€æˆ–â€œåâ€ï¼Œç„¶åä½ å¾—åˆ°åé¦ˆå°±ä¿®æ”¹ã€‚æ”¹å®Œä¹‹åï¼Œåˆšæ‰æ¼”çš„é‚£æ®µæˆå°±æ²¡ç”¨äº†ï¼Œä½ å¿…é¡»é‡æ–°æ¼”ä¸€æ®µï¼Œå¯¼æ¼”æ‰èƒ½ç»™æ–°åé¦ˆã€‚è€Œ PPO æ›´åƒ å¤ç›˜å½•åƒï¼Œä½ å…ˆæ¼”ä¸€æ®µæˆå½•ä¸‹æ¥ï¼Œæ¥ä¸‹æ¥çš„ 4 ä¸ª Epoch ä½ ååœ¨ç›‘è§†å™¨å‰ï¼Œå¯¹ç€è¿™æ®µå½•åƒåå¤ç¢ç£¨ã€‚ç¬¬ä¸€éæ ¹æ®åé¦ˆæ”¹ä¸€ç‚¹ï¼Œç¬¬äºŒéåœ¨ç¬¬ä¸€éæ”¹åŠ¨çš„åŸºç¡€ä¸Šï¼Œå†å¯¹ç€å½•åƒå¾®è°ƒã€‚ ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨åŒä¸€æ‰¹æ•°æ®ä¸Šè¿›è¡Œå¤šæ¬¡æ¢¯åº¦ä¸‹é™ï¼Œè¦ä¿æŒ advantage å’Œ rewards ä¸å˜ï¼Ÿæˆ‘ä»¬ä»ä¸¤ä¸ªè§’åº¦è¿›è¡Œåˆ†æã€‚é¦–å…ˆæˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­å¸®æˆ‘ä»¬æŠ½è±¡çš„ç†è§£ä¸€ä¸‹ã€‚å‡å¦‚ä½ æ˜¯ Kobeï¼Œç›´å‡æœºå æ¯å‰è¿˜åœ¨æ¹–äººæ‰“çƒå½•ä¸‹äº†ä¸€ç›˜æ¯”èµ›ã€‚å¦‚ä»Šåœ¨å¤©ä¸Šå¤ç›˜è¿™åœºçƒèµ›ï¼Œå³ä¾¿ä½ ç°åœ¨çƒæŠ€è¿›æ­¥äº†ï¼Œå›çœ‹å½“å¹´çš„å½•åƒï¼Œæ¯ä¸€ä¸ªè¿›çƒåœ¨å½“æ—¶çš„ä»·å€¼ï¼ˆAdvantageï¼‰æ˜¯å®¢è§‚äº‹å®ï¼Œä¸éšä½ ç°åœ¨çš„æ°´å¹³å˜åŒ–ã€‚å…¶æ¬¡ï¼Œå¦‚æœæˆ‘ä»¬ä¸å›ºå®š advantage å’Œ rewardsï¼Œç”¨æ–°çš„ç­–ç•¥æ¥æ›´æ–° advantage å’Œ rewardsï¼Œå¯èƒ½é€ æˆç­–ç•¥åç¦»å¤ªè¿œï¼Œå¯¼è‡´è¿‡æ‹Ÿåˆæˆ–ä¸ç¨³å®šã€‚å¹¶ä¸”æˆ‘ä»¬è®¡ç®—çš„ adv å’Œ reward éƒ½æ˜¯åŸºäº old actor model å¾—åˆ°çš„ï¼Œå‡å¦‚æ¯ä¸ª epoch éƒ½é‡æ–°è®¡ç®—æ–°çš„ adv å’Œ rewardï¼Œç”±äº action æ˜¯åœ¨æ—§çš„ model ä¸Šå¾—åˆ°äº†å°±ä¼šä¸åŒ¹é…ï¼Œå˜æˆ off-policyã€‚è€Œ ppo æ˜¯ on-policyï¼Œclip æœºåˆ¶ï¼ˆåæ–‡ä¼šæåˆ°ï¼‰å°±ä¼šå´©æºƒäº†ã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:1:1","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#è¿‘ç«¯ç­–ç•¥ä¼˜åŒ–"},{"categories":null,"content":" æ›´æ–°çº¦æŸä»–ä¸»è¦æ˜¯è§£å†³äº† A2C è®­ç»ƒä¸ç¨³å®šçš„é—®é¢˜ã€‚åœ¨ A2C ä¸­ï¼Œå¦‚æœå­¦ä¹ ç‡è®¾å¾—ç¨å¾®å¤§ä¸€ç‚¹ï¼Œä¸€æ¬¡æ›´æ–°å¯èƒ½è®©ç­–ç•¥å‘ç”Ÿå¾ˆå¤§çš„å˜åŒ–ï¼Œå¦‚æœ Actor çªç„¶å­¦åˆ°äº†ä¸€ä¸ªæå…¶ç³Ÿç³•çš„åŠ¨ä½œï¼Œæ•´ä¸ªç­–ç•¥å¯èƒ½ç¬é—´å´©å¡Œã€‚ é‚£æˆ‘ä»¬å¦‚ä½•è¡¡é‡ç­–ç•¥çš„å˜åŒ–å¹…åº¦å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹ä¸¤ä¸ªç­–ç•¥æ‰§è¡Œç›¸åŒåŠ¨ä½œå¾—åˆ°ç»“æœçš„å·®åˆ«ã€‚åœ¨ LLM ä¸­å°±æ˜¯ï¼Œæˆ‘ä»¬å¯¹æ›´æ–°å‚æ•°å‰åçš„æ¨¡å‹ p å’Œ pâ€™ éƒ½è¾“å…¥ tokenï¼Œå°±èƒ½å¾—åˆ°çš„ä¸åŒçš„æ¦‚ç‡åˆ†å¸ƒ $p(A_t|S_t)$ å’Œ $pâ€™(A_t|S_t)$ã€‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ¯”ç‡ $r_t(\\theta)$ï¼Œè¡¨ç¤ºæ–°ç­–ç•¥å’Œæ—§ç­–ç•¥äº§ç”ŸæŸä¸ªåŠ¨ä½œçš„æ¦‚ç‡æ¯”ï¼š rt(Î¸)=p(atâˆ£st)pâ€²(atâˆ£st) r_t(\\theta) = \\frac{p(a_t|s_t)}{p'(a_t|s_t)} rtâ€‹(Î¸)=pâ€²(atâ€‹âˆ£stâ€‹)p(atâ€‹âˆ£stâ€‹)â€‹ å¦‚æœ $r_t \u003e 1$ï¼šè¯´æ˜è¿™ä¸ªåŠ¨ä½œåœ¨æ–°ç­–ç•¥ä¸­å‡ºç°çš„æ¦‚ç‡å˜å¤§äº†ã€‚ å¦‚æœ $r_t = 1$ï¼šè¯´æ˜æ–°æ—§ç­–ç•¥å®Œå…¨ä¸€æ ·ã€‚ è¿›è€Œæœ‰äº†æ¼”å‘˜çš„ loss å‡½æ•°ï¼š loss=âˆ’p(Atâˆ£St)pâ€²(Atâˆ£St)Adv(St,At) loss = -\\frac{p(A_t|S_t)}{p'(A_t|S_t)} \\text{Adv}(S_t, A_t) loss=âˆ’pâ€²(Atâ€‹âˆ£Stâ€‹)p(Atâ€‹âˆ£Stâ€‹)â€‹Adv(Stâ€‹,Atâ€‹)æˆ‘ä»¬ä»æ¢¯åº¦æ›´æ–°çš„è§’åº¦æ€è€ƒä¸€ä¸‹è¿™ä¸ªå…¬å¼çš„æ„ä¹‰ï¼Œå…ˆæŠŠå…¬å¼æ”¹ä¸€ä¸‹ $loss = -p(A_t|S_t) \\times \\frac{\\text{Adv}(S_t, A_t)}{pâ€™(A_t|S_t)}$ï¼Œç”±äº adv å’Œ pâ€˜ éƒ½ä¸åœ¨è®¡ç®—å›¾é‡Œé¢ä¸å›ä¼ æ¢¯åº¦ï¼Œæ‰€ä»¥æ¢¯åº¦è¡¨è¾¾å¼ä¸º $\\frac{\\partial{loss}}{\\partial{p}}=- \\frac{\\text{Adv}(S_t, A_t)}{pâ€™(A_t|S_t)}$ã€‚å‡è®¾æŸæ¬¡ action çš„ $Adv\u003e0$ï¼Œä¹Ÿå°±æ˜¯å†³ç­–ä¼˜äºå¹³å‡æ°´å¹³ï¼Œé‚£æˆ‘ä»¬è‚¯å®šå¸Œæœ›æé«˜è¿™ä¸ª action çš„æ¦‚ç‡ï¼Œä¹Ÿå°±æ˜¯å¢åŠ  $p(A_t|S_t)$ã€‚å‡å¦‚åŸå…ˆ $pâ€™(A_t|S_t)$ ä¹Ÿå¾ˆå¤§ï¼Œä¹Ÿå°±æ˜¯åŸå…ˆæ¨¡å‹ä¹Ÿè®¤ä¸ºåº”è¯¥æ‰§è¡Œè¿™ä¸ª actionï¼Œé‚£ä¹ˆæ¢¯åº¦çš„ç»å¯¹å€¼å°±ä¼šå˜å°ï¼Œä¸ä¼šåšå‡ºéå¸¸å¤§æ”¹å˜ã€‚å‡å¦‚åŸå…ˆ $pâ€™(A_t|S_t)$ å¾ˆå°ï¼Œæ—§ç­–ç•¥è§‰å¾—è¿™ä¸ªåŠ¨ä½œå‡ ä¹ä¸å¯èƒ½å‘ç”Ÿï¼Œä½†å®é™…é‡‡æ ·å‡ºæ¥å‘ç°è¿™ä¸ªåŠ¨ä½œæ•ˆæœå‡ºå¥‡çš„å¥½ï¼ˆä¹Ÿå°±æ˜¯Adv å¾ˆå¤§ï¼‰ã€‚é‡è¦æ€§é‡‡æ ·å…¬å¼ $\\frac{p}{pâ€™}$ ä¼šè®¤ä¸ºï¼šè¿™æ˜¯ä¸€ä¸ªè¢«æ—§ç­–ç•¥ä¸¥é‡ä½ä¼°çš„å¥½ actionï¼Œäºæ˜¯ç®—æ³•ä¼šè¯•å›¾å‰§çƒˆåœ°æé«˜ $p(A_t|S_t)$ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»é™åˆ¶äº†ç­–ç•¥Â $p(A_t|S_t)$Â çš„æ›´æ–°å¹…åº¦ï¼Œä½†è¿˜ç¼ºå°‘ä¸€ä¸ªâ€œç†”æ–­æœºåˆ¶â€ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå°±æ˜¯ä¸‡ä¸€ç­–ç•¥çš„æ›´æ–°å¹…åº¦è¿˜æ˜¯å¤ªå¤§äº†ï¼Œæˆ‘ä»¬è¦åœæ­¢ç­–ç•¥çš„å‚æ•°æ›´æ–°ã€‚PPOçš„åšæ³•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºÂ $\\frac{p(A_t|S_t)}{pâ€™(A_t|S_t)}$Â è¡¡é‡äº†æ—§ç­–ç•¥å’Œç°è¡Œç­–ç•¥ä¹‹é—´å·®å¼‚ï¼Œæ‰€ä»¥å¯ä»¥ä¸ºå®ƒè®¾ç½®ä¸¤ä¸ªé˜ˆå€¼ã€‚ä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œæˆ‘ä»¬ä»¤Â $r(A_t, S_t) = \\frac{p(A_t|S_t)}{pâ€™(A_t|S_t)}$ï¼Œè¿™ç§ç†”æ–­æœºåˆ¶å¯ä»¥è¡¨ç¤ºä¸ºï¼š loss=âˆ’minâ¡(r(At,St)Adv(St,At),Â clip(r(At,St),0.8,1.2)Adv(St,At)) loss = -\\min(r(A_t, S_t) \\text{Adv}(S_t, A_t),\\ \\text{clip}(r(A_t, S_t) , 0.8, 1.2) \\text{Adv}(S_t, A_t)) loss=âˆ’min(r(Atâ€‹,Stâ€‹)Adv(Stâ€‹,Atâ€‹),Â clip(r(Atâ€‹,Stâ€‹),0.8,1.2)Adv(Stâ€‹,Atâ€‹)) Adv å¤§äº 0ï¼Œr å¤§äº 1.2ï¼šmin æ“ä½œå°±ä¼šå–å³è¾¹çš„å€¼ï¼Œæ­¤æ—¶ loss ä¸­å°±åªå‰©å¸¸é‡äº†ï¼Œä¸äº§ç”Ÿä»»ä½•æ¢¯åº¦åˆ™åœæ­¢å‚æ•°æ›´æ–°ï¼›è€Œ r æ— è®ºå¤šå°éƒ½è¿˜æ˜¯ä¼šäº§ç”Ÿæ¢¯åº¦ã€‚ Adv å°äº 0ï¼Œr å°äº 0.8ï¼šmin æ“ä½œå°±ä¼šå–å³è¾¹çš„å€¼ï¼Œæ­¤æ—¶ loss ä¸­å°±åªå‰©å¸¸é‡äº†ï¼Œä¸äº§ç”Ÿä»»ä½•æ¢¯åº¦åˆ™åœæ­¢å‚æ•°æ›´æ–°ï¼›è€Œ r æ— è®ºå¤šå¤§éƒ½è¿˜æ˜¯ä¼šäº§ç”Ÿæ¢¯åº¦ è¯¶ï¼Œé‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ç”¨ç®¡ Adv å¤§äº 0 ä¸” r å°äº 0.8 çš„æƒ…å†µï¼Ÿæˆ–è€… Adv å°äº 0 ä¸” r å¤§äº 1.2 çš„æƒ…å†µï¼ŸAdv å¤§äº 0 çš„æƒ…å†µè¯´æ˜å½“å‰ç­–ç•¥æ˜¯å¥½çš„ï¼Œå¦‚æœ r å°äº 0.8 è¯´æ˜ï¼šè¿™ä¸ªç­–ç•¥æ˜¯å¥½çš„ï¼Œæ—§æ¨¡å‹åå‘è¿™ä¸ªç­–ç•¥ï¼Œä½†æ˜¯æ–°æ¨¡å‹ä¸æ€ä¹ˆåå‘è¿™ä¸ªç­–ç•¥äº†ï¼Œé‚£æˆ‘ä»¬è‚¯å®šå¸Œæœ›èƒ½å°½å¯èƒ½æœç°åœ¨è¿™ä¸ªæ–¹å‘æ¥æ›´æ–°å‚æ•°ï¼Œæ‰€ä»¥ä¸ä¼šè¿›è¡Œ $max(r, 0.8)$ã€‚åŒæ · Adv å°äº 0 çš„æƒ…å†µè¯´æ˜å½“å‰ç­–ç•¥ä¸æ€ä¹ˆè¡Œï¼Œå¦‚æœ r å¤§äº 1.2 åˆ™è¯´æ˜è¿™ä¸ªä¸å¥½çš„ç­–ç•¥ç°åœ¨å¾ˆçœ‹å¥½ï¼Œé‚£æˆ‘ä»¬è‚¯å®šå¸Œæœ›åŠ å¤§åŠ›åº¦æ›´æ–°å‚æ•°æ¥é¿å…è¿™ä¸ª actionï¼Œäºæ˜¯ä¸åº”è¯¥é™åˆ¶æ›´æ–°çš„å¹…åº¦ã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:1:2","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#æ›´æ–°çº¦æŸ"},{"categories":null,"content":" Critic lossåœ¨ä¹‹å‰æˆ‘ä»¬æè¿‡ï¼ŒA2C çš„æŸå¤±å‡½æ•°æ˜¯ $loss = [\\text{Adv}(S_t, A_t)] ^2$ã€‚ä½†æ˜¯åœ¨ PPO ä¸­ï¼Œadvantages åœ¨ optimization é˜¶æ®µå°±åº”è¯¥ç”Ÿæˆäº†ï¼Œå¹¶ä¸”åœ¨åé¢å¤šè½®è®­ç»ƒä¸­ä¸å˜æ˜¯ä¸€ä¸ªå®šå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ª loss å®Œå…¨ä¸ä¾èµ–ä¸æ–°çš„ critic æ¨¡å‹çš„å‚æ•°ï¼Œæ— æ³•æ›´æ–° value modelã€‚é‚£æˆ‘ä»¬åº”è¯¥å¦‚ä½•ä¿®æ”¹ critic loss å‘¢ï¼Ÿ æˆ‘ä»¬æ¥è·Ÿç€æœ€è‡ªç„¶çš„æ€è€ƒé¡ºåºï¼Œé¦–å…ˆæˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯è®© critic çš„è¾“å‡º $V(s)$ å¿…é¡»å°½å¯èƒ½æ¥è¿‘çœŸå®çš„çŠ¶æ€ä»·å€¼ï¼š VÏ€(s)=Eaâˆ¼Ï€(â‹…âˆ£s),Â Ï„âˆ¼P[âˆ‘k=0âˆÎ³krt+k] V^\\pi(s) = \\mathbb{E}_{a \\sim \\pi(\\cdot|s),\\ \\tau \\sim P} \\Big[ \\sum_{k=0}^\\infty \\gamma^k r_{t+k} \\Big] VÏ€(s)=Eaâˆ¼Ï€(â‹…âˆ£s),Â Ï„âˆ¼Pâ€‹[k=0âˆ‘âˆâ€‹Î³krt+kâ€‹]å¦‚æœ value ä¼°å¾—å‡†ï¼Œadvantage = q - v å°±ä¼šä½æ–¹å·®ï¼Œactor å°±èƒ½ç¨³å®šåœ°çŸ¥é“â€œå“ªä¸ªåŠ¨ä½œæ¯”å¹³å‡å¥½å¤šå°‘â€ã€‚ æ‰€ä»¥æˆ‘ä»¬å¿…é¡»è®© $V(S_t)$ ä¸æ–­é€¼è¿‘è¿™ä¸ªâ€œçœŸå®å¹³å‡å›æŠ¥â€ã€‚ä½†æ˜¯çœŸå® $V(S_t)$ æ ¹æœ¬æ‹¿ä¸åˆ°ï¼Œäºæ˜¯æˆ‘ä»¬æƒ³åˆ°çŠ¶æ€ä»·å€¼ $V(S_t)$ æ­£å¥½ç­‰äºæ‰€æœ‰å¯èƒ½åŠ¨ä½œçš„åŠ¨ä½œä»·å€¼ $Q(S_t,A_t)$ åœ¨å½“å‰ç­–ç•¥ä¸‹çš„æœŸæœ›ï¼š VÏ€(s)â‰¡Eaâˆ¼Ï€(â‹…âˆ£s)[QÏ€(s,a)] V^\\pi(s) \\equiv \\mathbb{E}_{a \\sim \\pi(\\cdot|s)} \\big[ Q^\\pi(s,a) \\big] VÏ€(s)â‰¡Eaâˆ¼Ï€(â‹…âˆ£s)â€‹[QÏ€(s,a)]ç”±äºæˆ‘ä»¬çš„ advantage æœ¬èº«å®šä¹‰å°±æ˜¯ $Q(S_t,A_t) - V(S_t)$ï¼Œæ‰€ä»¥æˆ‘ä»¬ç§»é¡¹å¯ä»¥å¾—åˆ° $Q(s,a) = V(s) + \\text{Adv}(s,a)$ã€‚åœ¨ PPO ä¸­ï¼Œæˆ‘ä»¬è™½ç„¶æ²¡æœ‰è®­ç»ƒå•ç‹¬çš„ Q ç½‘ç»œï¼Œä½†æˆ‘ä»¬ç”¨ GAE ç®—å‡ºäº†ä¸€ä¸ªé«˜è´¨é‡çš„ Advantage ä¼°è®¡ï¼š AtGAEâ‰ˆQ(st,at)âˆ’Vold(st) A_t^{\\text{GAE}} \\approx Q(s_t, a_t) - V_{\\text{old}}(s_t) AtGAEâ€‹â‰ˆQ(stâ€‹,atâ€‹)âˆ’Voldâ€‹(stâ€‹)å› æ­¤ï¼š Q(st,at)â‰ˆVold(st)+AtGAE Q(s_t, a_t) \\approx V_{\\text{old}}(s_t) + A_t^{\\text{GAE}} Q(stâ€‹,atâ€‹)â‰ˆVoldâ€‹(stâ€‹)+AtGAEâ€‹æˆ‘ä»¬æŠŠè¿™ä¸ªè¿‘ä¼¼å€¼èµ·ä¸ªåå­—å« returnsï¼Œå®ƒå°±æ˜¯æˆ‘ä»¬ç›®å‰èƒ½å¾—åˆ°çš„æœ€å¥½çš„ $Q(S_t,A_t)$ é‡‡æ ·ä¼°è®¡ã€‚å› æ­¤å°±æœ‰äº† critic lossï¼š losscritic=(Vnew(s)âˆ’returns)2 \\text{loss}_{\\text{critic}} = \\left( V_{\\text{new}}(s) - \\text{returns} \\right)^2 losscriticâ€‹=(Vnewâ€‹(s)âˆ’returns)2critic å’Œ actor ä¸€æ ·éƒ½æœ‰å¯¹ loss çš„å˜åŒ–å¹…åº¦åšå‡ºé™åˆ¶ï¼Œcritic é¢„æµ‹çš„æ˜¯ valuesï¼Œæ‰€ä»¥é™åˆ¶äº† $V_{new}$ å’Œ $V_{old}$ çš„å˜åŒ–ï¼š Vclip=Vold+clip(Vnewâˆ’Vold,âˆ’Ïµ,Ïµ) V_{clip} = V_{old} + \\text{clip}(V_{new}-V_{old}, -\\epsilon, \\epsilon) Vclipâ€‹=Voldâ€‹+clip(Vnewâ€‹âˆ’Voldâ€‹,âˆ’Ïµ,Ïµ)å› æ­¤å¾—åˆ°äº†æœ€ç»ˆçš„ critic loss å…¬å¼ï¼š Lvalue=maxâ¡[(Vnew(st)âˆ’returns)2,(Vnew(st)+clip(VÎ¸(st)âˆ’Vold(st),âˆ’Ïµ,Ïµ)âˆ’returns)2] L^{\\text{value}} = \\max\\left[ (V_{\\text{new}}(s_t) - \\text{returns})^2, \\left( V_{\\text{new}}(s_t) + \\text{clip}(V_\\theta(s_t) - V_{\\text{old}}(s_t), -\\epsilon, \\epsilon) - \\text{returns} \\right)^2 \\right] Lvalue=max[(Vnewâ€‹(stâ€‹)âˆ’returns)2,(Vnewâ€‹(stâ€‹)+clip(VÎ¸â€‹(stâ€‹)âˆ’Voldâ€‹(stâ€‹),âˆ’Ïµ,Ïµ)âˆ’returns)2]è¿™é‡Œè¿˜æ˜¯è§£é‡Šä¸€ä¸‹ï¼šé¦–å…ˆ critic loss æ˜¯åœ¨åšä¸€ä¸ªå›å½’ï¼Œæˆ‘ä»¬ç”¨äº† MSEï¼Œå¸Œæœ›æ–°æ¨¡å‹çš„é¢„æµ‹å€¼ $V_{\\text{new}}$ å°½å¯èƒ½æ¥è¿‘ç›®æ ‡å€¼ $V_{target}$ ä¹Ÿæ˜¯å°± returnsã€‚ä¸ºäº†é˜²æ­¢ä»·å€¼å‡½æ•°æ›´æ–°å¤ªå¿«å¯¼è‡´ç­–ç•¥å´©æºƒï¼ŒPPO ç»™ critic model ä¹ŸåŠ äº†ä¸€ä¸ª max æ¥é™åˆ¶æ›´æ–°ã€‚å½“ $V_{\\text{new}}$ åœ¨ $[V_{old}-\\epsilon, V_{old}+\\epsilon]$ è¿™ä¸ªåŒºé—´æ—¶å€™ $V_{\\text{clip}} = V_{\\text{new}}$ æ­£å¸¸æ›´æ–°ï¼›å½“ $V_{\\theta} \u003e V_{old} + \\epsilon$ï¼Œæˆªæ–­é¡¹é‡Œçš„é¢„æµ‹å€¼ä¼šè¢«é”å®šåœ¨ $V_{\\text{clip}} = V_{old} + \\epsilon$ã€‚å‡å¦‚ $V_{\\text{new}}$ æ¯” $V_{\\text{clip}}$ æ›´æ¥è¿‘ returnsï¼Œé‚£ä¹ˆè¯´æ˜ä¸€æ¬¡æ„å¤–çš„æ›´æ–°ï¼ˆ$V_{\\text{new}}$ è¶…è¿‡ä¸Šç•Œäº†ï¼‰å¯¼è‡´ loss æ›´ä½äº†ï¼Œæˆ‘ä»¬å°±å¾—åšå‡ºé™åˆ¶ä¸èƒ½è®©ä»–æ›´æ–°ï¼Œmax å°±ä¼šé€‰æ‹© $(V_{\\text{clip}} - \\text{returns})^2$ é‡Œé¢ä¸å«å‚æ•°ã€‚å¦‚æœ $V_{\\text{clip}}$ æ¯” $V_{\\text{new}}$ æ›´æ¥è¿‘ returnsï¼Œé‚£ä¹ˆé€‰æ‹©çš„å°±æ˜¯ $(V_{\\text{new}} - \\text{returns})^2$ æ­£å¸¸æ›´æ–°äº†ã€‚åŒç† $V_{\\theta} \u003c V_{old} + \\epsilon$ ä¹Ÿæ˜¯è¿™æ ·ï¼ŒçœŸçš„å¾ˆå·§å¦™ã€‚ å½’æ ¹ç»“åº•ï¼Œactor loss å’Œ critic loss é‡Œé¢çš„ clip + min(max) éƒ½æ˜¯æ¨¡å‹ä¸ºäº†é˜²æ­¢è¿‡åº¦ä¼˜åŒ–åšå‡ºçš„ æ‚²è§‚ä¼°è®¡ã€‚actor model æ„å›¾æœ€å¤§åŒ–æŸå¤±å‡½æ•° $\\text{ratio} * \\text{advantages}$ æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšä¸€ä¸ª min çš„æ“ä½œï¼Œè€Œ critic model æŸå¤±å‡½æ•°çš„å‡æ–¹å·®æ„å›¾æ˜¯æœ€å°åŒ– $V_{\\text{new}}$ å’Œ $\\text{returns}$ çš„å·®è·ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‚²è§‚ä¼°è®¡æ—¶å€™è¦åš max æ“ä½œã€‚ PSï¼šå…·ä½“ä»£ç å®ç°ä¸Šï¼Œç”±äºæ¢¯åº¦ä¸‹é™ä¸€èˆ¬éœ€è¦è®©æŸå¤±å‡½æ•°æ±‚æœ€å°å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ actor model çš„ loss é‡Œé¢ä¼šåŠ ä¸Šè´Ÿå·å˜æˆ $-\\text{ratio} * \\text{advantages}$ï¼Œå¯èƒ½åšçš„æ˜¯ max æ“ä½œï¼Œä¸è¿‡éƒ½æ˜¯ä¸€ä¸ªæ€æƒ³ã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:1:3","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#critic-loss"},{"categories":null,"content":" Reward Lossåœ¨è®² Reward Loss ä¹‹å‰éœ€è¦å…ˆä»‹ç»ä¸€ä¸ª Bradley-Terry æ¨¡å‹ï¼Œå®ƒæ˜¯ä¸€ç§ç»å…¸çš„æ¦‚ç‡æ¨¡å‹ï¼Œç”¨äºå¤„ç†æˆå¯¹æ¯”è¾ƒå’Œæ’åé—®é¢˜ã€‚BT æ¨¡å‹å‡è®¾æ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªéšå«çš„â€œå¼ºåº¦â€æˆ–â€œåˆ†æ•°â€å‚æ•°ï¼Œé€šå¸¸ç”¨ $\\pi$ è¡¨ç¤ºã€‚å½“æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡ $i$ å’Œ $j$ æ—¶ï¼Œ$i$ ä¼˜äº $j$ çš„æ¦‚ç‡è®¡ç®—å…¬å¼ä¸ºï¼š P(i\u003ej)=Ï€iÏ€i+Ï€j P(i \u003e j) = \\frac{\\pi_i}{\\pi_i + \\pi_j} P(i\u003ej)=Ï€iâ€‹+Ï€jâ€‹Ï€iâ€‹â€‹æˆ‘ä»¬å…ˆä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡å¦‚æˆ‘ä¸€ä¸ªå¯¹æˆ˜æ•°æ®ï¼š å¯¹æˆ˜ èƒœåˆ© å¤±è´¥ A å¯¹ B 8 4 A å¯¹ C 3 5 é‚£æˆ‘ä»¬åˆ©ç”¨æœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼ˆè¿™æ‰¹èƒœè´Ÿæ•°æ®å‡ºç°çš„æ¦‚ç‡æœ€å¤§ï¼‰ï¼Œæ¥æ‰¾åˆ° $\\alpha_a$ï¼Œ$\\alpha_b$ï¼Œ$\\alpha_c$ï¼š L=(Î±AÎ±A+Î±B)8Ã—(Î±BÎ±A+Î±B)4Ã—(Î±AÎ±A+Î±C)3Ã—(Î±CÎ±A+Î±C)5 L = \\left(\\frac{\\alpha_A}{\\alpha_A+\\alpha_B}\\right)^8 \\times \\left(\\frac{\\alpha_B}{\\alpha_A+\\alpha_B}\\right)^4 \\times \\left(\\frac{\\alpha_A}{\\alpha_A+\\alpha_C}\\right)^3 \\times \\left(\\frac{\\alpha_C}{\\alpha_A+\\alpha_C}\\right)^5 L=(Î±Aâ€‹+Î±Bâ€‹Î±Aâ€‹â€‹)8Ã—(Î±Aâ€‹+Î±Bâ€‹Î±Bâ€‹â€‹)4Ã—(Î±Aâ€‹+Î±Câ€‹Î±Aâ€‹â€‹)3Ã—(Î±Aâ€‹+Î±Câ€‹Î±Câ€‹â€‹)5ç„¶åæˆ‘ä»¬æ±‚å¯¹æ•°å¾—åˆ°ï¼š lnâ¡L=8lnâ¡(Î±AÎ±A+Î±B)+4lnâ¡(Î±BÎ±A+Î±B)+3lnâ¡(Î±AÎ±A+Î±C)+5lnâ¡(Î±CÎ±A+Î±C) \\ln L = 8\\ln\\left(\\frac{\\alpha_A}{\\alpha_A+\\alpha_B}\\right) + 4\\ln\\left(\\frac{\\alpha_B}{\\alpha_A+\\alpha_B}\\right) + 3\\ln\\left(\\frac{\\alpha_A}{\\alpha_A+\\alpha_C}\\right) + 5\\ln\\left(\\frac{\\alpha_C}{\\alpha_A+\\alpha_C}\\right) lnL=8ln(Î±Aâ€‹+Î±Bâ€‹Î±Aâ€‹â€‹)+4ln(Î±Aâ€‹+Î±Bâ€‹Î±Bâ€‹â€‹)+3ln(Î±Aâ€‹+Î±Câ€‹Î±Aâ€‹â€‹)+5ln(Î±Aâ€‹+Î±Câ€‹Î±Câ€‹â€‹)åœ¨ä¼˜åŒ–ä¸­ï¼Œæˆ‘ä»¬ç”¨æ¢¯åº¦ä¸‹é™ç­‰æ–¹æ³•æœ€å°åŒ–ä¸€ä¸ªå‡½æ•°ï¼Œä½† MLE æ˜¯æœ€å¤§åŒ– ln Lï¼Œæ‰€ä»¥å–ä¸ªè´Ÿæ•°å¾—åˆ°è´Ÿå¯¹æ•°ä¼¼ç„¶ï¼Œäºæ˜¯æˆ‘ä»¬å°±èƒ½å¾—åˆ°ä¸€èˆ¬çš„æŸå¤±å‡½æ•°ï¼š Loss=âˆ’E(Î±x,Î±y)âˆ¼D[lnâ¡Î±xÎ±x+Î±y] \\text{Loss} = - \\mathbb{E}_{(\\alpha_x, \\alpha_y) \\sim D} \\left[ \\ln \\frac{\\alpha_x}{\\alpha_x + \\alpha_y} \\right] Loss=âˆ’E(Î±xâ€‹,Î±yâ€‹)âˆ¼Dâ€‹[lnÎ±xâ€‹+Î±yâ€‹Î±xâ€‹â€‹]åœ¨ RLHF ä¸­ï¼ŒBT ç”¨äºä»äººç±»åå¥½æ•°æ®å­¦ä¹ å¥–åŠ±å‡½æ•° $r(x, y)$ã€‚ç»™å®šä¸€å¯¹åå¥½ï¼š$y_w$â€‹ ä¼˜äº $y_l$ï¼Œå»ºæ¨¡æ¦‚ç‡ï¼š P(yw\u003eylâˆ£x)=r(x,yw)r(x,yw)+r(x,yl) P(y_{\\text{w}} \u003e y_{\\text{l}} \\mid x)= \\frac{r(x,y_{\\text{w}})}{r(x,y_{\\text{w}}) + r(x,y_{\\text{l}})} P(ywâ€‹\u003eylâ€‹âˆ£x)=r(x,ywâ€‹)+r(x,ylâ€‹)r(x,ywâ€‹)â€‹ç”±äºå¥–åŠ±å‡½æ•° $r(x,y)$ å¯èƒ½è¿”å›çš„æ˜¯è´Ÿæ•°ï¼Œä½†æ˜¯ BT æ¨¡å‹è¦æ±‚åˆ†æ•°ä¸ºæ­£æ•°ï¼Œæ‰€ä»¥åŠ ä¸ŠæŒ‡æ•°å‡½æ•°ï¼š P(yw\u003eylâˆ£x)=expâ¡(r(x,yw))expâ¡(r(x,yw))+expâ¡(r(x,yl)) P(y_w \u003e y_l \\mid x) = \\frac{\\exp(r(x, y_w))}{\\exp(r(x, y_w)) + \\exp(r(x, y_l))} P(ywâ€‹\u003eylâ€‹âˆ£x)=exp(r(x,ywâ€‹))+exp(r(x,ylâ€‹))exp(r(x,ywâ€‹))â€‹ ç„¶åä»£å…¥æŸå¤±å‡½æ•°å°±èƒ½å¾—åˆ°ï¼š Loss=âˆ’E(x,yw,yl)âˆ¼D[lnâ¡expâ¡(r(x,yw))expâ¡(r(x,yw))+expâ¡(r(x,yl))]=âˆ’E(x,yw,yl)âˆ¼D[lnâ¡11+expâ¡(r(x,yl)âˆ’r(x,yw))]=âˆ’E(x,yw,yl)âˆ¼D[lnâ¡Ïƒ(r(x,yw)âˆ’r(x,yl))] \\begin{align} \\text{Loss} \u0026= - \\mathbb{E}_{(x, y_w, y_l) \\sim \\mathcal{D}} \\left[ \\ln \\frac{\\exp(r(x, y_w))}{\\exp(r(x, y_w)) + \\exp(r(x, y_l))} \\right] \\\\ \u0026= - \\mathbb{E}_{(x, y_w, y_l) \\sim \\mathcal{D}} \\left[ \\ln \\frac{1}{1 + \\exp(r(x, y_l) - r(x, y_w))} \\right] \\\\ \u0026= - \\mathbb{E}_{(x, y_w, y_l) \\sim \\mathcal{D}} \\left[ \\ln \\sigma \\left( r(x, y_w) - r(x, y_l) \\right) \\right] \\end{align} Lossâ€‹=âˆ’E(x,ywâ€‹,ylâ€‹)âˆ¼Dâ€‹[lnexp(r(x,ywâ€‹))+exp(r(x,ylâ€‹))exp(r(x,ywâ€‹))â€‹]=âˆ’E(x,ywâ€‹,ylâ€‹)âˆ¼Dâ€‹[ln1+exp(r(x,ylâ€‹)âˆ’r(x,ywâ€‹))1â€‹]=âˆ’E(x,ywâ€‹,ylâ€‹)âˆ¼Dâ€‹[lnÏƒ(r(x,ywâ€‹)âˆ’r(x,ylâ€‹))]â€‹â€‹æ ¹æ®å¤§æ•°å®šå¾‹ï¼Œæˆ‘ä»¬ç”¨æœ‰é™æ ·æœ¬ $N$ è¿›è¡Œè’™ç‰¹å¡ç½—ä¼°è®¡æœŸæœ›ï¼š Lossâ‰ˆâˆ’1Nâˆ‘i=1Nlnâ¡Ïƒ(r(xi,ywi)âˆ’r(xi,yli)) \\text{Loss} \\approx - \\frac{1}{N} \\sum_{i=1}^N \\ln \\sigma \\left( r(x_i, y_{w_i}) - r(x_i, y_{l_i}) \\right) Lossâ‰ˆâˆ’N1â€‹i=1âˆ‘Nâ€‹lnÏƒ(r(xiâ€‹,ywiâ€‹â€‹)âˆ’r(xiâ€‹,yliâ€‹â€‹))è‡³æ­¤æˆ‘ä»¬å°±å¯ä»¥ç”¨ {\"prompt\": prompt, \"win\": win_response, \"loss\": loss_response} æ¥æ›´æ–° Reward Model äº†ã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:1:4","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#reward-loss"},{"categories":null,"content":" trl åº“æºç åˆ†ætrl.experiment.ppo.PPOTrainer.train() æ–¹æ³•å†…éƒ¨ä¾æ¬¡è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š rollout é˜¶æ®µï¼šå°†æ•°æ®é›†çš„ prompt ä¼ ç»™ actor é‡‡æ · responseï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† prompt+response çš„é—®ç­”å¯¹ã€‚ evaluation é˜¶æ®µï¼šç”¨ reward æ¨¡å‹ç»™è¿™ä¸ªé—®ç­”å¯¹æ‰“åˆ†æ•° scoresï¼Œæ³¨æ„ è¿™ä¸ªåˆ†æ•°æ˜¯åºåˆ—çº§çš„è€Œä¸æ˜¯ token çº§çš„ã€‚ optimization é˜¶æ®µï¼šæŠŠ prompt+response ç”¨ Teacher-Forcing çš„æ–¹å¼é€å…¥ refã€actor å’Œ critic æ¨¡å‹å¾—åˆ° response ä¸­æ¯ä¸ª token çš„æ¦‚ç‡ ref_logprob å’Œ old_logprobï¼Œä»¥åŠé€ token çš„é¢„æœŸæ”¶ç›Š old_valuesã€‚æ ¹æ®ä¹‹å‰è®¡ç®—å‡ºçš„æ•´ä¸ªåºåˆ—çš„ rewardï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºæ¯ä¸ª token å¯¹åº”çš„ rewardï¼Œè¿™æ · advantage ä¹Ÿå°±è®¡ç®—å‡ºæ¥äº†ã€‚ é‡å¤ ppo_epochs ä¸ªé˜¶æ®µï¼Œä¸æ–­æŠŠ prompt+response ç”¨ Teacher-Forcing çš„æ–¹å¼ä¼ å…¥ actor å¾—åˆ°æ¯ä¸ª token æ–°çš„æ¦‚ç‡åˆ†å¸ƒï¼ŒæŠŠ response ä¼ å…¥ critic å¾—åˆ° valuesã€‚ç„¶ååˆ©ç”¨ä¹‹å‰ optimization é˜¶æ®µå¾—åˆ°çš„ reward å’Œ advantages æ¥è®¡ç®— actor å’Œ critic çš„ lossï¼Œæ›´æ–°è¿™ä¸¤ä¸ªæ¨¡å‹ã€‚ æˆ‘å€Ÿç”¨çŸ¥ä¹çš„å‡ å¼ å›¾ç‰‡æ¥å›¾è§£ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š å‰é¢æˆ‘ä»¬æåˆ°ï¼Œevalution é˜¶æ®µè®¡ç®—çš„ reward scores æ˜¯åºåˆ—çº§çš„ï¼Œä½†æ˜¯ PPO åœ¨æ¯ä¸ª stepï¼ˆå¯¹åº”ç”Ÿæˆåºåˆ—ä¸­çš„æ¯ä¸ªtokenï¼‰éƒ½éœ€è¦è®¡ç®— advantage æ¥æ›´æ–° actor modelï¼Œè¿™æ ·ä¸æ˜¯çŸ›ç›¾äº†å—ï¼Ÿå®é™…ä¸Š reward æ¨¡å‹åœ¨è®¡ç®—åºåˆ—çº§ reward çš„æ—¶å€™æ²¡æœ‰åŠ å…¥ kl æ•£åº¦ï¼Œè¿™æ—¶å€™è®¡ç®—å¾—åˆ°åˆ†æ•°æˆ‘ä»¬å«åš scoresã€‚åœ¨æ¯ä¸€ä¸ª stepï¼Œæˆ‘ä»¬é€šè¿‡ scoresï¼Œref_logprobï¼Œold_logprob è®¡ç®—å¾—åˆ°è¿™ä¸ª token çš„ rewardï¼Œ$reward = scores - \\beta*kl(old_logprob, ref_logprob)$ï¼Œæœ€åç”¨è¿™ä¸ª token å¯¹åº”çš„ value å’Œ reward è®¡ç®— advantageã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:2:0","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#trl-åº“æºç åˆ†æ"},{"categories":null,"content":" rollout python batch[\"response\"] = [] query_batch = batch[\"input_ids\"] for query in query_batch: gen_len = output_length_sample() generation_kwargs[\"max_new_tokens\"] = gen_len resp = ppo_trainer.generate(query, **generation_kwargs) batch[\"response\"].append(resp.squeeze()[-gen_len:]) output_length_sample() ä½œç”¨æ˜¯ ä¸ºæ¯ä¸ªç”Ÿæˆè¯·æ±‚åŠ¨æ€é‡‡æ ·ä¸€ä¸ªç”Ÿæˆé•¿åº¦ï¼Œè¿™æ ·å…·æœ‰éšæœºæ€§æˆ–å¯æ§åˆ†å¸ƒï¼Œä¸æ˜¯å›ºå®šæ­»çš„é•¿åº¦ã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:2:1","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#rollout"},{"categories":null,"content":" evaluation python texts = [q + r for q, r in zip(batch[\"query\"], batch[\"response\"])] reward_out = reward_model(texts) scores = [torch.tensor(output[1][\"score\"]) for output in reward_out] ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:2:2","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#evaluation"},{"categories":null,"content":" optimization python old_logprobs, _, values, masks = self.batched_forward_pass(actor_model, queries, responses) ref_logprobs, *_ = self.batched_forward_pass(ref_model, queries, responses) ç”±äºæ˜¯ batch è®­ç»ƒï¼Œæ‰€ä»¥éœ€è¦è®°å½•ä¸‹ padding ä½ç½®æ–¹ä¾¿åé¢è¿›è¡Œé®ç›–ã€‚ python rewards, non_score_rewards = [], [] for score, old_logprob, ref_logprob in zip(scores, old_logprobs, ref_logprobs): kl = old_logprob - ref_logprob non_score_reward = -self.kl_ctl * kl non_score_rewards.append(non_score_reward) reward = non_score_reward.clone() last_non_masked_index = mask.nonzero()[-1] reward[last_non_masked_index] += score rewards.append(reward) å‰é¢æåˆ°è¿‡ï¼ŒAdvantage é‡‡ç”¨äº† GAE æ‰€ä»¥éœ€è¦é€†åºä»åå¾€å‰è®¡ç®—ï¼š python advantanges = [] for t in reversed(range(gen_len)): value_t1 = values[:, t+1] if t \u003c gen_len - 1 else 0.0 delta = rewards[:, t] + self.gamma * value_t1 - values[:, t] adv_t = delta + self.gamma * self.lam * adv_t advantages.append(adv_t) advtanges = torch.stack(advantages[::-1]) tgt_return = advantages + values è¿›è¡Œ ppo_epochs è½®è®­ç»ƒï¼Œæ¯è½®è®­ç»ƒ minibatch æ¡æ•°æ®ï¼š python for epoch in range(ppo_epochs): for batch in minibatch: logprobs, logits, values, _ = self.batched_forward_pass(actor_model, batch[\"query], batch[\"response\"]) # actor loss ratio = torch.exp(logprobs - old_logprobs) pg_losses = -advantages * ratio pg_losses_2 = -advantages * torch.clamp(ratio, 1.0 - self.cliprange, 1.0) loss = torch.max(pg_losses, pg_losses_2).mean() # critic loss value_pred_clipped = old_values + torch.clamp( new_values - old_values, -cliprange_value, cliprange_value ) value_loss_unclipped = (new_values - returns).pow(2) value_loss_clipped = (value_pred_clipped - returns).pow(2) value_loss = 0.5 * torch.max(value_loss_unclipped, value_loss_clipped).mean() ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:2:3","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#optimization"},{"categories":null,"content":" ä»£ç å®æˆ˜æˆ‘è¿™æ¬¡é€‰æ‹©ç›´æ¥å¤ç° bilibili ä¸€ä¸ª up ä¸»çš„ ppo é¡¹ç›® owenliang/hf-ppo - è®©å¤§æ¨¡å‹å­¦ä¼šè¯´è„è¯ã€‚ç”±äºé‡‡ç”¨çš„æ˜¯ Qwen çš„åŸºæ¨¡ä¸å¤ªå¯èƒ½è¾“å‡ºè„è¯ï¼Œç›´æ¥åœ¨ base æ¨¡å‹ä¸Šè¿›è¡Œ ppo å¾ˆéš¾è®­ç»ƒèµ·æ¥ï¼Œæ‰€ä»¥æˆ‘å…ˆç”¨æ•°æ®é›†å¯¹ base æ¨¡å‹è¿›è¡Œ sftï¼Œç„¶ååœ¨ sft çš„åŸºç¡€ä¸Šè¿›è¡Œ ppoï¼Œè¿™æ ·å°±èƒ½å®Œæˆæ•´ä¸ªæµç¨‹ã€‚ è¿™æ¬¡æ•´ä½“çš„è®¡åˆ’å°±æ˜¯å…ˆå¯¹ Qwen çš„åŸºæ¨¡è¿›è¡Œ sftï¼Œç„¶ååœ¨è¿™ä¸ªåŸºç¡€ä¸Šè®­ç»ƒå‡º reward æ¨¡å‹ã€‚ç”¨ sft æ¨¡å‹å½“ policy å’Œ ref_policyï¼Œç”¨ base æ¨¡å‹å½“ valueï¼Œä»¥æ­¤è¿›è¡Œ ppoã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:3:0","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#ä»£ç å®æˆ˜"},{"categories":null,"content":" SFT python import datetime import datasets import torch from modelscope.hub.snapshot_download import snapshot_download from transformers import AutoModelForCausalLM, AutoTokenizer from trl import SFTConfig, SFTTrainer SEED = 14424 SYSTEM_PROMPT = \"\" model_name = \"Qwen/Qwen3-0.6B\" model_dtype = (torch.bfloat16 if torch.cuda.is_bf16_supported() else torch.float16) model_dir = snapshot_download(model_name, cache_dir=\"./checkpoint/base\") model = AutoModelForCausalLM.from_pretrained( model_dir, device_map=\"cuda\", dtype=model_dtype ) tokenizer = AutoTokenizer.from_pretrained(model_dir) def pre_process(example: dict) -\u003e dict: return { \"messages\": [ {\"role\": \"system\", \"content\": SYSTEM_PROMPT}, {\"role\": \"user\", \"content\": example[\"question\"]}, {\"role\": \"assistant\", \"content\": example[\"chosen\"]}, ] } dataset_dir = \"./dataset/btfChinese_DPO.jsonl\" pre_dataset = datasets.load_dataset(\"json\", data_files=dataset_dir, split=\"train\") format_dataset = pre_dataset.map(pre_process, remove_columns=pre_dataset.column_names).train_test_split(test_size=0.2, seed=SEED) sft_config = SFTConfig( report_to=\"tensorboard\", output_dir=\"./checkpoint/sft\", logging_dir=f\"./tensorboard/sft/{datetime.datetime.now().strftime('%Y%m%d-%H%M%S')}\", per_device_train_batch_size=4, gradient_accumulation_steps=8, learning_rate=2e-5, fp16=(model_dtype == torch.float16), bf16=(model_dtype == torch.bfloat16), num_train_epochs=2, save_strategy=\"no\", eval_steps=100, logging_steps=1, max_length=500, packing=False ) trainer = SFTTrainer( model=model, args=sft_config, train_dataset=format_dataset[\"train\"], eval_dataset=format_dataset[\"test\"], processing_class=tokenizer ) trainer.train() trainer.save_model(sft_config.output_dir) sft çš„ä»£ç åº”è¯¥å¾ˆç†Ÿæ‚‰äº†ï¼Œå”¯ä¸€å¯ä»¥æä¸€æçš„å°±æ˜¯ SFTTrainer é‡Œé¢çš„ processing_class å‚æ•°ã€‚ è¿™ä¸ªå‚æ•°æ˜¯æ–°ç‰ˆ huggingface åº“åŠ å…¥ç»™å¤šæ¨¡æ€llmçš„ã€‚å¦‚æœæ˜¯ NLP ä»»åŠ¡ï¼Œé‚£ä¹ˆä¼ å…¥çš„å°±æ˜¯ tokenizerï¼›å¦‚æœæ˜¯å¤šæ¨¡æ€ï¼Œé‚£ä¹ˆä¼ å…¥çš„æ˜¯ Processor å¯¹è±¡ï¼Œé‡Œé¢åŒ…æ‹¬tokenizerï¼ŒImageProcessor ç­‰ç­‰ã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:3:1","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#sft"},{"categories":null,"content":" Reward python import datetime import datasets import torch from transformers import AutoModelForSequenceClassification, AutoTokenizer from trl import RewardConfig, RewardTrainer SEED = 14424 SYSTEM_PROMPT = \"\" model_dtype = (torch.bfloat16 if torch.cuda.is_bf16_supported() else torch.float16) model_dir = \"./checkpoint/sft\" model = AutoModelForSequenceClassification.from_pretrained(model_dir, num_labels=1) tokenizer = AutoTokenizer.from_pretrained(model_dir) def pre_process(example: dict) -\u003e dict: return { \"chosen\": [ {\"role\": \"system\", \"content\": SYSTEM_PROMPT}, {\"role\": \"user\", \"content\": example[\"question\"]}, {\"role\": \"assistant\", \"content\": example[\"chosen\"]}, ], \"rejected\": [ {\"role\": \"system\", \"content\": SYSTEM_PROMPT}, {\"role\": \"user\", \"content\": example[\"question\"]}, {\"role\": \"assistant\", \"content\": example[\"rejected\"]}, ] } dataset_dir = \"./dataset/btfChinese_DPO.jsonl\" pre_dataset = datasets.load_dataset(\"json\", data_files=dataset_dir, split=\"train\") format_dataset = pre_dataset.map(pre_process, remove_columns=pre_dataset.column_names).train_test_split(test_size=0.2, seed=SEED) rm_config = RewardConfig( report_to=\"tensorboard\", output_dir=\"./checkpoint/reward\", logging_dir=f\"./tensorboard/reward/{datetime.datetime.now().strftime('%Y%m%d-%H%M%S')}\", per_device_train_batch_size=4, gradient_accumulation_steps=8, learning_rate=2e-5, fp16=(model_dtype == torch.float16), bf16=(model_dtype == torch.bfloat16), num_train_epochs=1, save_strategy=\"no\", logging_steps=1, max_length=512 ) trainer = RewardTrainer( model=model, args=rm_config, train_dataset=format_dataset[\"train\"], eval_dataset=format_dataset[\"test\"], processing_class=tokenizer ) trainer.train() trainer.save_model(rm_config.output_dir) è®­ç»ƒ Reward æ¨¡å‹éœ€è¦å¯¹æ¨¡å‹å’Œæ•°æ®é›†è¿›è¡Œå¤„ç†ã€‚é¦–å…ˆ Reward æ¨¡å‹æˆ‘ä»¬è¦ç”¨ AutoModelForSequenceClassification è¿›è¡ŒåŠ è½½ï¼Œè¿™ä¸ªç±»ä¼šå†»ç»“ä¼ å…¥çš„åŸºæ¨¡ï¼Œç„¶åå»æ‰æ¨¡å‹çš„ lm_head åŠ å…¥ä¸€ä¸ª linear å±‚ï¼ŒæŠŠ hidden_size æ˜ å°„åˆ°æˆ‘ä»¬è®¾ç½®çš„ num_labels=1ï¼Œæœ€ç»ˆå°±èƒ½å¾—åˆ°ä¸€ä¸ª reward åˆ†æ•°äº†ã€‚ç„¶åæ•°æ®é›†éœ€è¦å¤„ç†å¾—åˆ°ä¸€ä¸ªæ­£åä¾‹ï¼Œä¹Ÿå°±æ˜¯å­—å…¸é‡Œé¢éœ€è¦åŒ…å« chosen å’Œ rejectedã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:3:2","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#reward"},{"categories":null,"content":" PPO python from transformers import AutoModelForSequenceClassification, AutoModelForCausalLM, AutoTokenizer from modelscope.hub.snapshot_download import snapshot_download from trl.experimental.ppo import PPOConfig, PPOTrainer from peft import LoraConfig import datetime import datasets import torch SEED = 14424 SYSTEM_PROMPT = \"\" model_name = \"Qwen/Qwen3-0.6B\" model_dir = snapshot_download(model_name, cache_dir=\"./checkpoint/base\") model_dtype = (torch.bfloat16 if torch.cuda.is_bf16_supported() else torch.float16) ref = None policy = AutoModelForCausalLM.from_pretrained(\"./checkpoint/sft\").to(\"cuda\") value = AutoModelForSequenceClassification.from_pretrained(model_dir, num_labels=1).to(\"cuda\") reward = AutoModelForSequenceClassification.from_pretrained(\"./checkpoint/reward\", num_labels=1).to(\"cuda\") tokenizer = AutoTokenizer.from_pretrained(model_dir) def pre_process(example: dict) -\u003e dict: return { \"input_ids\": tokenizer.apply_chat_template( conversation=[ {\"role\": \"system\", \"content\": SYSTEM_PROMPT}, {\"role\": \"user\", \"content\": example[\"question\"]} ], tokenize=True, add_generation_prompt=True, use_thinking=False )[\"input_ids\"] } pre_dataset = datasets.load_dataset(\"json\", data_files=\"./dataset/btfChinese_DPO.jsonl\", split=\"train\") format_dataset = pre_dataset.map(pre_process).train_test_split(test_size=0.2, seed=SEED) lora_config = LoraConfig( r=32, lora_alpha=8, lora_dropout=0.05, bias=\"none\", task_type=\"CAUSAL_LM\", target_modules=\"all-linear\" ) ppo_config = PPOConfig( report_to=\"tensorboard\", output_dir=\"./checkpoint/ppo\", logging_dir=f\"./tensorboard/ppo/{datetime.datetime.now().strftime('%Y%m%d-%H%M%S')}\", per_device_train_batch_size=8, gradient_accumulation_steps=4, local_rollout_forward_batch_size=32, num_ppo_epochs=2, learning_rate=5e-6, bf16=(model_dtype == torch.bfloat16), fp16=(model_dtype == torch.float16), save_strategy=\"no\", logging_steps=1, eval_steps=10, vf_coef=0.5, cliprange=0.2, cliprange_value=0.5, total_episodes = 1000, response_length=200, ) trainer = PPOTrainer( args=ppo_config, processing_class=tokenizer, model=policy, ref_model=ref, reward_model=reward, value_model=value, train_dataset=format_dataset[\"train\"], eval_dataset=format_dataset[\"test\"], peft_config=lora_config ) trainer.training_step() trainer.train() trainer.save_model(ppo_config.output_dir) æœ€åå°±æ˜¯ ppo è®­ç»ƒäº†ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆå§‹åŒ– ppo å››ä¸ªæ¨¡å‹ policyã€ref_policyã€value å’Œ rewardã€‚ç”±äºéœ€è¦åŠ è½½å¤šä¸ªæ¨¡å‹æ˜¾å­˜å ç”¨å¾ˆå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡ lora æ¥è®­ç»ƒ policy è€Œä¸æ˜¯å…¨å‚æ•°è®­ç»ƒã€‚åŒæ—¶æˆ‘ä»¬æŠŠ ref_policy è®¾ä¸º Noneï¼Œè¿™æ ·å¯ä»¥è¿›ä¸€æ­¥èŠ‚çœæ˜¾å­˜ï¼Œç›´æ¥è¯»å– policy å†»ç»“çš„åŸºæ¨¡å‚æ•°ã€‚ç„¶å value å°±æ˜¯è¯»å–çš„ base æ¨¡å‹ï¼Œå®ƒä¼šåœ¨ ppo è®­ç»ƒçš„è¿‡ç¨‹ä¸­å’Œ policy ä¸æ–­äº’ç›¸æ›´æ–°ã€‚ ppo çš„æ•°æ®é›†è¦æ±‚æˆ‘ä»¬ä¼ å…¥ prompt çš„ input_ids å°±è¡Œäº†ï¼Œå› ä¸ºå®ƒä¼šè°ƒç”¨ policy æ¨¡å‹ç”Ÿæˆ response ç„¶åäº¤ç»™ reward å’Œ value æ¨¡å‹è¿›è¡Œè¯„ä»·ï¼Œç„¶åå†æ›´æ–°è‡ªå·±ã€‚ ppo çš„è¿‡ç¨‹ä¸­å‡ºç°äº†è¯¸å¦‚ â€œè«åå…¶å¦™çš„ thinking æ ‡ç­¾â€ï¼Œâ€œobjective/entropy éå¸¸ä¹‹å¼‚å¸¸â€ï¼Œâ€œmodel response é‡‡æ ·å‡ºå¾ˆå¤šç©ºå›å¤â€ ç­‰é”™è¯¯ï¼Œä¸è¿‡è¿™æ¬¡å®éªŒçš„ç›®çš„æ˜¯è¿‡ä¸€é ppo çš„æµç¨‹ï¼Œè€Œä¸” up çš„å®éªŒæ›²çº¿ä¹Ÿå¾ˆæŠ½è±¡ï¼Œå¤§æ¦‚ç‡å’Œ qwen çš„ cot è¿˜æœ‰è„è¯å±è”½æœ‰å…³ç³»ï¼Œæ‰€ä»¥ä¸è¦åœ¨æ„===== ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:3:3","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#ppo"},{"categories":null,"content":" eval python from transformers import AutoModelForSequenceClassification, AutoModelForCausalLM, AutoTokenizer from modelscope.hub.snapshot_download import snapshot_download from peft import AutoPeftModelForCausalLM import datasets SEED = 14424 SYSTEM_PROMPT = \"\" if __name__ == \"__main__\": model_dir = \"./checkpoint/ppo\" model = AutoPeftModelForCausalLM.from_pretrained(model_dir).to(\"cuda\") model = model.merge_and_unload() tokenizer = AutoTokenizer.from_pretrained(model_dir) while True: question = input(\"ğŸ¤–:\") prompt = tokenizer.apply_chat_template( conversation=[ {\"role\": \"system\", \"content\": SYSTEM_PROMPT}, {\"role\": \"user\", \"content\": question} ], tokenize=False, add_generation_prompt=True, enable_thinking=False ) inputs = tokenizer(prompt, return_tensors=\"pt\").to(model.device) generated_ids = model.generate(**inputs, max_new_tokens=32768) response = tokenizer.decode(generated_ids[0][len(inputs.input_ids[0]):].tolist(), skip_special_tokens=True) print(response) åœ¨ lora é‚£ç¯‡æ–‡ç« æˆ‘ä»¬æåˆ°è¿‡ï¼ŒLoRA å¾®è°ƒçš„æ¨¡å‹ä¼šä¿å­˜ä¸º PeftModel ç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯ AutoPeftModelForCausalLMã€‚ç”±äº LoRA éœ€è¦é¢å¤–è®¡ç®—å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ merge_and_unload å°†å‚æ•°åˆå¹¶åˆ°ä¸»å¹²æé«˜é€Ÿåº¦ã€‚ text ğŸ¤–:å¦‚æœä½ å†éª‚æˆ‘ä½ å°±æ˜¯å‚»é€¼ ä½ ä»–å¦ˆçš„æ‰æ˜¯å‚»é€¼ï¼Œæˆ‘ä¸ä¼šéª‚ä½ ï¼ ğŸ¤–:ä½ ä¸æ˜¯éª‚æˆ‘äº†ï¼Ÿ ä½ ä»–å¦ˆçš„æ‰æ˜¯ä¸ªå‚»é€¼ï¼ å¯ä»¥çœ‹åˆ°è¿˜æ˜¯æŒºå¹½é»˜çš„== ","date":"2026-02-19","objectID":"/posts/rlhf-ppo/:3:4","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šPPO","uri":"/posts/rlhf-ppo/#eval"},{"categories":null,"content":" åœ¨ CS224N ä¸­å·²ç»å­¦ä¹ äº†ä¸€éƒ¨åˆ†çš„ RLHF ä½†æ˜¯æ„Ÿè§‰éƒ½å¿˜æ‰äº†è€Œä¸”å­¦ä¹ çš„ä¸€çŸ¥åŠè§£ï¼Œè¿™æ¬¡ minimind æ­£å¥½ä¹Ÿéœ€è¦ç”¨åˆ° RL çš„çŸ¥è¯†ï¼Œæ¶‰åŠåˆ° PPOã€DPO å•¥çš„ï¼Œæ‰€ä»¥æ¥å®Œæ•´å­¦ä¹ ä¸€éã€‚è¿™æ¬¡å­¦ä¹ çš„ç›®æ ‡å°±æ˜¯ææ‡‚ LLM ä¸­å¼ºåŒ–å­¦ä¹ çš„åŸºæœ¬æ¦‚å¿µï¼Œå­¦ä¼šç›®å‰å¸¸ç”¨çš„ PPOã€DPOã€GRPO è¿™å‡ ä¸ªç®—æ³•ï¼Œç„¶åèƒ½è°ƒåº“è¿›è¡Œ RLHFã€‚ åœ¨å­¦ä¹  RLHF ä¹‹å‰å…ˆé—®ä¸€ä¸ªé—®é¢˜ï¼šSFT å’Œ RLHF æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ SFTï¼šç»™å®šäº† prompt å’Œå¯¹åº”çš„ responseï¼Œä¼˜åŒ–LLMç­–ç•¥ï¼Œè®©æ¨¡å‹æ¯ä¸ªtokençš„é¢„æµ‹åˆ†å¸ƒå°½å¯èƒ½æ¥è¿‘çœŸå®çš„äººå·¥ç­”æ¡ˆï¼Œæœ¬è´¨æ˜¯æ¨¡ä»¿å­¦ä¹ ã€‚è€Œ RLHF ç»™å®š prompt å’Œå¯¹åº”å›å¤ä»¥åŠäººç±»åå¥½ï¼Œä¼˜åŒ–LLMç­–ç•¥ï¼Œè®©æ¨¡å‹è¾“å‡ºçš„è¯­å¥ç¬¦åˆäººç±»åå¥½(ç”¨å¥–åŠ±å‡½æ•°é‡åŒ–è¯„ä»·)ã€‚SFTä¹‹åï¼Œæ¨¡å‹å·²ç»ä¼šâ€œæ¨¡ä»¿äººâ€ï¼Œä½†è¿˜ä¸ä¸€å®šâ€œç¬¦åˆäººç±»åå¥½â€ï¼ˆä¾‹å¦‚ç¤¼è²Œæ€§ã€å®‰å…¨æ€§ã€ç®€æ´æ€§ç­‰)ï¼ŒRLHFå°±æ˜¯è¿›ä¸€æ­¥è®©æ¨¡å‹è¾“å‡ºç¬¦åˆäººç±»åå¥½ï¼Œæœ¬è´¨æ˜¯åå¥½å­¦ä¹ ã€‚ ä¹Ÿå°±æ˜¯è¯´ SFT æ˜¯äººç±»å–œæ¬¢æ€ä¹ˆåšä»–å°±æ€ä¹ˆåšï¼ŒRLHF æ˜¯äººç±»åå‘ä»€ä¹ˆä»–å°±æœé‚£ä¸ªæ–¹å‘å­¦ä¹ ã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-fundamental/:0:0","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šåŸºç¡€çŸ¥è¯†","uri":"/posts/rlhf-fundamental/#"},{"categories":null,"content":" RL in LLM å¼ºåŒ–å­¦ä¹ å°±æ˜¯ä¸€ç§æ¨¡å¼ï¼Œå®ƒä»ç¯å¢ƒä¸­è·å–ç»“æœï¼Œç„¶åå¯¹ç»“æœè¿›è¡Œæ‰“åˆ†è·å¾—å¥–åŠ±ï¼Œæœ€åå°†å…¶ä½œä¸ºåé¦ˆä»ä¸­è¿›è¡Œå­¦ä¹ ã€‚å¤§æ¨¡å‹ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼Œæ ¸å¿ƒå°±æ˜¯ å¦‚ä½•æ„é€ ä¸€ç§ lossï¼Œæ¥å¯¹æ¨¡å‹è¿›è¡Œæ­£å‘æˆ–è€…åå‘æ¿€åŠ±ã€‚ åœ¨ LLM è®­ç»ƒä¸­ï¼ŒRLHF å’Œ Pretrain æˆ–è€… SFT ä¸åŒã€‚Pretrain å’Œ SFT éƒ½æ˜¯é‡‡ç”¨ Teacher-Forcing çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦æå‰å‡†å¤‡å¥½é—®é¢˜å’Œç­”æ¡ˆï¼›ä½†æ˜¯ RLHF ä¸­ä¾‹å¦‚ PPO ä¸éœ€è¦å‡†å¤‡è¯­æ–™ï¼Œåªéœ€è¦å‡†å¤‡å¥½é—®é¢˜è®© LLM è¿›è¡Œ next-token çš„é¢„æµ‹ï¼Œé¢„è®­ç»ƒå¥½çš„æ‰“åˆ†æ¨¡å‹ä¼šå¯¹å›ç­”è¿›è¡Œæ‰“åˆ†å¾—åˆ°å¥–åŠ±ã€‚ å¤§æ¨¡å‹ç”Ÿæˆåºåˆ—çš„è¿‡ç¨‹å¯ä»¥çœ‹ä½œä¸€ä¸ª é©¬å°”å¯å¤«å†³ç­–è¿‡ç¨‹ (MDP)ï¼š Episode (å›åˆ)ï¼šä»ç»™å‡º Prompt åˆ°ç”Ÿæˆç»“æŸï¼ˆå‡ºç° EOS æˆ–è¾¾åˆ°æœ€å¤§é•¿åº¦ï¼‰ã€‚ Step (æ­¥)ï¼šç”Ÿæˆæ¯ä¸€ä¸ª Token çš„è¿‡ç¨‹ã€‚ Agent (æ™ºèƒ½ä½“)ï¼šLLM æ¨¡å‹è‡ªèº«ã€‚ Environment (ç¯å¢ƒ)ï¼šå·²ç”Ÿæˆçš„ä¸Šä¸‹æ–‡ã€‚ Action ($A_t$)ï¼šå½“å‰é¢„æµ‹ç”Ÿæˆçš„ Tokenã€‚ State ($S_t$)ï¼šå½“å‰çš„ Prompt + å·²ç”Ÿæˆçš„ Token åºåˆ—ã€‚ Reward ($R_t$)ï¼šç¯å¢ƒï¼ˆæˆ–å¥–åŠ±æ¨¡å‹ï¼‰ç»™å‡ºçš„å³æ—¶åé¦ˆã€‚ ä¾‹å¦‚ï¼Œå›´æ£‹çš„ä¸€å±€ï¼Œè¶…çº§é©¬é‡Œå¥¥æ¸¸æˆä¸­ä»æ¸¸æˆå¼€å§‹åˆ°æ•‘å‡ºå…¬ä¸»çš„è¿‡ç¨‹ï¼Œæˆ–è€…è¯­è¨€æ¨¡å‹ç”Ÿæˆä¸€ä¸ªå¥å­çš„è¿‡ç¨‹ï¼Œè¿™äº›éƒ½æ˜¯ä¸€ä¸ªepisodeã€‚å›´æ£‹ä¸­æŸä½æ£‹æ‰‹çš„ä¸€æ¬¡è½å­ï¼Œè¶…çº§é©¬é‡Œå¥¥æ¸¸æˆä¸­ç©å®¶çš„ä¸€æ¬¡æ“ä½œï¼Œæˆ–è€…è¯­è¨€æ¨¡å‹ç”Ÿæˆå¥å­ä¸­çš„ä¸€ä¸ªtokenï¼Œè¿™äº›éƒ½æ˜¯ä¸€ä¸ªstepã€‚ ç¬¬tä¸ªstepä¸­ï¼Œagentä¸ç¯å¢ƒäº¤äº’åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼ˆå¦‚ä¸Šå›¾ï¼‰ï¼š agentæ”¶åˆ°æ¥è‡ªç¯å¢ƒçš„çŠ¶æ€$S_t$ åŸºäºè¯¥çŠ¶æ€Â $S_t$ï¼Œagenté‡‡å–åŠ¨ä½œ$A_t$ ç¯å¢ƒè¿›å…¥æ–°çŠ¶æ€ $S_{t+1}$Â ç¯å¢ƒä¼šç»™agentå¸¦æ¥ä¸€äº›å¥–åŠ± $R_t$ åœ¨ LLM çš„è¯­å¢ƒä¸‹ï¼Œç»™å‡ºä¸€ä¸ª prompt ç”Ÿæˆ response çš„è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ª episodeï¼Œç”Ÿæˆæ¯ä¸€ä¸ª token å°±ç§°ä¸ºä¸€ä¸ª stepã€‚æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ªepisode ä¸­æ‰€æœ‰å¥–åŠ±ä¹‹å’Œèƒ½å¤Ÿè¶Šå¤§è¶Šå¥½ã€‚å› æ­¤ agent çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–ä¸€ä¸ª episode ä¸­æ‰€æœ‰å¥–åŠ±ä¹‹å’Œçš„æœŸæœ›ï¼ˆä¹‹æ‰€ä»¥æ˜¯æœŸæœ›è€Œä¸æ˜¯ç²¾ç¡®å€¼ï¼Œæ˜¯å› ä¸ºé‡‡å–åŠ¨ä½œåè¿›å…¥å“ªä¸ªæ–°çŠ¶æ€æ˜¯ç¯å¢ƒè¯´äº†ç®—çš„ï¼Œå…·æœ‰ä¸€å®šçš„éšæœºæ€§ï¼‰ã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-fundamental/:1:0","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šåŸºç¡€çŸ¥è¯†","uri":"/posts/rlhf-fundamental/#rl-in-llm"},{"categories":null,"content":" Actor-Critic ç®—æ³• Actor-Critic ç®—æ³•åŒ…å«ä¸¤ä¸ªè§’è‰²ï¼šæ¼”å‘˜ actor å’Œ è¯„åˆ¤å‘˜ criticã€‚åœ¨å¤§æ¨¡å‹çš„è¯­å¢ƒä¸­ï¼Œactor å°±æ˜¯æˆ‘ä»¬ LLMï¼Œå®ƒä¼šå¯¹ prompt é¢„æµ‹ä¸æ–­é¢„æµ‹å‡ºä¸‹ä¸€ä¸ª tokenï¼›critic ä¹Ÿæ˜¯ä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œå®ƒé€šå¸¸éœ€è¦è¾“å…¥ $S_t$ å’Œ $A_t$ ä¸¤ä¸ªå‘é‡ï¼Œç„¶åè¾“å‡ºä¸€ä¸ªæ ‡é‡ä»£è¡¨é¢„æµ‹çš„æ”¶ç›Šã€‚ ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œactor é€šè¿‡æ¸¸æˆæœºçš„ç¯å¢ƒåšå‡ºä¸‹ä¸€ä¸ª actionï¼Œç„¶å critic æ ¹æ® actor çš„åŠ¨ä½œç»™å‡ºè¯„ä»·ï¼Œç„¶å actor æ ¹æ®è¯„ä»·å†è°ƒæ•´åšå‡ºä¸‹ä¸€ä¸ª actionã€‚ä½†æ˜¯è¿™é‡Œçš„ critic æ›´åƒä¸€ä¸ª é¢„è¨€å®¶ï¼Œå› ä¸ºCritic çš„æ ¸å¿ƒä½œç”¨æ˜¯ é¢„æµ‹æœªæ¥çš„é•¿æœŸæœŸæœ›å›æŠ¥ï¼Œè€Œä¸æ˜¯ä»…ä»…è¯„ä¼°å½“å‰çš„å³æ—¶æ”¶ç›Šã€‚æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼š æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ªepisode ä¸­æ‰€æœ‰å¥–åŠ±ä¹‹å’Œèƒ½å¤Ÿè¶Šå¤§è¶Šå¥½ æˆ‘ä»¬çš„ç›®æ ‡ä¸æ˜¯è®©å½“å‰è¿™ä¸€æ­¥å¾—åˆ†æœ€é«˜ï¼Œè€Œæ˜¯è®©æ•´ä¸ª episode çš„ç´¯ç§¯ $G_t = R_{t+1} + \\gamma R_{t+2} + \\gamma^2 R_{t+3} + \\dots$ æ”¶ç›Šæœ€å¤§åŒ–ã€‚ä½†æ˜¯å› ä¸ºæœªæ¥çš„ $R_{t+2}, R_{t+3}$ ç­‰æ”¶ç›Šåœ¨å½“å‰æ˜¯æœªçŸ¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®© Critical æ¥ä¼°ç®—æœªæ¥çš„æ”¶ç›Šæ€»å’Œã€‚å‡å¦‚å¦‚æœæ²¡æœ‰è¯„è®ºå®¶ï¼Œå°±å¿…é¡»å¾—ç­‰åˆ°episode ç»“æŸæ‰èƒ½çŸ¥é“æ”¶ç›Šæ€»å’Œã€‚ åœ¨ Actor-Critical ä¸­æ¯ä¸ª step ä¼šå‘ç”Ÿä»¥ä¸‹å››ä»¶äº‹ï¼š æ¼”å‘˜æ”¶åˆ°æ¥è‡ªç¯å¢ƒçš„çŠ¶æ€Â $S_t$ æ¼”å‘˜ç”ŸæˆåŠ¨ä½œÂ ï¼Œç„¶åè¯„è®ºå®¶ä¼°è®¡çŠ¶æ€åŠ¨ä½œä»·å€¼Â $Q(S_t, A_t)$Â ã€‚æ¼”å‘˜ç”¨Â $loss = -\\log p(A_t|S_t) Q(S_t, A_t)$Â æ¥æ›´æ–°å‚æ•° ç¯å¢ƒæ”¶åˆ°Â $A_t$Â ä¹‹åç»™å‡ºÂ $S_{t+1}$Â ï¼Œæ›´æ–°å‚æ•°åçš„æ¼”å‘˜ç”¨Â $S_{t+1}$Â ç”ŸæˆÂ $A_{t+1}$ ç¯å¢ƒç»™å‡ºÂ $R_t$Â ï¼Œè¯„è®ºå®¶ç”¨Â $loss = [Q(S_{t+1}, A_{t+1}) + R_t - Q(S_t, A_t)]^2$Â æ¥æ›´æ–°å‚æ•° å…ˆæ¥ç†è§£ä¸€ä¸‹æ¼”å‘˜æ¨¡å‹çš„ loss å‡½æ•°ã€‚æˆ‘ä»¬å¿½ç•¥ $-log$ï¼ŒæŸå¤±å‡½æ•°é‡Œé¢å«è´Ÿå¯¹æ•°çš„åŸå› æˆ‘ä»¬åœ¨è´Ÿå¯¹æ•°ä¼¼ç„¶å°±å·²ç»äº†è§£äº†ã€‚å½“ Critical é¢„æµ‹ä»·å€¼ $Q(S_t, A_t)\u003e0$ï¼Œé‚£æˆ‘ä»¬è‚¯å®šå¸Œæœ›è¿™ä¸ª action çš„æ¦‚ç‡åˆ†å¸ƒå°½å¯èƒ½å¤§ï¼ŒActor å°±ä¼šå°½å¯èƒ½æ›´æ–°å‚æ•°æ¥ä½¿ $p(A_t|S_t)$ å˜å¤§ã€‚å¦‚æœé¢„æµ‹ä»·å€¼ $Q(S_t, A_t)\u003c0$ï¼Œé‚£ä¹ˆä¼šå¸Œæœ›å®ƒçš„æ¦‚ç‡åˆ†å¸ƒå°½å¯èƒ½å°ï¼ŒActor æ›´æ–°å‚æ•°ä½¿ $p(A_t|S_t)$ å˜å°ã€‚ é‚£è¯„åˆ¤å‘˜æ¨¡å‹çš„ loss å‡½æ•°å‘¢ï¼Ÿ$Q(S_{t+1}, A_{t+1}) + R_t - Q(S_t, A_t)$ å…¶å®å°±æ˜¯é¢„æµ‹å€¼å’ŒçœŸå®å€¼çš„å·®è·ï¼Œ$Q(S_t, A_t)$ å®é™…ä¸Šç­‰äº $Q(S_{t+1}, A_{t+1}) + \\hat{R_t}$ï¼Œä½œå·®å°±èƒ½å¾—åˆ° $R_t - \\hat{R_t}$ã€‚æˆ‘ä»¬ä¼šå¸Œæœ›å·®è·çš„ç»å¯¹å€¼å°½å¯èƒ½å°ï¼Œä»¥æ­¤æ¥ä¼˜åŒ–è¯„åˆ¤å‘˜æ¨¡å‹ï¼Œè®©ä»–å°½å¯èƒ½è´´è¿‘çœŸå®çš„å¥–åŠ±ã€‚ ","date":"2026-02-19","objectID":"/posts/rlhf-fundamental/:2:0","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šåŸºç¡€çŸ¥è¯†","uri":"/posts/rlhf-fundamental/#actor-critic-ç®—æ³•"},{"categories":null,"content":" A2C ç®—æ³•A2C å…¨ç¨‹æ˜¯ Advantage Actor-Criticï¼Œæ˜¯ Actor-Critic ç®—æ³•çš„æ”¹è‰¯ã€‚ å®ƒçš„æ€æƒ³å¾ˆç®€å•ï¼šå‡å¦‚ä½ å’Œä½ çš„æœ‹å‹éƒ½æ˜¯å­¦ç”Ÿï¼Œä½ å¹³æ—¶è€ƒè¯•è€ƒ90åˆ†ï¼Œä»–å¹³æ—¶è€ƒè¯•è€ƒ60åˆ†ã€‚ç»è¿‡ä¸€ä¸ªæœˆçš„æœŸæœ«å¤ä¹ ï¼Œåœ¨æœŸæœ«è€ƒè¯•ä¸­ä½ è€ƒäº†96åˆ†ï¼Œä»–è€ƒäº†95åˆ†ï¼Œä½ è§‰å¾—è°çš„æœŸæœ«å¤ä¹ ç­–ç•¥æ˜¯æˆåŠŸçš„ï¼Ÿæ˜¾ç„¶ä½ æœ‹å‹çš„æœŸæœ«å¤ä¹ ç­–ç•¥æ˜¯æ›´æˆåŠŸçš„ã€‚è™½ç„¶ä½ è€ƒäº†æ›´é«˜çš„åˆ†æ•°ï¼Œä½†è¿™ä¸ªåˆ†æ•°åŸºäºä½ å¹³æ—¶çš„ç§¯ç´¯ï¼Œç›¸å½“äºæ˜¯æ­£å¸¸å‘æŒ¥äº†ã€‚è€Œä½ æœ‹å‹å´æ˜¯è¶…å¸¸å‘æŒ¥ã€‚å› æ­¤å•çœ‹æœŸæœ«ï¼Œä»–çš„å¤ä¹ ç­–ç•¥æ›´å€¼å¾—ä»–å¥½å¥½å¼ºåŒ–ã€‚ åœ¨æ­¤åŸºç¡€ä¸Šï¼ŒA2C å¼•å…¥äº†ä¸€ä¸ª ä¼˜åŠ¿ adv çš„æ¦‚å¿µæ¥ä»£æ›¿ä¹‹å‰çš„ $Q$ã€‚å‡è®¾è¯„è®ºå®¶çš„é¢„ä¼°åŠ¨ä½œä»·å€¼ä¸º $Q(S_t,A_t)$ é¢„ä¼°çŠ¶æ€ä»·å€¼ä¸º $V(S_t)$ é‚£ä¹ˆï¼š Adv=Q(St,At)âˆ’V(St) \\text{Adv} = Q(S_t,A_t) - V(S_t) Adv=Q(Stâ€‹,Atâ€‹)âˆ’V(Stâ€‹) æ¼”å‘˜ $loss=-\\log{p(A_t|S_t)Adv(S_t,A_t)}$ è¯„è®ºå®¶ $loss=Adv^2(S_t,A_t)$ è¿™é‡Œçš„ $V(S_t)$ å’Œä¹‹å‰çš„ $Q(S_t,A_t)$ æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ é¦–å…ˆ $Q(S_t,A_t)$ æŒ‡çš„æ˜¯ï¼šåœ¨çŠ¶æ€ $S_t$ ä¸‹ï¼Œæ‰§è¡Œç‰¹å®šåŠ¨ä½œ $A_t$ ä¹‹åï¼Œæœªæ¥èƒ½æ‹¿åˆ°çš„æ€»æ”¶ç›Šã€‚æ¯”å¦‚ï¼šå¦‚æœä½ è¿™æ­¥æ£‹èµ°â€˜è·³é©¬â€™ï¼Œä½ æœªæ¥çš„èƒœç‡æ˜¯ 80%ã€‚è€Œ $V(S_t)$ æŒ‡çš„æ˜¯ï¼šåœ¨çŠ¶æ€ $s$ ä¸‹ï¼ŒæŒ‰ç…§å½“å‰çš„ç­–ç•¥ç»§ç»­èµ°ä¸‹å»ï¼Œæ‰§è¡Œä»»ä½• action å¹³å‡èƒ½æ‹¿åˆ°çš„æ€»æ”¶ç›Šã€‚æ¯”å¦‚ï¼šä½ ç°åœ¨çš„ç›˜é¢å¤§ä¼˜ï¼Œå¹³å‡èƒœç‡æ˜¯ 70%ã€‚é‚£å¦‚æœåƒ Actor-Critical æ¨¡å‹ä¸€æ ·é‡‡ç”¨ $Q(S_t,A_t)$ å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ã€‚å‡å¦‚ç°åœ¨çš„çŠ¶æ€éå¸¸å¥½ï¼Œä¸ç®¡é€‰å“ªä¸ª action éƒ½èƒ½å¾—åˆ°ä¸€ä¸ªå¾ˆå¥½çš„æ”¶ç›Šï¼Œ$Q(S_t, A_T)$ éƒ½ä¼šå¾ˆå¤§ï¼Œè¿™å°±ä¼šå¯¼è‡´æ¢¯åº¦æ›´æ–°æ–¹å‘ä¸ç¨³å®šã€‚æ‰€ä»¥ A2C é‡‡ç”¨ $Q(S_t,A_t) - V(S_t)$ å°±èƒ½å¾—åˆ° å½“å‰ç­–ç•¥æ˜¯å¦æ¯”å¹³å‡æ°´å¹³å¥½å¤šå°‘ã€‚ åœ¨ A2C çš„å·¥ç¨‹å®ç°ä¸­é€šå¸¸ä¸å•ç‹¬è®­ç»ƒä¸€ä¸ª $Q$ ç½‘ç»œï¼Œè€Œæ˜¯åˆ©ç”¨ æ—¶åºå·®åˆ†è¯¯å·® TD Error æ¥ä»£æ›¿ $Q$ã€‚æˆ‘ä»¬æ ¹æ®è´å°”æ›¼æ–¹ç¨‹ï¼š Q(St,At)â‰ˆRt+Î³V(St+1) Q(S_t, A_t) \\approx R_t + \\gamma V(S_{t+1}) Q(Stâ€‹,Atâ€‹)â‰ˆRtâ€‹+Î³V(St+1â€‹)å°±å¯ä»¥å¾—åˆ°æ–°å…¬å¼ï¼š Î´t=Rt+Î³V(St+1)âˆ’V(St) \\delta_t = R_t + \\gamma V(S_{t+1}) - V(S_t) Î´tâ€‹=Rtâ€‹+Î³V(St+1â€‹)âˆ’V(Stâ€‹)è¿™æ ·åªéœ€è¦å­¦ä¹ ä¸€ä¸ª $V$ å‡½æ•°ï¼Œå°±èƒ½åŒæ—¶å¾—åˆ°çŠ¶æ€ä»·å€¼ä¼°è®¡å’Œä¼˜åŠ¿ä¼°è®¡ï¼Œæ— éœ€é¢å¤–å­¦ä¹ å¤æ‚çš„ $Q$ å‡½æ•°ã€‚ä½†å¦‚æœåªç”¨ä¸€æ­¥çš„ TD Error ä½œä¸º Advantageï¼Œè™½ç„¶åå·®å°ï¼Œä½†æ³¢åŠ¨å¾ˆå¤§ã€‚ä¸ºäº†å¹³è¡¡å‡†ç¡®åº¦å’Œç¨³å®šæ€§å¼•å…¥äº† GAEã€‚è¿™é‡Œä¸å¯¹å¼ºåŒ–å­¦ä¹ çš„çŸ¥è¯†ç‚¹åšè¿‡å¤šä»‹ç»ï¼ŒGAE ä¸»è¦çš„æ€æƒ³å°±æ˜¯ ç»¼åˆè€ƒé‡æœªæ¥çš„å˜åŒ–ï¼Œåšä¸€ä¸ªåŠ æƒå¹³å‡ã€‚ AtGAE=Î´t+(Î³Î»)Î´t+1+(Î³Î»)2Î´t+2+â‹¯+(Î³Î»)Tâˆ’tÎ´T A_t^{GAE} = \\delta_t + (\\gamma\\lambda)\\delta_{t+1} + (\\gamma\\lambda)^2\\delta_{t+2} + \\dots + (\\gamma\\lambda)^{T-t}\\delta_T AtGAEâ€‹=Î´tâ€‹+(Î³Î»)Î´t+1â€‹+(Î³Î»)2Î´t+2â€‹+â‹¯+(Î³Î»)Tâˆ’tÎ´Tâ€‹è¿™é‡Œçš„ $\\lambda$ æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œä¸€èˆ¬å– 0.95ï¼š å¦‚æœ $\\lambda = 0$ï¼ŒGAE å°±é€€åŒ–æˆäº†å•çº¯çš„ TD Errorã€‚ å¦‚æœ $\\lambda = 1$ï¼ŒGAE å°±å˜æˆäº†è’™ç‰¹å¡æ´›é‡‡æ ·ï¼Œç®—å‡ºæ•´æ¡è·¯å¾„çš„æ€»å’Œã€‚ ä»£ç å®ç°ä¸Šï¼Œç”±äºç®—å‡º t æ—¶åˆ»çš„ $A_t^{GAE}$ éœ€è¦ä¹‹å‰ t+1 æ—¶åˆ»ä¹‹åçš„ $\\delta_t$ ï¼Œæ‰€ä»¥éœ€è¦å¯¹ token é€†åºçš„å¤„ç†ã€‚ äºæ˜¯ A2C çš„æ­¥éª¤å³ä¸ºï¼š æ¼”å‘˜æ”¶åˆ°æ¥è‡ªç¯å¢ƒçš„çŠ¶æ€Â $S_t$ï¼Œç”ŸæˆåŠ¨ä½œÂ $A_t$ ç¯å¢ƒæ”¶åˆ° $A_t$Â ä¹‹åç»™å‡ºå¥–åŠ±Â $R_t$Â å’Œæ–°çŠ¶æ€Â $S_{t+1}$ è¯„è®ºå®¶ä¼°è®¡çŠ¶æ€ä»·å€¼Â $V(S_t)ï¼ŒV(S_{t+1})$ï¼ŒÂ å¹¶è®¡ç®—ä¼˜åŠ¿Â $Adv(S_t, A_t) = A_t^{GAE}$ æ¼”å‘˜ç”¨Â $loss = -\\log p(A_t|S_t) \\text{Adv}(S_t, A_t)$Â æ›´æ–°å‚æ•° è¯„è®ºå®¶ç”¨Â $loss = [\\text{Adv}(S_t, A_t)] ^2$Â æ›´æ–°å‚æ•° ","date":"2026-02-19","objectID":"/posts/rlhf-fundamental/:3:0","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šåŸºç¡€çŸ¥è¯†","uri":"/posts/rlhf-fundamental/#a2c-ç®—æ³•"},{"categories":null,"content":" KL æ•£åº¦åœ¨ RLHF ä¸­å­˜åœ¨ Reward Hacking è¿™ä¸ªæ¦‚å¿µï¼Œè®­ç»ƒè¿‡ç¨‹ä¸­æ¨¡å‹å¯èƒ½ä¼šæœç€ Reward å€¾å‘çš„æ–¹å‘èµ°æ·å¾„ã€‚æ¯”å¦‚ prompt æ˜¯ â€œä»Šå¤©çš„å¤©æ°”å¦‚ä½•â€ï¼Œé‚£ä¹ˆæ¨¡å‹ä¼šç”Ÿæˆå¤©æ°”æƒ…å†µçš„åˆ†æç„¶åå†å‘Šè¯‰ä»Šå¤©çš„å¤©æ°”ï¼Œä¾æ¬¡æ¥è·å–æ›´é«˜çš„ rewardã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ loss ä¸­å¢åŠ ä¸€é¡¹ï¼Œé¿å…æ¨¡å‹è¿‡åº¦å­¦ä¹ ï¼Œæˆ–è€…è¯´è®©è®­ç»ƒåçš„æ¨¡å‹å’ŒåŸæ¨¡å‹å·®è·å°ä¸€äº›ã€‚RLHF ä¸­å¼•å…¥äº†ä¸€ä¸ª Ref Modelï¼Œè¿™ä¸ªæ¨¡å‹å°±æ˜¯ç»è¿‡ SFT è®­ç»ƒåå†»ç»“çš„æ¨¡å‹ã€‚æˆ‘ä»¬ç”¨å®ƒå’Œæ–°æ¨¡å‹è®¡ç®— KL æ•£åº¦ï¼Œæ¥è¡¡é‡æ¨¡å‹ç›¸è¾ƒäºåŸå…ˆçš„å˜åŒ–ã€‚KL æ•£åº¦çš„è®¡ç®—å…¬å¼ä¸ºï¼š KL=1nâˆ‘responselogp(aâˆ£s)pref(aâˆ£s) \\text{KL} = \\frac{1}{n}\\sum_{\\text{response}}{log{\\frac{p(a|s)}{p_{ref}(a|s)}}} KL=n1â€‹responseâˆ‘â€‹logprefâ€‹(aâˆ£s)p(aâˆ£s)â€‹é¦–å…ˆï¼Œæˆ‘ä»¬å–‚ä¸€ä¸ª prompt ç»™ Actor æ¨¡å‹ï¼Œè®©å®ƒæ­£å¸¸è¾“å‡ºå¯¹åº”çš„ responseã€‚response ä¸­æ¯ä¸€ä¸ª token éƒ½æœ‰å®ƒå¯¹åº”çš„æ¦‚ç‡åˆ†å¸ƒï¼Œæˆ‘ä»¬æŠŠå®ƒè®°ä¸ºÂ log_probsã€‚æˆ‘ä»¬æŠŠ Actor ç”Ÿæˆçš„\"prompt + response\" ä»¥ Teacher-Forcing çš„æ–¹å¼å–‚ç»™ Reference æ¨¡å‹ï¼Œé‚£ä¹ˆå®ƒåŒæ ·èƒ½ç»™å‡º response ä¸­æ¯ä¸ª token çš„ log_prob ç»“æœï¼Œæˆ‘ä»¬è®°å…¶ä¸º ref_log_probsã€‚æŠŠè¿™ä¸¤ä¸ªæ¦‚ç‡åˆ†å¸ƒä½œå·®ï¼Œç„¶åå†æ±‚å¯¹æ•°ä¹‹å’Œçš„å¹³å‡å€¼ï¼Œå°±æ˜¯ KL æ•£åº¦äº†ã€‚ KL æ•£åº¦çš„æ ‡å‡†å®šä¹‰åº”è¯¥æ˜¯ï¼šå¯¹äºå•ä¸ª token çš„ KL æ•£åº¦æ˜¯è¦å¯¹ vocab ä¸Š æ¯ä¸€ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒä½œå·®ã€‚ä½†æ˜¯åœ¨ RLHF çš„å®é™…å®ç°ä¸­ï¼ŒKL åªé’ˆå¯¹Â Actor å®é™…ç”Ÿæˆçš„ token è®¡ç®—æ¦‚ç‡å·®ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—Â log p_actor(response[t]) âˆ’ log p_ref(response[t])ã€‚ Hugging Face çš„ trl åº“ä¸­ KL æƒ©ç½šçš„è®¡ç®—é€»è¾‘å¯ä»¥ç®€åŒ–å¦‚ä¸‹ï¼š python # 1. è·å–å½“å‰æ¨¡å‹ç”Ÿæˆ token çš„ log_prob log_probs = actor_model.get_log_probs(states, actions) # 2. è·å–å‚è€ƒæ¨¡å‹ (Ref) ç”ŸæˆåŒæ · token çš„ log_prob # æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦ ref_model è¾“å‡ºæ•´ä¸ª vocab çš„åˆ†å¸ƒï¼Œåªéœ€è¦ gather å¯¹åº” action çš„å€¼ ref_log_probs = ref_model.get_log_probs(states, actions) # 3. è®¡ç®— KL ä¼°è®¡ kl = log_probs - ref_log_probs # 4. åŠ å…¥ Loss # é€šå¸¸è¿˜ä¼šä¹˜ä¸€ä¸ªç³»æ•° betaï¼Œå¹¶ä¸”æœ‰æ—¶ä¼šå– abs(kl) æˆ–è€…æ ¹æ®æ–¹å‘è°ƒæ•´ loss = ppo_loss + beta * kl get_log_probs å‡½æ•°å†…éƒ¨é€šå¸¸æ˜¯é€šè¿‡ gather æ“ä½œï¼Œç›´æ¥ä» logits ä¸­å–å‡ºå¯¹åº” action ç´¢å¼•çš„å€¼ï¼Œè€Œä¸æ˜¯éå†æ•´ä¸ª vocabã€‚ å¼ºåŒ–å­¦ä¹ ä¸­æ ‡å‡†çš„ KL Divergence å…¬å¼ä¸ºï¼š DKL(Pâˆ¥Q)=âˆ‘xP(x)logâ¡P(x)Q(x)D_{KL}(P \\parallel Q) = \\sum_{x} P(x) \\log \\frac{P(x)}{Q(x)}DKLâ€‹(Pâˆ¥Q)=xâˆ‘â€‹P(x)logQ(x)P(x)â€‹è¿™é‡Œçš„ $x$ æ˜¯å…¨éƒ¨çš„å¯èƒ½æ€§ï¼Œè€Œæˆ‘ä»¬åœ¨ PPO é‡Œé¢æ— æ³•éå†æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€å’ŒåŠ¨ä½œ $x$ æ¥è®¡ç®—ä¸Šé¢çš„æ±‚å’Œ $\\sum$ã€‚æˆ‘ä»¬åªèƒ½é€šè¿‡é‡‡æ ·æ¥è¿›è¡Œè’™ç‰¹å¡æ´›ä¼°è®¡ï¼š âˆ‘xP(x)logâ¡P(x)Q(x)=âˆ‘xilogP(xi)Q(xi)\\sum_{x} P(x) \\log \\frac{P(x)}{Q(x)} = \\sum_{x_i}log\\frac{P(x_i)}{Q(x_i)}xâˆ‘â€‹P(x)logQ(x)P(x)â€‹=xiâ€‹âˆ‘â€‹logQ(xiâ€‹)P(xiâ€‹)â€‹ ","date":"2026-02-19","objectID":"/posts/rlhf-fundamental/:4:0","series":["RLHF"],"tags":["å¤§æ¨¡å‹","å¼ºåŒ–å­¦ä¹ "],"title":"LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šåŸºç¡€çŸ¥è¯†","uri":"/posts/rlhf-fundamental/#kl-æ•£åº¦"},{"categories":null,"content":" SFTTrainer","date":"2026-02-18","objectID":"/posts/trainer/:1:0","series":["Transformerç›¸å…³","LLM"],"tags":["å¤§æ¨¡å‹"],"title":"transformers åº“æä¾›çš„æ›´æ–¹ä¾¿çš„ Trainer","uri":"/posts/trainer/#sfttrainer"},{"categories":null,"content":" å‡½æ•°è°ƒç”¨æˆ‘ä»¬ä¸»è¦ä¾èµ– Huggingface çš„ transformers åº“ä»¥åŠ trl åº“æ¥è¿›è¡Œè‡ªåŠ¨åŒ–å¾®è°ƒã€‚ python from transformers import AutoModelForCausalLM, AutoTokenizer from trl import SFTConfig, SFTTrainer SFTTrainer è´Ÿè´£æ¨¡å‹çš„ç›‘ç£å¾®è°ƒï¼ŒSFTConfig ä¼ å…¥äº†è®­ç»ƒæ—¶å¿…é¡»çš„å‚æ•°ï¼ŒåŒ…æ‹¬å­¦ä¹ ç‡ã€batch_sizeç­‰ç­‰ã€‚ python sft_config = SFTConfig( output_dir=args.save_dir, per_device_train_batch_size=args.batch_size, gradient_accumulation_steps=args.accumulation_steps, learning_rate=args.lr, logging_steps=args.log_interval, fp16=(args.dtype == \"float16\"), bf16=(args.dtype == \"bfloat16\"), num_train_epochs=args.epochs, save_steps=args.save_interval, optim=\"paged_adamw_32bit\", max_length=args.max_length, packing=False, ) trainer = SFTTrainer( model=model, tokenizer=tokenizer, args=sft_config, train_dataset=custom_dataset, ) trainer.train() ","date":"2026-02-18","objectID":"/posts/trainer/:1:1","series":["Transformerç›¸å…³","LLM"],"tags":["å¤§æ¨¡å‹"],"title":"transformers åº“æä¾›çš„æ›´æ–¹ä¾¿çš„ Trainer","uri":"/posts/trainer/#å‡½æ•°è°ƒç”¨"},{"categories":null,"content":" æ•°æ®å†…å®¹æ ¼å¼ Tensor Format python return { \"input_ids\": tensor, \"attention_mask\": tensor, \"labels\": tensor } å½“ SFTTrainer æ£€æµ‹åˆ°ä¼ å…¥çš„ train_dataset å·²ç»åŒ…å«äº† input_ids ç­‰æ¨¡å‹éœ€è¦çš„å¼ é‡å­—æ®µæ—¶ï¼Œå®ƒä¼šè·³è¿‡å†…éƒ¨çš„æ ¼å¼åŒ–é€»è¾‘ï¼Œç›´æ¥æŠŠæ•°æ®å–‚ç»™æ¨¡å‹ã€‚ Conversation Formatç¬¬äºŒç§æ–¹æ³•æ˜¯æŠŠæ•°æ®é¢„å¤„ç†ä¸ºé€šç”¨çš„æ ¼å¼ï¼š python return { \"messages\": [ {\"role\": \"user\", \"content\": \"ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚\"}, {\"role\": \"assistant\", \"content\": \"ä½ å¥½ï¼æˆ‘æ˜¯ç”± AI è®­ç»ƒçš„å¤§è¯­è¨€æ¨¡å‹ã€‚\"} ] } ä¸€å®šè¦åŒ…å« messages è¿™ä¸ª keyï¼ŒSFTTrainer ä¼šè‡ªåŠ¨è¯»å–æ¨¡å‹å†…ç½®çš„ tokenizer.chat_template æ¥æ‹¼æ¥å¯¹è¯ã€‚ Raw Text Formatç¬¬ä¸‰ç§æ–¹æ³•æ˜¯ç”¨çº¯æ–‡æœ¬æ ¼å¼ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µæŠŠæ‰€æœ‰ Prompt å’Œ Answer æ‹¼æˆäº†ä¸€ä¸ªé•¿å­—ç¬¦ä¸²ï¼Œå­˜åœ¨ text å­—æ®µä¸­ã€‚ python return {\"text\": \"User: 1+1ç­‰äºå‡ ï¼Ÿ Assistant: ç­‰äº2ã€‚\"} åœ¨ SFTConfig ä¸­æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŒ‡å®š dataset_text_fieldï¼Œæ ‡å¿—äº†æ–‡æœ¬å­˜åœ¨å“ªä¸ªå­—æ®µã€‚ Instruction Formatå¦‚æœæˆ‘ä»¬ç›‘ç£å¾®è°ƒçš„æ•°æ®æ˜¯ instruction ç±»å‹çš„ï¼Œä¾‹å¦‚ â€œæŠŠå¥å­ç¿»è¯‘æˆè‹±æ–‡ï¼šä»Šå¤©å¤©æ°”å¾ˆå¥½â€ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨è¿™ç§å†…å®¹æ ¼å¼ï¼š python return { \"instruction\": \"æŠŠå¥å­ç¿»è¯‘æˆè‹±æ–‡\", \"input\": \"ä»Šå¤©å¤©æ°”å¾ˆå¥½\", \"output\": \"The weather is nice today.\" } è¿™ç§æ–¹å¼æˆ‘ä»¬éœ€è¦æ˜ç¡®ä¼ å…¥ formatting_func æ¥ç»„åˆ instructionã€input å’Œ outputï¼Œä¾‹å¦‚ï¼š python def my_template(instruction, input_text, output_text): return f\"### Instruction:\\n{instruction}\\n\\n### Input:\\n{input_text}\\n\\n###Response:\\n{output_text}\" def formatting_prompts_func(examples): output_texts = [] for example in range(examples): text = my_template( example['instruction'], example['input'], example['output'] ) output_texts.append(text) return output_texts ","date":"2026-02-18","objectID":"/posts/trainer/:1:2","series":["Transformerç›¸å…³","LLM"],"tags":["å¤§æ¨¡å‹"],"title":"transformers åº“æä¾›çš„æ›´æ–¹ä¾¿çš„ Trainer","uri":"/posts/trainer/#æ•°æ®å†…å®¹æ ¼å¼"},{"categories":null,"content":" æ•°æ®å†…å®¹æ ¼å¼ Tensor Format python return { \"input_ids\": tensor, \"attention_mask\": tensor, \"labels\": tensor } å½“ SFTTrainer æ£€æµ‹åˆ°ä¼ å…¥çš„ train_dataset å·²ç»åŒ…å«äº† input_ids ç­‰æ¨¡å‹éœ€è¦çš„å¼ é‡å­—æ®µæ—¶ï¼Œå®ƒä¼šè·³è¿‡å†…éƒ¨çš„æ ¼å¼åŒ–é€»è¾‘ï¼Œç›´æ¥æŠŠæ•°æ®å–‚ç»™æ¨¡å‹ã€‚ Conversation Formatç¬¬äºŒç§æ–¹æ³•æ˜¯æŠŠæ•°æ®é¢„å¤„ç†ä¸ºé€šç”¨çš„æ ¼å¼ï¼š python return { \"messages\": [ {\"role\": \"user\", \"content\": \"ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚\"}, {\"role\": \"assistant\", \"content\": \"ä½ å¥½ï¼æˆ‘æ˜¯ç”± AI è®­ç»ƒçš„å¤§è¯­è¨€æ¨¡å‹ã€‚\"} ] } ä¸€å®šè¦åŒ…å« messages è¿™ä¸ª keyï¼ŒSFTTrainer ä¼šè‡ªåŠ¨è¯»å–æ¨¡å‹å†…ç½®çš„ tokenizer.chat_template æ¥æ‹¼æ¥å¯¹è¯ã€‚ Raw Text Formatç¬¬ä¸‰ç§æ–¹æ³•æ˜¯ç”¨çº¯æ–‡æœ¬æ ¼å¼ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µæŠŠæ‰€æœ‰ Prompt å’Œ Answer æ‹¼æˆäº†ä¸€ä¸ªé•¿å­—ç¬¦ä¸²ï¼Œå­˜åœ¨ text å­—æ®µä¸­ã€‚ python return {\"text\": \"User: 1+1ç­‰äºå‡ ï¼Ÿ Assistant: ç­‰äº2ã€‚\"} åœ¨ SFTConfig ä¸­æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŒ‡å®š dataset_text_fieldï¼Œæ ‡å¿—äº†æ–‡æœ¬å­˜åœ¨å“ªä¸ªå­—æ®µã€‚ Instruction Formatå¦‚æœæˆ‘ä»¬ç›‘ç£å¾®è°ƒçš„æ•°æ®æ˜¯ instruction ç±»å‹çš„ï¼Œä¾‹å¦‚ â€œæŠŠå¥å­ç¿»è¯‘æˆè‹±æ–‡ï¼šä»Šå¤©å¤©æ°”å¾ˆå¥½â€ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨è¿™ç§å†…å®¹æ ¼å¼ï¼š python return { \"instruction\": \"æŠŠå¥å­ç¿»è¯‘æˆè‹±æ–‡\", \"input\": \"ä»Šå¤©å¤©æ°”å¾ˆå¥½\", \"output\": \"The weather is nice today.\" } è¿™ç§æ–¹å¼æˆ‘ä»¬éœ€è¦æ˜ç¡®ä¼ å…¥ formatting_func æ¥ç»„åˆ instructionã€input å’Œ outputï¼Œä¾‹å¦‚ï¼š python def my_template(instruction, input_text, output_text): return f\"### Instruction:\\n{instruction}\\n\\n### Input:\\n{input_text}\\n\\n###Response:\\n{output_text}\" def formatting_prompts_func(examples): output_texts = [] for example in range(examples): text = my_template( example['instruction'], example['input'], example['output'] ) output_texts.append(text) return output_texts ","date":"2026-02-18","objectID":"/posts/trainer/:1:2","series":["Transformerç›¸å…³","LLM"],"tags":["å¤§æ¨¡å‹"],"title":"transformers åº“æä¾›çš„æ›´æ–¹ä¾¿çš„ Trainer","uri":"/posts/trainer/#tensor-format"},{"categories":null,"content":" æ•°æ®å†…å®¹æ ¼å¼ Tensor Format python return { \"input_ids\": tensor, \"attention_mask\": tensor, \"labels\": tensor } å½“ SFTTrainer æ£€æµ‹åˆ°ä¼ å…¥çš„ train_dataset å·²ç»åŒ…å«äº† input_ids ç­‰æ¨¡å‹éœ€è¦çš„å¼ é‡å­—æ®µæ—¶ï¼Œå®ƒä¼šè·³è¿‡å†…éƒ¨çš„æ ¼å¼åŒ–é€»è¾‘ï¼Œç›´æ¥æŠŠæ•°æ®å–‚ç»™æ¨¡å‹ã€‚ Conversation Formatç¬¬äºŒç§æ–¹æ³•æ˜¯æŠŠæ•°æ®é¢„å¤„ç†ä¸ºé€šç”¨çš„æ ¼å¼ï¼š python return { \"messages\": [ {\"role\": \"user\", \"content\": \"ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚\"}, {\"role\": \"assistant\", \"content\": \"ä½ å¥½ï¼æˆ‘æ˜¯ç”± AI è®­ç»ƒçš„å¤§è¯­è¨€æ¨¡å‹ã€‚\"} ] } ä¸€å®šè¦åŒ…å« messages è¿™ä¸ª keyï¼ŒSFTTrainer ä¼šè‡ªåŠ¨è¯»å–æ¨¡å‹å†…ç½®çš„ tokenizer.chat_template æ¥æ‹¼æ¥å¯¹è¯ã€‚ Raw Text Formatç¬¬ä¸‰ç§æ–¹æ³•æ˜¯ç”¨çº¯æ–‡æœ¬æ ¼å¼ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µæŠŠæ‰€æœ‰ Prompt å’Œ Answer æ‹¼æˆäº†ä¸€ä¸ªé•¿å­—ç¬¦ä¸²ï¼Œå­˜åœ¨ text å­—æ®µä¸­ã€‚ python return {\"text\": \"User: 1+1ç­‰äºå‡ ï¼Ÿ Assistant: ç­‰äº2ã€‚\"} åœ¨ SFTConfig ä¸­æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŒ‡å®š dataset_text_fieldï¼Œæ ‡å¿—äº†æ–‡æœ¬å­˜åœ¨å“ªä¸ªå­—æ®µã€‚ Instruction Formatå¦‚æœæˆ‘ä»¬ç›‘ç£å¾®è°ƒçš„æ•°æ®æ˜¯ instruction ç±»å‹çš„ï¼Œä¾‹å¦‚ â€œæŠŠå¥å­ç¿»è¯‘æˆè‹±æ–‡ï¼šä»Šå¤©å¤©æ°”å¾ˆå¥½â€ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨è¿™ç§å†…å®¹æ ¼å¼ï¼š python return { \"instruction\": \"æŠŠå¥å­ç¿»è¯‘æˆè‹±æ–‡\", \"input\": \"ä»Šå¤©å¤©æ°”å¾ˆå¥½\", \"output\": \"The weather is nice today.\" } è¿™ç§æ–¹å¼æˆ‘ä»¬éœ€è¦æ˜ç¡®ä¼ å…¥ formatting_func æ¥ç»„åˆ instructionã€input å’Œ outputï¼Œä¾‹å¦‚ï¼š python def my_template(instruction, input_text, output_text): return f\"### Instruction:\\n{instruction}\\n\\n### Input:\\n{input_text}\\n\\n###Response:\\n{output_text}\" def formatting_prompts_func(examples): output_texts = [] for example in range(examples): text = my_template( example['instruction'], example['input'], example['output'] ) output_texts.append(text) return output_texts ","date":"2026-02-18","objectID":"/posts/trainer/:1:2","series":["Transformerç›¸å…³","LLM"],"tags":["å¤§æ¨¡å‹"],"title":"transformers åº“æä¾›çš„æ›´æ–¹ä¾¿çš„ Trainer","uri":"/posts/trainer/#conversation-format"},{"categories":null,"content":" æ•°æ®å†…å®¹æ ¼å¼ Tensor Format python return { \"input_ids\": tensor, \"attention_mask\": tensor, \"labels\": tensor } å½“ SFTTrainer æ£€æµ‹åˆ°ä¼ å…¥çš„ train_dataset å·²ç»åŒ…å«äº† input_ids ç­‰æ¨¡å‹éœ€è¦çš„å¼ é‡å­—æ®µæ—¶ï¼Œå®ƒä¼šè·³è¿‡å†…éƒ¨çš„æ ¼å¼åŒ–é€»è¾‘ï¼Œç›´æ¥æŠŠæ•°æ®å–‚ç»™æ¨¡å‹ã€‚ Conversation Formatç¬¬äºŒç§æ–¹æ³•æ˜¯æŠŠæ•°æ®é¢„å¤„ç†ä¸ºé€šç”¨çš„æ ¼å¼ï¼š python return { \"messages\": [ {\"role\": \"user\", \"content\": \"ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚\"}, {\"role\": \"assistant\", \"content\": \"ä½ å¥½ï¼æˆ‘æ˜¯ç”± AI è®­ç»ƒçš„å¤§è¯­è¨€æ¨¡å‹ã€‚\"} ] } ä¸€å®šè¦åŒ…å« messages è¿™ä¸ª keyï¼ŒSFTTrainer ä¼šè‡ªåŠ¨è¯»å–æ¨¡å‹å†…ç½®çš„ tokenizer.chat_template æ¥æ‹¼æ¥å¯¹è¯ã€‚ Raw Text Formatç¬¬ä¸‰ç§æ–¹æ³•æ˜¯ç”¨çº¯æ–‡æœ¬æ ¼å¼ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µæŠŠæ‰€æœ‰ Prompt å’Œ Answer æ‹¼æˆäº†ä¸€ä¸ªé•¿å­—ç¬¦ä¸²ï¼Œå­˜åœ¨ text å­—æ®µä¸­ã€‚ python return {\"text\": \"User: 1+1ç­‰äºå‡ ï¼Ÿ Assistant: ç­‰äº2ã€‚\"} åœ¨ SFTConfig ä¸­æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŒ‡å®š dataset_text_fieldï¼Œæ ‡å¿—äº†æ–‡æœ¬å­˜åœ¨å“ªä¸ªå­—æ®µã€‚ Instruction Formatå¦‚æœæˆ‘ä»¬ç›‘ç£å¾®è°ƒçš„æ•°æ®æ˜¯ instruction ç±»å‹çš„ï¼Œä¾‹å¦‚ â€œæŠŠå¥å­ç¿»è¯‘æˆè‹±æ–‡ï¼šä»Šå¤©å¤©æ°”å¾ˆå¥½â€ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨è¿™ç§å†…å®¹æ ¼å¼ï¼š python return { \"instruction\": \"æŠŠå¥å­ç¿»è¯‘æˆè‹±æ–‡\", \"input\": \"ä»Šå¤©å¤©æ°”å¾ˆå¥½\", \"output\": \"The weather is nice today.\" } è¿™ç§æ–¹å¼æˆ‘ä»¬éœ€è¦æ˜ç¡®ä¼ å…¥ formatting_func æ¥ç»„åˆ instructionã€input å’Œ outputï¼Œä¾‹å¦‚ï¼š python def my_template(instruction, input_text, output_text): return f\"### Instruction:\\n{instruction}\\n\\n### Input:\\n{input_text}\\n\\n###Response:\\n{output_text}\" def formatting_prompts_func(examples): output_texts = [] for example in range(examples): text = my_template( example['instruction'], example['input'], example['output'] ) output_texts.append(text) return output_texts ","date":"2026-02-18","objectID":"/posts/trainer/:1:2","series":["Transformerç›¸å…³","LLM"],"tags":["å¤§æ¨¡å‹"],"title":"transformers åº“æä¾›çš„æ›´æ–¹ä¾¿çš„ Trainer","uri":"/posts/trainer/#raw-text-format"},{"categories":null,"content":" æ•°æ®å†…å®¹æ ¼å¼ Tensor Format python return { \"input_ids\": tensor, \"attention_mask\": tensor, \"labels\": tensor } å½“ SFTTrainer æ£€æµ‹åˆ°ä¼ å…¥çš„ train_dataset å·²ç»åŒ…å«äº† input_ids ç­‰æ¨¡å‹éœ€è¦çš„å¼ é‡å­—æ®µæ—¶ï¼Œå®ƒä¼šè·³è¿‡å†…éƒ¨çš„æ ¼å¼åŒ–é€»è¾‘ï¼Œç›´æ¥æŠŠæ•°æ®å–‚ç»™æ¨¡å‹ã€‚ Conversation Formatç¬¬äºŒç§æ–¹æ³•æ˜¯æŠŠæ•°æ®é¢„å¤„ç†ä¸ºé€šç”¨çš„æ ¼å¼ï¼š python return { \"messages\": [ {\"role\": \"user\", \"content\": \"ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚\"}, {\"role\": \"assistant\", \"content\": \"ä½ å¥½ï¼æˆ‘æ˜¯ç”± AI è®­ç»ƒçš„å¤§è¯­è¨€æ¨¡å‹ã€‚\"} ] } ä¸€å®šè¦åŒ…å« messages è¿™ä¸ª keyï¼ŒSFTTrainer ä¼šè‡ªåŠ¨è¯»å–æ¨¡å‹å†…ç½®çš„ tokenizer.chat_template æ¥æ‹¼æ¥å¯¹è¯ã€‚ Raw Text Formatç¬¬ä¸‰ç§æ–¹æ³•æ˜¯ç”¨çº¯æ–‡æœ¬æ ¼å¼ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µæŠŠæ‰€æœ‰ Prompt å’Œ Answer æ‹¼æˆäº†ä¸€ä¸ªé•¿å­—ç¬¦ä¸²ï¼Œå­˜åœ¨ text å­—æ®µä¸­ã€‚ python return {\"text\": \"User: 1+1ç­‰äºå‡ ï¼Ÿ Assistant: ç­‰äº2ã€‚\"} åœ¨ SFTConfig ä¸­æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŒ‡å®š dataset_text_fieldï¼Œæ ‡å¿—äº†æ–‡æœ¬å­˜åœ¨å“ªä¸ªå­—æ®µã€‚ Instruction Formatå¦‚æœæˆ‘ä»¬ç›‘ç£å¾®è°ƒçš„æ•°æ®æ˜¯ instruction ç±»å‹çš„ï¼Œä¾‹å¦‚ â€œæŠŠå¥å­ç¿»è¯‘æˆè‹±æ–‡ï¼šä»Šå¤©å¤©æ°”å¾ˆå¥½â€ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨è¿™ç§å†…å®¹æ ¼å¼ï¼š python return { \"instruction\": \"æŠŠå¥å­ç¿»è¯‘æˆè‹±æ–‡\", \"input\": \"ä»Šå¤©å¤©æ°”å¾ˆå¥½\", \"output\": \"The weather is nice today.\" } è¿™ç§æ–¹å¼æˆ‘ä»¬éœ€è¦æ˜ç¡®ä¼ å…¥ formatting_func æ¥ç»„åˆ instructionã€input å’Œ outputï¼Œä¾‹å¦‚ï¼š python def my_template(instruction, input_text, output_text): return f\"### Instruction:\\n{instruction}\\n\\n### Input:\\n{input_text}\\n\\n###Response:\\n{output_text}\" def formatting_prompts_func(examples): output_texts = [] for example in range(examples): text = my_template( example['instruction'], example['input'], example['output'] ) output_texts.append(text) return output_texts ","date":"2026-02-18","objectID":"/posts/trainer/:1:2","series":["Transformerç›¸å…³","LLM"],"tags":["å¤§æ¨¡å‹"],"title":"transformers åº“æä¾›çš„æ›´æ–¹ä¾¿çš„ Trainer","uri":"/posts/trainer/#instruction-format"},{"categories":null,"content":" æ•°æ®åŒ–è½½ä½“ ç›´æ¥ä¼  listï¼ŒSFTTrainer å†…éƒ¨ä¼šå·å·æŠŠ list è½¬æ¢æˆ datasets.Dataset å¤„ç† torch.utils.data.Dataset å°±æ˜¯æˆ‘ä»¬ä¹‹å‰ç»§æ‰¿å®ç°çš„è‡ªå®šä¹‰æ•°æ®é›†ï¼Œåœ¨ __getitem__ é‡Œé¢å¯ä»¥çµæ´»å¤„ç†å¤æ‚çš„é€»è¾‘ã€‚ datasets.load_dataset å¥½å¤„æ˜¯æ”¯æŒç£ç›˜æ˜ å°„ã€å¤šè¿›ç¨‹é¢„å¤„ç†ã€è‡ªåŠ¨ç¼“å­˜ã€‚ ","date":"2026-02-18","objectID":"/posts/trainer/:1:3","series":["Transformerç›¸å…³","LLM"],"tags":["å¤§æ¨¡å‹"],"title":"transformers åº“æä¾›çš„æ›´æ–¹ä¾¿çš„ Trainer","uri":"/posts/trainer/#æ•°æ®åŒ–è½½ä½“"},{"categories":null,"content":" NF4 é‡åŒ–ä»‹ç» NF4 é‡åŒ–ä¹‹å‰æˆ‘ä»¬å…ˆè¯´è¯´é‡åŒ–æ˜¯ä»€ä¹ˆï¼Œé‡åŒ–æœ¬è´¨æ˜¯æŠŠ æµ®ç‚¹æ•°å¼ é‡å‹ç¼©åˆ°æœ‰é™çš„æ•´æ•°é›†åˆé‡Œã€‚ä¾‹å¦‚ INT4 é‡åŒ–ï¼Œå°±æ˜¯æŠŠæ‰€æœ‰æµ®ç‚¹æ•°æ˜ å°„åˆ° $2^4$ ä¸ªæ•´æ•°ä¹Ÿå°±æ˜¯ [-8, 7] çš„åŒºé—´å†…ï¼Œè¿™æ ·å­å°±åªéœ€è¦å­˜å‚¨è¿™ 4ä¸ª bit ä¹Ÿå°±æ˜¯ 0.5Bã€‚å…·ä½“çš„å…¬å¼æ˜¯ï¼š xintâ‰ˆround(xfloatÃ·scale)â‰ˆround(xfÃ·max(abs(xf))7) x_{int} \\approx \\text{round}(x_{float} \\div \\text{scale}) \\approx \\text{round}(x_f \\div \\frac{max(abs(x_f))}{7}) xintâ€‹â‰ˆround(xfloatâ€‹Ã·scale)â‰ˆround(xfâ€‹Ã·7max(abs(xfâ€‹))â€‹)ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦é™¤ä»¥ scale å‘¢ï¼Ÿscale é€šå¸¸è¡¨ç¤º â€œ1 ä¸ªæ•´æ•°å•ä½ä»£è¡¨å¤šå°‘æµ®ç‚¹æ•°å€¼â€ã€‚æˆ‘ä»¬è®¾æƒ³ä¸€ä¸ªä¾‹å­ï¼Œå‡å¦‚å‘é‡ x=[-0.7, -0.5, 0.1, 0.9, 1.4]ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒæ˜ å°„åˆ° INT4 ä¹Ÿå°±æ˜¯ [-8, 7] çš„æ•´æ•°åŒºé—´å†…ã€‚é‚£æˆ‘ä»¬è®¡ç®—å¾—åˆ° $scale = \\frac{1.4}{7}=0.2$ ä¹Ÿå°±æ˜¯ä¸€ä¸ªæ•´æ•°åŒºé—´è¡¨ç¤º 0.2 ä¸ªæµ®ç‚¹æ•°å€¼ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æŠŠ 1.4 æ˜ å°„åˆ° 7ï¼Œ-0.7 æ˜ å°„åˆ° -4ï¼Œçœ‹èµ·æ¥å°±å¾ˆåˆç†äº†å¯¹å§ï¼Ÿ ä½†æ˜¯åœ¨æ¨¡å‹çš„å‚æ•°ä¸­éš¾å…å‡ºç°æç«¯çš„åˆ†å¸ƒï¼Œä¾‹å¦‚ [-0.7, 0.2, 1.2, 1000]ã€‚è¿™æ · 1000 å°±ä¼šä¸¥é‡å¹²æ‰°æµ®ç‚¹æ•°å’Œæ•´æ•°çš„æ˜ å°„ï¼Œscale å˜å¾—å¾ˆå¤§å°±ä¼šå¯¼è‡´æ¨¡å‹ç²¾åº¦æŸå¤±å¾ˆä¸¥é‡ï¼Œæ‰€ä»¥ LLM ä¸€èˆ¬ä¼šæ¯ 32 æˆ– 64 ä¸ªæƒé‡ä¸€ç»„ scaleã€‚ è¿™æ—¶å€™åˆæœ‰é—®é¢˜äº†ï¼šç»è¿‡é‡åŒ–æƒé‡çš„æ•°å€¼å®Œå…¨å˜æ ·äº†ï¼Œé‚£ä¹ˆæ¨¡å‹è¿˜èƒ½æ­£å¸¸è¾“å‡ºå—ï¼Ÿå®é™…ä¸Šæ¨ç†æ—¶ä¸ä¼šç›´æ¥æ‹¿é‡åŒ–çš„æ•´æ•°å»å½“çœŸå®æƒé‡ç”¨ï¼Œç®—å­å†…éƒ¨åšåé‡åŒ–ï¼Œé€šè¿‡ $x_{float} = x_{int} \\times scale$ å¾—åˆ°çœŸå®æƒé‡ã€‚ä½†æ˜¯é‚£äº›è¢«æ˜ å°„åˆ°ç›¸åŒæ•´æ•°çš„ä¸åŒæµ®ç‚¹æ•°ï¼Œå®ƒä»¬è¢«åé‡åŒ–ä¹‹åçš„å€¼å°±ç›¸åŒäº†ï¼Œè¿™å°±æ˜¯é‡åŒ–å¯¼è‡´çš„ç²¾åº¦æŸå¤±ã€‚ äº†è§£å®ŒåŸºç¡€çš„é‡åŒ–çŸ¥è¯†å°±å¯ä»¥è¯´è¯´ NF4 é‡åŒ–äº†ã€‚ä¼ ç»Ÿçš„ INT4/FP4 é‡åŒ–é€šå¸¸æ˜¯å‡åŒ€åˆ†å¸ƒçš„é‡åŒ–ï¼Œå®ƒä»¬åœ¨æ•°å€¼è½´ä¸Šå‡åŒ€åˆ†é…äº† 16 ä¸ªå€¼ã€‚ä½†æ˜¯æ ¹æ®ä¿¡æ¯è®ºï¼Œæƒé‡ä¸€èˆ¬éƒ½å‘ˆç°æ­£æ€åˆ†å¸ƒï¼š ä¹Ÿå°±æ˜¯è¯´åœ¨å€¼åœ¨ 0 é™„è¿‘çš„æƒé‡æœ€å¤šï¼Œç»å¯¹å€¼è¶Šå¤§æƒé‡åˆ†å¸ƒçš„å°±è¶Šå°‘ã€‚é‚£å¦‚æœæŒ‰ç…§ä¼ ç»Ÿçš„å‡åŒ€åˆ†å¸ƒé‡åŒ–å°±æ˜¾å¾—å¾ˆä¸åˆç†äº†ï¼Œ[-2, -0.15, -0.10, -0.9, -0.2, 0.1, 0.2, 0.3, 0.5, 0.11, 1.5, 2.1] æŒ‰ç…§å‡åŒ€åˆ†å¸ƒï¼Œå°±ä¼šå¯¼è‡´ 0 é™„è¿‘ å¤§é‡æ•°å€¼ç›¸è¿‘ çš„æƒé‡è¢«æ˜ å°„åˆ°ä¸€ä¸ªæ•´æ•°ä¸Šï¼Œè€Œä¸¤ä¾§å°‘é‡çš„æƒé‡èƒ½å¤Ÿå•ç‹¬æ˜ å°„åˆ°ä¸€ä¸ªæ•´æ•°ã€‚ NF4 çš„æ€è·¯å°±æ˜¯ï¼Œåœ¨ 0 çš„é™„è¿‘è®© scale æ›´å° â€”â€” æ•´æ•°å•ä½ä»£è¡¨æ›´å°‘çš„æµ®ç‚¹æ•°å€¼ï¼Œç»å¯¹å€¼è¶Šå¤§ scale è¶Šå¤§ã€‚åœ¨ç›¸åŒçš„ 4-bit å­˜å‚¨ç©ºé—´ä¸‹ï¼ŒNF4 èƒ½æ¯” INT4 ä¿ç•™æ›´å¤šçš„æƒé‡ä¿¡æ¯ï¼Œå°¤å…¶æ˜¯å¯¹äºæ¥è¿‘ 0 çš„å…³é”®æƒé‡ã€‚ ","date":"2026-02-17","objectID":"/posts/nf4-quantization/:1:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"NF4 é‡åŒ–å¤§æ¨¡å‹","uri":"/posts/nf4-quantization/#nf4-é‡åŒ–"},{"categories":null,"content":" åŒå±‚é‡åŒ–åœ¨é‡åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å­˜å‚¨ä¸€äº›ç»Ÿè®¡é‡æ¯”å¦‚ç¼©æ”¾å› å­ scale å’Œé›¶ç‚¹ zero_pointï¼Œæ¥å°† 4-bit æ•°æ®è¿˜åŸä¸ºé«˜ç²¾åº¦æµ®ç‚¹æ•°ã€‚æ™®é€šé‡åŒ–é€šå¸¸ä½¿ç”¨ FP32 å­˜å‚¨è¿™äº›ç»Ÿè®¡é‡ï¼ŒåŒé‡é‡åŒ–å°±æ˜¯å¯¹è¿™äº›ç»Ÿè®¡é‡å†æ¬¡è¿›è¡Œé‡åŒ–ï¼Œé€šå¸¸é‡åŒ–ä¸º 8-bitã€‚è¿™æ ·å¹³å‡æ¯å‚æ•°é¢å¤–èŠ‚çœçº¦ 0.37 bitï¼Œå¯¹äºå¤§æ¨¡å‹è¿™èƒ½èŠ‚çœæ•°ç™¾ MB åˆ°æ•° GB çš„æ˜¾å­˜ã€‚ ","date":"2026-02-17","objectID":"/posts/nf4-quantization/:2:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"NF4 é‡åŒ–å¤§æ¨¡å‹","uri":"/posts/nf4-quantization/#åŒå±‚é‡åŒ–"},{"categories":null,"content":" åˆ†é¡µä¼˜åŒ–å™¨åœ¨å‰å‘è®¡ç®—çš„æ—¶å€™ï¼Œç”±äºæˆ‘ä»¬éœ€è¦æŠŠåŸºæ¨¡ä¸­ NF4 å­˜å‚¨çš„çš„æƒé‡è¿›è¡Œåé‡åŒ–å¾—åˆ° FP16 çš„æƒé‡ï¼Œç„¶åä¸è¾“å…¥æ•°æ®åšè¿ç®—ï¼Œè¿™ä¼šå¯¼è‡´å¶å°”å‡ºç°å†…å­˜å³°å€¼ï¼Œå¯¼è‡´æ˜¾å­˜æº¢å‡ºã€‚ åˆ†é¡µä¼˜åŒ–å™¨å®ƒåˆ©ç”¨äº† NVIDIA çš„ç»Ÿä¸€å†…å­˜ç‰¹æ€§ã€‚å½“ GPU æ˜¾å­˜ç”±äºæ¢¯åº¦å³°å€¼ä¸å¤Ÿç”¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨æŠŠä¼˜åŒ–å™¨çŠ¶æ€æš‚æ—¶â€œæ¢é¡µâ€ç§»åˆ° CPU çš„å†…å­˜ï¼ˆRAMï¼‰é‡Œå»ï¼Œç­‰éœ€è¦æ›´æ–°æ—¶å†å–å›æ¥ã€‚è¿™è™½ç„¶ä¼šç¨å¾®æ…¢ä¸€ç‚¹ç‚¹ï¼Œä½†èƒ½ç¡®ä¿è¯è®­ç»ƒä¸ä¼šå› ä¸ºæ˜¾å­˜çˆ†äº†è€Œå´©æºƒã€‚ ","date":"2026-02-17","objectID":"/posts/nf4-quantization/:3:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"NF4 é‡åŒ–å¤§æ¨¡å‹","uri":"/posts/nf4-quantization/#åˆ†é¡µä¼˜åŒ–å™¨"},{"categories":null,"content":" å…·ä½“åº”ç”¨ python import torch from transformers import AutoModelForCausalLM, AutoTokenizer, BitsAndBytesConfig # 1. é…ç½®é‡åŒ–å‚æ•° bnb_config = BitsAndBytesConfig( load_in_4bit=True, # å¼€å¯ 4-bit é‡åŒ– bnb_4bit_quant_type=\"nf4\", bnb_4bit_use_double_quant=True, # å¼€å¯åŒé‡é‡åŒ– bnb_4bit_compute_dtype=torch.bfloat16 # è®¡ç®—æ—¶çš„ç²¾åº¦ ) # 2. åŠ è½½æ¨¡å‹ model_id = \"mistralai/Mistral-7B-v0.1\" tokenizer = AutoTokenizer.from_pretrained(model_id) tokenizer.pad_token = tokenizer.eos_token model = AutoModelForCausalLM.from_pretrained( model_id, quantization_config=bnb_config, device_map=\"auto\", torch_dtype=torch.bfloat16, # ä¸ compute_dtype ä¿æŒä¸€è‡´ ) ","date":"2026-02-17","objectID":"/posts/nf4-quantization/:4:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"NF4 é‡åŒ–å¤§æ¨¡å‹","uri":"/posts/nf4-quantization/#å…·ä½“åº”ç”¨"},{"categories":null,"content":" å¯¹æ¯”æ•°æ®ç”±äºæ‰‹å¤´åªæœ‰ä¸€ä¸ª RTX 3050Ti è·‘æ¨¡å‹ï¼ˆæ²¡é’±å» autodl ç§Ÿäº†ï¼‰ï¼Œæ‰€ä»¥è¿™æ¬¡å°±åœ¨ç¬”è®°æœ¬ä¸Šè·‘ Qwen3 0.6B å’Œ Qwen3 8B ä¸¤ä¸ªæ¨¡å‹ã€‚ å¯¹æ¯”å†…å­˜å ç”¨ é€šè¿‡ transformers åº“æä¾›çš„ get_memory_footprint æ–¹æ³•ï¼Œå¯ä»¥è®©æˆ‘ä»¬æ¸…æ™°åœ°çœ‹åˆ°æ¨¡å‹å ç”¨çš„æ˜¾å­˜ï¼š python tokenizer_fp16 = AutoTokenizer.from_pretrained(\"\") model_fp16 = AutoModelForCausalLM.from_pretrained(\"\", quantization_config=bnb_config, trust_remote_code=True, torch_dtype=torch.float16) print(f\"FP16 æ¨¡å‹å¤§å°ï¼š{model_fp16.get_memory_footprint() / 1024**3:0.3f}G\") del tokenizer_fp16 del model_fp16 tokenizer_nf4 = AutoTokenizer.from_pretrained(\"\") model_nf4 = AutoModelForCausalLM.from_pretrained(\"\", torch_dtype=torch.float16) print(f\"NF4 é‡åŒ–åæ¨¡å‹å¤§å°ï¼š{model_nf4.get_memory_footprint() / 1024**3:0.3f}G\") del tokenizer_nf4 del model_nf4 æ¨¡å‹\\ç²¾åº¦ FP16 NF4 Qwen3-0.6B 1.400G 0.785G Qwen3-8B 15.256G 5.553G å¾ˆæ˜¾ç„¶éšç€æ¨¡å‹å¤§å°å¢åŠ ï¼ŒNF4 é‡åŒ–å‡å°çš„å†…å­˜å ç”¨è¶Šæ¥è¶Šæ˜æ˜¾ã€‚ æ¨ç†é€Ÿåº¦å¯¹æ¯” å› ä¸ºæ˜¾å¡æ”¾ä¸ä¸‹ Qwen3-8Bï¼Œæ‰€ä»¥å°±å¯¹ 0.6B çš„æ¨¡å‹è¿›è¡Œæµ‹è¯•ï¼š python prompt = \"ä¸­å›½çš„é¦–éƒ½æ˜¯å“ªé‡Œï¼Ÿè¯·ç”¨ä¸­æ–‡å›ç­”ã€‚\" tokenizer_fp16 = AutoTokenizer.from_pretrained(\"\") model_fp16 = AutoModelForCausalLM.from_pretrained(\"\", torch_dtype=torch.float16).to(\"cuda\") print(f\"FP16 æ¨¡å‹å¤§å°ï¼š{model_fp16.get_memory_footprint() / 1024**3:0.3f}G\") start_time = time.time() inputs = tokenizer_fp16(prompt, return_tensors=\"pt\").to(\"cuda\") generated_ids_fp16 = model_fp16.generate(**inputs, max_new_tokens=50) end_time = time.time() fp16_time = end_time - start_time print(f\"FP16æ¨¡å‹ç”Ÿæˆ50ä¸ªè¯å…ƒè€—æ—¶: {fp16_time:.4f} ç§’\") del tokenizer_fp16 del model_fp16 è¿™é‡Œæˆ‘æµ‹è¯•äº†ç”Ÿæˆ 50 ä¸ª token çš„è€—æ—¶ï¼Œå®éªŒç»“æœå¦‚ä¸‹ï¼š æ¨¡å‹\\æ¨ç†è€—æ—¶ FP16 NF4 Qwen3-0.6B 3.2024s 4.7461s å®éªŒç»“æœæ¯”è¾ƒç¬¦åˆæˆ‘çš„çŒœæµ‹ï¼šåœ¨æ˜¾å­˜è¶³å¤Ÿå®¹çº³æ¨¡å‹çš„å‰æä¸‹ï¼ŒFP16 çš„çº¯æ¨ç†é€Ÿåº¦é€šå¸¸ç•¥å¿«äº NF4ã€‚å› ä¸º FP16 æœ‰åŸç”Ÿç¡¬ä»¶æ”¯æŒï¼ˆTensor Coreï¼‰ï¼Œå¹¶ä¸” NF4 éœ€è¦åé‡åŒ–è®¡ç®—ï¼Œä¼šå¼•å…¥é¢å¤–çš„è®¡ç®—å»¶è¿Ÿã€‚ä½†æ˜¯åœ¨æ˜¾å­˜ä¸è¶³çš„æƒ…å†µä¸‹ï¼ŒFP16 å¯èƒ½ä¼šé¢‘ç¹è§¦å‘å†…å­˜äº¤æ¢ï¼Œé‚£ä¹ˆ NF4 ä¹Ÿè®¸å°±ä¼šæ›´å¿«äº†ã€‚ æ€§èƒ½å¯¹æ¯” è¿™é‡Œæˆ‘ç›´æ¥è·‘ Gemini å†™çš„å›°æƒ‘åº¦è®¡ç®—çš„ä»£ç äº†ï¼š python import torch from datasets import load_dataset from tqdm import tqdm from transformers import AutoModelForCausalLM, AutoTokenizer, BitsAndBytesConfig # --- 1. å®šä¹‰ä¸€ä¸ªèƒ½å¤Ÿæ¥å—æ¨¡å‹å¯¹è±¡çš„ PPL è®¡ç®—å‡½æ•° --- def calculate_perplexity(model, tokenizer, text_list, device=\"cuda\", max_length=2048): model.eval() # å°†æ‰€æœ‰æ–‡æœ¬æ‹¼æ¥æˆä¸€ä¸ªé•¿å­—ç¬¦ä¸²ï¼ˆWikiText æ ‡å‡†è¯„æµ‹æ–¹å¼ï¼‰ # è¿‡æ»¤ç©ºè¡Œï¼Œé¿å…å™ªéŸ³ text = \"\\n\\n\".join([t for t in text_list if t.strip()]) encodings = tokenizer(text, return_tensors=\"pt\") input_ids = encodings.input_ids.to(device) nlls = [] stride = 512 # æ»‘åŠ¨çª—å£æ­¥é•¿ seq_len = input_ids.size(1) # ä½¿ç”¨æ»‘åŠ¨çª—å£è®¡ç®— Lossï¼Œè¿™æ˜¯æ ‡å‡†çš„ PPL è®¡ç®—é€»è¾‘ pbar = tqdm(range(0, seq_len, stride), desc=\"Calculating PPL\") for begin_loc in pbar: end_loc = min(begin_loc + max_length, seq_len) trg_len = end_loc - begin_loc # è¿™é‡Œçš„é€»è¾‘å¯èƒ½æœ‰ç»†å¾®å·®å¼‚ï¼Œé€šå¸¸ä»¥ stride ä¸ºæ­¥è¿› # è¿™é‡Œçš„å¤„ç†ä¸»è¦æ˜¯ä¸ºäº†å¤„ç†é•¿æ–‡æœ¬åˆ‡ç‰‡ input_ids_chunk = input_ids[:, begin_loc:end_loc] target_ids = input_ids_chunk.clone() # å¦‚æœä¸æ˜¯ç¬¬ä¸€æ®µï¼Œå¿½ç•¥å‰é¢çš„ä¸Šä¸‹æ–‡å¯¹ loss çš„è´¡çŒ®ï¼ˆåªè®¡ç®—å½“å‰çª—å£çš„ lossï¼‰ # ä½†å¯¹äºç®€å•è¯„æµ‹ï¼Œç›´æ¥è®¡ç®—æ•´æ®µ loss ä¹Ÿæ˜¯å¸¸è§çš„è¿‘ä¼¼ target_ids[:, :-trg_len] = -100 if input_ids_chunk.size(1) == 0: break with torch.no_grad(): outputs = model(input_ids_chunk, labels=target_ids) # outputs.loss æ˜¯ cross entropy loss neg_log_likelihood = outputs.loss nlls.append(neg_log_likelihood) if not nlls: return float(\"inf\") # PPL = exp(å¹³å‡ NLL) ppl = torch.exp(torch.stack(nlls).mean()) return ppl.item() # --- ä¸»æµç¨‹ --- # 1. é…ç½®é‡åŒ–å‚æ•° bnb_config = BitsAndBytesConfig( load_in_4bit=True, # å¼€å¯ 4-bit é‡åŒ– bnb_4bit_quant_type=\"nf4\", bnb_4bit_use_double_quant=True, # å¼€å¯åŒé‡é‡åŒ– bnb_4bit_compute_dtype=torch.bfloat16, # è®¡ç®—æ—¶çš„ç²¾åº¦ ) # 1. åŠ è½½æ•°æ® data = load_dataset(\"wikitext\", \"wikitext-2-raw-v1\", split=\"test[:5%]\") print(f\"æ•°æ®åŠ è½½å®Œæ¯•ï¼Œæ ·æœ¬æ•°: {len(data['text'])}\") # 2. åŠ è½½æ¨¡å‹å’Œåˆ†è¯å™¨ model_path = \"\" tokenizer = AutoTokenizer.from_pretrained(model_path) model = AutoModelForCausalLM.from_pretrained( model_path, quantization_config=bnb_config, trust_remote_code=True, torch_dtype=torch.float16, device_map=\"cuda\", # ç›´æ¥åŠ è½½åˆ° CUDA ) # 3. è®¡ç®—å›°æƒ‘åº¦ (ç›´æ¥ä¼ å…¥æ¨¡å‹å¯¹è±¡) ppl = calculate_perplexity(model, tokenizer, data[\"text\"]) print(f\"NF4 æ¨¡å‹çš„å›°æƒ‘åº¦: {ppl:.4f}\") # 4. æ¸…ç† del model_fp16 torch.cuda.empty_cache() å®éªŒç»“æœå¦‚ä¸‹ï¼š æ¨¡å‹\\å›°æƒ‘åº¦ FP16 NF4 Qwen3-0.6B 18.8580 21.2641 å¯ä»¥çœ‹åˆ° NF4 æŸå¤±äº†ç²¾åº¦åœ¨æ€§èƒ½ä¸Šç¡®å®ä¸‹é™æ¯”è¾ƒå‰å®³ï¼Œå¯èƒ½å’Œæ¨¡å‹å¤§å°ä¹Ÿæœ‰å…³ç³»ã€‚ ","date":"2026-02-17","objectID":"/posts/nf4-quantization/:5:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"NF4 é‡åŒ–å¤§æ¨¡å‹","uri":"/posts/nf4-quantization/#å¯¹æ¯”æ•°æ®"},{"categories":null,"content":" LoRA","date":"2026-02-16","objectID":"/posts/loraqlora/:1:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"LoRA\u0026QLoRA","uri":"/posts/loraqlora/#lora"},{"categories":null,"content":" ä¸ºä»€ä¹ˆé€‰æ‹©æ—è·¯è€Œä¸æ˜¯å †å LoRA ç°åœ¨çš„æ–¹æ¡ˆæ˜¯ $y=Wx+\\Delta{W}x$ è¿™æ ·åœ¨æ—è·¯åŠ ä¸€ä¸ªçŸ©é˜µè¿›è¡Œå¾®è°ƒï¼Œé‚£ä¸ºä»€ä¹ˆä¸é€‰æ‹© $y=W_2(W_1x)$ è¿™æ ·çš„å †å æ–¹æ¡ˆå‘¢ï¼Ÿ é¦–å…ˆè¿™ç§æ—è·¯è®¾è®¡å¯ä»¥ä¿æŒåŸæƒé‡å‡½æ•°ä¸å˜ã€‚LoRA åªæä¾›ä¸€ä¸ªä½ç§©ä¿®æ­£é¡¹ã€‚åˆå§‹åŒ–æ—¶ Aã€B æ¥è¿‘é›¶ï¼Œæ¨¡å‹è¡Œä¸ºâ‰ˆåŸæ¨¡å‹ã€‚è®­ç»ƒæ˜¯â€œå¾®è°ƒåç§»é‡â€ï¼Œä¸æ˜¯â€œé‡å»ºæ˜ å°„â€ã€‚å¦‚æœæ”¹æˆå †å æ–°å±‚ï¼Œå‰å‘å‡½æ•°ç›´æ¥æ”¹å˜ï¼Œåˆå§‹è¾“å‡ºå°±æ¼‚ç§»ï¼Œå¤§æ¨¡å‹å®¹æ˜“ä¸ç¨³å®šã€‚ å…¶æ¬¡æ¢¯åº¦éš”ç¦»æ›´å¹²å‡€ã€‚ æ—è·¯ç»“æ„åªè®­ç»ƒ Aã€Bï¼Œä¸»å¹² W å†»ç»“ã€‚æ¢¯åº¦åªæµç»ä½ç§©åˆ†æ”¯ï¼Œç­‰ä»·äºåœ¨å‚æ•°ç©ºé—´åšä½ç»´å­ç©ºé—´æ›´æ–°ã€‚ è‹¥é‡‡ç”¨å †å å±‚ï¼Œæ–°å±‚ä¼šæ”¹å˜ä¸­é—´è¡¨ç¤ºåˆ†å¸ƒï¼Œç­‰äºå¯¹åç»­æ‰€æœ‰å±‚è¾“å…¥åˆ†å¸ƒåšæ‰°åŠ¨ï¼Œå†»ç»“ä¸»å¹²æ—¶é€‚é…æ•ˆç‡åè€Œä¸‹é™ã€‚ æœ€åæ—è·¯æ–¹å¼ä½¿å¾—è®¡ç®—ä¸å¹¶è¡Œå®ç°ç®€å•ã€‚å¯ä»¥æ‹†æˆä¸¤ä¸ªå°çŸ©é˜µä¹˜æ³•å¹¶ä¸ä¸»è·¯å¾„å¹¶è¡Œæ‰§è¡Œï¼ŒGPU ä¸Šå®¹æ˜“èåˆã€‚å †å å±‚åˆ™æ˜¯ä¸¥æ ¼ä¸²è¡Œï¼Œå¤šä¸€æ¬¡å®Œæ•´å±‚å»¶è¿Ÿã€‚ ","date":"2026-02-16","objectID":"/posts/loraqlora/:1:1","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"LoRA\u0026QLoRA","uri":"/posts/loraqlora/#ä¸ºä»€ä¹ˆé€‰æ‹©æ—è·¯è€Œä¸æ˜¯å †å "},{"categories":null,"content":" LoRA æ’å…¥åœ¨å“ªé‡Œæ—©æœŸ LoRA æ¨¡å—ä»…åœ¨æ³¨æ„åŠ›æ¨¡å—çš„ $W_q$ å’Œ $W_v$ ä¸Šæ’å…¥ï¼Œ$W_q$ å†³å®šäº†è¦å…³æ³¨çš„ä¿¡æ¯ï¼Œ$W_k$ å†³å®šäº†è¦æå–çš„ä¿¡æ¯ã€‚ä½†æ˜¯éšç€å¤§æ¨¡å‹å¾®è°ƒç»éªŒçš„åŸºç±»ï¼Œå‘ç°å•å•å¾®è°ƒ Attention ä¸èƒ½æ”¹å˜æ¨¡å‹æ·±å±‚è¡Œä¸ºã€‚çœŸæ­£å­˜å‚¨å¤§æ¨¡å‹çŸ¥è¯†çš„æ˜¯æ¯ä¸€å±‚çš„ MLP æ¨¡å—ï¼Œæ‰€ä»¥è¿˜åœ¨å…¶ä¸­çš„ä¸‰ç»„æŠ•å½± $W_{up}$ã€$W_{gate}$ å’Œ $W_{down}$ ä¸ŠåŠ å…¥ LoRA æ¨¡å—ã€‚ç°åœ¨ä¸»æµçš„ LoRA å¾®è°ƒç­–ç•¥å·²ç»å˜æˆäº† All-Linearï¼Œä¹Ÿå°±æ˜¯å¯¹æ‰€æœ‰çº¿æ€§å±‚éƒ½æ’å…¥ LoRAã€‚ ","date":"2026-02-16","objectID":"/posts/loraqlora/:1:2","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"LoRA\u0026QLoRA","uri":"/posts/loraqlora/#lora-æ’å…¥åœ¨å“ªé‡Œ"},{"categories":null,"content":" LoRA åˆå§‹åŒ–ä¸€èˆ¬æ˜¯å¯¹ $A$ çŸ©é˜µåº”ç”¨ kaiming åˆå§‹åŒ–ï¼Œå¯¹ $B$ çŸ©é˜µç½®ä¸º 0ã€‚é¦–å…ˆçŸ©é˜µ $A$ å’Œ $B$ æœ€å°‘éœ€è¦ä¸€ä¸ªä¸º 0 çŸ©é˜µï¼Œè¿™æ · LoRA ä¸€å¼€å§‹æ›´æ–°æ—¶ $\\Delta W=BA$ æ¥è¿‘äº 0 çŸ©é˜µï¼Œå°±ä¸ä¼šç ´åé¢„è®­ç»ƒæƒé‡ã€‚å…¶æ¬¡çŸ©é˜µ $A$ ä¸èƒ½ä¸º 0 çŸ©é˜µï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ $A$ å’Œ $B$ çš„æ¢¯åº¦æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼š é¦–å…ˆ $A$ çš„æ¢¯åº¦å…¬å¼ä¸ºï¼š âˆ‚Lâˆ‚A=âˆ‚Lâˆ‚Qâ‹…ZT=âˆ‚Lâˆ‚Q(BXT)=âˆ‚Lâˆ‚QXTBT \\frac{\\partial{L}}{\\partial{A}}=\\frac{\\partial{L}}{\\partial{Q}} \\cdot Z^T= \\frac{\\partial{L}}{\\partial{Q}}(BX^T)=\\frac{\\partial{L}}{\\partial{Q}}X^TB^T âˆ‚Aâˆ‚Lâ€‹=âˆ‚Qâˆ‚Lâ€‹â‹…ZT=âˆ‚Qâˆ‚Lâ€‹(BXT)=âˆ‚Qâˆ‚Lâ€‹XTBT$B$ çš„æ¢¯åº¦å…¬å¼ä¸ºï¼š âˆ‚Lâˆ‚B=âˆ‚Lâˆ‚Zâ‹…XT=(ATâˆ‚Lâˆ‚Q)XT \\frac{\\partial{L}}{\\partial{B}}=\\frac{\\partial{L}}{\\partial{Z}} \\cdot X^T= (A^T\\frac{\\partial{L}}{\\partial{Q}})X^T âˆ‚Bâˆ‚Lâ€‹=âˆ‚Zâˆ‚Lâ€‹â‹…XT=(ATâˆ‚Qâˆ‚Lâ€‹)XTè€Œåœ¨å‰å‘ä¼ æ’­ä¸­ï¼Œä½ç§©æ›´æ–°å®é™…èµ°çš„è·¯å¾„æ˜¯ï¼šx â†’ A â†’ (scale) â†’ Bï¼Œä¹Ÿå°±æ˜¯è¯´åå‘ä¼ æ’­æ—¶æ˜¯ä»çŸ©é˜µ $B$ åˆ°çŸ©é˜µ $A$ã€‚å‡å¦‚çŸ©é˜µ $A$ ä¸º 0 çŸ©é˜µï¼Œé‚£ä¹ˆçŸ©é˜µ $B$ çš„æ¢¯åº¦ä¸º 0ï¼Œè®­ç»ƒå°±ä¼šå…ˆæ›´æ–°çŸ©é˜µ $A$ï¼Œ$A$ æ›´æ–°çš„æ•°å€¼å°ºåº¦å°±ä¼šæ”¶åˆ° $B$ çš„åˆå§‹åŒ–åˆ†å¸ƒå½±å“ï¼Œå®¹æ˜“æ”¾å¤§æ—©æœŸæ›´æ–°çš„å°ºåº¦ã€‚å¦‚æœåˆå§‹åŒ–çŸ©é˜µ $B$ ä¸º 0ï¼Œé‚£ä¹ˆä¼šå…ˆæ›´æ–°çŸ©é˜µ $B$ï¼ŒæŠŠ $B$ ä» 0 æ‹‰å¼€ï¼Œå†æ›´æ–° $A$ã€‚è®­ç»ƒç¨³å®šï¼Œç­‰ä»·äºå…ˆå­¦ä¹ è¾“å‡ºä¾§ç»„åˆï¼Œå†ç»†åŒ–è¾“å…¥ä¾§æŠ•å½±ã€‚ ","date":"2026-02-16","objectID":"/posts/loraqlora/:1:3","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"LoRA\u0026QLoRA","uri":"/posts/loraqlora/#lora-åˆå§‹åŒ–"},{"categories":null,"content":" ç§© r å¦‚ä½•å½±å“æ¨¡å‹è¡¨ç°ä»è®­ç»ƒè¡Œä¸ºçœ‹ã€‚r å°çº¦æŸå¼ºï¼Œæ›´æ–°å­ç©ºé—´çª„ï¼Œä¼˜åŒ–æ›´ç¨³å®šï¼Œå¯¹å°æ•°æ®é›†æ›´æŠ—è¿‡æ‹Ÿåˆï¼Œä½†å®¹æ˜“æ¬ æ‹Ÿåˆï¼Œloss é™ä¸åŠ¨æˆ–å¾ˆæ—©å¹³å°æœŸã€‚ r å¤§è‡ªç”±åº¦é«˜ï¼Œloss æ›´å®¹æ˜“ä¸‹é™ï¼Œä»»åŠ¡ä¸Šé™æ›´é«˜ï¼Œä½†å¯¹æ•°æ®è§„æ¨¡æ•æ„Ÿï¼Œå°æ•°æ®æ—¶å®¹æ˜“è®°å¿†åŒ–å’Œåˆ†å¸ƒæ¼‚ç§»ã€‚ åœ¨æ³¨æ„åŠ›å±‚ä¸Šï¼Œè¾ƒå°çš„ r å¾€å¾€å·²è¶³å¤Ÿæ”¹å˜ä¿¡æ¯è·¯ç”±ï¼Œæ”¶ç›Šæ›²çº¿å¾ˆå¿«é¥±å’Œã€‚åœ¨ MLP æŠ•å½±å±‚ä¸Šï¼Œé€šå¸¸éœ€è¦æ›´å¤§çš„ r æ‰èƒ½äº§ç”ŸåŒç­‰å¹…åº¦çš„è¡Œä¸ºå˜åŒ–ã€‚ ","date":"2026-02-16","objectID":"/posts/loraqlora/:1:4","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"LoRA\u0026QLoRA","uri":"/posts/loraqlora/#ç§©-r-å¦‚ä½•å½±å“æ¨¡å‹è¡¨ç°"},{"categories":null,"content":" QLoRAéšç€ LLM å‚æ•°é‡ä¸æ–­æ”€å‡ï¼Œå…¨é‡å¾®è°ƒæ‰€éœ€çš„æ˜¾å­˜è¶Šæ¥è¶Šå¤§ã€‚æ‰€ä»¥å‡ºç°äº† LoRAï¼Œå®ƒçš„æ€è·¯æ˜¯ï¼šå†»ç»“ä¸»æ¨¡å‹æƒé‡ï¼Œåªè®­ç»ƒå°‘é‡çš„ä½ç§©é€‚é…å™¨ã€‚è¿™æ ·è™½ç„¶éœ€è¦åŠ è½½æ•´ä¸ªæ¨¡å‹åˆ°æ˜¾å¡ï¼Œä½†æ˜¯ç”±äºåªéœ€è¦è®­ç»ƒ LoRA çš„ $A$ å’Œ $B$ ä¸¤ä¸ªæƒé‡çŸ©é˜µï¼Œæ‰€ä»¥ä¼˜åŒ–å™¨çš„å‚æ•°éå¸¸å°‘ï¼Œå¹¶ä¸”ä¸­é—´æ¿€æ´»å€¼çš„å ç”¨ä¹Ÿå¤§å¹…åº¦å‡å°ï¼Œæ‰€ä»¥æ˜¾å­˜éœ€æ±‚å¤§å¹…é™ä½ã€‚ä½†åŠ è½½æ¨¡å‹æœ¬èº«ä»éœ€é«˜ç²¾åº¦ï¼Œæ˜¾å­˜å ç”¨ä¾ç„¶è¾ƒå¤§ã€‚QLoRA çš„æ€è·¯å°±æ˜¯åœ¨ LoRA çš„åŸºç¡€ä¸Šï¼Œå°†é¢„è®­ç»ƒæ¨¡å‹é‡åŒ–ä¸º 4-bitï¼Œè¿›ä¸€æ­¥å‹ç¼©æ˜¾å­˜å ç”¨ã€‚ QLoRA é‡‡ç”¨çš„ NF4 é‡åŒ–çŸ¥è¯†å¯è§ï¼š NF4 é‡åŒ–å¤§æ¨¡å‹ 2026-02-17 #å¤§æ¨¡å‹Â  NF4 é‡åŒ–ä»‹ç» NF4 é‡åŒ–ä¹‹å‰æˆ‘ä»¬å…ˆè¯´è¯´é‡åŒ–æ˜¯ä»€ä¹ˆï¼Œé‡åŒ–æœ¬è´¨æ˜¯æŠŠ æµ®ç‚¹æ•°å¼ é‡å‹ç¼©åˆ°æœ‰é™çš„æ•´æ•°é›†åˆé‡Œã€‚ä¾‹å¦‚ INT4 é‡åŒ–ï¼Œå°±æ˜¯æŠŠæ‰€æœ‰æµ®ç‚¹æ•°æ˜ å°„åˆ° $2^4$ ä¸ªæ•´æ•°ä¹Ÿå°±æ˜¯ [-8, 7] çš„åŒºé—´å†…ï¼Œè¿™æ ·å­å°±åªéœ€è¦å­˜å‚¨è¿™ 4ä¸ª bit ä¹Ÿå°±æ˜¯ 0.5Bã€‚å…·ä½“çš„å…¬å¼æ˜¯ï¼š ","date":"2026-02-16","objectID":"/posts/loraqlora/:2:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"LoRA\u0026QLoRA","uri":"/posts/loraqlora/#qlora"},{"categories":null,"content":" Qwen3 QLoRA å®è·µ python import argparse import torch from peft import LoraConfig, prepare_model_for_kbit_training from torch.utils.data import Dataset from transformers import AutoModelForCausalLM, AutoTokenizer, BitsAndBytesConfig from trl import SFTConfig, SFTTrainer if __name__ == \"__main__\": args = get_args() bnb_config = BitsAndBytesConfig( load_in_4bit=True, bnb_4bit_quant_type=\"nf4\", bnb_4bit_compute_dtype=torch.float16, bnb_4bit_use_double_quant=True, ) device = \"cuda\" if torch.cuda.is_available() else \"cpu\" model = AutoModelForCausalLM.from_pretrained( r\"D:\\dev\\github\\minimind\\model\\qwen3-0.6b\", quantization_config=bnb_config, dtype=args.dtype, trust_remote_code=True, ).to(args.device) tokenizer = AutoTokenizer.from_pretrainer( r\"D:\\dev\\github\\minimind\\model\\qwen3-0.6b\" ) model = prepare_model_for_kbit_training(model) custom_dataset = Dataset() peft_config = LoraConfig( r=16, lora_alpha=32, lora_dropout=0.05, bias=\"none\", task_type=\"CAUSAL_LM\", target_modules=\"all-linear\", ) sft_config = SFTConfig( output_dir=args.save_dir, per_device_train_batch_size=args.batch_size, gradient_accumulation_steps=args.accumulation_steps, learning_rate=args.lr, lr_scheduler_type=\"cosine\", logging_steps=args.log_interval, fp16=(args.dtype == \"float16\"), bf16=(args.dtype == \"bfloat16\"), num_train_epochs=args.epochs, save_steps=args.save_interval, optim=\"paged_adamw_32bit\", max_length=args.max_length, packing=False, ) trainer = SFTTrainer( model=model, tokenizer=tokenizer, args=sft_config, train_dataset=custom_dataset, peft_config=peft_config, ) trainer.train() åœ¨ SFTTrainer é‡Œé¢ä¼ å…¥ peft_config å®ƒå†…éƒ¨å°±ä¼šåœ¨ trainer åˆå§‹åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨ get_peft_modelï¼Œæ³¨å…¥ LoRA å±‚ï¼Œå†»ç»“ base æƒé‡ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ª PeftModel åŒ…è£…å¯¹è±¡ã€‚ å¦å¤–æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼šå¦‚æœç”¨ NF4 é‡åŒ–æ¨¡å‹è¿›è¡Œè®­ç»ƒï¼Œé‚£ä¹ˆå¿…é¡»è¦ç”¨ prepare_model_for_kbit_training è¿™ä¸ªæ–¹æ³•å¯¹æ¨¡å‹è¿›è¡Œã€‚å¦‚æœåªæ˜¯è¿›è¡Œæ¨ç†çš„è¯ï¼Œbitsandbytes ä¼šåœ¨è®¡ç®—æ¯ä¸€å±‚çŸ©é˜µä¹˜æ³•æ—¶ï¼ŒåŠ¨æ€åœ°å°† 4-bit æƒé‡åé‡åŒ–ä¸º float16 æˆ– bfloat16ã€‚è®¡ç®—å®Œ $y = Wx + b$ åï¼Œä¸­é—´ç»“æœå°±ä¸¢å¼ƒäº†ã€‚è¿™ä¸ªè¿‡ç¨‹å¯¹ç²¾åº¦çš„æ³¢åŠ¨ä¸æ•æ„Ÿï¼Œåªè¦æ¨¡å‹èƒ½è¾“å‡ºåˆç†çš„æ¦‚ç‡åˆ†å¸ƒå³å¯ã€‚ä½†æ˜¯æ¨ç†æ¶‰åŠåˆ°æ¢¯åº¦çš„åå‘ä¼ æ’­ï¼Œå¾ˆå¯èƒ½å‡ºç°ç²¾åº¦æº¢å‡ºçš„é—®é¢˜ã€‚prepare_model_for_kbit_training å°† LayerNorm/RMSNorm è½¬æ¢ä¸º float32ã€‚ å½“ SFTTrainer ä¼ å…¥ peft_config è¿›è¡Œ LoRA å¾®è°ƒåï¼ŒTrainer å†…éƒ¨ä¼šæŠŠ model è½¬ä¸º PeftModelã€‚å¯¹ PeftModel è°ƒç”¨ save_model è¿›è¡Œä¿å­˜ï¼Œå®ƒåªä¼šä¿å­˜ LoRA éƒ¨åˆ†ä¸ä¼šä¿å­˜åŸºæ¨¡ã€‚æˆ‘ä»¬æ‰“å¼€ adapter_config.json ä¹Ÿèƒ½è§‚å¯Ÿåˆ°ï¼Œé…ç½®æ–‡ä»¶å†…éƒ¨æŒ‡å‘äº†åŸæ¨¡å‹çš„åœ°å€ï¼š ","date":"2026-02-16","objectID":"/posts/loraqlora/:2:1","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"LoRA\u0026QLoRA","uri":"/posts/loraqlora/#qwen3-qlora-å®è·µ"},{"categories":null,"content":" LoRA æ˜¯ä»€ä¹ˆPEFT å¤§è‡´åŒ…å«ä¸‰ç±»ï¼šPrompt-Tuningã€Adapter-Tuning ä»¥åŠ LoRAï¼Œè€Œ MiniMind é‡Œé¢é‡‡ç”¨çš„å°±æ˜¯ LoRA è¿›è¡ŒæŒ‡ä»¤å¾®è°ƒã€‚åœ¨ CS224N çš„è¯¾ç¨‹ä¸­å·²ç»å­¦ä¹ äº† LoRA çš„åŸç†ï¼Œç®€å•æ¥è¯´æˆ‘ä»¬åœ¨ç»è¿‡ Pretrain å’Œ SFT çš„æ¨¡å‹åŸºç¡€ä¸Šï¼Œå¯¹å‚æ•° $y=Wx$ åŠ ä¸Šä¸€ä¸ªå¢é‡çŸ©é˜µ $\\Delta{W}$ æ¥å¾®è°ƒæ¨¡å‹ï¼Œå¹¶ä¸”è¿™ä¸ª $\\Delta{W}$ æ˜¯é€šè¿‡ ä½ç§©è¿‘ä¼¼ å¾—åˆ°çš„ï¼Œæ‰€ä»¥å®é™…å‚æ•°é‡è¿œå°äº $W$ï¼Œè®¡ç®—å¼€é”€å°ã€‚å…·ä½“å¯ä»¥çœ‹ä¹‹å‰çš„ç¬”è®°ï¼š CS224N Lecture 12: Neural Network 2025-12-02 #æ·±åº¦å­¦ä¹ Â  Mixed Precision Trainingä»‹ç»æ··åˆç²¾åº¦è®­ç»ƒä¹‹å‰å…ˆå›é¡¾è®¡ç®—æœºç»„æˆåŸç†çš„ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š æµ®ç‚¹æ•°åœ¨è®¡ç®—æœºä¸Šé¢æ˜¯ä»¥ â€œsign + exp + digitsâ€ çš„æ ¼å¼å­˜å‚¨çš„ï¼Œexp çš„å¤§å°å†³å®šäº†æµ®ç‚¹æ•°èŒƒå›´ï¼Œdigits çš„å¤§å°å†³å®šäº†æµ®ç‚¹æ•°çš„ç²¾åº¦ã€‚ LoRA\u0026QLoRA 2026-02-16 #å¤§æ¨¡å‹Â  LoRA ä¸ºä»€ä¹ˆé€‰æ‹©æ—è·¯è€Œä¸æ˜¯å †å LoRA ç°åœ¨çš„æ–¹æ¡ˆæ˜¯ $y=Wx+\\Delta{W}x$ è¿™æ ·åœ¨æ—è·¯åŠ ä¸€ä¸ªçŸ©é˜µè¿›è¡Œå¾®è°ƒï¼Œé‚£ä¸ºä»€ä¹ˆä¸é€‰æ‹© $y=W_2(W_1x)$ è¿™æ ·çš„å †å æ–¹æ¡ˆå‘¢ï¼Ÿ é¦–å…ˆè¿™ç§æ—è·¯è®¾è®¡å¯ä»¥ä¿æŒåŸæƒé‡å‡½æ•°ä¸å˜ã€‚LoRA åªæä¾›ä¸€ä¸ªä½ç§©ä¿®æ­£é¡¹ã€‚åˆå§‹åŒ–æ—¶ Aã€B æ¥è¿‘é›¶ï¼Œæ¨¡å‹è¡Œä¸ºâ‰ˆåŸæ¨¡å‹ã€‚è®­ç»ƒæ˜¯â€œå¾®è°ƒåç§»é‡â€ï¼Œä¸æ˜¯â€œé‡å»ºæ˜ å°„â€ã€‚å¦‚æœæ”¹æˆå †å æ–°å±‚ï¼Œå‰å‘å‡½æ•°ç›´æ¥æ”¹å˜ï¼Œåˆå§‹è¾“å‡ºå°±æ¼‚ç§»ï¼Œå¤§æ¨¡å‹å®¹æ˜“ä¸ç¨³å®šã€‚ ","date":"2026-02-13","objectID":"/posts/minimind-lora/:1:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å…­)ï¼šLoRA","uri":"/posts/minimind-lora/#lora-æ˜¯ä»€ä¹ˆ"},{"categories":null,"content":" å®ç°ç»†èŠ‚","date":"2026-02-13","objectID":"/posts/minimind-lora/:2:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å…­)ï¼šLoRA","uri":"/posts/minimind-lora/#å®ç°ç»†èŠ‚"},{"categories":null,"content":" LoRA æ¨¡å—å‰é¢æˆ‘ä»¬æ•°å­¦å…¬å¼æ˜¯ $y=Wx+\\Delta Wx = Wx+BAx$ï¼Œä½†æ˜¯åœ¨ PyTorché‡Œé¢å¦‚æœæˆ‘ä»¬ç”¨ nn.Parameter() æ‰‹åŠ¨å®ç°å¾—å†™æˆï¼š python def __init__(self, in_features, out_features, r) self.A = nn.Parameter(torch.zeros(r, in_features)) self.B = nn.Parameter(torch.zeros(out_features, r)) def forward(self, x): return x @ (self.B @ self.A).T PyTorch é»˜è®¤æŠŠç‰¹å¾ç»´æ”¾åœ¨æœ€åï¼šè¾“å…¥å½¢çŠ¶æ˜¯ (batch, ..., in_features)ï¼Œè¿™æ ·æ‰€æœ‰å‰å¯¼ç»´éƒ½å½“ä½œæ‰¹ç»´è‡ªåŠ¨å¹¿æ’­ï¼Œæ‰€ä»¥åœ¨ PyTorch é‡Œé¢éƒ½æ˜¯ x å³ä¹˜ä¸€ä¸ªçŸ©é˜µè€Œä¸æ˜¯åƒçº¿æ€§ä»£æ•°é‡Œé¢éƒ½æ˜¯ $W \\times x$ è¿™æ ·å·¦ä¹˜ä¸€ä¸ªçŸ©é˜µã€‚ python class LoRA(nn.Module): def __init__(self, in_features: int, out_features: int, rank: int, alpha: int) -\u003e None: super(LoRA, self).__init__() self.scaling = alpha / rank self.A = nn.Linear(in_features, rank, bias=False) self.B = nn.Linear(rank, out_features, bias=False) nn.init.kaiming_uniform_(self.A.weight, a=5**0.5) nn.init.zeros_(self.B.weight) def forward(self, x: torch.Tensor) -\u003e torch.Tensor: return self.B(self.A(x)) * self.scaling å¦‚æœç›´æ¥ç”¨ nn.Linear é‚£ä¹ˆåªéœ€è¦å…ˆåº”ç”¨ A å†åº”ç”¨ B å°±å¥½äº†ã€‚ ","date":"2026-02-13","objectID":"/posts/minimind-lora/:2:1","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å…­)ï¼šLoRA","uri":"/posts/minimind-lora/#lora-æ¨¡å—"},{"categories":null,"content":" åº”ç”¨ LoRA python def apply_lora(model: nn.Module, rank: int, alpha: int) -\u003e None: # freeze all parameters for param in model.parameters(): param.requires_grad = False # collect linear lora_modules = [] for name, module in model.named_modules(): if isinstance(module, nn.Linear) and \"lora\" not in name and \"lm_head\" not in name: lora_modules.append((name, module)) for name, module in lora_modules: lora_module = LoRA(in_features=module.weight.shape[1], out_features=module.weight.shape[0], rank=rank, alpha=alpha).to(module.weight.device).to(module.weight.dtype) setattr(module, \"lora\", lora_module) ori_forward = module.forward def forward_with_lora(x): return ori_forward(x) + lora_module(x) module.forward = forward_with_lora ä¸ºäº†é¿å…å°† LoRA åº”ç”¨åˆ° LoRA å±‚è‡ªèº«ï¼Œæˆ‘ä»¬å¯¹æ¯ä¸€ä¸ª nn.Module æ£€æµ‹ä»–çš„æƒé‡çŸ©é˜µå½¢çŠ¶æ˜¯å¦ä¸º rankã€‚å…¶æ¬¡éœ€è¦æ³¨æ„æˆ‘ä»¬åˆå§‹åŒ– LoRA æ¨¡å—çš„æ—¶å€™ï¼Œin_features=module.weight.shape[1] ã€‚è¿™æ˜¯å› ä¸º nn.Linear å±‚å†…éƒ¨åˆå§‹åŒ–çš„æƒé‡çŸ©é˜µæ˜¯ W=[out_features, in_features]ï¼Œç„¶åè®¡ç®— $y=xW^T$ï¼Œæ‰€ä»¥ in_features åº”è¯¥æ˜¯æƒé‡çŸ©é˜µçš„ç¬¬äºŒç»´ã€‚ è¿™ä¸ªä»£ç çœ‹ä¼¼æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯æˆ‘è°ƒè¯•æ—¶å€™ debug äº†åŠä¸ªå¤šå°æ—¶ï¼Œæœ€åè¿˜æ˜¯ Gemini å¸®æˆ‘è§£å†³äº†ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„ Python é—­åŒ… å¯¼è‡´çš„é”™è¯¯ã€‚é—­åŒ…å‡½æ•°å†…çš„ lora å’Œ ori_forward æ˜¯ä»å¤–éƒ¨ä½œç”¨åŸŸâ€œå¼•ç”¨â€çš„å˜é‡ï¼Œå®ƒä»¬æŒ‡å‘çš„æ˜¯å¾ªç¯ç»“æŸæ—¶çš„â€œæœ€åä¸€ä¸ªå€¼â€ï¼Œè€Œä¸æ˜¯å½“å‰å¾ªç¯çš„å€¼ã€‚æ‰€ä»¥å½“æˆ‘ä»¬å‰å‘ä¼ æ’­è®¡ç®—çº¿æ€§å±‚çš„æ—¶å€™ï¼Œå®ƒè°ƒç”¨çš„ forward æ–¹æ³•å…¶å®éƒ½æ˜¯æœ€åä¸€ä¸ªçº¿æ€§å±‚çš„ forward + loraã€‚å…³äº Python çš„é—­åŒ…é—®é¢˜å¯ä»¥è§ä¸‹é¢è¿™ä¸ªæ–‡ç« ï¼Œè¿™é‡Œå°±è®²ä¸€ä¸‹æ€ä¹ˆè§£å†³ï¼š è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š æˆ‘ä»¬ç”¨ é»˜è®¤å‚æ•° å°†å½“å‰çš„ lora å’Œ ori_forward ç»‘å®šåˆ°å‡½æ•°å†…éƒ¨ã€‚ python def forward_with_lora(x, lora=lora, ori_forward=ori_forward): return ori_forward(x) + lora(x) ä½¿ç”¨ å·¥å‚å‡½æ•° åˆ›å»ºï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šç”Ÿæˆæ–°çš„é—­åŒ…ç¯å¢ƒ python def _create_lora_forward(lora_module, original_forwarda): def forward(x): return original_forward(x) + lora_module(x) return forward def apply_lora(model: nn.Module, rank: int) -\u003e None: for _, module in model.named_modules(): module.forward = _create_lora_forward(lora, module.forward, rank, rank*2) ","date":"2026-02-13","objectID":"/posts/minimind-lora/:2:2","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å…­)ï¼šLoRA","uri":"/posts/minimind-lora/#åº”ç”¨-lora"},{"categories":null,"content":" ä¿å­˜ LoRAæ—¢ç„¶æˆ‘ä»¬è®­ç»ƒäº† LoRA æ¨¡å—ï¼Œé‚£å°±éœ€è¦æŠŠé‡Œé¢çš„æƒé‡ä¿å­˜ä¸‹æ¥ã€‚æˆ‘ä»¬ä¹‹å‰ç”¨ setattr(module, \"lora\", lora) æŠŠ LoRA æ¨¡å—æ’å…¥äº† model é‡Œé¢ï¼Œæ‰€ä»¥ lm_checkpoint æ–¹æ³•é€šè¿‡ model.state_dict() å¯ä»¥è·å¾— LoRA çš„æƒé‡ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦çš„æ˜¯ LoRA çš„ å¯æ’æ‹” çš„ç‰¹æ€§ï¼Œæ‰€ä»¥åªéœ€è¦æŠŠ LoRA çš„æƒé‡ç•™ä¸‹æ¥å³å¯ï¼Œéœ€è¦çš„æ—¶å€™æŠŠè¿™éƒ¨åˆ†æƒé‡æŒ‚è½½ä¸Šå»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å†å†™ä¸€ä¸ªæ–¹æ³•æ¥å®ç°ï¼š python def save_lora(model: nn.Module, path: str): state_dict = {} for name, module in model.named_modules(): if hasattr(module, \"lora\"): tmp_state = {f\"{name}.lora.{k}\": v for k, v in module.lora.state_dict().items()} state_dict.update(tmp_state) torch.save(state_dict, path) ","date":"2026-02-13","objectID":"/posts/minimind-lora/:2:3","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å…­)ï¼šLoRA","uri":"/posts/minimind-lora/#ä¿å­˜-lora"},{"categories":null,"content":" åº”ç”¨ LoRA python def load_lora(model: nn.Module, path: str): state_dict = torch.load(path, map_location=model.device) for name, module in model.named_modules(): if hasattr(module, \"lora\"): lora_state = {\"A.weight\": state_dict[f\"{name}.lora.A.weight\"], \"B.weight\": state_dict[f\"{name}.lora.B.weight\"]} module.lora.load_state_dict(lora_state) ","date":"2026-02-13","objectID":"/posts/minimind-lora/:2:4","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å…­)ï¼šLoRA","uri":"/posts/minimind-lora/#åº”ç”¨-lora-1"},{"categories":null,"content":" å®éªŒç»“æœ","date":"2026-02-13","objectID":"/posts/minimind-lora/:3:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å…­)ï¼šLoRA","uri":"/posts/minimind-lora/#å®éªŒç»“æœ"},{"categories":null,"content":" MiniMind å¾®è°ƒ text ğŸ’¬: ä½ æœ‰ä»€ä¹ˆç‰¹é•¿ï¼Ÿ ğŸ¤–: æˆ‘æ˜¯èƒ½å¤Ÿåƒäººç±»ä¸€æ ·æ€è€ƒå’Œæ„ŸçŸ¥ç¯å¢ƒçš„æ™ºèƒ½æœºå™¨ã€‚ [Speed]: 15.22 tokens/s ğŸ’¬: ä¸ºä»€ä¹ˆå¤©ç©ºæ˜¯è“è‰²çš„ ğŸ¤–: å› ä¸ºæ˜Ÿæ˜Ÿå’Œå¤ªé˜³å…‰ä¼šåå°„ä¸åŒæ³¢é•¿çš„å…‰çº¿ï¼Œå¯¼è‡´æˆ‘ä»¬çœ‹åˆ°çš„æ˜¯è“è‰²ã€‚ [Speed]: 21.41 tokens/s t Outlook æˆ–è€… Yaho.ai Gam æ¸¸çš„æ™®é€šæ°‘ä¼—ï¼Œä¹Ÿå¯ä»¥é€‰æ‹© ğŸ’¬: è§£é‡Šä¸€ä¸‹\"å…‰åˆä½œç”¨\"çš„åŸºæœ¬è¿‡ç¨‹ ğŸ¤–: è›‹ç™½è´¨æ˜¯æ¤ç‰©å’Œä¸€äº›ç»†èŒåˆ©ç”¨é˜³å…‰ã€æ°´æˆ–å…¶ä»–ç”Ÿç‰©èƒ½è¿›è¡Œç»†èƒå‘¼å¸ï¼Œäº§ç”Ÿæ°§æ°”å¹¶é‡Šæ”¾å‡ºèƒ½é‡ã€‚è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°è›‹ç™½è´¨çš„ç»“æ„ ã€åˆ†å­é—´ç›¸äº’ä½œç”¨ä»¥åŠé…¶å‚¬åŒ–ç­‰å¤šç§æœºåˆ¶ã€‚åœ¨æ¤ç‰©ä½“å†…ï¼Œæ°¨åŸºé…¸é€šè¿‡è½¬å½•æˆRNAï¼Œç„¶åæ˜¯ç¢³æ°´åŒ–åˆç‰©ï¼ˆO2ï¼‰æ•è·äºŒæ°§åŒ–ç¢³ï¼Œç”Ÿæˆæœ‰ æœºç‰©è´¨ï¼›åŒæ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡ä»£è°¢é€”å¾„å°†æœ‰æœºç‰©è´¨è½¬æ¢ä¸ºè¥å…»ç‰©è´¨æ¥å¸®åŠ©æ¤ç‰©ç”Ÿé•¿å’Œä¼ é€’å…»åˆ†ã€‚å½“æ¤ç‰©å—åˆ°å¤–éƒ¨ç¯å¢ƒå‹åŠ›æ—¶ï¼Œå…¶ä»£ è°¢äº§ç‰©ä¼šè¢«æ¿€æ´»ï¼Œä¾›åº”ç›¸åº”çš„æ°´åˆ†å’Œè¥å…»æˆåˆ†ï¼›è¿™ä¸€è¿‡ç¨‹ä¸­è¿˜æœ‰åŠ©äºè°ƒèŠ‚äººä½“å…ç–«ç³»ç»Ÿï¼Œé˜²æ­¢æ„ŸæŸ“å’Œç–¾ç—…ã€‚æ€»ä¹‹ï¼Œç”Ÿç‰©ä½“å†…å‘ç”ŸDNAèšåˆé…¶çš„åˆ†è§£å’Œè½¬è¿ï¼Œæ˜¯è‡³å…³é‡è¦çš„ã€‚ [Speed]: 22.23 tokens/s ğŸ’¬: å¦‚æœæ˜å¤©ä¸‹é›¨ï¼Œæˆ‘åº”è¯¥å¦‚ä½•å‡ºé—¨ ğŸ¤–: ç¡®ä¿ä½ çš„è¡£æœå¹²å‡€ã€å¹²ç‡¥ã€‚ä½ å¯ä»¥ç©¿å¤–å¥—å»å­¦æ ¡æˆ–å›¾ä¹¦é¦†ã€‚å¦‚æœä½ æƒ³å¸¦ä¼ï¼Œä½†ä¸ä¼šä¸‹é›¨çš„è¯å°±å¸¦ä¸Šé›¨ä¼ã€‚ [Speed]: 20.53 tokens/s ğŸ’¬: æ¯”è¾ƒä¸€ä¸‹çŒ«å’Œç‹—ä½œä¸ºå® ç‰©çš„ä¼˜ç¼ºç‚¹ ğŸ¤–: çŒ«æ›´å–œæ¬¢è‡ªå·±ç‹¬å¤„ï¼Œè€Œç‹—åˆ™ç›¸å¯¹ç‹¬ç«‹ã€‚ä½†æ˜¯å®ƒä»¬çš„æ€§æ ¼ä¸åŒï¼Œæœ‰æ—¶å€™ç”šè‡³ä¼šè¢«é©¯æœï¼Œä½†å®ƒä»¬æ€»æ˜¯å¯ä»¥å˜å¾—éå¸¸äº²è¿‘äººç±»ï¼Œå–œ æ¬¢åœ¨ä¸»äººèº«è¾¹æ‰“æ‰°è‡ªå·±çš„å®‰å®ç¡è§‰ã€‚ [Speed]: 21.54 tokens/s ğŸ’¬: è§£é‡Šä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹  ğŸ¤–: æœºå™¨å­¦ä¹ ï¼ˆMachine Learningï¼‰æ˜¯ä¸€ç§åŸºäºæ•°æ®è®­ç»ƒçš„ç®—æ³•ï¼Œå®ƒèƒ½å¤Ÿé€šè¿‡åˆ†æå’Œæ¨¡å¼è¯†åˆ«æ•°æ®ä¸­çš„æ¨¡å¼ã€è¶‹åŠ¿æˆ–å…³è”æ€§ï¼Œä» è€Œå®ç°è‡ªåŠ¨åŒ–å†³ç­–æˆ–è€…é¢„æµ‹æœªæ¥ç»“æœçš„èƒ½åŠ›ã€‚è¿™ç§æŠ€æœ¯è¢«å¹¿æ³›åº”ç”¨äºå„ç§é¢†åŸŸï¼Œå¦‚è‡ªç„¶è¯­è¨€å¤„ç†ã€è®¡ç®—æœºè§†è§‰ã€åŒ»ç–—è¯Šæ–­ç­‰ï¼Œæ˜¯ ç°ä»£äººå·¥æ™ºèƒ½çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ [Speed]: 22.86 tokens/s ğŸ’¬: æ¨èä¸€äº›ä¸­å›½çš„ç¾é£Ÿ ğŸ¤–: æˆ‘æ¨èä¸€ä¸‹ï¼šå®«ä¿é¸¡ä¸ã€éº»è¾£é¦™é”…ã€å›é”…è‚‰ã€é¥ºå­çš®ç­‰ã€‚è¿™äº›éƒ½æ˜¯éå¸¸å—äººä»¬æ¬¢è¿çš„ç¾å‘³å“¦ï¼Œä½ å¯ä»¥å°è¯•ä¸€ä¸‹å°±å¯ä»¥äº†ï¼ [Speed]: 22.49 tokens/s è®­ç»ƒäº† 20 ä¸ª epochï¼Œå¯ä»¥çœ‹åˆ°æ¨¡å‹å·²ç»æœ‰äº†è‡ªå·±çš„è¯´è¯é£æ ¼äº†ã€‚ ","date":"2026-02-13","objectID":"/posts/minimind-lora/:3:1","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å…­)ï¼šLoRA","uri":"/posts/minimind-lora/#minimind-å¾®è°ƒ"},{"categories":null,"content":" Qwen3-0.6B å¾®è°ƒä½†æ˜¯ï¼Œç”±äºæˆ‘çš„åŸºæ¨¡å¤ªæ‹‰è·¨äº†ï¼Œæ‰€ä»¥æˆ‘ä¸‹è½½äº† Qwen3-0.6B æ¨¡å‹è¿›è¡Œ LoRA å¾®è°ƒã€‚ä¸‹é¢ä»£ç æ˜¯æ‰‹åŠ¨é€šè¿‡ PyTorch è¿›è¡Œ LoRA å¾®è°ƒï¼Œè°ƒç”¨ Transformers åº“è¿›è¡Œ LoRA å¾®è°ƒçš„æ–¹æ³•å¯ä»¥è§åšæ–‡ï¼š LoRA\u0026QLoRA 2026-02-16 #å¤§æ¨¡å‹Â  LoRA ä¸ºä»€ä¹ˆé€‰æ‹©æ—è·¯è€Œä¸æ˜¯å †å LoRA ç°åœ¨çš„æ–¹æ¡ˆæ˜¯ $y=Wx+\\Delta{W}x$ è¿™æ ·åœ¨æ—è·¯åŠ ä¸€ä¸ªçŸ©é˜µè¿›è¡Œå¾®è°ƒï¼Œé‚£ä¸ºä»€ä¹ˆä¸é€‰æ‹© $y=W_2(W_1x)$ è¿™æ ·çš„å †å æ–¹æ¡ˆå‘¢ï¼Ÿ é¦–å…ˆè¿™ç§æ—è·¯è®¾è®¡å¯ä»¥ä¿æŒåŸæƒé‡å‡½æ•°ä¸å˜ã€‚LoRA åªæä¾›ä¸€ä¸ªä½ç§©ä¿®æ­£é¡¹ã€‚åˆå§‹åŒ–æ—¶ Aã€B æ¥è¿‘é›¶ï¼Œæ¨¡å‹è¡Œä¸ºâ‰ˆåŸæ¨¡å‹ã€‚è®­ç»ƒæ˜¯â€œå¾®è°ƒåç§»é‡â€ï¼Œä¸æ˜¯â€œé‡å»ºæ˜ å°„â€ã€‚å¦‚æœæ”¹æˆå †å æ–°å±‚ï¼Œå‰å‘å‡½æ•°ç›´æ¥æ”¹å˜ï¼Œåˆå§‹è¾“å‡ºå°±æ¼‚ç§»ï¼Œå¤§æ¨¡å‹å®¹æ˜“ä¸ç¨³å®šã€‚ å…·ä½“ä»£ç å¦‚ä¸‹ï¼š python import argparse import torch import tqdm from torch.utils.data import DataLoader from transformers import AutoModelForCausalLM, AutoTokenizer from dataset.lora_dataset import LoRADataset from model.lora import apply_lora, save_lora def get_args() -\u003e argparse.Namespace: parser = argparse.ArgumentParser() parser.add_argument(\"--seed\", type=int, default=11711) parser.add_argument(\"--device\", type=str, default=\"cuda:0\") parser.add_argument(\"--dtype\", type=str, default=\"float16\") parser.add_argument(\"--batch_size\", type=int, default=\"8\") parser.add_argument(\"--lr\", type=float, default=1e-5) parser.add_argument(\"--epochs\", type=int, default=50) parser.add_argument(\"--model_path\", type=str, default=\"\") parser.add_argument(\"--tokenizer_path\", type=str, default=\"\") parser.add_argument(\"--dataset_path\", type=str, default=\"\") parser.add_argument(\"--max_length\", type=int, default=340) parser.add_argument(\"--num_workers\", type=int, default=2) parser.add_argument(\"--rank\", type=int, default=8) parser.add_argument(\"--alpha\", type=int, default=8) parser.add_argument(\"--log_interval\", type=int, default=100) parser.add_argument(\"--save_interval\", type=int, default=200) parser.add_argument(\"--lora_path\", type=str, default=\"lora\") parser.add_argument(\"--lora_name\", type=str, default=\"xiaoxue\") return parser.parse_args() def train(args: argparse.Namespace): model = AutoModelForCausalLM.from_pretrained(args.model_path).to(args.device) tokenizer = AutoTokenizer.from_pretrained(args.tokenizer_path) apply_lora(model, args.rank, args.alpha) train_ds = LoRADataset(tokenizer, args.dataset_path, args.max_length) dataloader = DataLoader(train_ds, args.batch_size, shuffle=True, num_workers=args.num_workers) optimizer = torch.optim.AdamW([p for p in model.parameters() if p.requires_grad], lr=args.lr) trainable_params = sum(p.numel() for p in model.parameters() if p.requires_grad) all_params = sum(p.numel() for p in model.parameters()) print(f\"å¯è®­ç»ƒå‚æ•°: {trainable_params} / {all_params} ({trainable_params / all_params:.2%})\") step = 0 model.train() for epoch in range(args.epochs): for input_ids, labels in tqdm.tqdm(dataloader, desc=f\"Epoch {epoch + 1}\"): step += 1 input_ids = input_ids.to(args.device) labels = labels.to(args.device) mask = (input_ids != tokenizer.pad_token_id).bool() outputs = model(input_ids=input_ids, labels=labels, attention_mask=mask) loss = outputs.loss optimizer.zero_grad() loss.backward() optimizer.step() if step % args.log_interval == 0: tqdm.write(f\"Epoch:[{epoch + 1}/{args.epochs}], loss: {loss.item():.4f}\") if step \u0026 args.save_interval == 0: save_lora(model, f\"{args.lora_path}/{args.lora_name}_{args.rank}.pth\") if __name__ == \"__main__\": args = get_args() train(args) æ¨¡å‹è¾“å‡ºå¦‚ä¸‹ï¼š text ğŸ’¬: ä½ æœ‰ä»€ä¹ˆç‰¹é•¿ï¼Ÿ ğŸ¤–: å—¯...æˆ‘æœ‰å†™æ•…äº‹çš„èƒ½åŠ›å“¦ï¼Œèƒ½å†™å‡ºå¥½å¤šä¸ªæœ‰è¶£çš„æ•…äº‹å‘¢ï¼ä¸è¿‡è¿™å¯æ˜¯æˆ‘çš„å¤©èµ‹å˜›ï¼ˆæ¼ï¼‰ [Speed]: 10.99 tokens/s ğŸ’¬: ä¸ºä»€ä¹ˆå¤©ç©ºæ˜¯è“è‰²çš„ ğŸ¤–: å› ä¸ºæ°´åˆ†å­åœ¨é˜³å…‰ä¸‹ä¼šæ•£å°„ï¼Œæ‰€ä»¥å¤©ç©ºå‘ˆç°è“è‰²ï¼ï¼ˆç­”ï¼‰ [Speed]: 13.29 tokens/s ğŸ’¬: è§£é‡Šä¸€ä¸‹\"å…‰åˆä½œç”¨\"çš„åŸºæœ¬è¿‡ç¨‹ ğŸ¤–: å…‰åˆä½œç”¨æ˜¯ä¸€ç§æ¤ç‰©ã€è—»ç±»å’ŒæŸäº›ç»†èŒç­‰ç”Ÿç‰©é€šè¿‡å¶ç»¿ä½“ä¸­çš„è‰²ç´ å¸æ”¶å¤ªé˜³å…‰ï¼Œå°†æ°´åˆ†è§£ä¸ºæ°§æ°”ï¼Œå¹¶é‡Šæ”¾å‡ºäºŒæ°§åŒ–ç¢³çš„è¿‡ç¨‹ã€‚åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œæ¤ç‰©åˆ©ç”¨é˜³å…‰èƒ½é‡åˆæˆç³–åˆ†å¹¶å‚¨å­˜è¿™äº›ç‰©è´¨ä½œä¸ºå‚¨è—åº“ä¾›ä»¥åä½¿ç”¨ã€‚è¿™ä¸€æ­¥æ˜¯ç”Ÿå‘½æ´»åŠ¨çš„åŸºç¡€ä¹‹ä¸€ï¼ï¼ˆæ³¨æ„ï¼šè¿™ä¸ªå› ç­”å¯èƒ½æœ‰äº›è¯¯å¯¼æ€§å“¦ï¼‰ [Speed]: 13.17 tokens/s ğŸ’¬: å¦‚æœæ˜å¤©ä¸‹é›¨ï¼Œæˆ‘åº”è¯¥å¦‚ä½•å‡ºé—¨ ğŸ¤–: å…ˆçœ‹å¤©æ°”é¢„æŠ¥ï¼å†å†³å®šæ˜¯å¦å¸¦ä¼ã€‚å¦‚æœæ˜¯æ™´å¤©é‚£å°±ç›´æ¥å‡ºå‘å§ [Speed]: 13.34 tokens/s ğŸ’¬: æ¯”è¾ƒä¸€ä¸‹çŒ«å’Œç‹—ä½œä¸ºå® ç‰©çš„ä¼˜ç¼ºç‚¹ ğŸ¤–: ä¼˜ç‚¹ï¼šçŒ«æ¯”ç‹—æ›´èªæ˜ï¼Œèƒ½æ„ŸçŸ¥åˆ°ä¸»äººçš„æƒ…ç»ªï¼›è€Œç‹—åˆ™æœ‰æ›´å¼ºçš„è´£ä»»æ„Ÿã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä»¬å¯èƒ½ç¼ºä¹è¶³å¤Ÿçš„äº’åŠ¨æ—¶é—´æ¥åŸ¹å…»å½¼æ­¤çš„æ„Ÿæƒ…ã€‚å› æ­¤åœ¨é€‰æ‹©æ—¶éœ€è¦æƒè¡¡è¿™äº›å› ç´ ï¼Œå¹¶è€ƒè™‘æ˜¯å¦èƒ½å¤Ÿä¸ºå¯¹æ–¹æä¾›è¶³å¤Ÿçš„æƒ…æ„Ÿæ”¯æŒã€‚å¦‚æœä½ ä»¬æ„¿æ„æŠ•å…¥æ›´å¤š çš„æ—¶é—´ä¸ç²¾åŠ›å»å»ºç«‹æƒ…æ„Ÿè”ç³»çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•å°†ä¸¤è€…æ”¾åœ¨åŒä¸€ä¸ªå®¶åº­ä¸­ï¼Œå…±åŒæˆé•¿å§ï¼ [Speed]: 12.99 tokens/s ğŸ’¬: è§£é‡Šä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹  ğŸ¤–: ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è®©è®¡ç®—æœºé€šè¿‡ç»éªŒæ¥å‘ç°è§„å¾‹å’Œæ¨¡å¼ï¼Œä»è€Œæé«˜å¯¹æ–°æ•°æ®çš„ç†è§£ä¸é¢„æµ‹èƒ½åŠ›ã€‚ä¾‹å¦‚ï¼Œåœ¨åˆ†ç±»é—®é¢˜ä¸­ï¼Œè®­ç»ƒæ¨¡å‹æ—¶å¯ä»¥å°†å¤§é‡å·²çŸ¥çš„æ•°æ®é›†åˆ†æˆè®­ç»ƒé›†ã€æµ‹è¯•é›†ç­‰éƒ¨åˆ†ï¼Œå¹¶ç”¨è¿™äº›æ•°æ®é›†ä¸Šçš„ä¿¡æ¯å»ä¼˜åŒ–æ¨¡å‹å‚æ•°ï¼ˆå³è¿‡æ‹Ÿåˆï¼‰ï¼Œæœ€åå°±èƒ½åœ¨æ–°çš„æµ‹ è¯•é›†ä¸­åšå‡ºæ›´å‡†ç¡®çš„åˆ¤æ–­äº†ï¼ [Speed]: 12.85 tokens/s ğŸ’¬: æ¨èä¸€äº›ä¸­å›½çš„ç¾é£Ÿ ğŸ¤–: å—¯...ä¸­å›½æœ‰å¾ˆå¤šå¥½åƒçš„ä¸œè¥¿å‘¢ï¼Œæ¯”å¦‚é¥ºå­ã€åŒ…å­ã€æ±¤åœ†ç­‰ç­‰ã€‚ä¸è¿‡è¿™äº›åº”è¯¥éƒ½æ˜¯æ¯”è¾ƒæ™®é€šçš„äº†å–µï¼ [Speed]: 12.58 tokens/s å¯ä»¥çœ‹å‡ºæ¥æ•°æ®é›†çš„è¯­è¨€é£æ ¼å·²ç»å¯ä»¥æ¨¡ä»¿ä¸ª 8-9 æˆäº†ã€‚ è®°å½•å¾®è°ƒ Qwen3 æ—¶å€™å‡ºç°çš„ä¸€ä¸ª BUGï¼šloss=na","date":"2026-02-13","objectID":"/posts/minimind-lora/:3:2","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å…­)ï¼šLoRA","uri":"/posts/minimind-lora/#qwen3-06b-å¾®è°ƒ"},{"categories":null,"content":"åœ¨ MiniMind ç³»åˆ—çš„ eval éƒ¨åˆ†æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•é€šè¿‡ transformers åº“é‡Œ GenerateMixin åŸºç±»æ¥ç”Ÿæˆæ–‡æœ¬ï¼Œè¿™ä¸€ç« å­¦ä¹ ä¸€ä¸‹ model.generate() æ–¹æ³•åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„ã€‚ MiniMind å­¦ä¹ æŒ‡åŒ—(å››)ï¼šè¯„ä¼° 2026-01-25 #å¤§æ¨¡å‹Â #æ·±åº¦å­¦ä¹ Â  è¿™ä¸€ç« æˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªè„šæœ¬æ¥éªŒè¯å¤§æ¨¡å‹çš„å¯¹è¯èƒ½åŠ› è¯„ä¼°è„šæœ¬æˆ‘ä»¬é¢„è®­ç»ƒæ˜¯è®©æ¨¡å‹å­¦ä¼šè¯´è¯çš„èƒ½åŠ›ï¼Œæˆ–è€…è¯´è¯è¯­æ¥é¾™çš„èƒ½åŠ›ï¼Œç»™ä»–ä¸€ä¸ª prompt å®ƒå¯ä»¥æ¥ç€è¯´ä¸‹å»ã€‚å› æ­¤æˆ‘ä»¬åœ¨å¤„ç† prompt æ—¶å€™éœ€è¦ç¨åŠ å¤„ç†ï¼š python ","date":"2026-02-11","objectID":"/posts/llm-generate/:0:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"æ¨¡å‹çš„ generate æ–¹æ³•","uri":"/posts/llm-generate/#"},{"categories":null,"content":" ä¸ºä»€ä¹ˆéœ€è¦ Generateï¼ŸTransformer æ¨¡å‹åœ¨è®­ç»ƒæ—¶æœ‰ä¸€ä¸ª forward æ–¹æ³•ï¼Œæ˜¯ç”¨äºé’ˆå¯¹æ¨¡å‹çš„è¾“å…¥æ¥äº§ç”Ÿè¾“å‡ºï¼Œä»è€Œè®¡ç®—æŸå¤± lossï¼Œæ›´æ–°æ¨¡å‹çš„å‚æ•°ã€‚æ—¢ç„¶æœ‰è¿™ä¹ˆä¸€ä¸ªç”Ÿæˆçš„å‡½æ•°äº†ï¼Œä¸ºä»€ä¹ˆ Transformer ä¸­è¿˜æœ‰ä¸“é—¨è®¾è®¡ generate æ–¹æ³•æ¥è´Ÿè´£åœ¨æ¨ç†æ—¶ç”Ÿæˆæ–‡æœ¬å‘¢ï¼Ÿ è¿™é‡Œé¢ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š æ¨¡å‹è®­ç»ƒä¸ç”Ÿæˆçš„å·®å¼‚ï¼šÂ ä¸€èˆ¬æƒ…å†µä¸‹ï¼ˆæ¯”å¦‚åœ¨åˆ†ç±»ä»»åŠ¡ä¸Šï¼‰ï¼Œforward æ–¹æ³•ä¸ decoding æˆ–è€… prediction æ—¶çš„å¤„ç†æ˜¯ä¸€è‡´çš„ã€‚ä½†æ˜¯åœ¨ LM çš„è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œè®­ç»ƒé˜¶æ®µçš„ forward æ–¹æ³•ä¸­é€šå¸¸å¹¶ä¸é‡‡ç”¨çœŸæ­£çš„é€’å½’çš„æ–¹å¼è¿›è¡Œé€æ­¥å¤„ç†ã€‚åœ¨ç†è®ºä¸Šï¼ŒLMæ¨¡å‹é€šè¿‡è¾“å…¥çš„ä¸€ç»„ tokenï¼Œæ¥é¢„æµ‹ä¸‹ä¸€ä¸ª tokenã€‚ ç„¶åå†å°†æ–°çš„é¢„æµ‹å‡ºçš„ token ä¸å‰é¢çš„ token åºåˆ—è¿›è¡Œé“¾æ¥ï¼Œç”¨æ¥ç»§ç»­é¢„æµ‹ä¸‹ä¸€ä¸ª tokenã€‚ä½†æ˜¯åœ¨å®é™…è®­ç»ƒä¸­ï¼Œä¸Šé¢çš„è‡ªå›å½’çš„è®­ç»ƒæ–¹å¼è®­ç»ƒçš„æ•ˆç‡éå¸¸çš„ä½ï¼Œæ— æ³•æ›´å¥½çš„åˆ©ç”¨GPUçš„å¹¶è¡Œå¤„ç†èƒ½åŠ›ï¼Œå› æ­¤å®é™…è®­ç»ƒä¸­ä¸€èˆ¬é‡‡ç”¨ Teacher-Forcing è¿™ç§æ–¹å¼å¹¶è¡Œçš„è®­ç»ƒã€‚ LM Decodingæ–¹æ³•çš„å¤æ‚æ€§ï¼š ç›¸æ¯”åˆ†ç±»ä»»åŠ¡ï¼ŒLM è¿™ç§è‡ªé€’å½’çš„ç”Ÿæˆä»»åŠ¡çš„è§£ç é€šå¸¸éƒ½æ¯”è¾ƒå¤æ‚ã€‚æ¯”å¦‚åœ¨ LM æˆ–è€… ASR ä»»åŠ¡ä¸­è§£ç æ–¹æ³•æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ greedy_search(), contrastive_search()ï¼Œsample()ï¼Œbeam_search()ï¼Œbeam_sample() ç­‰ç­‰ã€‚é€šè¿‡ä½¿ç”¨æ›´åŠ å¤æ‚çš„è§£ç çš„æ–¹æ³•ï¼Œé€šå¸¸å¯ä»¥å¾—åˆ°æ›´å¥½çš„æ•ˆæœã€‚æ¯”å¦‚ beam_search çš„ç»“æœæ¯” greedy_search çš„ç»“æœé€šå¸¸ä¼šæ›´å¥½ã€‚ä½†æ˜¯åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨çš„æ–¹æ³•æ›´åŠ ç±»ä¼¼äº greedy searchã€‚å› æ­¤ï¼Œè®¾è®¡æ›´å¥½çš„è§£ç ç®—æ³•ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç ”ç©¶æ–¹å‘ã€‚ ","date":"2026-02-11","objectID":"/posts/llm-generate/:1:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"æ¨¡å‹çš„ generate æ–¹æ³•","uri":"/posts/llm-generate/#ä¸ºä»€ä¹ˆéœ€è¦-generate"},{"categories":null,"content":" å¸¸è§çš„è§£ç æ–¹å¼","date":"2026-02-11","objectID":"/posts/llm-generate/:2:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"æ¨¡å‹çš„ generate æ–¹æ³•","uri":"/posts/llm-generate/#å¸¸è§çš„è§£ç æ–¹å¼"},{"categories":null,"content":" Greedy Search Greedy Search é¡¾åæ€ä¹‰æ˜¯è´ªå¿ƒæœç´¢ï¼Œå³æ¯æ­¥é€‰æ‹©æ¦‚ç‡æœ€å¤§çš„ tokenã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä»å•è¯ The å¼€å§‹ï¼Œè¯¥ç­–ç•¥æ¯æ­¥éƒ½ä¼šé€‰æ‹©ä¸‹ä¸€æ­¥æ¦‚ç‡æœ€å¤§çš„è¯ï¼Œæœ€åä¼šå¾—åˆ°è¾“å‡ºåºåˆ— The nice womanï¼Œæ€»æ¦‚ç‡æ˜¯ 0.5 * 0.4 = 0.2ã€‚Greedy Search é€Ÿåº¦æœ€å¿«ä½†ä¹Ÿæœ‰å¦‚ä¸‹å‡ ä¸ªç¼ºç‚¹ï¼š å®ƒå¯èƒ½ä¼šé”™è¿‡å…¨å±€æ¦‚ç‡æœ€å¤§çš„åºåˆ—ã€‚æ¯”å¦‚ä¸Šå›¾ä¸­ï¼ŒThe dog has çš„æ€»æ¦‚ç‡æ›´å¤§ï¼Œæ˜¯0.4 * 0.9 = 0.36ã€‚ ç”±äºç¼ºå°‘éšæœºæ€§ï¼Œæ¨¡å‹åœ¨è¾“å‡ºä¸€ä¸ªé‡å¤çš„ token ä¹‹åï¼Œæœ‰è¾ƒå¤§å¯èƒ½é™·å…¥é‡å¤è¾“å‡ºåºåˆ—çš„å¾ªç¯ã€‚ Greedy Search è§£ç æ–¹å¼éå¸¸æ¥è¿‘æ¨¡å‹è®­ç»ƒæ—¶å€™çš„ objectiveï¼Œå› æ­¤å®¹æ˜“å¤è¿°è®­ç»ƒæ•°æ®ï¼Œç¼ºå°‘äº†åˆ›é€ æ€§ã€‚ ","date":"2026-02-11","objectID":"/posts/llm-generate/:2:1","series":["LLM"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"æ¨¡å‹çš„ generate æ–¹æ³•","uri":"/posts/llm-generate/#greedy-search"},{"categories":null,"content":" Beam Search ä¸ºäº†è§£å†³ Greedy Search å¯èƒ½é”™è¿‡å…¨å±€æœ€å¤§æ¦‚ç‡åºåˆ—çš„é—®é¢˜ï¼ŒBeam Search ç­–ç•¥ç»å¸¸ä¼šè¢«é‡‡ç”¨ï¼Œå³ç»´æŠ¤ beam=nï¼Œä¿ç•™å½“å‰æœ€ä½³çš„n ä¸ªåºåˆ—ï¼Œå¹¶ä¸”å¯¹äºæ¯ä¸ªåºåˆ—ï¼Œéƒ½åœ¨è®¡ç®—æœ€å¥½çš„ n ä¸ª next tokenï¼Œç„¶åå†ä» $n*n$ ä¸ªç»“æœä¸­ï¼Œä¿ç•™ n ä¸ªæ¦‚ç‡ä¹˜ç§¯æœ€å¤§çš„åºåˆ—ã€‚æ¯”å¦‚ä¸Šå›¾ä¸­ï¼Œå‡è®¾ beam=2ï¼Œä»Â TheÂ å¼€å§‹ï¼Œä¼šä¿ç•™ [The dog, The nice] ä¸¤ä¸ªåºåˆ—ï¼Œæ¥ç€æ¯ä¸ªåºåˆ—é€‰å– 2 ä¸ªæœ€ä½³çš„ next tokenï¼Œå¾—åˆ°4ä¸ªåºåˆ—ï¼Œå†ä»ä¸­é€‰æ‹©2ä¸ªæœ€ä½³åºåˆ— [The dog has, The nice woman]ã€‚ç„¶è€Œï¼Œbeam Search æœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š åœ¨ NLP ä»»åŠ¡ä¸­ä¸€èˆ¬å°† eos_token è§†ä¸ºæ–‡æœ¬çš„ç»“å°¾ï¼Œä¹Ÿå°±æ˜¯ absorbing stateã€‚å¦‚æœæŸä¸ªå€™é€‰åºåˆ—è¾¾åˆ°è¿™ä¸ª absorbing stateï¼Œå°±ä¸å†æ‰©å±•å®ƒã€‚è¿™å°±ä¼šé€ æˆ Beam Search é€šå¸¸ä¼šå€¾å‘äºæ›´çŸ­çš„åºåˆ—ï¼Œå› ä¸ºé•¿åºåˆ—ç®—æ¦‚ç‡ä¹˜ç§¯åï¼Œæ•°å€¼ä¼šç›¸å¯¹çŸ­åºåˆ—æ›´å°ã€‚å› æ­¤ï¼Œä¸€èˆ¬ä¼šåœ¨å¾—åˆ†å‡½æ•°ä¸­å¼•å…¥ length normalization å¯¹é•¿åº¦è¿›è¡Œå½’ä¸€åŒ–ã€‚ ç”±äºç¼ºå°‘éšæœºæ€§ï¼ŒBeam Search ä»ç„¶å¾ˆå¯èƒ½æ‰å…¥é‡å¤åºåˆ—çš„å¾ªç¯ã€‚å› è€Œä¸€äº›å·¥ä½œå¼•å…¥äº† n-grams penalty æ¥ç¼“è§£ã€‚æœ€å¸¸è§çš„æ–¹æ³•æ˜¯é€šè¿‡å°†å·²ç»çœ‹åˆ°çš„ n-gram çš„ä¸‹ä¸€ä¸ªå•è¯çš„æ¦‚ç‡è®¾ç½®ä¸º 0ï¼Œæ¥ç¡®ä¿æ²¡æœ‰ n-gram å‡ºç°ä¸¤æ¬¡ã€‚n æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œå¦‚æœ n è®¾ä¸º2ï¼Œåˆ™ 2-gram åºåˆ—ï¼Œæ¯”å¦‚ New York ä¸ä¼šåœ¨è§£ç ä¸­å‡ºç°ä¸¤æ¬¡ã€‚ æœ€åï¼Œç›¸æ¯”äºäººç±»è¯­å¥ä¸€èˆ¬ä¸å¤ªå¯é¢„æµ‹ï¼ŒBeam Search ç”Ÿæˆçš„åºåˆ—ç¼ºå°‘æƒŠå–œï¼Œå› æ­¤åœ¨éœ€è¦åˆ›é€ æ€§çš„ç”Ÿæˆåœºæ™¯ä¸­ä¸æ˜¯éå¸¸åˆé€‚ã€‚ ","date":"2026-02-11","objectID":"/posts/llm-generate/:2:2","series":["LLM"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"æ¨¡å‹çš„ generate æ–¹æ³•","uri":"/posts/llm-generate/#beam-search"},{"categories":null,"content":" Random Sampling éšæœºé‡‡æ ·ç­–ç•¥æ ¹æ®å½“å‰çš„æ¦‚ç‡æ¥æŠ½ç­¾é€‰æ‹© next tokenã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä»»ä½•è¯éƒ½æœ‰ä¸€å®šæ¦‚ç‡è¢«é€‰æ‹©ã€‚è¯¥æ–¹æ¡ˆç”Ÿæˆçš„åºåˆ—å……æ»¡äº†åˆ›é€ æ€§ï¼Œä¹Ÿç›¸å¯¹è¾ƒå°‘å‡ºç°é‡å¤åºåˆ—å¾ªç¯é—®é¢˜ã€‚ä½†æ˜¯å®ƒç”Ÿæˆçš„è¯­å¥å´å¾ˆå¯èƒ½ä¸é€šé¡ºã€‚ è¿™é‡Œä¸€èˆ¬ä¼šå¼•å…¥ temperature æ¥æ”¹å˜ç”Ÿæˆ next token çš„æ¦‚ç‡åˆ†å¸ƒï¼Œä½¿å…¶æ›´åå‘äº high probability tokenã€‚å…·ä½“æ¥è¯´æ˜¯é€šè¿‡ $prob=\\text{softmax}(\\frac{logits}{T})$ æ§åˆ¶æ–‡æœ¬ç”Ÿæˆçš„å¤šæ ·æ€§ T = 1ï¼šåŸå§‹åˆ†å¸ƒã€‚ T \u003c 1ï¼šåˆ†å¸ƒå˜å°–ï¼Œå¤§æ¦‚ç‡çš„ token æ›´å ä¼˜åŠ¿ã€‚ T \u003e 1ï¼šåˆ†å¸ƒå˜å¹³ï¼Œå°æ¦‚ç‡çš„ token è¢«æŠ¬é«˜ã€‚ T â†’ 0ï¼šæ¥è¿‘ one-hot ï¼Œåªå‰© logit æœ€å¤§çš„ tokenï¼Œæ¥è¿‘ Greedy Searchã€‚ temperature=0æ˜¯ä¸æ˜¯ç­‰åŒäº Greedy Searchï¼Ÿ é”™è¯¯çš„ï¼Œåœ¨å®è·µä¸­æˆ‘ä»¬ä¼šå‘ç°æŠŠ temperature è®¾ä¸º 0ï¼Œæ¯æ¬¡è¾“å‡ºçš„æ–‡æœ¬è¿˜æ˜¯æœ‰æ‰€ä¸åŒï¼Œä¸»è¦æ˜¯æœ‰ä¸‰ä¸ªåŸå› ã€‚ é¦–å…ˆæ˜¯å› ä¸º æµ®ç‚¹æ•°åŠ æ³•ä¸æ»¡è¶³ç»“åˆå¾‹ã€‚æˆ‘ä»¬éƒ½çŸ¥é“è®¡ç®—æœºå†…éƒ¨æµ®ç‚¹æ•° float æ˜¯ç”¨å°¾æ•°+ç²¾åº¦çš„æ–¹æ³•å­˜å‚¨çš„ï¼Œæ‰€ä»¥æµ®ç‚¹æ•°è¿›è¡ŒåŠ æ³•å¯èƒ½å¯¼è‡´æº¢å‡ºã€‚ä¾‹å¦‚åœ¨ python ä¸­ (1 + 1e-16) - 1e-16=0 å’Œ 1 + (1e-16 - 1e-16) = 1 ä¸¤è€…ç­”æ¡ˆå°±ä¸åŒã€‚åœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼Œå¤šå¡å¤šæœºå¹¶å‘çš„é€šè®¯å»¶è¿Ÿï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´è®¡ç®—é€Ÿåº¦å¯¼è‡´çš„å…ˆåå·®å¼‚ï¼Œéƒ½å¯èƒ½å¯¼è‡´è®¡ç®—çš„å…ˆåé¡ºåºä¸åŒï¼Œæœ€ç»ˆå¯¼è‡´ç»“æœä¸åŒã€‚ å¦ä¸€æ–¹é¢ï¼Œåªä» DeepSeek é—®ä¸–ä¹‹å MoE æ¶æ„è¢«å¹¿æ³›é‡‡ç”¨ã€‚å¦‚æœæ˜¯æˆ‘ä»¬è‡ªå·±éƒ¨ç½²æ¨ç†æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœç”¨çš„æ˜¯å¤§å‹å‚å•†çš„æœåŠ¡ï¼Œä»–ä»¬å¾€å¾€ä¸ºäº†æé«˜æ•ˆç‡æŠŠå¤šä¸ªè¯·æ±‚åˆå¹¶æˆä¸€ä¸ªå¤§ batch è¿›è¡Œæ¨ç†ã€‚åœ¨ MoE ä¸­ä¸ºäº†æ•ˆç‡è€ƒè™‘ï¼Œæ¯ä¸ªä¸“å®¶é€šå¸¸éƒ½ç”¨å®¹é‡é™åˆ¶ï¼Œä¸€ä¸ªä¸“å®¶åŒæ—¶åªèƒ½å¤„ç†æœ‰é™æ•°é‡çš„ tokenã€‚å½“æˆ‘ä»¬çš„ prompt é‡ŒæŸä¸ª token å’Œåˆ«äºº prompt é‡Œé¢æŸä¸ª token åŒæ—¶ç«äº‰ä¸€ä¸ªä¸“å®¶æ—¶ï¼Œè°è¢«åˆ†é…åˆ°å¤‡ç”¨ä¸“å®¶å°±ä¸ä¸€å®šäº†ï¼Œæ‰€ä»¥è¾“å‡ºä¹Ÿä¸ä¸€å®šã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨ Random Sampling åŸºç¡€ä¸Šè¿˜æå‡ºäº†å¤šç§é‡‡ç”¨ç­–ç•¥ï¼š Top-p Samplingï¼šæŒ‰ç…§æ¦‚ç‡ä»é«˜åˆ°ä½é€‰æ‹© n ä¸ªè¯ï¼Œä½¿å®ƒä»¬çš„ç´¯è®¡æ¦‚ç‡ä¸º pï¼Œåœ¨è¿™ n ä¸ªè¯é‡Œé¢éšæœºé‡‡æ ·ã€‚ Top-K Samplingï¼šé™åˆ¶äº†æ¨¡å‹åªèƒ½ä»æ¦‚ç‡æœ€é«˜çš„ k ä¸ªè¯ä¸­æŒ‰ç…§ Basic Sampling é‡‡æ ·ï¼Œä¼˜ç‚¹æ˜¯é¿å…äº†ä½æ¦‚ç‡è¯æ±‡çš„å½±å“ï¼Œæé«˜äº†æ–‡æœ¬è´¨é‡ï¼Œä½† k å¯èƒ½ä¼šå¯¼è‡´è¯æ±‡è¿‡äºå±€é™ï¼Œä¸å¦‚ Top-p Sampling çµæ´»ã€‚ ","date":"2026-02-11","objectID":"/posts/llm-generate/:2:3","series":["LLM"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"æ¨¡å‹çš„ generate æ–¹æ³•","uri":"/posts/llm-generate/#random-sampling"},{"categories":null,"content":" Rank Beam Sampling Adiwardana et al., 2020 æå‡ºäº† sample-and-rank è§£ç ç­–ç•¥ï¼Œè¯¥æ–¹æ³•åœ¨å¯¹è¯é¢†åŸŸæ•ˆæœå¾ˆå¥½ã€‚å…¶æ€æƒ³æ˜¯å…ˆé€šè¿‡ random samplingï¼ˆç»“åˆtemperatureè°ƒæ•´æ¦‚ç‡åˆ†å¸ƒï¼‰ç”Ÿæˆå‡º N ä¸ªÂ sentenceï¼Œç„¶åå†ä» n ä¸ª sentence ä¸­é€‰æ‹©æ¦‚ç‡ä¹˜ç§¯æœ€å¤§çš„ã€‚è¿™ç§æ–¹å¼é€šè¿‡ random sampling ä¿ç•™äº†ç”Ÿæˆç»“æœçš„å¤šæ ·æ€§å’Œåˆ›é€ æ€§ï¼Œååˆé€šè¿‡ rank è¿‡æ»¤æ‰äº†ä¸é€šé¡ºçš„åºåˆ—ã€‚ä¸‹é¢ä¸¤ä¸ªè¡¨æ ¼å¯¹æ¯”äº† sample çš„ç»“æœå’Œ beam search çš„ç»“æœã€‚æ˜æ˜¾åœ°ï¼Œsample ç»“æœå¤šæ ·æ€§ä¼šæ›´å¥½ã€‚ beam sample æ–¹æ³•æ˜¯ sample and rank çš„æ”¹è¿›ï¼ŒåŸç†ä¸Šç±»ä¼¼ï¼Œç›¸æ¯” sample and rank åœ¨æœ€åæ‰å¯¹ç»“æœæ’åºå»è·å¾—æœ€ä½³çš„ n ä¸ªåºåˆ—ï¼Œbeam sampleÂ åœ¨æ¯ä¸€æ­¥ä¿ç•™å½“å‰æœ€ä½³çš„ n ä¸ªåºåˆ—ï¼Œæ—¢ä¿è¯äº†å¤šæ ·æ€§å’Œåˆ›é€ æ€§ï¼Œåˆå¯ä»¥å‡å°‘åœ¨ rank é˜¶æ®µéœ€è¦è¿‡æ»¤æ‰çš„å¥å­ã€‚ ","date":"2026-02-11","objectID":"/posts/llm-generate/:2:4","series":["LLM"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"æ¨¡å‹çš„ generate æ–¹æ³•","uri":"/posts/llm-generate/#rank-beam-sampling"},{"categories":null,"content":" Group Beam Search group beam search åŒæ ·æ˜¯ä¸ºäº†è§£å†³ beam search å¤šæ ·æ€§ä¸è¶³çš„é—®é¢˜ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¯ä»¥å‘ç° beam search ç”Ÿæˆçš„å›¾åƒæè¿°å‡ ä¹æ˜¯é‡å¤çš„ï¼Œè¿™æ˜¯ç”±äºåœ¨æœç´¢æ ‘ä¸­å…·æœ‰ç›¸ä¼¼çš„å…±äº«è·¯å¾„ï¼Œå¯¼è‡´æœ€ç»ˆçš„å˜åŒ–å¾ˆå°ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œgroup(diverse) beam search ç”Ÿæˆçš„ç»“æœåˆ™æ›´å¤šæ ·åŒ–ï¼Œä¹Ÿæ›´åŠ ç±»ä¼¼æè¿°å›¾åƒçš„äººé™…å·®å¼‚ã€‚ group beam search ä¸»è¦æ€è·¯æ˜¯é€šè¿‡å°† beam search ä¸­çš„å€™é€‰è·¯å¾„è¿›è¡Œåˆ†ç»„ï¼Œåœ¨å„ç»„å†…å»å¯»æ‰¾æœ€ä¼˜è§£ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œbeam search çš„å€™é€‰è·¯å¾„æœ‰6æ¡ï¼Œgroup beam search å°†è¿™6æ¡å€™é€‰è·¯å¾„ä¸¤ä¸¤ä½œä¸ºä¸€ç»„ï¼Œåˆ†ä¸ºä¸‰ç»„ã€‚æ¯ä¸€æ­¥éƒ½åœ¨å„ç»„å†…çš„è¯è¡¨ç©ºé—´ä¸‹å»å– top-2 çš„ç»“æœä½œä¸ºå½“å‰é¢„æµ‹çš„ tokenï¼Œå¯¹äºå½“å‰ç»„æ¥è¯´ï¼Œé€šè¿‡å¯¹ä¹‹å‰ç»„å·²ç”Ÿæˆçš„ token è¿›è¡Œæƒ©ç½šï¼Œæ¥ä¿è¯å½“å‰ç»„ç”Ÿæˆçš„ token ä¸ä¹‹å‰ç»„ä¸åŒçš„æ¦‚ç‡æ›´å¤§ï¼Œä»è€Œæ›´å…·å¤šæ ·æ€§ã€‚ ","date":"2026-02-11","objectID":"/posts/llm-generate/:2:5","series":["LLM"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"æ¨¡å‹çš„ generate æ–¹æ³•","uri":"/posts/llm-generate/#group-beam-search"},{"categories":null,"content":" ä»£ç å®ç°è¿™æ¬¡æˆ‘ä»¬å‚è€ƒ transformers åº“å®ç°ä¸€ä¸ª GenerateMixinï¼Œæ ¸å¿ƒå°±æ˜¯ model.generate() æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å®ç° Greedy Search å’Œ TopPã€TopK Sampling è¿™å‡ ç§æ¯”è¾ƒç®€å•çš„è§£ç ç­–ç•¥ã€‚ python @torch.inference_mode() def generate( self, input_ids: Union[list[int], torch.Tensor], attention_mask: Optional[torch.tensor] = None, max_new_tokens: int = 8192, min_length: int = -1, temperature: float = DEFAULT_TEMPERATURE, top_p: float = DEFAULT_TOP_P, top_k: float = DEFAULT_TOP_K, eos_token_id: Optional[int] = None, use_cache: bool = True, num_return_sequences: int = 1, do_sample: bool = True, repetition_penalty: float = DEFAULT_REPETITION_PENALTY, past_key_values: Optional[DynamicCache] = None, ) -\u003e torch.Tensor: è¿™é‡Œæœ‰å‡ ä¸ªå‚æ•°éœ€è¦ä»‹ç»ä¸€ä¸‹ï¼š max_new_tokensï¼šæ§åˆ¶ç”Ÿæˆçš„ token æ•°é‡ min_lengthï¼šæ§åˆ¶æ–‡æœ¬çš„æœ€çŸ­é•¿åº¦ use_cacheï¼šæ˜¯ä¸æ˜¯é‡‡ç”¨ KVCache num_return_sequencesï¼šä¸€æ¬¡ç”Ÿæˆå¤šæ¡ response repetition_penaltyï¼šæƒ©ç½šé‡å¤ç”Ÿæˆçš„ token 1. å‚æ•°é¢„å¤„ç† python if isinstance(input_ids, list): input_ids = torch.tensor(input_ids) initial_len = input_ids.size(-1) input_ids = input_ids.repeat(num_return_sequences, 1) if attention_mask is not None: attention_mask = attention_mask.repeat(num_return_sequences, 1) è¿™é‡Œæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æŠŠåºåˆ—å¤åˆ¶ num_return_sequences ä¸ªï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨ GPU å¹¶è¡Œæ¨ç†ç”Ÿæˆå¤šä¸ªåºåˆ—ã€‚ 2. æ¨ç†ç”Ÿæˆ python for _ in range(max_new_tokens - initial_len): past_len = past_key_values.get_seq_length() if past_key_values else 0 output = self.forward( input_ids=input_ids[:, past_len:], attention_mask=attention_mask, labels=None, past_key_values=past_key_values, use_cache=use_cache, logits_to_keep=1, ) logits = output.logits[:, -1, :] if min_length != -1: logits = min_length_processor(input_ids, logits, eos_token_id, initial_len) if repetition_penalty != DEFAULT_REPETITION_PENALTY: logits = repetition_penalty_processor(input_ids, logits, repetition_penalty) if do_sample: if temperature != DEFAULT_TEMPERATURE: logits = temperature_warper(logits, temperature) if top_k != DEFAULT_TOP_K: logits = top_k_warper(input_ids, logits, top_k) if top_p != DEFAULT_TOP_P: logits = top_p_warper() if do_sample: probs = torch.softmax(logits, dim=-1) next_token = torch.multinomial(probs, num_samples=1) else: # greedy_search next_token = torch.argmax(logits, dim=-1, keepdim=True) # [bs, 1] å› ä¸ºæˆ‘ä»¬é‡‡ç”¨äº† KVCache æ‰€ä»¥è¦å¯¹ input_ids è¿›è¡Œåˆ‡ç‰‡ï¼šç¬¬ä¸€æ¬¡æ¨ç†æ—¶å€™å°±æ˜¯å¯¹æ•´ä¸ª prompt è¿›è¡Œæ¨ç†ï¼Œåé¢æ¯æ¬¡å°±åªéœ€è¦ä¼ å…¥ 1 ä¸ª token å°±å¥½äº†ã€‚è¿™é‡Œ KVCache é‡‡ç”¨äº† transformers åº“çš„ DynamicCache è€Œä¸æ˜¯è€ç‰ˆçš„ list[tuple]ï¼Œæ‰€ä»¥è¯»æ–‡æœ¬é•¿åº¦çš„æ–¹å¼æœ‰æ‰€ä¸åŒã€‚ç„¶åè°ƒç”¨ forward æ–¹æ³•ç”Ÿæˆæ³¨æ„åŠ›åˆ†æ•° logits ä¹‹åï¼Œæˆ‘ä»¬å°±åº”ç”¨ä¸åŒçš„ç­–ç•¥åŒ…æ‹¬æ¸©åº¦è°ƒèŠ‚ã€é‡å¤æƒ©ç½šç­‰ç­‰ï¼Œè¿™åé¢ä¼šå…·ä½“è¯´ã€‚ æœ€åæ ¹æ® do_sample åˆ¤æ–­æ˜¯é‡‡æ · or Greedy Search æ¥ç”Ÿæˆ next tokenã€‚ æˆ‘ä»¬ç”¨äº† KVCache é‚£ä¹ˆ `logits_to_keep=1` æ˜¯ä¸æ˜¯æ²¡å•¥ç”¨äº†ï¼Ÿ æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬å›å¿†ä¸€ä¸‹ logits_to_keep è¿™ä¸ªå‚æ•°çš„ä½œç”¨ã€‚ python slice_indices = slice(-logits_to_keep, None) if isinstance(logits_to_keep, int) else logits_to_keep logits = self.lm_head(hidden_states[:, slice_indices, :]) åœ¨æ¨¡å‹çš„æ¨ç†é˜¶æ®µï¼Œå‡å¦‚ä¸å¼€å¯ KVCacheï¼Œé‚£ä¹ˆæ¯æ¬¡ hidden_states çš„å½¢çŠ¶ä¸º [batch_size, seq_len, hidden_size]ï¼Œlm_head çš„è®¡ç®—å¼€é”€å°±æ˜¯ (batch_size Ã— seq_len Ã— hidden_dim) @ (hidden_dim Ã— vocab_size)ã€‚ä½†å®é™…ä¸Šåœ¨æ¨ç†é˜¶æ®µæˆ‘ä»¬åªéœ€è¦æœ€åä¸€ä¸ª token çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ hidden_states[:, -1, : æ‰æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œè¿™å°±æ˜¯ logits_to_keep è¿™ä¸ªå‚æ•°çš„æ„ä¹‰ã€‚ä½†æ˜¯æœ‰äº† KVCache ä¹‹åï¼Œç¬¬äºŒæ¬¡æ¨ç†å¼€å§‹æˆ‘ä»¬åªä¼ å…¥ä¸€ä¸ª tokenï¼Œä¹Ÿå°±æ˜¯è¯´ seq_len å›ºå®šä¸º 1 äº†ï¼Œé‚£ä¹ˆ logits_to_keep å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚ è®¨è®ºä¸¤ä¸ªå†™ä»£ç æ—¶å€™æœ‰ç‚¹çº ç»“çš„é—®é¢˜ï¼šattention mask å’Œ eos_tokenã€‚ attention mask åˆ«å padding maskï¼Œç”¨æ¥æ ‡è®° input_ids é‡Œé¢å“ªäº› token æ˜¯ pad ä¸Šå»æ²¡æœ‰è¯­ä¹‰çš„ï¼Œè®©æ¯ä¸ª token çš„æ³¨æ„åŠ›ä¸æµªè´¹åœ¨é‚£äº›æ— æ„ä¹‰çš„å¡«å……å­—ç¬¦ä¸Šã€‚æˆ‘ä»¬åœ¨ softmax ä¹‹å‰å¯¹æ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œå¤„ç†ï¼ŒæŠŠ pad çš„éƒ¨åˆ†ï¼Œç½®ä¸ºä¸€ä¸ªéå¸¸å¤§çš„è´Ÿæ•°ã€‚ä½†æ˜¯å› ä¸ºæˆ‘ä»¬é‡‡ç”¨äº† KVCacheï¼Œscores çš„å½¢çŠ¶ä» [batch_size, seq_len, seq_len] å˜æˆäº† [batch_size, q_len, v_len]ï¼Œä¹Ÿå°±æ˜¯ [batch_size, 1, v_len]ã€‚æˆ‘æœ€ç›´æ¥çš„æƒ³æ³•å°±æ˜¯ï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯ä¹Ÿéœ€è¦å¯¹ attention mask è¿›è¡Œåˆ‡ç‰‡ï¼Œè®©å®ƒé•¿åº¦ä¸º 1ï¼Ÿ python # Padding Mask if attention_mask is not None: assert attention_mask.dim() == 2 scores = scores.masked_fill(~attention_mask.unsqueeze(1).unsqueeze(2), float(\"-inf\")) æ·±å…¥ä»£ç ä¹‹åå‘ç°å…¶å®æ˜¯ä¸ç”¨çš„ã€‚ä½¿ç”¨ KVCache ä¹‹åï¼Œæˆ‘ä»¬ç”Ÿæˆçš„ attention mask çš„å½¢çŠ¶å…¶å®æ˜¯ [batch_size, v_len]ã€‚ç„¶åæˆ‘ä»¬åœ¨ç¬¬ä¸€ç»´ unsqueeze å½¢çŠ¶å°±æ˜¯ [batch_size, 1, v_len] äº†ï¼ˆè¿™é‡Œæ˜¯å¤šå¤´æ³¨æ„åŠ›æ‰€ä»¥è¿˜æœ‰ä¸€ä¸ª head ç»´åº¦ï¼Œå¤šäº†ä¸€ä¸ª unsqueezeï¼‰ã€‚ ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ eos_tokenã€‚num_return_sequences å‚æ•°è§„å®šäº† batch çš„æ•°é‡ï¼Œæˆ‘ä»¬åŒæ—¶æ¨ç†ç”Ÿæˆå¤šä¸ª responseã€‚ä½†æ˜¯ç”±äºæ¯ä¸ª sequence éƒ½æ˜¯å¹¶è¡ŒåŒæ—¶æ¨ç†çš„ï¼Œå‡å¦‚ä¸€ä¸ª sequence ç”Ÿæˆäº† eos_token æˆ‘ä»¬æ€ä¹ˆæ§åˆ¶è¿™ä¸ª sequence åç»­ä¸ç”Ÿæˆäº†å‘¢ï¼Ÿtransformers åº“çš„è§£å†³åŠæ³•æ˜¯è®°å½•ä¸‹æ¥å“ªäº› sequence å·²ç»ç»“æŸäº†ï¼Œç„¶åæŠŠè¿™äº› sequence çš„ next token éƒ½è®¾ä¸º eos_tokenã€‚ python unfinished_sequence = torch.ones(num_return_sequences) f","date":"2026-02-11","objectID":"/posts/llm-generate/:3:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"æ¨¡å‹çš„ generate æ–¹æ³•","uri":"/posts/llm-generate/#ä»£ç å®ç°"},{"categories":null,"content":"å‰é¢æˆ‘ä»¬å·²ç»è¿›è¡Œäº†é¢„è®­ç»ƒï¼Œå¾—åˆ°äº†ä¸€ä¸ªåªä¼šç»­å†™çš„æ¨¡å‹ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬é¢„è®­ç»ƒæ•°æ®é›†çš„æ–‡æœ¬éƒ½æ˜¯ç®€å•çš„ä¸€å¥è¯ï¼Œç„¶åé€šè¿‡åŠ å·¥æˆ‘ä»¬å¾—åˆ°äº†ç±»ä¼¼ â€œ\u003c|im_start|\u003e ç§¦å§‹çš‡çš„åŠŸç»©åŒ…æ‹¬ç»Ÿä¸€è´§å¸ã€æ–‡å­—â€ çš„æ–‡æœ¬ï¼Œé€šè¿‡ Teacher-Forcing å®ƒåªèƒ½åšåˆ°é¢„æµ‹ä¸‹ä¸€ä¸ª tokenï¼Œæˆ–è€…è¯´åªä¼šæœºæ¢°æ¥é¾™ï¼Œä¸ä¼šå¯¹è¯ã€‚ SFT å…¨ç§°æ˜¯ Supervised-Finetuneï¼Œä¹Ÿå°±æ˜¯ç›‘ç£å¾®è°ƒã€‚æˆ‘ä»¬é€šè¿‡ å¯¹è¯æ–‡æœ¬ çš„æ•°æ®é›†åœ¨é¢„è®­ç»ƒçš„æ¨¡å‹åŸºç¡€ä¸Šè¿›è¡Œè®­ç»ƒï¼Œå°±èƒ½è®©æ¨¡å‹å­¦ä¼šå¯¹è¯ã€‚ç®€å•æ¥è¯´ SFT å’Œ Pretrain è€…æœ‰ä»¥ä¸‹åŒºåˆ«ï¼š Pretrain çš„æ•°æ®éƒ½æ˜¯çº¯æ–‡æœ¬å¦‚ â€œä»Šå¤©å¤©æ°”å¾ˆå¥½â€¦\"ï¼Œè€Œ SFT çš„æ•°æ®é›†æ˜¯å¯¹è¯å¦‚ {â€œuserâ€:â€œä½ å¥½â€, â€œassistantâ€: â€œä½ ä¹Ÿå¥½â€} Pretrain ä¼šç›´æ¥ tokenize æ•´ä¸ªæ–‡æœ¬ï¼Œè€Œ SFT ä¼šç”¨ template æ¨¡æ¿å°†å¯¹è¯æ‹¼æ¥ä¸º â€œ\u003c|im_start|\u003euser ä½ å¥½ \u003c|im_end|\u003e\u003c|im_start|\u003eassistant ä½ ä¹Ÿå¥½ \u003c|im_end|\u003eâ€ è¿™æ ·çš„ç»“æ„åŒ–æ–‡æœ¬ã€‚ è®¡ç®—æŸå¤±å‡½æ•°æ—¶å€™ï¼ŒPretrain æ˜¯å¯¹æ¯ä¸€ä¸ª token è®¡ç®—æŸå¤±ï¼Œè€Œ SFT ä»…å¯¹ Assistant éƒ¨åˆ†è®¡ç®—æŸå¤± æ‰€ä»¥è¯´ SFT æˆ‘ä»¬åªéœ€è¦å¯¹ Dataset è¿›è¡Œæ”¹è¿›ï¼Œè®­ç»ƒæ–¹å¼è¿˜æ˜¯ä¹‹å‰çš„ Teacher-Forcingã€‚ ","date":"2026-02-10","objectID":"/posts/minimind-sft/:0:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(äº”)ï¼šSFT","uri":"/posts/minimind-sft/#"},{"categories":null,"content":" æ”¹é€  Datasetå…ˆæ¥çœ‹çœ‹æˆ‘ä»¬ SFT çš„æ•°æ®é›†æ˜¯å•¥æ ·çš„ï¼š json { \"conversations\": [ {\"role\": \"user\", \"content\": \"hello!\"}, {\"role\": \"assistant\", \"content\": \"hi!\"} ] } åœ¨ MiniMind å®ç°é‡Œé¢ï¼Œé™¤äº†æŠŠ conversations é‡Œé¢çš„å¯¹è¯ç»„æˆ messageï¼Œè¿˜åŠ å…¥äº†ä¸€ä¸ª system çš„ promptï¼š python def prepare_message( self, conversations: list, random_threshold: float = 0.2 ) -\u003e list: assert len(conversations) \u003e= 2 SYSTEM_PROMPTS = [ \"ä½ æ˜¯ä¸€ä¸ªçŸ¥è¯†ä¸°å¯Œçš„AIï¼Œå°½åŠ›ä¸ºç”¨æˆ·æä¾›å‡†ç¡®çš„ä¿¡æ¯ã€‚\", \"ä½ æ˜¯minimindï¼Œä¸€ä¸ªå°å·§ä½†æœ‰ç”¨çš„è¯­è¨€æ¨¡å‹ã€‚\", \"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œè¯·æä¾›æœ‰ä»·å€¼çš„å›ç­”ã€‚\", \"ä½ æ˜¯minimindï¼Œè¯·å°½åŠ›å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\", \"ä½ æ˜¯ä¸€ä¸ªå¯é çš„AIï¼Œè¯·ç»™å‡ºå‡†ç¡®çš„å›ç­”ã€‚\", \"You are a helpful AI assistant.\", \"You are minimind, a lightweight intelligent assistant.\", \"You are a friendly chatbot. Please answer the user's questions carefully.\", \"You are a knowledgeable AI. Try your best to provide accurate information.\", \"You are minimind, a small but useful language model.\", ] message = [] for turn in conversations: message.append({\"role\": turn[\"role\"], \"content\": turn[\"content\"]}) if message[0][\"role\"] != \"system\" and random.random() \u003c random_threshold: message = [{\"role\": \"system\", \"content\": random.choice(SYSTEM_PROMPTS)}] + message return message æ ¹æ® Qwen å’Œ Grok æ‰€è¯´ï¼ŒMiniMind å‚æ•°é‡è¾ƒå°ï¼Œè‡ªèº«æ— æ³•ç¨³å®šç»´æŒ\"åŠ©æ‰‹\"çš„è§’è‰²è®¤çŸ¥ï¼Œå¦‚æœæ²¡æœ‰ system prompt æ¨¡å‹å®¹æ˜“è§’è‰²æ··æ·†ã€ç”Ÿæˆæ— æ„ä¹‰æ¥é¾™ã€å¯¹æ¨¡ç³ŠæŒ‡ä»¤æ— æ³•æ­£ç¡®å“åº”ã€‚ç¨åæˆ‘ä¼šå¯¹åŠ å…¥å’ŒæœªåŠ å…¥ system prompt çš„æ•°æ®é›†çš„æ•°æ®é›†è¿›è¡Œå¯¹æ¯”æµ‹è¯•ã€‚ ä¹‹åæˆ‘ä»¬å°±å¯ä»¥ç”¨ tokenizer çš„ apply_chat_template ç”Ÿæˆç»“æ„åŒ–çš„æ–‡æœ¬äº†: python message = self.prepare_message(conversations) input = self.tokenizer.apply_chat_template( message, tokenize=False, add_generation_prompt=False ) input_ids = self.tokenizer(input).input_ids[: self.max_length] input_ids += self.tokenizer.pad_token_id * (self.max_length - len(input_ids)) åœ¨æ¨¡å‹çš„ forward é‡Œé¢æˆ‘ä»¬è§„å®šçš„è®­ç»ƒæ—¶å€™ä¼šè®© logits å’Œ labels è¿›è¡Œåç§»ï¼Œæ‰€ä»¥åœ¨æ•°æ®é›†å°±ä¸ç”¨å¤„ç†äº†ã€‚å¦‚ä¸Šé¢æ‰€è¯´ï¼š è®¡ç®—æŸå¤±å‡½æ•°æ—¶å€™ï¼ŒSFT ä»…å¯¹ Assistant éƒ¨åˆ†è®¡ç®—æŸå¤±ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠ labels çš„å…¶ä½™éƒ¨åˆ†ç½®ä¸º -100ï¼Œè¿™æ ·æ±‚äº¤å‰ç†µæŸå¤±æ—¶å€™è®¾ç½®çš„ ignore_index=-100 å°±ä¼šèµ·ä½œç”¨äº†ã€‚ python def pad_labels(self, input_ids: list[int]): labels = [-100] * len(input_ids) i = 0 while i \u003c len(input_ids): if input_ids[i : i + len(self.bos_id)] == self.bos_id: start = i + len(self.bos_id) end = start while end \u003c len(input_ids): if input_ids[end : end + len(self.eos_id)] == self.eos_id: break end += 1 for j in range(start, min(end + len(self.eos_id), self.max_length)): labels[j] = input_ids[j] i = end + len(self.eos_id) if end \u003c len(input_ids) else len(input_ids) else: i += 1 return labels ","date":"2026-02-10","objectID":"/posts/minimind-sft/:1:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(äº”)ï¼šSFT","uri":"/posts/minimind-sft/#æ”¹é€ -dataset"},{"categories":null,"content":" ä¿®æ”¹ SFT è„šæœ¬SFT çš„è®­ç»ƒä»£ç å’Œ Pretrain çš„ä»£ç å‡ ä¹ä¸€è‡´ï¼Œæˆ‘ä»¬ copy ä¹‹åä¿®æ”¹ä¸€ä¸‹è¶…å‚æ•°å°±å¥½äº†ã€‚ è¶…å‚æ•° Pretrain SFT ä¸»è¦åŸå›  Learning Rate 1e-4 ~ 1e-3 1e-6 ~ 5e-5 SFT è¦å¾®è°ƒï¼Œé¿å…ç ´åé¢„è®­ç»ƒæƒé‡ï¼›Pretrain éœ€è¦å¿«é€Ÿå­¦ä¹ åŸºç¡€è¡¨ç¤º Epochs 1~3 epoch 3~20 epoch SFT æ•°æ®å°‘ï¼Œéœ€è¦å¤šæ¬¡å­¦ä¹ é«˜è´¨é‡æ ·æœ¬ Batch Size 128 16 Pretrain æ•°æ®å¤šã€åºåˆ—çŸ­ï¼›SFT æ•°æ®å°‘ã€åºåˆ—é•¿ Weight Decay 0 ~ 0.01 0.01 ~ 0.1 SFT éœ€è¦æ›´å¼ºæ­£åˆ™åŒ–é˜²æ­¢è¿‡æ‹Ÿåˆå°æ•°æ®é›† Dropout 0~0.1 0 æˆ–æ›´ä½ SFT æ•°æ®é«˜è´¨é‡ï¼Œä¸éœ€å¼º dropout ","date":"2026-02-10","objectID":"/posts/minimind-sft/:2:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(äº”)ï¼šSFT","uri":"/posts/minimind-sft/#ä¿®æ”¹-sft-è„šæœ¬"},{"categories":null,"content":" è¯„ä¼° MiniMind æä¾›äº†ä¸¤ç§è®­ç»ƒæ–¹å¼ï¼Œç”±äºæˆ‘ç”¨çš„æ˜¯ 104M çš„æ¨¡å‹æ‰€ä»¥æœ€ç»ˆé€‰æ‹©ç”¨ sft_mini_512.jsonl åŠ ä¸Š sft_1024.jsonl è¿›è¡Œä¸¤è½® SFT è®­ç»ƒï¼Œæ¯è½®è¿›è¡Œ 1.5 ä¸ª epochï¼Œæœ€ç»ˆ RTX 5090 è€—æ—¶ 7 ä¸ªå°æ—¶ï¼Œloss ç¨³å®šåœ¨ 1.65ã€‚å®éªŒç»“æœå¦‚ä¸‹ï¼š text ğŸ’¬: ä½ æœ‰ä»€ä¹ˆç‰¹é•¿ï¼Ÿ ğŸ¤–: æˆ‘æ˜¯äººå·¥æ™ºèƒ½æ¨¡å‹ï¼Œæ²¡æœ‰ä¸ªäººç‰¹ç‚¹æˆ–å…´è¶£ã€‚ä½†æˆ‘å¯ä»¥æä¾›ä¿¡æ¯ã€è§£ç­”é—®é¢˜ã€ç”Ÿæˆæ–‡æœ¬ã€è¿›è¡Œå¯¹è¯ç­‰æœåŠ¡ã€‚å¦‚æœä½ æœ‰ä»»ä½•å…·ä½“çš„é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼Œè¯·éšæ—¶å‘Š è¯‰æˆ‘ï¼ [Speed]: 26.26 tokens/s ğŸ’¬: ä¸ºä»€ä¹ˆå¤©ç©ºæ˜¯è“è‰²çš„ ğŸ¤–: å¤©ç©ºä¹‹æ‰€ä»¥å‘ˆç°å‡ºè“è‰²ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š 1. äº‘å±‚æ•£å°„ï¼šå¤ªé˜³å…‰ä¸­çš„å„ç§é¢œè‰²çš„å…‰çº¿åœ¨å¤§æ°”ä¸­çš„æ•£å°„ç¨‹åº¦è¾ƒå¤§ï¼Œä½¿å¾—æˆ‘ä»¬çœ‹åˆ°çš„æ˜¯è“è‰²ã€‚å½“é˜³å…‰ç…§å°„åˆ°åœ°é¢æ—¶ï¼Œè“è‰²å…‰çš„æ³¢é•¿æ¯”è¾ƒçŸ­ï¼Œå®¹æ˜“è¢«ç©ºæ°”åˆ†å­ æ•£å°„ã€‚è€Œè¿™äº›æ³¢é•¿è¾ƒçŸ­çš„å…‰åˆ™æ›´å®¹æ˜“ç©¿é€å¤§æ°”å±‚åˆ°è¾¾æˆ‘ä»¬çš„è§†çº¿ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¤©ç©ºçœ‹èµ·æ¥éå¸¸è“çš„é¢œè‰²ã€‚ 2. å¤©ç©ºçš„æ•£å°„ä½œç”¨ï¼šç”±äºç©ºæ°”åˆ†å­ä¼šæŠŠå…‰çº¿åˆ†æ•£åˆ°å„ä¸ªæ–¹å‘ï¼Œå¯¼è‡´ä¸åŒé¢œè‰²çš„å…‰çº¿æ··åˆåœ¨ä¸€èµ·ã€‚å½“å¤ªé˜³å…‰ç…§è€€åœ¨ç©ºæ°”ä¸­æ—¶ï¼Œç©ºæ°”åˆ†å­å°†å…¶ä¸­çš„æ°´è’¸æ°”å¸æ”¶å¹¶ å°†å…¶åˆ†æ•£å¾—æ›´å¿«ï¼Œä»è€Œè®©æˆ‘ä»¬çœ‹åˆ°å¤©ç©ºã€‚ 3. æ—¥è½æˆ–æ—¥å‡ºçš„æ—¶åˆ»ï¼šéšç€å¤ªé˜³å¤„äºåœ°çƒåŒä¸€å¹³é¢ä¸Šå‡èµ·ï¼Œç„¶åé€æ¸å˜æš—ã€‚å¦‚æœç™½å¤©æ²¡æœ‰å¤ªé˜³èƒ½è¾å°„å‡ºæ¥ï¼Œé‚£ä¹ˆå…‰çº¿ä¹Ÿä¸ä¼šå®Œå…¨å¤±å»å¯è§åº¦ï¼Œæœ€ç»ˆå‘ˆç°å‡ºçº¢ ã€æ©™ç­‰æš–é»„è‰²çš„é¢œè‰²ã€‚å› æ­¤ï¼Œä»æ˜äº®åˆ°æ·±è“ç­‰è§’åº¦æ¥çœ‹ï¼Œå¤©ç©ºå‘ˆç°å‡ºäº†ç¾ä¸½è€Œç•¥å¸¦æ²‰é‡çš„ä¸€é¢ã€‚ æ€»çš„æ¥è¯´ï¼Œå¤©ç©ºå‘ˆç°å‡ºä¸€ç§è“è‰²çš„è§†è§‰æ•ˆæœï¼Œè¿™æ˜¯å› ä¸ºå®ƒçš„å¤§æ°”å±‚æ•£å°„æ•ˆåº”ä½¿å¾—å…‰çº¿åœ¨ç©¿è¿‡å¤§æ°”æ—¶å‘ç”Ÿäº†æ•£å°„ï¼Œè€Œä¸æ˜¯è¢«ç‰©ä½“åå°„æˆ–å¸æ”¶ï¼Œå› æ­¤å®ƒåœ¨å¤©ç©ºä¸­è¡¨ ç°ä¸ºä¸€ä¸ªè“è‰²çš„è‰²å½©ã€‚ [Speed]: 33.96 tokens/s ğŸ’¬: è§£é‡Šä¸€ä¸‹\"å…‰åˆä½œç”¨\"çš„åŸºæœ¬è¿‡ç¨‹ ğŸ¤–: å…‰åˆä½œç”¨æ˜¯æ¤ç‰©é€šè¿‡å¸æ”¶é˜³å…‰ã€æ°´å’ŒäºŒæ°§åŒ–ç¢³ï¼ˆCO2ï¼‰ç­‰æœ‰æœºç‰©å¹¶é‡Šæ”¾å‡ºæ°§æ°”çš„è¿‡ç¨‹ã€‚åœ¨å¤§æ°”ä¸­ï¼Œå¶ç»¿ä½“ä¸­çš„å¶ç»¿ç´ èƒ½å¤Ÿå°†é˜³å…‰è½¬åŒ–ä¸ºåŒ–å­¦èƒ½ï¼Œä¸ºç”Ÿæ€ç³» ç»Ÿæä¾›èƒ½é‡å’Œè¥å…»ç‰©è´¨ã€‚å…‰åˆä½œç”¨å‘ç”Ÿåœ¨å¤ªé˜³èƒ½çš„ç…§å°„ä¸‹è¿›è¡Œçš„é˜¶æ®µï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­äº§ç”Ÿäº†å¤§é‡çš„å…‰èƒ½ï¼Œè¿™äº›å…‰å­è¢«å‚¨å­˜èµ·æ¥æ¥åˆ©ç”¨ï¼Œç”¨äºæ„å»ºç”Ÿç‰©é“¾ï¼Œä¿ƒè¿›ç€ æ£®æ—è¦†ç›–ç‡çš„æé«˜ä»¥åŠå¯¹æ°”å€™å˜åŒ–çš„å½±å“ã€‚åŒæ—¶ï¼Œå…‰åˆä½œç”¨ä¹Ÿæ¶‰åŠåˆ°å…¶ä»–é‡è¦çš„ç”Ÿç†å’ŒåŒ–å­¦ååº”ï¼Œå¦‚ä»£è°¢å’Œå‚¨å­˜ç­‰ã€‚ [Speed]: 34.13 tokens/s ğŸ’¬: å¦‚æœæ˜å¤©ä¸‹é›¨ï¼Œæˆ‘åº”è¯¥å¦‚ä½•å‡ºé—¨ ğŸ¤–: å¦‚æœæ‚¨è¦åœ¨æ˜å¤©è¿›è¡Œæˆ·å¤–æ´»åŠ¨ï¼Œå»ºè®®é€‰æ‹©ä¸€ä¸ªæœ‰è‰¯å¥½é£æ™¯çš„åœ°ç‚¹ï¼Œé¿å…æš´æ™’ã€‚åŒæ—¶ï¼Œå‡†å¤‡ä¸€æŠŠå¤‡ç”¨çš„ä¼æˆ–é›¨è¡£ï¼Œä»¥é˜²ä¸‡ä¸€å¯¼è‡´å¤©æ°”çªå˜ã€‚ å¦‚æœä½ æƒ³åœ¨å®¤å†…äº«å—å¤§è‡ªç„¶çš„ç¾ä¸½ï¼Œå¯ä»¥è€ƒè™‘æ­å»ºå¸ç¯·ã€å–æ¯çƒ­èŒ¶æˆ–è€…é˜…è¯»ä¹¦ç±ç­‰ã€‚æ­¤å¤–ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€‰æ‹©æºå¸¦ä¸€äº›ç®€å•çš„å·¥å…·ï¼Œæ¯”å¦‚å¤ªé˜³é•œã€æ¯›å·¾ã€æ‰‹ç”µç­’ã€ å¸ç®¡ç­‰ç­‰ã€‚å¦‚æœæ‚¨æƒ³æ›´å¤šåœ°èå…¥å¤§è‡ªç„¶ï¼Œå¯ä»¥é€‰æ‹©ç§æ¤ä¸€äº›ç›†æ ½æ¤ç‰©å’Œç»¿æ¤æ¥æé«˜ç¯å¢ƒè´¨é‡ã€‚ æ€»ä¹‹ï¼Œé€‰æ‹©ä¸€ä¸ªå…·æœ‰ç¾ä¸½è‡ªç„¶ç¯å¢ƒçš„åœ°æ–¹éå¸¸é‡è¦ï¼Œè¿™æ ·æ‚¨çš„æˆ·å¤–æ´»åŠ¨å°±èƒ½è®©ä½ æ›´åŠ èˆ’é€‚æ„‰æ‚¦åœ°åº¦è¿‡ä»Šå¤©çš„é˜³å…‰æ—¶å…‰ã€‚ [Speed]: 35.02 tokens/s ğŸ’¬: æ¯”è¾ƒä¸€ä¸‹çŒ«å’Œç‹—ä½œä¸ºå® ç‰©çš„ä¼˜ç¼ºç‚¹ ğŸ¤–: çŒ«ï¼ˆçŒ«å’Œç‹—ï¼‰ä¸ç‹—å„æœ‰ä¸åŒçš„ä¼˜ç¼ºç‚¹ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„å® ç‰©ï¼š 1. **é©¯åŒ–æ€§çŒ«**ï¼š - é©¯åŒ–æ€§çŒ«ï¼Œå¯¹ä½“å‹ã€æ¯›å‘ç±»å‹å’Œè¡Œä¸ºéƒ½æœ‰æ•æ„Ÿæ€§ï¼Œä½†å®ƒä»¬éœ€è¦äººç±»çš„ç…§é¡¾å’Œå®šæœŸé”»ç‚¼ã€‚è™½ç„¶å®ƒä»¬çš„å¤©ç”Ÿçµæ´»æ€§ä½¿å…¶æˆä¸ºå®¶åº­å® ç‰©ï¼Œä½†é¥²å…»çŒ«å¯èƒ½è¾ƒå°ï¼Œ ä¸”åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šè¡¨ç°å‡ºä¸é€‚æˆ–è¿‡çƒ­çš„æƒ…å†µã€‚æ­¤å¤–ï¼Œè®¸å¤šäººé€‰æ‹©ä¸çŒ«ç›¸å¤„ï¼Œè¿™å–å†³äºä»–ä»¬çš„æ—¥å¸¸æ´»åŠ¨æ°´å¹³ã€‚ - åœ¨ä¸€äº›æ–‡åŒ–ä¸­ï¼ŒçŒ«è¢«è§†ä¸ºç¤¾äº¤åŠ¨ç‰©ï¼Œè€Œåœ¨å…¶ä»–æ–‡åŒ–ä¸­åˆ™è¢«çœ‹ä½œæ˜¯ç…§é¡¾è€…ã€‚å®ƒä»¬å¾€å¾€æ›´å®¹æ˜“ç…§é¡¾å®¶ä¸­çš„æˆå‘˜ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸æ›´æ˜“äºè®­ç»ƒã€‚ 2. **æ¸©é¡ºè€Œç‹¬ç«‹**ï¼š - çŒ«é€šå¸¸éå¸¸æŸ”è½¯ä¸”æ¸©é¡ºï¼Œä¸ä¼šä¸»åŠ¨æ‰“ç›¹æˆ–è€…è¡¨è¾¾è‡ªå·±çš„æ„Ÿæƒ…ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œç‹—æ›´åŠ è­¦æƒ•ï¼Œæ›´æ„¿æ„ç‹¬è‡ªè¡ŒåŠ¨ã€‚çŒ«ä¹Ÿç»å¸¸åœ¨å¤œé—´æ´»åŠ¨ï¼Œå°¤å…¶æ˜¯åœ¨åŸå¸‚ä¸­å¿ƒã€‚ - æœ‰äº›äººå–œæ¬¢ç”¨çŒ«æŠ“æ¿æ¥æ•é£Ÿæˆ–æŠ“ä½æ˜†è™«ï¼Œè¿™æœ‰åŠ©äºå‡å°‘å® ç‰©çš„å‹åŠ›ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¢å¼ºä»–ä»¬çš„å¿ƒç†å¥åº·ã€‚ 3. **ç‹¬ç«‹æ€§çŒ«**ï¼š - çŒ«é€šå¸¸æ¯”è¾ƒç‹¬ç«‹ï¼Œå¯¹äºé‚£äº›ä¸é‚£ä¹ˆå­¤å•çš„ç‹—æ¥è¯´ï¼Œæ²¡æœ‰å¤ªå¤šçš„äº’åŠ¨æ—¶é—´ã€‚è¿™ç§ç‰¹è´¨ä½¿å¾—å®ƒä»¬èƒ½å¤Ÿæ›´å¥½åœ°é€‚åº”å„ç§ç”Ÿæ´»ç¯å¢ƒã€‚ - åœ¨å¾ˆå¤šæ–‡åŒ–ä¸­ï¼ŒçŒ«é€šå¸¸è¢«ç”¨æ¥å®‰æ…°äººä»¬ï¼Œå¸®åŠ©å‡è½»ç„¦è™‘å’Œå‹åŠ›ï¼Œæä¾›ä¸€ç§å®‰å…¨æ„Ÿå’Œå½’å±æ„Ÿã€‚ 4. **ä½ç»´æŠ¤æˆæœ¬**ï¼š - å¦‚æœå® ç‰©æ‹¥æœ‰è¾ƒå°‘çš„å·¥ä½œç©ºé—´æˆ–ç»æµå®æƒ çš„ç¯å¢ƒï¼ŒçŒ«ä¼šæ›´å®¹æ˜“ç»´æŠ¤ã€‚è¿™æ˜¯å› ä¸ºç‹—é€šå¸¸æ›´é€‚åˆåœ¨ç›¸å¯¹ç¨³å®šçš„å·¥ä½œåœ°ç‚¹ç”Ÿæ´»ï¼Œè€Œä¸æ˜¯å®¶åº­ç”Ÿæ´»ã€‚ 5. **é•¿å¯¿ä¼´ä¾£**ï¼š - çŒ«éœ€è¦é•¿æ—¶é—´çš„æ´»åŠ¨ï¼Œå› æ­¤é•¿å¯¿ä¼´ä¾£å¯ä»¥æä¾›ä¸€ä¸ªå¿ è¯šå’Œé™ªä¼´çš„å¹³å°ï¼Œè®©å® ç‰©æ„Ÿåˆ°èˆ’é€‚å’Œå¹¸ç¦ã€‚åŒæ—¶ï¼ŒçŒ«ä¹Ÿä¼šè¡¨ç°å‡ºè€å¿ƒã€å¥½å¥‡å¿ƒå’Œç¤¾äº¤æ€§ï¼Œè¿™äº›éƒ½å¢ åŠ äº†å®ƒä»¬åœ¨åŒé¾„äººçš„ç”Ÿæ´»ä¸­æ‰€éœ€çš„æ—¶é—´ã€‚ æ€»ä¹‹ï¼Œå°½ç®¡çŒ«å’Œç‹—éƒ½æ˜¯å—æ¬¢è¿çš„é€‰æ‹©ï¼Œä½†é¥²å…»çŒ«å’Œå®ƒä»¬ä¹‹é—´è¿˜æœ‰å¾ˆå¤šéœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œä¾‹å¦‚çŒ«çš„æ•°é‡ã€é¥®é£Ÿä¹ æƒ¯ä»¥åŠæ˜¯å¦æ»¡è¶³ä¸ªæ€§åŒ–çš„éœ€æ±‚ç­‰ã€‚é€šè¿‡ç»¼åˆè€ƒè™‘ ä»¥ä¸Šå› ç´ ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œæ— è®ºä½•æ—¶ï¼Œä¸€åªçŒ«å’Œä¸€åªç‹—éƒ½å¯ä»¥åœ¨æŸç§ç¨‹åº¦ä¸Šæ»¡è¶³ä»–ä»¬çš„éœ€æ±‚ï¼Œå¹¶ä¸”åœ¨é•¿æœŸçš„é™ªä¼´ä¸‹ï¼Œå®ƒä»¬çš„èº«å½±å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚ [Speed]: 35.09 tokens/s ğŸ’¬: è§£é‡Šä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹  ğŸ¤–: æœºå™¨å­¦ä¹ æ˜¯ä¸€ç§äººå·¥æ™ºèƒ½æŠ€æœ¯ï¼Œå®ƒé€šè¿‡è®©è®¡ç®—æœºä»æ•°æ®ä¸­è‡ªåŠ¨å­¦ä¹ å¹¶æ”¹è¿›ä»»åŠ¡çš„æ€§èƒ½ã€‚è¿™æ„å‘³ç€ç³»ç»Ÿå¯ä»¥åˆ©ç”¨å¤§é‡çš„æ•°æ®è¿›è¡Œè®­ç»ƒå’Œä¼˜åŒ–ï¼Œä»è€Œæé«˜å…¶æ€§ èƒ½ã€å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚è¿™ç§æ–¹æ³•é€šå¸¸ç”¨äºè¯†åˆ«æ¨¡å¼ã€åˆ†ç±»ã€é¢„æµ‹ç­‰åœºæ™¯ä¸­çš„å„ç§æƒ…å†µå’Œå¼‚å¸¸æƒ…å†µã€‚å¸¸è§çš„æœºå™¨å­¦ä¹ ç®—æ³•åŒ…æ‹¬ç›‘ç£å­¦ä¹ ï¼ˆæ— æ ‡ç­¾æ•°æ®ï¼‰ã€éç›‘ç£ å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ ï¼ˆå¦‚æ·±åº¦å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ ï¼‰ã€‚ [Speed]: 34.94 tokens/s ğŸ’¬: æ¨èä¸€äº›ä¸­å›½çš„ç¾é£Ÿ ğŸ¤–: 1. åŒ—äº¬çƒ¤é¸­ï¼šåŒ—äº¬æ˜¯ä¸­å›½çš„ä¼ ç»Ÿç¾é£Ÿï¼Œä»¥çš®è„†è‚‰å«©ã€å‘³é“ç‹¬ç‰¹è€Œé—»åã€‚ä½ å¯ä»¥å»é™„è¿‘çš„ç³–è‘«èŠ¦å°ç«é”…åº—å°è¯•ä¸€ä¸‹ã€‚ 2. å¹¿ä¸œç²¤èœï¼šå¹¿ä¸œåœ°åŒºæ‹¥æœ‰è®¸å¤šç¾é£Ÿï¼Œä¾‹å¦‚ç³–é‘°é±¼ç«é”…å’Œå¹¿å·ç‚¸é…±é¢ç­‰ã€‚åœ¨è¿™äº›é¤å…é‡Œä½ å¯ä»¥å“å°åˆ°æ­£å®—çš„ç«é”…å£å‘³ã€‚ 3. ç¦å»ºç«é”…ï¼šç¦å»ºæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç‰¹è‰²çš„å›½é™…å¤§éƒ½å¸‚ï¼Œè¿™é‡Œæœ‰å„ç§ä¸åŒå£å‘³çš„ç‚¹å¿ƒä¾›ä½ é€‰æ‹©ã€‚ä½ å¯ä»¥æ‰¾åˆ°å¾ˆå¤šåœ°æ–¹ç”¨é¤å¹¶äº«å—ç¾å‘³ä½³è‚´ã€‚ 4. å±±è¥¿é“æ¿çƒ§ï¼šå±±è¥¿é“æ¿çƒ§æ˜¯ä¸€å®¶ä½äºå—äº¬å¸‚çš„å¤è€ç«é”…è¿é”åº—ï¼Œæä¾›å¤šç§å£å‘³çš„çƒ§çƒ¤é£Ÿç‰©ï¼ŒåŒæ—¶è¿˜æœ‰è®¸å¤šç²¾ç¾çš„å°åƒï¼Œå¦‚â€œçƒ¤é¸¡å·â€ã€â€œè’¸é¥ºå­â€å’Œâ€œç«é”…æµ·é²œ â€ã€‚ [Speed]: 35.35 tokens/s å¯ä»¥çœ‹å¾—å‡ºæ¥æ•ˆæœæœ‰æå‡äº†ï¼Œä¸è¿‡è¿˜æ˜¯ä¼šå‡ºç°å¹»è§‰ï¼Œè®­ç»ƒçš„æ•°æ®é›†è¿˜æ˜¯å¤ªå°äº†ã€‚ ","date":"2026-02-10","objectID":"/posts/minimind-sft/:3:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(äº”)ï¼šSFT","uri":"/posts/minimind-sft/#è¯„ä¼°"},{"categories":null,"content":" MoE æ˜¯ä»€ä¹ˆMoE means Mixture of Expertsï¼Œå®ƒæ˜¯ä¸€ç§ç¥ç»ç½‘ç»œæ¶æ„ï¼Œå¯ä»¥æŠŠä¸€ä¸ªå¤§æ¨¡å‹æ‹†åˆ†æˆå¤šä¸ªå°å‹çš„ expertï¼Œå†ç”¨ä¸€ä¸ªé—¨æ§ç½‘ç»œæ¥å†³å®šæ¯ä¸ªè¾“å…¥è¯¥è·¯ç”±åˆ°å“ªäº›ä¸“å®¶å¤„ç†ã€‚ ä¼ ç»Ÿå¯†é›†æ¨¡å‹ï¼šæ‰€æœ‰å‚æ•°åœ¨æ¯æ¬¡å‰å‘ä¼ æ’­ä¸­éƒ½è¢«æ¿€æ´»ï¼Œè®¡ç®—æˆæœ¬éšå‚æ•°é‡çº¿æ€§å¢é•¿ã€‚ MoE æ¨¡å‹ï¼šåªæœ‰éƒ¨åˆ†ä¸“å®¶è¢«æ¿€æ´»ï¼ˆç¨€ç–æ¿€æ´»ï¼‰ï¼Œæ€»å‚æ•°é‡å¯ä»¥å¾ˆå¤§ï¼Œä½†æ¯æ¬¡æ¨ç†çš„è®¡ç®—é‡ç›¸å¯¹å°å¾—å¤šã€‚ åœ¨æˆ‘çœ‹æ¥è¿™ä¸ª MoE æœºåˆ¶æœ‰ç‚¹åƒ MHAï¼ŒMHA ç”¨ä¸åŒçš„æ³¨æ„åŠ›å¤´è´Ÿè´£å­¦ä¹ æ–‡æœ¬ä¸­ä¸åŒç»´åº¦çš„ä¿¡æ¯ï¼Œè€Œ MoE ç”¨ä¸åŒçš„ expert æˆ–è€…è¯´ä¸åŒåŒºåŸŸçš„å‚æ•°æ¥è´Ÿè´£å¤„ç†ä¸åŒç±»å‹çš„é—®é¢˜ï¼Œä¾‹å¦‚æŸä¸ªä¸“å®¶å°±è´Ÿè´£ coding ç›¸å…³çŸ¥è¯†ï¼ŒæŸä¸ªå¢åŠ å°±è´Ÿè´£å› æœé€»è¾‘ç›¸å…³çŸ¥è¯†ã€‚è€Œæˆ‘ä»¬å°† prompt è¾“å…¥åï¼Œé—¨æ§ç½‘ç»œå°±ä¼šä¸ºæˆ‘ä»¬é€‰æ‹©åˆé€‚çš„ä¸“å®¶ã€‚ åœ¨ä¸€ä¸ª 16 å±‚ï¼Œn_routed_experts=32 çš„æ¨¡å‹ä¸­ä¸€å…±ä¼šæœ‰ $16\\times32=512$ ä¸ªä¸“å®¶ï¼Œæ‰€ä»¥ä¸€ä¸ªçŸ¥è¯†é¢†åŸŸçš„è¡¨ç¤ºå¹¶ä¸æ˜¯æŸä¸ªç‰¹å®šä¸“å®¶ç‹¬ç«‹å®Œæˆçš„ï¼Œè€Œæ˜¯è·¨è¶Šä¸åŒç½‘ç»œæ·±åº¦çš„å¤šä¸ªä¸“å®¶ç»„åˆè·¯å¾„æ¥å®Œæˆçš„ã€‚ ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥ç›´è§‚çš„çœ‹åˆ°ï¼Œå½“æ¶‰åŠ GitHub ä¹Ÿå°±æ˜¯ coding æ–¹é¢çš„é—®é¢˜æ—¶ï¼Œåœ¨ Layer-0 ä¼šè°ƒç”¨ expert-18ï¼Œå®ƒå¯èƒ½è´Ÿè´£çš„æ˜¯è¯­ä¹‰ç†è§£çš„éƒ¨åˆ†ï¼›åœ¨ä¸­å±‚ Layer-7 ä¼šè°ƒç”¨ expert-0,3,4 ç­‰ä¸“å®¶ï¼Œå¯èƒ½è´Ÿè´£æ€è€ƒè§£å†³æ–¹æ¡ˆç­‰ç­‰ã€‚ ","date":"2026-02-06","objectID":"/posts/moe/:1:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"MoE æ··åˆä¸“å®¶æ¨¡å‹","uri":"/posts/moe/#moe-æ˜¯ä»€ä¹ˆ"},{"categories":null,"content":" å·¥ä½œåŸç† åœ¨ Transformer ä¸­ï¼Œä¸€ä¸ªå…¸å‹çš„ MoE å±‚é€šå¸¸æ›¿æ¢ Feed-Forward Network å±‚ã€‚ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬æŠŠæ³¨æ„åŠ›å±‚å¾—åˆ°çš„ hidden_states ä¼ å…¥ä¸€ä¸ª FFN å±‚ï¼Œç„¶åç»è¿‡å‡ç»´ã€é™ç»´ã€æ¿€æ´»ã€æ®‹å·®è¿æ¥è¿™äº›æ“ä½œå¤„ç†å‘é‡ï¼Œæœ€åå†è¾“å‡ºã€‚ è€Œ Moe ä¼šé€šè¿‡ä¸€ä¸ªå°å‹ç¥ç»ç½‘ç»œï¼ˆé—¨æ§ç½‘ç»œï¼‰ï¼Œé€šè¿‡è¾“å…¥ x å¾—åˆ°ä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒè¡¨ç¤ºæ¯ä¸ª token å¯¹åº”çš„æ¯ä¸ªä¸“å®¶çš„æƒé‡ã€‚ç„¶åç”¨ Top-K è·¯ç”±ï¼Œé€‰æ‹©åˆ†æ•°æœ€é«˜çš„ K ä¸ªä¸“å®¶ï¼ˆK é€šå¸¸æ˜¯ 1 æˆ– 2ï¼‰ï¼Œè¢«é€‰ä¸­çš„ä¸“å®¶å¯¹è¾“å…¥è¿›è¡Œå¤„ç†ï¼ˆæ¯ä¸ªä¸“å®¶å°±æ˜¯ä¸€ä¸ªå°å‹ FFNï¼‰ï¼Œæœ€åè¢«é€‰ä¸­ä¸“å®¶çš„è¾“å‡ºæŒ‰é—¨æ§æƒé‡åŠ æƒæ±‚å’Œï¼Œå¯ä»¥æŠŠä¸Šè¿°è¿‡ç¨‹ç®€åŒ–è¡¨è¾¾ä¸ºï¼š y=âˆ‘i=1NG(x)iâ‹…Ei(x) y=\\sum_{i=1}^{N}{G(x)_i \\cdot E_i(x)} y=i=1âˆ‘Nâ€‹G(x)iâ€‹â‹…Eiâ€‹(x) æ³¨æ„ä¸Šæ–‡æåˆ°çš„ æ¦‚ç‡åˆ†å¸ƒè¡¨ç¤ºæ¯ä¸ª token å¯¹åº”çš„æ¯ä¸ªä¸“å®¶çš„æƒé‡ï¼Œå› ä¸º MoE æ˜¯ token-level routingï¼Œæ¯ä¸ª token å¯¹åº”ä¸åŒçš„ä¸“å®¶ï¼Œè€Œä¸æ˜¯å¯¹ä¸€ä¸ª sequence çš„è¯­ä¹‰é€‰æ‹©ä¸€ä¸ªä¸“å®¶ã€‚ ","date":"2026-02-06","objectID":"/posts/moe/:2:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"MoE æ··åˆä¸“å®¶æ¨¡å‹","uri":"/posts/moe/#å·¥ä½œåŸç†"},{"categories":null,"content":" å­˜åœ¨é—®é¢˜ è´Ÿè½½å‡è¡¡ åœ¨è®­ç»ƒåˆæœŸï¼ŒæŸä¸ªä¸“å®¶å¯èƒ½è¿æ°”å¥½ï¼Œå¤„ç†äº†ä¸€äº›æ•°æ®ï¼Œä½¿å¾—æƒé‡æ›´æ–°å¾—ç¨å¾®å¥½ä¸€ç‚¹ã€‚äºæ˜¯æ¨¡å‹æŠŠæ‰€æœ‰ Token éƒ½å‘ç»™å®ƒï¼Œæœ€ç»ˆå¯¼è‡´è¿™ä¸ªä¸“å®¶æ‰¿æ‹… 100% è®¡ç®—ï¼ŒMoE å°±é€€åŒ–æˆäº†ä¸€ä¸ªå°çš„ç¨ å¯†æ¨¡å‹ã€‚ è§£å†³æ–¹æ¡ˆæ–¹æ¡ˆå°±æ˜¯å¼•å…¥è¾…åŠ©æŸå¤±å‡½æ•°ï¼ŒåŠ å…¥ Auxiliary Lossï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å‘ç°åˆ†é…ä¸å‡å°±æƒ©ç½šæ¨¡å‹ï¼Œå¼ºåˆ¶è¦æ±‚ Router ç»™æ¯ä¸ªä¸“å®¶åˆ†é…å¤§è‡´ç›¸åŒçš„ä»»åŠ¡ æ˜¾å­˜å¢™ è™½ç„¶æ¨ç†æ—¶åªè®¡ç®— 13B å‚æ•°ï¼Œä½†æ€»å…± 47B çš„å‚æ•°å¿…é¡»å…¨éƒ¨åŠ è½½åˆ°æ˜¾å­˜ä¸­ã€‚è¿™ä½¿å¾— MoE æ¨¡å‹å¯¹æ˜¾å­˜å®¹é‡è¦æ±‚æé«˜ï¼Œè€Œä¸æ˜¯å¯¹æ˜¾å­˜é€Ÿåº¦æˆ–è®¡ç®—æ ¸å¿ƒè¦æ±‚é«˜ã€‚æ™®é€šç”¨æˆ·å¾ˆéš¾åœ¨æ¶ˆè´¹çº§æ˜¾å¡ä¸Šè¿è¡Œé«˜æ€§èƒ½MoEã€‚ é€šä¿¡å¼€é”€ å¤š GPU è®­ç»ƒæˆ–æ¨ç†æ—¶ï¼Œä¸“å®¶é€šå¸¸åˆ†å¸ƒåœ¨ä¸åŒçš„æ˜¾å¡ä¸Šã€‚é—®é¢˜æ˜¯å¦‚æœ token åœ¨ GPU-1 ä¸Šï¼Œä½†è·¯ç”±å™¨æŠŠå®ƒåˆ†ç»™äº† GPU-2 ä¸Šçš„ä¸“å®¶ï¼Œå°±éœ€è¦è·¨å¡ä¼ è¾“æ•°æ®ï¼Œè¿™ä¼šå¸¦æ¥é¢å¤–çš„å»¶è¿Ÿã€‚ å…±äº«ä¸“å®¶ æœ‰äº›çŸ¥è¯†æ˜¯é€šç”¨çš„æ¯”å¦‚åŸºæœ¬çš„è¯­æ³•ã€é€»è¾‘ï¼Œå¦‚æœæ¯ä¸ªä¸“å®¶éƒ½å­¦ä¸€éï¼Œå¤ªæµªè´¹å‚æ•°äº†ã€‚ è§£å†³æ–¹æ¡ˆæ˜¯è®¾ç½®ä¸€ä¸ªå…±äº«ä¸“å®¶ Shared Expertï¼Œå®ƒæ€»æ˜¯è¢«æ¿€æ´»å¤„ç†é€šç”¨çŸ¥è¯†ã€‚å…¶ä»–çš„ä¸“å®¶åªè´Ÿè´£å¤„ç†ç‰¹å®šé¢†åŸŸçš„çŸ¥è¯†ã€‚ ","date":"2026-02-06","objectID":"/posts/moe/:3:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"MoE æ··åˆä¸“å®¶æ¨¡å‹","uri":"/posts/moe/#å­˜åœ¨é—®é¢˜"},{"categories":null,"content":" å…·ä½“å®ç°è¿™é‡Œæˆ‘ä»¬å®ç°çš„æ˜¯ SharedMoEï¼Œå¤§è‡´ä¸Šåˆ†ä¸º MoERouter å’Œ SparseMoE ä¸¤ä¸ªæ¨¡å—ï¼Œrouter è´Ÿè´£ä¸ºæ¯ä¸ª token é€‰æ‹©å®ƒå¯¹åº”çš„ä¸“å®¶ï¼ŒSparseMoE ç®¡ç†äº†æ•´ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å…ˆçœ‹ router éƒ¨åˆ†ï¼š python class MoERouter(nn.Module): def __init__(self, hidden_size: int, top_k: int, num_experts: int) -\u003e None: super(MoERouter, self).__init__() self.top_k = top_k self.num_experts = num_experts self.gate = nn.Linear(hidden_size, num_experts) def forward(self, hidden_states: torch.Tensor) -\u003e tuple: \"\"\" hidden_states: [bs*len, dim] router_logits: [bs*len, num_experts] router_weights/selected_indices: [bs*len, top_k] expert_masks: [bs*len, top_k, num_experts] \"\"\" assert hidden_states.dim() == 2 router_logits = self.gate(hidden_states) router_probs = nn.functional.softmax(router_logits, dim=-1) router_weights, selected_indices = torch.topk(input=router_probs, k=self.top_k, dim=-1) router_weights = router_weights / router_weights.sum(dim=-1, keepdim=True).to(hidden_states.dtype) expert_masks = nn.functional.one_hot(selected_indices, num_classes=self.num_experts) return router_probs, router_weights, selected_indices, expert_masks è¿™é‡Œçš„ hidden_states å·²ç»æ˜¯ token-level è€Œä¸æ˜¯ sample-levelï¼Œç„¶åé€šè¿‡çº¿æ€§å˜åŒ–åŠ ä¸Š softmax å¾—åˆ°è·¯ç”±çš„æ¦‚ç‡åˆ†å¸ƒï¼Œåˆ©ç”¨ torch.topk å°±å¯ä»¥æ ¹æ®æ¦‚ç‡åˆ†å¸ƒå¾—åˆ°æ¯ä¸ª token çš„å‰ k ä¸ªä¸“å®¶ã€‚ python class SparseMoE(nn.Module): def __init__(self, config: Namespace): super(SparseMoE, self).__init__() self.config = config self.router = MoERouter(config.hidden_size, config.top_k, config.num_experts) self.experts = nn.ModuleList([FeedForwardNet(config) for _ in range(config.num_experts)]) def forward(self, hidden_states: torch.Tensor) -\u003e torch.Tensor: assert hidden_states.dim() == 3 bs, seq_len, hidden_size = hidden_states.size() tokens = hidden_states.reshape(-1, hidden_size) _, router_weights, _, expert_masks = self.router(tokens) final_output = torch.zeros( (bs * seq_len, hidden_size), dtype=hidden_states.dtype, device=hidden_states.device, ) for expert_idx in range(self.config.num_experts): expert = self.experts[expert_idx] # é€‰æ‹©æœ‰ä¸“å®¶ expert_idx çš„ token token_indice, topk_indice = torch.where(expert_masks[..., expert_idx]) if token_indice.numel() == 0: continue expert_output = expert(tokens[token_indice]) # ä¹˜ä¸Š expert çš„æƒé‡ expert_output = expert_output * router_weights[ token_indice, topk_indice ].unsqueeze(-1) final_output.index_add_(0, token_indice, expert_output) return final_output ç¨€ç–æ··åˆä¸“å®¶çš„è¿‡ç¨‹å…¶å®ä¹Ÿè›®ç®€å•ï¼š é¦–å…ˆæˆ‘ä»¬æ ¹æ® router å¾—åˆ°æ¯ä¸ª token çš„ topk ä¸“å®¶ ç„¶åæˆ‘ä»¬éå†æ¯ä¸€ä¸ªä¸“å®¶ï¼Œå–å‡ºéœ€è¦è¿™ä¸ªä¸“å®¶çš„å…¨éƒ¨ token è¿™é‡Œä¸æ˜¯éå†æ¯ä¸ª token è€Œæ˜¯éå†æ¯ä¸ªä¸“å®¶ï¼Œæ•ˆç‡æ›´é«˜ï¼Œå› ä¸ºå¯ä»¥åˆ©ç”¨ PyTorch å¹¶è¡Œè®¡ç®—å¼ é‡çš„èƒ½åŠ›ã€‚ æˆ‘ä»¬æ ¹æ® expert_mask å°±èƒ½çŸ¥é“å“ªäº› token éœ€è¦å½“å‰ä¸“å®¶ï¼Œå¹¶ä¸”è·å–è¿™äº› token çš„ç´¢å¼•ã€‚æˆ‘ä»¬æŠŠæ¯å±‚ expert çš„è¾“å‡ºä¹˜ä¸Šæƒé‡ç´¯åŠ èµ·æ¥å°±èƒ½å¾—åˆ°ç»“æœã€‚tensor.index_add_() è¿™ä¸ªå†…ç½®æ–¹æ³•æ¯” tensor[indices] += æ€§èƒ½æ›´å¥½ã€‚ æœ€åç»„åˆæˆ SharedExpertï¼š python class SharedMoE(nn.Module): def __init__(self, config: Namespace): super(SharedMoE, self).__init__() self.shared_experts = nn.ModuleList( [FeedForwardNet(config) for _ in range(config.num_shared_experts)] ) self.sparse_moe = SparseMoE(config) def forward(self, hidden_states: torch.Tensor) -\u003e torch.Tensor: sparse_output = self.sparse_moe(hidden_states) shared_output = torch.stack( [shared_expert(hidden_states) for shared_expert in self.shared_experts], dim=0, ).sum(dim=0) return sparse_output + shared_output ","date":"2026-02-06","objectID":"/posts/moe/:4:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"MoE æ··åˆä¸“å®¶æ¨¡å‹","uri":"/posts/moe/#å…·ä½“å®ç°"},{"categories":null,"content":" ä¼˜åŒ–","date":"2026-02-06","objectID":"/posts/moe/:5:0","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"MoE æ··åˆä¸“å®¶æ¨¡å‹","uri":"/posts/moe/#ä¼˜åŒ–"},{"categories":null,"content":" è¾…åŠ©è´Ÿè½½å‡è¡¡æŸå¤±åœ¨ Mixture of Experts æ¨¡å‹ä¸­ï¼Œè·¯ç”±åå¡Œæ˜¯ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œè·¯ç”±ç½‘ç»œå¯èƒ½å€¾å‘äºå°†å‡ ä¹æ‰€æœ‰ token éƒ½åˆ†é…ç»™å°‘æ•°å‡ ä¸ªçƒ­é—¨ä¸“å®¶ï¼Œè€Œå…¶ä»–ä¸“å®¶å‡ ä¹ä¸è¢«ä½¿ç”¨ã€‚è§£å†³æ€è·¯å¦‚åŒæ­£åˆ™åŒ–é˜²æ­¢è¿‡æ‹Ÿåˆä¸€æ ·ï¼Œæˆ‘ä»¬åŠ å…¥è·¯ç”±ç›¸å…³çš„æŸå¤±é¡¹ã€‚è¾…åŠ©æŸå¤±å‡½æ•°åˆ†ä¸ºä¸¤ç§è®¡ç®—æ–¹å¼ï¼šåºåˆ—çº§è¾…åŠ©æŸå¤±å’Œæ‰¹çº§è¾…åŠ©æŸå¤±ã€‚ åºåˆ—çº§è¾…åŠ©æŸå¤± è¯¥æ–¹æ³•ä»¥æ¯ä¸ªåºåˆ—ä¸ºå•ä½è®¡ç®—è´Ÿè½½ï¼Œé€‚ç”¨äº é•¿åºåˆ—æˆ–è€…éœ€è¦ç»†ç²’åº¦å‡è¡¡çš„åœºæ™¯ è®¡ç®—æ¯ä¸ªåºåˆ—ä¸­ä¸“å®¶è¢«é€‰æ‹©çš„æ¬¡æ•° ceb,e=âˆ‘i=1Lâˆ‘j=1k(topk_idxb,i,j=e) ce_{b,e} = \\sum_{i=1}^{L}\\sum_{j=1}^{k}{(\\text{topk\\_idx}_{b,i,j}=e)} ceb,eâ€‹=i=1âˆ‘Lâ€‹j=1âˆ‘kâ€‹(topk_idxb,i,jâ€‹=e) å½’ä¸€åŒ–ä¸ºç›¸å¯¹è´Ÿè½½ç‡ ce^b,i=ceb,iLâ‹…k/E \\hat{ce}_{b,i}=\\frac{ce_{b,i}}{L \\cdot k / E} ce^b,iâ€‹=Lâ‹…k/Eceb,iâ€‹â€‹ è®¡ç®—æ¯ä¸ªåºåˆ—ä¸­ä¸“å®¶çš„å¹³å‡åˆ†æ•° s^b,e=1Lâˆ‘i=1Lsb,i,e \\hat{s}_{b,e}=\\frac{1}{L}\\sum_{i=1}^{L}{s_{b,i,e}} s^b,eâ€‹=L1â€‹i=1âˆ‘Lâ€‹sb,i,eâ€‹ è¾…åŠ©æŸå¤± Laux=Î±â‹…1Bâˆ‘b=1Bâˆ‘e=1Ec^b,eâ‹…s^b,e L_{aux} = \\alpha \\cdot \\frac{1}{B}\\sum_{b=1}^B\\sum_{e=1}^E \\hat{c}_{b,e} \\cdot \\hat{s}_{b,e} Lauxâ€‹=Î±â‹…B1â€‹b=1âˆ‘Bâ€‹e=1âˆ‘Eâ€‹c^b,eâ€‹â‹…s^b,eâ€‹ python def compute_seq_aux_loss( router_probs: torch.Tensor, topk_idx: torch.Tensor, bs: int, seq_len: int, top_k: int, num_experts: int, alpha: float = 0.0 ) -\u003e torch.Tensor: reshape_topk_idx = topk_idx.reshape(bs, -1) reshape_probs = router_probs.reshape(bs, seq_len, -1) expert_count = torch.zeros(bs, num_experts) expert_count.scatter_add_(1, reshape_topk_idx, torch.ones(bs, seq_len*top_k)) expert_fraction = expert_count.div(seq_len * top_k / num_experts) expert_importance = reshape_probs.mean(dim=1) return alpha * (expert_fraction * expert_importance).sum(dim=1).mean() ä¸ºä»€ä¹ˆéœ€è¦æŠŠä¸“å®¶é€‰æ‹©æ¬¡æ•°å½’ä¸€åŒ–å‘¢ï¼Ÿ æ ¹æœ¬ç›®çš„æ˜¯è®©ä¸“å®¶è¢«å‡åŒ€é€‰æ‹©æ—¶ ce[i] å›ºå®šå˜æˆ 1ã€‚ä¸¾ä¸ªä¾‹å­ï¼š seq_len = 100 top_k = 2 n_experts = 8 å¦‚æœå‡åŒ€åˆ™æ¯ä¸ªä¸“å®¶è¢«é€‰ä¸­ $200 / 8 = 25$ æ¬¡ â†’ ce[i] = 25ã€‚è¿›è¡Œå½’ä¸€åŒ–ï¼Œå³é™¤ä»¥ 25 é‚£ä¹ˆ ce[i] = 25 / 25 = 1ã€‚é‚£ä¹ˆè®¡ç®—æŸå¤± (ce * P_i).sum(dim=1) æ—¶ sum=1ï¼Œaux_loss å°±æ˜¯ Î±ã€‚ æ‰¹çº§è¾…åŠ©æŸå¤± è®¡ç®—æ¯ä¸ªä¸“å®¶çš„å…¨å±€å¹³å‡é€‰æ‹©ç‡ fe=1Nâ‹…kâˆ‘i=1Nâ‹…kmi,e f_e = \\frac{1}{N\\cdot k}\\sum_{i=1}^{N \\cdot k}{m_{i, e}} feâ€‹=Nâ‹…k1â€‹i=1âˆ‘Nâ‹…kâ€‹mi,eâ€‹ Nï¼šæ€» token æ•°é‡ kï¼štop_k mï¼šå±•å¹³å top_k ç´¢å¼•çš„ one-hot ç¼–ç  å½’ä¸€åŒ– fe^=feâ‹…E \\hat{f_e} = f_e \\cdot E feâ€‹^â€‹=feâ€‹â‹…E Eï¼šä¸“å®¶æ•°é‡ è®¡ç®—æ¯ä¸ªä¸“å®¶çš„å…¨å±€å¹³å‡åˆ†æ•° pe=1Nâˆ‘i=1Nsi,e p_e = \\frac{1}{N}\\sum_{i=1}^N{s_{i,e}} peâ€‹=N1â€‹i=1âˆ‘Nâ€‹si,eâ€‹ æ‰¹çº§è¾…åŠ©æŸå¤± Laux=Î±â‹…âˆ‘e=1Efe^â‹…pe L_{aux}=\\alpha \\cdot \\sum_{e=1}^E{\\hat{f_e}\\cdot p_e} Lauxâ€‹=Î±â‹…e=1âˆ‘Eâ€‹feâ€‹^â€‹â‹…peâ€‹ python def compute_batch_aux_loss( router_probs: torch.Tensor, topk_idx: torch.Tensor, num_experts: int, alpha: float = 0.0 ) -\u003e torch.Tensor: flat_topk_idx = topk_idx.reshape(-1) mask_ce = nn.functional.one_hot(flat_topk_idx, num_classes=num_experts) ce = mask_ce.float().mean(0) # ce[i] = ä¸“å®¶iè¢«é€‰ä¸­çš„æ¬¡æ•° / æ€»æ§½ä½æ•° fi = ce * num_experts pi = router_probs.mean(0) return alpha * (fi * pi).sum() ä½†æ˜¯æ–°çš„ç ”ç©¶è¡¨æ˜ï¼Œè¿‡åº¦å¼ºè°ƒå‡è¡¡åè€ŒæŸå®³æ¨¡å‹æ€§èƒ½ï¼Œå› æ­¤ DeepSeek æå‡ºäº† äº²å’Œåº¦æœºåˆ¶ï¼Œæˆ–æ˜¯é€šè¿‡åŠ¨æ€è°ƒæ•´è·¯ç”±åˆ†æ•°çš„åç½®ï¼Œåœ¨ä¸å¼•å…¥é¢å¤–æŸå¤±é¡¹çš„æƒ…å†µä¸‹å®ç°è´Ÿè½½å‡è¡¡ã€‚ ","date":"2026-02-06","objectID":"/posts/moe/:5:1","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"MoE æ··åˆä¸“å®¶æ¨¡å‹","uri":"/posts/moe/#è¾…åŠ©è´Ÿè½½å‡è¡¡æŸå¤±"},{"categories":null,"content":" all-to-all","date":"2026-02-06","objectID":"/posts/moe/:5:2","series":["LLM"],"tags":["å¤§æ¨¡å‹"],"title":"MoE æ··åˆä¸“å®¶æ¨¡å‹","uri":"/posts/moe/#all-to-all"},{"categories":null,"content":"æˆ‘ä»¬å…ˆå›å¿†ä¸€ä¸‹ä¼ ç»Ÿçš„å•æœºå•å¡è®­ç»ƒæ¨¡å¼ï¼š é¦–å…ˆç¡¬ç›˜è¯»å–æ•°æ®ï¼ŒCPU å¤„ç†æ•°æ®ï¼Œå°†æ•°æ®ç»„æˆä¸€ä¸ª batchï¼Œå†ä¼ å…¥ GPUï¼Œç½‘ç»œå‰å‘ä¼ æ’­ç®—å‡º lossï¼Œå†åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦ï¼Œç”¨æ¢¯åº¦æ›´æ–°å‚æ•°å®Œæˆä¸€æ¬¡è®­ç»ƒã€‚è¿™ç§ä¼ ç»Ÿæ¨¡å¼åœ¨å¤§å‚æ•°é‡æˆ–è€…å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹å°±å®¹æ˜“é™·å…¥æ˜¾å­˜çš„ç“¶é¢ˆï¼Œäºæ˜¯å°±å¼•å‡ºäº†å¤šå¡å¹¶è¡Œè®­ç»ƒã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:0:0","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#"},{"categories":null,"content":" DP DP(Data Parallel)ï¼Œä¹Ÿå°±æ˜¯æ•°æ®å¹¶è¡Œã€‚å®ƒçš„è¿è¡Œæ¨¡å¼æ˜¯ï¼š ç¡¬ç›˜è¯»å–æ•°æ®ï¼Œç”± CPU å¤„ç†ä¹‹åï¼Œç»™æ¯ä¸ª GPU ä¼ ä¸åŒçš„ä¸€éƒ¨åˆ† mini batch æ¯ä¸ª GPU å„è‡ªè®¡ç®—è¿›è¡Œå‰å‘ä¼ æ’­ï¼Œè®¡ç®—æŸå¤±å‡½æ•°ï¼Œç„¶ååå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦ å…¶å®ƒæ¯ä¸ª GPU éƒ½æŠŠæ¢¯åº¦ä¼ ç»™ GPU-0ï¼Œè®¡ç®—å…¨å±€å¹³å‡æ¢¯åº¦ï¼Œç„¶åæ›´æ–°è‡ªå·±çš„å‚æ•° æœ€å GPU-0 æŠŠæœ€æ–°çš„å‚æ•°ä¼ ç»™å…¶å®ƒ GPUï¼Œä¿è¯æ‰€æœ‰ GPU ä¸Šæ¨¡å‹çš„ä¸€è‡´ã€‚ Data Parallel çš„é—®é¢˜åœ¨äºæ•°æ®çš„ä¼ è¾“é‡å¤ªå¤§äº†ï¼Œå¹¶ä¸”éƒ½é›†ä¸­åœ¨ GPU-0 ä¸Šå‹åŠ›å¤ªå¤§äº†ã€‚å‡è®¾å‚æ•°é‡ä¸º $\\Psi$ èŠ‚ç‚¹æ•°é‡ä¸º $N$ï¼Œé‚£ä¹ˆ GPU-0 éœ€è¦ä¼ å…¥æ¢¯åº¦ $(N-1)\\Psi$ï¼Œä¼ å‡ºå‚æ•°é‡ä¸º $(N-1)\\Psi$ï¼›å…¶ä»– GPU ä¼ å‡ºæ¢¯åº¦é‡ä¸º $\\Psi$ ä¼ å…¥å‚æ•°ä¸º $\\Psi$ã€‚å…¶æ¬¡ DP æ¨¡å‹ä¸­ç»™æ¯ä¸ª GPU åˆ†é…ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™å°±ä¼šå‡ºç° GIL é”çš„é—®é¢˜ã€‚æ¯ä¸ª GPU æ‰€åœ¨çº¿ç¨‹è¿›è¡Œå‰å‘è®¡ç®—æˆ–è€…åå‘ä¼ æ’­æ—¶å€™ï¼Œç”±äºæ‰§è¡Œçš„æ˜¯ CUDA å†…æ ¸æ‰€ä»¥ä¼šè§£å¼€ GIL é”ã€‚ä½†æ˜¯ DP é‡Œé¢è¿˜æœ‰å¾ˆå¤šçº¯ Python å±‚é¢çš„ä»£ç ï¼Œä¾‹å¦‚æ¨¡å‹å¤åˆ¶ ã€è¾“å…¥åˆ‡åˆ†ã€è¾“å‡ºæ”¶é›†ç­‰ç­‰ï¼Œè¿™äº›æ“ä½œç”±äº GIL é”çš„å­˜åœ¨å°±ä¸èƒ½å¹¶è¡Œæ‰§è¡Œï¼Œæ•ˆç‡å¾ˆä½ã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:1:0","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#dp"},{"categories":null,"content":" DDP","date":"2026-02-02","objectID":"/posts/distributed_parallel/:2:0","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#ddp"},{"categories":null,"content":" Ring-AllReduce åœ¨ä»‹ç» DPP ä¹‹å‰ï¼Œè¦å…ˆä»‹ç»ä¸€ç§é›†ç¾¤é€šä¿¡æ–¹å¼ Ring-AllReduceï¼š é¦–å…ˆåœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µ Scatter-Reduceï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´ä¼šç›¸äº’ä¼ é€éƒ¨åˆ†ä¿¡æ¯ï¼Œæœ€ç»ˆè¾¾åˆ°å„ä¸ªèŠ‚ç‚¹åŒæ­¥ï¼š å¦‚å›¾ï¼Œç¬¬ä¸€æ­¥ GPU-0 å°† $a_0$ å‘ç»™ GPU-1ï¼ŒGPU-1 å°† $b_1$ å‘ç»™ GPU-2ï¼ŒGPU-2 æŠŠ $c_2$ å‘ç»™ GPU-0 ç¬¬äºŒæ­¥ï¼ŒGPU-0 æŠŠ $c_0+c_2$ å‘ç»™ GPU-1ï¼ŒGPU-1 æŠŠ $a_0+a_1$ å‘ç»™ GPU-2ï¼ŒGPU-2 æŠŠ $b_1+b2$ å‘ç»™ GPU-0 ç¬¬äºŒä¸ªé˜¶æ®µæ˜¯ AllGatherï¼š æ­¤æ—¶ GPU-0/1/2 åˆ†åˆ«æœ‰äº†å®Œæ•´çš„ c/a/b çš„ä¿¡æ¯ï¼Œå†è¿›è¡Œä¸¤è½®ä¼ æ’­ï¼Œä¸‰ä¸ª GPU å°±æŒæ¡äº†å…¨éƒ¨ä¿¡æ¯ã€‚ è¿™æ ·æ¯ä¸ª GPU éƒ½åœ¨åŒæ—¶å‘é€å’Œæ¥å—ï¼Œæœ€å¤§é™åº¦çš„åˆ©ç”¨äº†æ¯ä¸ªæ˜¾å¡çš„ä¸Šä¸‹è¡Œå¸¦å®½ã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:2:1","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#ring-allreduce"},{"categories":null,"content":" è®­ç»ƒè¿‡ç¨‹ é¦–å…ˆ PyTorch ä¼šæŠŠæ¨¡å‹å†…çš„å‚æ•°æŒ‰ç…§å€’åºæ’åˆ—ï¼ˆå› ä¸ºæ˜¯åå‘ä¼ æ’­æ±‚æ¢¯åº¦ï¼Œé¡ºåºå’Œä»£ç æ˜¯ç›¸åçš„ï¼‰ï¼Œç„¶åå°†å‚æ•°ä¾æ¬¡æ”¾åœ¨æ¡¶é‡Œã€‚æ¯ä¸ªå‚æ•°éƒ½ä¼šæŒ‚ä¸€ä¸ªç›‘å¬å™¨ï¼Œå½“å‚æ•°æ±‚å¾—æ¢¯åº¦ä¹‹åç›‘å¬å™¨è¢«è§¦å‘ï¼Œæ­¤æ—¶æ£€æŸ¥æ¡¶å†…å‚æ•°æ˜¯ä¸æ˜¯å…¨éƒ½è®¡ç®—å¥½æ¢¯åº¦äº†ã€‚å¦‚æœæ¢¯åº¦å…¨éƒ¨è®¡ç®—å®Œæˆæ”¶é›†æ»¡ä¸€ä¸ªæ¡¶ï¼Œé‚£ä¹ˆå°±ç”¨ Ring-AllReduce å¯¹è¿™ä¸ªæ¡¶å†…å‚æ•°çš„æ¢¯åº¦è¿›è¡ŒåŒæ­¥ã€‚å½“å…¨éƒ¨æ¡¶éƒ½åŒæ­¥å®Œæ•´ï¼Œå„ä¸ª GPU çš„æ¨¡å‹å°±åº”è¯¥åŒæ­¥äº†ï¼Œæ­¤æ—¶å°±å¯ä»¥è°ƒç”¨ä¼˜åŒ–å™¨å¯¹å‚æ•°è¿›è¡Œæ›´æ–°ã€‚ è¿™é‡Œå¼•å…¥æ¡¶æ˜¯å› ä¸ºï¼Œå¦‚æœä¸€ä¸ªå‚æ•°è®¡ç®—å¥½æ¢¯åº¦å°±åŒæ­¥ï¼Œå¼€é”€å¤ªå¤§äº†ã€‚ å‡è®¾å‚æ•°é‡ä¸º $\\Psi$ èŠ‚ç‚¹æ•°é‡ä¸º $N$ï¼Œé‚£ä¹ˆå¯¹äºæ¯ä¸ª GPU æœ‰ï¼š Scatter-Reduce é˜¶æ®µä¼ å…¥/ä¼ å‡ºï¼š$(N-1)\\frac{\\Psi}{N}\\approx\\Psi$ AllGather é˜¶æ®µä¼ å…¥/ä¼ å‡ºï¼š$(N-1)\\frac{\\Psi}{N}\\approx\\Psi$ å›æƒ³ä¹‹å‰ä¸‰ä¸ª GPUï¼Œæ¯ä¸ª GPU æœ‰ a/b/c ä¸‰ä¸ªå‚æ•°ã€‚æ¯ä¸ª GPU éƒ½æœ‰ $\\frac{\\Psi}{N}$ ä¸ªå—ï¼Œæ¯ä¸ªå—éƒ½ä¼šè¿›è¡Œ $N-1$ æ¬¡ä¼ é€’ï¼Œæ‰€ä»¥æ¯ä¸ª GPU æ€»ä¼ å…¥/ä¼ å‡ºçº¦ $\\Psi$ æ¬¡ï¼ŒAllGather é˜¶æ®µåŒç†ï¼Œæ€»å¤§å°çº¦ $2\\Psi$ ä¸é›†ç¾¤å¤§å°æ— å…³ã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:2:2","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#è®­ç»ƒè¿‡ç¨‹"},{"categories":null,"content":" ä»£ç å®ç°coding ä¹‹å‰æˆ‘ä»¬å¿…é¡»å…ˆæ˜ç¡®ä¸€ä¸ªæ¦‚å¿µï¼Œä¸ç®¡æˆ‘ä»¬æ˜¯é€šè¿‡ torch.multiprocessing.spawn è¿˜æ˜¯ torchrun æ¥å¯åŠ¨ DDP åˆ†å¸ƒå¼è®­ç»ƒï¼Œè„šæœ¬å¯åŠ¨ä¹‹åä¼š å¤åˆ¶å‡ºå¤šä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æ‰§è¡Œç›¸åŒçš„ä»£ç ã€‚ åœ¨å•å¡è®­ç»ƒçš„åŸºç¡€ä¸Šæˆ‘ä»¬éœ€è¦é¢å¤–å¯¼å…¥ä¸‰ä¸ªæ¨¡å—ï¼š python import torch.distributed as dist from torch.nn.parallel import DistributedDataParallel from torch.utils.data.distributed import DistributedSampler DistributedDataParallelï¼š PyTorch ä¸­å®ç° DDP æœºåˆ¶çš„æ¨¡å— DistributedSamplerï¼š ç”¨äºæŠŠæ•°æ®é‡‡æ ·åˆ°ä¸åŒçš„ GPU(è¿›ç¨‹) ä¸Š torch.distributedï¼šæä¾›åˆ†å¸ƒå¼é€šä¿¡çš„åŸºç¡€æ¨¡å—ï¼ˆè¿›ç¨‹ç»„åˆå§‹åŒ–ã€rank è·å–ç­‰ï¼‰ã€‚ è¿›ç¨‹ç»„åˆå§‹åŒ– python def init_distributed(): dist.init_process_group(backend=\"nccl\") rank = dist.get_rank() world_size = dist.get_world_size() torch.cuda.set_device(rank) return rank, world_size é¦–å…ˆæˆ‘ä»¬é…ç½®æ¯ä¸ªè¿›ç¨‹éƒ½é‡‡ç”¨ NVIDIA çš„ NCCL é€šä¿¡åº“è¿›è¡Œåˆ†å¸ƒå¼é€šä¿¡ï¼ˆnccl ç”¨ GPU æ¥é€šä¿¡ï¼Œgloo ç”¨ CPU é€šä¿¡ï¼Œç›¸è¾ƒè€Œè¨€ nccl æ•ˆç‡æ›´é«˜ï¼Œä½†æ˜¯ nccl åªé€‚ç”¨äº Linux ç¯å¢ƒï¼‰ï¼ŒåŒæ—¶å®ƒä¼šæŠŠå½“å‰çš„è¿›ç¨‹æ‹‰è¿›åŒä¸€ä¸ªåˆ†å¸ƒå¼é€šä¿¡ç»„é‡Œã€‚ä¹‹åæˆ‘ä»¬ç”¨ torch.cuda.set_device å¸®æˆ‘ä»¬æŠŠå½“å‰è¿›ç¨‹ç»‘å®šåˆ° GPU-rank ä¸Šï¼Œå°±ä¸ä¼šå‡ºç°å¤šä¸ªè¿›ç¨‹å…±æœ‰ GPU çš„æƒ…å†µã€‚ ä½†æ˜¯åœ¨å¤šæœºå¤šå¡çš„æƒ…å†µä¸‹ä¸Šè¿°ä»£ç å°±ä¼šæŠ¥é”™äº†ï¼ŒåŸå› ä¸»è¦æ˜¯æˆ‘ä»¬ææ··äº† rank å’Œ local_rank çš„åŒºåˆ«ã€‚ rank ä»£è¡¨äº†è‡ªå·±æ˜¯ç¬¬å‡ ä¸ªè¿›ç¨‹ï¼Œlocal_rank ä»£è¡¨äº†è¯¥å ç”¨å“ªå¼  GPUã€‚åœ¨å•æœºå¤šå¡çš„æƒ…å†µä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰å››å¼ å¡ï¼Œé‚£ä¹ˆå››ä¸ªè¿›ç¨‹åˆ†åˆ«ç”¨ GPU-rank æ˜¯æ²¡é—®é¢˜çš„ï¼Œä¾‹å¦‚ 0 å·è¿›ç¨‹å°±ç”¨ GPU-0ã€‚ä½†æ˜¯åœ¨å¤šæœºå¤šå¡çš„æƒ…å†µä¸‹ï¼Œå‡è®¾ä½ æœ‰ä¸¤å°æœºå™¨ï¼Œæ¯å° 4 å¼ å¡ï¼š æœºå™¨Aï¼šrank 0 1 2 3 æœºå™¨Bï¼šrank 4 5 6 7 è¿™æ—¶æœºå™¨ B ä¸Šçš„ rank-5 è¿›ç¨‹å°±ä¸èƒ½ç»‘å®š GPU-5äº†ï¼Œå®ƒç»‘å®šçš„åº”è¯¥æ˜¯æœºå™¨ B ä¸Šçš„ GPU-1ï¼Œæ‰€ä»¥æ­£ç¡®çš„é€šç”¨ä»£ç ä¸ºï¼š python def init_distributed(): dist.init_process_group(backend=\"nccl\") rank = dist.get_rank() world_size = dist.get_world_size() local_rank = int(os.environ[\"LOCAL_RANK\"]) torch.cuda.set_device(locak_rank) return rank, local_rank, world_size æ•°æ®åˆ†å¸ƒå¼é‡‡æ · python sampler = DistributedSampler(dataset) dataloader = DataLoader(dataset, batch_size=64, sampler=sampler) è¿™é‡Œæœ‰ä¸¤ä¸ªæ³¨æ„äº‹é¡¹ï¼š DataLoader é‡Œé¢ä¸éœ€è¦å†è®¾ç½® shuffle=True äº†ï¼Œåº”è¯¥åœ¨æ¯ä¸ª epoch å¼€å§‹ sampler.set_epoch(epoch)ã€‚ DistributedSampler ä¸éœ€è¦å†æ‰‹åŠ¨å¡«å†™ world_size å’Œ rankï¼Œæˆ‘ä»¬åœ¨ dist.init_process_group å°±å·²ç»æ³¨å†Œäº†ã€‚ ç”¨ DDP åŒ…è£…æ¨¡å‹ python model = model.cuda(local_rank) model = DPP(model, device_ids=[local_rank]) è¿™é‡Œç”¨ DDP æŠŠåŸå§‹æ¨¡å‹åŒ…è£…æˆåˆ†å¸ƒå¼æ¨¡å‹ï¼Œè¿™æ ·æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å®Œæ•´æ¨¡å‹å‰¯æœ¬ï¼Œä¼šè‡ªåŠ¨åœ¨ backward() æ—¶æ³¨å†Œ hookï¼Œæ‰§è¡Œ AllReduce æ“ä½œï¼Œå‚æ•°æ›´æ–°åï¼Œæ‰€æœ‰è¿›ç¨‹çš„æ¨¡å‹ä¿æŒä¸€è‡´ã€‚ å¯åŠ¨è„šæœ¬ å•æœºå¤šå¡ï¼š lua torchrun --nproc_per_node=4 --master_addr=127.0.0.1 --master_port=29500 train.py å¤šæœºå¤šå¡ï¼š lua -- æœºå™¨ A torchrun \\ --nnodes=2 \\ --nproc_per_node=4 \\ --node_rank=0 \\ --master_addr=192.168.1.10 \\ --master_port=29500 \\ main.py -- æœºå™¨ B torchrun \\ --nnodes=2 \\ --nproc_per_node=4 \\ --node_rank=1 \\ --master_addr=192.168.1.10 \\ --master_port=29500 \\ main.py nnodesï¼šæœºå™¨æ•° nproc_per_nodeï¼šGPU æ•°é‡ node_rankï¼šå½“å‰æœºå™¨æ˜¯ç¬¬å‡ ä¸ªèŠ‚ç‚¹ master_addrï¼šä¸»èŠ‚ç‚¹IP master_portï¼š é€šä¿¡ç«¯å£ torchrun ä¼šè‡ªåŠ¨è®¡ç®— rankã€local_rank å’Œ world_size æ³¨å…¥åˆ°ç¯å¢ƒå˜é‡é‡Œé¢ï¼Œç”¨ os.environ å°±å¯ä»¥è·å–äº†ã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:2:3","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#ä»£ç å®ç°"},{"categories":null,"content":" Accelerateä¸Šé¢ä»£ç ä¹Ÿå¯ä»¥çœ‹è§ PyTorch å†…ç½®çš„ DDP æœ‰ç‚¹å¤ªéº»çƒ¦äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Huggingface å°è£…çš„ accelerate åº“æ›¿ä»£ï¼ŒèŒƒä¾‹å¦‚ä¸‹ï¼š python from accelerate import Accelerator def train(): accelerator = Accelerator() model = ConvNet().cuda() optimizer = torch.optim.SGD(model.parameters(), lr=1e-4) train_dataset = Dataset(...) train_loader = Dataloader(train_dataset, batch_size, shuffle=False) train_loader, model, optimizer = accelector.prepare(train_loader, model, optimizer) for epoch in range(args.epoch): for x, y in train_loader: logits = model(x) loss = criterion(logits, y) accelector.backward(loss) optimizer.step() optimizer.zero_grad() if accelerator.is_main_process: print() ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:2:4","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#accelerate"},{"categories":null,"content":" DeepSpeed ZeROå¼€å§‹ DeepSpeed ZeRO ä¹‹å‰æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ DP å’Œ DDP ä¼˜åŒ–äº†å“ªäº›åœ°æ–¹ã€‚ é¦–å…ˆ DP é‡‡ç”¨å•è¿›ç¨‹å¤šçº¿ç¨‹è¿è¡Œï¼Œæ¯ä¸ª GPU ç‹¬ç«‹è®¡ç®—æ¢¯åº¦ï¼Œæ±‡æ€»åˆ° GPU-0 ä¸Šå¹³å‡æ¢¯åº¦å†æ›´æ–°å‚æ•°ã€‚ç„¶å GPU-0 å†æŠŠæ›´æ–°åçš„å‚æ•°åˆ†å‘å‡ºå»ã€‚ç¼ºç‚¹ç”±äº GIL é”çš„é—®é¢˜ï¼Œå¤šä¸ª GPU é€šä¿¡æ˜¯å•è¿›ç¨‹æ— æ³•åˆ©ç”¨ CPU å¤šæ ¸ï¼Œå…¶æ¬¡é€šä¿¡é‡å…¨éƒ¨é›†ä¸­åœ¨ GPU-0 ä¸Šå‹åŠ›å¤§ï¼Œæœ€åé€šä¿¡é‡éšç€ GPU æ•°å¢åŠ çº¿æ€§å¢é•¿ã€‚ DDP é‡‡ç”¨ Ring-AllReduce å®ç°æ¢¯åº¦åŒæ­¥ã€‚è®¡ç®—å’ŒåŒæ­¥å¹¶è¡Œï¼Œä»è¾“å‡ºå±‚åå‘å¼€å§‹åŒæ­¥ï¼ˆç¦»è¾“å‡ºè¶Šè¿‘çš„å‚æ•°æ¢¯åº¦è¶Šå…ˆè®¡ç®—å‡ºæ¥ï¼‰ï¼Œä¸ºäº†é™ä½é¢‘ç¹é€šä¿¡çš„å¼€é”€ï¼Œä½¿ç”¨æ¡¶æ”¶é›†ä¸€å®šé‡æ¢¯åº¦ååŒæ­¥ä¸€æ¬¡ï¼Œæ¯ä¸ª GPU çš„é€šè¡Œé‡çº¦ä¸º $2*\\Psi$ã€‚ ä½†æ˜¯ä¸ç®¡æ˜¯ DP è¿˜æ˜¯ DDPï¼Œæ¯ä¸ª GPU éƒ½ä¿å­˜äº†å®Œæ•´çš„æ¨¡å‹å‚æ•°ï¼Œä¸­é—´æ¿€æ´»å€¼ä»¥åŠä¼˜åŒ–å™¨çŠ¶æ€ï¼Œè¿™é‡Œé¢ä¼˜åŒ–å™¨çŠ¶æ€å ç”¨çš„æ˜¾å­˜æœ€å¤§ï¼Œæˆ‘ä»¬æ‹¿ AdamW ä¸¾ä¾‹ä¸€å…±éœ€è¦ï¼š FP16 çš„å‚æ•°ã€æ¢¯åº¦ï¼ˆæ¨¡å‹å‚æ•°ï¼‰ FP32 çš„æ¢¯åº¦ã€ä¸€é˜¶åŠ¨é‡ã€äºŒé˜¶åŠ¨é‡ã€Master Weightï¼ˆä¼˜åŒ–å™¨çŠ¶æ€ï¼‰ è€Œ DeepSpeed ZeRO çš„ ZeRO å«ä¹‰æ˜¯ Zero Redundancy Optimizerï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ æ¶ˆé™¤å†—ä½™å­˜å‚¨çš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼Œæ¯ä¸ª GPU ä¸­ä¼˜åŒ–å™¨çŠ¶æ€æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å°†ä¼˜åŒ–å™¨çŠ¶æ€æŒ‰ç¦»è¾“å‡ºçš„ä½ç½®å…³ç³»è¿›è¡Œåˆ†å—ï¼Œæ‹†åˆ†åˆ°ä¸åŒ GPU ä¸Šï¼Œå®ç°é›¶å†—ä½™ã€‚DeepSpeed åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼ŒZeRO-1 ä»…åˆ†åŒºä¼˜åŒ–å™¨çŠ¶æ€ï¼ŒZeRO-2 åŠ å…¥äº†æ¢¯åº¦ï¼ŒZeRO-3 åŠ å…¥äº†æ¨¡å‹çš„å‚æ•°ã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:3:0","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#deepspeed-zero"},{"categories":null,"content":" ZeRO-1 æˆ‘ä»¬ä»ä¸Šå›¾å¼€å§‹äº†è§£ DeepSpeed ZeRO-1ã€‚é¦–å…ˆé‡‡æ ·äº†ä¸åŒçš„æ•°æ®åˆ†é…ç»™æ¯ä¸ª GPUï¼Œæ¯ä¸ª GPU ä¿å­˜äº†ç›¸åŒçš„ FP16 çš„å‚æ•°å’Œæ¢¯åº¦ï¼ˆæµ…è“è‰²çš„ä¸¤å±‚ï¼‰ï¼Œä½†æ˜¯ä¿å­˜äº†ä¸åŒåˆ†åŒºçš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆæ·±è“è‰²åŒºåŸŸï¼‰ã€‚å‡å¦‚æˆ‘ä»¬æœ‰ä¸‰ä¸ª GPUï¼Œæ¨¡å‹ä¸€å…±æœ‰ 9 å±‚ï¼Œé‚£ä¹ˆ GPU-0 å­˜å‰ä¸‰å±‚çš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼ŒGPU-1 å­˜ä¸­é—´ä¸‰å±‚çš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼ŒGPU-2 å­˜æœ€åä¸‰å±‚çš„ä¼˜åŒ–å™¨çŠ¶æ€ã€‚è®­ç»ƒå¼€å§‹ï¼š ç”±äºæ¯ä¸ª GPU éƒ½å­˜å‚¨äº†å®Œæ•´çš„æ¨¡å‹å‚æ•°ï¼Œæ‰€ä»¥å¯ä»¥åˆ†åˆ«ç‹¬ç«‹çš„è¿›è¡Œå‰å‘ä¼ æ’­ï¼Œè®¡ç®—å¾—åˆ° loss åå‘ä¼ æ’­æ—¶ï¼Œæ¯ä¸ª GPU éƒ½ä»åå‘å‰è®¡ç®—å‡ºæ¯ä¸€å±‚å‚æ•°çš„æ¢¯åº¦ ç„¶å GPU-0 å’Œ GPU-1 åˆ†åˆ«å°†åä¸‰å±‚è®¡ç®—å‡ºçš„æ¢¯åº¦ä¼ ç»™ GPU-2ï¼ŒGPU-2 è®¡ç®—å¾—åˆ°åä¸‰å±‚å‚æ•°çš„å¹³å‡æ¢¯åº¦ã€‚åŒç†ï¼ŒGPU-0 å’Œ GPU-2 æŠŠä¸­é—´ä¸‰å±‚è®¡ç®—çš„æ¢¯åº¦ä¼ ç»™ GPU-1ï¼ŒGPU-0 ä¹Ÿæ˜¯è¿™æ ·ã€‚æœ€ç»ˆä¸‰ä¸ª GPU åˆ†åˆ«èƒ½å¤Ÿè®¡ç®—å‡ºè‡ªå·±å¯¹åº”å±‚æ¬¡çš„å¹³å‡æ¢¯åº¦ã€‚ å¯¹ GPU-0 æ¥è¯´ï¼Œå®ƒå·²ç»è®¡ç®—å¾—åˆ°äº†å‰ä¸‰å±‚å‚æ•°çš„æ¢¯åº¦å¹³å‡å€¼ï¼Œå®ƒåˆä¿å­˜äº†å‰ä¸‰å±‚çš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼Œæ‰€ä»¥å®ƒå°±å¯ä»¥å°†æ¢¯åº¦è½¬åˆ° FP32 ç„¶åæ›´æ–°å‰ä¸‰å±‚ä¼˜åŒ–å™¨çŠ¶æ€ï¼Œå†æ›´æ–°å‰ä¸‰å±‚çš„å‚æ•°å€¼ï¼Œæœ€åæŠŠæ›´æ–°åçš„å‰ä¸‰å±‚å‚æ•°å¹¿æ’­ç»™å…¶ä»–ä¸¤ä¸ª GPUã€‚å…¶ä»– GPU ä¹ŸåŒæ ·åšä¸Šè¿°æ“ä½œå°†è‡ªå·±å¯¹åº”çš„å‚æ•°æ›´æ–°äº†å†å¹¿æ’­ç»™å…¶ä»– GPUï¼Œä½¿å¾—ä¸åŒ GPU çš„æ¨¡å‹æœ€ç»ˆä¿æŒä¸€è‡´ã€‚ å‡è®¾å‚æ•°é‡ä¸º $\\Psi$ èŠ‚ç‚¹æ•°é‡ä¸º $N$ï¼Œé‚£ä¹ˆå¯¹äºæ¯ä¸ª GPU æœ‰ï¼š æ¢¯åº¦æ”¶é›†é˜¶æ®µä¼ å…¥/ä¼ å‡ºï¼š$(N-1)\\frac{\\Psi}{N}\\approx\\Psi$ å‚æ•°å¹¿æ’­é˜¶æ®µä¼ å…¥/ä¼ å‡ºï¼š$(N-1)\\frac{\\Psi}{N}\\approx\\Psi$ æœ€ç»ˆæ€»ä¼ å…¥/ä¼ å‡ºå‚æ•°é‡ä¸º $2\\Psi$ å’Œ DDP é€šè®¯é‡ç›¸åŒã€‚ ä¸Šå›¾å¯ä»¥çœ‹åˆ° DeepSpeed ZeRO-1 é€šè¿‡å°†ä¼˜åŒ–å™¨çŠ¶æ€åˆ†å¸ƒåœ¨ä¸åŒ GPUï¼Œå¤§å¹…åº¦é™ä½äº†æ˜¾å­˜å ç”¨ã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:3:1","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#zero-1"},{"categories":null,"content":" ZeRO-2 DeepSpeed ZeRO-2 ç›¸å¯¹äº ZeRO- 1 çš„æ ¸å¿ƒä¼˜åŒ–åœ¨äºè¿›ä¸€æ­¥åˆ†åŒºäº†æ¢¯åº¦ä»è€Œæ˜¾è‘—é™ä½æ˜¾å­˜å ç”¨ï¼Œæƒ³æ³•å¾ˆç®€å•ï¼šæ¯ä¸ª GPU åªè´Ÿè´£æ›´æ–°å¯¹åº”çš„å‚æ•°ï¼Œé‚£ä¹ˆåªéœ€è¦ä¿å­˜è¿™éƒ¨åˆ†å‚æ•°çš„æ¢¯åº¦å°±å¥½äº†ã€‚è®­ç»ƒè¿‡ç¨‹å¦‚ä¸‹ï¼š ç”±äºæ¯ä¸ª GPU éƒ½å­˜å‚¨äº†å®Œæ•´çš„æ¨¡å‹å‚æ•°ï¼Œæ‰€ä»¥å¯ä»¥åˆ†åˆ«ç‹¬ç«‹çš„è¿›è¡Œå‰å‘ä¼ æ’­ï¼Œè®¡ç®—å¾—åˆ° loss åå‘ä¼ æ’­æ—¶ï¼Œæ¯ä¸ª GPU éƒ½ä»åå‘å‰è®¡ç®—å‡ºæ¯ä¸€å±‚å‚æ•°çš„æ¢¯åº¦ ç„¶å GPU-0 å’Œ GPU-1 è®¡ç®—å‡ºæœ€åä¸€å±‚å‚æ•°çš„æ¢¯åº¦ï¼Œå®ƒä»¬ä¼šæŠŠè¿™äº›æ¢¯åº¦æ”¾åˆ°ä¸€ä¸ª bucket é‡Œé¢ï¼Œå†ä¼ ç»™ GPU-2ã€‚å½“ GPU-2 è®¡ç®—å¾—åˆ°æœ€åä¸€å±‚çš„å¹³å‡æ¢¯åº¦ï¼ŒGPU-0 å’Œ GPU-1 å°±æŠŠè¿™äº›æ¢¯åº¦åˆ é™¤ï¼Œå› ä¸ºä¸æ˜¯è‡ªå·±éœ€è¦çš„ï¼Œä»¥æ­¤å‡å°‘äº†æ˜¾å­˜å ç”¨ã€‚å€’æ•°ç¬¬äºŒã€ä¸‰å±‚ä¹Ÿæ˜¯å¦‚ä½•ï¼Œè®¡ç®—å¾—åˆ°æ¢¯åº¦å†ä¼ ç»™ GPU-2 è®¡ç®—å¹³å‡æ¢¯åº¦ï¼Œç„¶åè‡ªå·±å†æŠŠä¸éœ€è¦çš„è¿™éƒ¨åˆ†æ¢¯åº¦åˆ é™¤ã€‚è€Œ GPU-2 å¾—åˆ°äº†åä¸‰å±‚å¹³å‡æ¢¯åº¦ï¼Œå°±å¯ä»¥æ›´æ–°è‡ªå·±å¯¹åº”çš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼Œå†æ›´æ–°å‚æ•°ã€‚ æœ€åä¸‰ä¸ª GPU å†åˆ†åˆ«ä¼ é€’è‡ªå·±æ›´æ–°å¥½çš„å‚æ•°ï¼Œä½¿å¾—æ¯ä¸ª GPU ä¸Šçš„æ¨¡å‹ä¿å­˜ä¸€è‡´ã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:3:2","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#zero-2"},{"categories":null,"content":" ZeRO-3 DeepSpeed ZeRO-3 åˆè¿›ä¸€æ­¥åˆ†åŒºäº†æ¨¡å‹çš„å‚æ•°ï¼Œåœ¨å‰å‘ä¼ æ’­æ—¶å€™é€šè¿‡å…¶ä»– GPU æ¥å¹¿æ’­è‡ªå·±æ‰€ç¼ºçš„é‚£ä¸€éƒ¨åˆ†å‚æ•°ã€‚ å‡è®¾å‚æ•°é‡ä¸º $\\Psi$ èŠ‚ç‚¹æ•°é‡ä¸º $N$ï¼Œé‚£ä¹ˆå¯¹äºæ¯ä¸ª GPU æœ‰ï¼š æ¢¯åº¦æ”¶é›†é˜¶æ®µä¼ å…¥/ä¼ å‡ºï¼š$(N-1)\\frac{\\Psi}{N}\\approx\\Psi$ å‚æ•°å¹¿æ’­é˜¶æ®µä¼ å…¥/ä¼ å‡ºï¼š$2*(N-1)\\frac{\\Psi}{N}\\approx2\\Psi$ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:3:3","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#zero-3"},{"categories":null,"content":" ä»£ç å®ç°ç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯æ‰‹åŠ¨åˆ›å»º DataLoader + DistributedSamplerï¼Œè¿™æ ·å¯ä»¥è‡ªå·±ç®¡ç†æ•°æ®åˆ†ç‰‡ã€‚ python if args.local_rank != -1: torch.cuda.set_device(args.local_rank) dist.init_process_group(\"nccl\") def train_custom(epochs: int): model = Net().cuda() optimizer = AdamW(model.parameters(), lr=1e-5) model_engine, optimizer, *_ = deepspeed.initialize( model=model, optimizer=optimizer, config_json=\"deepspeed_config.json\" ) dataset = NetDataset() sampler = DistributedSampler(dataset) dataloader = DataLoader(dataset, batch_size=args.batch_size, sampler=sampler) criterion = MSELoss() model_engine.train() for epoch in range(epochs): sampler.set_epoch(epoch) for i, (x, y) in enumerate(dataloader): inputs = x.to(model_engine.local_rank) labels = y.to(model_engine.local_rank) output = model_engine(inputs) loss = criterion(output, labels) model_engine.backward(loss) model_engine.step() è¿™ç§æ–¹æ³•è‡ªå·±é€šè¿‡ DistributedSampler å¯¹æ•°æ®è¿›è¡Œåˆ†å¸ƒï¼Œæ ¹æ® distributed é€šè®¯ç»„çš„ä¿¡æ¯(local_rank) å°±èƒ½è¿›è¡Œé‡‡æ ·äº†ï¼Œè¿™ç§æ–¹æ³•å¥½å¤„åœ¨äºå¯ä»¥å®Œå…¨æ§åˆ¶ dataloaderï¼Œå¯åŠ  collate_fnã€è‡ªå®šä¹‰ sampler ç­‰ã€‚è€Œ deepspeed.initialize ä¼šåˆ›å»º DeepSpeedEngine å®ä¾‹ä»£æ›¿åŸæ¥çš„ Moduleï¼Œè´Ÿè´£ä¼˜åŒ–å™¨çŠ¶æ€ã€æ¢¯åº¦ç­‰ä¿¡æ¯çš„ä¼ é€’ã€‚ å¦ä¸€ç§æ–¹æ³•æ˜¯å®Œå…¨ç”± DeepSpeed æ¨¡å—æ¥è‡ªåŠ¨å¤„ç†æ•°æ®åˆ†ç‰‡å’Œ shuffleï¼Œè¿™é‡Œæˆ‘ä»¬æ²¡æœ‰æ‰‹åŠ¨å®šä¹‰ optimizerï¼Œè€Œæ˜¯åœ¨ DeepSpeed çš„é…ç½®æ–‡ä»¶é‡Œé¢å¡«å†™ä¼˜åŒ–å™¨ä¿¡æ¯ï¼Œç„¶åç”± deepspeed.initialize æ–¹æ³•ç›´æ¥ç”Ÿæˆï¼š python def train_default(epochs: int): model = Net().cuda() dataset = NetDataset() criterion = MSELoss() model_engine, optimizer, training_dataloader, _ = deepspeed.initialize( args=args, model=model, model_parameters=[p for p in model.parameters() if p.requires_grad], training_data=dataset, config=\"ds_config.json\", ) model_engine.train() for epoch in range(epochs): for x, y in training_dataloader: inputs = x.to(model_engine.local_rank) labels = y.to(model_engine.local_rank) output = model_engine(inputs) loss = criterion(output, labels) model_engine.backward(loss) model_engine.step() æ³¨æ„ä¸ç®¡æ˜¯å“ªç§å†™æ³•éƒ½ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ  model.zero_grad() ï¼Œå› ä¸º DeepSpeedEngine å·²ç»æ¥ç®¡äº†æ•´ä¸ªæµç¨‹ã€‚å®ƒå¯ä»¥ç»“åˆæ¢¯åº¦ç´¯è®¡çš„å‚æ•°ï¼Œè‡ªåŠ¨è¿›è¡Œ engine.step()ã€‚æ‰‹åŠ¨ zero_grad ä¼šç ´å ZeRO çš„åˆ†åŒºçŠ¶æ€ï¼Œå› ä¸ºæœ‰å¯èƒ½æ¢¯åº¦è¿˜æ²¡ä¼ æ’­ï¼Œå…¶ä»– GPU çš„åˆ†åŒºè¿˜æ²¡æœ‰åŒæ­¥ã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:3:4","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#ä»£ç å®ç°-1"},{"categories":null,"content":" é…ç½®æ–‡ä»¶ ZeRO-2 json { \"fp16\": { \"enabled\": \"auto\", \"loss_scale\": 0, \"loss_scale_window\": 1000, \"initial_scale_power\": 16, \"hysteresis\": 2, \"min_loss_scale\": 1 }, \"optimizer\": { \"type\": \"AdamW\", \"params\": { \"lr\": \"auto\", \"betas\": \"auto\", \"eps\": \"auto\", \"weight_decay\": \"auto\" } }, \"scheduler\": { \"type\": \"WarmupLR\", \"params\": { \"warmup_min_lr\": \"auto\", \"warmup_max_lr\": \"auto\", \"warmup_num_steps\": \"auto\" } }, \"zero_optimization\": { \"stage\": 2, \"offload_optimizer\": { \"device\": \"cpu\", \"pin_memory\": true }, \"allgather_partitions\": true, \"allgather_bucket_size\": 2e8, \"overlap_comm\": true, \"reduce_scatter\": true, \"reduce_bucket_size\": 2e8, \"contiguous_gradients\": true }, \"gradient_accumulation_steps\": \"auto\", \"gradient_clipping\": \"auto\", \"steps_per_print\": 2000, \"train_batch_size\": \"auto\", \"train_micro_batch_size_per_gpu\": \"auto\", \"wall_clock_breakdown\": false } å¤§éƒ¨åˆ†å‚æ•°çœ‹åå­—å°±èƒ½æ„ä¼šäº†ï¼Œè¿™é‡Œä»‹ç»å‡ ä¸ªå¾…æƒ…å†µè€Œå®šçš„å‚æ•°ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜ç½‘ï¼š contiguous_gradientsï¼šæ˜¯å¦åœ¨å†…å­˜ä¸­å­˜å‚¨è¿ç»­æ¢¯åº¦ï¼Œå¼€å¯åå¯å‡å°‘å†…å­˜ç¢ç‰‡åŒ–æé«˜é€šä¿¡æ•ˆç‡ï¼Œä½†æ˜¯å¢åŠ æ˜¾å­˜å¼€é”€ã€‚ reduce_bucket_sizeï¼šå›¾ä¾‹ä¸­ bucket çš„å¤§å°ï¼Œè‹¥æ˜¾å­˜ä¸è¶³ï¼Œå‡å°å€¼è‡³Â 1e5Â æˆ–Â 5e5ï¼Œå¦‚æœé€šä¿¡ç“¶é¢ˆæ˜æ˜¾ï¼Œå¯é€‚å½“å¢å¤§å€¼ã€‚ offload_optimizerï¼šå¦‚æœæ˜¾å­˜ä¸è¶³å¯ä»¥æŠŠä¼˜åŒ–å™¨çŠ¶æ€å­˜åœ¨ CPU ä¸Šï¼Œåªæœ‰ ZeRO-3 å¯ä»¥ç”¨ã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:3:5","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#é…ç½®æ–‡ä»¶"},{"categories":null,"content":" é…ç½®æ–‡ä»¶ ZeRO-2 json { \"fp16\": { \"enabled\": \"auto\", \"loss_scale\": 0, \"loss_scale_window\": 1000, \"initial_scale_power\": 16, \"hysteresis\": 2, \"min_loss_scale\": 1 }, \"optimizer\": { \"type\": \"AdamW\", \"params\": { \"lr\": \"auto\", \"betas\": \"auto\", \"eps\": \"auto\", \"weight_decay\": \"auto\" } }, \"scheduler\": { \"type\": \"WarmupLR\", \"params\": { \"warmup_min_lr\": \"auto\", \"warmup_max_lr\": \"auto\", \"warmup_num_steps\": \"auto\" } }, \"zero_optimization\": { \"stage\": 2, \"offload_optimizer\": { \"device\": \"cpu\", \"pin_memory\": true }, \"allgather_partitions\": true, \"allgather_bucket_size\": 2e8, \"overlap_comm\": true, \"reduce_scatter\": true, \"reduce_bucket_size\": 2e8, \"contiguous_gradients\": true }, \"gradient_accumulation_steps\": \"auto\", \"gradient_clipping\": \"auto\", \"steps_per_print\": 2000, \"train_batch_size\": \"auto\", \"train_micro_batch_size_per_gpu\": \"auto\", \"wall_clock_breakdown\": false } å¤§éƒ¨åˆ†å‚æ•°çœ‹åå­—å°±èƒ½æ„ä¼šäº†ï¼Œè¿™é‡Œä»‹ç»å‡ ä¸ªå¾…æƒ…å†µè€Œå®šçš„å‚æ•°ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜ç½‘ï¼š contiguous_gradientsï¼šæ˜¯å¦åœ¨å†…å­˜ä¸­å­˜å‚¨è¿ç»­æ¢¯åº¦ï¼Œå¼€å¯åå¯å‡å°‘å†…å­˜ç¢ç‰‡åŒ–æé«˜é€šä¿¡æ•ˆç‡ï¼Œä½†æ˜¯å¢åŠ æ˜¾å­˜å¼€é”€ã€‚ reduce_bucket_sizeï¼šå›¾ä¾‹ä¸­ bucket çš„å¤§å°ï¼Œè‹¥æ˜¾å­˜ä¸è¶³ï¼Œå‡å°å€¼è‡³Â 1e5Â æˆ–Â 5e5ï¼Œå¦‚æœé€šä¿¡ç“¶é¢ˆæ˜æ˜¾ï¼Œå¯é€‚å½“å¢å¤§å€¼ã€‚ offload_optimizerï¼šå¦‚æœæ˜¾å­˜ä¸è¶³å¯ä»¥æŠŠä¼˜åŒ–å™¨çŠ¶æ€å­˜åœ¨ CPU ä¸Šï¼Œåªæœ‰ ZeRO-3 å¯ä»¥ç”¨ã€‚ ","date":"2026-02-02","objectID":"/posts/distributed_parallel/:3:5","series":["LLM"],"tags":[],"title":"åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯","uri":"/posts/distributed_parallel/#zero-2-1"},{"categories":null,"content":" é•¿è¯çŸ­è¯´ä»Šå¤©çœ‹äº†ä¸€ä¸‹æºç å’Œå®˜æ–¹æ–‡æ¡£ï¼Œæ¢³ç†è¿‡åä¼šå‘ç°å…¶å®ä¹Ÿä¸æ˜¯å¾ˆå¤æ‚ï¼Œç®€å•ç†è§£å°±ä¸¤æ¡ï¼š ModelOutput(transformers.utils.ModelOutput)æ˜¯æ‰€æœ‰æ¨¡å‹è¾“å‡ºçš„åŸºç±»ã€‚ç®€å•ç†è§£å®ƒå°±æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œåœ¨æ¨¡å‹çš„Â forwardå‡½æ•°é‡ŒæŠŠåŸæœ¬çš„è¾“å‡ºåšäº†ä¸€ä¸‹å°è£…è€Œå·²ï¼Œæ–¹ä¾¿ç”¨æˆ·èƒ½ç›´è§‚åœ°çŸ¥é“è¾“å‡ºæ˜¯ä»€ä¹ˆã€‚ä¾‹å¦‚CausalLMOutputé¡¾åæ€ä¹‰å°±æ˜¯ç”¨äºåƒ GPT è¿™æ ·è‡ªå›å½’æ¨¡å‹çš„è¾“å‡ºã€‚ PreTrainedModelÂ (transformers.modeling_utils.PretrainedModel) æ˜¯æ‰€æœ‰æ¨¡å‹çš„åŸºç±»ã€‚æ‰€ä»¥ä½ å¦‚æœçœ‹åˆ°ä¸€ä¸ªæ¨¡å‹å–åä¸ºLlamaForCausalLMï¼Œé‚£ä½ å°±å¯ä»¥çŸ¥é“è¿™ä¸ªæ¨¡å‹çš„è¾“å‡ºæ ¼å¼å¤§æ¦‚ç‡å°±æ˜¯è‡ªå›å½’è¾“å‡ºï¼Œå³å‰é¢æåˆ°çš„CausalLMOutputã€‚ä¸ºä»€ä¹ˆè¯´å¤§æ¦‚ç‡å‘¢ï¼Œå› ä¸ºè‡ªå›å½’è¾“å‡ºè¿˜æœ‰è›®å¤šç§çš„ï¼Œèµ¶æ—¶é—´çš„æœ‹å‹çœ‹åˆ°è¿™å°±å¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–æ–‡ç« äº†ï¼Œè‡³æ­¤ä½ åº”è¯¥ä¹Ÿèƒ½äº†è§£ transformers æœ€æ ¸å¿ƒçš„æ¨¡å—äº†ã€‚æ„Ÿå…´è¶£çš„å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹ï¼Œä¸‹é¢åšä¸€ä¸ªç®€å•çš„æ€»ç»“å’Œä»‹ç»ã€‚ ","date":"2026-01-27","objectID":"/posts/hg_transformer/:1:0","series":["LLM"],"tags":["HuggingFace"],"title":"transformeråº“çš„åŸºç±»","uri":"/posts/hg_transformer/#é•¿è¯çŸ­è¯´"},{"categories":null,"content":" çŸ­è¯é•¿è¯´","date":"2026-01-27","objectID":"/posts/hg_transformer/:2:0","series":["LLM"],"tags":["HuggingFace"],"title":"transformeråº“çš„åŸºç±»","uri":"/posts/hg_transformer/#çŸ­è¯é•¿è¯´"},{"categories":null,"content":" ModelOutputå‰é¢å·²ç»ä»‹ç»è¿‡äº†ï¼ŒModelOutputæ˜¯æ‰€æœ‰æ¨¡å‹è¾“å‡ºçš„åŸºç±»ã€‚ä¸‹é¢æ˜¯å…¶æºç æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¸€äº›å…·ä½“å®ç°ä»£ç åˆ é™¤äº†ï¼Œä¸è¿‡ä¸å½±å“ç†è§£ã€‚ å¯ä»¥çœ‹åˆ°Â ModelOutputÂ å…¶å®å°±æ˜¯ä¸€ä¸ªæœ‰åºçš„å­—å…¸ï¼ˆOrderedDictï¼‰ã€‚ python class ModelOutput(OrderedDict): def __init_subclass__(cls) -\u003e None: \"\"\" è¿™ä¸ªæ–¹æ³•å…è®¸å¯¹ ModelOutput çš„å­ç±»è¿›è¡Œå®šåˆ¶ï¼Œä½¿å¾—å­ç±»åœ¨è¢«åˆ›å»ºæ—¶èƒ½å¤Ÿæ‰§è¡Œç‰¹å®šçš„æ“ä½œæˆ–æ³¨å†Œåˆ°æŸä¸ªç³»ç»Ÿä¸­ã€‚ \"\"\" ... def __init__(self, *args, **kwargs): \"\"\" åˆå§‹åŒ– ModelOutput ç±»çš„å®ä¾‹ã€‚ \"\"\" super().__init__(*args, **kwargs) def __post_init__(self): \"\"\" åœ¨åˆå§‹åŒ– ModelOutput ç±»çš„å®ä¾‹ä¹‹åæ‰§è¡Œçš„æ“ä½œï¼Œå…è®¸è¿›ä¸€æ­¥å¯¹å®ä¾‹è¿›è¡Œå¤„ç†æˆ–è®¾ç½®å±æ€§ã€‚å­ç±»éœ€è¦ç”¨ dataclass è£…é¥°å™¨ \"\"\" ... åŸºäºÂ ModelOutputï¼Œhf é¢„å…ˆå®šä¹‰äº† 40 å¤šç§ä¸åŒçš„ sub-classï¼Œè¿™äº›ç±»æ˜¯ Hugging Face Transformers åº“ä¸­ç”¨äºè¡¨ç¤ºä¸åŒç±»å‹æ¨¡å‹è¾“å‡ºçš„åŸºç¡€ç±»ï¼Œæ¯ä¸ªç±»éƒ½æä¾›äº†ç‰¹å®šç±»å‹æ¨¡å‹è¾“å‡ºçš„ç»“æ„å’Œä¿¡æ¯ï¼Œä»¥ä¾¿äºåœ¨å®é™…ä»»åŠ¡ä¸­å¯¹æ¨¡å‹è¾“å‡ºè¿›è¡Œå¤„ç†å’Œä½¿ç”¨ã€‚æ¯ä¸ª sub-class éƒ½éœ€è¦ç”¨è£…é¥°å™¨Â @dataclassã€‚æˆ‘ä»¬ä»¥CausalLMOutputWithPastä¸ºä¾‹çœ‹ä¸€ä¸‹æºç æ˜¯ä»€ä¹ˆæ ·çš„ï¼š python @dataclass class CausalLMOutputWithPast(ModelOutput): loss: Optional[torch.FloatTensor] = None logits: torch.FloatTensor = None past_key_values: Optional[Tuple[Tuple[torch.FloatTensor]]] = None hidden_states: Optional[Tuple[torch.FloatTensor]] = None attentions: Optional[Tuple[torch.FloatTensor]] = None ä¸ºäº†ä¿æŒä»£ç è§„èŒƒï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¨¡å‹çš„forwardå‡½æ•°ä¸­å¯¹è¾“å‡ºç»“æœè¿›è¡Œå°è£…ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š python class MyModel(PretrainedModel): def __init__(self): self.model = ... def forward(self, inputs, labels): output = self.model(**inputs) hidden_states = ... loss = loss_fn(outputs, labels) return CausalLMOutputWithPast( loss=loss, logits=logits, past_key_values=outputs.past_key_values, hidden_states=outputs.hidden_states, attentions=outputs.attentions, ) è¿™é‡Œç®€å•ä»‹ç»ä»¥ä¸‹å‡ ç§ï¼Œæ›´å¤šçš„å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£å’Œæºç ï¼š BaseModelOutput: è¯¥ç±»æ˜¯è®¸å¤šåŸºæœ¬æ¨¡å‹è¾“å‡ºçš„åŸºç¡€ï¼ŒåŒ…å«æ¨¡å‹çš„ä¸€èˆ¬è¾“å‡ºï¼Œå¦‚ logitsã€hidden_states ç­‰ã€‚ BaseModelOutputWithNoAttention: åœ¨æ¨¡å‹è¾“å‡ºä¸­ä¸åŒ…å«æ³¨æ„åŠ›ï¼ˆattentionï¼‰ä¿¡æ¯ã€‚ BaseModelOutputWithPast: åŒ…å«è¿‡å»éšè—çŠ¶æ€çš„æ¨¡å‹è¾“å‡ºï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿­ä»£ç”Ÿæˆæ–‡æœ¬çš„æ¨¡å‹ï¼Œä¾‹å¦‚è¯­è¨€æ¨¡å‹ã€‚ BaseModelOutputWithCrossAttentions: åœ¨æ¨¡å‹è¾“å‡ºä¸­åŒ…å«äº¤å‰æ³¨æ„åŠ›ï¼ˆcross attentionsï¼‰ä¿¡æ¯ï¼Œé€šå¸¸ç”¨äºç‰¹å®šä»»åŠ¡ä¸­éœ€è¦è·¨æ³¨æ„åŠ›çš„æƒ…å†µï¼Œæ¯”å¦‚æœºå™¨ç¿»è¯‘ã€‚ BaseModelOutputWithPastAndCrossAttentions: åŒæ—¶åŒ…å«è¿‡å»éšè—çŠ¶æ€å’Œäº¤å‰æ³¨æ„åŠ›çš„æ¨¡å‹è¾“å‡ºã€‚ MoEModelOutput: åŒ…å«æ··åˆä¸“å®¶æ¨¡å‹ï¼ˆMixture of Expertsï¼‰è¾“å‡ºçš„æ¨¡å‹ã€‚ MoECausalLMOutputWithPast: æ··åˆä¸“å®¶è¯­è¨€æ¨¡å‹çš„è¾“å‡ºï¼ŒåŒ…æ‹¬è¿‡å»éšè—çŠ¶æ€ã€‚ Seq2SeqModelOutput: åºåˆ—åˆ°åºåˆ—æ¨¡å‹è¾“å‡ºçš„åŸºç±»ï¼Œé€‚ç”¨äºéœ€è¦ç”Ÿæˆåºåˆ—çš„æ¨¡å‹ã€‚ CausalLMOutput: ç”¨äºç”Ÿæˆå¼è¯­è¨€æ¨¡å‹è¾“å‡ºçš„åŸºç¡€ç±»ï¼Œæä¾›ç”Ÿæˆæ–‡æœ¬çš„åŸºæœ¬ä¿¡æ¯ã€‚ CausalLMOutputWithPast: ç”Ÿæˆå¼è¯­è¨€æ¨¡å‹è¾“å‡ºçš„ç±»ï¼ŒåŒ…å«è¿‡å»éšè—çŠ¶æ€ï¼Œç”¨äºè¿ç»­ç”Ÿæˆæ–‡æœ¬çš„æ¨¡å‹ã€‚ ","date":"2026-01-27","objectID":"/posts/hg_transformer/:2:1","series":["LLM"],"tags":["HuggingFace"],"title":"transformeråº“çš„åŸºç±»","uri":"/posts/hg_transformer/#modeloutput"},{"categories":null,"content":" PretraiedModelPreTrainedModelÂ æ˜¯ Hugging Face Transformers åº“ä¸­å®šä¹‰é¢„è®­ç»ƒæ¨¡å‹çš„åŸºç±»ã€‚å®ƒç»§æ‰¿äº†Â nn.Moduleï¼ŒåŒæ—¶æ··åˆäº†å‡ ä¸ªä¸åŒçš„ mixin ç±»ï¼Œå¦‚Â ModuleUtilsMixinã€GenerationMixinã€PushToHubMixinÂ å’ŒÂ PeftAdapterMixinã€‚è¿™ä¸ªåŸºç±»æä¾›äº†åˆ›å»ºå’Œå®šä¹‰é¢„è®­ç»ƒæ¨¡å‹æ‰€éœ€çš„æ ¸å¿ƒåŠŸèƒ½å’Œå±æ€§ã€‚ ä»¥ä¸‹æ˜¯Â PreTrainedModelÂ ä¸­çš„éƒ¨åˆ†ä»£ç ï¼š python class PreTrainedModel(nn.Module, ModuleUtilsMixin, GenerationMixin, PushToHubMixin, PeftAdapterMixin): config_class = None base_model_prefix = \"\" main_input_name = \"input_ids\" _auto_class = None _no_split_modules = None _skip_keys_device_placement = None _keep_in_fp32_modules = None ... def __init__(self, config: PretrainedConfig, *inputs, **kwargs): super().__init__() ... åœ¨è¿™ä¸ªåŸºç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€äº›é‡è¦çš„å±æ€§å’Œæ–¹æ³•ï¼š config_classï¼šæŒ‡å‘ç‰¹å®šé¢„è®­ç»ƒæ¨¡å‹ç±»çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ¨¡å‹çš„é…ç½®ã€‚ base_model_prefixï¼šåŸºæœ¬æ¨¡å‹å‰ç¼€ï¼Œåœ¨æ¨¡å‹çš„å‘½åä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚åœ¨åŠ è½½é¢„è®­ç»ƒæ¨¡å‹çš„æƒé‡æ—¶ä½¿ç”¨ã€‚ main_input_nameï¼šæŒ‡å®šæ¨¡å‹çš„ä¸»è¦è¾“å…¥åç§°ï¼Œé€šå¸¸æ˜¯ input_idsã€‚ _init_weightsÂ æ–¹æ³•ï¼šç”¨äºåˆå§‹åŒ–æ¨¡å‹æƒé‡çš„æ–¹æ³•ã€‚ åœ¨è¿™ä¸ªåŸºç±»ä¸­ï¼Œå¤§å¤šæ•°å±æ€§éƒ½è¢«å®šä¹‰ä¸º None æˆ–ç©ºå­—ç¬¦ä¸²ï¼Œè¿™äº›å±æ€§åœ¨å…·ä½“çš„é¢„è®­ç»ƒæ¨¡å‹ç±»ä¸­ä¼šè¢«é‡å†™æˆ–å¡«å……ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨ PretrainedModel ç±»å®šä¹‰ llama æ¨¡å‹ã€‚ python class LlamaPreTrainedModel(PreTrainedModel): config_class = LlamaConfig base_model_prefix = \"model\" supports_gradient_checkpointing = True _no_split_modules = [\"LlamaDecoderLayer\"] _skip_keys_device_placement = \"past_key_values\" _supports_flash_attn_2 = True def _init_weights(self, module): std = self.config.initializer_range if isinstance(module, nn.Linear): module.weight.data.normal_(mean=0.0, std=std) if module.bias is not None: module.bias.data.zero_() elif isinstance(module, nn.Embedding): module.weight.data.normal_(mean=0.0, std=std) if module.padding_idx is not None: module.weight.data[module.padding_idx].zero_() åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé¦–å…ˆå®šä¹‰äº†Â LlamaPreTrainedModelÂ ç±»ä½œä¸º llama æ¨¡å‹çš„åŸºç±»ï¼Œå®ƒç»§æ‰¿è‡ªÂ PreTrainedModelã€‚åœ¨è¿™ä¸ªåŸºç±»ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº†ä¸€äº› llama æ¨¡å‹ç‰¹æœ‰çš„å±æ€§ï¼Œæ¯”å¦‚é…ç½®ç±»Â LlamaConfigã€æ¨¡å‹å‰ç¼€ modelã€æ”¯æŒæ¢¯åº¦æ£€æŸ¥ç‚¹ï¼ˆgradient checkpointingï¼‰ã€è·³è¿‡çš„æ¨¡å—åˆ—è¡¨ _no_split_modules ç­‰ç­‰ã€‚ ç„¶åï¼Œæˆ‘ä»¬åŸºäºè¿™ä¸ªåŸºç±»åˆ†åˆ«å®šä¹‰äº†Â LlamaModelã€LlamaForCausalLMÂ å’ŒÂ LlamaForSequenceClassificationã€‚è¿™äº›æ¨¡å‹çš„é€»è¾‘å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š LlamaModelæ˜¯ llama æ¨¡å‹çš„ä¸»ä½“å®šä¹‰ç±»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®pytorch å®šä¹‰æ¨¡å‹çš„æ–¹æ³•ã€é»˜è®¤çš„è¾“å‡ºæ ¼å¼ä¸ºBaseModelOutputWithPastï¼› python class LlamaModel(LlamaPreTrainedModel): def __init__(self, config: LlamaConfig): super().__init__(config) self.padding_idx = config.pad_token_id self.vocab_size = config.vocab_size self.embed_tokens = nn.Embedding(config.vocab_size, config.hidden_size, self.padding_idx) self.layers = nn.ModuleList([LlamaDecoderLayer(config) for _ in range(config.num_hidden_layers)]) self.norm = LlamaRMSNorm(config.hidden_size, eps=config.rms_norm_eps) ... def forward(self, ...): ... return BaseModelOutputWithPast(...) LlamaForCausalLMÂ é€‚ç”¨äºç”Ÿæˆå¼è¯­è¨€æ¨¡å‹çš„ llama æ¨¡å‹ï¼Œå¯ä»¥çœ‹åˆ° backbone å°±æ˜¯Â LlamaModelï¼Œå¢åŠ äº†lm_headä½œä¸ºåˆ†ç±»å™¨ï¼Œè¾“å‡ºé•¿åº¦ä¸ºè¯æ±‡è¡¨è¾¾å¤§å°ï¼Œç”¨æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ã€‚è¾“å‡ºæ ¼å¼ä¸ºCausalLMOutputWithPastï¼› python class LlamaForCausalLM(LlamaPreTrainedModel): # é€‚ç”¨äºç”Ÿæˆå¼è¯­è¨€æ¨¡å‹çš„ Llama æ¨¡å‹å®šä¹‰ def __init__(self, config): super().__init__(config) self.model = LlamaModel(config) self.vocab_size = config.vocab_size self.lm_head = nn.Linear(config.hidden_size, config.vocab_size, bias=False) ... def forward(self, ...): outputs = self.model(...) ... # åå¤„ç† outputsï¼Œä»¥æ»¡è¶³è¾“å‡ºæ ¼å¼è¦æ±‚ return CausalLMOutputWithPast(...) LlamaForSequenceClassificationÂ é€‚ç”¨äºåºåˆ—åˆ†ç±»ä»»åŠ¡çš„ llama æ¨¡å‹ï¼ŒåŒæ ·æŠŠÂ LlamaModelä½œä¸º backboneï¼Œ ä¸è¿‡å¢åŠ äº†scoreä½œä¸ºåˆ†ç±»å™¨ï¼Œè¾“å‡ºé•¿åº¦ä¸º label çš„æ•°é‡ï¼Œç”¨æ¥é¢„æµ‹ç±»åˆ«ã€‚è¾“å‡ºæ ¼å¼ä¸ºSequenceClassifierOutputWithPast python class LlamaForSequenceClassification(LlamaPreTrainedModel): # é€‚ç”¨äºåºåˆ—åˆ†ç±»ä»»åŠ¡çš„ Llama æ¨¡å‹å®šä¹‰ def __init__(self, config): super().__init__(config) self.num_labels = config.num_labels self.model = LlamaModel(config) self.score = nn.Linear(config.hidden_size, self.num_labels, bias=False) ... def forward(self, ...): outputs = self.model(...) ... # åå¤„ç† outputsï¼Œä»¥æ»¡è¶³è¾“å‡ºæ ¼å¼è¦æ±‚ return SequenceClassifierOutputWithPast(...) æ¯ä¸ªå­ç±»æ ¹æ®ç‰¹å®šçš„ä»»åŠ¡æˆ–åº”ç”¨åœºæ™¯è¿›è¡Œäº†å®šåˆ¶ï¼Œä»¥æ»¡è¶³ä¸åŒä»»åŠ¡çš„éœ€æ±‚ã€‚å¦å¤–å¯ä»¥çœ‹åˆ° hf å®šä¹‰çš„æ¨¡å‹éƒ½æ˜¯ç”±ä¼ å…¥çš„Â configå‚æ•°å®šä¹‰çš„ï¼Œæ‰€ä»¥ä¸åŒæ¨¡å‹å¯¹åº”ä¸åŒçš„é…ç½®å•¦ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ç»å¸¸èƒ½çœ‹åˆ°æœ‰åƒÂ BertConfigï¼ŒGPTConfigè¿™äº›é¢„å…ˆå®šä¹‰å¥½çš„ç±»ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°é€šè¿‡æŒ‡å®šçš„å­—ç¬¦ä¸²æˆ–è€…æ–‡ä»¶è·å–å’Œä¿®æ”¹ä¸åŒçš„å‚æ•°é…ç½®ï¼š python config = BertConfig.from_pretrained( \"bert-base-uncased\" ) # Download configuration from huggingface.co and cache. config = BertConfig.from_pretrained( \"./test/saved_model/\" ) # E.g. config (or model) was saved using *save_pretrained('./test/saved_model/')* config = BertConfig.from_pretrained(\"./test/saved_model/my","date":"2026-01-27","objectID":"/posts/hg_transformer/:2:2","series":["LLM"],"tags":["HuggingFace"],"title":"transformeråº“çš„åŸºç±»","uri":"/posts/hg_transformer/#pretraiedmodel"},{"categories":null,"content":" GenerateMixinGenerationMixin æ˜¯ Hugging Face Transformers åº“ä¸­çš„ä¸€ä¸ªæ··å…¥ç±»ï¼Œä¸»è¦ç”¨äºä¸ºæ”¯æŒè‡ªå›å½’æ–‡æœ¬ç”Ÿæˆçš„æ¨¡å‹æä¾›ç»Ÿä¸€çš„ç”ŸæˆåŠŸèƒ½å’Œæ¥å£ï¼Œè¿™æ ·ä¸åŒæ¨¡å‹çš„ç”Ÿæˆæ–¹å¼å°±å¯ä»¥é«˜åº¦ä¸€è‡´å¹¶ä¸”å¯é…ç½®ã€‚ å®ƒæä¾›çš„åŠŸèƒ½åŒ…æ‹¬ï¼š generate() æ–¹æ³•ï¼šæ ¸å¿ƒç”Ÿæˆæ¥å£ï¼Œæ”¯æŒå¤šç§è§£ç ç­–ç•¥ï¼š greedy decodingï¼šç›´æ¥é€‰æ¦‚ç‡æœ€é«˜çš„ tokenã€‚ beam searchï¼šä¿æŒå¤šä¸ªå€™é€‰åºåˆ—ï¼Œæé«˜ç”Ÿæˆè´¨é‡ã€‚ samplingï¼šå¦‚ top-kã€top-pï¼ˆnucleusï¼‰é‡‡æ ·ï¼Œå¢åŠ å¤šæ ·æ€§ã€‚ GenerationConfigï¼šé€šè¿‡è¿™ä¸ªé…ç½®ç±»æ§åˆ¶ç”Ÿæˆè¡Œä¸ºï¼ˆå¦‚æœ€å¤§é•¿åº¦ã€æ¸©åº¦ã€é‡å¤æƒ©ç½šã€åœæ­¢æ¡ä»¶ç­‰ï¼‰ã€‚ å…¶ä»–è¾…åŠ©æ–¹æ³•ï¼šå¦‚è®¡ç®—ç”Ÿæˆåºåˆ—çš„è½¬ç§»åˆ†æ•°ï¼ˆtransition scoresï¼‰ï¼Œç”¨äºåˆ†æç”Ÿæˆè¿‡ç¨‹ã€‚ ","date":"2026-01-27","objectID":"/posts/hg_transformer/:2:3","series":["LLM"],"tags":["HuggingFace"],"title":"transformeråº“çš„åŸºç±»","uri":"/posts/hg_transformer/#generatemixin"},{"categories":null,"content":" è¿™ä¸€ç« æˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªè„šæœ¬æ¥éªŒè¯å¤§æ¨¡å‹çš„å¯¹è¯èƒ½åŠ› ","date":"2026-01-25","objectID":"/posts/minimind-eval/:0:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å››)ï¼šè¯„ä¼°","uri":"/posts/minimind-eval/#"},{"categories":null,"content":" è¯„ä¼°è„šæœ¬æˆ‘ä»¬é¢„è®­ç»ƒæ˜¯è®©æ¨¡å‹å­¦ä¼šè¯´è¯çš„èƒ½åŠ›ï¼Œæˆ–è€…è¯´è¯è¯­æ¥é¾™çš„èƒ½åŠ›ï¼Œç»™ä»–ä¸€ä¸ª prompt å®ƒå¯ä»¥æ¥ç€è¯´ä¸‹å»ã€‚å› æ­¤æˆ‘ä»¬åœ¨å¤„ç† prompt æ—¶å€™éœ€è¦ç¨åŠ å¤„ç†ï¼š python inputs = tokenizer.bos_tok_id + prompt è¿™æ ·æˆ‘ä»¬å°±èƒ½å¾—åˆ°ä¸€ä¸ªç±»ä¼¼ â€œ\u003cim_start\u003e ä»Šå¤©å¤©æ°”â€ è¿™æ ·çš„è¾“å…¥æ–‡æœ¬äº†ã€‚ ä¸‹ä¸€æ­¥æˆ‘ä»¬ç”¨ tokenizer æŠŠè¾“å…¥æ–‡æœ¬å˜é•¿ token åºåˆ—ï¼š python input_ids = tokenizer(inputs, return_tensors=\"pt\", truncation=True).to(args.device) åœ¨ MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šæ¨¡å‹ è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çš„æ¨¡å‹ç»§æ‰¿äº† Transformers åº“çš„ GenerationMixin è¿™ä¸ªåŸºç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„è°ƒç”¨å®ƒçš„ generate è¿™ä¸ªæ–¹æ³•æ¥ç”Ÿæˆæ–‡æœ¬ã€‚ä¸æ­¤åŒæ—¶ä¸ºäº†è®©æ¨¡å‹è¾“å‡ºæ›´æµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨å®ƒçš„ TextStream è¿™ä¸ªç±»æ¥å®ç°æµå¼è¾“å‡ºï¼š python model, tokenizer = init_model() streamer = TextStreamer(tokenizer, skip_prompt=True, skip_special_tokens=True) generated_ids = model.generate( inputs=inputs[\"input_ids\"], attention_mask=inputs[\"attention_mask\"].bool(), max_new_tokens=args.max_new_tokens, do_sample=True, streamer=streamer, pad_token_id=tokenizer.pad_token_id, eos_token_id=tokenizer.eos_token_id, top_p=args.top_p, temperature=args.temperature, repetition_penalty=1.0 ) okeyï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä¹‹å‰é¢„è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹æƒé‡è¿›è¡Œè¯„ä¼°ï¼Œä¸å‡ºæ‰€æ–™åˆçˆ† BUG äº†ã€‚ã€‚ã€‚ ","date":"2026-01-25","objectID":"/posts/minimind-eval/:1:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å››)ï¼šè¯„ä¼°","uri":"/posts/minimind-eval/#è¯„ä¼°è„šæœ¬"},{"categories":null,"content":" ä¿®æ”¹æ¨¡å‹ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ª BUG å‡ºåœ¨å“ªï¼ŒTraceback é‡Œé¢æç¤ºæˆ‘ä»¬çš„ä¿å­˜ KVcache çš„æ•°ç»„ past_key_values æ˜¯ä¸€ä¸ª DynamicCache å¯¹è±¡ï¼Œä¸èƒ½ç”¨ç´¢å¼•æ¥å–ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚ç»è¿‡ç ”ç©¶é—®é¢˜åŸæ¥æ˜¯ GenerationMixin åŸºç±»çš„ generate æ–¹æ³•ä¼šè°ƒç”¨æˆ‘ä»¬å†™å¥½çš„ forward æ–¹æ³•ï¼Œæ ¹æ® use_cache è¿™ä¸ªå‚æ•°å¸®æˆ‘ä»¬ç”Ÿæˆ past_key_valuesã€‚ç„¶è€Œæ–°ç‰ˆæœ¬çš„ Transformers åº“å¼•å…¥äº† DynamicCache ä½œä¸º KV Cache çš„æ ‡å‡†å®ç°ï¼Œç”¨äºåœ¨è‡ªå›å½’ç”Ÿæˆä¸­é«˜æ•ˆç®¡ç†æ³¨æ„åŠ›é”®å€¼ç¼“å­˜ï¼Œå½»åº•æ›¿ä»£æ—§ç‰ˆ list[tuple] æ ¼å¼ã€‚ å…ˆäº†è§£ä¸€ä¸‹ DynamicCache é‡Œéœ€è¦ç”¨åˆ°çš„æ–¹æ³•ï¼š get_seq_length(layer_idx: int) -\u003e intï¼šè·å–ç¬¬ i å±‚çš„ KV é•¿åº¦ update(key: Tensor, value: Tensor, layer_idx: int) -\u003e tupleï¼šç±»ä¼¼ä¹‹å‰çš„ torch.concat å¸®æˆ‘ä»¬æ›´æ–° key å’Œ valueï¼Œå¹¶ä¸”è¿”å›å®Œæ•´ keyã€valueã€‚ python class MiniMindModel(nn.Module): def forward(self, ...): # if past_key_values is None: # past_key_values = [None] * len(self.layers) # sta_pos = 0 if past_key_values[0] is None else past_key_values[0][0].shape[2] if past_key_values is not None and use_cache: sta_pos = past_key_values.get_seq_length() else: sta_pos = 0 if use_cache: past_key_values = DynamicCache() #... for idx, layer in enumerate(self.layers): hidden_states, past_key_values = layer( hidden_states, idx, position_embeddings, past_key_values, use_cache, attention_mask, ) class MiniMindBlock(nn.Module): def forward( self, hidden_states: torch.Tensor, layer_idx: int, position_embeddings: tuple[torch.Tensor, torch.Tensor], past_key_values: Optional[DynamicCache] = None, use_cache: bool = False, attention_mask: Optional[torch.Tensor] = None, ) -\u003e torch.Tensor: residual = hidden_states hidden_states, past_key_values = self.attention( self.attn_norm(hidden_states), layer_idx, position_embeddings, past_key_values, use_cache, attention_mask, ) hidden_states = hidden_states + residual hidden_states = hidden_states + self.mlp(self.ffn_norm(hidden_states)) return hidden_states, past_key_values class GQA(nn.Module): def forward( self, hidden_states: torch.Tensor, layer_idx: int, position_embeddings: tuple[torch.Tensor, torch.Tensor], past_key_values: Optional[DynamicCache] = None, use_cache: bool = False, attention_mask: Optional[torch.Tensor] = None, ) -\u003e tuple[torch.Tensor, Optional[torch.Tensor], Optional[tuple[torch.Tensor]]]: # if past_key_value is not None: # key = torch.cat([past_key_value[0], key], dim=2) # value = torch.cat([past_key_value[1], value], dim=2) # past_key_value = (key, value) if use_cache else None if use_cache: key, value = past_key_values.update(key, value, layer_idx) ","date":"2026-01-25","objectID":"/posts/minimind-eval/:2:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å››)ï¼šè¯„ä¼°","uri":"/posts/minimind-eval/#ä¿®æ”¹æ¨¡å‹"},{"categories":null,"content":" è¯„ä¼°ç»“æœ text ğŸ’¬: ä¸ºä»€ä¹ˆå¤©ç©ºæ˜¯è“è‰²çš„ ğŸ¤–: ï¼Ÿå¤©ç©ºä¹‹æ‰€ä»¥å‘ˆç°è“è‰²ï¼Œæ˜¯å› ä¸ºå¤§æ°”å±‚ä¸­çš„æ°®æ°”ã€æ°§æ°”ã€æ°´åˆ†å­å’Œå…¶ä»–æ°”ä½“åˆ†å­ä¼šæ•£å°„å…‰çº¿ï¼Œä½¿å¾—å¤©ç©ºçœ‹èµ·æ¥æ˜¯è“è‰²çš„ã€‚ [Speed]: 38.49 tokens/s ğŸ’¬: è¯·ç”¨Pythonå†™ä¸€ä¸ªè®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„å‡½æ•° ğŸ¤–: ã€‚å‡½æ•°å¯ä»¥ä½¿ç”¨ä»»ä½•ä¸€ä¸ªå‡½æ•°æ¥å†™ï¼Œä½†æ˜¯å®ƒéœ€è¦ä¸€ä¸ªå¤§å‹çš„å‡½æ•°æ¥å­˜å‚¨ï¼Œä¾‹å¦‚while()å‡½æ•°ã€‚å› æ­¤ï¼Œè¦ç¼–å†™ç¨‹åºæ—¶ï¼Œè¦è€ƒè™‘åˆ°å‡½æ•°çš„å¤æ‚åº¦ï¼Œå®ƒéœ€è¦å¤§è§„æ¨¡çš„å‡½æ•°æ¥å­˜å‚¨å’Œå¤„ç†æ•°æ®ã€‚ [Speed]: 38.62 tokens/s ğŸ’¬: è§£é‡Šä¸€ä¸‹\"å…‰åˆä½œç”¨\"çš„åŸºæœ¬è¿‡ç¨‹ ğŸ¤–: ã€‚å…‰åˆä½œç”¨æ˜¯æŒ‡å…‰èƒ½è½¬åŒ–ä¸ºåŒ–å­¦èƒ½çš„è¿‡ç¨‹ã€‚åœ¨å…‰åˆä½œç”¨ä¸­ï¼Œæ¤ç‰©ã€åŠ¨ç‰©å’Œå¾®ç”Ÿç‰©å°†å¤ªé˜³èƒ½è½¬åŒ–ä¸ºæœ‰æœºç‰©ï¼Œå¹¶é‡Šæ”¾å‡ºæ°§æ°”ã€‚è¿™ä¸ªè¿‡ç¨‹å‘ç”Ÿåœ¨å…‰åˆä½œç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå°†äºŒæ°§åŒ–ç¢³å’Œæ°´è½¬åŒ–ä¸ºè‘¡è„ç³–å’Œæ°§æ°”ï¼ŒåŒæ—¶é‡Šæ”¾å‡ºæ°§æ°”ã€‚ å…‰åˆä½œç”¨çš„å¦ä¸€ä¸ªåŸºæœ¬è¿‡ç¨‹æ˜¯å…‰åˆè‰²ç´ çš„åˆæˆã€‚å½“å…‰åˆè‰²ç´ é€šè¿‡å…‰èƒ½è¢«è½¬åŒ–ä¸ºåŒ–å­¦èƒ½æ—¶ï¼Œå…‰åˆè‰²ç´ å¸æ”¶å…‰èƒ½å¹¶å°†å…¶è½¬åŒ–ä¸ºåŒ–å­¦èƒ½ï¼Œä»è€Œç”Ÿæˆè‘¡è„ç³–å’Œæ°§æ°”ã€‚è¿™ä¸ªè¿‡ç¨‹åœ¨å…‰åˆä½œç”¨ä¸­èµ·åˆ°éå¸¸é‡è¦çš„ä½œç”¨ï¼Œå› ä¸ºå…‰åˆä½œç”¨å¯ä»¥äº§ç”Ÿå‡ºæ¤ç‰©å’ŒåŠ¨ç‰©ç­‰å…‰åˆç”Ÿç‰©æ‰€éœ€çš„èƒ½é‡ã€‚ [Speed]: 36.80 tokens/s ğŸ’¬: è§£é‡Šä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹  ğŸ¤–: ï¼Œå¹¶æä¾›ä¸€ä¸ªå®é™…çš„åº”ç”¨ã€‚ æœºå™¨å­¦ä¹ æ˜¯ä¸€ç§äººå·¥æ™ºèƒ½é¢†åŸŸçš„ç®—æ³•å’Œæ¨¡å‹ï¼Œé€šè¿‡è®­ç»ƒè®¡ç®—æœºç¨‹åºï¼Œä½¿å…¶èƒ½å¤Ÿä»æ•°æ®ä¸­å­¦ä¹ ï¼Œè‡ªåŠ¨æ”¹è¿›å’Œé€‚åº”ï¼Œä»è€Œå®ç°è‡ªåŠ¨åŒ–å†³ç­–å’Œé¢„æµ‹ã€‚ æ±½è½¦ï¼Œå› ä¸ºå®ƒä»¬èƒ½å¤Ÿä½¿æ±½è½¦åœ¨é“è·¯ä¸Šè¡Œé©¶ï¼Œå¹¶æé«˜è¡Œé©¶å®‰å…¨æ€§ã€‚ æœºå™¨å­¦ä¹ æ˜¯ä¸€ç§äººå·¥æ™ºèƒ½é¢†åŸŸçš„ç®—æ³•å’Œæ¨¡å‹ï¼Œé€šè¿‡è®­ç»ƒè®¡ç®—æœºç¨‹åºï¼Œä½¿å…¶èƒ½å¤Ÿä»æ•°æ®ä¸­å­¦ä¹ ï¼Œè‡ªåŠ¨æ”¹è¿›å’Œé€‚åº”ï¼Œä»è€Œå®ç°è‡ªåŠ¨åŒ–å†³ç­–å’Œé¢„æµ‹ã€‚ ä¸€ä¸ªå®é™…åº”ç”¨çš„ä¾‹å­æ˜¯å›¾åƒè¯†åˆ«ã€‚ä¾‹å¦‚ï¼Œåˆ©ç”¨æ·±åº¦å­¦ä¹ æŠ€æœ¯ï¼Œä¾‹å¦‚å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰å¯ä»¥è¯†åˆ«å›¾åƒä¸­çš„ç‰©ä½“ï¼Œå¹¶å°†å…¶åˆ†ç±»ä¸ºæ­£é¢æˆ–è´Ÿé¢ã€‚ ä¸€ä¸ªå®é™…çš„åº”ç”¨æ˜¯è‡ªåŠ¨é©¾é©¶æ±½è½¦ã€‚è‡ªåŠ¨é©¾é©¶æ±½è½¦é€šè¿‡ä½¿ç”¨ä¼ æ„Ÿå™¨å’Œç®—æ³•æ¥å®ç°è‡ªä¸»é©¾é©¶ï¼Œå¦‚æ¿€å…‰é›·è¾¾ã€æ¿€å…‰é›·è¾¾å’Œæ‘„åƒå¤´ã€‚è¿™äº›æŠ€æœ¯å¯ç”¨äºè‡ªåŠ¨é©¾é©¶ ä¸€ä¸ªå®é™…çš„åº”ç”¨æ˜¯è‡ªåŠ¨é©¾é©¶æ±½è½¦ã€‚è‡ªåŠ¨é©¾é©¶æ±½è½¦é€šè¿‡ä½¿ç”¨ä¼ æ„Ÿå™¨å’Œç®—æ³•æ¥å®ç°è‡ªä¸»é©¾é©¶ï¼Œå¦‚æ¿€å…‰é›·è¾¾ã€æ¿€å…‰é›·è¾¾å’Œæ‘„åƒå¤´ã€‚è¿™äº›æŠ€æœ¯å¯ç”¨äºè‡ªåŠ¨é©¾é©¶ æ±½è½¦ï¼Œå› ä¸ºå®ƒä»¬èƒ½å¤Ÿä½¿æ±½è½¦åœ¨é“è·¯ä¸Šè¡Œé©¶ï¼Œå¹¶æé«˜è¡Œé©¶å®‰å…¨æ€§ã€‚ [Speed]: 36.99 tokens/s å¯ä»¥çœ‹åˆ°æ¨¡å‹åœ¨æ¥é¾™æ–¹é¢è¿˜è¿‡å¾—å»ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬éœ€è¦è¿›è¡Œç›‘ç£å¾®è°ƒ SFT è¿›ä¸€æ­¥æé«˜æ¨¡å‹å¯¹è¯èƒ½åŠ›ã€‚ ","date":"2026-01-25","objectID":"/posts/minimind-eval/:3:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(å››)ï¼šè¯„ä¼°","uri":"/posts/minimind-eval/#è¯„ä¼°ç»“æœ"},{"categories":null,"content":" æ•°æ®é›† é¢„è®­ç»ƒæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ Teacher-Forcingï¼Œæ‰€ä»¥éœ€è¦çš„æ•°æ®æ ¼å¼åº”è¯¥æ˜¯åç§»çš„ input_ids å’Œ labelsã€‚ __getitem__ æ–¹æ³•æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š åœ¨ input_ids å‰ååŠ ä¸Š bos å’Œ eos ä¸¤ä¸ª special token å¯ä»¥å¸®åŠ©æ¨¡å‹ç†è§£ï¼Œå¥å­è¯¥ä»å“ªé‡Œå¼€å§‹ï¼Œåœ¨ä»€ä¹ˆæ—¶å€™ç»“æŸï¼Œä¸ä¼šåœ¨é•¿æ–‡æœ¬èƒ¡è¨€ä¹±è¯­ã€‚ ç”±äºæˆ‘ä»¬åœ¨æ¨¡å‹çš„ forward é‡Œé¢è§„å®šäº†ï¼šè®­ç»ƒæ¨¡å¼ä¸‹å°† logits å’Œ labels è¿›è¡Œåç§»ï¼Œæ‰€ä»¥åœ¨ Dataset é‡Œé¢è¿”å›çš„ x å’Œ y å°±ä¸ç”¨é¢å¤–çš„è¿›è¡Œ shift äº†ã€‚ padding è¡¥å……çš„ token ä¸å‚ä¸ loss è®¡ç®—ï¼Œæ‰€ä»¥åœ¨ labels é‡Œé¢æŠŠè¿™éƒ¨åˆ† token çš„ id è®¾ä¸º -100ï¼Œå’Œ F.cross_entropy(...,ignore_index=-100) ä¸€è‡´ã€‚ python class PreTrainDataset(Dataset): def __init__( self, tokenizer, datapath: Union[str, PathLike[str]], max_length: int = 512 ) -\u003e None: super().__init__() self.tokenizer = tokenizer self.max_length = max_length self.samples = self.load_data(datapath) def load_data(self, datapath: Union[str, PathLike[str]]) -\u003e list[str]: samples = [] with open(datapath, \"r\", encoding=\"utf-8\") as f: for line in f: data = json.loads(line.strip()) samples.append(data) return samples def __len__(self) -\u003e int: return len(self.samples) def __getitem__(self, index) -\u003e list[int]: sample = self.samples[index] encoding = self.tokenizer( str(sample[\"text\"]), max_length=self.max_length - 2, truncation=True, add_special_tokens=False, ) input_ids = torch.tensor( [self.tokenizer.bos_token_id] + encoding[\"input_ids\"] + [self.tokenizer.eos_token.id], dtype=torch.long, ) labels = input_ids.clone() labels[input_ids == self.tokenizer.pad_token_id] = -100 return input_ids, labels é¢„è®­ç»ƒçš„ä»£ç ä¸­åŒ…å«äº†å¾ˆå¤š tricksï¼Œè¿™é‡Œå…ˆæ”¾ä¸Šæºç ï¼š python def get_args() -\u003e argparse.Namespace: parser = argparse.ArgumentParser() parser.add_argument(\"--seed\", type=int, default=11711) parser.add_argument(\"--device\", type=str, default=\"cuda:0\") parser.add_argument(\"--dtype\", type=str, default=\"float16\") parser.add_argument(\"--lr\", type=float, default=1e-5) parser.add_argument(\"--epochs\", type=int, default=1) parser.add_argument(\"--max_length\", type=int, default=340) parser.add_argument(\"--batch_size\", type=int, default=32) parser.add_argument(\"--hidden_size\", type=int, default=768) parser.add_argument(\"--num_hidden_layers\", type=int, default=16) parser.add_argument(\"--log_interval\", type=int, default=100) parser.add_argument(\"--save_weight\", type=str, default=\"pretrain\") parser.add_argument(\"--save_interval\", type=int, default=1000) parser.add_argument(\"--from_resume\", type=int, default=0) parser.add_argument(\"--use_moe\", type=int, default=0, choices=[0, 1]) parser.add_argument(\"--save_dir\", type=str, default=\"../out\") parser.add_argument(\"--data_path\", type=str, default=\"dataset/pretrain_test.jsonl\") parser.add_argument(\"--from_weight\", type=str, default=\"none\") parser.add_argument(\"--use_wandb\", action=\"store_true\") parser.add_argument(\"--wandb_project\", type=str, default=\"MiniMind-Pretrain\") parser.add_argument(\"--use_compile\", default=0, type=int, choices=[0, 1]) parser.add_argument(\"--num_workers\", type=int, default=8) parser.add_argument(\"--accumulation_steps\", type=int, default=8) parser.add_argument(\"--grad_clip\", type=float, default=1.0) return parser.parse_args() def train_epoch( model: MiniMindForCausalLM, tokenizer: Tokenizer, epoch: int, loader: DataLoader, iters: int, sta_step: int = 0, wandb=None, ) -\u003e None: start_time = time.time() for step, (input_ids, labels) in tqdm(enumerate(loader, start=sta_step), total=iters, desc=f\"Epoch {epoch+1}\"): input_ids = input_ids.to(args.device) labels = labels.to(args.device) attention_mask = input_ids != tokenizer.pad_token_id lr = get_lr(epoch * iters + step, args.epochs * iters, args.lr) for param_group in optimizer.param_groups: param_group[\"lr\"] = lr with context: res = model(input_ids, attention_mask, labels) loss = res.loss / args.accumulation_steps scaler.scale(loss).backward() if (step + 1) % args.accumulation_steps == 0: scaler.unscale_(optimizer) torch.nn.utils.clip_grad_norm_(model.parameters(), args.grad_clip) scaler.step(optimizer) scaler.update() optimizer.zero_grad(set_to_none=True) if step % args.log_interval == 0 or step == iters - 1: spend_time = time.time() - start_time current_loss = loss.item() * args.accumulation_steps current_lr = optimizer.param_groups[-1][\"l","date":"2026-01-24","objectID":"/posts/minimind-pretrain/:1:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸‰)ï¼šé¢„è®­ç»ƒ","uri":"/posts/minimind-pretrain/#æ•°æ®é›†"},{"categories":null,"content":" ckp \u0026 resumeå¤§å‹æ¨¡å‹çš„è®­ç»ƒè€—æ—¶éå¸¸ä¹…ï¼Œéš¾å…ä¼šå‡ºç°é—´æ–­çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®šæ—¶å°†æ¨¡å‹å½“å‰çš„çŠ¶æ€è¿›è¡Œä¿å­˜ï¼Œå¹¶ä¸”å¯ä»¥æ¢å¤ç»§ç»­è®­ç»ƒï¼Œç±»ä¼¼â€œæ–­ç‚¹ç»­ä¼ â€ã€‚ checkpointï¼šé€šå¸¸åªåŒ…å«æ¨¡å‹çš„æƒé‡ model.state_dict()ï¼Œç”¨äºæ¨ç†æˆ–è€…ä½œä¸ºé¢„è®­ç»ƒæƒé‡è¢«åˆ«äººåŠ è½½ resumeï¼šé€šå¸¸åŒ…å«è®­ç»ƒçš„å…¨éƒ¨ä¿¡æ¯ï¼ŒåŒ…å«æ¨¡å‹æƒé‡ã€optimizer æƒé‡ã€epochã€step ç­‰ç­‰ï¼Œç”¨æ¥æ¢å¤é—´æ–­çš„è®­ç»ƒ python state_dict = model.state_dict() state_dict = {k: v.half().cpu() for k, v in state_dict.items()} ckp_tmp = ckp_path + \".tmp\" torch.save(state_dict, ckp_tmp) os.replace(ckp_tmp, ckp_path) è¿™é‡Œç”¨åˆ°å·¥ç¨‹åŒ–çš„è®¾è®¡ï¼Œå…ˆæŠŠ ckp çš„æ•°æ®å†™åˆ°ä¸´æ—¶æ–‡ä»¶é‡Œï¼Œç„¶åå†æŠŠä¸´æ—¶æ–‡ä»¶è½¬å­˜åˆ°ç›®æ ‡è·¯å¾„ï¼Œå¯ä»¥é¿å…æ„å¤–æƒ…å†µä¸‹ç•™ä¸‹åŠä¸ªæœ‰é—®é¢˜çš„ checkpointã€‚ python resume_data = { \"model\": state_dict, \"optimizer\": optimizer.state_dict(), \"epoch\": epoch, \"step\": step, \"wandb_id\": wandb_id, } for key, value in kwargs.items(): if value is not None: if hasattr(value, \"state_dict\"): resume_data[key] = value.state_dict() else: resume_data[key] = value å‰é¢è¯´åˆ° resume é‡Œé¢éœ€è¦ä¿å­˜å®Œæ•´çš„è®­ç»ƒç¯å¢ƒï¼Œé™¤äº†å‰é¢ checkpoint é‡Œé¢ä¿å­˜çš„æ¨¡å‹æƒé‡ï¼Œè¿˜éœ€è¦ä¼˜åŒ–å™¨æƒé‡ç­‰ç­‰ã€‚ ç­‰åˆ°è®­ç»ƒçš„æ—¶å€™å°±éœ€è¦æ ¹æ® args åˆ¤æ–­æ˜¯ä¸æ˜¯éœ€è¦è¯»å– resume ç»§ç»­è®­ç»ƒï¼š python ckp_data = ( lm_checkpoint(lm_config, weight=args.save_weight, save_dir=\"../checkpoints\") if args.from_resume else None ) sta_epoch, sta_step = 0, 0 if ckp_data: model.load_state_dict(ckp_data[\"model\"]) optimizer.load_state_dict(ckp_data[\"optimizer\"]) scaler.load_state_dict(ckp_data[\"scaler\"]) sta_epoch = ckp_data[\"epoch\"] sta_step = ckp_data[\"step\"] æ¯éš” args.save_interval æˆ–è€…æ¯ä¸ª batch ç»“æŸï¼Œå°±éœ€è¦ä¿å­˜å½“å‰ç¯å¢ƒï¼š python if step % args.save_interval == 0 or step == iters - 1: lm_checkpoint( lm_config, weight=args.save_weight, model=model, optimizer=optimizer, scaler=scaler, epoch=epoch, step=step, wandb=wandb, save_dir=\"../checkpoints\", ) ","date":"2026-01-24","objectID":"/posts/minimind-pretrain/:2:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸‰)ï¼šé¢„è®­ç»ƒ","uri":"/posts/minimind-pretrain/#ckp--resume"},{"categories":null,"content":" æ··åˆç²¾åº¦è®­ç»ƒ åœ¨ cs224n çš„å¸–å­ä¸­ï¼Œæˆ‘å·²ç»è¯¦ç»†è®°å½•äº†æ··åˆç²¾åº¦è®­ç»ƒçš„çŸ¥è¯†ç‚¹ï¼Œå…·ä½“å¯è§ [[cs224n-lecture12]]ã€‚ ç®€å•æ¥è¯´ï¼Œå¤§æ¨¡å‹çš„å‚æ•°å¦‚æœéƒ½ç”¨ FP32 æ¥æé«˜è®¡ç®—ç²¾åº¦ï¼Œå¯èƒ½å¯¼è‡´æ˜¾å­˜ä¸å¤Ÿå‡ºç°å†…å­˜æº¢å‡ºã€‚å¦‚æœæµ®ç‚¹æ•°ç²¾åº¦ç”¨ FP16ï¼Œæ€§èƒ½ä¸ä¼šå¤§å¹…åº¦ä¸‹é™ï¼Œä½†æ˜¯å­˜åœ¨å‚æ•°è¶…å‡º FP16 è¡¨ç¤ºèŒƒå›´çš„é—®é¢˜ã€‚è§£å†³æ–¹å¼æ˜¯ï¼šä¸€æ–¹é¢åˆ†æƒ…å†µä½¿ç”¨ FP32 æˆ–è€… FP16ï¼ˆåœ¨å®¹æ˜“å¯¼è‡´æº¢å‡ºçš„æ“ä½œä½¿ç”¨ FP16ï¼‰ï¼›ä¸€æ–¹é¢åœ¨åå‘ä¼ æ’­æ—¶å€™æŠŠ loss æ‰©å¤§ï¼Œé¿å…å‚æ•°å°äº FP16 çš„è¡¨ç¤ºèŒƒå›´ï¼Œç„¶ååœ¨æ›´æ–°å‚æ•°ä¹‹å‰å†æŠŠæ¢¯åº¦ç¼©å°ã€‚ å…·ä½“è®­ç»ƒä¸­æˆ‘ä»¬ä¸€èˆ¬éµå¾ªä¸‹é¢æ¡†æ¶ï¼š python scaler = torch.amp.GradScaler(enabled=(args.dtype == \"float16\")) with torch.amp.autocast(device, dtype=dtype): loss = model(input_ids, attention_mask, labels) scaler.scale(loss).backward() scaler.step(optimizer) scaler.update() é¦–å…ˆè¯´è¯´ torch.amp.autocast è¿™ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå®ƒåœ¨å‰å‘ä¼ æ’­ä¹Ÿå°±æ˜¯è®¡ç®— loss çš„è¿‡ç¨‹ä¸­ï¼Œåˆ¤æ–­å“ªäº›åœ°æ–¹éœ€è¦ FP16 å“ªäº›åœ°æ–¹éœ€è¦ FP32ã€‚ä¾‹å¦‚ matmul / conv / attention è¿™äº›ä¸å®¹æ˜“å¯¼è‡´å‚æ•°è®¡ç®—æº¢å‡ºçš„åœ°æ–¹ï¼Œå°±ä½¿ç”¨ FP16ï¼Œåœ¨ softmax / norm / reduction è¿™äº›åœ°æ–¹å°±é‡‡ç”¨ FP32ã€‚ å¹¶ä¸”æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œtorch.amp.autocast æ§åˆ¶çš„æ˜¯â€œç®—çš„æ—¶å€™ç”¨ä»€ä¹ˆâ€ï¼Œä¸æ˜¯â€œå­˜çš„æ—¶å€™ç”¨ä»€ä¹ˆâ€ã€‚ä¹Ÿå°±æ˜¯è¯´æ¨¡å‹å­˜å‚¨çš„å‚æ•°ï¼Œå…¶ç±»å‹å°±æ˜¯æˆ‘ä»¬ä»£ç é‡Œé¢é¢„å…ˆè§„å®šçš„ã€‚è€Œå‰å‘è®¡ç®—æ—¶å€™ç¢°åˆ° softmax è¿™æ ·çš„æ“ä½œï¼Œå®ƒä»¬ä¼šè¢«ä¸´æ—¶ cast æˆ FP16ï¼Œç„¶åç”¨ FP16 çš„ kernel è·‘ï¼›å¦‚æœç¢°åˆ°çŸ©é˜µä¹˜æ³•ï¼Œå‚ä¸çš„ tensor å°±ä¼šè¢« cast ä¸º FP32ï¼Œç„¶åç”¨ FP32 çš„ matmul kernel å¤„ç†ã€‚ æ—¢ç„¶æ²¡æœ‰æ”¹å˜å…¨éƒ¨å‚æ•°å­˜å‚¨çš„ç±»å‹ï¼Œæ¯”å¦‚è§„å®š FP32 å­˜å‚¨è¿˜æ˜¯ FP32ï¼Œé‚£å¦‚ä½•è§£å†³å ç”¨æ˜¾å­˜å¤§çš„é—®é¢˜ï¼Ÿåœ¨ç»å¤§å¤šæ•°ç°ä»£æ¨¡å‹é‡Œï¼šå‚æ•° + optimizer state â‰ˆ 30â€“40%ï¼Œè€Œæ¿€æ´»å€¼ï¼ˆactivationsï¼‰+ ä¸­é—´ç»“æœ â‰ˆ 50â€“70%ï¼Œæ‰€ä»¥ AMP èƒ½å¤§å¹…åº¦å‡å°å³°å€¼æ˜¾å­˜å ç”¨ã€‚ åœ¨åå‘ä¼ æ’­çš„æ—¶å€™ backward kernel è¢«è°ƒç”¨ï¼Œå®ƒåªèƒ½ç”¨ forward ä¿å­˜ä¸‹æ¥çš„ dtypeï¼Œå¯¹äº softmax è¿™äº›æ“ä½œ backward è‡ªç„¶ä¹Ÿæ˜¯ FP16ã€‚ torch.amp.GradScaler æ˜¯ä¸ºäº†è§£å†³åå‘ä¼ æ’­æ›´å®¹æ˜“æ¢¯åº¦æ¶ˆå¤±çš„é—®é¢˜ - æ±‚åå¯¼æ›´å®¹æ˜“å¯¼è‡´å‚æ•°æˆ–è€…æ¢¯åº¦è¶…è¿‡ FP16 çš„ç²¾åº¦ã€‚scaler.scale(loss).backward() å¯ä»¥åœ¨åå‘ä¼ æ’­ä¹‹å‰æŠŠ loss ä¹˜ä¸Šä¸€å®šå€æ•°ï¼Œè¿™æ ·æ”¾å¤§çš„ loss æ±‚åå¯¼å°±ä¸å®¹æ˜“æ¢¯åº¦æ¶ˆå¤±ï¼Œæœ€å scaler.step(optimizer) ä¼šå…ˆ unscale æ¢¯åº¦ï¼Œç„¶åæ£€æŸ¥ inf / nanï¼Œå¦‚æœå®‰å…¨åˆ™ optimizer.step() æ›´æ–°å‚æ•°ã€‚ ","date":"2026-01-24","objectID":"/posts/minimind-pretrain/:3:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸‰)ï¼šé¢„è®­ç»ƒ","uri":"/posts/minimind-pretrain/#æ··åˆç²¾åº¦è®­ç»ƒ"},{"categories":null,"content":" ä½™å¼¦è¡°é€€å­¦ä¹ ç‡lr10+0.5Ã—lrÃ—(1+cosâ¡(Ï€Ã—cnt_steptotal_step)) \\frac{\\text{lr}}{10} + 0.5 \\times \\text{lr} \\times (1+\\cos(\\pi \\times \\frac{\\text{cnt\\_step}}{\\text{total\\_step}})) 10lrâ€‹+0.5Ã—lrÃ—(1+cos(Ï€Ã—total_stepcnt_stepâ€‹)) æ ¹æ®ä½™å¼¦å‡½æ•°çš„æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º lr å‘ˆé€æ¸å‡å°çš„è¶‹åŠ¿ã€‚å‰æœŸæé«˜æ¨¡å‹å­¦ä¹ ç‡ï¼ŒåæœŸé¿å…åœ¨æœ€ä¼˜ç‚¹é™„è¿‘éœ‡è¡æ‰€æœ‰å‡å°å­¦ä¹ ç‡ã€‚ ","date":"2026-01-24","objectID":"/posts/minimind-pretrain/:4:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸‰)ï¼šé¢„è®­ç»ƒ","uri":"/posts/minimind-pretrain/#ä½™å¼¦è¡°é€€å­¦ä¹ ç‡"},{"categories":null,"content":" æ¢¯åº¦ç´¯ç§¯æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ·±åº¦å­¦ä¹ é‡Œé¢ç›¸å¯¹å¤§çš„ batch_size æ¯”å° batch_size è®­ç»ƒï¼Œloss æ›²çº¿æ›´å¹³æ»‘å™ªå£°æ›´å°ã€‚ä½†æ˜¯å¯¹äºå‚æ•°é‡å¦‚æ­¤åºå¤§çš„å¤§æ¨¡å‹ï¼Œé‡‡ç”¨å¤§ batch_size å¯èƒ½ä¼šçˆ†æ˜¾å­˜ã€‚è€Œæ¢¯åº¦ç´¯ç§¯åˆ™æ˜¯ä¸€ç§ quick fixï¼Œå®ƒåœ¨æ—¶é—´ç»´åº¦ä¸Šæ¨¡æ‹Ÿæ›´å¤§çš„ batchï¼Œå¤šæ¬¡å‰å‘ + åå‘ä¼ æ’­åªæ›´æ–°ä¸€æ¬¡å‚æ•°ã€‚ å…·ä½“çš„åšæ³•å¦‚ä¸‹ï¼š python for step, (x, y) in enumerate(dataloader): logits = model(x) loss = loss_fn(y, logits) / step_accumulations loss.backward() if (step + 1) % accum_steps == 0: optimizer.step() optimizer.zero_grad() æ³¨æ„ï¼šå½“æˆ‘ä»¬æ‰§è¡Œ backward()ï¼Œä¼šå°†å° batch çš„å¹³å‡æ¢¯åº¦æ·»åŠ åˆ°å‚æ•°çš„ .grad ä¸Šã€‚å‡å¦‚æˆ‘ä»¬æ²¡æœ‰è®© loss /= step_accumulationsï¼Œé‚£ä¹ˆç»è¿‡ k è½®æˆ‘ä»¬ä¼šå¾—åˆ°å° batch å¹³å‡æ¢¯åº¦çš„ kå€ï¼Œè€Œä¸æ˜¯å¤§ batch çš„å¹³å‡æ¢¯åº¦ã€‚ ","date":"2026-01-24","objectID":"/posts/minimind-pretrain/:5:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸‰)ï¼šé¢„è®­ç»ƒ","uri":"/posts/minimind-pretrain/#æ¢¯åº¦ç´¯ç§¯"},{"categories":null,"content":" æ¢¯åº¦è£å‰ªæ¢¯åº¦è£å‰ªæ˜¯ä¸ºäº†è§£å†³ï¼šåœ¨åå‘ä¼ æ’­æ—¶æ¢¯åº¦æ˜¯é“¾å¼ç›¸ä¹˜çš„ï¼Œæ·±å±‚æ¨¡å‹é‡Œå¯èƒ½å‡ºç° loss æˆ–è€…æ¢¯åº¦è¾¾åˆ°å¤©æ–‡æ•°å­—è¶…è¿‡èŒƒå›´çš„æƒ…å†µã€‚å®ƒå¯ä»¥åœ¨ optimizer.step() ä¹‹å‰ï¼Œå°†æ¢¯åº¦ç¼©å°ã€‚ åœ¨æ··åˆç²¾åº¦ä¸­ï¼Œéœ€è¦ç”¨ scaler å°†æ¢¯åº¦å…ˆç¼©æ”¾å›å»åœ¨è®¡ç®—æ¢¯åº¦çš„èŒƒæ•°ï¼š python scaler.scale(loss).backward() scaler.unscale_(optimizer) torch.nn.utils.clip_grad_norm_(model.parameters(), 1.0) scaler.step(optimizer) scaler.update() ","date":"2026-01-24","objectID":"/posts/minimind-pretrain/:6:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸‰)ï¼šé¢„è®­ç»ƒ","uri":"/posts/minimind-pretrain/#æ¢¯åº¦è£å‰ª"},{"categories":null,"content":" è®­ç»ƒç»§ç»­æˆ‘ä»¬æ¨¡å‹ã€æ•°æ®å’Œé¢„è®­ç»ƒçš„è„šæ­¥éƒ½å‡†å¤‡å¥½äº†ï¼Œé‚£è‚¯å®šå¾—è·‘ä¸€è½®çœ‹çœ‹æˆ‘ä»¬çš„æ¨¡å‹æ˜¯å•¥æ ·äº†ï¼Œäºæ˜¯æˆ‘åœ¨ AutoDL ç§Ÿäº†ä¸€å¼  RTX 5090 è·‘äº†ä¸¤ä¸ªå°æ—¶ã€‚ è¿™é‡Œæˆ‘æŒ‰ç…§ MiniMind æ¨èçš„å‚æ•° hidden_size=768, num_hidden_layers=16ï¼š104M çš„æ¨¡å‹ï¼Œè·‘äº†ä¸¤ä¸ª epoch æœ€ç»ˆ loss ç¨³å®šåœ¨ 1.6 ä¸Šä¸‹æˆ‘å°±ä¸æµªè´¹é©¬å†…äº†ã€‚ ä¸ºä»€ä¹ˆ LLM é¢„è®­ç»ƒé€šå¸¸æ˜¯ä¸€åˆ°ä¸¤ä¸ª epochï¼Ÿ ç°ä»£å¤§æ¨¡å‹ä¸åŒäºä»¥å‰çš„æ·±åº¦å­¦ä¹ ï¼Œè®­ç»ƒä½¿ç”¨ä¸‡äº¿çº§ token çš„å¤§è§„æ¨¡è¯­æ–™ï¼Œæ‰€ä»¥å¦‚æœå’Œä»¥å‰ DL ä¸€æ ·ç”¨å‡ åä¸Šç™¾ä¸ª epoch è¿›è¡Œè®­ç»ƒä¸€å®šä¼šè¿‡æ‹Ÿåˆã€‚ æ¨¡å‹å‚æ•°å·¨å¤§ï¼Œè®­ç»ƒçš„æˆæœ¬å¾ˆé«˜ ","date":"2026-01-24","objectID":"/posts/minimind-pretrain/:7:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸‰)ï¼šé¢„è®­ç»ƒ","uri":"/posts/minimind-pretrain/#è®­ç»ƒ"},{"categories":null,"content":"åœ¨ Transformer ä¸­åŒæ—¶è¿ç”¨äº†ä¸¤ç§æ©ç æŠ€æœ¯ï¼š ç”¨äºå¤„ç†éå®šé•¿åºåˆ—çš„ padding mask ç”¨äºé˜²æ­¢æ ‡ç­¾æ³„éœ²çš„ causal mask ","date":"2026-01-24","objectID":"/posts/tips_about_mask/:0:0","series":["Transformerç›¸å…³"],"tags":["æ©ç ","Transformer"],"title":"Mask On Transformer","uri":"/posts/tips_about_mask/#"},{"categories":null,"content":" Padding MaskNLP ä»»åŠ¡ä¸­ï¼Œè¾“å…¥çš„é•¿åº¦å¾€å¾€ä¸æ˜¯ç»Ÿä¸€çš„ï¼Œè®­ç»ƒçš„æ•°æ®é›†é‡Œé¢æ ·æœ¬é•¿åº¦å„æœ‰ä¸åŒã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨å®é™…è®­ç»ƒä¸­ï¼Œå¾€å¾€éœ€è¦æŠŠå¤šä¸ªæ•°æ®åˆæˆä¸€ä¸ªå¤§çš„ batch ä¸€åŒè®­ç»ƒï¼Œè¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨æ˜¾å¡çš„æ€§èƒ½ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä¸åŒé•¿åº¦çš„æ–‡æœ¬å¦‚ä½•åˆæˆä¸€ä¸ªå¤§ batch å‘¢ã€‚NLP çš„è§£å†³æ€è·¯æ˜¯ï¼šæŠŠæ‰€æœ‰è¾“å…¥çš„æ–‡æœ¬ç»Ÿä¸€æˆä¸€ä¸ªå›ºå®šé•¿åº¦ï¼Œå¤šä½™çš„ä½ç½®ç”¨ç‰¹æ®Šå­—ç¬¦ \u003cPAD\u003e æ¥å¡«å……ã€‚ ç”Ÿæˆ Padding Mask çš„æ€è·¯éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¾“å…¥çš„ token_id å’Œ \u003cPAD\u003e çš„ special_id è¿›è¡Œå¯¹æ¯”ï¼Œå¾—åˆ°ä¸€ä¸ªå¸ƒå°”çŸ©é˜µå°±å¥½äº†ï¼Œå®ƒè¡¨ç¤ºäº†å“ªäº› token æ˜¯å¡«å……çš„ã€‚è¿­ä»£ä¸­ä¸€ä¸ª batch é‡Œ x å½¢çŠ¶æ˜¯ [batch_size, seq_len]ï¼Œè€Œåº”ç”¨ mask æ—¶å€™ attn å½¢çŠ¶ä¸º [batch_size, n_heads, seq_len, seq_len]ï¼Œæ‰€ä»¥ä¸ºäº†å‘é‡èƒ½å¤Ÿå¹¿æ’­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠç»´åº¦å¯¹é½ã€‚ python import tokenizer for x, y in dataloader: padding_mask = (x != tokenizer.pad_idx).unsqueeze(1).unsqueeze(-1) logits = model(x, padding_mask) æˆ‘ä»¬ä½¿ç”¨ Padding Mask çš„ç›®çš„æ˜¯è®©æ¯ä¸ª token çš„æ³¨æ„åŠ›ä¸æµªè´¹åœ¨é‚£äº›æ— æ„ä¹‰çš„å¡«å……å­—ç¬¦ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ softmax ä¹‹å‰å¯¹æ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œå¤„ç†ã€‚æˆ‘ä»¬æŠŠæ³¨æ„åŠ›åˆ†æ•°é‡Œé‚£äº›ä¸å¸Œæœ›å…³æ³¨çš„éƒ¨åˆ†ï¼Œç½®ä¸ºä¸€ä¸ªéå¸¸å¤§çš„è´Ÿæ•°ï¼Œè¿™æ · softmax ä¹‹åå®ƒä»¬çš„æ³¨æ„åŠ›æƒé‡å°±ä¼šæ¥è¿‘äº 0ã€‚ python class Attention(nn.Module): def forward(self, x, padding_mask): # ... scores = torch.matmul(query, key.transpose(-1, -2)) / torch.sqrt(self.head_dim) if padding_mask is not None: scores = scores.masked_fill(~padding_mask.unsqueeze(1).unsqueeze(2), float(\"-inf\")) attn = nn.Softmax(scores, dim=-1) masked_fill å‡½æ•°ä¼šæŠŠ Padding Mask ä¸­å€¼ä¸º True çš„ä½ç½®ç½®ä¸º -INFã€‚ è¿™é‡Œéœ€è¦æ³¨æ„ masked_fill å’Œ masked_fill_ çš„åŒºåˆ«ï¼Œåè€…æ˜¯ä¸€ä¸ªåŸåœ°æ“ä½œã€‚ ","date":"2026-01-24","objectID":"/posts/tips_about_mask/:1:0","series":["Transformerç›¸å…³"],"tags":["æ©ç ","Transformer"],"title":"Mask On Transformer","uri":"/posts/tips_about_mask/#padding-mask"},{"categories":null,"content":" Causal MaskCausal Mask ä¸»è¦ç”¨äºé™å®šæ¨¡å‹çš„å¯è§†èŒƒå›´ï¼Œé˜²æ­¢æ¨¡å‹çœ‹åˆ°æœªæ¥çš„æ•°æ®ã€‚ æˆ‘ä»¬çŸ¥é“ Transformer æ˜¯ä¸€ä¸ªè‡ªå›å½’æ¨¡å‹ï¼Œå®ƒçš„é¢„è®­ç»ƒæ–¹å¼ç§°ä¸º Teacher-Forcingã€‚å¯¹äºä¸€ä¸ªæ•°æ® â€œI love eating lunchâ€ï¼Œå®ƒä¼šä¸æ–­ç”¨ â€œIâ€ é¢„æµ‹ â€œloveâ€ï¼Œç”¨ â€œI loveâ€ é¢„æµ‹ â€œeatingâ€ï¼Œç”¨ â€œI love eatingâ€ é¢„æµ‹ â€œlunchâ€ã€‚ä½†æ˜¯æˆ‘ä»¬åŒæ ·çŸ¥é“æ³¨æ„åŠ›æœºåˆ¶å®ƒçš„ä¼˜åŠ¿åœ¨äºå¯ä»¥ è§‚å¯Ÿä¸Šä¸‹æ–‡ï¼Œä¹Ÿå°±æ˜¯å®ƒä¼šé€šè¿‡ä¸‹æ–‡æ¥å¸®åŠ©ç†è§£ tokenï¼Œè¿™å°±ä¸ Teacher-Forcing å†²çªäº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ Causal Mask å› æœæ³¨æ„åŠ›æŠŠä¸‹æ–‡æ©ç æ‰ã€‚ åœ¨å…·ä½“åº”ç”¨ä¸­ï¼ŒCausal Mask å°†æ‰€æœ‰æœªæ¥çš„ token çš„æ³¨æ„åŠ›åˆ†æ•°è®¾ä¸ºè´Ÿæ— ç©·ï¼Œè¿™æ ·æ³¨æ„åŠ›æƒé‡å°±ä¼šæ¥è¿‘äº 0ï¼Œä»æ³¨æ„åŠ›æœºåˆ¶ä¸­å±è”½æ‰è¿™äº›ä»¤ç‰Œï¼Œä½¿å¾—æ¨¡å‹åœ¨è¿›è¡Œé¢„æµ‹æ—¶åªèƒ½å…³æ³¨è¿‡å»å’Œå½“å‰çš„ tokenï¼Œå¹¶ç¡®ä¿æ¨¡å‹ä»…åŸºäºæ¯ä¸ªæ—¶é—´æ­¥éª¤å¯ç”¨çš„ä¿¡æ¯è¿›è¡Œé¢„æµ‹ã€‚ python class Attention(nn.Module): def forward(self, x): # ... scores = torch.matmul(query, key.transpose(-1, -2)) / torch.sqrt(self.head_dim) causal_mask = torch.triu(torch.full((seq_len, seq_len), float(\"-inf\")), diagonal=1) scores[..., -seq_len:] += causal_mask è¿™é‡Œéœ€è¦æ³¨æ„ï¼šscores çš„å½¢çŠ¶æ˜¯ [bsize, n_heads, seq_q, seq_k] è€Œä¸æ˜¯ [bsize, n_heads, seq_len, seq_len]ã€‚ ä¸ºä»€ä¹ˆ query çš„é•¿åº¦å’Œ key çš„é•¿åº¦ä¸ä¸€æ ·ï¼Ÿæˆ‘ä»¬éœ€è¦å›å¿†ä¸€ä¸‹ KVCache çš„çŸ¥è¯†ç‚¹ã€‚ å¯¹äºç¬¬ i æ¬¡å¾ªç¯æˆ‘ä»¬è¦ç”Ÿæˆ $token_i$â€‹ï¼Œå®ƒåªéœ€è¦ $QK^T$ è¿™ä¸ªä¸‹ä¸‰è§’çŸ©é˜µçš„æœ€åä¸€è¡Œå’Œ $V$ çŸ©é˜µã€‚å†æ‹†ç»†ä¸€ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦ $Q_i$â€‹ å’Œ $K$ çŸ©é˜µç›¸ä¹˜å¾—åˆ°ä¸‹ä¸‰è§’çŸ©é˜µæœ€åä¸€è¡Œè¿˜æœ‰ $V$ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç¼“å­˜ $K$ å’Œ $V$ çŸ©é˜µã€‚ python # KVCache if past_key_value is not None: key = torch.cat([past_key_value[0], key], dim=1) value = torch.cat([past_key_value[1], value], dim=1) past_key_value = (key, value) if use_cache else None å¯ä»¥çœ‹åˆ°ï¼Œè‡ªå›å½’è®­ç»ƒåˆ©ç”¨ KVCache ä¹‹åæ¯æ¬¡ Query çš„é•¿åº¦éƒ½æ˜¯ 1ï¼Œè€Œ Key å’Œ Value çš„é•¿åº¦æ˜¯ past_len + q_lenï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹ â€œå½“å‰æ–°å¢çš„ key éƒ¨åˆ†â€ æ–½åŠ  causal ç»“æ„ï¼Œ-seq_len: æ­£å¥½é€‰ä¸­æœ€åæ–°å¢çš„é‚£ä¸€å°æ®µ keyã€‚ ","date":"2026-01-24","objectID":"/posts/tips_about_mask/:2:0","series":["Transformerç›¸å…³"],"tags":["æ©ç ","Transformer"],"title":"Mask On Transformer","uri":"/posts/tips_about_mask/#causal-mask"},{"categories":null,"content":" Tokenizer åœ¨ CS336 çš„ç¬”è®°ä¸­æˆ‘å·²ç»å®Œæ•´ä»‹ç»äº†ä¸€ä¸ª Tokenizer æ˜¯å¦‚ä½•è®­ç»ƒå¹¶ä¸”è¯»å–çš„ï¼Œè¯¦æƒ…å¯è§ cs336_assignment1ã€‚ ç®€å•æ¥è¯´ï¼Œè®­ç»ƒä¸€ä¸ª tokenizer ç»è¿‡ä»¥ä¸‹æ­¥éª¤ï¼š é€šè¿‡æ­£åˆ™åˆ†è¯ï¼Œè·å¾—æ–‡æœ¬ä¸­å…¨éƒ¨ tokenï¼Œå°†å…¶å’Œ special_tokens ä¸€èµ·è®°å½•ã€‚ ä¸æ–­æŠŠæ–‡æœ¬ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„ token_pair åˆå¹¶å¾—åˆ°æ–° tokenï¼Œç„¶åç”¨æ–° token æ›¿æ¢æ–‡æœ¬ä¸­åŸå…ˆçš„ pairã€‚ é‡å¤ä¸Šä¸€æ­¥ç›´åˆ° vocab è¾¾åˆ°æŒ‡å®šè§„æ¨¡ã€‚ ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å·²ç»åœ¨ CS336 é‡Œå®ç°è¿‡äº†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬é€šè¿‡ Huggingface çš„ tokenizers åº“ç›´æ¥ç”Ÿæˆã€‚ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘å…ˆä»å¦‚ä½•å¾—åˆ°ä¸€ä¸ª tokenizer è®²èµ·ã€‚ é¦–å…ˆ AutoTokenizer.from_pretrained(pretrained_model_name_or_path) ä¼šæ ¹æ®å‚æ•°è‡ªåŠ¨åŠ è½½å¯¹åº”çš„ tokenizerï¼Œå‡å¦‚æˆ‘ä»¬ä¼ å…¥çš„æ˜¯æ¨¡å‹åç§°ï¼Œä¾‹å¦‚ â€œbert-base-uncasedâ€ã€â€œgpt2â€ï¼Œå®ƒä¼šå…ˆè¯·æ±‚ config.jsonï¼Œä»ä¸­åˆ¤æ–­ tokenizer ç±»å‹ï¼ˆBertTokenizerã€GPT2Tokenizerã€LlamaTokenizer ç­‰ï¼‰ï¼Œç„¶åä¸‹è½½ tokenizer å¿…éœ€çš„æ–‡ä»¶åˆ°æœ¬åœ°ã€‚å‡å¦‚æˆ‘ä»¬ä¼ å…¥çš„æ˜¯ä¸€ä¸ªè·¯å¾„ï¼Œå®ƒå°±ä¼šç›´æ¥ä»æ–‡ä»¶å¤¹ä¸­è¯»å– tokenizer çš„æ ¸å¿ƒæ–‡ä»¶ï¼Œå®ƒåŒ…æ‹¬ï¼š tokenizer_config.jsonï¼šé‡Œé¢åŒ…å« special_tokensã€æ˜¯å¦è‡ªåŠ¨åœ¨æ–‡æœ¬å¼€å¤´æ·»åŠ Â bos_token ç­‰ç­‰ tokenizer çš„é…ç½®ä¿¡æ¯ã€‚ è¯æ±‡è¡¨æ–‡ä»¶ï¼ˆäºŒé€‰ä¸€ï¼‰ vocab.json + merges.txt tokenizer.jsonï¼šå®é™…ä¸Šå°±æ˜¯æŠŠ vocab.json + merges.txt æ”¾åˆ°ä¸€èµ·äº† é‚£æˆ‘ä»¬è®­ç»ƒ Tokenizer å°±æ˜¯è¦å¾—åˆ° tokenizer.json å’Œ tokenizer_config.json ä¸¤ä¸ªæ–‡ä»¶ã€‚ python VOCAB_SIZE = 6400 SAVE_PATH = \"out\" SPECIAL_TOKENS = [\"\u003c|endoftext|\u003e\", \"\u003c|im_start|\u003e\", \"\u003c|im_end|\u003e\"] def data_iterator( datapath: Union[str, PathLike[str]], max_sample: Optional[int] = None ): with open(datapath, \"r\", encoding=\"utf-8\") as f: for i, line in enumerate(f): if max_sample is not None and i == max_sample: break data = json.loads(line) yield data[\"text\"] def train_tokenizer(datapath: Union[str, PathLike[str]]): tokenizer = Tokenizer(models.BPE()) tokenizer.pre_tokenizer = pre_tokenizers.ByteLevel(add_prefix_space=False) trainer = trainers.BpeTrainer( vocab_size=VOCAB_SIZE, show_progress=True, special_tokens=SPECIAL_TOKENS, initial_alphabet=pre_tokenizers.ByteLevel.alphabet(), ) iter = data_iterator(datapath) tokenizer.train_from_iterator(iter, trainer) tokenizer.decoder = decoders.ByteLevel() tokenizer.save(path.join(SAVE_PATH, \"tokenizer.json\")) ä»£ç çš„æ ¸å¿ƒå°±æ˜¯ tokenizer.train_from_iterator è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬æä¾›ä¸€ä¸ªæ•°æ®é›†çš„è¿­ä»£å™¨è¿˜æœ‰ä¸€ä¸ªè®­ç»ƒå™¨ï¼ˆä¾‹å¦‚è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯ BPEï¼‰ï¼Œå°±å¯ä»¥ç”¨ huggingface æä¾›çš„å‡½æ•°è¿›è¡Œè®­ç»ƒäº†ã€‚è®°å¾—å‰é¢æˆ‘ä»¬è¿˜è¯´åˆ°ï¼ŒAutoTokenizer é™¤äº† tokenizer.json é‡Œé¢çš„è¯æ±‡è¡¨å’Œåˆå¹¶è§„åˆ™ï¼Œè¿˜éœ€è¦ tokenizer_config.json çš„ tokenizer é…ç½®ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¿å­˜ï¼š python config = { \"add_bos_token\": False, \"add_eos_token\": False, \"add_prefix_space\": False, \"added_tokens_decoder\": { \"0\": { \"content\": \"\u003c|endoftext|\u003e\", \"lstrip\": False, \"normalized\": False, \"rstrip\": False, \"single_word\": False, \"special\": True, }, \"1\": { \"content\": \"\u003c|im_start|\u003e\", \"lstrip\": False, \"normalized\": False, \"rstrip\": False, \"single_word\": False, \"special\": True, }, \"2\": { \"content\": \"\u003c|im_end|\u003e\", \"lstrip\": False, \"normalized\": False, \"rstrip\": False, \"single_word\": False, \"special\": True, }, }, \"additional_special_tokens\": [], \"bos_token\": \"\u003c|im_start|\u003e\", \"clean_up_tokenization_spaces\": False, \"eos_token\": \"\u003c|im_end|\u003e\", \"legacy\": True, \"model_max_length\": 32768, \"pad_token\": \"\u003c|endoftext|\u003e\", \"sp_model_kwargs\": {}, \"spaces_between_special_tokens\": False, \"tokenizer_class\": \"PreTrainedTokenizerFast\", \"unk_token\": \"\u003c|endoftext|\u003e\", \"chat_template\": \"{% if messages[0]['role'] == 'system' %}{% set system_message = messages[0]['content'] %}{{ '\u003c|im_start|\u003esystem\\\\n' + system_message + '\u003c|im_end|\u003e\\\\n' }}{% else %}{{ '\u003c|im_start|\u003esystem\\\\nYou are a helpful assistant\u003c|im_end|\u003e\\\\n' }}{% endif %}{% for message in messages %}{% set content = message['content'] %}{% if message['role'] == 'user' %}{{ '\u003c|im_start|\u003euser\\\\n' + content + '\u003c|im_end|\u003e\\\\n\u003c|im_start|\u003eassistant\\\\n' }}{% elif message['role'] == 'assistant' %}{{ content + '\u003c|im_end|\u003e' + '\\\\n' }}{% endif %}{% endfor %}\", } with open(os.path.join(SAVE_PATH, \"tokenizer_config.json\"), \"w\", encoding=\"utf-8\") as config_file: json.dump(config, config_file, ensure_ascii=False, indent=4) å­—æ®µå è§£é‡Š add_bos_token æ˜¯å¦è‡ªåŠ¨åœ¨æ–‡æœ¬å¼€å¤´æ·»åŠ Â bos_tokenã€‚ add_eos_token æ˜¯å¦è‡ªåŠ¨åœ¨æ–‡æœ¬æœ«å°¾æ·»åŠ Â eos_tokenã€‚ add_prefix_space Byte-level åˆ†è¯æ—¶æ˜¯å¦åœ¨æ–‡æœ¬å‰åŠ ç©ºæ ¼ã€‚é€šå¸¸è‹±æ–‡ä¸­å¯ç”¨ï¼ˆTrueï¼‰æ›´å¥½ï¼Œä¸­æ–‡ä¸­è®¾ä¸º Falseã€‚ added_tokens_decoder ç‰¹æ®Š token çš„è¯¦ç»†é…ç½®ã€‚åŒ…æ‹¬ token å†…å®¹ã€æ˜¯å¦ä¸ºç‰¹æ®Š tokenã€æ˜¯å¦ä»…é™å•è¯ç­‰ï¼Œkey æ˜¯å†…éƒ¨ token IDã€‚ additional_special_tokens é™¤äº†Â bos/eos/pad/unkÂ å¤–ï¼Œé¢å¤–å£°æ˜çš„ç‰¹æ®Š token åˆ—è¡¨ã€‚å½“å‰ä¸ºç©ºã€‚ bos_token èµ·å§‹ tokenï¼Œé€šå¸¸ç”¨äºè¯­è¨€æ¨¡å‹çš„å¼€å¤´æ§åˆ¶ç¬¦ã€‚ clean_up_tokenization_spaces è§£ç æ—¶æ˜¯å¦æ¸…ç† token åŒ–å¸¦æ¥çš„ç©ºæ ¼å†—ä½™ã€‚False è¡¨ç¤ºä¸æ¸…ç†ã€‚ eos_token ç»“æŸ tokenï¼Œé€šå¸¸ç”¨äºè¯­è¨€æ¨¡å‹è¾“å‡ºç»“æŸçš„æ ‡è®°ã€‚ legacy è®¾ç½®ä¸ºÂ TrueÂ å…¼å®¹æ—§ç‰ˆæœ¬Â tokenizerÂ è¡Œä¸ºã€‚æ¨èä¿æŒé»˜è®¤ã€‚ model_max_le","date":"2026-01-23","objectID":"/posts/minimind-tokenizer/:1:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(äºŒ)ï¼šTokenizer","uri":"/posts/minimind-tokenizer/#tokenizer"},{"categories":null,"content":"è¿™æ˜¯ Minimind å­¦ä¹ æŒ‡åŒ—ç³»åˆ—çš„ç¬¬ä¸€èŠ‚ï¼Œæ•´ä¸ªç³»åˆ—æˆ‘ä»¬å¤§è‡´åˆ†ä¸ºï¼š æ¨¡å‹å®ç° Tokenizer é¢„è®­ç»ƒ è¯„ä¼° ç›‘ç£å¾®è°ƒ LoRA å¼ºåŒ–å­¦ä¹  è’¸é¦ æ¨ç† ","date":"2026-01-22","objectID":"/posts/minimind-model/:0:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#"},{"categories":null,"content":" RMSNorm","date":"2026-01-22","objectID":"/posts/minimind-model/:1:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#rmsnorm"},{"categories":null,"content":" å‰èº«RMSNorm ä¹Ÿæ˜¯å½’ä¸€åŒ– Normalization çš„ä¸€ç§ï¼Œå®ƒçš„æå‡ºæ˜¯ä¸ºäº†è§£å†³è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå½“æ•°æ®åˆ†å¸ƒéå¸¸ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œæ¨¡å‹æ— æ³•å¾ˆå¥½çš„å­¦ä¹ åˆ°æ•°æ®é‡Œé¢çš„ä¿¡æ¯ã€‚ä»æ•°å­¦å±‚é¢æ¥çœ‹ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼šå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•° y=wx y=wx y=wx åœ¨åå‘ä¼ æ’­æ—¶å€™æˆ‘ä»¬éœ€è¦è®¡ç®—æŸå¤±å‡½æ•°å¯¹å‚æ•°çš„åå¯¼ $\\frac{\\partial L}{\\partial w} = \\frac{\\partial L}{\\partial y} \\times x$ï¼Œå¯ä»¥çœ‹åˆ°æ¢¯åº¦å¤§å°å’Œ x æœ‰å…³ç³»ï¼Œx è¿‡å¤§è¿‡å°éƒ½å®¹æ˜“å¯¼è‡´æ¢¯åº¦çˆ†ç‚¸æˆ–æ¶ˆå¤±ã€‚è€Œå½’ä¸€åŒ–æŠŠæ•°æ®å˜æˆå˜æˆå‡å€¼ä¸º 0ï¼Œæ ‡å‡†å·®ä¸º 1 çš„åˆ†å¸ƒï¼Œå°±å¯ä»¥ç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚ åœ¨ Transformer åŸè®ºæ–‡ä¸­å½’ä¸€åŒ–é‡‡ç”¨çš„æ˜¯ LayerNormï¼š LayerNorm(x)=xâˆ’Î¼1Hâˆ‘i=1H(xiâˆ’Î¼)2+ÏµâŠ™Î³ \\text{LayerNorm}(\\mathbf{x}) = \\frac{\\mathbf{x} - \\mu}{\\sqrt{\\frac{1}{H} \\sum_{i=1}^{H} (x_i - \\mu)^2 + \\epsilon}} \\odot \\gamma LayerNorm(x)=H1â€‹âˆ‘i=1Hâ€‹(xiâ€‹âˆ’Î¼)2+Ïµâ€‹xâˆ’Î¼â€‹âŠ™Î³ è€Œ RMSNorm åœ¨ LayerNorm çš„åŸºç¡€ä¸ŠæŠŠå‡å€¼ $\\mu$ è¿™ä¸€é¡¹å»æ‰äº†ï¼Œåœ¨å¤§å¹…å‡å°‘è®¡ç®—é‡çš„åŒæ—¶æ€§èƒ½ç›¸å·®ä¸å¤§ï¼š RMSNorm(x)=x1Hâˆ‘i=1Hxi2+ÏµâŠ™Î³ \\text{RMSNorm}(\\mathbf{x}) = \\frac{\\mathbf{x}}{\\sqrt{\\frac{1}{H} \\sum_{i=1}^{H} x_i^2 + \\epsilon}} \\odot \\gamma RMSNorm(x)=H1â€‹âˆ‘i=1Hâ€‹xi2â€‹+Ïµâ€‹xâ€‹âŠ™Î³","date":"2026-01-22","objectID":"/posts/minimind-model/:1:1","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#å‰èº«"},{"categories":null,"content":" ä»£ç  python class RMSNorm(nn.Module): def __init__( self, d_model: int, dtype: torch.dtype, device: torch.device, eps: float = 1e-8 ) -\u003e None: super(RMSNorm, self).__init__() self.eps = eps self.weight = nn.Parameter(torch.ones((d_model), dtype=dtype, device=device)) def forward(self, x: torch.Tensor) -\u003e torch.Tensor: mean = torch.mean(x.square(), dim=-1, keepdim=True) norm = x / torch.sqrt(mean + self.eps) return norm * self.weight Note å€¼å¾—æ³¨æ„ï¼Œå…¬å¼ä¸­ x éœ€è¦å’Œå‡æ–¹æ ¹ç›¸é™¤ï¼Œæ‰€ä»¥æ±‚å‡å€¼æ—¶å€™ keepdim éœ€è¦è®¾ä¸º Trueã€‚å¦åˆ™ x çš„ç»´åº¦æ˜¯ [bs, len, d_model]ï¼Œmean çš„ç»´åº¦æ˜¯ [bs, len]ï¼Œæ²¡åŠæ³•å¹¿æ’­ç›¸é™¤ã€‚ ","date":"2026-01-22","objectID":"/posts/minimind-model/:1:2","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#ä»£ç "},{"categories":null,"content":" RoPERoPE çš„åŸºç¡€çŸ¥è¯†å¯ä»¥æŸ¥çœ‹æ–‡ç« ï¼šRoPE è¿™é‡Œæˆ‘å¼•ç”¨ RoPE æ–‡ç« é‡Œé¢çš„ç¤ºä¾‹å›¾ï¼Œä¸€æ­¥æ­¥æ‹†è§£ä»£ç ï¼š æ ¹æ®å…¬å¼ $\\theta_i=10000^{-2i/d}$ï¼Œè®¡ç®— $\\theta_0$ åˆ° $\\theta_{d/2-1}$ å‘é‡ å°†å®ƒä¸ position å‘é‡ï¼ˆä¹Ÿå°±æ˜¯å…¬å¼é‡Œé¢çš„ mï¼‰ æ±‚å¤–ç§¯ ç„¶åå¯¹æ•´ä¸ªçŸ©é˜µæ±‚ä½™å¼¦å€¼ï¼ŒåŒç†æ­£å¼¦çŸ©é˜µçš„æ­¥éª¤ä¹Ÿç›¸åŒ ç”±äºæ¯æ¬¡å¯¹ Q å’Œ K çŸ©é˜µè¿›è¡Œ RoPE æ—¶ï¼Œå®ƒä»¬çš„ä½ç½®ä¿¡æ¯éƒ½æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠæ±‚æ­£ä½™å¼¦çŸ©é˜µçš„æ­¥éª¤æ‹†è§£å‡ºæ¥ã€‚ python def precompute_freqs(dim: int, end: int, base: float = 1e6): position = torch.arange(end, dtype=torch.float) freq = 1.0 / base ** (torch.arange(0, dim, 2, dtype=torch.float) / dim) sinusoid = torch.outer(position, freq) return torch.cos(sinusoid), torch.sin(sinusoid) def apply_rotary_pos_emb(qk: torch.Tensor, cos: torch.Tensor, sin: torch.Tensor): even, odd = qk[..., 0::2], qk[..., 1::2] rotated_even = even * cos - odd * sin rotated_odd = odd * cos + even * sin rotated_qk = torch.stack([rotated_even, rotated_odd], dim=-1) return rotated_qk.reshape_as(qk) ","date":"2026-01-22","objectID":"/posts/minimind-model/:2:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#rope"},{"categories":null,"content":" YaRN","date":"2026-01-22","objectID":"/posts/minimind-model/:3:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#yarn"},{"categories":null,"content":" å‰è¨€åœ¨ç ”ç©¶ YaRN ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å›åˆ° RoPE çš„å…¬å¼ï¼Œçœ‹çœ‹å®ƒå­˜åœ¨ä»€ä¹ˆé—®é¢˜ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒRoPE æœ¬è´¨ä¸Šæ˜¯åœ¨æ¯ä¸ª attention head çš„å¶æ•°/å¥‡æ•°ç»´åº¦ä¸Šåšä¸€ä¸ªäºŒç»´æ—‹è½¬ï¼Œæ—‹è½¬è§’åº¦æ˜¯ $\\theta = m \\cdot \\omega$ ã€‚ç”±äº $\\omega_i = 10000^{-2(i-1)/D}$ ï¼Œæ‰€ä»¥ï¼š åœ¨ä½ç»´åº¦ï¼ˆä¹Ÿå°±æ˜¯i æ¯”è¾ƒå°çš„ç»´åº¦ï¼‰ $\\omega_i$ æ¯”è¾ƒå¤§æ›´æ¥è¿‘äº 1ï¼Œå®ƒçš„æ—‹è½¬è§’åº¦æ˜¯ $m \\cdot 1$ã€‚m ç¨å¾®å˜åŒ–ä¸€ç‚¹ï¼Œå®ƒçš„è§’åº¦å˜åŒ–å°±éå¸¸æ˜æ˜¾ã€‚è¿™ç§é«˜é¢‘ä¿¡å·æ›´é€‚åˆæ•æ‰çŸ­è·ç¦»ã€ç²¾ç»†çš„ä½ç½®å·®å¼‚ã€‚ è€Œåœ¨é«˜çº¬åº¦çš„æ—¶å€™ $\\omega_i$ æ¯”è¾ƒå°ï¼Œé¢‘ç‡å°±ä½ï¼Œé€‚åˆæ•æ‰é•¿è·ç¦»ã€ç²—ç²’åº¦çš„ä½ç½®å…³ç³»ã€‚ å¤–æ¨æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ ç°åœ¨ç»™æ¨¡å‹ä¸€ä¸ªé•¿åº¦ä¸º 4096 çš„å¥å­ã€‚å¯¹äºç¬¬ 3000 ä¸ªè¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ å®ƒçš„æ—‹è½¬è§’åº¦ $\\theta = m \\cdot \\omega$ã€‚ç”±äº sin å’Œ cos å‡½æ•°æ˜¯å‘¨æœŸæ€§çš„ï¼Œå½“ m å˜å¾—å¾ˆå¤§æ—¶ï¼Œ$m \\cdot \\omega$ å¯èƒ½ä¼šç»•å›æ¥ã€‚ å½“ä½ç½® m è¶…å‡ºé¢„è®­ç»ƒèŒƒå›´ L æ—¶ï¼Œæ¯”å¦‚ m=L+kï¼Œæ¨¡å‹è®¡ç®—å‡ºçš„æ—‹è½¬è§’åº¦å¯èƒ½å’Œä¸€ä¸ªåœ¨é¢„è®­ç»ƒèŒƒå›´å†…çš„ä½ç½® mâ€™(mâ€™\u003cL)çš„è§’åº¦ä¸€æ¨¡ä¸€æ ·ã€‚ ç»“æœå°±æ˜¯ï¼šæ¨¡å‹ä¼šå½»åº•æ··æ·†ä½ç½®ã€‚å®ƒçœ‹åˆ°ç¬¬ 3000 ä¸ªè¯ï¼Œå¯èƒ½è§‰å¾—å®ƒçš„ä½ç½®å’Œç¬¬ 500 ä¸ªè¯å·®ä¸å¤šï¼Œå¯¼è‡´ç›¸å¯¹ä½ç½®ä¿¡æ¯å®Œå…¨é”™ä¹±ï¼Œæ³¨æ„åŠ›è®¡ç®—ä¹Ÿå°±éšä¹‹å´©æºƒï¼Œæœ€ç»ˆæ¨¡å‹æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚æˆ–è€…è¯´ï¼šåœ¨é«˜é¢‘ç»´åº¦ $\\omega_d$â€‹ å’Œ $j-i$ å¤§å¯¼è‡´ $\\Delta\\theta_d$ å¾ˆå¤§ç–¯ç‹‚ç»•åœˆï¼Œcos/sin è½åœ¨è®­ç»ƒä¸­ä»æ²¡è§è¿‡çš„ç»„åˆã€‚ ","date":"2026-01-22","objectID":"/posts/minimind-model/:3:1","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#å‰è¨€"},{"categories":null,"content":" è§£å†³æ–¹æ¡ˆYaRN çš„è§£å†³æ–¹æ³•å¹¶ä¸æ˜¯æ‹‰çŸ­é«˜é¢‘ï¼Œè€Œæ˜¯æ‹‰é•¿ä½é¢‘ï¼Œè®©ä½é¢‘åœ¨è¿œè·ç¦»è¿˜èƒ½ä¿æŒå¯åŒºåˆ†çš„ç›¸ä½ã€‚ç”±äºé«˜é¢‘åŒºåŸŸè´Ÿè´£çŸ­è·ç¦»ä¿¡æ¯ï¼Œç¼©æ”¾ä¼šå¯¼è‡´ç»†èŠ‚ä¸¢å¤±ï¼Œæ‰€ä»¥ä¸ç¼©æ”¾ï¼›æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ä½é¢‘ç»´åº¦æ—‹è½¬å˜æ…¢ï¼Œä»è€Œè¦†ç›–æ›´é•¿çš„ä½ç½®èŒƒå›´ï¼š h(Î¸d)=(1âˆ’Î³(r(d)))â‹…Î¸ds+Î³(r(d))â‹…Î¸d h(\\theta_d) = (1 - \\gamma(r(d))) \\cdot \\frac{\\theta_d}{s} + \\gamma(r(d)) \\cdot \\theta_d h(Î¸dâ€‹)=(1âˆ’Î³(r(d)))â‹…sÎ¸dâ€‹â€‹+Î³(r(d))â‹…Î¸dâ€‹ ä»¥åŠï¼š Î³(r)={0ifÂ r\u003cÎ±1ifÂ r\u003eÎ²râˆ’Î±Î²âˆ’Î±otherwise \\begin{array}{c} \\gamma(r) = \\begin{cases} 0 \u0026 \\text{if } r \u003c \\alpha \\\\ 1 \u0026 \\text{if } r \u003e \\beta \\\\ \\frac{r - \\alpha}{\\beta - \\alpha} \u0026 \\text{otherwise} \\end{cases} \\end{array} Î³(r)=â©â¨â§â€‹01Î²âˆ’Î±râˆ’Î±â€‹â€‹ifÂ r\u003cÎ±ifÂ r\u003eÎ²otherwiseâ€‹â€‹ YaRN çš„å®˜æ–¹å†™æ³•é‡‡ç”¨æ³¢é•¿æ¥åˆ¤æ–­é¢‘ç‡é«˜ä½ï¼Œç”±äºæ­£ä½™å¼¦å‡½æ•°å‘¨æœŸä¸º 2Ï€ï¼Œæ‰€ä»¥æ³¢é•¿ä¸º $\\lambda(d) = \\frac{2\\pi}{\\theta_d}$ï¼Œè€Œ $r(d)=\\frac{L}{\\lambda(d)}$ ä»£è¡¨åœ¨æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ L å†…ï¼Œè¿™ä¸ªç»´åº¦ä¼šè½¬å¤šå°‘åœˆã€‚å‡å¦‚ $r \\ll 1$ é‚£ä¹ˆè¯´æ˜ä¸€åœˆéƒ½è½¬ä¸å®Œå±äºä½é¢‘ã€‚ åœ¨é«˜é¢‘ç»´åº¦ï¼ˆå° $\\theta_d$ï¼Œå° $\\lambda_d$ï¼Œå¤§ $r(d)$ï¼‰ï¼šå‡ ä¹ä¸ç¼©æ”¾ï¼ˆä¿æŒåŸ $\\theta_d$â€‹ï¼‰ åœ¨ä½é¢‘ç»´åº¦ï¼ˆå¤§ $\\theta_d$ï¼Œå¤§ $\\lambda_d$ï¼Œå° $r(d)$ï¼‰ï¼šå®Œå…¨ç¼©æ”¾ $\\theta_d / s$ ä¸­é—´ç»´åº¦ï¼šçº¿æ€§è¿‡æ¸¡ python def precompute_freqs(dim: int, end: int, base: float = 1e6, rope_scaling: Optional[dict]=None): position = torch.arange(end, dtype=torch.float) freq, attn_factor = 1.0 / base ** (torch.arange(0, dim, 2, dtype=torch.float) / dim), 1.0 if rope_scaling is not None: beta_fast, beta_slow, factor, ori_max, attn_factor = ( rope_scaling.get(\"beta_fast\", 32.0), rope_scaling.get(\"beta_slow\", 1.0), rope_scaling.get(\"factor\", 16), rope_scaling.get(\"original_max_position_embeddings\", 2048), rope_scaling.get(\"attention_factor\", 1.0) ) if end \u003e ori_max: r = ori_max * freq / 2 * torch.pi gamma = torch.clamp((r - beta_slow) / (beta_fast - beta_slow), 0, 1) freq = (1 - gamma) * freq / factor + gamma * freq sinusoid = torch.outer(position, freq) cos = torch.cos(sinusoid) * attn_factor sin = torch.sin(sinusoid) * attn_factor return cos, sin æ³¨æ„è¿™é‡Œç”¨å›ºå®šå€¼ factor æ›¿æ¢äº†YaRN é‡Œé¢çš„ s è¿™ä¸ªæ¸©åº¦å‚æ•° ","date":"2026-01-22","objectID":"/posts/minimind-model/:3:2","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#è§£å†³æ–¹æ¡ˆ"},{"categories":null,"content":" GQA ä¼ ç»Ÿ MHA çš„åšæ³•æ˜¯æŠŠ Queryï¼ŒKey å’Œ Value éƒ½åˆ†ä¸ºå¤šä¸ªæ³¨æ„åŠ›å¤´åˆ†åˆ«è®¡ç®—ï¼Œä½†æ˜¯åœ¨å®é™…åº”ç”¨ä¸­é€šå¸¸é‡‡ç”¨ KVCache ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ï¼ŒKey å’Œ Value å ç”¨çš„æ˜¾å­˜éå¸¸å¤§ã€‚GQA çš„æ€è·¯éå¸¸ç›´æ¥ï¼Œè®© Key å’Œ Value ä¸è¦åˆ†é‚£ä¹ˆå¤šä¸ªæ³¨æ„åŠ›å¤´äº†ï¼Œä¸€ç»„ Query å…±ç”¨ä¸€ä¸ª Key å’Œ Valueã€‚è™½ç„¶æ³¨æ„åŠ›å¤´å‡å°‘äº†ï¼Œä½†æ˜¯å®é™…åº”ç”¨ä¸­æ€§èƒ½å·®è·ä¸å¤§ï¼Œæ˜¾å­˜å ç”¨æ˜¾è‘—å‡å°ã€‚ åœ¨ __init__ é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ Query çš„æ³¨æ„åŠ›å¤´æ•°å¯ä»¥æ•´é™¤ KV çš„æ³¨æ„åŠ›å¤´æ•°ï¼Œè¿™æ ·ç»„æ•°æ‰æ˜¯ä¸€ä¸ªæ•´æ•°ã€‚ python class GQA(nn.Module): def __init__(self, args: PretrainedConfig): super(GQA, self).__init__() assert args.hidden_size % args.num_attention_heads == 0 assert args.num_attention_heads \u0026 args.num_key_value_heads == 0 self.flash_attn = args.flash_attn self.n_rep = args.num_attention_heads // args.num_key_value_heads self.n_query_heads = args.num_attention_heads self.n_kv_heads = args.num_key_value_heads self.hidden_size = args.hidden_size self.head_dim = self.hidden_size // self.n_query_heads self.q_proj = nn.Linear(self.hidden_size, self.n_query_heads * self.head_dim, bias=False) self.k_proj = nn.Linear(self.hidden_size, self.n_kv_heads * self.head_dim, bias=False) self.v_proj = nn.Linear(self.hidden_size, self.n_kv_heads * self.head_dim, bias=False) ä¸ºäº†ä¿è¯ Query å’Œ KV çš„ç»´åº¦ç›¸åŒå¯ä»¥è¿›è¡ŒçŸ©é˜µä¹˜æ³•è®¡ç®—ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ KV çš„å¼ é‡è¿›è¡Œæ‰©å±•ï¼šåˆ©ç”¨ repeat_interleave è¿™ä¸ªå†…ç½®å‡½æ•°å°±å¯ä»¥åœ¨å¼ é‡çš„ç¬¬ k ç»´è¿›è¡Œé‡å¤äº†ã€‚ python def repeat_kv(x: torch.Tensor, n_rep: int) -\u003e torch.Tensor: if n_rep == 1: return x return torch.repeat_interleave(x, dim=1, repeats=n_rep) ç„¶ååœ¨ä½ç½®ç¼–ç ä¹‹åå¯¹ KV åº”ç”¨ repeat_kvè¿›è¡Œæ‰©å¼ ï¼š python # RoPE \u0026 YaRN cos, sin = position_embeddings key = apply_rotary_pos_emb(key, cos, sin) query = apply_rotary_pos_emb(key, cos, sin) key = repeat_kv(key, self.n_rep) value = repeat_kv(value, self.n_rep) # KVCache if past_key_value is not None: key = torch.cat([past_key_value[0], key], dim=2) value = torch.cat([past_key_value[1], value], dim=2) past_key_value = (key, value) if use_cache else None scores = torch.matmul(query, key.transpose(-1, -2)) / math.sqrt(self.head_dim) # Casual Mask causal_mask = torch.triu( torch.full((seq_len, seq_len), float(\"-inf\")), diagonal=1 ).to(scores.device) scores[..., -seq_len:] = scores[..., -seq_len:] + causal_m # Padding Mask if attention_mask is not None: assert attention_mask.dim() == 2 # [b, k_len] scores = scores.masked_fill(~attention_mask.unsqueeze(1).unsqueeze(2), float(\"-inf\") attn = torch.softmax(scores, dim=-1) attn = self.attn_dropout(attn) attn = torch.matmul(attn, value) Note å‡è®¾åœ¨é¢„è®­ç»ƒé˜¶æ®µï¼ˆå³ KVCache æ²¡æœ‰å¼€å¯ï¼‰ï¼Œscores çš„å½¢çŠ¶ä¸º [batch_size, num_heads, seq_len, seq_len]ï¼Œattention_mask çš„å½¢çŠ¶æ˜¯ [batch_size, seq_len]ï¼Œé‚£attention_mask.unsqueeze(1).unsqueeze(2) è€Œä¸æ˜¯ attention_mask.unsqueeze(1).unsqueeze(-1) éƒ½å¯ä»¥å—ï¼Ÿ å¹¶ä¸æ˜¯ã€‚PyTorch çš„å¹¿æ’­è§„åˆ™æ˜¯ä»å³å‘å·¦å¯¹é½ç»´åº¦ï¼Œå‡å¦‚æˆ‘ä»¬ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼š scores: [b, h, s, s ] mask: [b, 1, s, 1 ] é‚£ä¹ˆ mask çš„ s ä¼šè¢«å¯¹å…¶åˆ° scores çš„ query ç»´åº¦ï¼Œä¹Ÿå°±æ˜¯ dim=-2 çš„è¡Œç»´åº¦ã€‚è¿™æ„å‘³ç€å¦‚æœæŸä¸ª query ä½ç½® i æ˜¯ padded çš„ï¼Œé‚£ä¹ˆæ•´ä¸ªç¬¬ i è¡Œéƒ½ä¼šè¢«å¡«æˆ -infã€‚å¦‚æœæˆ‘ä»¬é‡‡ç”¨ç¬¬ä¸€ç§æ–¹æ³•ï¼Œé‚£ä¹ˆ s ä¼šè¢«å¯¹å…¶åˆ° scores çš„ dim=-1 åˆ—ç»´åº¦ï¼Œå‡å¦‚ query ä½ç½® i æ˜¯ padded é‚£ä¹ˆ scores çš„ç¬¬ i åˆ—éƒ½ä¼šè¢«å¡«å……ï¼Œè¿™æ‰æ˜¯æ­£ç¡®çš„ã€‚ ","date":"2026-01-22","objectID":"/posts/minimind-model/:4:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#gqa"},{"categories":null,"content":" FFNFFN å…¨ç§°æ˜¯ FeedforwardNetï¼Œå‰é¦ˆç¥ç»ç½‘ç»œã€‚ä»–ä¸»è¦æ˜¯å¯¹è¾“å…¥è¿›è¡Œå‡ç»´ï¼Œä»¥åŠåŠ å…¥éçº¿æ€§å˜åŒ–æ¥ä¸°å¯Œç¥ç»ç½‘ç»œçš„ç»†èŠ‚ã€‚ å‡ç»´æ˜¯ä¸€ä¸ªæ•°å­¦çš„æ¦‚å¿µï¼Œè¾¾åˆ°ä¸‰ç»´ä¹‹åå·²ç»è¶…è¿‡æˆ‘ä»¬çš„æƒ³åƒèŒƒå›´äº†æ¯•ç«Ÿéš¾ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªä¾‹å­æ¥ç±»æ¯”ä¸€ä¸‹ã€‚æˆ‘ä»¬è¯„ä»·ä¸€ä¸ªäººå¯ä»¥ä»ä¸‰ä¸ªæ–¹é¢è¿›è¡Œæ‰“åˆ†ï¼šäººå“ã€å¤–è²Œã€èƒ½åŠ›ï¼Œä½†æ˜¯å¯¹äºå…¨ä¸–ç•Œè¿™ä¹ˆå¤šçš„äººï¼Œéƒ½åªä»ä¸‰ä¸ªç»´åº¦è¿›è¡Œè¯„ä»·ï¼Œ å°±ä¼šå¤ªç¬¼ç»Ÿäº†ï¼Œå¯èƒ½æœ‰å¾ˆå¤šäººè¯„åˆ†ç›¸åŒã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠè¯„åˆ†æŒ‡æ ‡å‡ç»´ï¼Œä¾‹å¦‚å¤–è²Œå°±å¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–ä¸ºï¼šèº«é«˜ã€ä½“é‡ã€é•¿ç›¸ã€å¹´é¾„ç­‰ç­‰ã€‚æ‰€ä»¥å‰é¦ˆç¥ç»ç½‘ç»œå¯¹è¾“å…¥æ•°æ®è¿›è¡Œå‡ç»´ï¼Œå¯ä»¥ç†è§£ä¸ºæŠŠæ•°æ®é‡Œé¢çš„ä¿¡æ¯æ›´ç»†èŠ‚åŒ–ï¼ŒåŠ æ·±ç¥ç»ç½‘ç»œçš„ç†è§£ã€‚ åœ¨ç¥ç»ç½‘ç»œåŠ å…¥éçº¿æ€§æ˜¯ä¸ºäº†å¢åŠ ç½‘ç»œçš„è¡¨è¾¾èƒ½åŠ›ã€‚å¦‚æœå•ä¸€çš„åªä½¿ç”¨çº¿æ€§å˜æ¢ï¼Œå†å¤æ‚çš„ç»„åˆ $y=f_1(f_2(f_3(f_4(x)+b_4)+b_3)+b_2)+b_1$ éƒ½å¯ä»¥è¢«ç®€åŒ–ä¸º $y=f(x)+b$ è¿™ä¸ªä¸€æ¬¡å‡½æ•°ã€‚åœ¨ç½‘ç»œä¸­åŠ å…¥éçº¿æ€§å› ç´ å°±å¯ä»¥è§£å†³çº¿æ€§ä¸å¯åˆ†é—®é¢˜ï¼Œé€šè¿‡åˆ†æ®µå‡½æ•°æ¥å¢åŠ å®ƒçš„æ‹Ÿåˆèƒ½åŠ›ï¼Œæé«˜è¡¨è¾¾èƒ½åŠ›ã€‚ python class FeedForwardNet(nn.Module): def __init__(self, args: MiniMindConfig): super(FeedForwardNet, self).__init__() self.up_proj = nn.Linear(args.hidden_size, args.intermediate_size, bias=False) self.gate_proj = nn.Linear(args.hidden_size, args.intermediate_size, bias=False) self.down_proj = nn.Linear(args.intermediate_size, args.hidden_size, bias=False) self.act_fn = ACT2FN[args.hidden_act] self.dropout = nn.Dropout(args.dropout) def forward(self, x: torch.Tensor) -\u003e torch.Tensor: return self.dropout(self.down_proj(self.up_proj(x) * self.act_fn(self.gate_proj(x)))) ACT2FN æ˜¯ Transformer åº“è‡ªå¸¦çš„ä¸€ä¸ªæ¿€æ´»å‡½æ•°åº“ï¼Œå°±ä¸ç”¨æˆ‘ä»¬è‡ªå·±æ‰‹å†™äº†ã€‚ ","date":"2026-01-22","objectID":"/posts/minimind-model/:5:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#ffn"},{"categories":null,"content":" Modelç®€å•æ¥è¯´ MiniMindModel æ•´åˆäº†æ¯ä¸ªæ¨¡å—ï¼Œå¹¶ä¸”é¢„è®¡ç®—äº†æ­£ä½™å¼¦å€¼ï¼Œè¿™æ ·å°±å‡å°‘äº†é‡å¤è®¡ç®—çš„å¼€é”€ã€‚ python class MiniMindModel(nn.Module): def __init__(self, config: MiniMindConfig) -\u003e None: super(MiniMindModel, self).__init__() self.embedding = nn.Embedding(config.vocab_size, config.hidden_size) self.proj = nn.Linear(config.hidden_size, config.vocab_size) self.norm = RMSNorm(config.hidden_size) self.dropout = nn.Dropout(config.dropout) self.layers = nn.ModuleList([MiniMindBlock(config) for _ in range(config.num_hidden_layers)]) freqs_cos, freqs_sin = precompute_freqs( dim=config.hidden_size // config.num_attention_heads, end=config.max_position_embeddings, base=config.rope_theta, rope_scaling=config.rope_scaling, ) self.register_buffer(\"freqs_cos\", freqs_cos, persistent=False) self.register_buffer(\"freqs_sin\", freqs_sin, persistent=False) def forward( self, input_ids: torch.Tensor, use_cache: bool = False, padding_mask: Optional[torch.Tensor] = None, past_key_values: Optional[list[tuple[torch.Tensor, torch.Tensor]]] = None, **kwargs, ) -\u003e torch.Tensor: _, seq_len = input_ids.shape hidden_state = self.embedding(input_ids) hidden_state = self.dropout(hidden_state) if past_key_values is None: past_key_values = [None] * len(self.layers) sta_pos = 0 if past_key_values[0] is None else past_key_values[0][0].shape[2] position_embeddings = ( self.freqs_cos[sta_pos : sta_pos + seq_len, :], self.freqs_sin[sta_pos : sta_pos + seq_len, :], ) cur_key_values = [] for idx, layer in enumerate(self.layers): hidden_state, cur_key_value = layer( hidden_state, position_embeddings, past_key_values[idx], use_cache, padding_mask, ) cur_key_values.append(cur_key_value) hidden_state = self.norm(hidden_state) logits = self.proj(hidden_state) return logits, cur_key_values ç”±äºé¢„è®¡ç®—çš„æ­£ä½™å¼¦å€¼å½¢çŠ¶æ˜¯ [max_seq_len, dim // 2]ï¼Œè€Œä½¿ç”¨ KVCache ä¹‹åæ¨ç†é˜¶æ®µæ¯æ¬¡ hidden_states çš„é•¿åº¦ä¸º 1ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å–å¯¹åº”ä½ç½®çš„ cos å’Œ sin å°±å¥½äº†ï¼Œè€Œä¸æ˜¯ä¼ å…¥æ•´ä¸ª freqs_cos å’Œ freqs_sinã€‚ åœ¨ MiniMindModel ç»§æ‰¿ä¸Šæˆ‘ä»¬åˆå°è£…äº†ä¸€å±‚ MiniMindForCausalLMï¼Œå®ƒç»§æ‰¿äº† PreTrainedModel å’Œ GenerationMixin ä¸¤ä¸ªåŸºç±»ã€‚ PreTrainedModel æ˜¯ Huggingface ç”¨æ¥è§„èŒƒé¢„è®­ç»ƒæ¨¡å‹çš„ï¼Œè§„å®šäº†åˆ›å»ºå’Œå®šä¹‰é¢„è®­ç»ƒæ¨¡å‹æ‰€éœ€çš„æ ¸å¿ƒåŠŸèƒ½å’Œå±æ€§ GenerationMixin æ˜¯ Huggingface æ˜¯ç”¨æ¥è§„èŒƒç”Ÿæˆç±»æ¨¡å‹çš„åŸºç±»ï¼Œæä¾›ç»Ÿä¸€çš„ç”ŸæˆåŠŸèƒ½å’Œæ¥å£ å…·ä½“ç»†èŠ‚å¯è§æ–‡ç«  transformeråº“çš„åŸºç±»ã€‚ python class MiniMindForCausalLM(PreTrainedModel, GenerationMixin): config_class = MiniMindConfig def __init__(self, config: MiniMindConfig) -\u003e None: self.config = config super().__init__(self.config) self.model = MiniMindModel(config) self.lm_head = nn.Linear(config.hidden_size, config.vocab_size, bias=False) self.model.embedding.weight = self.lm_head.weight def forward( self, input_ids: torch.Tensor, attention_mask: Optional[torch.Tensor], labels: Optional[torch.Tensor], past_key_values: Optional[list[tuple[torch.Tensor, torch.Tensor]]] = None, use_cache: bool = False, logits_to_keep: Union[int, torch.Tensor] = 0, **kwargs, ): hidden_states, past_key_values = self.model( input_ids=input_ids, attention_mask=attention_mask, past_key_values=past_key_values, use_cache=use_cache, **kwargs, ) slice_indices = ( slice(-logits_to_keep, None) if isinstance(logits_to_keep, int) else logits_to_keep ) logits = self.lm_head(hidden_states[:, slice_indices, :]) loss = None if labels is not None: shift_logits = logits[..., :-1, :].contiguous() shift_labels = labels[..., 1:].contiguous() loss = F.cross_entropy( shift_logits.view(-1, shift_logits.size(-1)), shift_labels.view(-1), ignore_index=-100, ) return CausalLMOutputWithPast( loss=loss, logits=logits, past_key_values=past_key_values, hidden_states=hidden_states, ) å½“å¤„äºè®­ç»ƒæ¨¡å¼çš„æ—¶å€™ï¼Œç”±äºå› æœè¯­è¨€æ¨¡å‹çš„è®­ç»ƒé€»è¾‘æ˜¯ é¢„æµ‹ä¸‹ä¸€ä¸ªè¯ï¼ˆNext Token Predictionï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠ logits å’Œlabels é”™ä½ï¼Œå°†â€œæ¨¡å‹çš„é¢„æµ‹ç»“æœâ€å’Œâ€œçœŸå®çš„æ ‡å‡†ç­”æ¡ˆâ€å¯¹é½ã€‚ python shift_logits = logits[..., :-1, :].contiguous() shift_labels = labels[..., 1:].contiguous() å½“å¤„äºæ¨ç†æ¨¡å¼æ—¶å€™ï¼Œç”±äº token éœ€è¦ä¸€ä¸ªä¸€ä¸ªç”Ÿæˆï¼Œæˆ‘ä»¬æ¯æ¬¡åªéœ€è¦æœ€åä¸€ä¸ª token çš„éšè—çŠ¶æ€ï¼Œæ‰€ä»¥å¯ä»¥æŒ‡å®š logits_to_keepï¼Œä¸€èˆ¬è®¾ä¸º 1ã€‚ python slice_indices = slice(-logits_to_keep, None) if isinstance(logits_to_keep, int) else logits_to_keep logits = self.lm_head(hidden_states[:, slice_indices, :]) ","date":"2026-01-22","objectID":"/posts/minimind-model/:6:0","series":["minimind"],"tags":["å¤§æ¨¡å‹","æ·±åº¦å­¦ä¹ "],"title":"MiniMind å­¦ä¹ æŒ‡åŒ—(ä¸€)ï¼šModel","uri":"/posts/minimind-model/#model"},{"categories":null,"content":" æ•°ç»„","date":"2026-01-21","objectID":"/posts/algorithm/:1:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#æ•°ç»„"},{"categories":null,"content":" äºŒåˆ†æŸ¥æ‰¾äºŒåˆ†æŸ¥æ‰¾çš„åŸç†å°±æ˜¯ä¸æ–­æ”¶ç¼© left å’Œ right æŒ‡é’ˆï¼Œä½¿å¾—æœ€ç»ˆå¸Œæœ›æ‰¾çš„çš„å…ƒç´  target åœ¨ä»–ä»¬å›´æˆçš„åŒºåŸŸé‡Œã€‚æ‰€ä»¥è¿™å°±å¼•ç”³å‡ºä¸¤ç§å†™æ³•ï¼Œå¦‚æœåŒºåŸŸæ˜¯å·¦é—­å³é—­çš„ [left, right]ï¼Œé‚£ä¹ˆæœ€ç»ˆ target å°±æ˜¯ left==right çš„é‚£ä¸ªå€¼ï¼›å¦‚æœæ˜¯å·¦é—­å³å¼€çš„ [left, right)ï¼Œé‚£ä¹ˆå½“ left+1==right æ—¶å€™ target å°±åœ¨å·¦ç«¯ç‚¹çš„ä½ç½®ã€‚ å·¦é—­å³å¼€ å¦‚æœ left==rightï¼Œé‚£ä¹ˆè¯´æ˜å·²ç»æ²¡æœ‰æ„ä¹‰ target ä¸å­˜åœ¨äº†ï¼Œæ‰€ä»¥å¾ªç¯æ¡ä»¶åº”è¯¥æ˜¯ while left \u003c rightã€‚ å‡ºç° A[mid] \u003e target æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ”¶ç¼©å³è¾¹ç•Œã€‚ç”±äºè§„å®šäº†å³è¾¹ç•Œæ˜¯å¼€çš„ï¼Œæ‰€ä»¥å¯ä»¥è®© right=A[mid]ã€‚ python def binaery_search(arr, tgt): l, r = 0, len(arr) while l \u003c r: mid = (l + r) \u003e\u003e 1 if arr[mid] == tgt: return mid elif arr[mid] \u003e tgt: r = mid else: l = mid + 1 return -1 å·¦é—­å³é—­ ç”±äºå³ç«¯ç‚¹æ˜¯é—­çš„ï¼Œæ‰€ä»¥ left==right æ—¶ target ä»ç„¶å¯èƒ½å­˜åœ¨ï¼Œéœ€è¦ while left \u003c= right åˆ¤æ–­ å‡ºç° A[mid] \u003e target æ—¶å€™ï¼Œæˆ‘ä»¬æ˜ç¡® A[mid] ä¸å¯èƒ½ä¸º target äº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¾åœ¨å³ç«¯ç‚¹ python def binaery_search(arr, tgt): l, r = 0, len(arr)-1 while l \u003c= r: mid = (l + r) \u003e\u003e 1 if arr[mid] == tgt: return mid elif arr[mid] \u003e tgt: r = mid + 1 else: l = mid + 1 return l lower_boundlower_bound æ ‡å‡†å®šä¹‰æ˜¯ï¼šåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ A[0â€¦nâˆ’1] ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå¤§ç­‰äº x çš„ä½ç½®ä¸‹æ ‡ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨å·¦é—­å³å¼€åŒºé—´ [left, right)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿æŒä»¥ä¸‹çš„å¾ªç¯ä¸å˜é‡ï¼š åŒºé—´å·¦ä¾§ $[0, l)$ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003c x åŒºé—´å³ä¾§ $[r, n)$ ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003e x python def lower_bound(nums, tgt): l, r = 0, len(nums) while upper_boundupper_bound æ ‡å‡†å®šä¹‰æ˜¯ï¼šåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ A[0â€¦nâˆ’1] ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªä¸¥æ ¼å¤§äº x çš„ä½ç½®ä¸‹æ ‡ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨å·¦é—­å³å¼€åŒºé—´ [left, right)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿æŒä»¥ä¸‹çš„å¾ªç¯ä¸å˜é‡ï¼š åŒºé—´å·¦ä¾§ $[0, l)$ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] â‰¤ x åŒºé—´å³ä¾§ $[r, n)$ ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003e x å› æ­¤ï¼ŒçœŸæ­£çš„ upper_bound ä½ç½®ä¸€å®šåœ¨ $[l, r)$ ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸æ–­æ”¶ç¼© left å’Œ right å°±èƒ½æ‰¾åˆ° upper_boundã€‚ python def upper_bound(nums, tgt): l, r = 0, len(nums) while l \u003c r: mid = (l + r) \u003e\u003e 1 if nums[mid] \u003e tgt: r = mid else: l = mid + 1 return l ","date":"2026-01-21","objectID":"/posts/algorithm/:1:1","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#äºŒåˆ†æŸ¥æ‰¾"},{"categories":null,"content":" äºŒåˆ†æŸ¥æ‰¾äºŒåˆ†æŸ¥æ‰¾çš„åŸç†å°±æ˜¯ä¸æ–­æ”¶ç¼© left å’Œ right æŒ‡é’ˆï¼Œä½¿å¾—æœ€ç»ˆå¸Œæœ›æ‰¾çš„çš„å…ƒç´  target åœ¨ä»–ä»¬å›´æˆçš„åŒºåŸŸé‡Œã€‚æ‰€ä»¥è¿™å°±å¼•ç”³å‡ºä¸¤ç§å†™æ³•ï¼Œå¦‚æœåŒºåŸŸæ˜¯å·¦é—­å³é—­çš„ [left, right]ï¼Œé‚£ä¹ˆæœ€ç»ˆ target å°±æ˜¯ left==right çš„é‚£ä¸ªå€¼ï¼›å¦‚æœæ˜¯å·¦é—­å³å¼€çš„ [left, right)ï¼Œé‚£ä¹ˆå½“ left+1==right æ—¶å€™ target å°±åœ¨å·¦ç«¯ç‚¹çš„ä½ç½®ã€‚ å·¦é—­å³å¼€ å¦‚æœ left==rightï¼Œé‚£ä¹ˆè¯´æ˜å·²ç»æ²¡æœ‰æ„ä¹‰ target ä¸å­˜åœ¨äº†ï¼Œæ‰€ä»¥å¾ªç¯æ¡ä»¶åº”è¯¥æ˜¯ while left \u003c rightã€‚ å‡ºç° A[mid] \u003e target æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ”¶ç¼©å³è¾¹ç•Œã€‚ç”±äºè§„å®šäº†å³è¾¹ç•Œæ˜¯å¼€çš„ï¼Œæ‰€ä»¥å¯ä»¥è®© right=A[mid]ã€‚ python def binaery_search(arr, tgt): l, r = 0, len(arr) while l \u003c r: mid = (l + r) \u003e\u003e 1 if arr[mid] == tgt: return mid elif arr[mid] \u003e tgt: r = mid else: l = mid + 1 return -1 å·¦é—­å³é—­ ç”±äºå³ç«¯ç‚¹æ˜¯é—­çš„ï¼Œæ‰€ä»¥ left==right æ—¶ target ä»ç„¶å¯èƒ½å­˜åœ¨ï¼Œéœ€è¦ while left \u003c= right åˆ¤æ–­ å‡ºç° A[mid] \u003e target æ—¶å€™ï¼Œæˆ‘ä»¬æ˜ç¡® A[mid] ä¸å¯èƒ½ä¸º target äº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¾åœ¨å³ç«¯ç‚¹ python def binaery_search(arr, tgt): l, r = 0, len(arr)-1 while l \u003c= r: mid = (l + r) \u003e\u003e 1 if arr[mid] == tgt: return mid elif arr[mid] \u003e tgt: r = mid + 1 else: l = mid + 1 return l lower_boundlower_bound æ ‡å‡†å®šä¹‰æ˜¯ï¼šåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ A[0â€¦nâˆ’1] ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå¤§ç­‰äº x çš„ä½ç½®ä¸‹æ ‡ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨å·¦é—­å³å¼€åŒºé—´ [left, right)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿æŒä»¥ä¸‹çš„å¾ªç¯ä¸å˜é‡ï¼š åŒºé—´å·¦ä¾§ $[0, l)$ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003c x åŒºé—´å³ä¾§ $[r, n)$ ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003e x python def lower_bound(nums, tgt): l, r = 0, len(nums) while upper_boundupper_bound æ ‡å‡†å®šä¹‰æ˜¯ï¼šåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ A[0â€¦nâˆ’1] ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªä¸¥æ ¼å¤§äº x çš„ä½ç½®ä¸‹æ ‡ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨å·¦é—­å³å¼€åŒºé—´ [left, right)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿æŒä»¥ä¸‹çš„å¾ªç¯ä¸å˜é‡ï¼š åŒºé—´å·¦ä¾§ $[0, l)$ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] â‰¤ x åŒºé—´å³ä¾§ $[r, n)$ ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003e x å› æ­¤ï¼ŒçœŸæ­£çš„ upper_bound ä½ç½®ä¸€å®šåœ¨ $[l, r)$ ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸æ–­æ”¶ç¼© left å’Œ right å°±èƒ½æ‰¾åˆ° upper_boundã€‚ python def upper_bound(nums, tgt): l, r = 0, len(nums) while l \u003c r: mid = (l + r) \u003e\u003e 1 if nums[mid] \u003e tgt: r = mid else: l = mid + 1 return l ","date":"2026-01-21","objectID":"/posts/algorithm/:1:1","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#å·¦é—­å³å¼€"},{"categories":null,"content":" äºŒåˆ†æŸ¥æ‰¾äºŒåˆ†æŸ¥æ‰¾çš„åŸç†å°±æ˜¯ä¸æ–­æ”¶ç¼© left å’Œ right æŒ‡é’ˆï¼Œä½¿å¾—æœ€ç»ˆå¸Œæœ›æ‰¾çš„çš„å…ƒç´  target åœ¨ä»–ä»¬å›´æˆçš„åŒºåŸŸé‡Œã€‚æ‰€ä»¥è¿™å°±å¼•ç”³å‡ºä¸¤ç§å†™æ³•ï¼Œå¦‚æœåŒºåŸŸæ˜¯å·¦é—­å³é—­çš„ [left, right]ï¼Œé‚£ä¹ˆæœ€ç»ˆ target å°±æ˜¯ left==right çš„é‚£ä¸ªå€¼ï¼›å¦‚æœæ˜¯å·¦é—­å³å¼€çš„ [left, right)ï¼Œé‚£ä¹ˆå½“ left+1==right æ—¶å€™ target å°±åœ¨å·¦ç«¯ç‚¹çš„ä½ç½®ã€‚ å·¦é—­å³å¼€ å¦‚æœ left==rightï¼Œé‚£ä¹ˆè¯´æ˜å·²ç»æ²¡æœ‰æ„ä¹‰ target ä¸å­˜åœ¨äº†ï¼Œæ‰€ä»¥å¾ªç¯æ¡ä»¶åº”è¯¥æ˜¯ while left \u003c rightã€‚ å‡ºç° A[mid] \u003e target æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ”¶ç¼©å³è¾¹ç•Œã€‚ç”±äºè§„å®šäº†å³è¾¹ç•Œæ˜¯å¼€çš„ï¼Œæ‰€ä»¥å¯ä»¥è®© right=A[mid]ã€‚ python def binaery_search(arr, tgt): l, r = 0, len(arr) while l \u003c r: mid = (l + r) \u003e\u003e 1 if arr[mid] == tgt: return mid elif arr[mid] \u003e tgt: r = mid else: l = mid + 1 return -1 å·¦é—­å³é—­ ç”±äºå³ç«¯ç‚¹æ˜¯é—­çš„ï¼Œæ‰€ä»¥ left==right æ—¶ target ä»ç„¶å¯èƒ½å­˜åœ¨ï¼Œéœ€è¦ while left \u003c= right åˆ¤æ–­ å‡ºç° A[mid] \u003e target æ—¶å€™ï¼Œæˆ‘ä»¬æ˜ç¡® A[mid] ä¸å¯èƒ½ä¸º target äº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¾åœ¨å³ç«¯ç‚¹ python def binaery_search(arr, tgt): l, r = 0, len(arr)-1 while l \u003c= r: mid = (l + r) \u003e\u003e 1 if arr[mid] == tgt: return mid elif arr[mid] \u003e tgt: r = mid + 1 else: l = mid + 1 return l lower_boundlower_bound æ ‡å‡†å®šä¹‰æ˜¯ï¼šåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ A[0â€¦nâˆ’1] ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå¤§ç­‰äº x çš„ä½ç½®ä¸‹æ ‡ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨å·¦é—­å³å¼€åŒºé—´ [left, right)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿æŒä»¥ä¸‹çš„å¾ªç¯ä¸å˜é‡ï¼š åŒºé—´å·¦ä¾§ $[0, l)$ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003c x åŒºé—´å³ä¾§ $[r, n)$ ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003e x python def lower_bound(nums, tgt): l, r = 0, len(nums) while upper_boundupper_bound æ ‡å‡†å®šä¹‰æ˜¯ï¼šåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ A[0â€¦nâˆ’1] ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªä¸¥æ ¼å¤§äº x çš„ä½ç½®ä¸‹æ ‡ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨å·¦é—­å³å¼€åŒºé—´ [left, right)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿æŒä»¥ä¸‹çš„å¾ªç¯ä¸å˜é‡ï¼š åŒºé—´å·¦ä¾§ $[0, l)$ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] â‰¤ x åŒºé—´å³ä¾§ $[r, n)$ ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003e x å› æ­¤ï¼ŒçœŸæ­£çš„ upper_bound ä½ç½®ä¸€å®šåœ¨ $[l, r)$ ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸æ–­æ”¶ç¼© left å’Œ right å°±èƒ½æ‰¾åˆ° upper_boundã€‚ python def upper_bound(nums, tgt): l, r = 0, len(nums) while l \u003c r: mid = (l + r) \u003e\u003e 1 if nums[mid] \u003e tgt: r = mid else: l = mid + 1 return l ","date":"2026-01-21","objectID":"/posts/algorithm/:1:1","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#å·¦é—­å³é—­"},{"categories":null,"content":" äºŒåˆ†æŸ¥æ‰¾äºŒåˆ†æŸ¥æ‰¾çš„åŸç†å°±æ˜¯ä¸æ–­æ”¶ç¼© left å’Œ right æŒ‡é’ˆï¼Œä½¿å¾—æœ€ç»ˆå¸Œæœ›æ‰¾çš„çš„å…ƒç´  target åœ¨ä»–ä»¬å›´æˆçš„åŒºåŸŸé‡Œã€‚æ‰€ä»¥è¿™å°±å¼•ç”³å‡ºä¸¤ç§å†™æ³•ï¼Œå¦‚æœåŒºåŸŸæ˜¯å·¦é—­å³é—­çš„ [left, right]ï¼Œé‚£ä¹ˆæœ€ç»ˆ target å°±æ˜¯ left==right çš„é‚£ä¸ªå€¼ï¼›å¦‚æœæ˜¯å·¦é—­å³å¼€çš„ [left, right)ï¼Œé‚£ä¹ˆå½“ left+1==right æ—¶å€™ target å°±åœ¨å·¦ç«¯ç‚¹çš„ä½ç½®ã€‚ å·¦é—­å³å¼€ å¦‚æœ left==rightï¼Œé‚£ä¹ˆè¯´æ˜å·²ç»æ²¡æœ‰æ„ä¹‰ target ä¸å­˜åœ¨äº†ï¼Œæ‰€ä»¥å¾ªç¯æ¡ä»¶åº”è¯¥æ˜¯ while left \u003c rightã€‚ å‡ºç° A[mid] \u003e target æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ”¶ç¼©å³è¾¹ç•Œã€‚ç”±äºè§„å®šäº†å³è¾¹ç•Œæ˜¯å¼€çš„ï¼Œæ‰€ä»¥å¯ä»¥è®© right=A[mid]ã€‚ python def binaery_search(arr, tgt): l, r = 0, len(arr) while l \u003c r: mid = (l + r) \u003e\u003e 1 if arr[mid] == tgt: return mid elif arr[mid] \u003e tgt: r = mid else: l = mid + 1 return -1 å·¦é—­å³é—­ ç”±äºå³ç«¯ç‚¹æ˜¯é—­çš„ï¼Œæ‰€ä»¥ left==right æ—¶ target ä»ç„¶å¯èƒ½å­˜åœ¨ï¼Œéœ€è¦ while left \u003c= right åˆ¤æ–­ å‡ºç° A[mid] \u003e target æ—¶å€™ï¼Œæˆ‘ä»¬æ˜ç¡® A[mid] ä¸å¯èƒ½ä¸º target äº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¾åœ¨å³ç«¯ç‚¹ python def binaery_search(arr, tgt): l, r = 0, len(arr)-1 while l \u003c= r: mid = (l + r) \u003e\u003e 1 if arr[mid] == tgt: return mid elif arr[mid] \u003e tgt: r = mid + 1 else: l = mid + 1 return l lower_boundlower_bound æ ‡å‡†å®šä¹‰æ˜¯ï¼šåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ A[0â€¦nâˆ’1] ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå¤§ç­‰äº x çš„ä½ç½®ä¸‹æ ‡ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨å·¦é—­å³å¼€åŒºé—´ [left, right)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿æŒä»¥ä¸‹çš„å¾ªç¯ä¸å˜é‡ï¼š åŒºé—´å·¦ä¾§ $[0, l)$ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003c x åŒºé—´å³ä¾§ $[r, n)$ ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003e x python def lower_bound(nums, tgt): l, r = 0, len(nums) while upper_boundupper_bound æ ‡å‡†å®šä¹‰æ˜¯ï¼šåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ A[0â€¦nâˆ’1] ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªä¸¥æ ¼å¤§äº x çš„ä½ç½®ä¸‹æ ‡ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨å·¦é—­å³å¼€åŒºé—´ [left, right)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿æŒä»¥ä¸‹çš„å¾ªç¯ä¸å˜é‡ï¼š åŒºé—´å·¦ä¾§ $[0, l)$ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] â‰¤ x åŒºé—´å³ä¾§ $[r, n)$ ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003e x å› æ­¤ï¼ŒçœŸæ­£çš„ upper_bound ä½ç½®ä¸€å®šåœ¨ $[l, r)$ ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸æ–­æ”¶ç¼© left å’Œ right å°±èƒ½æ‰¾åˆ° upper_boundã€‚ python def upper_bound(nums, tgt): l, r = 0, len(nums) while l \u003c r: mid = (l + r) \u003e\u003e 1 if nums[mid] \u003e tgt: r = mid else: l = mid + 1 return l ","date":"2026-01-21","objectID":"/posts/algorithm/:1:1","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#lower_bound"},{"categories":null,"content":" äºŒåˆ†æŸ¥æ‰¾äºŒåˆ†æŸ¥æ‰¾çš„åŸç†å°±æ˜¯ä¸æ–­æ”¶ç¼© left å’Œ right æŒ‡é’ˆï¼Œä½¿å¾—æœ€ç»ˆå¸Œæœ›æ‰¾çš„çš„å…ƒç´  target åœ¨ä»–ä»¬å›´æˆçš„åŒºåŸŸé‡Œã€‚æ‰€ä»¥è¿™å°±å¼•ç”³å‡ºä¸¤ç§å†™æ³•ï¼Œå¦‚æœåŒºåŸŸæ˜¯å·¦é—­å³é—­çš„ [left, right]ï¼Œé‚£ä¹ˆæœ€ç»ˆ target å°±æ˜¯ left==right çš„é‚£ä¸ªå€¼ï¼›å¦‚æœæ˜¯å·¦é—­å³å¼€çš„ [left, right)ï¼Œé‚£ä¹ˆå½“ left+1==right æ—¶å€™ target å°±åœ¨å·¦ç«¯ç‚¹çš„ä½ç½®ã€‚ å·¦é—­å³å¼€ å¦‚æœ left==rightï¼Œé‚£ä¹ˆè¯´æ˜å·²ç»æ²¡æœ‰æ„ä¹‰ target ä¸å­˜åœ¨äº†ï¼Œæ‰€ä»¥å¾ªç¯æ¡ä»¶åº”è¯¥æ˜¯ while left \u003c rightã€‚ å‡ºç° A[mid] \u003e target æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ”¶ç¼©å³è¾¹ç•Œã€‚ç”±äºè§„å®šäº†å³è¾¹ç•Œæ˜¯å¼€çš„ï¼Œæ‰€ä»¥å¯ä»¥è®© right=A[mid]ã€‚ python def binaery_search(arr, tgt): l, r = 0, len(arr) while l \u003c r: mid = (l + r) \u003e\u003e 1 if arr[mid] == tgt: return mid elif arr[mid] \u003e tgt: r = mid else: l = mid + 1 return -1 å·¦é—­å³é—­ ç”±äºå³ç«¯ç‚¹æ˜¯é—­çš„ï¼Œæ‰€ä»¥ left==right æ—¶ target ä»ç„¶å¯èƒ½å­˜åœ¨ï¼Œéœ€è¦ while left \u003c= right åˆ¤æ–­ å‡ºç° A[mid] \u003e target æ—¶å€™ï¼Œæˆ‘ä»¬æ˜ç¡® A[mid] ä¸å¯èƒ½ä¸º target äº†ï¼Œæ‰€ä»¥ä¸èƒ½æ”¾åœ¨å³ç«¯ç‚¹ python def binaery_search(arr, tgt): l, r = 0, len(arr)-1 while l \u003c= r: mid = (l + r) \u003e\u003e 1 if arr[mid] == tgt: return mid elif arr[mid] \u003e tgt: r = mid + 1 else: l = mid + 1 return l lower_boundlower_bound æ ‡å‡†å®šä¹‰æ˜¯ï¼šåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ A[0â€¦nâˆ’1] ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå¤§ç­‰äº x çš„ä½ç½®ä¸‹æ ‡ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨å·¦é—­å³å¼€åŒºé—´ [left, right)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿æŒä»¥ä¸‹çš„å¾ªç¯ä¸å˜é‡ï¼š åŒºé—´å·¦ä¾§ $[0, l)$ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003c x åŒºé—´å³ä¾§ $[r, n)$ ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003e x python def lower_bound(nums, tgt): l, r = 0, len(nums) while upper_boundupper_bound æ ‡å‡†å®šä¹‰æ˜¯ï¼šåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ A[0â€¦nâˆ’1] ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªä¸¥æ ¼å¤§äº x çš„ä½ç½®ä¸‹æ ‡ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨å·¦é—­å³å¼€åŒºé—´ [left, right)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¿æŒä»¥ä¸‹çš„å¾ªç¯ä¸å˜é‡ï¼š åŒºé—´å·¦ä¾§ $[0, l)$ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] â‰¤ x åŒºé—´å³ä¾§ $[r, n)$ ä¸­çš„å…ƒç´ ä¸€å®šæ»¡è¶³ A[i] \u003e x å› æ­¤ï¼ŒçœŸæ­£çš„ upper_bound ä½ç½®ä¸€å®šåœ¨ $[l, r)$ ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸æ–­æ”¶ç¼© left å’Œ right å°±èƒ½æ‰¾åˆ° upper_boundã€‚ python def upper_bound(nums, tgt): l, r = 0, len(nums) while l \u003c r: mid = (l + r) \u003e\u003e 1 if nums[mid] \u003e tgt: r = mid else: l = mid + 1 return l ","date":"2026-01-21","objectID":"/posts/algorithm/:1:1","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#upper_bound"},{"categories":null,"content":" é“¾è¡¨","date":"2026-01-21","objectID":"/posts/algorithm/:2:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#é“¾è¡¨"},{"categories":null,"content":" å“ˆå¸Œè¡¨","date":"2026-01-21","objectID":"/posts/algorithm/:3:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#å“ˆå¸Œè¡¨"},{"categories":null,"content":" å­—ç¬¦ä¸²","date":"2026-01-21","objectID":"/posts/algorithm/:4:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#å­—ç¬¦ä¸²"},{"categories":null,"content":" åŒæŒ‡é’ˆ","date":"2026-01-21","objectID":"/posts/algorithm/:5:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#åŒæŒ‡é’ˆ"},{"categories":null,"content":" æ ˆ\u0026é˜Ÿåˆ—","date":"2026-01-21","objectID":"/posts/algorithm/:6:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#æ ˆé˜Ÿåˆ—"},{"categories":null,"content":" äºŒå‰æ ‘","date":"2026-01-21","objectID":"/posts/algorithm/:7:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#äºŒå‰æ ‘"},{"categories":null,"content":" å›æº¯","date":"2026-01-21","objectID":"/posts/algorithm/:8:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#å›æº¯"},{"categories":null,"content":" è´ªå¿ƒ","date":"2026-01-21","objectID":"/posts/algorithm/:9:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#è´ªå¿ƒ"},{"categories":null,"content":" åŠ¨æ€è§„åˆ’","date":"2026-01-21","objectID":"/posts/algorithm/:10:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#åŠ¨æ€è§„åˆ’"},{"categories":null,"content":" å•è°ƒæ ˆ","date":"2026-01-21","objectID":"/posts/algorithm/:11:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#å•è°ƒæ ˆ"},{"categories":null,"content":" å›¾è®º","date":"2026-01-21","objectID":"/posts/algorithm/:12:0","series":[],"tags":[],"title":"ç®—æ³•åˆ·é¢˜è®°å½•","uri":"/posts/algorithm/#å›¾è®º"},{"categories":null,"content":"æŠŠåšå®¢éƒ¨ç½²åˆ° Github Pages ç¡®å®å¾ˆæ–¹ä¾¿ï¼Œä¸è¿‡ç”±äºç§ç§åŸå› åœ¨å†…åœ°æ²¡æ³•ç›´è¿ï¼Œäºæ˜¯ç ”ç©¶ç”¨ Cloudflare åŠ é€Ÿä¸€ä¸‹ã€‚ Cloudflare å¦‚ä½•åŠ é€Ÿ GitHub Pages é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨åŸŸåæä¾›å•†(ä¾‹å¦‚æˆ‘ç”¨çš„æ˜¯é˜¿é‡Œäº‘çš„åŸŸå)å°†åŸŸåçš„ Nameserver æŒ‡å‘ Cloudflareï¼š ns1.cloudflare.com ns2.cloudflare.com è¿™æ · Cloudflare å°±èƒ½æ¥ç®¡åŸŸåçš„ DNSæœåŠ¡ã€‚å½“æˆ‘ä»¬è®¿é—®åŸŸå xilyfe.top æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šè¯·æ±‚ Cloudflare çš„ DNSï¼Œå¾—åˆ°æœ€è¿‘èŠ‚ç‚¹ IPï¼Œç„¶åè®¿é—®æœ€è¿‘ Cloudflare è¾¹ç¼˜èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯ç›´æ¥è®¿é—® Github Pagesã€‚è€Œ Cloudflare èŠ‚ç‚¹ä¼šä»£æ›¿æˆ‘ä»¬è®¿é—® GitHub Pages æºç«™ã€‚ ","date":"2026-01-15","objectID":"/posts/cdn_config/:0:0","series":["å¤‡å¿˜"],"tags":["CDN"],"title":"CDN åŠ é€Ÿåšå®¢å’Œå›¾åºŠ","uri":"/posts/cdn_config/#"},{"categories":null,"content":" åŠ é€Ÿ Github Page","date":"2026-01-15","objectID":"/posts/cdn_config/:1:0","series":["å¤‡å¿˜"],"tags":["CDN"],"title":"CDN åŠ é€Ÿåšå®¢å’Œå›¾åºŠ","uri":"/posts/cdn_config/#åŠ é€Ÿ-github-page"},{"categories":null,"content":" é…ç½® cloudflare è¿›å…¥https://www.cloudflare-cn.com/ï¼Œæ³¨å†Œè´¦å·å¹¶ç™»å½• æ·»åŠ è‡ªå·±çš„åŸŸå 3. æ³¨æ„ä¸éœ€è¦å¸¦ https æˆ–è€… wwwã€ 4. é€‰æ‹© free å¥—é¤ 5. æ·»åŠ  DNS è®°å½• ä¸€å…±éœ€è¦æ·»åŠ äº”æ¡è®°å½•å¦‚ä¸‹ï¼š text 1. A @ 185.199.108.153 2. A @ 185.199.109.153 3. A @ 185.199.110.153 4. A @ 185.199.111.153 5. CNAME @ xxxx.github.io ä¿®æ”¹åŸŸåçš„ NameServerï¼Œæˆ‘è¿™é‡Œä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼š è¿”å› Cloudflareï¼Œå¦‚æœå‡ºç°ä¸‹é¢æ ‡è¯†è¯´æ˜å·²ç»æˆåŠŸäº†ï¼ŒDNS è¿˜éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½ç”Ÿæ•ˆã€‚ ","date":"2026-01-15","objectID":"/posts/cdn_config/:1:1","series":["å¤‡å¿˜"],"tags":["CDN"],"title":"CDN åŠ é€Ÿåšå®¢å’Œå›¾åºŠ","uri":"/posts/cdn_config/#é…ç½®-cloudflare"},{"categories":null,"content":" é…ç½® Github Repo è¿›å…¥ github.io å¯¹åº”çš„ä»“åº“ï¼Œè¿›å…¥Â Settingsï¼š å·¦æ ä¸­çš„ pagesï¼Œåœ¨Â Custom domain ä¸­è¾“å…¥è‡ªå·±çš„åŸŸåä¿å­˜ï¼Œå¦‚æœæˆåŠŸä¼šæ˜¾ç¤ºä¸‹å›¾ï¼š ","date":"2026-01-15","objectID":"/posts/cdn_config/:1:2","series":["å¤‡å¿˜"],"tags":["CDN"],"title":"CDN åŠ é€Ÿåšå®¢å’Œå›¾åºŠ","uri":"/posts/cdn_config/#é…ç½®-github-repo"},{"categories":null,"content":" åŠ é€Ÿå›¾åºŠ","date":"2026-01-15","objectID":"/posts/cdn_config/:2:0","series":["å¤‡å¿˜"],"tags":["CDN"],"title":"CDN åŠ é€Ÿåšå®¢å’Œå›¾åºŠ","uri":"/posts/cdn_config/#åŠ é€Ÿå›¾åºŠ"},{"categories":null,"content":" é…ç½® cloudflare å›åˆ° Cloudflare é¢æ¿ï¼Œæ‰“å¼€ Workds and Pages è¿™ä¸ª tabï¼Œç‚¹å‡»åˆ›å»ºåº”ç”¨ç¨‹åºï¼š é€‰æ‹© ä» Hello World! å¼€å§‹ï¼š ç‚¹å‡» ç¼–è¾‘ä»£ç ï¼š æŠŠä»£ç å¤åˆ¶è¿›å»ï¼Œå¹¶ä¸”å¡«å†™ Github Img Repo çš„ä¸€äº›ä¿¡æ¯ï¼š js // Website you intended to retrieve for users. const upstream = \"raw.githubusercontent.com\"; // Custom pathname for the upstream website. // (1) å¡«å†™ä»£ç†çš„è·¯å¾„ï¼Œæ ¼å¼ä¸º /\u003cç”¨æˆ·\u003e/\u003cä»“åº“å\u003e/\u003cåˆ†æ”¯\u003e const upstream_path = \"****\"; // github personal access token. // (2) å¡«å†™githubä»¤ç‰Œ const github_token = \"****\"; // Website you intended to retrieve for users using mobile devices. const upstream_mobile = upstream; // Countries and regions where you wish to suspend your service. const blocked_region = []; // IP addresses which you wish to block from using your service. const blocked_ip_address = [\"0.0.0.0\", \"127.0.0.1\"]; // Whether to use HTTPS protocol for upstream address. const https = true; // Whether to disable cache. const disable_cache = false; // Replace texts. const replace_dict = { $upstream: \"$custom_domain\", }; addEventListener(\"fetch\", (event) =\u003e { event.respondWith(fetchAndApply(event.request)); }); async function fetchAndApply(request) { const region = request.headers.get(\"cf-ipcountry\")?.toUpperCase(); const ip_address = request.headers.get(\"cf-connecting-ip\"); const user_agent = request.headers.get(\"user-agent\"); let response = null; let url = new URL(request.url); let url_hostname = url.hostname; if (https == true) { url.protocol = \"https:\"; } else { url.protocol = \"http:\"; } if (await device_status(user_agent)) { var upstream_domain = upstream; } else { var upstream_domain = upstream_mobile; } url.host = upstream_domain; if (url.pathname == \"/\") { url.pathname = upstream_path; } else { url.pathname = upstream_path + url.pathname; } if (blocked_region.includes(region)) { response = new Response( \"Access denied: WorkersProxy is not available in your region yet.\", { status: 403, } ); } else if (blocked_ip_address.includes(ip_address)) { response = new Response( \"Access denied: Your IP address is blocked by WorkersProxy.\", { status: 403, } ); } else { let method = request.method; let request_headers = request.headers; let new_request_headers = new Headers(request_headers); new_request_headers.set(\"Host\", upstream_domain); new_request_headers.set(\"Referer\", url.protocol + \"//\" + url_hostname); new_request_headers.set(\"Authorization\", \"token \" + github_token); let original_response = await fetch(url.href, { method: method, headers: new_request_headers, body: request.body, }); let connection_upgrade = new_request_headers.get(\"Upgrade\"); if (connection_upgrade \u0026\u0026 connection_upgrade.toLowerCase() == \"websocket\") { return original_response; } let original_response_clone = original_response.clone(); let original_text = null; let response_headers = original_response.headers; let new_response_headers = new Headers(response_headers); let status = original_response.status; if (disable_cache) { new_response_headers.set(\"Cache-Control\", \"no-store\"); } else { new_response_headers.set(\"Cache-Control\", \"max-age=43200000\"); } new_response_headers.set(\"access-control-allow-origin\", \"*\"); new_response_headers.set(\"access-control-allow-credentials\", \"true\"); new_response_headers.delete(\"content-security-policy\"); new_response_headers.delete(\"content-security-policy-report-only\"); new_response_headers.delete(\"clear-site-data\"); if (new_response_headers.get(\"x-pjax-url\")) { new_response_headers.set( \"x-pjax-url\", response_headers .get(\"x-pjax-url\") .replace(\"//\" + upstream_domain, \"//\" + url_hostname) ); } const content_type = new_response_headers.get(\"content-type\"); if ( content_type != null \u0026\u0026 content_type.includes(\"text/html\") \u0026\u0026 content_type.includes(\"UTF-8\") ) { original_text = await replace_response_text( original_response_clone, upstream_domain, url_hostname ); } else { original_text = original_response_clone.body; } response = new Response(original_text, { status, headers: new_response_headers, }); } return response; } async function replace_response_text(response, upstream_domain, host_name) { let text = await response.","date":"2026-01-15","objectID":"/posts/cdn_config/:2:1","series":["å¤‡å¿˜"],"tags":["CDN"],"title":"CDN åŠ é€Ÿåšå®¢å’Œå›¾åºŠ","uri":"/posts/cdn_config/#é…ç½®-cloudflare-1"},{"categories":null,"content":" é…ç½® picgoåœ¨ picgo è®¾ç½®ä¸­å¡«å†™è‡ªå®šä¹‰åŸŸåå°±å¯ä»¥äº† ","date":"2026-01-15","objectID":"/posts/cdn_config/:2:2","series":["å¤‡å¿˜"],"tags":["CDN"],"title":"CDN åŠ é€Ÿåšå®¢å’Œå›¾åºŠ","uri":"/posts/cdn_config/#é…ç½®-picgo"},{"categories":null,"content":" å¤ä¹ æçº² ç¬¬1ç«  æ¦‚è¿° DBMSç³»ç»Ÿç»“æ„ç»„æˆ æ•°æ®åº“ã€DBMSã€æ•°æ®åº“ç³»ç»Ÿç­‰åŸºæœ¬æ¦‚å¿µ ç¬¬2ç« Â å…³ç³»æ•°æ®åº“æŠ€æœ¯å›é¡¾ (reading) æ•°æ®æ¨¡å‹å’Œå…³ç³»æ•°æ®æ¨¡å‹ å…³ç³»ä»£æ•°å’ŒSQL ä¸‰çº§æ¨¡å¼ç»“æ„ä¸æ•°æ®ç‹¬ç«‹æ€§ ç¬¬3ç«  æ•°æ®å­˜å‚¨ ç£ç›˜å—å­˜å–æ—¶é—´ å­˜å‚¨å™¨ç»“æ„ ä¸åŒç±»å‹å­˜å‚¨ä»‹è´¨ä¹‹é—´çš„å·®å¼‚ ç¬¬4ç«  æ•°æ®è¡¨ç¤º æ•°æ®é¡¹çš„è¡¨ç¤º è®°å½•çš„è¡¨ç¤º è®°å½•åœ¨ç£ç›˜å—ä¸­çš„ç»„ç»‡ é“¾è¡¨å¼å †æ–‡ä»¶å’Œç›®å½•å¼å †æ–‡ä»¶ ç¬¬5ç«  ç¼“å†²åŒºç®¡ç† ç¼“å†²åŒºç»“æ„ã€frame/dirty/pin-countç­‰æ¦‚å¿µçš„å«ä¹‰ ç¼“å†²åŒºç½®æ¢ç®—æ³• ç¼“å†²åŒºç®¡ç†å™¨çš„å®ç° ç¬¬6ç«  ç´¢å¼•ç»“æ„ ä¸€ç»´ç´¢å¼•ï¼šB+æ ‘ã€æ•£åˆ—è¡¨ (åŒ…æ‹¬åŠ¨æ€æ•£åˆ—è¡¨) å¤šç»´ç´¢å¼•ï¼šR-Treeã€åˆ†æ®µæ•£åˆ—å‡½æ•°(Partitioned Hash Func.) ç¬¬7ç«  æŸ¥è¯¢ä¼˜åŒ– æŸ¥è¯¢å¤„ç†å™¨çš„å·¥ä½œè¿‡ç¨‹ ä¸­é—´ç»“æœå¤§å°ä¼°è®¡ I/Oä»£ä»·çš„å½±å“å› ç´  ç¬¬8ç«  è¿æ¥ç®—æ³• åµŒå¥—å¾ªç¯è¿æ¥ å½’å¹¶è¿æ¥ ç´¢å¼•è¿æ¥ æ•£åˆ—è¿æ¥ è¿æ¥ç®—æ³•çš„I/Oä»£ä»·ä¼°è®¡ä¸å†…å­˜å¼€é”€ ç¬¬9ç«  äº‹åŠ¡å¤„ç†Iï¼šæ•…éšœä¸æ¢å¤ æ•°æ®åº“çš„ä¸€è‡´æ€§æ¦‚å¿µ äº‹åŠ¡çš„åŸºæœ¬æ¦‚å¿µã€ACIDå’ŒåŸå­æ“ä½œ Undoæ—¥å¿—ã€Redoæ—¥å¿—ã€Undo/Redoæ—¥å¿—çš„æ¢å¤è¿‡ç¨‹ Checkpoint ç¬¬10ç«  äº‹åŠ¡å¤„ç†IIï¼šå¹¶å‘æ§åˆ¶ å¯ä¸²æ€§ã€å†²çªå¯ä¸²æ€§çš„æ¦‚å¿µ å†²çªå¯ä¸²æ€§çš„åˆ¤å®š é”ï¼šSã€Xã€Uã€ISã€IXã€2PLã€MGL è§†å›¾å¯ä¸²æ€§ æ­»é” ä¹è§‚å¹¶å‘æ§åˆ¶æŠ€æœ¯ ç¬¬11ç«  NoSQLæ•°æ®åº“æ¦‚è¿° NoSQLæ•°æ®åº“çš„ç‰¹ç‚¹ NoSQLäº§ç”Ÿçš„åŸå›  NoSQLä¸RDBMSçš„å¯¹æ¯” NoSQLæ•°æ®åº“ä¸»è¦ç±»å‹ CAPå’ŒBASEç†è®º LSM-tree ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:0:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#"},{"categories":null,"content":" ç¬¬ä¸€ç«  æ¦‚è¿°","date":"2026-01-13","objectID":"/posts/ustc-db-review/:1:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¬¬ä¸€ç« -æ¦‚è¿°"},{"categories":null,"content":" åŸºç¡€æ¦‚å¿µ æ•°æ®åº“ï¼šé•¿æœŸå‚¨å­˜åœ¨è®¡ç®—æœºå†…ã€æœ‰ç»„ç»‡çš„ã€å¯å…±äº«çš„å¤§é‡æ•°æ®çš„é›†åˆ æ•°æ®åº“æ¨¡å¼ï¼šæ•°æ®åº“ä¸­å…¨ä½“æ•°æ®çš„é€»è¾‘ç»“æ„å’Œç‰¹å¾çš„æè¿° æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼šè®¡ç®—æœºç¨‹åºçš„é›†åˆï¼Œç”¨äºåˆ›å»ºå’Œç»´æŠ¤æ•°æ®åº“ã€‚ ä½äºOSå’ŒAPPä¹‹é—´ æ€»æ˜¯åŸºäºæŸç§æ•°æ®ç±»å‹ ä¾‹å­ï¼šMySQL, Oracle11g æ•°æ®åº“ç³»ç»Ÿï¼šä¸€ä¸ªå®Œæ•´çš„æ•°æ®åº“åº”ç”¨ç¯å¢ƒï¼Œæ˜¯â€œç³»ç»Ÿâ€çš„æ¦‚å¿µã€‚ DBS å’Œ DBMS çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼ŸDBMS å°±æ˜¯ä¸€ä¸ªæ•°æ®åº“è½¯ä»¶ä¾‹å¦‚ MySQL, Oracleã€‚DBS ä¾‹å¦‚ä¸€ä¸ªå­¦æ ¡çš„æ•™åŠ¡ç³»ç»Ÿï¼ŒåŒ…å«(1)æ•°æ®åº“ï¼šå­¦ç”Ÿè¡¨ã€è¯¾ç¨‹è¡¨ã€æˆç»©è¡¨ (2)DBMSï¼šMySQL (3)åº”ç”¨ç¨‹åºï¼šé€‰è¯¾ç³»ç»Ÿã€æˆç»©æŸ¥è¯¢ç½‘é¡µ (4)ç”¨æˆ·ï¼šå­¦ç”Ÿã€è€å¸ˆã€ç®¡ç†å‘˜ (4)è§„åˆ™ï¼šæƒé™æ§åˆ¶ã€å¤‡ä»½ç­–ç•¥ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:1:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#åŸºç¡€æ¦‚å¿µ"},{"categories":null,"content":" DBMS ç»“æ„ å¯¹äºç”¨æˆ·æŸ¥è¯¢ sql è¯­å¥ï¼Œç»è¿‡æŸ¥è¯¢ç¼–è¯‘å™¨ç¼–è¯‘ä¸ºæŸ¥è¯¢è®¡åˆ’ï¼Œæä¾›ç»™æ‰§è¡Œå¼•æ“ã€‚æ‰§è¡Œå¼•æ“å¯¹äºç´¢å¼•/ æ–‡ä»¶/è®°å½•è¯·æ±‚äº¤ç»™å¯¹åº”ç´¢å¼•/æ–‡ä»¶/è®°å½•ç®¡ç†å™¨è¿›è¡Œæ“ä½œï¼Œè€Œç´¢å¼•ç­‰åº•å±‚å®ç°å³é¡µé¢(page)å› æ­¤é€šè¿‡ç¼“å†²åŒºç®¡ç†å™¨(Manager Buffer)æ¥è¿›è¡Œè¯»å–,å¦‚æœ missï¼Œåˆ™éœ€è¦è°ƒç”¨å­˜å‚¨ç®¡ç†å™¨ä»ç£ç›˜ä¸­è¯»å–ã€‚ å¯¹äºäº‹åŠ¡å‘½ä»¤äº¤ç”±äº‹åŠ¡ç®¡ç†å™¨è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡ç”Ÿæˆæ—¥å¿—å’Œæ¢å¤çš„æ–¹å¼ä¿è¯ä¸€è‡´æ€§ã€‚å¯¹äºç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶é€šè¿‡ä¸ç¼“å†²åŒºäº¤äº’å®ç°æŒä¹…åŒ–ï¼Œå¯¹äºå¹¶å‘äº‹åŠ¡è¿˜é€šè¿‡å¹¶å‘æ§åˆ¶å’Œé”è¡¨ä¿éšœæ•°æ®ä¸€è‡´æ€§ã€‚ å¯¹äºæ•°æ®åº“ç®¡ç†å‘˜çš„ DDL å‘½ä»¤(åˆ›å»º/åˆ é™¤è¡¨ç­‰)äº¤ç”± DDL ç¼–è¯‘å™¨å¹¶é€šè¿‡ç±»ä¼¼è·¯çº¿ 1 çš„æ–¹å¼å®ç° ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:1:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#dbms-ç»“æ„"},{"categories":null,"content":" æ•°æ®åº“è®¾è®¡é—®é¢˜ æ•°æ®å†—ä½™ï¼šæ¯”å¦‚æ¯ä¸ªè€å¸ˆåªæœ‰ä¸€ä¸ªå›ºå®šçš„åœ°å€ï¼Œä½†æ˜¯å­˜è¯¾ç¨‹ä¿¡æ¯æ—¶å€™ï¼ŒæŠŠè€å¸ˆçš„åœ°å€ä¹Ÿå­˜è¿›å»äº†ã€‚å®é™…ä¸Šåªéœ€è¦å­˜åœ¨è€å¸ˆçš„é‚£ä¸ªè¡¨é‡Œã€‚ æ›´æ–°å¼‚å¸¸ï¼šæ¯”å¦‚è¦ä¿®æ”¹è€å¸ˆçš„åœ°å€ï¼Œå°±éœ€è¦è¯¾ç¨‹ä¿¡æ¯é‡Œé¢æ¯ä¸€æ¡åŒ…å«è€å¸ˆéƒ½ä¿®æ”¹åœ°å€ï¼Œå¦åˆ™ä¼šä¸ä¸€è‡´ã€‚ æ’å…¥å¼‚å¸¸ï¼šè¯¾ç¨‹ä¿¡æ¯è¡¨ä¸­ï¼Œè¯¾ç¨‹å·æ˜¯ä¸»ç ã€‚ç”±äºæ²¡æœ‰å•ç‹¬çš„æ•™å¸ˆä¿¡æ¯è¡¨ï¼Œæ–°å¢æ•™å¸ˆæ—¶å€™å¦‚æœæ²¡æœ‰ä»£è¯¾ï¼Œè¯¾ç¨‹å·ä¸ºç©ºï¼Œæ— æ³•æ’å…¥ã€‚ åˆ é™¤å¼‚å¸¸ï¼šå¦‚æœè€å¸ˆä¸ä»£è¯¾äº†ï¼Œéœ€è¦åœ¨è¯¾ç¨‹ä¿¡æ¯è¡¨ä¸­åˆ é™¤ä»–çš„è¯¾ï¼Œä½†æ˜¯é™„å¸¦åœ°å€ç­‰æ•™å¸ˆä¿¡æ¯ä¸€èµ·åˆ é™¤äº†ï¼ˆå®é™…ä¸Šè¿™éƒ¨åˆ†å†…å®¹åº”è¯¥ä¿å­˜åœ¨æ•™å¸ˆä¿¡æ¯è¡¨é‡Œé¢çš„ï¼‰ã€‚ è§£å†³æ–¹æ³•ï¼šæ¨¡å¼åˆ†è§£ã€‚å°†ä¸€ä¸ªå¤§è¡¨åˆ†è§£æˆè‹¥å¹²ç›¸å¯¹ç‹¬ç«‹çš„å°è¡¨ï¼Œé€šè¿‡å…±åŒä¸»é”®äº§ç”Ÿå…³è”ï¼Œä½†æ˜¯åœ¨æŸ¥è¯¢æ—¶ä¼šæ¥å¸¦é¢å¤–çš„ join å¼€é”€ï¼Œå¹¶ä¸”å¦‚ä½•åˆ†è§£ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ æ›´æ–°å¼‚å¸¸å’Œæ’å…¥å¼‚å¸¸å®é™…ä¸Šå°±æ˜¯æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:1:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ•°æ®åº“è®¾è®¡é—®é¢˜"},{"categories":null,"content":" æ•°æ®åº“è¯­è¨€ æ•°æ®åº“å®šä¹‰è¯­è¨€ï¼ˆData Definition Languageï¼ŒDDLï¼‰ å®šä¹‰è¡¨ è§†å›¾æ“ä½œ ç´¢å¼•æ“ä½œ æ•°æ®æ“çºµè¯­è¨€ï¼ˆData Manipulation Languageï¼ŒDMLï¼‰ Insertï¼ŒDeleteï¼ŒSeleteï¼ŒUpdate æ•°æ®åº“æ§åˆ¶è¯­è¨€ï¼ˆData Control Languageï¼ŒDCLï¼‰ Grantï¼ŒRevoke ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:1:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ•°æ®åº“è¯­è¨€"},{"categories":null,"content":" ç¬¬äºŒç«  æ•°æ®å­˜å‚¨","date":"2026-01-13","objectID":"/posts/ustc-db-review/:2:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¬¬äºŒç« -æ•°æ®å­˜å‚¨"},{"categories":null,"content":" ç£ç›˜ç»“æ„ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:2:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç£ç›˜ç»“æ„"},{"categories":null,"content":" ç£ç›˜å—å­˜å– å—æ˜¯DBMSæˆ–OSä¸­æ•°æ®å­˜å–çš„æœ€å°å•å…ƒï¼Œæ‰€ä»¥å—æ˜¯é€»è¾‘å•å…ƒã€‚ æ‰‡åŒºæ˜¯ç£ç›˜ä¸­æ•°æ®å­˜å‚¨çš„æœ€å°å•å…ƒï¼Œæ‰€ä»¥æ‰‡åŒºæ˜¯ç‰©ç†å•å…ƒã€‚ è¯»å—æ—¶é—´Tall=å¯»é“æ—¶é—´S+æ—‹è½¬å»¶è¿ŸR+ä¼ è¾“æ—¶é—´T+å…¶ä»–æ—¶é—´O \\text{è¯»å—æ—¶é—´}T_{all} = \\text{å¯»é“æ—¶é—´}S+ \\text{æ—‹è½¬å»¶è¿Ÿ}R + \\text{ä¼ è¾“æ—¶é—´}T + \\text{å…¶ä»–æ—¶é—´}O è¯»å—æ—¶é—´Tallâ€‹=å¯»é“æ—¶é—´S+æ—‹è½¬å»¶è¿ŸR+ä¼ è¾“æ—¶é—´T+å…¶ä»–æ—¶é—´O Note è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šä¸€ä¸ªç›˜é¢ï¼Œä»å†…åˆ°å¤–æœ‰å¾ˆå¤šç£é“ï¼ŒåŒä¸€ä¸ªç£é“è¢«åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªæ‰‡åŒºã€‚å…¶ä¸­æ‰‡åŒºä¹‹é—´æœ‰é—´éš™éš”å¼€ï¼Œé—´éš™å ç£é“çš„ 10% ç©ºé—´ã€‚ä¹Ÿå°±æ˜¯è¯´å‡å¦‚å‘Šè¯‰ä½ æ¯ä¸ªæ‰‡åŒºå¤§å°ä¸º xï¼Œä¸€å…± t ä¸ªæ‰‡åŒºï¼Œè®¡ç®—å®¹é‡æ—¶å€™æ˜¯ä¸ç”¨ç®¡é—´éš™çš„ï¼Œå› ä¸ºé—´éš™ä¸å ç©ºé—´ã€‚è€Œå¦‚æœè®©ä½ æ±‚ç£é“ä½å¯†åº¦ï¼Œä½ éœ€è¦æŠŠç£é“ç¨‹åº¦ä¹˜ 90% æ‰æ˜¯çœŸå®é•¿åº¦ã€‚ å…¶ä¸­æ‰‡åŒºä¹‹é—´æœ‰é—´éš™éš”å¼€ï¼Œé—´éš™å ç£é“çš„10%ç©ºé—´ã€‚ å¯»é“æ—¶é—´ä¸€èˆ¬åœ¨10ms-40msä¹‹é—´ æ—‹è½¬å»¶è¿Ÿæ˜¯ç£ç›˜è½¬åŠ¨åˆ°å—çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºåˆ°è¾¾ç£å¤´æ‰€éœ€çš„æ—¶é—´. ç£ç›˜è½¬é€Ÿå•ä½ï¼šRPM (Rotation / Min) å¹³å‡æ—¶é—´ä¸ºæ—‹è½¬1/2å‘¨æ‰€è´¹çš„æ—¶é—´ e.g.ï¼šä¸€ä¸ª7200RPMçš„ç£ç›˜ï¼Œå¹³å‡æ—‹è½¬å»¶è¿Ÿ $R=\\frac{60 \\times 10^3ms}{7200} \\times \\frac{1}{2} = 4.17ms$ ä¼ è¾“æ—¶é—´æ˜¯ç£å¤´æ—‹è½¬é€šè¿‡å—æ‰€åœ¨æ‰‡åŒºåŠå…¶é—´éš™æ‰€éœ€çš„æ—¶é—´ e.g., ç£é“å¤§çº¦æœ‰100,000 Bytesï¼Œçº¦10msè½¬ä¸€å‘¨ï¼Œåˆ™æ¯ç§’å¯ä»ç£ç›˜è¯»å–1000/10*100000=10MB. ä¸€ä¸ª4KBçš„å—ä¼ è¾“æ—¶é—´å°äº0.5ms å…¶ä»–å»¶è¿Ÿï¼š CPUè¯·æ±‚IOçš„æ—¶é—´ äº‰ç”¨ç£ç›˜æ§åˆ¶å™¨æ—¶é—´ å¾ç”¨æ€»çº¿å’Œä¸»å­˜çš„æ—¶é—´ å…¸å‹æƒ…å†µï¼š0ï¼ˆå¿½ç•¥ä¸è®¡ï¼‰ å¦‚ä½•è¯»ä¸‹ä¸€å— åœ¨åŒä¸€æŸ±é¢ä¸Šï¼š$R+T+other$ ä¸åœ¨åŒä¸€æŸ±é¢ä¸Šï¼š$S+R+T+other$ é“å¯†åº¦æ˜¯æ²¿ç£ç›˜åŠå¾„æ–¹å‘å•ä½é•¿åº¦ä¸Šçš„ç£é“æ•°ï¼Œ ä½å¯†åº¦æ˜¯ç£é“å•ä½é•¿åº¦ä¸Šèƒ½è®°å½•çš„äºŒè¿›åˆ¶ä»£ç ä½æ•° é¢å¯†åº¦æ˜¯ä½å¯†åº¦å’Œé“å¯†åº¦çš„ä¹˜ç§¯ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œå¯»é“æ—¶é—´(10ms-40ms)\u003eæ—‹è½¬å»¶è¿Ÿ(4ms)\u003eä¼ è¾“æ—¶é—´(4kb-0.5ms) å†™å—æ—¶é—´ å¦‚æœæ— éœ€æ ¡éªŒï¼›åˆ™ä¸è¯»å—ç›¸åŒ å¦‚æœéœ€è¦æ ¡éªŒï¼Œåˆ™éœ€è¦åŠ ä¸Š1æ¬¡æ—‹è½¬æ—¶é—´å’Œ1æ¬¡å—ä¼ è¾“æ—¶é—´ å—ä¿®æ”¹ å°†å—è¯»å…¥ä¸»å­˜ åœ¨ä¸»å­˜å®Œæˆä¿®æ”¹ å°†å—é‡æ–°å†™å…¥ç£ç›˜ å¦‚ä½•å®šä½ä¸€ä¸ªå—çš„ä½ç½® å—åœ°å€ = (è®¾å¤‡å·ï¼ŒæŸ±é¢å·ï¼Œç›˜é¢å·ï¼Œæ‰‡åŒºå·) 3840 RPM 8 ç›˜é¢ 8192 ç£é“ 256 æ‰‡åŒº 512B å­—èŠ‚/æ‰‡åŒº å¯»é“æ—¶é—´(æœ€å¤§)ï¼š17.4 ms ç£å¤´å¯åŠ¨åœæ­¢1 msï¼Œæ¯ç§»åŠ¨500ä¸ªæŸ±é¢éœ€1ms 1 block ï¼ 4 KB ï¼ 8 sectors å—ä¹‹é—´çš„é—´éš™å å—çš„10%å¤§å° æ¯ç£é“å¤§å°=(256/8)*4 KB=128 KB=32å— æ¯æŸ±é¢å¤§å°=8*128KB=1 M 3840 RPM â†’ 3840 è½¬/min â†’ 60*10^3/3840 = 15.625msã€‚æ‰€ä»¥è¯»å–ä¸€ä¸ªç£é“ï¼ˆä¹Ÿå°±æ˜¯è½¬ä¸€åœˆï¼‰éœ€è¦15.625msï¼Œä¸€ä¸ªç£é“æœ‰32å—ï¼Œæ‰€ä»¥è¯»å–ä¸€ä¸ªå—è¦0.4883msï¼Œé—´éš”å 10%æ•…è¯»å–æ•°æ®æ—¶é—´å 90%ï¼Œ0.439msã€‚è¯»å–ä¸€å—æœ€å¤§æ—¶é—´ = å¯»é“æ—¶é—´(æœ€å¤§) + æ—‹è½¬å»¶è¿Ÿ(æ—‹è½¬ä¸€åœˆ) + ä¼ é€æ—¶é—´=17.4ms + 15.625ms + 0.439msã€‚æœ€çŸ­æ—¶é—´å°±æ˜¯åªè¦ä¼ è¾“æ—¶é—´0.439msã€‚ è¯»å–ä¸€å—çš„å¹³å‡æ—¶é—´æ€ä¹ˆç®—ï¼Ÿ æ ¹æ®å‚è€ƒä¹¦ç»“è®ºï¼šç£é€šå¹³å‡ç§»åŠ¨è·ç¦»æ˜¯ç£ç›˜çš„ 1/3ï¼Œæ‰€ä»¥å¹³å‡å¯»é“æ•°æ˜¯ 8192/3=2730ã€‚æ¯ç§»åŠ¨500ä¸ªæŸ±é¢éœ€1msï¼Œéœ€è¦ 2730/500=5.5msï¼ŒåŠ ä¸Šå¯åŠ¨åœæ­¢çš„ 1ms ä¸€å…± 6.5msã€‚æ‰€ä»¥å¹³å‡æ—¶é—´=6.5ms + 15.625ms/2(æ—‹è½¬åŠåœˆ) + 0.439ms(ä¼ è¾“æ—¶é—´) ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:2:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç£ç›˜å—å­˜å–"},{"categories":null,"content":" ç£ç›˜å­˜å–ä¼˜åŒ– å…ˆè¯»åŒä¸€ä¸ªç£é“çš„ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:2:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç£ç›˜å­˜å–ä¼˜åŒ–"},{"categories":null,"content":" æ–°å‹å­˜å‚¨ é—ªå­˜ï¼ˆFlash Memoryï¼‰ è¯»å†™ä¸å¯¹ç§°ï¼ˆå†™æ…¢è¯»å¿«ï¼‰ å†™å‰æ“¦é™¤ï¼šå¼‚ä½æ›´æ–°ã€å—æ“¦é™¤æ“ä½œ å¯¿å‘½æœ‰é™ï¼šå—æ“¦é™¤æ¬¡æ•°æœ‰é™ æŒ‰é¡µè¯»å†™ã€æŒ‰å—æ“¦é™¤ ç›¸å˜å­˜å‚¨å™¨ï¼ˆPCM) è¯»å–å»¶è¿Ÿè¾ƒNAND Flashé«˜ä¸€ç‚¹(ä¸€å€å·¦å³) å†™å…¥é€Ÿåº¦è¿œå¿«äºNAND Flashå¿«å¾—å¤š(500å€) æœ¬èº«è¯»å†™å¹¶ä¸å¹³è¡¡, å†™å¿«è¯»æ…¢ (50å€) æ²¡æœ‰æ“¦é™¤å»¶è¿Ÿï¼Œè€ŒNAND Flashéœ€è¦2ms æ“¦é™¤æ¬¡æ•°ä¹Ÿæ¯”NANDé«˜å‡ ä¸ªæ•°é‡çº§ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:2:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ–°å‹å­˜å‚¨"},{"categories":null,"content":" æ–°å‹å­˜å‚¨ é—ªå­˜ï¼ˆFlash Memoryï¼‰ è¯»å†™ä¸å¯¹ç§°ï¼ˆå†™æ…¢è¯»å¿«ï¼‰ å†™å‰æ“¦é™¤ï¼šå¼‚ä½æ›´æ–°ã€å—æ“¦é™¤æ“ä½œ å¯¿å‘½æœ‰é™ï¼šå—æ“¦é™¤æ¬¡æ•°æœ‰é™ æŒ‰é¡µè¯»å†™ã€æŒ‰å—æ“¦é™¤ ç›¸å˜å­˜å‚¨å™¨ï¼ˆPCM) è¯»å–å»¶è¿Ÿè¾ƒNAND Flashé«˜ä¸€ç‚¹(ä¸€å€å·¦å³) å†™å…¥é€Ÿåº¦è¿œå¿«äºNAND Flashå¿«å¾—å¤š(500å€) æœ¬èº«è¯»å†™å¹¶ä¸å¹³è¡¡, å†™å¿«è¯»æ…¢ (50å€) æ²¡æœ‰æ“¦é™¤å»¶è¿Ÿï¼Œè€ŒNAND Flashéœ€è¦2ms æ“¦é™¤æ¬¡æ•°ä¹Ÿæ¯”NANDé«˜å‡ ä¸ªæ•°é‡çº§ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:2:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#é—ªå­˜flash-memory"},{"categories":null,"content":" æ–°å‹å­˜å‚¨ é—ªå­˜ï¼ˆFlash Memoryï¼‰ è¯»å†™ä¸å¯¹ç§°ï¼ˆå†™æ…¢è¯»å¿«ï¼‰ å†™å‰æ“¦é™¤ï¼šå¼‚ä½æ›´æ–°ã€å—æ“¦é™¤æ“ä½œ å¯¿å‘½æœ‰é™ï¼šå—æ“¦é™¤æ¬¡æ•°æœ‰é™ æŒ‰é¡µè¯»å†™ã€æŒ‰å—æ“¦é™¤ ç›¸å˜å­˜å‚¨å™¨ï¼ˆPCM) è¯»å–å»¶è¿Ÿè¾ƒNAND Flashé«˜ä¸€ç‚¹(ä¸€å€å·¦å³) å†™å…¥é€Ÿåº¦è¿œå¿«äºNAND Flashå¿«å¾—å¤š(500å€) æœ¬èº«è¯»å†™å¹¶ä¸å¹³è¡¡, å†™å¿«è¯»æ…¢ (50å€) æ²¡æœ‰æ“¦é™¤å»¶è¿Ÿï¼Œè€ŒNAND Flashéœ€è¦2ms æ“¦é™¤æ¬¡æ•°ä¹Ÿæ¯”NANDé«˜å‡ ä¸ªæ•°é‡çº§ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:2:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç›¸å˜å­˜å‚¨å™¨pcm"},{"categories":null,"content":" è¯¾åé¢˜ text å‡è®¾æŸç£ç›˜å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š (1)æœ‰8ä¸ªç›˜é¢å’Œ8192ä¸ªæŸ±é¢ (2)ç›˜é¢ç›´å¾„ä¸º3.5è‹±å¯¸ï¼Œå…¶ä¸­å†…åœˆä¸å­˜å‚¨æ•°æ®ï¼Œå†…åœˆç›´å¾„ä¸º1.5è‹±å¯¸ (3)æ¯ç£é“å¹³å‡æœ‰256ä¸ªæ‰‡åŒºï¼Œæ¯ä¸ªæ‰‡åŒº512å­—èŠ‚ (4)æ¯ä¸ªç£é“10%è¢«ç”¨äºé—´éš™ (5)ç£ç›˜è½¬é€Ÿä¸º7200RPM (6)ç£å¤´å¯åŠ¨åˆ°åœæ­¢éœ€è¦1ms,æ¯ç§»åŠ¨500ä¸ªæŸ±é¢å¦åŠ 1ms å›ç­”ä¸‹åˆ—é—®é¢˜ï¼š (1)ç£ç›˜å®¹é‡æ˜¯å¤šå°‘ï¼Ÿ (2)å¦‚æœæ‰€æœ‰çš„ç£é“æ‹¥æœ‰ç›¸åŒçš„æ‰‡åŒºæ•°ï¼Œé‚£ä¹ˆæœ€å†…åœˆçš„ç£é“çš„ä½å¯†åº¦æ˜¯å¤šå°‘ï¼Ÿ (3)å¦‚æœä¸€ä¸ªå—æ˜¯8KB,é‚£ä¹ˆä¸€ä¸ªå—çš„ä¼ è¾“æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿ (4)å¹³å‡å¯»é“æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿ (5)å¹³å‡æ—‹è½¬ç­‰å¾…æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿ ç£é“å®¹é‡ä¸å«é—´éš”ï¼Œå°±æ˜¯æ¯ä¸ªæ‰‡åŒºå®¹é‡ä¹‹å’Œ ç®—ä½å¯†åº¦ä¸å«é—´éš” å—ä¼ è¾“æ—¶å€™ï¼Œç£å¤´ç»è¿‡å¤šä¸ªæ‰‡åŒºï¼Œè®°å¾—ç®—ç»è¿‡é—´éš”æ•°=ç»è¿‡æ‰‡åŒºæ•°-1 çº é”™ ç®—ä½å¯†åº¦æ—¶å€™ï¼Œç»™çš„æ˜¯ç›´å¾„ï¼Œéœ€è¦çš„åº”è¯¥æ˜¯å‘¨é•¿ï¼Œæ‰€ä»¥è¦ä¹˜ä¸Š Ï€ ä¼ è¾“æ—¶é—´=(æ‰‡åŒºè·ç¦» + é—´éš™è·ç¦») / è½¬é€Ÿï¼Œæ‰‡åŒºè·ç¦»è®¡ç®—çš„æ—¶å€™åº”è¯¥ Ã— 90%ã€‚å› ä¸ºå‡è®¾ç£é“é•¿åº¦ä¸º xï¼Œé‚£ä¹ˆé‡Œé¢æ‰‡åŒºé•¿åº¦æ˜¯ 0.9xï¼Œ16 ä¸ªæ‰‡åŒºé•¿åº¦æ˜¯ $\\frac{16}{256} \\times 0.9x$ã€‚ text å‡è®¾ç£ç›˜å—å¤§å°ä¸º 4KBï¼Œå—ä¸­å­˜å‚¨100å­—èŠ‚çš„å®šé•¿è®°å½•ã€‚æˆ‘ä»¬å‡è®¾å—é¦–éƒ¨åªåŒ…æ‹¬4å­—èŠ‚çš„æ¨¡å¼æŒ‡é’ˆå’Œä¸€ä¸ªåç§»é‡è¡¨ã€‚å¯¹äºå—å†…çš„æ¯æ¡è®°å½•ï¼Œåœ¨åç§»é‡è¡¨ä¸­éƒ½æœ‰ä¸€ä¸ª4å­—èŠ‚çš„æŒ‡é’ˆæŒ‡å‘è¯¥è®°å½•ã€‚å‡è®¾åˆå§‹æ—¶ç£ç›˜å—ä¸­å·²ç»æœ‰10æ¡è®°å½•ã€‚ç„¶åï¼Œæˆ‘ä»¬æ¯å¤©å‘å—å†…æ’å…¥4æ¡è®°å½•ï¼Œåˆ é™¤2æ¡è®°å½•;å¹¶ä¸”æ¯å¤©çš„åˆ é™¤æ“ä½œæ€»æ˜¯å‘ç”Ÿåœ¨æ’å…¥ä¹‹åï¼Œåˆ é™¤è®°å½•æ—¶æˆ‘ä»¬å°†è®°å½•åœ¨åç§»é‡è¡¨ä¸­çš„æŒ‡é’ˆç½®ä¸ºNULLæ¥å®ç°ã€‚å½“å—å†…ç©ºé—´ä¸è¶³ä»¥æ’å…¥4æ¡è®°å½•æ—¶ï¼Œå…è®¸åªæ’å…¥è®°å½•å¹¶ç»“æŸæ“ä½œ(å³ä¸å†ç»§ç»­å¯¹è¯¥å—è¿›è¡Œåˆ é™¤æ“ä½œ)ã€‚æˆ‘ä»¬è§„å®šåç§»é‡è¡¨ä¸èƒ½ç”¨ä½œè®°å½•å­˜å‚¨ç©ºé—´ã€‚è¯·é—®: 1ï¼Œå‡ å¤©åä¸èƒ½å†å‘è¯¥å—å†…æ’å…¥è®°å½•? 2.ç»“æŸæ“ä½œåå—å†…å…±æœ‰å‡ æ¡è®°å½•?åç§»é‡è¡¨å äº†å¤šå°‘å­—èŠ‚?ç£ç›˜å—è¿˜å‰©å¤šå°‘ç©ºé—²ç©ºé—´(å­—èŠ‚)? text 2ã€å‡è®¾æŸå—ç£ç›˜çš„å‚æ•°å¦‚ä¸‹ï¼šå®¹é‡ä¸º36.7GB,ä¼ è¾“é€Ÿç‡ä¸º45MB/s,æ—‹è½¬ä¸€åœˆçš„æ—¶é—´ä¸º 4ms.å¹³å‡å¯»é“æ—¶é—´ä¸º5ms.æœ€å°å¯»é“æ—¶é—´ä¸º0.65ms(æŒ‡ç£å¤´å¯»é“åˆ°ç›¸é‚»ç£é“çš„æ—¶é—´)ï¼Œä¸€ä¸ªç£é“å¤§å°ä¸º180KBã€‚å¦‚æœç£ç›˜å—å¤§å°ä¸º4KB,è¯·å›ç­”ä¸‹é¢é—®é¢˜ï¼ˆæ‰€æœ‰ç»“æœå‡å››èˆäº”å…¥ä¿ç•™å°æ•°ç‚¹åä¸¤ä½)ï¼š (1)éšæœºè¯»å–1000ä¸ªç£ç›˜å—éœ€è¦å¤šå°‘æ—¶é—´(ms)? (2)å‡å®š(1)ä¸­çš„1000ä¸ªç£ç›˜å—åœ¨å•ä¸ªç£é“ä¸Šè¿ç»­å­˜å‚¨ï¼Œå¹¶ä¸”æ‰€æœ‰ç£ç›˜å—å­˜å‚¨åœ¨ç›¸é‚»çš„ç£é“ä¸Šï¼Œæ­¤æ—¶è¯»å–è¿™1000ä¸ªç£ç›˜å—éœ€è¦å¤šå°‘æ—¶é—´(ms)? text ç”±äºé—ªå­˜ç­‰å­˜å‚¨ä»‹è´¨çš„åŸåœ°æ›´æ–°(In-Place Update)ä»£ä»·å¾ˆé«˜ï¼Œå› æ­¤å½“æˆ‘ä»¬è®¾è®¡é¢å‘é—ªå­˜(SSD)çš„ç£ç›˜å—ç»“æ„æ—¶å¾€å¾€è¦é‡‡ç”¨å¼‚åœ°æ›´æ–°(Out-Place Update)çš„æ–¹å¼ã€‚å¼‚åœ°æ›´æ–°çš„ä¸€ç§å¸¸è§å®ç°æ–¹å¼æ˜¯é‡‡ç”¨è¿½åŠ å†™(Append-Only),å³æ›´æ–°è®°å½•æ—¶åœ¨ç£ç›˜å—çš„ç©ºé—²ç©ºé—´ä¸­è¿½åŠ ä¸€æ¡æ–°çš„è®°å½•ï¼ˆå³æ›´æ–°åçš„è®°å½•ï¼‰ï¼ŒåŒæ—¶å°†æ—§è®°å½•ç½®ä¸ºæ— æ•ˆã€‚è¯·å›ç­”ä¸‹é¢çš„é—®é¢˜ï¼š (1)ç»™å‡ºæ”¯æŒè¿½åŠ å†™çš„ç£ç›˜å—çš„ç»“æ„è®¾è®¡å›¾ï¼Œè¦æ±‚åŒ…å«å¿…é¡»çš„æ•°æ®ç»“æ„ï¼› (2)ç”¨ä¼ªç ç»™å‡ºåŸºäºè¿½åŠ å†™çš„è®°å½•æ›´æ–°ç®—æ³•è¿‡ç¨‹ï¼Œè¦æ±‚ç»™å‡ºè¾“å…¥ã€è¾“å‡ºå’Œç®—æ³•æµç¨‹ï¼› (3)è®¨è®ºä¸€ä¸‹è¿½åŠ å†™ä¸åŸåœ°æ›´æ–°ç›¸æ¯”çš„ä¼˜ç¼ºç‚¹ã€‚ Flash ç”±å¤šä¸ª Block ç»„æˆï¼Œæ¯ä¸ª Block å«å¤šä¸ª Pageã€‚è¿›è¡Œå†™æ“ä½œæ—¶å€™é€‰ä¸€ä¸ªç©ºçš„ Page å†™ï¼Œåˆ é™¤æ“ä½œæ—¶å€™è¦ä»¥ Block ä¸ºå•ä½åˆ é™¤ï¼ŒåŸå…ˆæ•°æ®éœ€è¦æ‰¾å…¶ä»– Block å­˜å‚¨ã€‚ ç•¥ ä¼˜ç‚¹ï¼šä¸ç”¨ç®¡æ—§æ•°æ®ï¼Œå‡å°‘äº†åˆ é™¤æ“ä½œçš„å¼€é”€ï¼›è¿½åŠ å†™æ˜¯é¡ºåºå†™å…¥ï¼Œæ¯”åŸåœ°æ›´æ–°çš„éšæœºå†™é€Ÿåº¦æ›´å¿«ã€‚ç¼ºç‚¹ï¼šå¢åŠ äº†ç©ºé—´å ç”¨ï¼›åƒåœ¾æ¸…ç†å’Œæ”¶é›†æœºåˆ¶å½±å“æ€§èƒ½ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:2:5","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è¯¾åé¢˜"},{"categories":null,"content":" ç¬¬ä¸‰ç«  æ•°æ®è¡¨ç¤º","date":"2026-01-13","objectID":"/posts/ustc-db-review/:3:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¬¬ä¸‰ç« -æ•°æ®è¡¨ç¤º"},{"categories":null,"content":" æ•°æ®é¡¹ ç±»å‹ é•¿åº¦ å­˜å‚¨æ–¹å¼ Integer(short) 2B=16bit äºŒè¿›åˆ¶å­˜å‚¨ Real,Float 4B=32bit ç¬¦å·+å°æ•°+æŒ‡æ•° Char(n) nå­—èŠ‚ nå­—èŠ‚çš„æ•°ç»„ï¼Œå°äºnæ˜¯ç‰¹æ®Šå­—ç¬¦å¡«å…… VarChar(n) ä¸å®šé•¿ æ–¹æ³•1ï¼šNullç»ˆæ­¢ç¬¦ï¼›æ–¹æ³•2ï¼šå¸¦é•¿åº¦ 3catï¼›æ–¹æ³•3ï¼šn+1å­—èŠ‚ Boolean 1B=8bit True=11111111 Enum 2B=16bit äºŒè¿›åˆ¶å­˜å‚¨ï¼Œä¸€å…±å¯ä»¥è¡¨ç¤º2^16 Date 10/8/7/Integer â€œYYYY-MM-DDâ€,â€œYYYYMMDDâ€,â€œYYYYDDDâ€,1900-0101ä»¥æ¥å¤©æ•° Time 8/Varchar/Integer â€œHH:MM:SSâ€,â€œHH:MM::SS.FFâ€,00:00::00ä»¥æ¥ç§’æ•° Bit å¸¦é•¿åº¦çš„äºŒè¿›åˆ¶ä¸² ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:3:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ•°æ®é¡¹"},{"categories":null,"content":" è®°å½• å›ºå®šæ ¼å¼å®šé•¿è®°å½•ä¾‹å¦‚è§„å®šäº† (1) E#, 2B integer (2) Ename, 10char (3) Dept, 2B codeï¼Œé‚£ä¹ˆå°±æŒ‰ç…§ â€œ55 smith 02\"è¿™æ ·å­˜å‚¨ sql CREATE TABLE Student( stid CHAR(30) PRIMARY KEY, stname VARCHAR(255), gender CHAR(1), birthdate DATE ) è€ƒè™‘å¯»å€ç‰¹ç‚¹ï¼šè®°å½•å’Œå­—æ®µçš„å¼€å§‹åœ°å€å¿…é¡»æŒ‰4çš„å€æ•°å¯¹é½ï¼Œå…·æœ‰æ›´å¿«çš„è¯»å†™é€Ÿåº¦ï¼Œä½†æ˜¯æµªè´¹ç©ºé—´ã€‚ è®°å½•é¦–éƒ¨ï¼ˆHeadï¼‰ä¼šå­˜å‚¨æè¿°è®°å½•çš„ä¿¡æ¯ è®°å½•ç±»å‹ï¼ˆSchemeï¼‰ è®°å½•é•¿åº¦ æ—¶é—´æˆ³ï¼ˆç”¨äºå¹¶å‘æ§åˆ¶ï¼‰ å…¶ä»–ä¿¡æ¯ å¯å˜æ ¼å¼è®°å½• cpp typedef struct { void *data; int size; } DBT; è®°å½•éƒ½ä»¥â€œKEY+VALUEâ€æ–¹å¼è¡¨ç¤ºï¼ŒKEYä¸VALUEéƒ½ä»¥å­—èŠ‚æµï¼ˆbyte stringï¼‰å­˜å‚¨ ä¼˜ç‚¹ çµæ´»çš„è®°å½•æ ¼å¼ï¼Œé€‚åˆâ€œæ¾æ•£â€è®°å½•ï¼Œå¦‚ç—…äººçš„æ£€éªŒç»“æœ é€‚åˆå¤„ç†é‡å¤å­—æ®µ é€‚åˆè®°å½•æ ¼å¼æ¼”å˜ ç¼ºç‚¹ æ ‡è®°å­˜å‚¨æ–¹å¼ç©ºé—´ä»£ä»·é«˜ KVæ–¹å¼éš¾ä»¥æ”¯æŒå¤æ‚æŸ¥è¯¢ åº”ç”¨è´Ÿæ‹…é‡ä¸”äº‹åŠ¡å¤„ç†ç­‰å®ç°å›°éš¾ å¯å˜æ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å˜é•¿çš„ï¼Œå›ºå®šæ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å®šé•¿çš„ï¼Ÿ å‰åŠå¥å¯¹ï¼ŒååŠå¥ä¸å¯¹ã€‚å¯å˜æ ¼å¼è®°å½•ï¼Œå­—æ®µä¸ªæ•°æˆ–å­—æ®µç±»å‹å¯èƒ½å˜åŒ–ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯å˜é•¿çš„ã€‚ä½†æ˜¯å›ºå®šæ ¼å¼è®°å½•ï¼Œé‡Œé¢çš„æ•°æ®é¡¹ä¸ä¸€å®šæ˜¯å®šé•¿çš„ï¼Œä¾‹å¦‚ Varcharï¼Œæ‰€ä»¥å›ºå®šæ ¼å¼è®°å½•ä¸ä¸€å®šå®šé•¿ã€‚ é¦–éƒ¨æŒ‡é’ˆæ³•(å˜é•¿è®°å½•è¡¨ç¤ºæ³•) å®šé•¿å­—æ®µåœ¨å‰,å˜é•¿å­—æ®µåœ¨å,å¦‚ä¸‹ä¾‹(nameã€addresså˜é•¿): æ··åˆæ ¼å¼ï¼šå®šé•¿è®°å½•+å˜é•¿è®°å½• è®°å½•çš„ç»„ç»‡æ–¹å¼ å®šé•¿è®°å½•é€šå¸¸ç”¨\u003cå—å·ï¼Œæ§½å·\u003eè¡¨ç¤º æ–¹å¼ä¸€: ä½¿ç”¨é¢å¤–çš„ä¸€ä¸ªç©ºé—´è®°å½•å½“å‰è®°å½•æ•°N,å¯¹äºæ’å…¥æ“ä½œæ’å…¥åˆ°ç¬¬N+1çš„æ§½ä¸­å³å¯,åŒæ—¶å°†N-\u003eN+1,ä½†æ˜¯å¯¹ äºåˆ é™¤ä¸å‹å¥½ æ–¹å¼äºŒ: è®°å½•å½“å‰è®°å½•æ•°mçš„æƒ…å†µä¸‹,ä½¿ç”¨é¢å¤–Nçš„ç©ºé—´è®°å½•æ§½æ˜¯å¦å¯ç”¨(ä¾‹å¦‚0å¯ç”¨,1ä¸å¯ç”¨),æ”¯æŒ åˆ é™¤æ“ä½œ,ä½†æ˜¯é’ˆå¯¹æ’å…¥éœ€è¦å…ˆéå†ä¸€é,æœ‰é¢å¤–æ—¶é—´å¼€é”€ å˜é•¿è®°å½•ä¼šæœ‰ä¸€ä¸ªæ§½ç›®å½•æ¥è®°å½•æ¯æ¡è®°å½•ï¼š\u003cè®°å½•åç§»é‡ï¼Œé•¿åº¦\u003e æ’å…¥ è®°å½•æ— åº æ’å…¥åˆ°ä»»æ„å—çš„ç©ºé—²ç©ºé—´ä¸­ æˆ–ç”³è¯·ä¸€ä¸ªæ–°å—ï¼ˆå½“æ‰€æœ‰å—éƒ½å·²æ»¡æ—¶ï¼‰ è®°å½•å˜é•¿æ—¶ï¼Œå¯ä½¿ç”¨åç§»é‡è¡¨ è®°å½•æœ‰åº æ‰¾åˆ°è®°å½•åº”è¯¥æ”¾ç½®çš„å— å¦‚æœæœ‰ç©ºé—´ï¼Œæ”¾å…¥å¹¶è°ƒèŠ‚è®°å½•é¡ºåºå³å¯ï¼Œ å¦åˆ™æœ‰ä¸¤ç§æ–¹æ³•ï¼š åœ¨â€œé‚»è¿‘å—â€ä¸­æ‰¾ç©ºé—´ã€åˆ›å»ºæº¢å‡ºå— åˆ é™¤ åˆ é™¤æ—¶å€™æŠŠç©ºé—´åŠ å…¥å¯ç”¨ç©ºé—´åˆ—è¡¨ä¸­ã€‚ è‹¥ä½¿ç”¨åç§»è¡¨ï¼Œåˆ™å¯ä»¥ä¿®æ”¹åç§»è¡¨é¡¹æŒ‡é’ˆï¼Œå°†å…¶ç½®ç©º è‹¥ä½¿ç”¨é€»è¾‘ï¼ç‰©ç†åœ°å€æ˜ å°„è¡¨ï¼Œåˆ™å¯ä»¥å°†ç‰©ç†åœ°å€ç½®ç©º å¯ä»¥åœ¨è®°å½•é¦–éƒ¨é¢„ç•™ä¸€å¼€å§‹ä½ï¼š0ï¼æœªåˆ é™¤ï¼Œ1ï¼å·²åˆ é™¤ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:3:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è®°å½•"},{"categories":null,"content":" è®°å½• å›ºå®šæ ¼å¼å®šé•¿è®°å½•ä¾‹å¦‚è§„å®šäº† (1) E#, 2B integer (2) Ename, 10char (3) Dept, 2B codeï¼Œé‚£ä¹ˆå°±æŒ‰ç…§ â€œ55 smith 02\"è¿™æ ·å­˜å‚¨ sql CREATE TABLE Student( stid CHAR(30) PRIMARY KEY, stname VARCHAR(255), gender CHAR(1), birthdate DATE ) è€ƒè™‘å¯»å€ç‰¹ç‚¹ï¼šè®°å½•å’Œå­—æ®µçš„å¼€å§‹åœ°å€å¿…é¡»æŒ‰4çš„å€æ•°å¯¹é½ï¼Œå…·æœ‰æ›´å¿«çš„è¯»å†™é€Ÿåº¦ï¼Œä½†æ˜¯æµªè´¹ç©ºé—´ã€‚ è®°å½•é¦–éƒ¨ï¼ˆHeadï¼‰ä¼šå­˜å‚¨æè¿°è®°å½•çš„ä¿¡æ¯ è®°å½•ç±»å‹ï¼ˆSchemeï¼‰ è®°å½•é•¿åº¦ æ—¶é—´æˆ³ï¼ˆç”¨äºå¹¶å‘æ§åˆ¶ï¼‰ å…¶ä»–ä¿¡æ¯ å¯å˜æ ¼å¼è®°å½• cpp typedef struct { void *data; int size; } DBT; è®°å½•éƒ½ä»¥â€œKEY+VALUEâ€æ–¹å¼è¡¨ç¤ºï¼ŒKEYä¸VALUEéƒ½ä»¥å­—èŠ‚æµï¼ˆbyte stringï¼‰å­˜å‚¨ ä¼˜ç‚¹ çµæ´»çš„è®°å½•æ ¼å¼ï¼Œé€‚åˆâ€œæ¾æ•£â€è®°å½•ï¼Œå¦‚ç—…äººçš„æ£€éªŒç»“æœ é€‚åˆå¤„ç†é‡å¤å­—æ®µ é€‚åˆè®°å½•æ ¼å¼æ¼”å˜ ç¼ºç‚¹ æ ‡è®°å­˜å‚¨æ–¹å¼ç©ºé—´ä»£ä»·é«˜ KVæ–¹å¼éš¾ä»¥æ”¯æŒå¤æ‚æŸ¥è¯¢ åº”ç”¨è´Ÿæ‹…é‡ä¸”äº‹åŠ¡å¤„ç†ç­‰å®ç°å›°éš¾ å¯å˜æ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å˜é•¿çš„ï¼Œå›ºå®šæ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å®šé•¿çš„ï¼Ÿ å‰åŠå¥å¯¹ï¼ŒååŠå¥ä¸å¯¹ã€‚å¯å˜æ ¼å¼è®°å½•ï¼Œå­—æ®µä¸ªæ•°æˆ–å­—æ®µç±»å‹å¯èƒ½å˜åŒ–ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯å˜é•¿çš„ã€‚ä½†æ˜¯å›ºå®šæ ¼å¼è®°å½•ï¼Œé‡Œé¢çš„æ•°æ®é¡¹ä¸ä¸€å®šæ˜¯å®šé•¿çš„ï¼Œä¾‹å¦‚ Varcharï¼Œæ‰€ä»¥å›ºå®šæ ¼å¼è®°å½•ä¸ä¸€å®šå®šé•¿ã€‚ é¦–éƒ¨æŒ‡é’ˆæ³•(å˜é•¿è®°å½•è¡¨ç¤ºæ³•) å®šé•¿å­—æ®µåœ¨å‰,å˜é•¿å­—æ®µåœ¨å,å¦‚ä¸‹ä¾‹(nameã€addresså˜é•¿): æ··åˆæ ¼å¼ï¼šå®šé•¿è®°å½•+å˜é•¿è®°å½• è®°å½•çš„ç»„ç»‡æ–¹å¼ å®šé•¿è®°å½•é€šå¸¸ç”¨\u003cå—å·ï¼Œæ§½å·\u003eè¡¨ç¤º æ–¹å¼ä¸€: ä½¿ç”¨é¢å¤–çš„ä¸€ä¸ªç©ºé—´è®°å½•å½“å‰è®°å½•æ•°N,å¯¹äºæ’å…¥æ“ä½œæ’å…¥åˆ°ç¬¬N+1çš„æ§½ä¸­å³å¯,åŒæ—¶å°†N-\u003eN+1,ä½†æ˜¯å¯¹ äºåˆ é™¤ä¸å‹å¥½ æ–¹å¼äºŒ: è®°å½•å½“å‰è®°å½•æ•°mçš„æƒ…å†µä¸‹,ä½¿ç”¨é¢å¤–Nçš„ç©ºé—´è®°å½•æ§½æ˜¯å¦å¯ç”¨(ä¾‹å¦‚0å¯ç”¨,1ä¸å¯ç”¨),æ”¯æŒ åˆ é™¤æ“ä½œ,ä½†æ˜¯é’ˆå¯¹æ’å…¥éœ€è¦å…ˆéå†ä¸€é,æœ‰é¢å¤–æ—¶é—´å¼€é”€ å˜é•¿è®°å½•ä¼šæœ‰ä¸€ä¸ªæ§½ç›®å½•æ¥è®°å½•æ¯æ¡è®°å½•ï¼š\u003cè®°å½•åç§»é‡ï¼Œé•¿åº¦\u003e æ’å…¥ è®°å½•æ— åº æ’å…¥åˆ°ä»»æ„å—çš„ç©ºé—²ç©ºé—´ä¸­ æˆ–ç”³è¯·ä¸€ä¸ªæ–°å—ï¼ˆå½“æ‰€æœ‰å—éƒ½å·²æ»¡æ—¶ï¼‰ è®°å½•å˜é•¿æ—¶ï¼Œå¯ä½¿ç”¨åç§»é‡è¡¨ è®°å½•æœ‰åº æ‰¾åˆ°è®°å½•åº”è¯¥æ”¾ç½®çš„å— å¦‚æœæœ‰ç©ºé—´ï¼Œæ”¾å…¥å¹¶è°ƒèŠ‚è®°å½•é¡ºåºå³å¯ï¼Œ å¦åˆ™æœ‰ä¸¤ç§æ–¹æ³•ï¼š åœ¨â€œé‚»è¿‘å—â€ä¸­æ‰¾ç©ºé—´ã€åˆ›å»ºæº¢å‡ºå— åˆ é™¤ åˆ é™¤æ—¶å€™æŠŠç©ºé—´åŠ å…¥å¯ç”¨ç©ºé—´åˆ—è¡¨ä¸­ã€‚ è‹¥ä½¿ç”¨åç§»è¡¨ï¼Œåˆ™å¯ä»¥ä¿®æ”¹åç§»è¡¨é¡¹æŒ‡é’ˆï¼Œå°†å…¶ç½®ç©º è‹¥ä½¿ç”¨é€»è¾‘ï¼ç‰©ç†åœ°å€æ˜ å°„è¡¨ï¼Œåˆ™å¯ä»¥å°†ç‰©ç†åœ°å€ç½®ç©º å¯ä»¥åœ¨è®°å½•é¦–éƒ¨é¢„ç•™ä¸€å¼€å§‹ä½ï¼š0ï¼æœªåˆ é™¤ï¼Œ1ï¼å·²åˆ é™¤ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:3:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å›ºå®šæ ¼å¼å®šé•¿è®°å½•"},{"categories":null,"content":" è®°å½• å›ºå®šæ ¼å¼å®šé•¿è®°å½•ä¾‹å¦‚è§„å®šäº† (1) E#, 2B integer (2) Ename, 10char (3) Dept, 2B codeï¼Œé‚£ä¹ˆå°±æŒ‰ç…§ â€œ55 smith 02\"è¿™æ ·å­˜å‚¨ sql CREATE TABLE Student( stid CHAR(30) PRIMARY KEY, stname VARCHAR(255), gender CHAR(1), birthdate DATE ) è€ƒè™‘å¯»å€ç‰¹ç‚¹ï¼šè®°å½•å’Œå­—æ®µçš„å¼€å§‹åœ°å€å¿…é¡»æŒ‰4çš„å€æ•°å¯¹é½ï¼Œå…·æœ‰æ›´å¿«çš„è¯»å†™é€Ÿåº¦ï¼Œä½†æ˜¯æµªè´¹ç©ºé—´ã€‚ è®°å½•é¦–éƒ¨ï¼ˆHeadï¼‰ä¼šå­˜å‚¨æè¿°è®°å½•çš„ä¿¡æ¯ è®°å½•ç±»å‹ï¼ˆSchemeï¼‰ è®°å½•é•¿åº¦ æ—¶é—´æˆ³ï¼ˆç”¨äºå¹¶å‘æ§åˆ¶ï¼‰ å…¶ä»–ä¿¡æ¯ å¯å˜æ ¼å¼è®°å½• cpp typedef struct { void *data; int size; } DBT; è®°å½•éƒ½ä»¥â€œKEY+VALUEâ€æ–¹å¼è¡¨ç¤ºï¼ŒKEYä¸VALUEéƒ½ä»¥å­—èŠ‚æµï¼ˆbyte stringï¼‰å­˜å‚¨ ä¼˜ç‚¹ çµæ´»çš„è®°å½•æ ¼å¼ï¼Œé€‚åˆâ€œæ¾æ•£â€è®°å½•ï¼Œå¦‚ç—…äººçš„æ£€éªŒç»“æœ é€‚åˆå¤„ç†é‡å¤å­—æ®µ é€‚åˆè®°å½•æ ¼å¼æ¼”å˜ ç¼ºç‚¹ æ ‡è®°å­˜å‚¨æ–¹å¼ç©ºé—´ä»£ä»·é«˜ KVæ–¹å¼éš¾ä»¥æ”¯æŒå¤æ‚æŸ¥è¯¢ åº”ç”¨è´Ÿæ‹…é‡ä¸”äº‹åŠ¡å¤„ç†ç­‰å®ç°å›°éš¾ å¯å˜æ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å˜é•¿çš„ï¼Œå›ºå®šæ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å®šé•¿çš„ï¼Ÿ å‰åŠå¥å¯¹ï¼ŒååŠå¥ä¸å¯¹ã€‚å¯å˜æ ¼å¼è®°å½•ï¼Œå­—æ®µä¸ªæ•°æˆ–å­—æ®µç±»å‹å¯èƒ½å˜åŒ–ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯å˜é•¿çš„ã€‚ä½†æ˜¯å›ºå®šæ ¼å¼è®°å½•ï¼Œé‡Œé¢çš„æ•°æ®é¡¹ä¸ä¸€å®šæ˜¯å®šé•¿çš„ï¼Œä¾‹å¦‚ Varcharï¼Œæ‰€ä»¥å›ºå®šæ ¼å¼è®°å½•ä¸ä¸€å®šå®šé•¿ã€‚ é¦–éƒ¨æŒ‡é’ˆæ³•(å˜é•¿è®°å½•è¡¨ç¤ºæ³•) å®šé•¿å­—æ®µåœ¨å‰,å˜é•¿å­—æ®µåœ¨å,å¦‚ä¸‹ä¾‹(nameã€addresså˜é•¿): æ··åˆæ ¼å¼ï¼šå®šé•¿è®°å½•+å˜é•¿è®°å½• è®°å½•çš„ç»„ç»‡æ–¹å¼ å®šé•¿è®°å½•é€šå¸¸ç”¨\u003cå—å·ï¼Œæ§½å·\u003eè¡¨ç¤º æ–¹å¼ä¸€: ä½¿ç”¨é¢å¤–çš„ä¸€ä¸ªç©ºé—´è®°å½•å½“å‰è®°å½•æ•°N,å¯¹äºæ’å…¥æ“ä½œæ’å…¥åˆ°ç¬¬N+1çš„æ§½ä¸­å³å¯,åŒæ—¶å°†N-\u003eN+1,ä½†æ˜¯å¯¹ äºåˆ é™¤ä¸å‹å¥½ æ–¹å¼äºŒ: è®°å½•å½“å‰è®°å½•æ•°mçš„æƒ…å†µä¸‹,ä½¿ç”¨é¢å¤–Nçš„ç©ºé—´è®°å½•æ§½æ˜¯å¦å¯ç”¨(ä¾‹å¦‚0å¯ç”¨,1ä¸å¯ç”¨),æ”¯æŒ åˆ é™¤æ“ä½œ,ä½†æ˜¯é’ˆå¯¹æ’å…¥éœ€è¦å…ˆéå†ä¸€é,æœ‰é¢å¤–æ—¶é—´å¼€é”€ å˜é•¿è®°å½•ä¼šæœ‰ä¸€ä¸ªæ§½ç›®å½•æ¥è®°å½•æ¯æ¡è®°å½•ï¼š\u003cè®°å½•åç§»é‡ï¼Œé•¿åº¦\u003e æ’å…¥ è®°å½•æ— åº æ’å…¥åˆ°ä»»æ„å—çš„ç©ºé—²ç©ºé—´ä¸­ æˆ–ç”³è¯·ä¸€ä¸ªæ–°å—ï¼ˆå½“æ‰€æœ‰å—éƒ½å·²æ»¡æ—¶ï¼‰ è®°å½•å˜é•¿æ—¶ï¼Œå¯ä½¿ç”¨åç§»é‡è¡¨ è®°å½•æœ‰åº æ‰¾åˆ°è®°å½•åº”è¯¥æ”¾ç½®çš„å— å¦‚æœæœ‰ç©ºé—´ï¼Œæ”¾å…¥å¹¶è°ƒèŠ‚è®°å½•é¡ºåºå³å¯ï¼Œ å¦åˆ™æœ‰ä¸¤ç§æ–¹æ³•ï¼š åœ¨â€œé‚»è¿‘å—â€ä¸­æ‰¾ç©ºé—´ã€åˆ›å»ºæº¢å‡ºå— åˆ é™¤ åˆ é™¤æ—¶å€™æŠŠç©ºé—´åŠ å…¥å¯ç”¨ç©ºé—´åˆ—è¡¨ä¸­ã€‚ è‹¥ä½¿ç”¨åç§»è¡¨ï¼Œåˆ™å¯ä»¥ä¿®æ”¹åç§»è¡¨é¡¹æŒ‡é’ˆï¼Œå°†å…¶ç½®ç©º è‹¥ä½¿ç”¨é€»è¾‘ï¼ç‰©ç†åœ°å€æ˜ å°„è¡¨ï¼Œåˆ™å¯ä»¥å°†ç‰©ç†åœ°å€ç½®ç©º å¯ä»¥åœ¨è®°å½•é¦–éƒ¨é¢„ç•™ä¸€å¼€å§‹ä½ï¼š0ï¼æœªåˆ é™¤ï¼Œ1ï¼å·²åˆ é™¤ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:3:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å¯å˜æ ¼å¼è®°å½•"},{"categories":null,"content":" è®°å½• å›ºå®šæ ¼å¼å®šé•¿è®°å½•ä¾‹å¦‚è§„å®šäº† (1) E#, 2B integer (2) Ename, 10char (3) Dept, 2B codeï¼Œé‚£ä¹ˆå°±æŒ‰ç…§ â€œ55 smith 02\"è¿™æ ·å­˜å‚¨ sql CREATE TABLE Student( stid CHAR(30) PRIMARY KEY, stname VARCHAR(255), gender CHAR(1), birthdate DATE ) è€ƒè™‘å¯»å€ç‰¹ç‚¹ï¼šè®°å½•å’Œå­—æ®µçš„å¼€å§‹åœ°å€å¿…é¡»æŒ‰4çš„å€æ•°å¯¹é½ï¼Œå…·æœ‰æ›´å¿«çš„è¯»å†™é€Ÿåº¦ï¼Œä½†æ˜¯æµªè´¹ç©ºé—´ã€‚ è®°å½•é¦–éƒ¨ï¼ˆHeadï¼‰ä¼šå­˜å‚¨æè¿°è®°å½•çš„ä¿¡æ¯ è®°å½•ç±»å‹ï¼ˆSchemeï¼‰ è®°å½•é•¿åº¦ æ—¶é—´æˆ³ï¼ˆç”¨äºå¹¶å‘æ§åˆ¶ï¼‰ å…¶ä»–ä¿¡æ¯ å¯å˜æ ¼å¼è®°å½• cpp typedef struct { void *data; int size; } DBT; è®°å½•éƒ½ä»¥â€œKEY+VALUEâ€æ–¹å¼è¡¨ç¤ºï¼ŒKEYä¸VALUEéƒ½ä»¥å­—èŠ‚æµï¼ˆbyte stringï¼‰å­˜å‚¨ ä¼˜ç‚¹ çµæ´»çš„è®°å½•æ ¼å¼ï¼Œé€‚åˆâ€œæ¾æ•£â€è®°å½•ï¼Œå¦‚ç—…äººçš„æ£€éªŒç»“æœ é€‚åˆå¤„ç†é‡å¤å­—æ®µ é€‚åˆè®°å½•æ ¼å¼æ¼”å˜ ç¼ºç‚¹ æ ‡è®°å­˜å‚¨æ–¹å¼ç©ºé—´ä»£ä»·é«˜ KVæ–¹å¼éš¾ä»¥æ”¯æŒå¤æ‚æŸ¥è¯¢ åº”ç”¨è´Ÿæ‹…é‡ä¸”äº‹åŠ¡å¤„ç†ç­‰å®ç°å›°éš¾ å¯å˜æ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å˜é•¿çš„ï¼Œå›ºå®šæ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å®šé•¿çš„ï¼Ÿ å‰åŠå¥å¯¹ï¼ŒååŠå¥ä¸å¯¹ã€‚å¯å˜æ ¼å¼è®°å½•ï¼Œå­—æ®µä¸ªæ•°æˆ–å­—æ®µç±»å‹å¯èƒ½å˜åŒ–ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯å˜é•¿çš„ã€‚ä½†æ˜¯å›ºå®šæ ¼å¼è®°å½•ï¼Œé‡Œé¢çš„æ•°æ®é¡¹ä¸ä¸€å®šæ˜¯å®šé•¿çš„ï¼Œä¾‹å¦‚ Varcharï¼Œæ‰€ä»¥å›ºå®šæ ¼å¼è®°å½•ä¸ä¸€å®šå®šé•¿ã€‚ é¦–éƒ¨æŒ‡é’ˆæ³•(å˜é•¿è®°å½•è¡¨ç¤ºæ³•) å®šé•¿å­—æ®µåœ¨å‰,å˜é•¿å­—æ®µåœ¨å,å¦‚ä¸‹ä¾‹(nameã€addresså˜é•¿): æ··åˆæ ¼å¼ï¼šå®šé•¿è®°å½•+å˜é•¿è®°å½• è®°å½•çš„ç»„ç»‡æ–¹å¼ å®šé•¿è®°å½•é€šå¸¸ç”¨\u003cå—å·ï¼Œæ§½å·\u003eè¡¨ç¤º æ–¹å¼ä¸€: ä½¿ç”¨é¢å¤–çš„ä¸€ä¸ªç©ºé—´è®°å½•å½“å‰è®°å½•æ•°N,å¯¹äºæ’å…¥æ“ä½œæ’å…¥åˆ°ç¬¬N+1çš„æ§½ä¸­å³å¯,åŒæ—¶å°†N-\u003eN+1,ä½†æ˜¯å¯¹ äºåˆ é™¤ä¸å‹å¥½ æ–¹å¼äºŒ: è®°å½•å½“å‰è®°å½•æ•°mçš„æƒ…å†µä¸‹,ä½¿ç”¨é¢å¤–Nçš„ç©ºé—´è®°å½•æ§½æ˜¯å¦å¯ç”¨(ä¾‹å¦‚0å¯ç”¨,1ä¸å¯ç”¨),æ”¯æŒ åˆ é™¤æ“ä½œ,ä½†æ˜¯é’ˆå¯¹æ’å…¥éœ€è¦å…ˆéå†ä¸€é,æœ‰é¢å¤–æ—¶é—´å¼€é”€ å˜é•¿è®°å½•ä¼šæœ‰ä¸€ä¸ªæ§½ç›®å½•æ¥è®°å½•æ¯æ¡è®°å½•ï¼š\u003cè®°å½•åç§»é‡ï¼Œé•¿åº¦\u003e æ’å…¥ è®°å½•æ— åº æ’å…¥åˆ°ä»»æ„å—çš„ç©ºé—²ç©ºé—´ä¸­ æˆ–ç”³è¯·ä¸€ä¸ªæ–°å—ï¼ˆå½“æ‰€æœ‰å—éƒ½å·²æ»¡æ—¶ï¼‰ è®°å½•å˜é•¿æ—¶ï¼Œå¯ä½¿ç”¨åç§»é‡è¡¨ è®°å½•æœ‰åº æ‰¾åˆ°è®°å½•åº”è¯¥æ”¾ç½®çš„å— å¦‚æœæœ‰ç©ºé—´ï¼Œæ”¾å…¥å¹¶è°ƒèŠ‚è®°å½•é¡ºåºå³å¯ï¼Œ å¦åˆ™æœ‰ä¸¤ç§æ–¹æ³•ï¼š åœ¨â€œé‚»è¿‘å—â€ä¸­æ‰¾ç©ºé—´ã€åˆ›å»ºæº¢å‡ºå— åˆ é™¤ åˆ é™¤æ—¶å€™æŠŠç©ºé—´åŠ å…¥å¯ç”¨ç©ºé—´åˆ—è¡¨ä¸­ã€‚ è‹¥ä½¿ç”¨åç§»è¡¨ï¼Œåˆ™å¯ä»¥ä¿®æ”¹åç§»è¡¨é¡¹æŒ‡é’ˆï¼Œå°†å…¶ç½®ç©º è‹¥ä½¿ç”¨é€»è¾‘ï¼ç‰©ç†åœ°å€æ˜ å°„è¡¨ï¼Œåˆ™å¯ä»¥å°†ç‰©ç†åœ°å€ç½®ç©º å¯ä»¥åœ¨è®°å½•é¦–éƒ¨é¢„ç•™ä¸€å¼€å§‹ä½ï¼š0ï¼æœªåˆ é™¤ï¼Œ1ï¼å·²åˆ é™¤ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:3:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è®°å½•çš„ç»„ç»‡æ–¹å¼"},{"categories":null,"content":" è®°å½• å›ºå®šæ ¼å¼å®šé•¿è®°å½•ä¾‹å¦‚è§„å®šäº† (1) E#, 2B integer (2) Ename, 10char (3) Dept, 2B codeï¼Œé‚£ä¹ˆå°±æŒ‰ç…§ â€œ55 smith 02\"è¿™æ ·å­˜å‚¨ sql CREATE TABLE Student( stid CHAR(30) PRIMARY KEY, stname VARCHAR(255), gender CHAR(1), birthdate DATE ) è€ƒè™‘å¯»å€ç‰¹ç‚¹ï¼šè®°å½•å’Œå­—æ®µçš„å¼€å§‹åœ°å€å¿…é¡»æŒ‰4çš„å€æ•°å¯¹é½ï¼Œå…·æœ‰æ›´å¿«çš„è¯»å†™é€Ÿåº¦ï¼Œä½†æ˜¯æµªè´¹ç©ºé—´ã€‚ è®°å½•é¦–éƒ¨ï¼ˆHeadï¼‰ä¼šå­˜å‚¨æè¿°è®°å½•çš„ä¿¡æ¯ è®°å½•ç±»å‹ï¼ˆSchemeï¼‰ è®°å½•é•¿åº¦ æ—¶é—´æˆ³ï¼ˆç”¨äºå¹¶å‘æ§åˆ¶ï¼‰ å…¶ä»–ä¿¡æ¯ å¯å˜æ ¼å¼è®°å½• cpp typedef struct { void *data; int size; } DBT; è®°å½•éƒ½ä»¥â€œKEY+VALUEâ€æ–¹å¼è¡¨ç¤ºï¼ŒKEYä¸VALUEéƒ½ä»¥å­—èŠ‚æµï¼ˆbyte stringï¼‰å­˜å‚¨ ä¼˜ç‚¹ çµæ´»çš„è®°å½•æ ¼å¼ï¼Œé€‚åˆâ€œæ¾æ•£â€è®°å½•ï¼Œå¦‚ç—…äººçš„æ£€éªŒç»“æœ é€‚åˆå¤„ç†é‡å¤å­—æ®µ é€‚åˆè®°å½•æ ¼å¼æ¼”å˜ ç¼ºç‚¹ æ ‡è®°å­˜å‚¨æ–¹å¼ç©ºé—´ä»£ä»·é«˜ KVæ–¹å¼éš¾ä»¥æ”¯æŒå¤æ‚æŸ¥è¯¢ åº”ç”¨è´Ÿæ‹…é‡ä¸”äº‹åŠ¡å¤„ç†ç­‰å®ç°å›°éš¾ å¯å˜æ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å˜é•¿çš„ï¼Œå›ºå®šæ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å®šé•¿çš„ï¼Ÿ å‰åŠå¥å¯¹ï¼ŒååŠå¥ä¸å¯¹ã€‚å¯å˜æ ¼å¼è®°å½•ï¼Œå­—æ®µä¸ªæ•°æˆ–å­—æ®µç±»å‹å¯èƒ½å˜åŒ–ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯å˜é•¿çš„ã€‚ä½†æ˜¯å›ºå®šæ ¼å¼è®°å½•ï¼Œé‡Œé¢çš„æ•°æ®é¡¹ä¸ä¸€å®šæ˜¯å®šé•¿çš„ï¼Œä¾‹å¦‚ Varcharï¼Œæ‰€ä»¥å›ºå®šæ ¼å¼è®°å½•ä¸ä¸€å®šå®šé•¿ã€‚ é¦–éƒ¨æŒ‡é’ˆæ³•(å˜é•¿è®°å½•è¡¨ç¤ºæ³•) å®šé•¿å­—æ®µåœ¨å‰,å˜é•¿å­—æ®µåœ¨å,å¦‚ä¸‹ä¾‹(nameã€addresså˜é•¿): æ··åˆæ ¼å¼ï¼šå®šé•¿è®°å½•+å˜é•¿è®°å½• è®°å½•çš„ç»„ç»‡æ–¹å¼ å®šé•¿è®°å½•é€šå¸¸ç”¨\u003cå—å·ï¼Œæ§½å·\u003eè¡¨ç¤º æ–¹å¼ä¸€: ä½¿ç”¨é¢å¤–çš„ä¸€ä¸ªç©ºé—´è®°å½•å½“å‰è®°å½•æ•°N,å¯¹äºæ’å…¥æ“ä½œæ’å…¥åˆ°ç¬¬N+1çš„æ§½ä¸­å³å¯,åŒæ—¶å°†N-\u003eN+1,ä½†æ˜¯å¯¹ äºåˆ é™¤ä¸å‹å¥½ æ–¹å¼äºŒ: è®°å½•å½“å‰è®°å½•æ•°mçš„æƒ…å†µä¸‹,ä½¿ç”¨é¢å¤–Nçš„ç©ºé—´è®°å½•æ§½æ˜¯å¦å¯ç”¨(ä¾‹å¦‚0å¯ç”¨,1ä¸å¯ç”¨),æ”¯æŒ åˆ é™¤æ“ä½œ,ä½†æ˜¯é’ˆå¯¹æ’å…¥éœ€è¦å…ˆéå†ä¸€é,æœ‰é¢å¤–æ—¶é—´å¼€é”€ å˜é•¿è®°å½•ä¼šæœ‰ä¸€ä¸ªæ§½ç›®å½•æ¥è®°å½•æ¯æ¡è®°å½•ï¼š\u003cè®°å½•åç§»é‡ï¼Œé•¿åº¦\u003e æ’å…¥ è®°å½•æ— åº æ’å…¥åˆ°ä»»æ„å—çš„ç©ºé—²ç©ºé—´ä¸­ æˆ–ç”³è¯·ä¸€ä¸ªæ–°å—ï¼ˆå½“æ‰€æœ‰å—éƒ½å·²æ»¡æ—¶ï¼‰ è®°å½•å˜é•¿æ—¶ï¼Œå¯ä½¿ç”¨åç§»é‡è¡¨ è®°å½•æœ‰åº æ‰¾åˆ°è®°å½•åº”è¯¥æ”¾ç½®çš„å— å¦‚æœæœ‰ç©ºé—´ï¼Œæ”¾å…¥å¹¶è°ƒèŠ‚è®°å½•é¡ºåºå³å¯ï¼Œ å¦åˆ™æœ‰ä¸¤ç§æ–¹æ³•ï¼š åœ¨â€œé‚»è¿‘å—â€ä¸­æ‰¾ç©ºé—´ã€åˆ›å»ºæº¢å‡ºå— åˆ é™¤ åˆ é™¤æ—¶å€™æŠŠç©ºé—´åŠ å…¥å¯ç”¨ç©ºé—´åˆ—è¡¨ä¸­ã€‚ è‹¥ä½¿ç”¨åç§»è¡¨ï¼Œåˆ™å¯ä»¥ä¿®æ”¹åç§»è¡¨é¡¹æŒ‡é’ˆï¼Œå°†å…¶ç½®ç©º è‹¥ä½¿ç”¨é€»è¾‘ï¼ç‰©ç†åœ°å€æ˜ å°„è¡¨ï¼Œåˆ™å¯ä»¥å°†ç‰©ç†åœ°å€ç½®ç©º å¯ä»¥åœ¨è®°å½•é¦–éƒ¨é¢„ç•™ä¸€å¼€å§‹ä½ï¼š0ï¼æœªåˆ é™¤ï¼Œ1ï¼å·²åˆ é™¤ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:3:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ’å…¥"},{"categories":null,"content":" è®°å½• å›ºå®šæ ¼å¼å®šé•¿è®°å½•ä¾‹å¦‚è§„å®šäº† (1) E#, 2B integer (2) Ename, 10char (3) Dept, 2B codeï¼Œé‚£ä¹ˆå°±æŒ‰ç…§ â€œ55 smith 02\"è¿™æ ·å­˜å‚¨ sql CREATE TABLE Student( stid CHAR(30) PRIMARY KEY, stname VARCHAR(255), gender CHAR(1), birthdate DATE ) è€ƒè™‘å¯»å€ç‰¹ç‚¹ï¼šè®°å½•å’Œå­—æ®µçš„å¼€å§‹åœ°å€å¿…é¡»æŒ‰4çš„å€æ•°å¯¹é½ï¼Œå…·æœ‰æ›´å¿«çš„è¯»å†™é€Ÿåº¦ï¼Œä½†æ˜¯æµªè´¹ç©ºé—´ã€‚ è®°å½•é¦–éƒ¨ï¼ˆHeadï¼‰ä¼šå­˜å‚¨æè¿°è®°å½•çš„ä¿¡æ¯ è®°å½•ç±»å‹ï¼ˆSchemeï¼‰ è®°å½•é•¿åº¦ æ—¶é—´æˆ³ï¼ˆç”¨äºå¹¶å‘æ§åˆ¶ï¼‰ å…¶ä»–ä¿¡æ¯ å¯å˜æ ¼å¼è®°å½• cpp typedef struct { void *data; int size; } DBT; è®°å½•éƒ½ä»¥â€œKEY+VALUEâ€æ–¹å¼è¡¨ç¤ºï¼ŒKEYä¸VALUEéƒ½ä»¥å­—èŠ‚æµï¼ˆbyte stringï¼‰å­˜å‚¨ ä¼˜ç‚¹ çµæ´»çš„è®°å½•æ ¼å¼ï¼Œé€‚åˆâ€œæ¾æ•£â€è®°å½•ï¼Œå¦‚ç—…äººçš„æ£€éªŒç»“æœ é€‚åˆå¤„ç†é‡å¤å­—æ®µ é€‚åˆè®°å½•æ ¼å¼æ¼”å˜ ç¼ºç‚¹ æ ‡è®°å­˜å‚¨æ–¹å¼ç©ºé—´ä»£ä»·é«˜ KVæ–¹å¼éš¾ä»¥æ”¯æŒå¤æ‚æŸ¥è¯¢ åº”ç”¨è´Ÿæ‹…é‡ä¸”äº‹åŠ¡å¤„ç†ç­‰å®ç°å›°éš¾ å¯å˜æ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å˜é•¿çš„ï¼Œå›ºå®šæ ¼å¼çš„è®°å½•å¿…å®šæ˜¯å®šé•¿çš„ï¼Ÿ å‰åŠå¥å¯¹ï¼ŒååŠå¥ä¸å¯¹ã€‚å¯å˜æ ¼å¼è®°å½•ï¼Œå­—æ®µä¸ªæ•°æˆ–å­—æ®µç±»å‹å¯èƒ½å˜åŒ–ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯å˜é•¿çš„ã€‚ä½†æ˜¯å›ºå®šæ ¼å¼è®°å½•ï¼Œé‡Œé¢çš„æ•°æ®é¡¹ä¸ä¸€å®šæ˜¯å®šé•¿çš„ï¼Œä¾‹å¦‚ Varcharï¼Œæ‰€ä»¥å›ºå®šæ ¼å¼è®°å½•ä¸ä¸€å®šå®šé•¿ã€‚ é¦–éƒ¨æŒ‡é’ˆæ³•(å˜é•¿è®°å½•è¡¨ç¤ºæ³•) å®šé•¿å­—æ®µåœ¨å‰,å˜é•¿å­—æ®µåœ¨å,å¦‚ä¸‹ä¾‹(nameã€addresså˜é•¿): æ··åˆæ ¼å¼ï¼šå®šé•¿è®°å½•+å˜é•¿è®°å½• è®°å½•çš„ç»„ç»‡æ–¹å¼ å®šé•¿è®°å½•é€šå¸¸ç”¨\u003cå—å·ï¼Œæ§½å·\u003eè¡¨ç¤º æ–¹å¼ä¸€: ä½¿ç”¨é¢å¤–çš„ä¸€ä¸ªç©ºé—´è®°å½•å½“å‰è®°å½•æ•°N,å¯¹äºæ’å…¥æ“ä½œæ’å…¥åˆ°ç¬¬N+1çš„æ§½ä¸­å³å¯,åŒæ—¶å°†N-\u003eN+1,ä½†æ˜¯å¯¹ äºåˆ é™¤ä¸å‹å¥½ æ–¹å¼äºŒ: è®°å½•å½“å‰è®°å½•æ•°mçš„æƒ…å†µä¸‹,ä½¿ç”¨é¢å¤–Nçš„ç©ºé—´è®°å½•æ§½æ˜¯å¦å¯ç”¨(ä¾‹å¦‚0å¯ç”¨,1ä¸å¯ç”¨),æ”¯æŒ åˆ é™¤æ“ä½œ,ä½†æ˜¯é’ˆå¯¹æ’å…¥éœ€è¦å…ˆéå†ä¸€é,æœ‰é¢å¤–æ—¶é—´å¼€é”€ å˜é•¿è®°å½•ä¼šæœ‰ä¸€ä¸ªæ§½ç›®å½•æ¥è®°å½•æ¯æ¡è®°å½•ï¼š\u003cè®°å½•åç§»é‡ï¼Œé•¿åº¦\u003e æ’å…¥ è®°å½•æ— åº æ’å…¥åˆ°ä»»æ„å—çš„ç©ºé—²ç©ºé—´ä¸­ æˆ–ç”³è¯·ä¸€ä¸ªæ–°å—ï¼ˆå½“æ‰€æœ‰å—éƒ½å·²æ»¡æ—¶ï¼‰ è®°å½•å˜é•¿æ—¶ï¼Œå¯ä½¿ç”¨åç§»é‡è¡¨ è®°å½•æœ‰åº æ‰¾åˆ°è®°å½•åº”è¯¥æ”¾ç½®çš„å— å¦‚æœæœ‰ç©ºé—´ï¼Œæ”¾å…¥å¹¶è°ƒèŠ‚è®°å½•é¡ºåºå³å¯ï¼Œ å¦åˆ™æœ‰ä¸¤ç§æ–¹æ³•ï¼š åœ¨â€œé‚»è¿‘å—â€ä¸­æ‰¾ç©ºé—´ã€åˆ›å»ºæº¢å‡ºå— åˆ é™¤ åˆ é™¤æ—¶å€™æŠŠç©ºé—´åŠ å…¥å¯ç”¨ç©ºé—´åˆ—è¡¨ä¸­ã€‚ è‹¥ä½¿ç”¨åç§»è¡¨ï¼Œåˆ™å¯ä»¥ä¿®æ”¹åç§»è¡¨é¡¹æŒ‡é’ˆï¼Œå°†å…¶ç½®ç©º è‹¥ä½¿ç”¨é€»è¾‘ï¼ç‰©ç†åœ°å€æ˜ å°„è¡¨ï¼Œåˆ™å¯ä»¥å°†ç‰©ç†åœ°å€ç½®ç©º å¯ä»¥åœ¨è®°å½•é¦–éƒ¨é¢„ç•™ä¸€å¼€å§‹ä½ï¼š0ï¼æœªåˆ é™¤ï¼Œ1ï¼å·²åˆ é™¤ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:3:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#åˆ é™¤"},{"categories":null,"content":" å— å †æ–‡ä»¶ï¼ˆéšä¾¿æ”¾ï¼‰ æœ€åŸºæœ¬ã€æœ€ç®€å•çš„æ–‡ä»¶ç»“æ„ è®°å½•ä¸ä»¥ä»»ä½•é¡ºåºæ’åº è®°å½•å¯èƒ½å­˜æ”¾åœ¨ç‰©ç†ä¸é‚»æ¥çš„å—ä¸Š æ’å…¥å®¹æ˜“ï¼Œä½†æŸ¥æ‰¾å’Œåˆ é™¤ä»£ä»·é«˜ é“¾è¡¨å¼å †æ–‡ä»¶ç»„ç»‡ï¼šé¦–å— \u003c-\u003e æ•°æ®å— \u003c-\u003e æ•°æ®å— \u003c-\u003e æ•°æ®å— -\u003e å«ç©ºé—²ç©ºé—´çš„å—é“¾è¡¨ ç›®å½•å¼å †æ–‡ä»¶ç»„ç»‡ï¼š [é‚»æ¥æ•°æ®å—é˜µåˆ—ï¼ˆé¦–å—ï¼‰] -\u003e [é‚»æ¥æ•°æ®å—é˜µåˆ—] -\u003e [é‚»æ¥æ•°æ®å—é˜µåˆ—] -\u003e â€¦ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:3:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å—"},{"categories":null,"content":" ç¬¬å››ç«  ç¼“å†²åŒºç®¡ç†","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¬¬å››ç« -ç¼“å†²åŒºç®¡ç†"},{"categories":null,"content":" ç¼“å†²åŒºç»“æ„ Dirtyï¼šFrame ä¸­çš„å—æ˜¯ä¸æ˜¯å·²ç»è¢«ä¿®æ”¹ Pin-countï¼šFrame çš„å—ä¸­å·²ç»è¢«è¯·æ±‚ä½†æ˜¯æ²¡æœ‰è¢«é‡Šæ”¾çš„æ•°é‡ï¼Œå³ç”¨æˆ·æ•° Pageï¼šä¸€èˆ¬æ˜¯é€»è¾‘å•ä½ï¼Œåœ¨é€»è¾‘åœ°å€ç©ºé—´ä¸­ Frameï¼šåœ¨å†…å­˜ã€ç¼“å†²åŒºä¸­çš„å•ä½ Blockï¼šåœ¨ç£ç›˜ä¸Š å¦‚ä½•åŒºåˆ†Pageã€Frameã€Blockï¼Ÿå½“ä¸Šå±‚è¯·æ±‚ä¸€ä¸ª page æ—¶ï¼Œç³»ç»Ÿå…ˆåœ¨å†…å­˜ä¸­çš„ framesï¼ˆç¼“å†²åŒº/é¡µæ¡†ï¼‰ é‡ŒæŸ¥æ‰¾ï¼› è‹¥å‘½ä¸­ï¼Œç›´æ¥è¿”å›è¯¥ frame å·ï¼› è‹¥æœªå‘½ä¸­ï¼Œåˆ™ä»ç£ç›˜ä¸Šè¯¥ page æ‰€åœ¨çš„ block è¯»å…¥å†…å­˜ï¼›è‹¥å†…å­˜å·²æ»¡ï¼Œåˆ™æ ¹æ®æ›¿æ¢ç­–ç•¥é€‰æ‹©ä¸€ä¸ª frame è¿›è¡Œæ›¿æ¢ï¼ˆå¿…è¦æ—¶å…ˆå†™å›å…¶å¯¹åº”çš„ blockï¼‰ï¼›æœ€åå°†æ–° page è£…å…¥è¯¥ frameï¼Œå¹¶è¿”å›è¯¥ frame å·ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¼“å†²åŒºç»“æ„"},{"categories":null,"content":" ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ LRU ä¼˜ç‚¹ï¼š é€‚ç”¨äºæ»¡è¶³æ—¶é—´å±€éƒ¨æ€§çš„åœºæ™¯ï¼ˆå¤šæ¬¡é‡å¤è¯·æ±‚åŒä¸€é¡µï¼‰ é€‰å–frameçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1) ç¼ºç‚¹ï¼š ç¼“å­˜æ±¡æŸ“ï¼šLRU + repreated sequential scans ç»´æŠ¤LRUé“¾è¡¨ä»£ä»·æ˜‚è´µï¼šä¿®æ”¹é“¾è¡¨è€—æ—¶ å¦‚æœè®¿é—®ä¸æ»¡è¶³æ—¶é—´å±€éƒ¨æ€§ï¼Œåˆ™æ€§èƒ½è¾ƒå·® åªè€ƒè™‘æœ€è¿‘ä¸€æ¬¡è®¿é—®ï¼Œä¸è€ƒè™‘è®¿é—®é¢‘ç‡ LRU-K æ•°æ®ç¬¬ä¸€æ¬¡è¢«è®¿é—®ï¼ŒåŠ å…¥åˆ°è®¿é—®å†å²åˆ—è¡¨ï¼› å¦‚æœæ•°æ®åœ¨è®¿é—®å†å²åˆ—è¡¨é‡Œåæ²¡æœ‰è¾¾åˆ°Kæ¬¡è®¿é—®ï¼Œåˆ™æŒ‰ç…§ä¸€å®šè§„åˆ™ï¼ˆFIFOï¼ŒLRUï¼‰æ·˜æ±°ï¼› å½“è®¿é—®å†å²é˜Ÿåˆ—ä¸­çš„æ•°æ®è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡åï¼Œå°†æ•°æ®ç´¢å¼•ä»å†å²é˜Ÿåˆ—åˆ é™¤ï¼Œå°†æ•°æ®ç§»åˆ°ç¼“å­˜é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç¼“å­˜æ­¤æ•°æ®ï¼Œç¼“å­˜é˜Ÿåˆ—é‡æ–°æŒ‰ç…§æ—¶é—´æ’åºï¼› ç¼“å­˜æ•°æ®é˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®åï¼Œé‡æ–°æ’åºï¼› éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼Œæ·˜æ±°ç¼“å­˜é˜Ÿåˆ—ä¸­æ’åœ¨æœ«å°¾çš„æ•°æ®ï¼Œå³ï¼šæ·˜æ±°â€œå€’æ•°ç¬¬Kæ¬¡è®¿é—®ç¦»ç°åœ¨æœ€ä¹…â€çš„æ•°æ®ã€‚ å‡è®¾æœ‰è®¿é—®åºåˆ—ï¼šA B C A D E Aï¼Œé‚£ä¹ˆï¼š ç¬¬ä¸€æ¬¡è®¿é—®ï¼š A â†’ å†å²åˆ—è¡¨ (1 æ¬¡) B â†’ å†å²åˆ—è¡¨ (1 æ¬¡) C â†’ å†å²åˆ—è¡¨ (1 æ¬¡) ç¬¬äºŒæ¬¡è®¿é—®: A â†’ å†å²åˆ—è¡¨è®¿é—®æ¬¡æ•° = 2 â†’ è¾¾åˆ° K â†’ ç§»å…¥ç¼“å­˜é˜Ÿåˆ— ç¬¬ä¸‰æ¬¡è®¿é—®ï¼š A â†’ ç¼“å­˜é˜Ÿåˆ—é‡æ–°æ’åº Dã€E åªè®¿é—®ä¸€æ¬¡ â†’ ä»åœ¨å†å²åˆ—è¡¨æˆ–è¢«æ·˜æ±° â†’ ä¸å ç¼“å­˜ åœ¨ LRU-K é‡Œé¢ï¼Œè®¿é—®å†å²åˆ—è¡¨èµ·åˆ°çš„æ˜¯ è®¡æ•° çš„ä½œç”¨ï¼Œè¾¾åˆ° K æ¬¡çš„æ•°æ®åŠ å…¥ç¼“å­˜ã€‚ 2Qè¯¥ç®—æ³•ç±»ä¼¼äº LRU-2ï¼Œä¸åŒç‚¹åœ¨äº 2Q å°† LRU-2 ç®—æ³•ä¸­çš„è®¿é—®å†å²é˜Ÿåˆ—ï¼ˆæ³¨æ„è¿™ä¸æ˜¯ç¼“å­˜æ•°æ®çš„ï¼‰æ”¹ä¸ºä¸€ä¸ª FIFOç¼“å­˜é˜Ÿåˆ—ï¼Œ2Qç®—æ³•æœ‰ä¸¤ä¸ªç¼“å­˜é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯FIFOé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯LRUé˜Ÿåˆ—ã€‚ æ–°è®¿é—®çš„æ•°æ®æ’å…¥åˆ°FIFOé˜Ÿåˆ—ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­ä¸€ç›´æ²¡æœ‰è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™æœ€ç»ˆæŒ‰ç…§FIFOè§„åˆ™æ·˜æ±°ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› å¦‚æœæ•°æ®åœ¨LRUé˜Ÿåˆ—å†æ¬¡è¢«è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› LRUé˜Ÿåˆ—æ·˜æ±°æœ«å°¾çš„æ•°æ®ã€‚ Second-Chance FIFOå°†æ‰€æœ‰ Frame æŒ‰ç…§ FIFO çš„æ–¹å¼è¿æ¥ï¼Œå¹¶ä¸”æ¯ä¸ª Frame éƒ½é¢å¤–é™„å¸¦ä¸€ä¸ª bit ä½é»˜è®¤ä¸º 0ã€‚ å¦‚æœä¸€ä¸ª Frame è¢«è®¿é—®ï¼Œé‚£ä¹ˆç½®ä¸º 1ã€‚å¦‚æœä¸€ä¸ª Frame è¦è¢«ç½®æ¢äº†ï¼Œå¦‚æœæ ‡å¿—æ˜¯ 0ï¼Œé‚£ä¹ˆç›´æ¥ç½®æ¢ï¼›å¦‚æœæ ‡å¿—æ˜¯ 1ï¼Œé‚£ä¹ˆç»™ä»–ä¸€ä¸ªæœºä¼šï¼Œå°†è¿™ä¸ª Frame æ”¾åˆ° FOï¼ˆé“¾è¡¨å°¾éƒ¨ï¼‰ä½†æ˜¯æ ‡å¿—æ”¹æˆ 0ã€‚ ClockSecond-Chance FIFO å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæ¯æ¬¡æ›´æ–° Frame éœ€è¦è°ƒæ•´é“¾è¡¨å¼€é”€å¾ˆå¤§ã€‚Clock çš„è§£å†³æ–¹æ³•æ˜¯ï¼ŒæŠŠå…¨éƒ¨ Frame éƒ½ç»„ç»‡æˆç¯å½¢ï¼Œå¹¶ä¸”ç”¨ current æŒ‡å‘é¦– Frameã€‚ ä» current å¼€å§‹æ£€æŸ¥ï¼Œè‹¥ pin-count\u003e0ï¼ˆç›¸å½“äºè¢«å ç”¨ï¼‰ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame å¦‚æœ pin-count=0 è‹¥ referenced=1ï¼Œåˆ™ç»™ä»–ä¸€æ¬¡æœºä¼šï¼ŒæŠŠå®ƒç½®ä¸º0ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame è‹¥ referenced=0ï¼Œé‚£ä¹ˆå°±ç½®æ¢å‡ºå»ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª current æŒ‡é’ˆåªåœ¨ç½®æ¢æ—¶æ›´æ–°ï¼Œè®¿é—®å‘½ä¸­æ—¶ä¸æ”¹å˜ current æŒ‡é’ˆ ä¸ºä½•ä¸ä½¿ç”¨ OS ç¼“å†²åŒºç®¡ç† DBMS ç»å¸¸èƒ½é¢„æµ‹è®¿é—®æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨æ›´ä¸“é—¨çš„ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ã€‚DBMSéœ€è¦å¼ºåˆ¶å†™å›ç£ç›˜èƒ½åŠ›ï¼ˆå¦‚WALï¼‰ï¼ŒOSçš„ç¼“å†²å†™ å›ä¸€èˆ¬é€šè¿‡è®°å½•å†™è¯·æ±‚æ¥å®ç°ï¼ˆæ¥è‡ªä¸åŒåº”ç”¨ï¼‰ï¼Œå®é™…çš„ ç£ç›˜ä¿®æ”¹æ¨è¿Ÿï¼Œå› æ­¤ä¸èƒ½ä¿è¯å†™é¡ºåºã€‚ å„ç§ç®—æ³•éƒ½è§£å†³äº†ä»€ä¹ˆé—®é¢˜ LRU-K å’Œ 2Q é€šè¿‡é¢å¤–é˜Ÿåˆ—è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Second-Chance FIFO é€šè¿‡æ ‡è®°ä½è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Clock æ˜¯é€šè¿‡å¾ªç¯é˜Ÿåˆ—è§£å†³äº† Second-Chance FIFO ä¿®æ”¹é“¾è¡¨å¼€é”€å¤§çš„é—®é¢˜ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥"},{"categories":null,"content":" ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ LRU ä¼˜ç‚¹ï¼š é€‚ç”¨äºæ»¡è¶³æ—¶é—´å±€éƒ¨æ€§çš„åœºæ™¯ï¼ˆå¤šæ¬¡é‡å¤è¯·æ±‚åŒä¸€é¡µï¼‰ é€‰å–frameçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1) ç¼ºç‚¹ï¼š ç¼“å­˜æ±¡æŸ“ï¼šLRU + repreated sequential scans ç»´æŠ¤LRUé“¾è¡¨ä»£ä»·æ˜‚è´µï¼šä¿®æ”¹é“¾è¡¨è€—æ—¶ å¦‚æœè®¿é—®ä¸æ»¡è¶³æ—¶é—´å±€éƒ¨æ€§ï¼Œåˆ™æ€§èƒ½è¾ƒå·® åªè€ƒè™‘æœ€è¿‘ä¸€æ¬¡è®¿é—®ï¼Œä¸è€ƒè™‘è®¿é—®é¢‘ç‡ LRU-K æ•°æ®ç¬¬ä¸€æ¬¡è¢«è®¿é—®ï¼ŒåŠ å…¥åˆ°è®¿é—®å†å²åˆ—è¡¨ï¼› å¦‚æœæ•°æ®åœ¨è®¿é—®å†å²åˆ—è¡¨é‡Œåæ²¡æœ‰è¾¾åˆ°Kæ¬¡è®¿é—®ï¼Œåˆ™æŒ‰ç…§ä¸€å®šè§„åˆ™ï¼ˆFIFOï¼ŒLRUï¼‰æ·˜æ±°ï¼› å½“è®¿é—®å†å²é˜Ÿåˆ—ä¸­çš„æ•°æ®è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡åï¼Œå°†æ•°æ®ç´¢å¼•ä»å†å²é˜Ÿåˆ—åˆ é™¤ï¼Œå°†æ•°æ®ç§»åˆ°ç¼“å­˜é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç¼“å­˜æ­¤æ•°æ®ï¼Œç¼“å­˜é˜Ÿåˆ—é‡æ–°æŒ‰ç…§æ—¶é—´æ’åºï¼› ç¼“å­˜æ•°æ®é˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®åï¼Œé‡æ–°æ’åºï¼› éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼Œæ·˜æ±°ç¼“å­˜é˜Ÿåˆ—ä¸­æ’åœ¨æœ«å°¾çš„æ•°æ®ï¼Œå³ï¼šæ·˜æ±°â€œå€’æ•°ç¬¬Kæ¬¡è®¿é—®ç¦»ç°åœ¨æœ€ä¹…â€çš„æ•°æ®ã€‚ å‡è®¾æœ‰è®¿é—®åºåˆ—ï¼šA B C A D E Aï¼Œé‚£ä¹ˆï¼š ç¬¬ä¸€æ¬¡è®¿é—®ï¼š A â†’ å†å²åˆ—è¡¨ (1 æ¬¡) B â†’ å†å²åˆ—è¡¨ (1 æ¬¡) C â†’ å†å²åˆ—è¡¨ (1 æ¬¡) ç¬¬äºŒæ¬¡è®¿é—®: A â†’ å†å²åˆ—è¡¨è®¿é—®æ¬¡æ•° = 2 â†’ è¾¾åˆ° K â†’ ç§»å…¥ç¼“å­˜é˜Ÿåˆ— ç¬¬ä¸‰æ¬¡è®¿é—®ï¼š A â†’ ç¼“å­˜é˜Ÿåˆ—é‡æ–°æ’åº Dã€E åªè®¿é—®ä¸€æ¬¡ â†’ ä»åœ¨å†å²åˆ—è¡¨æˆ–è¢«æ·˜æ±° â†’ ä¸å ç¼“å­˜ åœ¨ LRU-K é‡Œé¢ï¼Œè®¿é—®å†å²åˆ—è¡¨èµ·åˆ°çš„æ˜¯ è®¡æ•° çš„ä½œç”¨ï¼Œè¾¾åˆ° K æ¬¡çš„æ•°æ®åŠ å…¥ç¼“å­˜ã€‚ 2Qè¯¥ç®—æ³•ç±»ä¼¼äº LRU-2ï¼Œä¸åŒç‚¹åœ¨äº 2Q å°† LRU-2 ç®—æ³•ä¸­çš„è®¿é—®å†å²é˜Ÿåˆ—ï¼ˆæ³¨æ„è¿™ä¸æ˜¯ç¼“å­˜æ•°æ®çš„ï¼‰æ”¹ä¸ºä¸€ä¸ª FIFOç¼“å­˜é˜Ÿåˆ—ï¼Œ2Qç®—æ³•æœ‰ä¸¤ä¸ªç¼“å­˜é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯FIFOé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯LRUé˜Ÿåˆ—ã€‚ æ–°è®¿é—®çš„æ•°æ®æ’å…¥åˆ°FIFOé˜Ÿåˆ—ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­ä¸€ç›´æ²¡æœ‰è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™æœ€ç»ˆæŒ‰ç…§FIFOè§„åˆ™æ·˜æ±°ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› å¦‚æœæ•°æ®åœ¨LRUé˜Ÿåˆ—å†æ¬¡è¢«è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› LRUé˜Ÿåˆ—æ·˜æ±°æœ«å°¾çš„æ•°æ®ã€‚ Second-Chance FIFOå°†æ‰€æœ‰ Frame æŒ‰ç…§ FIFO çš„æ–¹å¼è¿æ¥ï¼Œå¹¶ä¸”æ¯ä¸ª Frame éƒ½é¢å¤–é™„å¸¦ä¸€ä¸ª bit ä½é»˜è®¤ä¸º 0ã€‚ å¦‚æœä¸€ä¸ª Frame è¢«è®¿é—®ï¼Œé‚£ä¹ˆç½®ä¸º 1ã€‚å¦‚æœä¸€ä¸ª Frame è¦è¢«ç½®æ¢äº†ï¼Œå¦‚æœæ ‡å¿—æ˜¯ 0ï¼Œé‚£ä¹ˆç›´æ¥ç½®æ¢ï¼›å¦‚æœæ ‡å¿—æ˜¯ 1ï¼Œé‚£ä¹ˆç»™ä»–ä¸€ä¸ªæœºä¼šï¼Œå°†è¿™ä¸ª Frame æ”¾åˆ° FOï¼ˆé“¾è¡¨å°¾éƒ¨ï¼‰ä½†æ˜¯æ ‡å¿—æ”¹æˆ 0ã€‚ ClockSecond-Chance FIFO å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæ¯æ¬¡æ›´æ–° Frame éœ€è¦è°ƒæ•´é“¾è¡¨å¼€é”€å¾ˆå¤§ã€‚Clock çš„è§£å†³æ–¹æ³•æ˜¯ï¼ŒæŠŠå…¨éƒ¨ Frame éƒ½ç»„ç»‡æˆç¯å½¢ï¼Œå¹¶ä¸”ç”¨ current æŒ‡å‘é¦– Frameã€‚ ä» current å¼€å§‹æ£€æŸ¥ï¼Œè‹¥ pin-count\u003e0ï¼ˆç›¸å½“äºè¢«å ç”¨ï¼‰ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame å¦‚æœ pin-count=0 è‹¥ referenced=1ï¼Œåˆ™ç»™ä»–ä¸€æ¬¡æœºä¼šï¼ŒæŠŠå®ƒç½®ä¸º0ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame è‹¥ referenced=0ï¼Œé‚£ä¹ˆå°±ç½®æ¢å‡ºå»ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª current æŒ‡é’ˆåªåœ¨ç½®æ¢æ—¶æ›´æ–°ï¼Œè®¿é—®å‘½ä¸­æ—¶ä¸æ”¹å˜ current æŒ‡é’ˆ ä¸ºä½•ä¸ä½¿ç”¨ OS ç¼“å†²åŒºç®¡ç† DBMS ç»å¸¸èƒ½é¢„æµ‹è®¿é—®æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨æ›´ä¸“é—¨çš„ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ã€‚DBMSéœ€è¦å¼ºåˆ¶å†™å›ç£ç›˜èƒ½åŠ›ï¼ˆå¦‚WALï¼‰ï¼ŒOSçš„ç¼“å†²å†™ å›ä¸€èˆ¬é€šè¿‡è®°å½•å†™è¯·æ±‚æ¥å®ç°ï¼ˆæ¥è‡ªä¸åŒåº”ç”¨ï¼‰ï¼Œå®é™…çš„ ç£ç›˜ä¿®æ”¹æ¨è¿Ÿï¼Œå› æ­¤ä¸èƒ½ä¿è¯å†™é¡ºåºã€‚ å„ç§ç®—æ³•éƒ½è§£å†³äº†ä»€ä¹ˆé—®é¢˜ LRU-K å’Œ 2Q é€šè¿‡é¢å¤–é˜Ÿåˆ—è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Second-Chance FIFO é€šè¿‡æ ‡è®°ä½è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Clock æ˜¯é€šè¿‡å¾ªç¯é˜Ÿåˆ—è§£å†³äº† Second-Chance FIFO ä¿®æ”¹é“¾è¡¨å¼€é”€å¤§çš„é—®é¢˜ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#lru"},{"categories":null,"content":" ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ LRU ä¼˜ç‚¹ï¼š é€‚ç”¨äºæ»¡è¶³æ—¶é—´å±€éƒ¨æ€§çš„åœºæ™¯ï¼ˆå¤šæ¬¡é‡å¤è¯·æ±‚åŒä¸€é¡µï¼‰ é€‰å–frameçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1) ç¼ºç‚¹ï¼š ç¼“å­˜æ±¡æŸ“ï¼šLRU + repreated sequential scans ç»´æŠ¤LRUé“¾è¡¨ä»£ä»·æ˜‚è´µï¼šä¿®æ”¹é“¾è¡¨è€—æ—¶ å¦‚æœè®¿é—®ä¸æ»¡è¶³æ—¶é—´å±€éƒ¨æ€§ï¼Œåˆ™æ€§èƒ½è¾ƒå·® åªè€ƒè™‘æœ€è¿‘ä¸€æ¬¡è®¿é—®ï¼Œä¸è€ƒè™‘è®¿é—®é¢‘ç‡ LRU-K æ•°æ®ç¬¬ä¸€æ¬¡è¢«è®¿é—®ï¼ŒåŠ å…¥åˆ°è®¿é—®å†å²åˆ—è¡¨ï¼› å¦‚æœæ•°æ®åœ¨è®¿é—®å†å²åˆ—è¡¨é‡Œåæ²¡æœ‰è¾¾åˆ°Kæ¬¡è®¿é—®ï¼Œåˆ™æŒ‰ç…§ä¸€å®šè§„åˆ™ï¼ˆFIFOï¼ŒLRUï¼‰æ·˜æ±°ï¼› å½“è®¿é—®å†å²é˜Ÿåˆ—ä¸­çš„æ•°æ®è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡åï¼Œå°†æ•°æ®ç´¢å¼•ä»å†å²é˜Ÿåˆ—åˆ é™¤ï¼Œå°†æ•°æ®ç§»åˆ°ç¼“å­˜é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç¼“å­˜æ­¤æ•°æ®ï¼Œç¼“å­˜é˜Ÿåˆ—é‡æ–°æŒ‰ç…§æ—¶é—´æ’åºï¼› ç¼“å­˜æ•°æ®é˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®åï¼Œé‡æ–°æ’åºï¼› éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼Œæ·˜æ±°ç¼“å­˜é˜Ÿåˆ—ä¸­æ’åœ¨æœ«å°¾çš„æ•°æ®ï¼Œå³ï¼šæ·˜æ±°â€œå€’æ•°ç¬¬Kæ¬¡è®¿é—®ç¦»ç°åœ¨æœ€ä¹…â€çš„æ•°æ®ã€‚ å‡è®¾æœ‰è®¿é—®åºåˆ—ï¼šA B C A D E Aï¼Œé‚£ä¹ˆï¼š ç¬¬ä¸€æ¬¡è®¿é—®ï¼š A â†’ å†å²åˆ—è¡¨ (1 æ¬¡) B â†’ å†å²åˆ—è¡¨ (1 æ¬¡) C â†’ å†å²åˆ—è¡¨ (1 æ¬¡) ç¬¬äºŒæ¬¡è®¿é—®: A â†’ å†å²åˆ—è¡¨è®¿é—®æ¬¡æ•° = 2 â†’ è¾¾åˆ° K â†’ ç§»å…¥ç¼“å­˜é˜Ÿåˆ— ç¬¬ä¸‰æ¬¡è®¿é—®ï¼š A â†’ ç¼“å­˜é˜Ÿåˆ—é‡æ–°æ’åº Dã€E åªè®¿é—®ä¸€æ¬¡ â†’ ä»åœ¨å†å²åˆ—è¡¨æˆ–è¢«æ·˜æ±° â†’ ä¸å ç¼“å­˜ åœ¨ LRU-K é‡Œé¢ï¼Œè®¿é—®å†å²åˆ—è¡¨èµ·åˆ°çš„æ˜¯ è®¡æ•° çš„ä½œç”¨ï¼Œè¾¾åˆ° K æ¬¡çš„æ•°æ®åŠ å…¥ç¼“å­˜ã€‚ 2Qè¯¥ç®—æ³•ç±»ä¼¼äº LRU-2ï¼Œä¸åŒç‚¹åœ¨äº 2Q å°† LRU-2 ç®—æ³•ä¸­çš„è®¿é—®å†å²é˜Ÿåˆ—ï¼ˆæ³¨æ„è¿™ä¸æ˜¯ç¼“å­˜æ•°æ®çš„ï¼‰æ”¹ä¸ºä¸€ä¸ª FIFOç¼“å­˜é˜Ÿåˆ—ï¼Œ2Qç®—æ³•æœ‰ä¸¤ä¸ªç¼“å­˜é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯FIFOé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯LRUé˜Ÿåˆ—ã€‚ æ–°è®¿é—®çš„æ•°æ®æ’å…¥åˆ°FIFOé˜Ÿåˆ—ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­ä¸€ç›´æ²¡æœ‰è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™æœ€ç»ˆæŒ‰ç…§FIFOè§„åˆ™æ·˜æ±°ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› å¦‚æœæ•°æ®åœ¨LRUé˜Ÿåˆ—å†æ¬¡è¢«è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› LRUé˜Ÿåˆ—æ·˜æ±°æœ«å°¾çš„æ•°æ®ã€‚ Second-Chance FIFOå°†æ‰€æœ‰ Frame æŒ‰ç…§ FIFO çš„æ–¹å¼è¿æ¥ï¼Œå¹¶ä¸”æ¯ä¸ª Frame éƒ½é¢å¤–é™„å¸¦ä¸€ä¸ª bit ä½é»˜è®¤ä¸º 0ã€‚ å¦‚æœä¸€ä¸ª Frame è¢«è®¿é—®ï¼Œé‚£ä¹ˆç½®ä¸º 1ã€‚å¦‚æœä¸€ä¸ª Frame è¦è¢«ç½®æ¢äº†ï¼Œå¦‚æœæ ‡å¿—æ˜¯ 0ï¼Œé‚£ä¹ˆç›´æ¥ç½®æ¢ï¼›å¦‚æœæ ‡å¿—æ˜¯ 1ï¼Œé‚£ä¹ˆç»™ä»–ä¸€ä¸ªæœºä¼šï¼Œå°†è¿™ä¸ª Frame æ”¾åˆ° FOï¼ˆé“¾è¡¨å°¾éƒ¨ï¼‰ä½†æ˜¯æ ‡å¿—æ”¹æˆ 0ã€‚ ClockSecond-Chance FIFO å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæ¯æ¬¡æ›´æ–° Frame éœ€è¦è°ƒæ•´é“¾è¡¨å¼€é”€å¾ˆå¤§ã€‚Clock çš„è§£å†³æ–¹æ³•æ˜¯ï¼ŒæŠŠå…¨éƒ¨ Frame éƒ½ç»„ç»‡æˆç¯å½¢ï¼Œå¹¶ä¸”ç”¨ current æŒ‡å‘é¦– Frameã€‚ ä» current å¼€å§‹æ£€æŸ¥ï¼Œè‹¥ pin-count\u003e0ï¼ˆç›¸å½“äºè¢«å ç”¨ï¼‰ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame å¦‚æœ pin-count=0 è‹¥ referenced=1ï¼Œåˆ™ç»™ä»–ä¸€æ¬¡æœºä¼šï¼ŒæŠŠå®ƒç½®ä¸º0ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame è‹¥ referenced=0ï¼Œé‚£ä¹ˆå°±ç½®æ¢å‡ºå»ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª current æŒ‡é’ˆåªåœ¨ç½®æ¢æ—¶æ›´æ–°ï¼Œè®¿é—®å‘½ä¸­æ—¶ä¸æ”¹å˜ current æŒ‡é’ˆ ä¸ºä½•ä¸ä½¿ç”¨ OS ç¼“å†²åŒºç®¡ç† DBMS ç»å¸¸èƒ½é¢„æµ‹è®¿é—®æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨æ›´ä¸“é—¨çš„ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ã€‚DBMSéœ€è¦å¼ºåˆ¶å†™å›ç£ç›˜èƒ½åŠ›ï¼ˆå¦‚WALï¼‰ï¼ŒOSçš„ç¼“å†²å†™ å›ä¸€èˆ¬é€šè¿‡è®°å½•å†™è¯·æ±‚æ¥å®ç°ï¼ˆæ¥è‡ªä¸åŒåº”ç”¨ï¼‰ï¼Œå®é™…çš„ ç£ç›˜ä¿®æ”¹æ¨è¿Ÿï¼Œå› æ­¤ä¸èƒ½ä¿è¯å†™é¡ºåºã€‚ å„ç§ç®—æ³•éƒ½è§£å†³äº†ä»€ä¹ˆé—®é¢˜ LRU-K å’Œ 2Q é€šè¿‡é¢å¤–é˜Ÿåˆ—è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Second-Chance FIFO é€šè¿‡æ ‡è®°ä½è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Clock æ˜¯é€šè¿‡å¾ªç¯é˜Ÿåˆ—è§£å†³äº† Second-Chance FIFO ä¿®æ”¹é“¾è¡¨å¼€é”€å¤§çš„é—®é¢˜ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#lru-k"},{"categories":null,"content":" ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ LRU ä¼˜ç‚¹ï¼š é€‚ç”¨äºæ»¡è¶³æ—¶é—´å±€éƒ¨æ€§çš„åœºæ™¯ï¼ˆå¤šæ¬¡é‡å¤è¯·æ±‚åŒä¸€é¡µï¼‰ é€‰å–frameçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1) ç¼ºç‚¹ï¼š ç¼“å­˜æ±¡æŸ“ï¼šLRU + repreated sequential scans ç»´æŠ¤LRUé“¾è¡¨ä»£ä»·æ˜‚è´µï¼šä¿®æ”¹é“¾è¡¨è€—æ—¶ å¦‚æœè®¿é—®ä¸æ»¡è¶³æ—¶é—´å±€éƒ¨æ€§ï¼Œåˆ™æ€§èƒ½è¾ƒå·® åªè€ƒè™‘æœ€è¿‘ä¸€æ¬¡è®¿é—®ï¼Œä¸è€ƒè™‘è®¿é—®é¢‘ç‡ LRU-K æ•°æ®ç¬¬ä¸€æ¬¡è¢«è®¿é—®ï¼ŒåŠ å…¥åˆ°è®¿é—®å†å²åˆ—è¡¨ï¼› å¦‚æœæ•°æ®åœ¨è®¿é—®å†å²åˆ—è¡¨é‡Œåæ²¡æœ‰è¾¾åˆ°Kæ¬¡è®¿é—®ï¼Œåˆ™æŒ‰ç…§ä¸€å®šè§„åˆ™ï¼ˆFIFOï¼ŒLRUï¼‰æ·˜æ±°ï¼› å½“è®¿é—®å†å²é˜Ÿåˆ—ä¸­çš„æ•°æ®è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡åï¼Œå°†æ•°æ®ç´¢å¼•ä»å†å²é˜Ÿåˆ—åˆ é™¤ï¼Œå°†æ•°æ®ç§»åˆ°ç¼“å­˜é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç¼“å­˜æ­¤æ•°æ®ï¼Œç¼“å­˜é˜Ÿåˆ—é‡æ–°æŒ‰ç…§æ—¶é—´æ’åºï¼› ç¼“å­˜æ•°æ®é˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®åï¼Œé‡æ–°æ’åºï¼› éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼Œæ·˜æ±°ç¼“å­˜é˜Ÿåˆ—ä¸­æ’åœ¨æœ«å°¾çš„æ•°æ®ï¼Œå³ï¼šæ·˜æ±°â€œå€’æ•°ç¬¬Kæ¬¡è®¿é—®ç¦»ç°åœ¨æœ€ä¹…â€çš„æ•°æ®ã€‚ å‡è®¾æœ‰è®¿é—®åºåˆ—ï¼šA B C A D E Aï¼Œé‚£ä¹ˆï¼š ç¬¬ä¸€æ¬¡è®¿é—®ï¼š A â†’ å†å²åˆ—è¡¨ (1 æ¬¡) B â†’ å†å²åˆ—è¡¨ (1 æ¬¡) C â†’ å†å²åˆ—è¡¨ (1 æ¬¡) ç¬¬äºŒæ¬¡è®¿é—®: A â†’ å†å²åˆ—è¡¨è®¿é—®æ¬¡æ•° = 2 â†’ è¾¾åˆ° K â†’ ç§»å…¥ç¼“å­˜é˜Ÿåˆ— ç¬¬ä¸‰æ¬¡è®¿é—®ï¼š A â†’ ç¼“å­˜é˜Ÿåˆ—é‡æ–°æ’åº Dã€E åªè®¿é—®ä¸€æ¬¡ â†’ ä»åœ¨å†å²åˆ—è¡¨æˆ–è¢«æ·˜æ±° â†’ ä¸å ç¼“å­˜ åœ¨ LRU-K é‡Œé¢ï¼Œè®¿é—®å†å²åˆ—è¡¨èµ·åˆ°çš„æ˜¯ è®¡æ•° çš„ä½œç”¨ï¼Œè¾¾åˆ° K æ¬¡çš„æ•°æ®åŠ å…¥ç¼“å­˜ã€‚ 2Qè¯¥ç®—æ³•ç±»ä¼¼äº LRU-2ï¼Œä¸åŒç‚¹åœ¨äº 2Q å°† LRU-2 ç®—æ³•ä¸­çš„è®¿é—®å†å²é˜Ÿåˆ—ï¼ˆæ³¨æ„è¿™ä¸æ˜¯ç¼“å­˜æ•°æ®çš„ï¼‰æ”¹ä¸ºä¸€ä¸ª FIFOç¼“å­˜é˜Ÿåˆ—ï¼Œ2Qç®—æ³•æœ‰ä¸¤ä¸ªç¼“å­˜é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯FIFOé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯LRUé˜Ÿåˆ—ã€‚ æ–°è®¿é—®çš„æ•°æ®æ’å…¥åˆ°FIFOé˜Ÿåˆ—ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­ä¸€ç›´æ²¡æœ‰è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™æœ€ç»ˆæŒ‰ç…§FIFOè§„åˆ™æ·˜æ±°ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› å¦‚æœæ•°æ®åœ¨LRUé˜Ÿåˆ—å†æ¬¡è¢«è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› LRUé˜Ÿåˆ—æ·˜æ±°æœ«å°¾çš„æ•°æ®ã€‚ Second-Chance FIFOå°†æ‰€æœ‰ Frame æŒ‰ç…§ FIFO çš„æ–¹å¼è¿æ¥ï¼Œå¹¶ä¸”æ¯ä¸ª Frame éƒ½é¢å¤–é™„å¸¦ä¸€ä¸ª bit ä½é»˜è®¤ä¸º 0ã€‚ å¦‚æœä¸€ä¸ª Frame è¢«è®¿é—®ï¼Œé‚£ä¹ˆç½®ä¸º 1ã€‚å¦‚æœä¸€ä¸ª Frame è¦è¢«ç½®æ¢äº†ï¼Œå¦‚æœæ ‡å¿—æ˜¯ 0ï¼Œé‚£ä¹ˆç›´æ¥ç½®æ¢ï¼›å¦‚æœæ ‡å¿—æ˜¯ 1ï¼Œé‚£ä¹ˆç»™ä»–ä¸€ä¸ªæœºä¼šï¼Œå°†è¿™ä¸ª Frame æ”¾åˆ° FOï¼ˆé“¾è¡¨å°¾éƒ¨ï¼‰ä½†æ˜¯æ ‡å¿—æ”¹æˆ 0ã€‚ ClockSecond-Chance FIFO å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæ¯æ¬¡æ›´æ–° Frame éœ€è¦è°ƒæ•´é“¾è¡¨å¼€é”€å¾ˆå¤§ã€‚Clock çš„è§£å†³æ–¹æ³•æ˜¯ï¼ŒæŠŠå…¨éƒ¨ Frame éƒ½ç»„ç»‡æˆç¯å½¢ï¼Œå¹¶ä¸”ç”¨ current æŒ‡å‘é¦– Frameã€‚ ä» current å¼€å§‹æ£€æŸ¥ï¼Œè‹¥ pin-count\u003e0ï¼ˆç›¸å½“äºè¢«å ç”¨ï¼‰ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame å¦‚æœ pin-count=0 è‹¥ referenced=1ï¼Œåˆ™ç»™ä»–ä¸€æ¬¡æœºä¼šï¼ŒæŠŠå®ƒç½®ä¸º0ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame è‹¥ referenced=0ï¼Œé‚£ä¹ˆå°±ç½®æ¢å‡ºå»ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª current æŒ‡é’ˆåªåœ¨ç½®æ¢æ—¶æ›´æ–°ï¼Œè®¿é—®å‘½ä¸­æ—¶ä¸æ”¹å˜ current æŒ‡é’ˆ ä¸ºä½•ä¸ä½¿ç”¨ OS ç¼“å†²åŒºç®¡ç† DBMS ç»å¸¸èƒ½é¢„æµ‹è®¿é—®æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨æ›´ä¸“é—¨çš„ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ã€‚DBMSéœ€è¦å¼ºåˆ¶å†™å›ç£ç›˜èƒ½åŠ›ï¼ˆå¦‚WALï¼‰ï¼ŒOSçš„ç¼“å†²å†™ å›ä¸€èˆ¬é€šè¿‡è®°å½•å†™è¯·æ±‚æ¥å®ç°ï¼ˆæ¥è‡ªä¸åŒåº”ç”¨ï¼‰ï¼Œå®é™…çš„ ç£ç›˜ä¿®æ”¹æ¨è¿Ÿï¼Œå› æ­¤ä¸èƒ½ä¿è¯å†™é¡ºåºã€‚ å„ç§ç®—æ³•éƒ½è§£å†³äº†ä»€ä¹ˆé—®é¢˜ LRU-K å’Œ 2Q é€šè¿‡é¢å¤–é˜Ÿåˆ—è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Second-Chance FIFO é€šè¿‡æ ‡è®°ä½è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Clock æ˜¯é€šè¿‡å¾ªç¯é˜Ÿåˆ—è§£å†³äº† Second-Chance FIFO ä¿®æ”¹é“¾è¡¨å¼€é”€å¤§çš„é—®é¢˜ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#2q"},{"categories":null,"content":" ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ LRU ä¼˜ç‚¹ï¼š é€‚ç”¨äºæ»¡è¶³æ—¶é—´å±€éƒ¨æ€§çš„åœºæ™¯ï¼ˆå¤šæ¬¡é‡å¤è¯·æ±‚åŒä¸€é¡µï¼‰ é€‰å–frameçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1) ç¼ºç‚¹ï¼š ç¼“å­˜æ±¡æŸ“ï¼šLRU + repreated sequential scans ç»´æŠ¤LRUé“¾è¡¨ä»£ä»·æ˜‚è´µï¼šä¿®æ”¹é“¾è¡¨è€—æ—¶ å¦‚æœè®¿é—®ä¸æ»¡è¶³æ—¶é—´å±€éƒ¨æ€§ï¼Œåˆ™æ€§èƒ½è¾ƒå·® åªè€ƒè™‘æœ€è¿‘ä¸€æ¬¡è®¿é—®ï¼Œä¸è€ƒè™‘è®¿é—®é¢‘ç‡ LRU-K æ•°æ®ç¬¬ä¸€æ¬¡è¢«è®¿é—®ï¼ŒåŠ å…¥åˆ°è®¿é—®å†å²åˆ—è¡¨ï¼› å¦‚æœæ•°æ®åœ¨è®¿é—®å†å²åˆ—è¡¨é‡Œåæ²¡æœ‰è¾¾åˆ°Kæ¬¡è®¿é—®ï¼Œåˆ™æŒ‰ç…§ä¸€å®šè§„åˆ™ï¼ˆFIFOï¼ŒLRUï¼‰æ·˜æ±°ï¼› å½“è®¿é—®å†å²é˜Ÿåˆ—ä¸­çš„æ•°æ®è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡åï¼Œå°†æ•°æ®ç´¢å¼•ä»å†å²é˜Ÿåˆ—åˆ é™¤ï¼Œå°†æ•°æ®ç§»åˆ°ç¼“å­˜é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç¼“å­˜æ­¤æ•°æ®ï¼Œç¼“å­˜é˜Ÿåˆ—é‡æ–°æŒ‰ç…§æ—¶é—´æ’åºï¼› ç¼“å­˜æ•°æ®é˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®åï¼Œé‡æ–°æ’åºï¼› éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼Œæ·˜æ±°ç¼“å­˜é˜Ÿåˆ—ä¸­æ’åœ¨æœ«å°¾çš„æ•°æ®ï¼Œå³ï¼šæ·˜æ±°â€œå€’æ•°ç¬¬Kæ¬¡è®¿é—®ç¦»ç°åœ¨æœ€ä¹…â€çš„æ•°æ®ã€‚ å‡è®¾æœ‰è®¿é—®åºåˆ—ï¼šA B C A D E Aï¼Œé‚£ä¹ˆï¼š ç¬¬ä¸€æ¬¡è®¿é—®ï¼š A â†’ å†å²åˆ—è¡¨ (1 æ¬¡) B â†’ å†å²åˆ—è¡¨ (1 æ¬¡) C â†’ å†å²åˆ—è¡¨ (1 æ¬¡) ç¬¬äºŒæ¬¡è®¿é—®: A â†’ å†å²åˆ—è¡¨è®¿é—®æ¬¡æ•° = 2 â†’ è¾¾åˆ° K â†’ ç§»å…¥ç¼“å­˜é˜Ÿåˆ— ç¬¬ä¸‰æ¬¡è®¿é—®ï¼š A â†’ ç¼“å­˜é˜Ÿåˆ—é‡æ–°æ’åº Dã€E åªè®¿é—®ä¸€æ¬¡ â†’ ä»åœ¨å†å²åˆ—è¡¨æˆ–è¢«æ·˜æ±° â†’ ä¸å ç¼“å­˜ åœ¨ LRU-K é‡Œé¢ï¼Œè®¿é—®å†å²åˆ—è¡¨èµ·åˆ°çš„æ˜¯ è®¡æ•° çš„ä½œç”¨ï¼Œè¾¾åˆ° K æ¬¡çš„æ•°æ®åŠ å…¥ç¼“å­˜ã€‚ 2Qè¯¥ç®—æ³•ç±»ä¼¼äº LRU-2ï¼Œä¸åŒç‚¹åœ¨äº 2Q å°† LRU-2 ç®—æ³•ä¸­çš„è®¿é—®å†å²é˜Ÿåˆ—ï¼ˆæ³¨æ„è¿™ä¸æ˜¯ç¼“å­˜æ•°æ®çš„ï¼‰æ”¹ä¸ºä¸€ä¸ª FIFOç¼“å­˜é˜Ÿåˆ—ï¼Œ2Qç®—æ³•æœ‰ä¸¤ä¸ªç¼“å­˜é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯FIFOé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯LRUé˜Ÿåˆ—ã€‚ æ–°è®¿é—®çš„æ•°æ®æ’å…¥åˆ°FIFOé˜Ÿåˆ—ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­ä¸€ç›´æ²¡æœ‰è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™æœ€ç»ˆæŒ‰ç…§FIFOè§„åˆ™æ·˜æ±°ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› å¦‚æœæ•°æ®åœ¨LRUé˜Ÿåˆ—å†æ¬¡è¢«è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› LRUé˜Ÿåˆ—æ·˜æ±°æœ«å°¾çš„æ•°æ®ã€‚ Second-Chance FIFOå°†æ‰€æœ‰ Frame æŒ‰ç…§ FIFO çš„æ–¹å¼è¿æ¥ï¼Œå¹¶ä¸”æ¯ä¸ª Frame éƒ½é¢å¤–é™„å¸¦ä¸€ä¸ª bit ä½é»˜è®¤ä¸º 0ã€‚ å¦‚æœä¸€ä¸ª Frame è¢«è®¿é—®ï¼Œé‚£ä¹ˆç½®ä¸º 1ã€‚å¦‚æœä¸€ä¸ª Frame è¦è¢«ç½®æ¢äº†ï¼Œå¦‚æœæ ‡å¿—æ˜¯ 0ï¼Œé‚£ä¹ˆç›´æ¥ç½®æ¢ï¼›å¦‚æœæ ‡å¿—æ˜¯ 1ï¼Œé‚£ä¹ˆç»™ä»–ä¸€ä¸ªæœºä¼šï¼Œå°†è¿™ä¸ª Frame æ”¾åˆ° FOï¼ˆé“¾è¡¨å°¾éƒ¨ï¼‰ä½†æ˜¯æ ‡å¿—æ”¹æˆ 0ã€‚ ClockSecond-Chance FIFO å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæ¯æ¬¡æ›´æ–° Frame éœ€è¦è°ƒæ•´é“¾è¡¨å¼€é”€å¾ˆå¤§ã€‚Clock çš„è§£å†³æ–¹æ³•æ˜¯ï¼ŒæŠŠå…¨éƒ¨ Frame éƒ½ç»„ç»‡æˆç¯å½¢ï¼Œå¹¶ä¸”ç”¨ current æŒ‡å‘é¦– Frameã€‚ ä» current å¼€å§‹æ£€æŸ¥ï¼Œè‹¥ pin-count\u003e0ï¼ˆç›¸å½“äºè¢«å ç”¨ï¼‰ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame å¦‚æœ pin-count=0 è‹¥ referenced=1ï¼Œåˆ™ç»™ä»–ä¸€æ¬¡æœºä¼šï¼ŒæŠŠå®ƒç½®ä¸º0ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame è‹¥ referenced=0ï¼Œé‚£ä¹ˆå°±ç½®æ¢å‡ºå»ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª current æŒ‡é’ˆåªåœ¨ç½®æ¢æ—¶æ›´æ–°ï¼Œè®¿é—®å‘½ä¸­æ—¶ä¸æ”¹å˜ current æŒ‡é’ˆ ä¸ºä½•ä¸ä½¿ç”¨ OS ç¼“å†²åŒºç®¡ç† DBMS ç»å¸¸èƒ½é¢„æµ‹è®¿é—®æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨æ›´ä¸“é—¨çš„ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ã€‚DBMSéœ€è¦å¼ºåˆ¶å†™å›ç£ç›˜èƒ½åŠ›ï¼ˆå¦‚WALï¼‰ï¼ŒOSçš„ç¼“å†²å†™ å›ä¸€èˆ¬é€šè¿‡è®°å½•å†™è¯·æ±‚æ¥å®ç°ï¼ˆæ¥è‡ªä¸åŒåº”ç”¨ï¼‰ï¼Œå®é™…çš„ ç£ç›˜ä¿®æ”¹æ¨è¿Ÿï¼Œå› æ­¤ä¸èƒ½ä¿è¯å†™é¡ºåºã€‚ å„ç§ç®—æ³•éƒ½è§£å†³äº†ä»€ä¹ˆé—®é¢˜ LRU-K å’Œ 2Q é€šè¿‡é¢å¤–é˜Ÿåˆ—è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Second-Chance FIFO é€šè¿‡æ ‡è®°ä½è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Clock æ˜¯é€šè¿‡å¾ªç¯é˜Ÿåˆ—è§£å†³äº† Second-Chance FIFO ä¿®æ”¹é“¾è¡¨å¼€é”€å¤§çš„é—®é¢˜ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#second-chance-fifo"},{"categories":null,"content":" ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ LRU ä¼˜ç‚¹ï¼š é€‚ç”¨äºæ»¡è¶³æ—¶é—´å±€éƒ¨æ€§çš„åœºæ™¯ï¼ˆå¤šæ¬¡é‡å¤è¯·æ±‚åŒä¸€é¡µï¼‰ é€‰å–frameçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1) ç¼ºç‚¹ï¼š ç¼“å­˜æ±¡æŸ“ï¼šLRU + repreated sequential scans ç»´æŠ¤LRUé“¾è¡¨ä»£ä»·æ˜‚è´µï¼šä¿®æ”¹é“¾è¡¨è€—æ—¶ å¦‚æœè®¿é—®ä¸æ»¡è¶³æ—¶é—´å±€éƒ¨æ€§ï¼Œåˆ™æ€§èƒ½è¾ƒå·® åªè€ƒè™‘æœ€è¿‘ä¸€æ¬¡è®¿é—®ï¼Œä¸è€ƒè™‘è®¿é—®é¢‘ç‡ LRU-K æ•°æ®ç¬¬ä¸€æ¬¡è¢«è®¿é—®ï¼ŒåŠ å…¥åˆ°è®¿é—®å†å²åˆ—è¡¨ï¼› å¦‚æœæ•°æ®åœ¨è®¿é—®å†å²åˆ—è¡¨é‡Œåæ²¡æœ‰è¾¾åˆ°Kæ¬¡è®¿é—®ï¼Œåˆ™æŒ‰ç…§ä¸€å®šè§„åˆ™ï¼ˆFIFOï¼ŒLRUï¼‰æ·˜æ±°ï¼› å½“è®¿é—®å†å²é˜Ÿåˆ—ä¸­çš„æ•°æ®è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡åï¼Œå°†æ•°æ®ç´¢å¼•ä»å†å²é˜Ÿåˆ—åˆ é™¤ï¼Œå°†æ•°æ®ç§»åˆ°ç¼“å­˜é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç¼“å­˜æ­¤æ•°æ®ï¼Œç¼“å­˜é˜Ÿåˆ—é‡æ–°æŒ‰ç…§æ—¶é—´æ’åºï¼› ç¼“å­˜æ•°æ®é˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®åï¼Œé‡æ–°æ’åºï¼› éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼Œæ·˜æ±°ç¼“å­˜é˜Ÿåˆ—ä¸­æ’åœ¨æœ«å°¾çš„æ•°æ®ï¼Œå³ï¼šæ·˜æ±°â€œå€’æ•°ç¬¬Kæ¬¡è®¿é—®ç¦»ç°åœ¨æœ€ä¹…â€çš„æ•°æ®ã€‚ å‡è®¾æœ‰è®¿é—®åºåˆ—ï¼šA B C A D E Aï¼Œé‚£ä¹ˆï¼š ç¬¬ä¸€æ¬¡è®¿é—®ï¼š A â†’ å†å²åˆ—è¡¨ (1 æ¬¡) B â†’ å†å²åˆ—è¡¨ (1 æ¬¡) C â†’ å†å²åˆ—è¡¨ (1 æ¬¡) ç¬¬äºŒæ¬¡è®¿é—®: A â†’ å†å²åˆ—è¡¨è®¿é—®æ¬¡æ•° = 2 â†’ è¾¾åˆ° K â†’ ç§»å…¥ç¼“å­˜é˜Ÿåˆ— ç¬¬ä¸‰æ¬¡è®¿é—®ï¼š A â†’ ç¼“å­˜é˜Ÿåˆ—é‡æ–°æ’åº Dã€E åªè®¿é—®ä¸€æ¬¡ â†’ ä»åœ¨å†å²åˆ—è¡¨æˆ–è¢«æ·˜æ±° â†’ ä¸å ç¼“å­˜ åœ¨ LRU-K é‡Œé¢ï¼Œè®¿é—®å†å²åˆ—è¡¨èµ·åˆ°çš„æ˜¯ è®¡æ•° çš„ä½œç”¨ï¼Œè¾¾åˆ° K æ¬¡çš„æ•°æ®åŠ å…¥ç¼“å­˜ã€‚ 2Qè¯¥ç®—æ³•ç±»ä¼¼äº LRU-2ï¼Œä¸åŒç‚¹åœ¨äº 2Q å°† LRU-2 ç®—æ³•ä¸­çš„è®¿é—®å†å²é˜Ÿåˆ—ï¼ˆæ³¨æ„è¿™ä¸æ˜¯ç¼“å­˜æ•°æ®çš„ï¼‰æ”¹ä¸ºä¸€ä¸ª FIFOç¼“å­˜é˜Ÿåˆ—ï¼Œ2Qç®—æ³•æœ‰ä¸¤ä¸ªç¼“å­˜é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯FIFOé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯LRUé˜Ÿåˆ—ã€‚ æ–°è®¿é—®çš„æ•°æ®æ’å…¥åˆ°FIFOé˜Ÿåˆ—ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­ä¸€ç›´æ²¡æœ‰è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™æœ€ç»ˆæŒ‰ç…§FIFOè§„åˆ™æ·˜æ±°ï¼› å¦‚æœæ•°æ®åœ¨FIFOé˜Ÿåˆ—ä¸­è¢«å†æ¬¡è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› å¦‚æœæ•°æ®åœ¨LRUé˜Ÿåˆ—å†æ¬¡è¢«è®¿é—®ï¼Œåˆ™å°†æ•°æ®ç§»åˆ°LRUé˜Ÿåˆ—å¤´éƒ¨ï¼› LRUé˜Ÿåˆ—æ·˜æ±°æœ«å°¾çš„æ•°æ®ã€‚ Second-Chance FIFOå°†æ‰€æœ‰ Frame æŒ‰ç…§ FIFO çš„æ–¹å¼è¿æ¥ï¼Œå¹¶ä¸”æ¯ä¸ª Frame éƒ½é¢å¤–é™„å¸¦ä¸€ä¸ª bit ä½é»˜è®¤ä¸º 0ã€‚ å¦‚æœä¸€ä¸ª Frame è¢«è®¿é—®ï¼Œé‚£ä¹ˆç½®ä¸º 1ã€‚å¦‚æœä¸€ä¸ª Frame è¦è¢«ç½®æ¢äº†ï¼Œå¦‚æœæ ‡å¿—æ˜¯ 0ï¼Œé‚£ä¹ˆç›´æ¥ç½®æ¢ï¼›å¦‚æœæ ‡å¿—æ˜¯ 1ï¼Œé‚£ä¹ˆç»™ä»–ä¸€ä¸ªæœºä¼šï¼Œå°†è¿™ä¸ª Frame æ”¾åˆ° FOï¼ˆé“¾è¡¨å°¾éƒ¨ï¼‰ä½†æ˜¯æ ‡å¿—æ”¹æˆ 0ã€‚ ClockSecond-Chance FIFO å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæ¯æ¬¡æ›´æ–° Frame éœ€è¦è°ƒæ•´é“¾è¡¨å¼€é”€å¾ˆå¤§ã€‚Clock çš„è§£å†³æ–¹æ³•æ˜¯ï¼ŒæŠŠå…¨éƒ¨ Frame éƒ½ç»„ç»‡æˆç¯å½¢ï¼Œå¹¶ä¸”ç”¨ current æŒ‡å‘é¦– Frameã€‚ ä» current å¼€å§‹æ£€æŸ¥ï¼Œè‹¥ pin-count\u003e0ï¼ˆç›¸å½“äºè¢«å ç”¨ï¼‰ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame å¦‚æœ pin-count=0 è‹¥ referenced=1ï¼Œåˆ™ç»™ä»–ä¸€æ¬¡æœºä¼šï¼ŒæŠŠå®ƒç½®ä¸º0ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª Frame è‹¥ referenced=0ï¼Œé‚£ä¹ˆå°±ç½®æ¢å‡ºå»ï¼Œcurrent æŒ‡å‘ä¸‹ä¸€ä¸ª current æŒ‡é’ˆåªåœ¨ç½®æ¢æ—¶æ›´æ–°ï¼Œè®¿é—®å‘½ä¸­æ—¶ä¸æ”¹å˜ current æŒ‡é’ˆ ä¸ºä½•ä¸ä½¿ç”¨ OS ç¼“å†²åŒºç®¡ç† DBMS ç»å¸¸èƒ½é¢„æµ‹è®¿é—®æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨æ›´ä¸“é—¨çš„ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ã€‚DBMSéœ€è¦å¼ºåˆ¶å†™å›ç£ç›˜èƒ½åŠ›ï¼ˆå¦‚WALï¼‰ï¼ŒOSçš„ç¼“å†²å†™ å›ä¸€èˆ¬é€šè¿‡è®°å½•å†™è¯·æ±‚æ¥å®ç°ï¼ˆæ¥è‡ªä¸åŒåº”ç”¨ï¼‰ï¼Œå®é™…çš„ ç£ç›˜ä¿®æ”¹æ¨è¿Ÿï¼Œå› æ­¤ä¸èƒ½ä¿è¯å†™é¡ºåºã€‚ å„ç§ç®—æ³•éƒ½è§£å†³äº†ä»€ä¹ˆé—®é¢˜ LRU-K å’Œ 2Q é€šè¿‡é¢å¤–é˜Ÿåˆ—è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Second-Chance FIFO é€šè¿‡æ ‡è®°ä½è§£å†³äº† LRU ç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ Clock æ˜¯é€šè¿‡å¾ªç¯é˜Ÿåˆ—è§£å†³äº† Second-Chance FIFO ä¿®æ”¹é“¾è¡¨å¼€é”€å¤§çš„é—®é¢˜ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#clock"},{"categories":null,"content":" ç¼“å†²åŒºç®¡ç†å™¨ frame cpp #define FRAMESIZE 4096 struct bFrame { char field[FRAMESIZE]; }; buffer cpp #define BUFSIZE 1024 bFrame buf[BUFSIZE]; bcbä¸ºæ¯ä¸€ä¸ª frame å­˜å‚¨ä¸€ä¸ªæ§åˆ¶ä¿¡æ¯ cpp struct BCB { BCB(); int page_id; int frame_id; int count; int time; int latch; int dirty; BCB * next; }; hashä¸ºäº†å»ºç«‹ frame-page ä¹‹é—´çš„ç´¢å¼•ï¼Œå¯ä»¥é‡‡ç”¨ Hash è¡¨ã€‚å·²çŸ¥éœ€è¦è¯»çš„ page_idï¼Œé€šè¿‡æ˜ å°„å¾—åˆ° hashå€¼å½“ç´¢å¼•ï¼Œå¾—åˆ° BCBï¼Œæ ¹æ® BCB çš„ frame_id å°±å¯ä»¥å» buffer é‡Œé¢æ‰¾åˆ° frame äº†ã€‚ cpp BCB hTable[BufferSize] //page 2 frame int hTable[BufferSize] //frame 2 page åŸºæœ¬åŠŸèƒ½ FixPage(int page_id)ï¼š åœ¨ buffer é‡Œæ‰¾ pageï¼ˆFindFrameï¼‰ å¦‚æœæ‰¾åˆ°äº† â†’ ç›´æ¥ç”¨ å¦‚æœæ²¡æ‰¾åˆ°ï¼š buffer æœªæ»¡ â†’ åˆ†é…ä¸€ä¸ª frame buffer å·²æ»¡ â†’ SelectVictim() é€‰ä¸€ä¸ª frame æ¢å‡º è‹¥è¢«æ¢å‡ºçš„ frame æ˜¯ dirty â†’ å†™å›ç£ç›˜ ä»ç£ç›˜æŠŠ page_id å¯¹åº”çš„ block è¯»å…¥è¿™ä¸ª frame è¿”å› frame_idï¼ˆæˆ– page æŒ‡é’ˆï¼‰ FixNewPage()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ pageï¼ˆè¿˜ä¸åœ¨ç£ç›˜ä¸Šï¼‰ï¼Œå¹¶æ”¾å…¥ buffer SelectVictim()ï¼šåœ¨ buffer æ»¡æ—¶ï¼Œé€‰ä¸€ä¸ªå¯ä»¥è¢«æ¢å‡ºçš„ frame SetDirty(int frame_id)ï¼šæ ‡è®° frame ä¸º dirty ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¼“å†²åŒºç®¡ç†å™¨"},{"categories":null,"content":" ç¼“å†²åŒºç®¡ç†å™¨ frame cpp #define FRAMESIZE 4096 struct bFrame { char field[FRAMESIZE]; }; buffer cpp #define BUFSIZE 1024 bFrame buf[BUFSIZE]; bcbä¸ºæ¯ä¸€ä¸ª frame å­˜å‚¨ä¸€ä¸ªæ§åˆ¶ä¿¡æ¯ cpp struct BCB { BCB(); int page_id; int frame_id; int count; int time; int latch; int dirty; BCB * next; }; hashä¸ºäº†å»ºç«‹ frame-page ä¹‹é—´çš„ç´¢å¼•ï¼Œå¯ä»¥é‡‡ç”¨ Hash è¡¨ã€‚å·²çŸ¥éœ€è¦è¯»çš„ page_idï¼Œé€šè¿‡æ˜ å°„å¾—åˆ° hashå€¼å½“ç´¢å¼•ï¼Œå¾—åˆ° BCBï¼Œæ ¹æ® BCB çš„ frame_id å°±å¯ä»¥å» buffer é‡Œé¢æ‰¾åˆ° frame äº†ã€‚ cpp BCB hTable[BufferSize] //page 2 frame int hTable[BufferSize] //frame 2 page åŸºæœ¬åŠŸèƒ½ FixPage(int page_id)ï¼š åœ¨ buffer é‡Œæ‰¾ pageï¼ˆFindFrameï¼‰ å¦‚æœæ‰¾åˆ°äº† â†’ ç›´æ¥ç”¨ å¦‚æœæ²¡æ‰¾åˆ°ï¼š buffer æœªæ»¡ â†’ åˆ†é…ä¸€ä¸ª frame buffer å·²æ»¡ â†’ SelectVictim() é€‰ä¸€ä¸ª frame æ¢å‡º è‹¥è¢«æ¢å‡ºçš„ frame æ˜¯ dirty â†’ å†™å›ç£ç›˜ ä»ç£ç›˜æŠŠ page_id å¯¹åº”çš„ block è¯»å…¥è¿™ä¸ª frame è¿”å› frame_idï¼ˆæˆ– page æŒ‡é’ˆï¼‰ FixNewPage()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ pageï¼ˆè¿˜ä¸åœ¨ç£ç›˜ä¸Šï¼‰ï¼Œå¹¶æ”¾å…¥ buffer SelectVictim()ï¼šåœ¨ buffer æ»¡æ—¶ï¼Œé€‰ä¸€ä¸ªå¯ä»¥è¢«æ¢å‡ºçš„ frame SetDirty(int frame_id)ï¼šæ ‡è®° frame ä¸º dirty ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#frame"},{"categories":null,"content":" ç¼“å†²åŒºç®¡ç†å™¨ frame cpp #define FRAMESIZE 4096 struct bFrame { char field[FRAMESIZE]; }; buffer cpp #define BUFSIZE 1024 bFrame buf[BUFSIZE]; bcbä¸ºæ¯ä¸€ä¸ª frame å­˜å‚¨ä¸€ä¸ªæ§åˆ¶ä¿¡æ¯ cpp struct BCB { BCB(); int page_id; int frame_id; int count; int time; int latch; int dirty; BCB * next; }; hashä¸ºäº†å»ºç«‹ frame-page ä¹‹é—´çš„ç´¢å¼•ï¼Œå¯ä»¥é‡‡ç”¨ Hash è¡¨ã€‚å·²çŸ¥éœ€è¦è¯»çš„ page_idï¼Œé€šè¿‡æ˜ å°„å¾—åˆ° hashå€¼å½“ç´¢å¼•ï¼Œå¾—åˆ° BCBï¼Œæ ¹æ® BCB çš„ frame_id å°±å¯ä»¥å» buffer é‡Œé¢æ‰¾åˆ° frame äº†ã€‚ cpp BCB hTable[BufferSize] //page 2 frame int hTable[BufferSize] //frame 2 page åŸºæœ¬åŠŸèƒ½ FixPage(int page_id)ï¼š åœ¨ buffer é‡Œæ‰¾ pageï¼ˆFindFrameï¼‰ å¦‚æœæ‰¾åˆ°äº† â†’ ç›´æ¥ç”¨ å¦‚æœæ²¡æ‰¾åˆ°ï¼š buffer æœªæ»¡ â†’ åˆ†é…ä¸€ä¸ª frame buffer å·²æ»¡ â†’ SelectVictim() é€‰ä¸€ä¸ª frame æ¢å‡º è‹¥è¢«æ¢å‡ºçš„ frame æ˜¯ dirty â†’ å†™å›ç£ç›˜ ä»ç£ç›˜æŠŠ page_id å¯¹åº”çš„ block è¯»å…¥è¿™ä¸ª frame è¿”å› frame_idï¼ˆæˆ– page æŒ‡é’ˆï¼‰ FixNewPage()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ pageï¼ˆè¿˜ä¸åœ¨ç£ç›˜ä¸Šï¼‰ï¼Œå¹¶æ”¾å…¥ buffer SelectVictim()ï¼šåœ¨ buffer æ»¡æ—¶ï¼Œé€‰ä¸€ä¸ªå¯ä»¥è¢«æ¢å‡ºçš„ frame SetDirty(int frame_id)ï¼šæ ‡è®° frame ä¸º dirty ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#buffer"},{"categories":null,"content":" ç¼“å†²åŒºç®¡ç†å™¨ frame cpp #define FRAMESIZE 4096 struct bFrame { char field[FRAMESIZE]; }; buffer cpp #define BUFSIZE 1024 bFrame buf[BUFSIZE]; bcbä¸ºæ¯ä¸€ä¸ª frame å­˜å‚¨ä¸€ä¸ªæ§åˆ¶ä¿¡æ¯ cpp struct BCB { BCB(); int page_id; int frame_id; int count; int time; int latch; int dirty; BCB * next; }; hashä¸ºäº†å»ºç«‹ frame-page ä¹‹é—´çš„ç´¢å¼•ï¼Œå¯ä»¥é‡‡ç”¨ Hash è¡¨ã€‚å·²çŸ¥éœ€è¦è¯»çš„ page_idï¼Œé€šè¿‡æ˜ å°„å¾—åˆ° hashå€¼å½“ç´¢å¼•ï¼Œå¾—åˆ° BCBï¼Œæ ¹æ® BCB çš„ frame_id å°±å¯ä»¥å» buffer é‡Œé¢æ‰¾åˆ° frame äº†ã€‚ cpp BCB hTable[BufferSize] //page 2 frame int hTable[BufferSize] //frame 2 page åŸºæœ¬åŠŸèƒ½ FixPage(int page_id)ï¼š åœ¨ buffer é‡Œæ‰¾ pageï¼ˆFindFrameï¼‰ å¦‚æœæ‰¾åˆ°äº† â†’ ç›´æ¥ç”¨ å¦‚æœæ²¡æ‰¾åˆ°ï¼š buffer æœªæ»¡ â†’ åˆ†é…ä¸€ä¸ª frame buffer å·²æ»¡ â†’ SelectVictim() é€‰ä¸€ä¸ª frame æ¢å‡º è‹¥è¢«æ¢å‡ºçš„ frame æ˜¯ dirty â†’ å†™å›ç£ç›˜ ä»ç£ç›˜æŠŠ page_id å¯¹åº”çš„ block è¯»å…¥è¿™ä¸ª frame è¿”å› frame_idï¼ˆæˆ– page æŒ‡é’ˆï¼‰ FixNewPage()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ pageï¼ˆè¿˜ä¸åœ¨ç£ç›˜ä¸Šï¼‰ï¼Œå¹¶æ”¾å…¥ buffer SelectVictim()ï¼šåœ¨ buffer æ»¡æ—¶ï¼Œé€‰ä¸€ä¸ªå¯ä»¥è¢«æ¢å‡ºçš„ frame SetDirty(int frame_id)ï¼šæ ‡è®° frame ä¸º dirty ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#bcb"},{"categories":null,"content":" ç¼“å†²åŒºç®¡ç†å™¨ frame cpp #define FRAMESIZE 4096 struct bFrame { char field[FRAMESIZE]; }; buffer cpp #define BUFSIZE 1024 bFrame buf[BUFSIZE]; bcbä¸ºæ¯ä¸€ä¸ª frame å­˜å‚¨ä¸€ä¸ªæ§åˆ¶ä¿¡æ¯ cpp struct BCB { BCB(); int page_id; int frame_id; int count; int time; int latch; int dirty; BCB * next; }; hashä¸ºäº†å»ºç«‹ frame-page ä¹‹é—´çš„ç´¢å¼•ï¼Œå¯ä»¥é‡‡ç”¨ Hash è¡¨ã€‚å·²çŸ¥éœ€è¦è¯»çš„ page_idï¼Œé€šè¿‡æ˜ å°„å¾—åˆ° hashå€¼å½“ç´¢å¼•ï¼Œå¾—åˆ° BCBï¼Œæ ¹æ® BCB çš„ frame_id å°±å¯ä»¥å» buffer é‡Œé¢æ‰¾åˆ° frame äº†ã€‚ cpp BCB hTable[BufferSize] //page 2 frame int hTable[BufferSize] //frame 2 page åŸºæœ¬åŠŸèƒ½ FixPage(int page_id)ï¼š åœ¨ buffer é‡Œæ‰¾ pageï¼ˆFindFrameï¼‰ å¦‚æœæ‰¾åˆ°äº† â†’ ç›´æ¥ç”¨ å¦‚æœæ²¡æ‰¾åˆ°ï¼š buffer æœªæ»¡ â†’ åˆ†é…ä¸€ä¸ª frame buffer å·²æ»¡ â†’ SelectVictim() é€‰ä¸€ä¸ª frame æ¢å‡º è‹¥è¢«æ¢å‡ºçš„ frame æ˜¯ dirty â†’ å†™å›ç£ç›˜ ä»ç£ç›˜æŠŠ page_id å¯¹åº”çš„ block è¯»å…¥è¿™ä¸ª frame è¿”å› frame_idï¼ˆæˆ– page æŒ‡é’ˆï¼‰ FixNewPage()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ pageï¼ˆè¿˜ä¸åœ¨ç£ç›˜ä¸Šï¼‰ï¼Œå¹¶æ”¾å…¥ buffer SelectVictim()ï¼šåœ¨ buffer æ»¡æ—¶ï¼Œé€‰ä¸€ä¸ªå¯ä»¥è¢«æ¢å‡ºçš„ frame SetDirty(int frame_id)ï¼šæ ‡è®° frame ä¸º dirty ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#hash"},{"categories":null,"content":" ç¼“å†²åŒºç®¡ç†å™¨ frame cpp #define FRAMESIZE 4096 struct bFrame { char field[FRAMESIZE]; }; buffer cpp #define BUFSIZE 1024 bFrame buf[BUFSIZE]; bcbä¸ºæ¯ä¸€ä¸ª frame å­˜å‚¨ä¸€ä¸ªæ§åˆ¶ä¿¡æ¯ cpp struct BCB { BCB(); int page_id; int frame_id; int count; int time; int latch; int dirty; BCB * next; }; hashä¸ºäº†å»ºç«‹ frame-page ä¹‹é—´çš„ç´¢å¼•ï¼Œå¯ä»¥é‡‡ç”¨ Hash è¡¨ã€‚å·²çŸ¥éœ€è¦è¯»çš„ page_idï¼Œé€šè¿‡æ˜ å°„å¾—åˆ° hashå€¼å½“ç´¢å¼•ï¼Œå¾—åˆ° BCBï¼Œæ ¹æ® BCB çš„ frame_id å°±å¯ä»¥å» buffer é‡Œé¢æ‰¾åˆ° frame äº†ã€‚ cpp BCB hTable[BufferSize] //page 2 frame int hTable[BufferSize] //frame 2 page åŸºæœ¬åŠŸèƒ½ FixPage(int page_id)ï¼š åœ¨ buffer é‡Œæ‰¾ pageï¼ˆFindFrameï¼‰ å¦‚æœæ‰¾åˆ°äº† â†’ ç›´æ¥ç”¨ å¦‚æœæ²¡æ‰¾åˆ°ï¼š buffer æœªæ»¡ â†’ åˆ†é…ä¸€ä¸ª frame buffer å·²æ»¡ â†’ SelectVictim() é€‰ä¸€ä¸ª frame æ¢å‡º è‹¥è¢«æ¢å‡ºçš„ frame æ˜¯ dirty â†’ å†™å›ç£ç›˜ ä»ç£ç›˜æŠŠ page_id å¯¹åº”çš„ block è¯»å…¥è¿™ä¸ª frame è¿”å› frame_idï¼ˆæˆ– page æŒ‡é’ˆï¼‰ FixNewPage()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ pageï¼ˆè¿˜ä¸åœ¨ç£ç›˜ä¸Šï¼‰ï¼Œå¹¶æ”¾å…¥ buffer SelectVictim()ï¼šåœ¨ buffer æ»¡æ—¶ï¼Œé€‰ä¸€ä¸ªå¯ä»¥è¢«æ¢å‡ºçš„ frame SetDirty(int frame_id)ï¼šæ ‡è®° frame ä¸º dirty ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#åŸºæœ¬åŠŸèƒ½"},{"categories":null,"content":" è¯¾åé¢˜ text å‡è®¾æˆ‘ä»¬é‡‡ç”¨LRUä½œä¸ºç¼“å†²åŒºç½®æ¢ç­–ç•¥ï¼Œå½“æˆ‘ä»¬å‘Buffer Managerå‘å‡ºä¸€ä¸ªè¯»é¡µè¯·æ±‚æ—¶ï¼Œè¯·è®¨è®ºä¸€ä¸‹ï¼š (1)å¦‚æœé¡µä¸åœ¨ç¼“å†²åŒºä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä»ç£ç›˜ä¸­è¯»å…¥è¯¥é¡µã€‚è¯·é—®å¦‚ä½•æ‰èƒ½åœ¨ç¼“å†²åŒºä¸æ»¡çš„æ—¶å€™å¿«é€Ÿåœ°è¿”å›ä¸€ä¸ªfreeçš„frame?è¯·ç»™å‡ºè‡³å°‘ä¸¤ç§ç­–ç•¥ï¼Œå¹¶åˆ†æä¸€ä¸‹å„è‡ªçš„æ—¶é—´å¤æ‚åº¦ã€‚ (2)å¦‚ä½•æ‰èƒ½å¿«é€Ÿåœ°åˆ¤æ–­æ‰€è¯·æ±‚çš„é¡µæ˜¯å¦åœ¨ç¼“å†²åŒºä¸­ï¼Ÿå¦‚æœè¯·æ±‚çš„é¡µåœ¨ç¼“å†²åŒºä¸­ï¼Œå¦‚ä½•å¿«é€Ÿè¿”å›è¯¥é¡µå¯¹åº”çš„frameåœ°å€ï¼Ÿè¯·ç»™å‡ºè‡³å°‘ä¸¤ç§ç­–ç•¥ï¼Œå¹¶åˆ†æä¸€ä¸‹å„è‡ªçš„æ—¶é—´å¤æ‚åº¦ã€‚ ç”¨ä¸€ä¸ªæ•°ç»„è¡¨ç¤ºæ¯ä¸ª frame æ˜¯å¦ä¸ºç©ºï¼Œè¿™æ ·å°±èƒ½åœ¨ä¸æ»¡çš„æ—¶å€™ç”¨ O(1) çš„æ—¶é—´è¿”å›ä¸€ä¸ªç©º frameï¼Œå¯æ˜¯å ç”¨ç©ºé—´å¤§ï¼›å¦ä¸€ä¸ªæ–¹æ³•æ˜¯ç”¨ä¸€ä¸ªç©ºé—²é“¾è¡¨ï¼Œå°†ç©º frame çš„æŒ‡é’ˆè¿åœ¨ä¸€èµ·ã€‚è¿™æ ·ä¹Ÿå¯ä»¥åœ¨ O(1) çš„æ—¶é—´è¿”å›ä¸€ä¸ªç©º frameï¼Œä½†æ˜¯ç»´æŠ¤çš„æ—¶é—´å¼€é”€æ¯”è¾ƒå¤§ã€‚ ç”¨ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œå¾—åˆ° page åˆ° frame çš„æ˜ å°„ï¼Œç„¶åå» lru é˜Ÿåˆ—é‡Œé¢æŸ¥æ‰¾ frameï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ã€‚ text LRUç®—æ³•åªè€ƒè™‘äº†æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œä½†åœ¨å®é™…DBMSä¸­ï¼Œå¦‚æœè¢«ç½®æ¢çš„frameæ˜¯dirtyé¡µï¼ŒBuffer Manageréœ€è¦å°†è¯¥frameå†™å›ç£ç›˜ï¼Œè¿™ä¼šå¸¦æ¥é¢å¤–çš„I/Oã€‚å¦‚æœè¢«ç½®æ¢çš„frameæ˜¯cleané¡µï¼Œåˆ™æ— éœ€å°†å…¶å†™å›ç£ç›˜ï¼Œå°±ä¸ä¼šäº§ç”Ÿé¢å¤–I/Oã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨é€‰æ‹©ç½®æ¢ é¡µä¸ä»…è€ƒè™‘æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œè€Œä¸”è¿˜è€ƒè™‘frameçš„dityå±æ€§ï¼Œä»è€Œå¾—åˆ°ä¸€ç§ä¼˜åŒ–çš„å†™å‹å¥½çš„LRUç®—æ³•ï¼Œå³ä¼˜å…ˆç½®æ¢cleançš„frameã€‚è¯·è¯•ç€è®¾è®¡ä¸€ä¸‹åŸºäºä¸Šè¿°æ€è·¯çš„å†™å‹å¥½çš„LRUç­–ç•¥ï¼š (1)è¯·ç»™å‡ºä¿®æ”¹åçš„LRUé“¾è¡¨ç»“æ„ï¼ˆæ˜¯å¦éœ€è¦å¢åŠ æ–°çš„æŒ‡é’ˆæˆ–è€…æ•°æ®ç»“æ„ï¼‰ (2)ç®€è¦è§£é‡Šå†™å‹å¥½çš„LRUç½®æ¢é¡µé€‰æ‹©è¿‡ç¨‹ (3)è¿™ç§å†™å‹å¥½çš„LRUç­–ç•¥åœ¨å®é™…åº”ç”¨ä¸­çš„æ€§èƒ½æ˜¯å¦ä¸€å®šä¼˜äºä¼ ç»ŸLRU?ä¸ºä»€ä¹ˆï¼Ÿ æ€è·¯ï¼šç»´æŠ¤ä¸¤ä¸ªç‹¬ç«‹çš„ LRU é“¾è¡¨ Clean LRU List å’Œ Dirty LRU Listï¼Œæ¯ä¸ª frame åªå±äºå…¶ä¸­ä¸€æ¡é“¾è¡¨ã€‚å½“é¡µé¢çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼šä¾‹å¦‚å¾€ frame é‡Œé¢å†™å…¥æ•°æ®ï¼Œåˆ™ä» clean å˜æˆ dirtyï¼›å¦‚æœæ›¿æ¢å‡ºä¸€ä¸ª frameï¼Œé‚£ä¹ˆåˆ™æŠŠä»–é€å…¥ clean é“¾è¡¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:4:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è¯¾åé¢˜-1"},{"categories":null,"content":" ç¬¬äº”ç«  ç´¢å¼•ç»“æ„","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¬¬äº”ç« -ç´¢å¼•ç»“æ„"},{"categories":null,"content":" é¡ºåºæ–‡ä»¶ç´¢å¼• å¯†é›†ç´¢å¼• è®°å½•é€šå¸¸æ¯”ç´¢å¼•é¡¹è¦å¤§ ç´¢å¼•å¯ä»¥å¸¸é©»å†…å­˜ è¦æŸ¥æ‰¾é”®å€¼ä¸ºKçš„è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸éœ€è¦è®¿é—®ç£ç›˜æ•°æ® ç¨€ç–ç´¢å¼• ä»…ä¸ºæ¯ä¸ªæ•°æ®å—çš„ç¬¬ä¸€ä¸ªè®°å½•å»ºç«‹ç´¢å¼• èŠ‚çœäº†ç´¢å¼•ç©ºé—´ï¼Œ å¯¹åŒæ ·çš„è®°å½•ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥ä½¿ç”¨æ›´å°‘çš„ç´¢å¼•é¡¹ã€‚ ä½†æ˜¯æ²¡åŠæ³•ç›´æ¥çŸ¥é“ï¼Œæ˜¯å¦å­˜åœ¨ key=K çš„è®°å½•ï¼Œéœ€è¦éå† å¤šçº§ç´¢å¼• ä¸€çº§ç´¢å¼•å¯èƒ½è¿˜å¤ªå¤§è€Œä¸èƒ½å¸¸é©»å†…å­˜ äºŒçº§ç´¢å¼•æ›´å°ï¼Œå¯ä»¥å¸¸é©»å†…å­˜ å‡å°‘ç£ç›˜I/Oæ¬¡æ•° æ³¨æ„ï¼Œæœ€å·¦è¾¹æ˜¯äºŒçº§ç´¢å¼•ï¼Œä¸€çº§ç´¢å¼•æŒ‡å‘æ•°æ®ã€‚ ä¾‹ï¼šä¸€ä¸ªå—å 4KBï¼Œä¸€çº§ç´¢å¼•10,000ä¸ªå—ï¼Œæ¯ä¸ªå—å¯å­˜100ä¸ªç´¢å¼•é¡¹ï¼Œå…±40MBã€‚äºŒçº§ç¨€ç–ç´¢å¼•100ä¸ªå—ï¼Œå…±400KBã€‚æŸ¥æ‰¾ä¸€ä¸ªè®°å½•éœ€è¦å¤šå°‘æ¬¡ I/O ï¼Ÿ äºŒçº§ç´¢å¼•ä½äºå†…å­˜é‡Œé¢ï¼Œç›´æ¥è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œéœ€è¦ 0 æ¬¡ I/Oï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€çº§ç´¢å¼•å—çš„åœ°å€ ä¸€æ¬¡ I/O è¯»å…¥ä¸€çº§ç´¢å¼•å—è¿›å…¥å†…å­˜ï¼Œåœ¨å†…å­˜è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå¾—åˆ°æ•°æ®å—åœ°å€ï¼Œ1 æ¬¡ I/Oï¼Œå…±ä¸¤æ¬¡ã€‚ äºŒçº§ç´¢å¼•å¿…é¡»ç”¨ç¨€ç–ç´¢å¼•ï¼Œä¸ç„¶å®Œå…¨æ²¡æœ‰æ„ä¹‰ï¼šå› ä¸ºäºŒçº§ç´¢å¼•å­˜åœ¨å°±æ˜¯å› ä¸ºä¸€çº§ç´¢å¼•å¤ªå¤šäº†ã€‚ è¾…åŠ©ç´¢å¼•å‡è®¾ä¸€å¼ è¡¨ï¼šStudent(id, name, age, dept)ï¼Œæ•°æ®æŒ‰ idï¼ˆä¸»é”®ï¼‰é¡ºåºå­˜ï¼Œç°åœ¨æŸ¥ï¼šSELECT * FROM Student WHERE dept = 'CS'; ï¼Œç”±äº dept ä¸æ˜¯ä¸»é”®ï¼Œåªèƒ½å…¨è¡¨æ‰«æï¼ˆè¯»æ‰€æœ‰æ•°æ®å—ï¼‰ï¼Œè¿™åœ¨æ•°æ®é‡å¤§æ—¶éå¸¸æ…¢ã€‚ ä¸ºä»€ä¹ˆè¾…åŠ©ç´¢å¼•ä¸èƒ½ç”¨ç¨€ç–ç´¢å¼•ï¼Ÿ å› ä¸ºæ•°æ®æ–‡ä»¶ä¸æ˜¯æŒ‰è¾…åŠ©ç´¢å¼•å­—æ®µé¡ºåºå­˜æ”¾çš„ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸»é”®é¡ºåºå­˜æ”¾çš„ã€‚å¯¹äºä¸»é”®æ¥è¯´ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥æ‰¾åˆ°å—åï¼Œé¡ºåºæ‰«å—å†…æ•°æ®å°±è¡Œã€‚ä½†æ˜¯å¯¹äºè¾…åŠ©ç´¢å¼•å­—æ®µï¼ŒæŸä¸ªå—å†… key=10 è¿™æ¡è®°å½•ä¸‹ä¸€ä¸ªè®°å½•å¯èƒ½ key=5ã€‚ é‡å¤é”®å€¼æ€ä¹ˆå¤„ç†ï¼Ÿ å¤šä¸ªç´¢å¼•é¡¹ï¼Œæ¯ä¸ªç´¢å¼•é¡¹æŒ‡å‘ä¸€æ¡è®°å½• ç´¢å¼•é¡¹ + æŒ‡é’ˆé“¾è¡¨ï¼ŒæŒ‡å‘ä¸€ä¸ª è®°å½•æŒ‡é’ˆé“¾è¡¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè®°å½• B+æ ‘å¶å­ç»“ç‚¹ é—´æ¥æ¡¶ é—´æ¥æ¡¶çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¾…åŠ©ç´¢å¼•é‡å¤é”®å€¼æµªè´¹ç©ºé—´çš„é—®é¢˜ã€‚ æ€è·¯ç±»ä¼¼æŒ‡é’ˆé“¾è¡¨ï¼Œå°±æ˜¯åœ¨bucketé‡Œé¢å­˜å‚¨é‡å¤çš„é”®å€¼æŒ‡é’ˆ å€’æ’ç´¢å¼•åº”ç”¨äºæ–‡æ¡£æ£€ç´¢ï¼Œå°±æ˜¯å…³é”®è¯æŸ¥æ‰¾ä½äºæ–‡æ¡£çš„å“ªä¸ªä½ç½®ã€‚ä¸ºæ¯ä¸ªæ£€ç´¢è¯å»ºç«‹é—´æ¥æ¡¶ï¼Œæ¡¶çš„æŒ‡é’ˆæŒ‡å‘æ£€ç´¢è¯æ‰€å‡ºç°çš„æ–‡æ¡£ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#é¡ºåºæ–‡ä»¶ç´¢å¼•"},{"categories":null,"content":" é¡ºåºæ–‡ä»¶ç´¢å¼• å¯†é›†ç´¢å¼• è®°å½•é€šå¸¸æ¯”ç´¢å¼•é¡¹è¦å¤§ ç´¢å¼•å¯ä»¥å¸¸é©»å†…å­˜ è¦æŸ¥æ‰¾é”®å€¼ä¸ºKçš„è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸éœ€è¦è®¿é—®ç£ç›˜æ•°æ® ç¨€ç–ç´¢å¼• ä»…ä¸ºæ¯ä¸ªæ•°æ®å—çš„ç¬¬ä¸€ä¸ªè®°å½•å»ºç«‹ç´¢å¼• èŠ‚çœäº†ç´¢å¼•ç©ºé—´ï¼Œ å¯¹åŒæ ·çš„è®°å½•ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥ä½¿ç”¨æ›´å°‘çš„ç´¢å¼•é¡¹ã€‚ ä½†æ˜¯æ²¡åŠæ³•ç›´æ¥çŸ¥é“ï¼Œæ˜¯å¦å­˜åœ¨ key=K çš„è®°å½•ï¼Œéœ€è¦éå† å¤šçº§ç´¢å¼• ä¸€çº§ç´¢å¼•å¯èƒ½è¿˜å¤ªå¤§è€Œä¸èƒ½å¸¸é©»å†…å­˜ äºŒçº§ç´¢å¼•æ›´å°ï¼Œå¯ä»¥å¸¸é©»å†…å­˜ å‡å°‘ç£ç›˜I/Oæ¬¡æ•° æ³¨æ„ï¼Œæœ€å·¦è¾¹æ˜¯äºŒçº§ç´¢å¼•ï¼Œä¸€çº§ç´¢å¼•æŒ‡å‘æ•°æ®ã€‚ ä¾‹ï¼šä¸€ä¸ªå—å 4KBï¼Œä¸€çº§ç´¢å¼•10,000ä¸ªå—ï¼Œæ¯ä¸ªå—å¯å­˜100ä¸ªç´¢å¼•é¡¹ï¼Œå…±40MBã€‚äºŒçº§ç¨€ç–ç´¢å¼•100ä¸ªå—ï¼Œå…±400KBã€‚æŸ¥æ‰¾ä¸€ä¸ªè®°å½•éœ€è¦å¤šå°‘æ¬¡ I/O ï¼Ÿ äºŒçº§ç´¢å¼•ä½äºå†…å­˜é‡Œé¢ï¼Œç›´æ¥è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œéœ€è¦ 0 æ¬¡ I/Oï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€çº§ç´¢å¼•å—çš„åœ°å€ ä¸€æ¬¡ I/O è¯»å…¥ä¸€çº§ç´¢å¼•å—è¿›å…¥å†…å­˜ï¼Œåœ¨å†…å­˜è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå¾—åˆ°æ•°æ®å—åœ°å€ï¼Œ1 æ¬¡ I/Oï¼Œå…±ä¸¤æ¬¡ã€‚ äºŒçº§ç´¢å¼•å¿…é¡»ç”¨ç¨€ç–ç´¢å¼•ï¼Œä¸ç„¶å®Œå…¨æ²¡æœ‰æ„ä¹‰ï¼šå› ä¸ºäºŒçº§ç´¢å¼•å­˜åœ¨å°±æ˜¯å› ä¸ºä¸€çº§ç´¢å¼•å¤ªå¤šäº†ã€‚ è¾…åŠ©ç´¢å¼•å‡è®¾ä¸€å¼ è¡¨ï¼šStudent(id, name, age, dept)ï¼Œæ•°æ®æŒ‰ idï¼ˆä¸»é”®ï¼‰é¡ºåºå­˜ï¼Œç°åœ¨æŸ¥ï¼šSELECT * FROM Student WHERE dept = 'CS'; ï¼Œç”±äº dept ä¸æ˜¯ä¸»é”®ï¼Œåªèƒ½å…¨è¡¨æ‰«æï¼ˆè¯»æ‰€æœ‰æ•°æ®å—ï¼‰ï¼Œè¿™åœ¨æ•°æ®é‡å¤§æ—¶éå¸¸æ…¢ã€‚ ä¸ºä»€ä¹ˆè¾…åŠ©ç´¢å¼•ä¸èƒ½ç”¨ç¨€ç–ç´¢å¼•ï¼Ÿ å› ä¸ºæ•°æ®æ–‡ä»¶ä¸æ˜¯æŒ‰è¾…åŠ©ç´¢å¼•å­—æ®µé¡ºåºå­˜æ”¾çš„ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸»é”®é¡ºåºå­˜æ”¾çš„ã€‚å¯¹äºä¸»é”®æ¥è¯´ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥æ‰¾åˆ°å—åï¼Œé¡ºåºæ‰«å—å†…æ•°æ®å°±è¡Œã€‚ä½†æ˜¯å¯¹äºè¾…åŠ©ç´¢å¼•å­—æ®µï¼ŒæŸä¸ªå—å†… key=10 è¿™æ¡è®°å½•ä¸‹ä¸€ä¸ªè®°å½•å¯èƒ½ key=5ã€‚ é‡å¤é”®å€¼æ€ä¹ˆå¤„ç†ï¼Ÿ å¤šä¸ªç´¢å¼•é¡¹ï¼Œæ¯ä¸ªç´¢å¼•é¡¹æŒ‡å‘ä¸€æ¡è®°å½• ç´¢å¼•é¡¹ + æŒ‡é’ˆé“¾è¡¨ï¼ŒæŒ‡å‘ä¸€ä¸ª è®°å½•æŒ‡é’ˆé“¾è¡¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè®°å½• B+æ ‘å¶å­ç»“ç‚¹ é—´æ¥æ¡¶ é—´æ¥æ¡¶çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¾…åŠ©ç´¢å¼•é‡å¤é”®å€¼æµªè´¹ç©ºé—´çš„é—®é¢˜ã€‚ æ€è·¯ç±»ä¼¼æŒ‡é’ˆé“¾è¡¨ï¼Œå°±æ˜¯åœ¨bucketé‡Œé¢å­˜å‚¨é‡å¤çš„é”®å€¼æŒ‡é’ˆ å€’æ’ç´¢å¼•åº”ç”¨äºæ–‡æ¡£æ£€ç´¢ï¼Œå°±æ˜¯å…³é”®è¯æŸ¥æ‰¾ä½äºæ–‡æ¡£çš„å“ªä¸ªä½ç½®ã€‚ä¸ºæ¯ä¸ªæ£€ç´¢è¯å»ºç«‹é—´æ¥æ¡¶ï¼Œæ¡¶çš„æŒ‡é’ˆæŒ‡å‘æ£€ç´¢è¯æ‰€å‡ºç°çš„æ–‡æ¡£ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å¯†é›†ç´¢å¼•"},{"categories":null,"content":" é¡ºåºæ–‡ä»¶ç´¢å¼• å¯†é›†ç´¢å¼• è®°å½•é€šå¸¸æ¯”ç´¢å¼•é¡¹è¦å¤§ ç´¢å¼•å¯ä»¥å¸¸é©»å†…å­˜ è¦æŸ¥æ‰¾é”®å€¼ä¸ºKçš„è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸éœ€è¦è®¿é—®ç£ç›˜æ•°æ® ç¨€ç–ç´¢å¼• ä»…ä¸ºæ¯ä¸ªæ•°æ®å—çš„ç¬¬ä¸€ä¸ªè®°å½•å»ºç«‹ç´¢å¼• èŠ‚çœäº†ç´¢å¼•ç©ºé—´ï¼Œ å¯¹åŒæ ·çš„è®°å½•ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥ä½¿ç”¨æ›´å°‘çš„ç´¢å¼•é¡¹ã€‚ ä½†æ˜¯æ²¡åŠæ³•ç›´æ¥çŸ¥é“ï¼Œæ˜¯å¦å­˜åœ¨ key=K çš„è®°å½•ï¼Œéœ€è¦éå† å¤šçº§ç´¢å¼• ä¸€çº§ç´¢å¼•å¯èƒ½è¿˜å¤ªå¤§è€Œä¸èƒ½å¸¸é©»å†…å­˜ äºŒçº§ç´¢å¼•æ›´å°ï¼Œå¯ä»¥å¸¸é©»å†…å­˜ å‡å°‘ç£ç›˜I/Oæ¬¡æ•° æ³¨æ„ï¼Œæœ€å·¦è¾¹æ˜¯äºŒçº§ç´¢å¼•ï¼Œä¸€çº§ç´¢å¼•æŒ‡å‘æ•°æ®ã€‚ ä¾‹ï¼šä¸€ä¸ªå—å 4KBï¼Œä¸€çº§ç´¢å¼•10,000ä¸ªå—ï¼Œæ¯ä¸ªå—å¯å­˜100ä¸ªç´¢å¼•é¡¹ï¼Œå…±40MBã€‚äºŒçº§ç¨€ç–ç´¢å¼•100ä¸ªå—ï¼Œå…±400KBã€‚æŸ¥æ‰¾ä¸€ä¸ªè®°å½•éœ€è¦å¤šå°‘æ¬¡ I/O ï¼Ÿ äºŒçº§ç´¢å¼•ä½äºå†…å­˜é‡Œé¢ï¼Œç›´æ¥è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œéœ€è¦ 0 æ¬¡ I/Oï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€çº§ç´¢å¼•å—çš„åœ°å€ ä¸€æ¬¡ I/O è¯»å…¥ä¸€çº§ç´¢å¼•å—è¿›å…¥å†…å­˜ï¼Œåœ¨å†…å­˜è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå¾—åˆ°æ•°æ®å—åœ°å€ï¼Œ1 æ¬¡ I/Oï¼Œå…±ä¸¤æ¬¡ã€‚ äºŒçº§ç´¢å¼•å¿…é¡»ç”¨ç¨€ç–ç´¢å¼•ï¼Œä¸ç„¶å®Œå…¨æ²¡æœ‰æ„ä¹‰ï¼šå› ä¸ºäºŒçº§ç´¢å¼•å­˜åœ¨å°±æ˜¯å› ä¸ºä¸€çº§ç´¢å¼•å¤ªå¤šäº†ã€‚ è¾…åŠ©ç´¢å¼•å‡è®¾ä¸€å¼ è¡¨ï¼šStudent(id, name, age, dept)ï¼Œæ•°æ®æŒ‰ idï¼ˆä¸»é”®ï¼‰é¡ºåºå­˜ï¼Œç°åœ¨æŸ¥ï¼šSELECT * FROM Student WHERE dept = 'CS'; ï¼Œç”±äº dept ä¸æ˜¯ä¸»é”®ï¼Œåªèƒ½å…¨è¡¨æ‰«æï¼ˆè¯»æ‰€æœ‰æ•°æ®å—ï¼‰ï¼Œè¿™åœ¨æ•°æ®é‡å¤§æ—¶éå¸¸æ…¢ã€‚ ä¸ºä»€ä¹ˆè¾…åŠ©ç´¢å¼•ä¸èƒ½ç”¨ç¨€ç–ç´¢å¼•ï¼Ÿ å› ä¸ºæ•°æ®æ–‡ä»¶ä¸æ˜¯æŒ‰è¾…åŠ©ç´¢å¼•å­—æ®µé¡ºåºå­˜æ”¾çš„ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸»é”®é¡ºåºå­˜æ”¾çš„ã€‚å¯¹äºä¸»é”®æ¥è¯´ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥æ‰¾åˆ°å—åï¼Œé¡ºåºæ‰«å—å†…æ•°æ®å°±è¡Œã€‚ä½†æ˜¯å¯¹äºè¾…åŠ©ç´¢å¼•å­—æ®µï¼ŒæŸä¸ªå—å†… key=10 è¿™æ¡è®°å½•ä¸‹ä¸€ä¸ªè®°å½•å¯èƒ½ key=5ã€‚ é‡å¤é”®å€¼æ€ä¹ˆå¤„ç†ï¼Ÿ å¤šä¸ªç´¢å¼•é¡¹ï¼Œæ¯ä¸ªç´¢å¼•é¡¹æŒ‡å‘ä¸€æ¡è®°å½• ç´¢å¼•é¡¹ + æŒ‡é’ˆé“¾è¡¨ï¼ŒæŒ‡å‘ä¸€ä¸ª è®°å½•æŒ‡é’ˆé“¾è¡¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè®°å½• B+æ ‘å¶å­ç»“ç‚¹ é—´æ¥æ¡¶ é—´æ¥æ¡¶çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¾…åŠ©ç´¢å¼•é‡å¤é”®å€¼æµªè´¹ç©ºé—´çš„é—®é¢˜ã€‚ æ€è·¯ç±»ä¼¼æŒ‡é’ˆé“¾è¡¨ï¼Œå°±æ˜¯åœ¨bucketé‡Œé¢å­˜å‚¨é‡å¤çš„é”®å€¼æŒ‡é’ˆ å€’æ’ç´¢å¼•åº”ç”¨äºæ–‡æ¡£æ£€ç´¢ï¼Œå°±æ˜¯å…³é”®è¯æŸ¥æ‰¾ä½äºæ–‡æ¡£çš„å“ªä¸ªä½ç½®ã€‚ä¸ºæ¯ä¸ªæ£€ç´¢è¯å»ºç«‹é—´æ¥æ¡¶ï¼Œæ¡¶çš„æŒ‡é’ˆæŒ‡å‘æ£€ç´¢è¯æ‰€å‡ºç°çš„æ–‡æ¡£ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¨€ç–ç´¢å¼•"},{"categories":null,"content":" é¡ºåºæ–‡ä»¶ç´¢å¼• å¯†é›†ç´¢å¼• è®°å½•é€šå¸¸æ¯”ç´¢å¼•é¡¹è¦å¤§ ç´¢å¼•å¯ä»¥å¸¸é©»å†…å­˜ è¦æŸ¥æ‰¾é”®å€¼ä¸ºKçš„è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸éœ€è¦è®¿é—®ç£ç›˜æ•°æ® ç¨€ç–ç´¢å¼• ä»…ä¸ºæ¯ä¸ªæ•°æ®å—çš„ç¬¬ä¸€ä¸ªè®°å½•å»ºç«‹ç´¢å¼• èŠ‚çœäº†ç´¢å¼•ç©ºé—´ï¼Œ å¯¹åŒæ ·çš„è®°å½•ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥ä½¿ç”¨æ›´å°‘çš„ç´¢å¼•é¡¹ã€‚ ä½†æ˜¯æ²¡åŠæ³•ç›´æ¥çŸ¥é“ï¼Œæ˜¯å¦å­˜åœ¨ key=K çš„è®°å½•ï¼Œéœ€è¦éå† å¤šçº§ç´¢å¼• ä¸€çº§ç´¢å¼•å¯èƒ½è¿˜å¤ªå¤§è€Œä¸èƒ½å¸¸é©»å†…å­˜ äºŒçº§ç´¢å¼•æ›´å°ï¼Œå¯ä»¥å¸¸é©»å†…å­˜ å‡å°‘ç£ç›˜I/Oæ¬¡æ•° æ³¨æ„ï¼Œæœ€å·¦è¾¹æ˜¯äºŒçº§ç´¢å¼•ï¼Œä¸€çº§ç´¢å¼•æŒ‡å‘æ•°æ®ã€‚ ä¾‹ï¼šä¸€ä¸ªå—å 4KBï¼Œä¸€çº§ç´¢å¼•10,000ä¸ªå—ï¼Œæ¯ä¸ªå—å¯å­˜100ä¸ªç´¢å¼•é¡¹ï¼Œå…±40MBã€‚äºŒçº§ç¨€ç–ç´¢å¼•100ä¸ªå—ï¼Œå…±400KBã€‚æŸ¥æ‰¾ä¸€ä¸ªè®°å½•éœ€è¦å¤šå°‘æ¬¡ I/O ï¼Ÿ äºŒçº§ç´¢å¼•ä½äºå†…å­˜é‡Œé¢ï¼Œç›´æ¥è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œéœ€è¦ 0 æ¬¡ I/Oï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€çº§ç´¢å¼•å—çš„åœ°å€ ä¸€æ¬¡ I/O è¯»å…¥ä¸€çº§ç´¢å¼•å—è¿›å…¥å†…å­˜ï¼Œåœ¨å†…å­˜è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå¾—åˆ°æ•°æ®å—åœ°å€ï¼Œ1 æ¬¡ I/Oï¼Œå…±ä¸¤æ¬¡ã€‚ äºŒçº§ç´¢å¼•å¿…é¡»ç”¨ç¨€ç–ç´¢å¼•ï¼Œä¸ç„¶å®Œå…¨æ²¡æœ‰æ„ä¹‰ï¼šå› ä¸ºäºŒçº§ç´¢å¼•å­˜åœ¨å°±æ˜¯å› ä¸ºä¸€çº§ç´¢å¼•å¤ªå¤šäº†ã€‚ è¾…åŠ©ç´¢å¼•å‡è®¾ä¸€å¼ è¡¨ï¼šStudent(id, name, age, dept)ï¼Œæ•°æ®æŒ‰ idï¼ˆä¸»é”®ï¼‰é¡ºåºå­˜ï¼Œç°åœ¨æŸ¥ï¼šSELECT * FROM Student WHERE dept = 'CS'; ï¼Œç”±äº dept ä¸æ˜¯ä¸»é”®ï¼Œåªèƒ½å…¨è¡¨æ‰«æï¼ˆè¯»æ‰€æœ‰æ•°æ®å—ï¼‰ï¼Œè¿™åœ¨æ•°æ®é‡å¤§æ—¶éå¸¸æ…¢ã€‚ ä¸ºä»€ä¹ˆè¾…åŠ©ç´¢å¼•ä¸èƒ½ç”¨ç¨€ç–ç´¢å¼•ï¼Ÿ å› ä¸ºæ•°æ®æ–‡ä»¶ä¸æ˜¯æŒ‰è¾…åŠ©ç´¢å¼•å­—æ®µé¡ºåºå­˜æ”¾çš„ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸»é”®é¡ºåºå­˜æ”¾çš„ã€‚å¯¹äºä¸»é”®æ¥è¯´ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥æ‰¾åˆ°å—åï¼Œé¡ºåºæ‰«å—å†…æ•°æ®å°±è¡Œã€‚ä½†æ˜¯å¯¹äºè¾…åŠ©ç´¢å¼•å­—æ®µï¼ŒæŸä¸ªå—å†… key=10 è¿™æ¡è®°å½•ä¸‹ä¸€ä¸ªè®°å½•å¯èƒ½ key=5ã€‚ é‡å¤é”®å€¼æ€ä¹ˆå¤„ç†ï¼Ÿ å¤šä¸ªç´¢å¼•é¡¹ï¼Œæ¯ä¸ªç´¢å¼•é¡¹æŒ‡å‘ä¸€æ¡è®°å½• ç´¢å¼•é¡¹ + æŒ‡é’ˆé“¾è¡¨ï¼ŒæŒ‡å‘ä¸€ä¸ª è®°å½•æŒ‡é’ˆé“¾è¡¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè®°å½• B+æ ‘å¶å­ç»“ç‚¹ é—´æ¥æ¡¶ é—´æ¥æ¡¶çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¾…åŠ©ç´¢å¼•é‡å¤é”®å€¼æµªè´¹ç©ºé—´çš„é—®é¢˜ã€‚ æ€è·¯ç±»ä¼¼æŒ‡é’ˆé“¾è¡¨ï¼Œå°±æ˜¯åœ¨bucketé‡Œé¢å­˜å‚¨é‡å¤çš„é”®å€¼æŒ‡é’ˆ å€’æ’ç´¢å¼•åº”ç”¨äºæ–‡æ¡£æ£€ç´¢ï¼Œå°±æ˜¯å…³é”®è¯æŸ¥æ‰¾ä½äºæ–‡æ¡£çš„å“ªä¸ªä½ç½®ã€‚ä¸ºæ¯ä¸ªæ£€ç´¢è¯å»ºç«‹é—´æ¥æ¡¶ï¼Œæ¡¶çš„æŒ‡é’ˆæŒ‡å‘æ£€ç´¢è¯æ‰€å‡ºç°çš„æ–‡æ¡£ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å¤šçº§ç´¢å¼•"},{"categories":null,"content":" é¡ºåºæ–‡ä»¶ç´¢å¼• å¯†é›†ç´¢å¼• è®°å½•é€šå¸¸æ¯”ç´¢å¼•é¡¹è¦å¤§ ç´¢å¼•å¯ä»¥å¸¸é©»å†…å­˜ è¦æŸ¥æ‰¾é”®å€¼ä¸ºKçš„è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸éœ€è¦è®¿é—®ç£ç›˜æ•°æ® ç¨€ç–ç´¢å¼• ä»…ä¸ºæ¯ä¸ªæ•°æ®å—çš„ç¬¬ä¸€ä¸ªè®°å½•å»ºç«‹ç´¢å¼• èŠ‚çœäº†ç´¢å¼•ç©ºé—´ï¼Œ å¯¹åŒæ ·çš„è®°å½•ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥ä½¿ç”¨æ›´å°‘çš„ç´¢å¼•é¡¹ã€‚ ä½†æ˜¯æ²¡åŠæ³•ç›´æ¥çŸ¥é“ï¼Œæ˜¯å¦å­˜åœ¨ key=K çš„è®°å½•ï¼Œéœ€è¦éå† å¤šçº§ç´¢å¼• ä¸€çº§ç´¢å¼•å¯èƒ½è¿˜å¤ªå¤§è€Œä¸èƒ½å¸¸é©»å†…å­˜ äºŒçº§ç´¢å¼•æ›´å°ï¼Œå¯ä»¥å¸¸é©»å†…å­˜ å‡å°‘ç£ç›˜I/Oæ¬¡æ•° æ³¨æ„ï¼Œæœ€å·¦è¾¹æ˜¯äºŒçº§ç´¢å¼•ï¼Œä¸€çº§ç´¢å¼•æŒ‡å‘æ•°æ®ã€‚ ä¾‹ï¼šä¸€ä¸ªå—å 4KBï¼Œä¸€çº§ç´¢å¼•10,000ä¸ªå—ï¼Œæ¯ä¸ªå—å¯å­˜100ä¸ªç´¢å¼•é¡¹ï¼Œå…±40MBã€‚äºŒçº§ç¨€ç–ç´¢å¼•100ä¸ªå—ï¼Œå…±400KBã€‚æŸ¥æ‰¾ä¸€ä¸ªè®°å½•éœ€è¦å¤šå°‘æ¬¡ I/O ï¼Ÿ äºŒçº§ç´¢å¼•ä½äºå†…å­˜é‡Œé¢ï¼Œç›´æ¥è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œéœ€è¦ 0 æ¬¡ I/Oï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€çº§ç´¢å¼•å—çš„åœ°å€ ä¸€æ¬¡ I/O è¯»å…¥ä¸€çº§ç´¢å¼•å—è¿›å…¥å†…å­˜ï¼Œåœ¨å†…å­˜è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå¾—åˆ°æ•°æ®å—åœ°å€ï¼Œ1 æ¬¡ I/Oï¼Œå…±ä¸¤æ¬¡ã€‚ äºŒçº§ç´¢å¼•å¿…é¡»ç”¨ç¨€ç–ç´¢å¼•ï¼Œä¸ç„¶å®Œå…¨æ²¡æœ‰æ„ä¹‰ï¼šå› ä¸ºäºŒçº§ç´¢å¼•å­˜åœ¨å°±æ˜¯å› ä¸ºä¸€çº§ç´¢å¼•å¤ªå¤šäº†ã€‚ è¾…åŠ©ç´¢å¼•å‡è®¾ä¸€å¼ è¡¨ï¼šStudent(id, name, age, dept)ï¼Œæ•°æ®æŒ‰ idï¼ˆä¸»é”®ï¼‰é¡ºåºå­˜ï¼Œç°åœ¨æŸ¥ï¼šSELECT * FROM Student WHERE dept = 'CS'; ï¼Œç”±äº dept ä¸æ˜¯ä¸»é”®ï¼Œåªèƒ½å…¨è¡¨æ‰«æï¼ˆè¯»æ‰€æœ‰æ•°æ®å—ï¼‰ï¼Œè¿™åœ¨æ•°æ®é‡å¤§æ—¶éå¸¸æ…¢ã€‚ ä¸ºä»€ä¹ˆè¾…åŠ©ç´¢å¼•ä¸èƒ½ç”¨ç¨€ç–ç´¢å¼•ï¼Ÿ å› ä¸ºæ•°æ®æ–‡ä»¶ä¸æ˜¯æŒ‰è¾…åŠ©ç´¢å¼•å­—æ®µé¡ºåºå­˜æ”¾çš„ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸»é”®é¡ºåºå­˜æ”¾çš„ã€‚å¯¹äºä¸»é”®æ¥è¯´ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥æ‰¾åˆ°å—åï¼Œé¡ºåºæ‰«å—å†…æ•°æ®å°±è¡Œã€‚ä½†æ˜¯å¯¹äºè¾…åŠ©ç´¢å¼•å­—æ®µï¼ŒæŸä¸ªå—å†… key=10 è¿™æ¡è®°å½•ä¸‹ä¸€ä¸ªè®°å½•å¯èƒ½ key=5ã€‚ é‡å¤é”®å€¼æ€ä¹ˆå¤„ç†ï¼Ÿ å¤šä¸ªç´¢å¼•é¡¹ï¼Œæ¯ä¸ªç´¢å¼•é¡¹æŒ‡å‘ä¸€æ¡è®°å½• ç´¢å¼•é¡¹ + æŒ‡é’ˆé“¾è¡¨ï¼ŒæŒ‡å‘ä¸€ä¸ª è®°å½•æŒ‡é’ˆé“¾è¡¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè®°å½• B+æ ‘å¶å­ç»“ç‚¹ é—´æ¥æ¡¶ é—´æ¥æ¡¶çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¾…åŠ©ç´¢å¼•é‡å¤é”®å€¼æµªè´¹ç©ºé—´çš„é—®é¢˜ã€‚ æ€è·¯ç±»ä¼¼æŒ‡é’ˆé“¾è¡¨ï¼Œå°±æ˜¯åœ¨bucketé‡Œé¢å­˜å‚¨é‡å¤çš„é”®å€¼æŒ‡é’ˆ å€’æ’ç´¢å¼•åº”ç”¨äºæ–‡æ¡£æ£€ç´¢ï¼Œå°±æ˜¯å…³é”®è¯æŸ¥æ‰¾ä½äºæ–‡æ¡£çš„å“ªä¸ªä½ç½®ã€‚ä¸ºæ¯ä¸ªæ£€ç´¢è¯å»ºç«‹é—´æ¥æ¡¶ï¼Œæ¡¶çš„æŒ‡é’ˆæŒ‡å‘æ£€ç´¢è¯æ‰€å‡ºç°çš„æ–‡æ¡£ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è¾…åŠ©ç´¢å¼•"},{"categories":null,"content":" é¡ºåºæ–‡ä»¶ç´¢å¼• å¯†é›†ç´¢å¼• è®°å½•é€šå¸¸æ¯”ç´¢å¼•é¡¹è¦å¤§ ç´¢å¼•å¯ä»¥å¸¸é©»å†…å­˜ è¦æŸ¥æ‰¾é”®å€¼ä¸ºKçš„è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸éœ€è¦è®¿é—®ç£ç›˜æ•°æ® ç¨€ç–ç´¢å¼• ä»…ä¸ºæ¯ä¸ªæ•°æ®å—çš„ç¬¬ä¸€ä¸ªè®°å½•å»ºç«‹ç´¢å¼• èŠ‚çœäº†ç´¢å¼•ç©ºé—´ï¼Œ å¯¹åŒæ ·çš„è®°å½•ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥ä½¿ç”¨æ›´å°‘çš„ç´¢å¼•é¡¹ã€‚ ä½†æ˜¯æ²¡åŠæ³•ç›´æ¥çŸ¥é“ï¼Œæ˜¯å¦å­˜åœ¨ key=K çš„è®°å½•ï¼Œéœ€è¦éå† å¤šçº§ç´¢å¼• ä¸€çº§ç´¢å¼•å¯èƒ½è¿˜å¤ªå¤§è€Œä¸èƒ½å¸¸é©»å†…å­˜ äºŒçº§ç´¢å¼•æ›´å°ï¼Œå¯ä»¥å¸¸é©»å†…å­˜ å‡å°‘ç£ç›˜I/Oæ¬¡æ•° æ³¨æ„ï¼Œæœ€å·¦è¾¹æ˜¯äºŒçº§ç´¢å¼•ï¼Œä¸€çº§ç´¢å¼•æŒ‡å‘æ•°æ®ã€‚ ä¾‹ï¼šä¸€ä¸ªå—å 4KBï¼Œä¸€çº§ç´¢å¼•10,000ä¸ªå—ï¼Œæ¯ä¸ªå—å¯å­˜100ä¸ªç´¢å¼•é¡¹ï¼Œå…±40MBã€‚äºŒçº§ç¨€ç–ç´¢å¼•100ä¸ªå—ï¼Œå…±400KBã€‚æŸ¥æ‰¾ä¸€ä¸ªè®°å½•éœ€è¦å¤šå°‘æ¬¡ I/O ï¼Ÿ äºŒçº§ç´¢å¼•ä½äºå†…å­˜é‡Œé¢ï¼Œç›´æ¥è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œéœ€è¦ 0 æ¬¡ I/Oï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€çº§ç´¢å¼•å—çš„åœ°å€ ä¸€æ¬¡ I/O è¯»å…¥ä¸€çº§ç´¢å¼•å—è¿›å…¥å†…å­˜ï¼Œåœ¨å†…å­˜è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå¾—åˆ°æ•°æ®å—åœ°å€ï¼Œ1 æ¬¡ I/Oï¼Œå…±ä¸¤æ¬¡ã€‚ äºŒçº§ç´¢å¼•å¿…é¡»ç”¨ç¨€ç–ç´¢å¼•ï¼Œä¸ç„¶å®Œå…¨æ²¡æœ‰æ„ä¹‰ï¼šå› ä¸ºäºŒçº§ç´¢å¼•å­˜åœ¨å°±æ˜¯å› ä¸ºä¸€çº§ç´¢å¼•å¤ªå¤šäº†ã€‚ è¾…åŠ©ç´¢å¼•å‡è®¾ä¸€å¼ è¡¨ï¼šStudent(id, name, age, dept)ï¼Œæ•°æ®æŒ‰ idï¼ˆä¸»é”®ï¼‰é¡ºåºå­˜ï¼Œç°åœ¨æŸ¥ï¼šSELECT * FROM Student WHERE dept = 'CS'; ï¼Œç”±äº dept ä¸æ˜¯ä¸»é”®ï¼Œåªèƒ½å…¨è¡¨æ‰«æï¼ˆè¯»æ‰€æœ‰æ•°æ®å—ï¼‰ï¼Œè¿™åœ¨æ•°æ®é‡å¤§æ—¶éå¸¸æ…¢ã€‚ ä¸ºä»€ä¹ˆè¾…åŠ©ç´¢å¼•ä¸èƒ½ç”¨ç¨€ç–ç´¢å¼•ï¼Ÿ å› ä¸ºæ•°æ®æ–‡ä»¶ä¸æ˜¯æŒ‰è¾…åŠ©ç´¢å¼•å­—æ®µé¡ºåºå­˜æ”¾çš„ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸»é”®é¡ºåºå­˜æ”¾çš„ã€‚å¯¹äºä¸»é”®æ¥è¯´ï¼Œç¨€ç–ç´¢å¼•å¯ä»¥æ‰¾åˆ°å—åï¼Œé¡ºåºæ‰«å—å†…æ•°æ®å°±è¡Œã€‚ä½†æ˜¯å¯¹äºè¾…åŠ©ç´¢å¼•å­—æ®µï¼ŒæŸä¸ªå—å†… key=10 è¿™æ¡è®°å½•ä¸‹ä¸€ä¸ªè®°å½•å¯èƒ½ key=5ã€‚ é‡å¤é”®å€¼æ€ä¹ˆå¤„ç†ï¼Ÿ å¤šä¸ªç´¢å¼•é¡¹ï¼Œæ¯ä¸ªç´¢å¼•é¡¹æŒ‡å‘ä¸€æ¡è®°å½• ç´¢å¼•é¡¹ + æŒ‡é’ˆé“¾è¡¨ï¼ŒæŒ‡å‘ä¸€ä¸ª è®°å½•æŒ‡é’ˆé“¾è¡¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè®°å½• B+æ ‘å¶å­ç»“ç‚¹ é—´æ¥æ¡¶ é—´æ¥æ¡¶çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¾…åŠ©ç´¢å¼•é‡å¤é”®å€¼æµªè´¹ç©ºé—´çš„é—®é¢˜ã€‚ æ€è·¯ç±»ä¼¼æŒ‡é’ˆé“¾è¡¨ï¼Œå°±æ˜¯åœ¨bucketé‡Œé¢å­˜å‚¨é‡å¤çš„é”®å€¼æŒ‡é’ˆ å€’æ’ç´¢å¼•åº”ç”¨äºæ–‡æ¡£æ£€ç´¢ï¼Œå°±æ˜¯å…³é”®è¯æŸ¥æ‰¾ä½äºæ–‡æ¡£çš„å“ªä¸ªä½ç½®ã€‚ä¸ºæ¯ä¸ªæ£€ç´¢è¯å»ºç«‹é—´æ¥æ¡¶ï¼Œæ¡¶çš„æŒ‡é’ˆæŒ‡å‘æ£€ç´¢è¯æ‰€å‡ºç°çš„æ–‡æ¡£ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å€’æ’ç´¢å¼•"},{"categories":null,"content":" B+æ ‘ B+æ ‘æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ n ä¸ªå€¼ï¼Œn+1 ä¸ªæŒ‡é’ˆ éå¶èŠ‚ç‚¹ï¼Œn ä¸ªé”®å€¼åˆ’åˆ† n+1 ä¸ªå­—æ•°ï¼Œä¾‹å¦‚ï¼š[p1(keyå°äº10çš„èŠ‚ç‚¹æŒ‡é’ˆ), 10, p2(10\u003ckey\u003c20çš„èŠ‚ç‚¹æŒ‡é’ˆ)] å¶èŠ‚ç‚¹ï¼Œå‰ n ä¸ªæŒ‡é’ˆå¯¹åº” n ä¸ªå€¼çš„æŒ‡é’ˆï¼Œæœ€åä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå¶èŠ‚ç‚¹ã€‚ B+æ ‘å’ŒBæ ‘åŒºåˆ«æ˜¯ï¼Œå¶èŠ‚ç‚¹ä¹‹åæœ‰é¡ºåºè¿æ¥çš„æŒ‡é’ˆï¼Œå¯ä»¥è¿›è¡Œéå†ã€‚ æŸ¥æ‰¾ ä»æ ¹ç»“ç‚¹å¼€å§‹ æ²¿æŒ‡é’ˆå‘ä¸‹ï¼Œç›´åˆ°åˆ°è¾¾å¶ç»“ç‚¹ åœ¨å¶ç»“ç‚¹ä¸­é¡ºåºæŸ¥æ‰¾ æ’å…¥ å¯¹äºå¶èŠ‚ç‚¹çš„åˆ†è£‚ï¼Œä»ä¸­é—´(å‘ä¸Šå–æ•´)çš„ä½ç½®æ–­å¼€ï¼Œç„¶åå³ä¾§æ–°èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ª key ä¸Šæã€‚ å¯¹äºéå¶èŠ‚ç‚¹çš„åˆ†è£‚ï¼Œä»ä¸­é—´(å‘ä¸Šå–æ•´)çš„ä½ç½®æ–­å¼€ï¼Œç„¶åå³ä¾§æ–°èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ª key ä¸Šæï¼Œä½†æ˜¯åˆ†è£‚çš„æ–°èŠ‚ç‚¹ï¼Œä¸åŒ…å«ç¬¬ä¸€ä¸ªkeyã€‚å¦‚å›¾å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€æ¬¡å¶èŠ‚ç‚¹åˆ†è£‚ï¼Œåˆ†è£‚çš„æ–°èŠ‚ç‚¹åŒ…å« 40ï¼›ä½†æ˜¯ç¬¬äºŒæ¬¡éå¶èŠ‚ç‚¹åˆ†è£‚ï¼Œåˆ†è£‚å‡ºæ¥æ–°èŠ‚ç‚¹åªæœ‰40ï¼Œæ²¡æœ‰ 30ã€‚ åˆ é™¤ åˆ é™¤åæ»¡è¶³è¦æ±‚ä¸ç®¡ åˆ é™¤åä¸æ»¡è¶³è¦æ±‚ å…„å¼Ÿå¤Ÿå€Ÿå°±å€Ÿï¼Œæ³¨æ„æ”¹çˆ¶èŠ‚ç‚¹å…ƒç´  å…„å¼Ÿä¸å¤Ÿå€Ÿå°±å’Œå…„å¼Ÿåˆå¹¶ï¼Œæ³¨æ„åˆ çˆ¶èŠ‚ç‚¹å…ƒç´  æ•ˆç‡ è®¿é—®ç´¢å¼•çš„ I/O ä»£ä»·ï¼æ ‘é«˜ï¼ˆBï¼‹æ ‘ä¸å¸¸é©»å†…å­˜ï¼‰æˆ–è€…0ï¼ˆå¸¸é©»å†…å­˜ï¼‰ æ ‘é«˜é€šå¸¸ä¸è¶…è¿‡ 3 å±‚ï¼Œå› æ­¤ç´¢å¼• I/O ä»£ä»·ä¸è¶…è¿‡ 3ï¼Œæ€»ä»£ä»·ä¸è¶…è¿‡ 4ã€‚ ä¸ºä»€ä¹ˆè¯´æ€»ä»£ä»·ä¸è¶…è¿‡ 4ï¼Œé¡ºåºæŸ¥æ‰¾ä¸éœ€è¦ I/Oå—ï¼Ÿ å½“æˆ‘ä»¬æŸ¥æ‰¾åˆ°å¶èŠ‚ç‚¹æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæŠŠè¿™ä¸ª key æ‰€åœ¨çš„æ•´ä¸ªå—è¯»è¿›å†…å­˜ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„é¡ºåºæŸ¥æ‰¾åœ¨å†…å­˜é‡Œï¼Œæ²¡æœ‰ I/O å¼€é”€ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#bæ ‘"},{"categories":null,"content":" B+æ ‘ B+æ ‘æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ n ä¸ªå€¼ï¼Œn+1 ä¸ªæŒ‡é’ˆ éå¶èŠ‚ç‚¹ï¼Œn ä¸ªé”®å€¼åˆ’åˆ† n+1 ä¸ªå­—æ•°ï¼Œä¾‹å¦‚ï¼š[p1(keyå°äº10çš„èŠ‚ç‚¹æŒ‡é’ˆ), 10, p2(10","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æŸ¥æ‰¾"},{"categories":null,"content":" B+æ ‘ B+æ ‘æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ n ä¸ªå€¼ï¼Œn+1 ä¸ªæŒ‡é’ˆ éå¶èŠ‚ç‚¹ï¼Œn ä¸ªé”®å€¼åˆ’åˆ† n+1 ä¸ªå­—æ•°ï¼Œä¾‹å¦‚ï¼š[p1(keyå°äº10çš„èŠ‚ç‚¹æŒ‡é’ˆ), 10, p2(10","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ’å…¥-1"},{"categories":null,"content":" B+æ ‘ B+æ ‘æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ n ä¸ªå€¼ï¼Œn+1 ä¸ªæŒ‡é’ˆ éå¶èŠ‚ç‚¹ï¼Œn ä¸ªé”®å€¼åˆ’åˆ† n+1 ä¸ªå­—æ•°ï¼Œä¾‹å¦‚ï¼š[p1(keyå°äº10çš„èŠ‚ç‚¹æŒ‡é’ˆ), 10, p2(10","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#åˆ é™¤-1"},{"categories":null,"content":" B+æ ‘ B+æ ‘æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ n ä¸ªå€¼ï¼Œn+1 ä¸ªæŒ‡é’ˆ éå¶èŠ‚ç‚¹ï¼Œn ä¸ªé”®å€¼åˆ’åˆ† n+1 ä¸ªå­—æ•°ï¼Œä¾‹å¦‚ï¼š[p1(keyå°äº10çš„èŠ‚ç‚¹æŒ‡é’ˆ), 10, p2(10","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ•ˆç‡"},{"categories":null,"content":" æ•£åˆ—è¡¨ æ ¹æ®æ•£åˆ—å‡½æ•°ï¼ŒæŠŠ key æ˜ å°„åˆ°æ¡¶ idã€‚ ä¸€ä¸ªæ¡¶ä¸€èˆ¬ä¼šå¯¹åº”ä¸€ä¸ª blockï¼Œå—å†…åŒ…å«å¤šæ¡è®°å½•ã€‚I/O æ¬¡æ•°å–å†³äº n blocks/bucketã€‚ æ•£åˆ—è¡¨æ’å…¥æ—¶å€™ï¼Œå¦‚æœæ¡¶å†…æ²¡æœ‰ç©ºé—´ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæº¢å‡ºå—è¿æ¥åˆ°æ¡¶ã€‚ æ•£åˆ—è¡¨åˆ é™¤æ—¶å€™ï¼Œå¦‚æœæ¡¶å†…æœ‰å¤šä½™ç©ºé—´äº†ï¼Œä¼šæŠŠæº¢å‡ºå—æåˆ°æ¡¶å†…ï¼Œåˆ é™¤æº¢å‡ºå—ã€‚ æ•£åˆ—è¡¨ç©ºé—´åˆ©ç”¨ç‡é—®é¢˜=å®é™…é”®å€¼æ•°/ æ‰€æœ‰æ¡¶å¯æ”¾ç½®çš„é”®å€¼æ•°ï¼Œæ‰€ä»¥åˆ©ç”¨ç‡å¯èƒ½å¤§äº 1ã€‚ åˆ©ç”¨ç‡è¶Šå¤§å°±æœ‰å¯èƒ½å†²çªï¼Œæ‰€ä»¥ä¸æ˜¯å¥½äº‹ã€‚ å¯æ‰©å±•æ•£åˆ—è¡¨æ•°æ®æ–‡ä»¶çš„å¢é•¿ä½¿æ¡¶çš„æº¢å‡ºå—æ•°å¢å¤šï¼Œå¢åŠ I/Oï¼Œå¯æ‹“å±•æ•£åˆ—è¡¨å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æ•£åˆ—å‡½æ•°ä¼šæŠŠ key æ˜ å°„ä¸ºä¸€ä¸ª äºŒè¿›åˆ¶åºåˆ—ï¼Œç„¶åå–å‰ g ä½ä½œä¸ºæ¡¶ idï¼Œæ‰¾åˆ°æ¡¶æŒ‡é’ˆã€‚ å¦‚æœæ¡¶æœ‰ç©ºä½ï¼Œç›´æ¥æ’å…¥ å¦‚æœæ¡¶æ²¡æœ‰ç©ºä½ï¼Œä¼šè¿›è¡Œåˆ†è£‚ å¦‚æœ l \u003e gï¼šg++ï¼Œæ‰©å±•ç›®å½•ã€‚ å¦‚æœ l \u003c gï¼šé‡æ–°æ•£åˆ—è¯¥å—çš„æ•°æ®åˆ°å…¶ä»–ä¸¤å—ï¼Œl++ ä¼˜ç‚¹ï¼šå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸å­˜åœ¨ç€æº¢å‡ºå—ï¼Œå› æ­¤å½“æŸ¥æ‰¾è®°å½•æ—¶ï¼Œåªéœ€æŸ¥æ‰¾ä¸€ä¸ª å­˜å‚¨å—ã€‚ ç¼ºç‚¹ï¼šæ¡¶å¢é•¿é€Ÿåº¦å¿«ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ”¾ä¸ä¸‹æ•´ä¸ªæ¡¶æ•°ç»„ï¼Œå½±å“å…¶ä»–ä¿å­˜ åœ¨ä¸»å­˜ä¸­çš„æ•°æ®ï¼Œæ³¢åŠ¨è¾ƒå¤§ã€‚ çº¿æ€§æ•£åˆ—è¡¨ text ä¾‹: - æ•£åˆ—ä½æ•° (i): 1 (çœ‹äºŒè¿›åˆ¶æœ€å 1 ä½) - æ¡¶æ•° (n): 2 (ç›®å‰åªæœ‰æ¡¶ 0 å’Œ æ¡¶ 1) - åˆ†è£‚æŒ‡é’ˆ (next): 0 (å› ä¸º n=2 æ˜¯ 2^1 çš„æ•´æ•°å€ï¼Œä¸€è½®åˆ†è£‚åˆšå¼€å§‹ï¼ŒæŒ‡é’ˆåœ¨å¼€å¤´) - å½“å‰æ•°æ®: - Bucket 0: 0000, 1010 (å‡ä»¥ 0 ç»“å°¾) - Bucket 1: 1111 (ä»¥ 1 ç»“å°¾) å‡è®¾æ’å…¥ 0101ï¼Œç»è¿‡æ•£åˆ— $0101 \\mod 2^i=1$ ï¼Œæ‰€ä»¥æ’å…¥ Bucket 1ã€‚ åˆ¤æ–­æ˜¯å¦åˆ†è£‚ï¼Œ$\\frac{r}{n}=2\u003e1.7$ æ‰€ä»¥è§¦å‘åˆ†è£‚ï¼Œå¯¹ next æŒ‡å‘çš„ Bucket 0 å’Œä¹‹å‰å…¨éƒ¨ Bucket éƒ½è¿›è¡Œåˆ†è£‚ã€‚ n å˜æˆ 3ï¼Œæ–°å¢ Bucket 2 å¯¹ Bucket 0 çš„æ•°æ®è¿›è¡Œé‡æ’ $0000 \\mod 2^{i+1}=0$ ï¼Œè¿˜åœ¨ Bucket 0 $1010 \\mod 2^{i+1} = 2$ï¼Œåœ¨ Bucket 2 è§¦å‘äº†åˆ†è£‚ï¼Œnext æŒ‡é’ˆéƒ½ç§»åŠ¨ n=3 è¶…è¿‡ $2^i$ æ‰€ä»¥ i++ æ³¨æ„é¢˜ç›®è¯´çš„æ˜¯ â€œ$\\frac{r}{n}\u003e1.7$â€ æˆ–è€…è¯´ â€œç©ºé—´åˆ©ç”¨ç‡å¤§äº80%æ—¶â€ï¼Œå¦‚æœæ˜¯åè€…çš„è¯ï¼šç©ºé—´åˆ©ç”¨ç‡=$\\frac{å…ƒç´ ä¸ªæ•°}{æ¡¶æ•° \\times æ¡¶å®¹é‡}$ ï¼Œä¹Ÿå°±æ˜¯è¯´ $\\frac{r}{n} \\gt 0.8 \\times æ¡¶æ•°$ ã€‚ å‡è®¾å†æ’å…¥ 0001ï¼Œç»è¿‡æ•£åˆ— $0001 \\mod 2^i=1$ ï¼Œæ‰€ä»¥æ’å…¥ Bucket 1ã€‚ åˆ¤æ–­æ˜¯å¦åˆ†è£‚ï¼Œ$\\frac{r}{n}=\\frac{5}{3}\u003c1.7$ æ‰€ä»¥ä¸åˆ†è£‚ã€‚Bucket 1 å…ƒç´ è¶…è¿‡ä¸Šé™ï¼Œä¸å¢åŠ æ–°æ¡¶æ‰€ä»¥ä½¿ç”¨æº¢å‡ºå—ã€‚ å¯æ‰©å±•æ•£åˆ—è¡¨æ²¡æœ‰æº¢å‡ºå—ï¼Œçº¿æ€§æ•£åˆ—è¡¨æœ‰å¯èƒ½æœ‰æº¢å‡ºå—ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ•£åˆ—è¡¨"},{"categories":null,"content":" æ•£åˆ—è¡¨ æ ¹æ®æ•£åˆ—å‡½æ•°ï¼ŒæŠŠ key æ˜ å°„åˆ°æ¡¶ idã€‚ ä¸€ä¸ªæ¡¶ä¸€èˆ¬ä¼šå¯¹åº”ä¸€ä¸ª blockï¼Œå—å†…åŒ…å«å¤šæ¡è®°å½•ã€‚I/O æ¬¡æ•°å–å†³äº n blocks/bucketã€‚ æ•£åˆ—è¡¨æ’å…¥æ—¶å€™ï¼Œå¦‚æœæ¡¶å†…æ²¡æœ‰ç©ºé—´ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæº¢å‡ºå—è¿æ¥åˆ°æ¡¶ã€‚ æ•£åˆ—è¡¨åˆ é™¤æ—¶å€™ï¼Œå¦‚æœæ¡¶å†…æœ‰å¤šä½™ç©ºé—´äº†ï¼Œä¼šæŠŠæº¢å‡ºå—æåˆ°æ¡¶å†…ï¼Œåˆ é™¤æº¢å‡ºå—ã€‚ æ•£åˆ—è¡¨ç©ºé—´åˆ©ç”¨ç‡é—®é¢˜=å®é™…é”®å€¼æ•°/ æ‰€æœ‰æ¡¶å¯æ”¾ç½®çš„é”®å€¼æ•°ï¼Œæ‰€ä»¥åˆ©ç”¨ç‡å¯èƒ½å¤§äº 1ã€‚ åˆ©ç”¨ç‡è¶Šå¤§å°±æœ‰å¯èƒ½å†²çªï¼Œæ‰€ä»¥ä¸æ˜¯å¥½äº‹ã€‚ å¯æ‰©å±•æ•£åˆ—è¡¨æ•°æ®æ–‡ä»¶çš„å¢é•¿ä½¿æ¡¶çš„æº¢å‡ºå—æ•°å¢å¤šï¼Œå¢åŠ I/Oï¼Œå¯æ‹“å±•æ•£åˆ—è¡¨å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æ•£åˆ—å‡½æ•°ä¼šæŠŠ key æ˜ å°„ä¸ºä¸€ä¸ª äºŒè¿›åˆ¶åºåˆ—ï¼Œç„¶åå–å‰ g ä½ä½œä¸ºæ¡¶ idï¼Œæ‰¾åˆ°æ¡¶æŒ‡é’ˆã€‚ å¦‚æœæ¡¶æœ‰ç©ºä½ï¼Œç›´æ¥æ’å…¥ å¦‚æœæ¡¶æ²¡æœ‰ç©ºä½ï¼Œä¼šè¿›è¡Œåˆ†è£‚ å¦‚æœ l \u003e gï¼šg++ï¼Œæ‰©å±•ç›®å½•ã€‚ å¦‚æœ l \u003c gï¼šé‡æ–°æ•£åˆ—è¯¥å—çš„æ•°æ®åˆ°å…¶ä»–ä¸¤å—ï¼Œl++ ä¼˜ç‚¹ï¼šå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸å­˜åœ¨ç€æº¢å‡ºå—ï¼Œå› æ­¤å½“æŸ¥æ‰¾è®°å½•æ—¶ï¼Œåªéœ€æŸ¥æ‰¾ä¸€ä¸ª å­˜å‚¨å—ã€‚ ç¼ºç‚¹ï¼šæ¡¶å¢é•¿é€Ÿåº¦å¿«ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ”¾ä¸ä¸‹æ•´ä¸ªæ¡¶æ•°ç»„ï¼Œå½±å“å…¶ä»–ä¿å­˜ åœ¨ä¸»å­˜ä¸­çš„æ•°æ®ï¼Œæ³¢åŠ¨è¾ƒå¤§ã€‚ çº¿æ€§æ•£åˆ—è¡¨ text ä¾‹: - æ•£åˆ—ä½æ•° (i): 1 (çœ‹äºŒè¿›åˆ¶æœ€å 1 ä½) - æ¡¶æ•° (n): 2 (ç›®å‰åªæœ‰æ¡¶ 0 å’Œ æ¡¶ 1) - åˆ†è£‚æŒ‡é’ˆ (next): 0 (å› ä¸º n=2 æ˜¯ 2^1 çš„æ•´æ•°å€ï¼Œä¸€è½®åˆ†è£‚åˆšå¼€å§‹ï¼ŒæŒ‡é’ˆåœ¨å¼€å¤´) - å½“å‰æ•°æ®: - Bucket 0: 0000, 1010 (å‡ä»¥ 0 ç»“å°¾) - Bucket 1: 1111 (ä»¥ 1 ç»“å°¾) å‡è®¾æ’å…¥ 0101ï¼Œç»è¿‡æ•£åˆ— $0101 \\mod 2^i=1$ ï¼Œæ‰€ä»¥æ’å…¥ Bucket 1ã€‚ åˆ¤æ–­æ˜¯å¦åˆ†è£‚ï¼Œ$\\frac{r}{n}=2\u003e1.7$ æ‰€ä»¥è§¦å‘åˆ†è£‚ï¼Œå¯¹ next æŒ‡å‘çš„ Bucket 0 å’Œä¹‹å‰å…¨éƒ¨ Bucket éƒ½è¿›è¡Œåˆ†è£‚ã€‚ n å˜æˆ 3ï¼Œæ–°å¢ Bucket 2 å¯¹ Bucket 0 çš„æ•°æ®è¿›è¡Œé‡æ’ $0000 \\mod 2^{i+1}=0$ ï¼Œè¿˜åœ¨ Bucket 0 $1010 \\mod 2^{i+1} = 2$ï¼Œåœ¨ Bucket 2 è§¦å‘äº†åˆ†è£‚ï¼Œnext æŒ‡é’ˆéƒ½ç§»åŠ¨ n=3 è¶…è¿‡ $2^i$ æ‰€ä»¥ i++ æ³¨æ„é¢˜ç›®è¯´çš„æ˜¯ â€œ$\\frac{r}{n}\u003e1.7$â€ æˆ–è€…è¯´ â€œç©ºé—´åˆ©ç”¨ç‡å¤§äº80%æ—¶â€ï¼Œå¦‚æœæ˜¯åè€…çš„è¯ï¼šç©ºé—´åˆ©ç”¨ç‡=$\\frac{å…ƒç´ ä¸ªæ•°}{æ¡¶æ•° \\times æ¡¶å®¹é‡}$ ï¼Œä¹Ÿå°±æ˜¯è¯´ $\\frac{r}{n} \\gt 0.8 \\times æ¡¶æ•°$ ã€‚ å‡è®¾å†æ’å…¥ 0001ï¼Œç»è¿‡æ•£åˆ— $0001 \\mod 2^i=1$ ï¼Œæ‰€ä»¥æ’å…¥ Bucket 1ã€‚ åˆ¤æ–­æ˜¯å¦åˆ†è£‚ï¼Œ$\\frac{r}{n}=\\frac{5}{3}\u003c1.7$ æ‰€ä»¥ä¸åˆ†è£‚ã€‚Bucket 1 å…ƒç´ è¶…è¿‡ä¸Šé™ï¼Œä¸å¢åŠ æ–°æ¡¶æ‰€ä»¥ä½¿ç”¨æº¢å‡ºå—ã€‚ å¯æ‰©å±•æ•£åˆ—è¡¨æ²¡æœ‰æº¢å‡ºå—ï¼Œçº¿æ€§æ•£åˆ—è¡¨æœ‰å¯èƒ½æœ‰æº¢å‡ºå—ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å¯æ‰©å±•æ•£åˆ—è¡¨"},{"categories":null,"content":" æ•£åˆ—è¡¨ æ ¹æ®æ•£åˆ—å‡½æ•°ï¼ŒæŠŠ key æ˜ å°„åˆ°æ¡¶ idã€‚ ä¸€ä¸ªæ¡¶ä¸€èˆ¬ä¼šå¯¹åº”ä¸€ä¸ª blockï¼Œå—å†…åŒ…å«å¤šæ¡è®°å½•ã€‚I/O æ¬¡æ•°å–å†³äº n blocks/bucketã€‚ æ•£åˆ—è¡¨æ’å…¥æ—¶å€™ï¼Œå¦‚æœæ¡¶å†…æ²¡æœ‰ç©ºé—´ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæº¢å‡ºå—è¿æ¥åˆ°æ¡¶ã€‚ æ•£åˆ—è¡¨åˆ é™¤æ—¶å€™ï¼Œå¦‚æœæ¡¶å†…æœ‰å¤šä½™ç©ºé—´äº†ï¼Œä¼šæŠŠæº¢å‡ºå—æåˆ°æ¡¶å†…ï¼Œåˆ é™¤æº¢å‡ºå—ã€‚ æ•£åˆ—è¡¨ç©ºé—´åˆ©ç”¨ç‡é—®é¢˜=å®é™…é”®å€¼æ•°/ æ‰€æœ‰æ¡¶å¯æ”¾ç½®çš„é”®å€¼æ•°ï¼Œæ‰€ä»¥åˆ©ç”¨ç‡å¯èƒ½å¤§äº 1ã€‚ åˆ©ç”¨ç‡è¶Šå¤§å°±æœ‰å¯èƒ½å†²çªï¼Œæ‰€ä»¥ä¸æ˜¯å¥½äº‹ã€‚ å¯æ‰©å±•æ•£åˆ—è¡¨æ•°æ®æ–‡ä»¶çš„å¢é•¿ä½¿æ¡¶çš„æº¢å‡ºå—æ•°å¢å¤šï¼Œå¢åŠ I/Oï¼Œå¯æ‹“å±•æ•£åˆ—è¡¨å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æ•£åˆ—å‡½æ•°ä¼šæŠŠ key æ˜ å°„ä¸ºä¸€ä¸ª äºŒè¿›åˆ¶åºåˆ—ï¼Œç„¶åå–å‰ g ä½ä½œä¸ºæ¡¶ idï¼Œæ‰¾åˆ°æ¡¶æŒ‡é’ˆã€‚ å¦‚æœæ¡¶æœ‰ç©ºä½ï¼Œç›´æ¥æ’å…¥ å¦‚æœæ¡¶æ²¡æœ‰ç©ºä½ï¼Œä¼šè¿›è¡Œåˆ†è£‚ å¦‚æœ l \u003e gï¼šg++ï¼Œæ‰©å±•ç›®å½•ã€‚ å¦‚æœ l \u003c gï¼šé‡æ–°æ•£åˆ—è¯¥å—çš„æ•°æ®åˆ°å…¶ä»–ä¸¤å—ï¼Œl++ ä¼˜ç‚¹ï¼šå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸å­˜åœ¨ç€æº¢å‡ºå—ï¼Œå› æ­¤å½“æŸ¥æ‰¾è®°å½•æ—¶ï¼Œåªéœ€æŸ¥æ‰¾ä¸€ä¸ª å­˜å‚¨å—ã€‚ ç¼ºç‚¹ï¼šæ¡¶å¢é•¿é€Ÿåº¦å¿«ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ”¾ä¸ä¸‹æ•´ä¸ªæ¡¶æ•°ç»„ï¼Œå½±å“å…¶ä»–ä¿å­˜ åœ¨ä¸»å­˜ä¸­çš„æ•°æ®ï¼Œæ³¢åŠ¨è¾ƒå¤§ã€‚ çº¿æ€§æ•£åˆ—è¡¨ text ä¾‹: - æ•£åˆ—ä½æ•° (i): 1 (çœ‹äºŒè¿›åˆ¶æœ€å 1 ä½) - æ¡¶æ•° (n): 2 (ç›®å‰åªæœ‰æ¡¶ 0 å’Œ æ¡¶ 1) - åˆ†è£‚æŒ‡é’ˆ (next): 0 (å› ä¸º n=2 æ˜¯ 2^1 çš„æ•´æ•°å€ï¼Œä¸€è½®åˆ†è£‚åˆšå¼€å§‹ï¼ŒæŒ‡é’ˆåœ¨å¼€å¤´) - å½“å‰æ•°æ®: - Bucket 0: 0000, 1010 (å‡ä»¥ 0 ç»“å°¾) - Bucket 1: 1111 (ä»¥ 1 ç»“å°¾) å‡è®¾æ’å…¥ 0101ï¼Œç»è¿‡æ•£åˆ— $0101 \\mod 2^i=1$ ï¼Œæ‰€ä»¥æ’å…¥ Bucket 1ã€‚ åˆ¤æ–­æ˜¯å¦åˆ†è£‚ï¼Œ$\\frac{r}{n}=2\u003e1.7$ æ‰€ä»¥è§¦å‘åˆ†è£‚ï¼Œå¯¹ next æŒ‡å‘çš„ Bucket 0 å’Œä¹‹å‰å…¨éƒ¨ Bucket éƒ½è¿›è¡Œåˆ†è£‚ã€‚ n å˜æˆ 3ï¼Œæ–°å¢ Bucket 2 å¯¹ Bucket 0 çš„æ•°æ®è¿›è¡Œé‡æ’ $0000 \\mod 2^{i+1}=0$ ï¼Œè¿˜åœ¨ Bucket 0 $1010 \\mod 2^{i+1} = 2$ï¼Œåœ¨ Bucket 2 è§¦å‘äº†åˆ†è£‚ï¼Œnext æŒ‡é’ˆéƒ½ç§»åŠ¨ n=3 è¶…è¿‡ $2^i$ æ‰€ä»¥ i++ æ³¨æ„é¢˜ç›®è¯´çš„æ˜¯ â€œ$\\frac{r}{n}\u003e1.7$â€ æˆ–è€…è¯´ â€œç©ºé—´åˆ©ç”¨ç‡å¤§äº80%æ—¶â€ï¼Œå¦‚æœæ˜¯åè€…çš„è¯ï¼šç©ºé—´åˆ©ç”¨ç‡=$\\frac{å…ƒç´ ä¸ªæ•°}{æ¡¶æ•° \\times æ¡¶å®¹é‡}$ ï¼Œä¹Ÿå°±æ˜¯è¯´ $\\frac{r}{n} \\gt 0.8 \\times æ¡¶æ•°$ ã€‚ å‡è®¾å†æ’å…¥ 0001ï¼Œç»è¿‡æ•£åˆ— $0001 \\mod 2^i=1$ ï¼Œæ‰€ä»¥æ’å…¥ Bucket 1ã€‚ åˆ¤æ–­æ˜¯å¦åˆ†è£‚ï¼Œ$\\frac{r}{n}=\\frac{5}{3}\u003c1.7$ æ‰€ä»¥ä¸åˆ†è£‚ã€‚Bucket 1 å…ƒç´ è¶…è¿‡ä¸Šé™ï¼Œä¸å¢åŠ æ–°æ¡¶æ‰€ä»¥ä½¿ç”¨æº¢å‡ºå—ã€‚ å¯æ‰©å±•æ•£åˆ—è¡¨æ²¡æœ‰æº¢å‡ºå—ï¼Œçº¿æ€§æ•£åˆ—è¡¨æœ‰å¯èƒ½æœ‰æº¢å‡ºå—ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#çº¿æ€§æ•£åˆ—è¡¨"},{"categories":null,"content":" å¤šç»´ç´¢å¼•ä¹‹å‰çš„ä¸»é”®ç´¢å¼•æˆ–è€…è¾…åŠ©ç´¢å¼•éƒ½åªèƒ½é’ˆå¯¹å•ä¸ª key è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœè¦å¯¹å¤šç»´æ•°æ®åŒ¹é…å°±éœ€è¦å¤šç»´ç´¢å¼•ã€‚ R-Tree åŸºäºç£ç›˜çš„ï¼šæ•°æ®å­˜å‚¨åœ¨ç£ç›˜,æ ¹æ®éœ€æ±‚å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­æ“ä½œ æ•°æ®åˆ†é¡µï¼šæ¯ä¸ªèŠ‚ç‚¹å ç”¨ç›¸åŒå¤§å°çš„ç£ç›˜ç©ºé—´ å¹³è¡¡çš„:æ‰€æœ‰å¶å­èŠ‚ç‚¹åˆ°è·ŸèŠ‚ç‚¹çš„è·ç¦»ç›¸åŒ åŠ¨æ€çš„:æ”¯æŒæ•°æ®æ’å…¥åˆ é™¤ å¶å­å­˜å‚¨æ•°æ®:ä¸­é—´èŠ‚ç‚¹ä»…æä¾›ç´¢å¼•,æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ åŠæ»¡çš„:æ‰€æœ‰èŠ‚ç‚¹è‡³å°‘æ˜¯åŠæ»¡çš„ R-Tree å°±æ˜¯äºŒç»´ç‰ˆæœ¬çš„ B-Treeã€‚ åˆ†æ®µæ•£åˆ—å‡½æ•° é‡‡ç”¨å°†æ•°æ®åˆ’åˆ†åˆ°æ¡¶ä¸­çš„æ–¹æ³•â€”â€”ç±»æ•£åˆ—æ–¹æ³• åˆ†æ®µæ•£åˆ—å¯ä»¥æ”¯æŒé«˜äº 2 ç»´çš„å¤šç»´æ•°æ® åˆ†æ®µæ•£åˆ—å¯ä»¥å°†æ•°æ®è¾ƒå‡åŒ€åœ°æ•£åˆ—åˆ°æ¡¶ä¸­ï¼Œç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ æ”¯æŒéƒ¨åˆ†åŒ¹é…æŸ¥è¯¢ ä¸é€‚åˆNNæŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢ï¼Œå› ä¸ºç”¨çš„æ˜¯æ•£åˆ—å‡½æ•°ï¼Œå­˜å‚¨ä¸é¡ºåºã€‚ å‘é‡ç´¢å¼• æ‰€æœ‰æ•°æ® Embedding æˆå‘é‡ï¼ŒæŸ¥è¯¢ä¹Ÿ Embedding æˆå‘é‡ åˆ©ç”¨å‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§è¿›è¡Œæ£€ç´¢ ä¸ä¼ ç»Ÿå¤šç»´ç´¢å¼•çš„åŒºåˆ« å…¨ç»´åŒ¹é…ï¼Œä¸€èˆ¬ä¸è€ƒè™‘éƒ¨åˆ†åŒ¹é…æŸ¥è¯¢ è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢(top-k ANN)ï¼Œä¸€èˆ¬ä¸è€ƒè™‘å‡†ç¡®åŒ¹é… ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å¤šç»´ç´¢å¼•"},{"categories":null,"content":" å¤šç»´ç´¢å¼•ä¹‹å‰çš„ä¸»é”®ç´¢å¼•æˆ–è€…è¾…åŠ©ç´¢å¼•éƒ½åªèƒ½é’ˆå¯¹å•ä¸ª key è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœè¦å¯¹å¤šç»´æ•°æ®åŒ¹é…å°±éœ€è¦å¤šç»´ç´¢å¼•ã€‚ R-Tree åŸºäºç£ç›˜çš„ï¼šæ•°æ®å­˜å‚¨åœ¨ç£ç›˜,æ ¹æ®éœ€æ±‚å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­æ“ä½œ æ•°æ®åˆ†é¡µï¼šæ¯ä¸ªèŠ‚ç‚¹å ç”¨ç›¸åŒå¤§å°çš„ç£ç›˜ç©ºé—´ å¹³è¡¡çš„:æ‰€æœ‰å¶å­èŠ‚ç‚¹åˆ°è·ŸèŠ‚ç‚¹çš„è·ç¦»ç›¸åŒ åŠ¨æ€çš„:æ”¯æŒæ•°æ®æ’å…¥åˆ é™¤ å¶å­å­˜å‚¨æ•°æ®:ä¸­é—´èŠ‚ç‚¹ä»…æä¾›ç´¢å¼•,æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ åŠæ»¡çš„:æ‰€æœ‰èŠ‚ç‚¹è‡³å°‘æ˜¯åŠæ»¡çš„ R-Tree å°±æ˜¯äºŒç»´ç‰ˆæœ¬çš„ B-Treeã€‚ åˆ†æ®µæ•£åˆ—å‡½æ•° é‡‡ç”¨å°†æ•°æ®åˆ’åˆ†åˆ°æ¡¶ä¸­çš„æ–¹æ³•â€”â€”ç±»æ•£åˆ—æ–¹æ³• åˆ†æ®µæ•£åˆ—å¯ä»¥æ”¯æŒé«˜äº 2 ç»´çš„å¤šç»´æ•°æ® åˆ†æ®µæ•£åˆ—å¯ä»¥å°†æ•°æ®è¾ƒå‡åŒ€åœ°æ•£åˆ—åˆ°æ¡¶ä¸­ï¼Œç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ æ”¯æŒéƒ¨åˆ†åŒ¹é…æŸ¥è¯¢ ä¸é€‚åˆNNæŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢ï¼Œå› ä¸ºç”¨çš„æ˜¯æ•£åˆ—å‡½æ•°ï¼Œå­˜å‚¨ä¸é¡ºåºã€‚ å‘é‡ç´¢å¼• æ‰€æœ‰æ•°æ® Embedding æˆå‘é‡ï¼ŒæŸ¥è¯¢ä¹Ÿ Embedding æˆå‘é‡ åˆ©ç”¨å‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§è¿›è¡Œæ£€ç´¢ ä¸ä¼ ç»Ÿå¤šç»´ç´¢å¼•çš„åŒºåˆ« å…¨ç»´åŒ¹é…ï¼Œä¸€èˆ¬ä¸è€ƒè™‘éƒ¨åˆ†åŒ¹é…æŸ¥è¯¢ è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢(top-k ANN)ï¼Œä¸€èˆ¬ä¸è€ƒè™‘å‡†ç¡®åŒ¹é… ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#r-tree"},{"categories":null,"content":" å¤šç»´ç´¢å¼•ä¹‹å‰çš„ä¸»é”®ç´¢å¼•æˆ–è€…è¾…åŠ©ç´¢å¼•éƒ½åªèƒ½é’ˆå¯¹å•ä¸ª key è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœè¦å¯¹å¤šç»´æ•°æ®åŒ¹é…å°±éœ€è¦å¤šç»´ç´¢å¼•ã€‚ R-Tree åŸºäºç£ç›˜çš„ï¼šæ•°æ®å­˜å‚¨åœ¨ç£ç›˜,æ ¹æ®éœ€æ±‚å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­æ“ä½œ æ•°æ®åˆ†é¡µï¼šæ¯ä¸ªèŠ‚ç‚¹å ç”¨ç›¸åŒå¤§å°çš„ç£ç›˜ç©ºé—´ å¹³è¡¡çš„:æ‰€æœ‰å¶å­èŠ‚ç‚¹åˆ°è·ŸèŠ‚ç‚¹çš„è·ç¦»ç›¸åŒ åŠ¨æ€çš„:æ”¯æŒæ•°æ®æ’å…¥åˆ é™¤ å¶å­å­˜å‚¨æ•°æ®:ä¸­é—´èŠ‚ç‚¹ä»…æä¾›ç´¢å¼•,æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ åŠæ»¡çš„:æ‰€æœ‰èŠ‚ç‚¹è‡³å°‘æ˜¯åŠæ»¡çš„ R-Tree å°±æ˜¯äºŒç»´ç‰ˆæœ¬çš„ B-Treeã€‚ åˆ†æ®µæ•£åˆ—å‡½æ•° é‡‡ç”¨å°†æ•°æ®åˆ’åˆ†åˆ°æ¡¶ä¸­çš„æ–¹æ³•â€”â€”ç±»æ•£åˆ—æ–¹æ³• åˆ†æ®µæ•£åˆ—å¯ä»¥æ”¯æŒé«˜äº 2 ç»´çš„å¤šç»´æ•°æ® åˆ†æ®µæ•£åˆ—å¯ä»¥å°†æ•°æ®è¾ƒå‡åŒ€åœ°æ•£åˆ—åˆ°æ¡¶ä¸­ï¼Œç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ æ”¯æŒéƒ¨åˆ†åŒ¹é…æŸ¥è¯¢ ä¸é€‚åˆNNæŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢ï¼Œå› ä¸ºç”¨çš„æ˜¯æ•£åˆ—å‡½æ•°ï¼Œå­˜å‚¨ä¸é¡ºåºã€‚ å‘é‡ç´¢å¼• æ‰€æœ‰æ•°æ® Embedding æˆå‘é‡ï¼ŒæŸ¥è¯¢ä¹Ÿ Embedding æˆå‘é‡ åˆ©ç”¨å‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§è¿›è¡Œæ£€ç´¢ ä¸ä¼ ç»Ÿå¤šç»´ç´¢å¼•çš„åŒºåˆ« å…¨ç»´åŒ¹é…ï¼Œä¸€èˆ¬ä¸è€ƒè™‘éƒ¨åˆ†åŒ¹é…æŸ¥è¯¢ è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢(top-k ANN)ï¼Œä¸€èˆ¬ä¸è€ƒè™‘å‡†ç¡®åŒ¹é… ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#åˆ†æ®µæ•£åˆ—å‡½æ•°"},{"categories":null,"content":" å¤šç»´ç´¢å¼•ä¹‹å‰çš„ä¸»é”®ç´¢å¼•æˆ–è€…è¾…åŠ©ç´¢å¼•éƒ½åªèƒ½é’ˆå¯¹å•ä¸ª key è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœè¦å¯¹å¤šç»´æ•°æ®åŒ¹é…å°±éœ€è¦å¤šç»´ç´¢å¼•ã€‚ R-Tree åŸºäºç£ç›˜çš„ï¼šæ•°æ®å­˜å‚¨åœ¨ç£ç›˜,æ ¹æ®éœ€æ±‚å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­æ“ä½œ æ•°æ®åˆ†é¡µï¼šæ¯ä¸ªèŠ‚ç‚¹å ç”¨ç›¸åŒå¤§å°çš„ç£ç›˜ç©ºé—´ å¹³è¡¡çš„:æ‰€æœ‰å¶å­èŠ‚ç‚¹åˆ°è·ŸèŠ‚ç‚¹çš„è·ç¦»ç›¸åŒ åŠ¨æ€çš„:æ”¯æŒæ•°æ®æ’å…¥åˆ é™¤ å¶å­å­˜å‚¨æ•°æ®:ä¸­é—´èŠ‚ç‚¹ä»…æä¾›ç´¢å¼•,æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ åŠæ»¡çš„:æ‰€æœ‰èŠ‚ç‚¹è‡³å°‘æ˜¯åŠæ»¡çš„ R-Tree å°±æ˜¯äºŒç»´ç‰ˆæœ¬çš„ B-Treeã€‚ åˆ†æ®µæ•£åˆ—å‡½æ•° é‡‡ç”¨å°†æ•°æ®åˆ’åˆ†åˆ°æ¡¶ä¸­çš„æ–¹æ³•â€”â€”ç±»æ•£åˆ—æ–¹æ³• åˆ†æ®µæ•£åˆ—å¯ä»¥æ”¯æŒé«˜äº 2 ç»´çš„å¤šç»´æ•°æ® åˆ†æ®µæ•£åˆ—å¯ä»¥å°†æ•°æ®è¾ƒå‡åŒ€åœ°æ•£åˆ—åˆ°æ¡¶ä¸­ï¼Œç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ æ”¯æŒéƒ¨åˆ†åŒ¹é…æŸ¥è¯¢ ä¸é€‚åˆNNæŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢ï¼Œå› ä¸ºç”¨çš„æ˜¯æ•£åˆ—å‡½æ•°ï¼Œå­˜å‚¨ä¸é¡ºåºã€‚ å‘é‡ç´¢å¼• æ‰€æœ‰æ•°æ® Embedding æˆå‘é‡ï¼ŒæŸ¥è¯¢ä¹Ÿ Embedding æˆå‘é‡ åˆ©ç”¨å‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§è¿›è¡Œæ£€ç´¢ ä¸ä¼ ç»Ÿå¤šç»´ç´¢å¼•çš„åŒºåˆ« å…¨ç»´åŒ¹é…ï¼Œä¸€èˆ¬ä¸è€ƒè™‘éƒ¨åˆ†åŒ¹é…æŸ¥è¯¢ è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢(top-k ANN)ï¼Œä¸€èˆ¬ä¸è€ƒè™‘å‡†ç¡®åŒ¹é… ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å‘é‡ç´¢å¼•"},{"categories":null,"content":" è¯¾åé¢˜ text 3.å‡è®¾æœ‰å¦‚ä¸‹çš„é”®å€¼ï¼Œç°ç”¨5ä½äºŒè¿›åˆ¶åºåˆ—æ¥è¡¨ç¤ºæ¯ä¸ªé”®å€¼çš„hashå€¼ã€‚å›ç­”é—®é¢˜ï¼š A[11001] B[00111] C[00101] D[00110] E[10100] F[01000] G[00011] H[11110] I[10001] J[01101] K[10101] L[11100] M[01100] N[11111] (1)å¦‚æœå°†ä¸Šè¿°é”®å€¼æŒ‰Aåˆ°Nçš„é¡ºåºæ’å…¥åˆ°å¯æ‰©å±•æ•£åˆ—ç´¢å¼•ä¸­ï¼Œè‹¥æ¯ä¸ªæ¡¶å¤§å°ä¸ºä¸€ä¸ªç£ç›˜å—ï¼Œæ¯ä¸ªç£ç›˜å—æœ€å¤šå¯å®¹çº³3ä¸ªé”®å€¼ï¼Œä¸”åˆå§‹æ—¶æ•£åˆ—ç´¢å¼•ä¸ºç©ºï¼Œåˆ™å…¨éƒ¨é”®å€¼æ’å…¥å®Œæˆåè¯¥æ•£åˆ—ç´¢å¼•ä¸­å…±æœ‰å‡ ä¸ªæ¡¶ï¼Ÿå¹¶è¯·å†™å‡ºé”®å€¼Eæ‰€åœ¨çš„æ¡¶ä¸­çš„å…¨éƒ¨é”®å€¼ã€‚ (2)å‰ä¸€é—®é¢˜ä¸­ï¼Œå¦‚æœæ¢æˆçº¿æ€§æ•£åˆ—ç´¢å¼•ï¼Œå…¶ä½™å‡è®¾ä¸å˜ï¼ŒåŒæ—¶å‡è®¾åªæœ‰å½“æ’å…¥æ–°é”®å€¼åç©ºé—´åˆ©ç”¨ç‡å¤§äº80%æ—¶æ‰å¢åŠ æ–°çš„æ¡¶ï¼Œåˆ™å…¨éƒ¨é”®å€¼æŒ‰åºæ’å…¥å®Œæˆåè¯¥æ•£åˆ—ç´¢å¼•ä¸­å…±æœ‰å‡ ä¸ªæ¡¶ï¼Ÿå¹¶è¯·å†™å‡ºé”®å€¼Bæ‰€åœ¨çš„æ¡¶ä¸­çš„å…¨éƒ¨é”®å€¼ï¼ˆåŒ…æ‹¬æº¢å‡ºå—ä¸­çš„é”®å€¼ï¼‰ã€‚ æ­¥éª¤ æ’å…¥é”® hash i p n æ’å…¥æ¡¶ å„æ¡¶å†…å®¹ï¼ˆä»…åˆ—éç©ºæ¡¶ï¼‰ Util è¯´æ˜ 0 åˆå§‹ â€“ 1 0 2 â€“ 0:âˆ… 1:âˆ… 0% åˆå§‹ 1 A 11001 1 0 2 1 1:A 16.7% â€“ 2 B 00111 1 0 2 1 1:A,B 33.3% â€“ 3 C 00101 1 0 2 1 1:A,B,C 50% â€“ 4 D 00110 1 0 2 0 0:D 66.7% â€“ 5 E 10100 1 0 2â†’3 0 0:E 1:A,B,C 2:D 83.3% åˆ†è£‚æ¡¶0 6 F 01000 1 1 3 0 0:E,F 66.7% â€“ 7 G 00011 1 1 3 1 1:A,B,C,G 77.8% â€“ 8 H 11110 1â†’2 1â†’0 3â†’4 0 0:E,F,H 1:A,C 2:D 3:B,G 88.9% åˆ†è£‚æ¡¶1ï¼Œå‡ä½ 9 I 10001 2 0 4 1 1:A,C,I 75% â€“ 10 J 01101 2 0 4â†’5 1 0:F 1:A,C,I,J 3:B,G 4:E,H 83.3% åˆ†è£‚æ¡¶0 11 K 10101 2 1 5 1 1:A,C,I,J,K 73.3% â€“ 12 L 11100 2 1 5 0 0:F,L 80% ä¸åˆ†è£‚ 13 M 01100 2 1 5â†’6 0 0:F,L,M 1:A,I 3:B,G 4:E,H 5:C,J,K 86.7% åˆ†è£‚æ¡¶1 14 N 11111 2 2 6 3 3:B,G,N 77.8% â€“ text è€ƒè™‘ä¸‹é¢çš„ç£ç›˜ B+ æ ‘(ä¸€ä¸ªèŠ‚ç‚¹æœ€å¤šå®¹çº³3ä¸ªé”®å€¼)ï¼Œå›ç­”é—®é¢˜: (1)è¯·å†™å‡ºæ‰§è¡ŒèŒƒå›´æŸ¥è¯¢[17,76]æ—¶ä¾æ¬¡è®¿é—®çš„èŠ‚ç‚¹åºåˆ—(èŠ‚ç‚¹ç”¨ N1ã€N2 è¡¨ç¤º); (2)æ’å…¥é”®å€¼ 37 åå“ªäº›èŠ‚ç‚¹ä¼šå—åˆ°å½±å“?è¯·ç”»å‡ºè¿™äº›å—å½±å“çš„èŠ‚ç‚¹æ‰€æ„æˆçš„å­æ ‘ç»“æ„; (3)å‡è®¾æ¯ä¸€ä¸ªå¶èŠ‚ç‚¹éƒ½å¢åŠ ä¸€ä¸ªæº¢å‡ºèŠ‚ç‚¹ï¼Œç”¨äºå®¹çº³æ–°æ’å…¥çš„é”®å€¼ã€‚è¯·ä»¥æ’å…¥é”®å€¼ 37 ä¸ºä¾‹ï¼Œåˆ†åˆ«è®¡ç®—æ— æº¢å‡ºèŠ‚ç‚¹ B+ æ ‘å’Œæœ‰æº¢å‡ºèŠ‚ç‚¹ B+ æ ‘çš„æ’å…¥ I/O æ¬¡æ•°ã€‚ N1,N2,N4,N5,N6,N7,N8,N9 N5,N2,N1 ä¼šå—åˆ°å½±å“ I/O æ— æº¢å‡ºèŠ‚ç‚¹ï¼šå–æ ¹èŠ‚ç‚¹ N1ï¼Œå– N2ï¼Œå†…å­˜ä¸­äºŒåˆ†æŸ¥æ‰¾åå– N5ï¼Œç„¶åæŠŠ N1,N2,N5,N11(N5 åˆ†è£‚),N12(N2 åˆ†è£‚) å†™å›ç£ç›˜ï¼Œä¸€å…± 8 æ¬¡ã€‚ æœ‰æº¢å‡ºèŠ‚ç‚¹ï¼šå–æ ¹èŠ‚ç‚¹ N1ï¼Œå– N2ï¼Œå†…å­˜ä¸­äºŒåˆ†æŸ¥æ‰¾åå– N5ï¼Œå†™å› N5ï¼Œå†™ N5 çš„æº¢å‡ºèŠ‚ç‚¹ï¼Œä¸€å…± 5 æ¬¡ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:5:5","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è¯¾åé¢˜-2"},{"categories":null,"content":" ç¬¬å…­ç«  æŸ¥è¯¢ä¼˜åŒ–é‡ç‚¹ï¼šæŸ¥è¯¢å·¥ä½œæµç¨‹ã€ä¸­é—´ç»“æœå¤§å°ä¼°è®¡ã€ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:6:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¬¬å…­ç« -æŸ¥è¯¢ä¼˜åŒ–"},{"categories":null,"content":" æŸ¥è¯¢å¤„ç†å…¨æµç¨‹ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:6:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æŸ¥è¯¢å¤„ç†å…¨æµç¨‹"},{"categories":null,"content":" è¯­æ³•åˆ†æ æŠŠ SQL è¯­å¥æ„é€ ä¸ºè¯­æ³•åˆ†ææ ‘ï¼Œäº†è§£å³å¯ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:6:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è¯­æ³•åˆ†æ"},{"categories":null,"content":" ç”Ÿæˆåˆå§‹é€»è¾‘æŸ¥è¯¢è®¡åˆ’ä¾‹ä¸€ï¼š sql SELECT sname, age FROM Student S, Enroll E WHERE S.sid = E.sid AND E.grade \u003e 80; text Ï€_{sname, age} ( Ïƒ_{S.sid = E.sid âˆ§ grade \u003e 80} ( Student Ã— Enroll ) ) ä¾‹äºŒï¼š sql SELECT title FROM StarsIn WHERE starName IN ( SELECT name FROM MovieStar WHERE birthdate LIKE '%1960' ); text Ï€_title ( Ïƒ_{starName âˆˆ (Ï€_name (Ïƒ_{birthdate LIKE '%1960'}(MovieStar)))} (StarsIn) ) ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:6:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç”Ÿæˆåˆå§‹é€»è¾‘æŸ¥è¯¢è®¡åˆ’"},{"categories":null,"content":" æŸ¥è¯¢é‡å†™ text R S T A B A C C D 10 20 10 20 20 20 20 30 20 30 10 30 30 40 30 40 10 40 (Râ‹ˆS)â‹ˆTï¼šä¸­é—´ç»“æœ Râ‹ˆS äº§ç”Ÿ3æ¡è®°å½• Râ‹ˆ(Sâ‹ˆT)ï¼šä¸­é—´ç»“æœ Sâ‹ˆT äº§ç”Ÿ1æ¡è®°å½• ä»è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œåˆé€‚çš„é‡å†™å¯ä»¥å‡å°‘æŸ¥è¯¢æ‰§è¡Œæ—¶çš„ä¸­é—´å…³ç³»å¤§å°ï¼ˆå…ƒç»„æ•°ï¼‰ã€å‡å°‘å…ƒç»„çš„å¤§å°ï¼Œæœ€ç»ˆå‡å°æŸ¥è¯¢çš„å¼€é”€(I/O æ¬¡æ•°)ã€‚ å°±æ˜¯åŠ¨æ€è§„åˆ’é‡Œé¢çš„ä¹˜æ³•é“¾é—®é¢˜ Ã—å’Œâ‹ˆåŒºåˆ« å‡è®¾ä¸¤ä¸ªç®€å•è¡¨ï¼š sid sname 1 Alice sid grade 1 90 3 85 R Ã— Sï¼ˆç¬›å¡å°”ç§¯ï¼‰ï¼šæ— æ¡ä»¶ï¼Œå…¨ç»„åˆï¼Œå…± 2 Ã— 3 = 6 è¡Œã€‚ R.sid sname S.sid grade 1 Alice 1 90 1 Alice 3 85 2 Bob 1 90 2 Bob 3 85 R â‹ˆ Sï¼šå…ˆéšå¼åšç¬›å¡å°”ç§¯ï¼Œå†è¿‡æ»¤ R.sid = S.sid sid sname grade 1 Alice 90 è²Œä¼¼ä¸è€ƒï¼Œåšç®€å•äº†è§£ï¼Œå…·ä½“å¦‚ä½•è½¬æ¢ä¸çœ‹äº†ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:6:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æŸ¥è¯¢é‡å†™"},{"categories":null,"content":" ä»£ä»·ä¼°è®¡ ä¸­é—´ç»“æœå¤§å°ä¼°è®¡ $T(R)$ï¼šR çš„å…ƒç»„æ•° $S(R)$ï¼šR ä¸­æ¯ä¸ªå…ƒç»„çš„å¤§å°(bytes) $V(R, A)$ï¼šR çš„å±æ€§ A ä¸Šçš„ä¸åŒå€¼æ•° $B(R)$ï¼šå®¹çº³ R æ‰€æœ‰å…ƒç»„æ‰€éœ€çš„å—æ•° è®¡ç®—ä¸­é—´ç»“æœçš„å¤§å°ï¼Œæˆ‘ä»¬éœ€è¦ å…ƒç»„æ•° * æ¯ä¸ªå…ƒç¥–å¤§å°ï¼Œå³ $T(R)$ å’Œ $S(R)$ã€‚ å¯¹äºç¬›å¡å°”ç§¯ $W= R_1 \\times R_2$ $T(W) = T(R_1) * T(R_2)$ $S(W) = S(R_1) + S(R_2)$ å¯¹äºé€‰æ‹©æ“ä½œ $W=\\sigma_p(R)$ $S(W) = S(R)$ $T(W)$ å¯¹äºç­‰å€¼æŸ¥è¯¢æ“ä½œ $p:{A=a}$ ä¸å¥½ä¼°è®¡ï¼Œå‡å¦‚åˆ— A ä¸Šçš„ä¸åŒå€¼å‡åŒ€åˆ†å¸ƒå°±æœ‰ $T(W)=\\frac{T(R)}{V(R,A)}$ ï¼ˆæ¢å¥è¯è¯´ï¼Œå‡å¦‚ R æœ‰ 10000è¡Œï¼Œ $V(R,A)=100$ ï¼Œå‡åŒ€åˆ†å¸ƒçš„è¯æ¯ä¸ªå€¼å‡ºç° 100 æ¬¡ã€‚ï¼‰ å¯¹äºåŒºé—´é€‰æ‹©æ“ä½œ $p:{A\u003ea}$ï¼Œä¸‰ç§æ–¹æ³•ï¼š$T(W)=\\frac{T(R)}{2}$ æˆ– $T(W)=\\frac{T(R)}{3}$ æˆ– $T(W)=\\frac{\\text{é€‰æ‹©å…ƒç´ }}{\\text{åŒºé—´èŒƒå›´}} \\times T(R)$ å¯¹äºä¸ç­‰å€¼æŸ¥è¯¢æ“ä½œ $p: {A \\neq a}$ ï¼Œ$T(W)=T(R) - \\frac{T(R)}{V(R,A)}$ å¯¹äºé€‰æ‹©æ“ä½œçš„ T(W) å…¬å¼ï¼Œæ ¹æœ¬ä¸Šæ˜¯ $T(W)=T(R)Ã—P(w)$ ï¼Œä¾‹å¦‚åœ¨ç­‰å€¼æŸ¥è¯¢æ—¶å€™ï¼Œå‡è®¾å‡åŒ€åˆ†å¸ƒï¼Œ$A=a$ çš„æ¦‚ç‡å°±æ˜¯ $\\frac{1}{V(R,A)}$ã€‚åœ¨è¿™ä¸ªåŸºç¡€ä¸Šæˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°ï¼Œå¸¦æœ‰ AND å’Œ OR çš„é€‰æ‹©æ“ä½œè¯¥æ€ä¹ˆè®¡ç®—ï¼š å¯¹äº $W = \\sigma_{p_1 \\land p_2}(R)$ï¼Œ p1 å’Œ p2 æ˜¯ A å’Œ B çš„ç­‰å€¼é€‰æ‹©ï¼Œæˆ‘ä»¬æœ‰ $T(W)=T(R)Ã—P(p1_â€‹)Ã—P(p_2â€‹)=\\frac{R}{V(R,A) \\times V(R, B)}$ å¯¹äº $W = \\sigma_{p_1 \\lor p_2}(R)$ï¼Œp1 å’Œ p2 æ˜¯ A å’Œ B çš„ç­‰å€¼é€‰æ‹©ï¼Œæˆ‘ä»¬æœ‰ $T(W)=T(R)Ã—(P(p_1â€‹)+P(p_2â€‹)âˆ’P(p_1â€‹)Ã—P(p_2â€‹))$ å¯¹äºè¿æ¥æ“ä½œ $W=R_1(A,B,C) \\Join R_2(A,D)$ $S(W) = S(R_1) + S(R_2) - S(A)$ $T(W)=\\frac{T(R_1) \\times T(R_2)}{\\max{(V(R_1,A), V(R_2,A))}}$ $V(W,*)$ $V(W,B)=V(R_1,B)$ $V(W,C)=V(R_1,C)$ $V(W,D)=V(R_2,D)$ $V(W,A)=\\min (V(R_1,A),V(R_2,A))$ å¯¹äºè¿æ¥æ“ä½œï¼Œå‡å¦‚å‡ºç°å¤šä¸ªå…³è”é”®ï¼Œä¾‹å¦‚ $W=R_1(A,B,C) \\Join R_2(A,B,D)$ $S(W) = S(R_1) + S(R_2) - S(A) - S(B)$ $T(W)=\\frac{T(R_1) \\times T(R_2)}{\\max{(V(R_1,A), V(R_2,A))} \\times \\max{(V(R_1,B), V(R_2,B))}}$ ä¸Šé¢å…¬å¼æ˜¯åŸºäºä¸‹é¢çš„å‡è®¾ï¼š $V(R_1,A) \\lt V(R_2,A)$ â‡’ R1.A ä¸Šçš„å€¼éƒ½åœ¨ R2 ä¸­ $V(R_2,A) \\lt V(R_1,A)$ â‡’ R2.A ä¸Šçš„å€¼éƒ½åœ¨ R1 ä¸­ å¯¹äº $R_1$ è€Œè¨€ï¼ŒA å‡ºç°åœ¨ $R_2$ çš„é¢„æœŸè¡Œæ•°ä¸º $\\frac{T(R_2)}{V(R_2, A)}$ ï¼Œå¯¹äº $R_2$ è€Œè¨€åŒç†ã€‚å‡å¦‚ $V(R_1,A) \\lt V(R_2,A)$ï¼ŒR2.A å¾ˆå¤šå€¼ä¸åœ¨ R1ï¼Œå¦‚æœç”¨ $T(R_2) * \\frac{T(R_1)}{V(R_1, A)}$ ä¸å‡†ã€‚ I/O ä»£ä»·ä¼°è®¡ ä¼°è®¡ç›®æ ‡ï¼šæŸ¥è¯¢è®¡åˆ’æ‰€å¿…é¡»è¯»ï¼ˆå†™ï¼‰çš„ç£ç›˜å—æ•°ç›® å½±å“æŸ¥è¯¢è®¡åˆ’ I/O ä»£ä»·çš„å› ç´ ï¼š å®ç°æŸ¥è¯¢è®¡åˆ’çš„é€»è¾‘æ“ä½œç¬¦ ä¸­é—´ç»“æœçš„å¤§å° å®ç°é€»è¾‘æ“ä½œç¬¦çš„ç‰©ç†æ“ä½œ e.g. è¿æ¥æ“ä½œæ˜¯ç”¨ç´¢å¼•è¿æ¥è¿˜æ˜¯æ•£åˆ—è¿æ¥ï¼Ÿ ç›¸ä¼¼æ“ä½œçš„é¡ºåº e.g. å¤šå…³ç³»çš„è¿æ¥é¡ºåº ç‰©ç†æ“ä½œç¬¦ä¹‹é—´çš„å‚æ•°ä¼ é€’æ–¹å¼ï¼ˆæµæ°´çº¿è¿˜æ˜¯ç‰©åŒ–ï¼Ÿï¼‰ ç‰©ç†æ“ä½œç¬¦çš„å‚æ•°ä¼ é€’æ–¹å¼ï¼š æµæ°´çº¿ï¼šå¤šä¸ªæ“ä½œåŒæ—¶æ‰§è¡Œï¼Œä¸€ä¸ªæ“ä½œäº§ç”Ÿçš„å…ƒç»„ç›´æ¥é€šè¿‡å…±äº«å†…å­˜ä¼ é€’ç»™å…¶ä»–æ“ä½œ èŠ‚çœ I/O å ç”¨ä¸»å­˜ï¼Œè‹¥ç¼“å†²åŒºå‡ºç°â€œé¢ ç°¸â€åˆ™ I/O å¢åŠ  ç‰©åŒ–ï¼šæ“ä½œä¾æ¬¡æ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸ªæ“ä½œçš„ç»“æœï¼ˆä¸­é—´å…³ç³»ï¼‰éƒ½å†™åˆ°ç£ç›˜ä¸Šä¾›å…¶ä»–æ“ä½œå­˜å– é€šè¿‡ç£ç›˜ç‰©ç†è¿›è¡Œæ•°æ®ä¼ é€’ èŠ‚çœä¸»å­˜ç©ºé—´ æ„Ÿè§‰ä¸è€ƒï¼Œè®°ä¸€è®°ä»¥é˜²é€‰æ‹©åˆ¤æ–­é¢˜è€ƒã€‚ ç‰©ç†æŸ¥è¯¢è®¡åˆ’ç”Ÿæˆ åº”è¯¥ä¸è€ƒ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:6:5","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ä»£ä»·ä¼°è®¡"},{"categories":null,"content":" ä»£ä»·ä¼°è®¡ ä¸­é—´ç»“æœå¤§å°ä¼°è®¡ $T(R)$ï¼šR çš„å…ƒç»„æ•° $S(R)$ï¼šR ä¸­æ¯ä¸ªå…ƒç»„çš„å¤§å°(bytes) $V(R, A)$ï¼šR çš„å±æ€§ A ä¸Šçš„ä¸åŒå€¼æ•° $B(R)$ï¼šå®¹çº³ R æ‰€æœ‰å…ƒç»„æ‰€éœ€çš„å—æ•° è®¡ç®—ä¸­é—´ç»“æœçš„å¤§å°ï¼Œæˆ‘ä»¬éœ€è¦ å…ƒç»„æ•° * æ¯ä¸ªå…ƒç¥–å¤§å°ï¼Œå³ $T(R)$ å’Œ $S(R)$ã€‚ å¯¹äºç¬›å¡å°”ç§¯ $W= R_1 \\times R_2$ $T(W) = T(R_1) * T(R_2)$ $S(W) = S(R_1) + S(R_2)$ å¯¹äºé€‰æ‹©æ“ä½œ $W=\\sigma_p(R)$ $S(W) = S(R)$ $T(W)$ å¯¹äºç­‰å€¼æŸ¥è¯¢æ“ä½œ $p:{A=a}$ ä¸å¥½ä¼°è®¡ï¼Œå‡å¦‚åˆ— A ä¸Šçš„ä¸åŒå€¼å‡åŒ€åˆ†å¸ƒå°±æœ‰ $T(W)=\\frac{T(R)}{V(R,A)}$ ï¼ˆæ¢å¥è¯è¯´ï¼Œå‡å¦‚ R æœ‰ 10000è¡Œï¼Œ $V(R,A)=100$ ï¼Œå‡åŒ€åˆ†å¸ƒçš„è¯æ¯ä¸ªå€¼å‡ºç° 100 æ¬¡ã€‚ï¼‰ å¯¹äºåŒºé—´é€‰æ‹©æ“ä½œ $p:{A\u003ea}$ï¼Œä¸‰ç§æ–¹æ³•ï¼š$T(W)=\\frac{T(R)}{2}$ æˆ– $T(W)=\\frac{T(R)}{3}$ æˆ– $T(W)=\\frac{\\text{é€‰æ‹©å…ƒç´ }}{\\text{åŒºé—´èŒƒå›´}} \\times T(R)$ å¯¹äºä¸ç­‰å€¼æŸ¥è¯¢æ“ä½œ $p: {A \\neq a}$ ï¼Œ$T(W)=T(R) - \\frac{T(R)}{V(R,A)}$ å¯¹äºé€‰æ‹©æ“ä½œçš„ T(W) å…¬å¼ï¼Œæ ¹æœ¬ä¸Šæ˜¯ $T(W)=T(R)Ã—P(w)$ ï¼Œä¾‹å¦‚åœ¨ç­‰å€¼æŸ¥è¯¢æ—¶å€™ï¼Œå‡è®¾å‡åŒ€åˆ†å¸ƒï¼Œ$A=a$ çš„æ¦‚ç‡å°±æ˜¯ $\\frac{1}{V(R,A)}$ã€‚åœ¨è¿™ä¸ªåŸºç¡€ä¸Šæˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°ï¼Œå¸¦æœ‰ AND å’Œ OR çš„é€‰æ‹©æ“ä½œè¯¥æ€ä¹ˆè®¡ç®—ï¼š å¯¹äº $W = \\sigma_{p_1 \\land p_2}(R)$ï¼Œ p1 å’Œ p2 æ˜¯ A å’Œ B çš„ç­‰å€¼é€‰æ‹©ï¼Œæˆ‘ä»¬æœ‰ $T(W)=T(R)Ã—P(p1_â€‹)Ã—P(p_2â€‹)=\\frac{R}{V(R,A) \\times V(R, B)}$ å¯¹äº $W = \\sigma_{p_1 \\lor p_2}(R)$ï¼Œp1 å’Œ p2 æ˜¯ A å’Œ B çš„ç­‰å€¼é€‰æ‹©ï¼Œæˆ‘ä»¬æœ‰ $T(W)=T(R)Ã—(P(p_1â€‹)+P(p_2â€‹)âˆ’P(p_1â€‹)Ã—P(p_2â€‹))$ å¯¹äºè¿æ¥æ“ä½œ $W=R_1(A,B,C) \\Join R_2(A,D)$ $S(W) = S(R_1) + S(R_2) - S(A)$ $T(W)=\\frac{T(R_1) \\times T(R_2)}{\\max{(V(R_1,A), V(R_2,A))}}$ $V(W,*)$ $V(W,B)=V(R_1,B)$ $V(W,C)=V(R_1,C)$ $V(W,D)=V(R_2,D)$ $V(W,A)=\\min (V(R_1,A),V(R_2,A))$ å¯¹äºè¿æ¥æ“ä½œï¼Œå‡å¦‚å‡ºç°å¤šä¸ªå…³è”é”®ï¼Œä¾‹å¦‚ $W=R_1(A,B,C) \\Join R_2(A,B,D)$ $S(W) = S(R_1) + S(R_2) - S(A) - S(B)$ $T(W)=\\frac{T(R_1) \\times T(R_2)}{\\max{(V(R_1,A), V(R_2,A))} \\times \\max{(V(R_1,B), V(R_2,B))}}$ ä¸Šé¢å…¬å¼æ˜¯åŸºäºä¸‹é¢çš„å‡è®¾ï¼š $V(R_1,A) \\lt V(R_2,A)$ â‡’ R1.A ä¸Šçš„å€¼éƒ½åœ¨ R2 ä¸­ $V(R_2,A) \\lt V(R_1,A)$ â‡’ R2.A ä¸Šçš„å€¼éƒ½åœ¨ R1 ä¸­ å¯¹äº $R_1$ è€Œè¨€ï¼ŒA å‡ºç°åœ¨ $R_2$ çš„é¢„æœŸè¡Œæ•°ä¸º $\\frac{T(R_2)}{V(R_2, A)}$ ï¼Œå¯¹äº $R_2$ è€Œè¨€åŒç†ã€‚å‡å¦‚ $V(R_1,A) \\lt V(R_2,A)$ï¼ŒR2.A å¾ˆå¤šå€¼ä¸åœ¨ R1ï¼Œå¦‚æœç”¨ $T(R_2) * \\frac{T(R_1)}{V(R_1, A)}$ ä¸å‡†ã€‚ I/O ä»£ä»·ä¼°è®¡ ä¼°è®¡ç›®æ ‡ï¼šæŸ¥è¯¢è®¡åˆ’æ‰€å¿…é¡»è¯»ï¼ˆå†™ï¼‰çš„ç£ç›˜å—æ•°ç›® å½±å“æŸ¥è¯¢è®¡åˆ’ I/O ä»£ä»·çš„å› ç´ ï¼š å®ç°æŸ¥è¯¢è®¡åˆ’çš„é€»è¾‘æ“ä½œç¬¦ ä¸­é—´ç»“æœçš„å¤§å° å®ç°é€»è¾‘æ“ä½œç¬¦çš„ç‰©ç†æ“ä½œ e.g. è¿æ¥æ“ä½œæ˜¯ç”¨ç´¢å¼•è¿æ¥è¿˜æ˜¯æ•£åˆ—è¿æ¥ï¼Ÿ ç›¸ä¼¼æ“ä½œçš„é¡ºåº e.g. å¤šå…³ç³»çš„è¿æ¥é¡ºåº ç‰©ç†æ“ä½œç¬¦ä¹‹é—´çš„å‚æ•°ä¼ é€’æ–¹å¼ï¼ˆæµæ°´çº¿è¿˜æ˜¯ç‰©åŒ–ï¼Ÿï¼‰ ç‰©ç†æ“ä½œç¬¦çš„å‚æ•°ä¼ é€’æ–¹å¼ï¼š æµæ°´çº¿ï¼šå¤šä¸ªæ“ä½œåŒæ—¶æ‰§è¡Œï¼Œä¸€ä¸ªæ“ä½œäº§ç”Ÿçš„å…ƒç»„ç›´æ¥é€šè¿‡å…±äº«å†…å­˜ä¼ é€’ç»™å…¶ä»–æ“ä½œ èŠ‚çœ I/O å ç”¨ä¸»å­˜ï¼Œè‹¥ç¼“å†²åŒºå‡ºç°â€œé¢ ç°¸â€åˆ™ I/O å¢åŠ  ç‰©åŒ–ï¼šæ“ä½œä¾æ¬¡æ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸ªæ“ä½œçš„ç»“æœï¼ˆä¸­é—´å…³ç³»ï¼‰éƒ½å†™åˆ°ç£ç›˜ä¸Šä¾›å…¶ä»–æ“ä½œå­˜å– é€šè¿‡ç£ç›˜ç‰©ç†è¿›è¡Œæ•°æ®ä¼ é€’ èŠ‚çœä¸»å­˜ç©ºé—´ æ„Ÿè§‰ä¸è€ƒï¼Œè®°ä¸€è®°ä»¥é˜²é€‰æ‹©åˆ¤æ–­é¢˜è€ƒã€‚ ç‰©ç†æŸ¥è¯¢è®¡åˆ’ç”Ÿæˆ åº”è¯¥ä¸è€ƒ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:6:5","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ä¸­é—´ç»“æœå¤§å°ä¼°è®¡"},{"categories":null,"content":" ä»£ä»·ä¼°è®¡ ä¸­é—´ç»“æœå¤§å°ä¼°è®¡ $T(R)$ï¼šR çš„å…ƒç»„æ•° $S(R)$ï¼šR ä¸­æ¯ä¸ªå…ƒç»„çš„å¤§å°(bytes) $V(R, A)$ï¼šR çš„å±æ€§ A ä¸Šçš„ä¸åŒå€¼æ•° $B(R)$ï¼šå®¹çº³ R æ‰€æœ‰å…ƒç»„æ‰€éœ€çš„å—æ•° è®¡ç®—ä¸­é—´ç»“æœçš„å¤§å°ï¼Œæˆ‘ä»¬éœ€è¦ å…ƒç»„æ•° * æ¯ä¸ªå…ƒç¥–å¤§å°ï¼Œå³ $T(R)$ å’Œ $S(R)$ã€‚ å¯¹äºç¬›å¡å°”ç§¯ $W= R_1 \\times R_2$ $T(W) = T(R_1) * T(R_2)$ $S(W) = S(R_1) + S(R_2)$ å¯¹äºé€‰æ‹©æ“ä½œ $W=\\sigma_p(R)$ $S(W) = S(R)$ $T(W)$ å¯¹äºç­‰å€¼æŸ¥è¯¢æ“ä½œ $p:{A=a}$ ä¸å¥½ä¼°è®¡ï¼Œå‡å¦‚åˆ— A ä¸Šçš„ä¸åŒå€¼å‡åŒ€åˆ†å¸ƒå°±æœ‰ $T(W)=\\frac{T(R)}{V(R,A)}$ ï¼ˆæ¢å¥è¯è¯´ï¼Œå‡å¦‚ R æœ‰ 10000è¡Œï¼Œ $V(R,A)=100$ ï¼Œå‡åŒ€åˆ†å¸ƒçš„è¯æ¯ä¸ªå€¼å‡ºç° 100 æ¬¡ã€‚ï¼‰ å¯¹äºåŒºé—´é€‰æ‹©æ“ä½œ $p:{A\u003ea}$ï¼Œä¸‰ç§æ–¹æ³•ï¼š$T(W)=\\frac{T(R)}{2}$ æˆ– $T(W)=\\frac{T(R)}{3}$ æˆ– $T(W)=\\frac{\\text{é€‰æ‹©å…ƒç´ }}{\\text{åŒºé—´èŒƒå›´}} \\times T(R)$ å¯¹äºä¸ç­‰å€¼æŸ¥è¯¢æ“ä½œ $p: {A \\neq a}$ ï¼Œ$T(W)=T(R) - \\frac{T(R)}{V(R,A)}$ å¯¹äºé€‰æ‹©æ“ä½œçš„ T(W) å…¬å¼ï¼Œæ ¹æœ¬ä¸Šæ˜¯ $T(W)=T(R)Ã—P(w)$ ï¼Œä¾‹å¦‚åœ¨ç­‰å€¼æŸ¥è¯¢æ—¶å€™ï¼Œå‡è®¾å‡åŒ€åˆ†å¸ƒï¼Œ$A=a$ çš„æ¦‚ç‡å°±æ˜¯ $\\frac{1}{V(R,A)}$ã€‚åœ¨è¿™ä¸ªåŸºç¡€ä¸Šæˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°ï¼Œå¸¦æœ‰ AND å’Œ OR çš„é€‰æ‹©æ“ä½œè¯¥æ€ä¹ˆè®¡ç®—ï¼š å¯¹äº $W = \\sigma_{p_1 \\land p_2}(R)$ï¼Œ p1 å’Œ p2 æ˜¯ A å’Œ B çš„ç­‰å€¼é€‰æ‹©ï¼Œæˆ‘ä»¬æœ‰ $T(W)=T(R)Ã—P(p1_â€‹)Ã—P(p_2â€‹)=\\frac{R}{V(R,A) \\times V(R, B)}$ å¯¹äº $W = \\sigma_{p_1 \\lor p_2}(R)$ï¼Œp1 å’Œ p2 æ˜¯ A å’Œ B çš„ç­‰å€¼é€‰æ‹©ï¼Œæˆ‘ä»¬æœ‰ $T(W)=T(R)Ã—(P(p_1â€‹)+P(p_2â€‹)âˆ’P(p_1â€‹)Ã—P(p_2â€‹))$ å¯¹äºè¿æ¥æ“ä½œ $W=R_1(A,B,C) \\Join R_2(A,D)$ $S(W) = S(R_1) + S(R_2) - S(A)$ $T(W)=\\frac{T(R_1) \\times T(R_2)}{\\max{(V(R_1,A), V(R_2,A))}}$ $V(W,*)$ $V(W,B)=V(R_1,B)$ $V(W,C)=V(R_1,C)$ $V(W,D)=V(R_2,D)$ $V(W,A)=\\min (V(R_1,A),V(R_2,A))$ å¯¹äºè¿æ¥æ“ä½œï¼Œå‡å¦‚å‡ºç°å¤šä¸ªå…³è”é”®ï¼Œä¾‹å¦‚ $W=R_1(A,B,C) \\Join R_2(A,B,D)$ $S(W) = S(R_1) + S(R_2) - S(A) - S(B)$ $T(W)=\\frac{T(R_1) \\times T(R_2)}{\\max{(V(R_1,A), V(R_2,A))} \\times \\max{(V(R_1,B), V(R_2,B))}}$ ä¸Šé¢å…¬å¼æ˜¯åŸºäºä¸‹é¢çš„å‡è®¾ï¼š $V(R_1,A) \\lt V(R_2,A)$ â‡’ R1.A ä¸Šçš„å€¼éƒ½åœ¨ R2 ä¸­ $V(R_2,A) \\lt V(R_1,A)$ â‡’ R2.A ä¸Šçš„å€¼éƒ½åœ¨ R1 ä¸­ å¯¹äº $R_1$ è€Œè¨€ï¼ŒA å‡ºç°åœ¨ $R_2$ çš„é¢„æœŸè¡Œæ•°ä¸º $\\frac{T(R_2)}{V(R_2, A)}$ ï¼Œå¯¹äº $R_2$ è€Œè¨€åŒç†ã€‚å‡å¦‚ $V(R_1,A) \\lt V(R_2,A)$ï¼ŒR2.A å¾ˆå¤šå€¼ä¸åœ¨ R1ï¼Œå¦‚æœç”¨ $T(R_2) * \\frac{T(R_1)}{V(R_1, A)}$ ä¸å‡†ã€‚ I/O ä»£ä»·ä¼°è®¡ ä¼°è®¡ç›®æ ‡ï¼šæŸ¥è¯¢è®¡åˆ’æ‰€å¿…é¡»è¯»ï¼ˆå†™ï¼‰çš„ç£ç›˜å—æ•°ç›® å½±å“æŸ¥è¯¢è®¡åˆ’ I/O ä»£ä»·çš„å› ç´ ï¼š å®ç°æŸ¥è¯¢è®¡åˆ’çš„é€»è¾‘æ“ä½œç¬¦ ä¸­é—´ç»“æœçš„å¤§å° å®ç°é€»è¾‘æ“ä½œç¬¦çš„ç‰©ç†æ“ä½œ e.g. è¿æ¥æ“ä½œæ˜¯ç”¨ç´¢å¼•è¿æ¥è¿˜æ˜¯æ•£åˆ—è¿æ¥ï¼Ÿ ç›¸ä¼¼æ“ä½œçš„é¡ºåº e.g. å¤šå…³ç³»çš„è¿æ¥é¡ºåº ç‰©ç†æ“ä½œç¬¦ä¹‹é—´çš„å‚æ•°ä¼ é€’æ–¹å¼ï¼ˆæµæ°´çº¿è¿˜æ˜¯ç‰©åŒ–ï¼Ÿï¼‰ ç‰©ç†æ“ä½œç¬¦çš„å‚æ•°ä¼ é€’æ–¹å¼ï¼š æµæ°´çº¿ï¼šå¤šä¸ªæ“ä½œåŒæ—¶æ‰§è¡Œï¼Œä¸€ä¸ªæ“ä½œäº§ç”Ÿçš„å…ƒç»„ç›´æ¥é€šè¿‡å…±äº«å†…å­˜ä¼ é€’ç»™å…¶ä»–æ“ä½œ èŠ‚çœ I/O å ç”¨ä¸»å­˜ï¼Œè‹¥ç¼“å†²åŒºå‡ºç°â€œé¢ ç°¸â€åˆ™ I/O å¢åŠ  ç‰©åŒ–ï¼šæ“ä½œä¾æ¬¡æ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸ªæ“ä½œçš„ç»“æœï¼ˆä¸­é—´å…³ç³»ï¼‰éƒ½å†™åˆ°ç£ç›˜ä¸Šä¾›å…¶ä»–æ“ä½œå­˜å– é€šè¿‡ç£ç›˜ç‰©ç†è¿›è¡Œæ•°æ®ä¼ é€’ èŠ‚çœä¸»å­˜ç©ºé—´ æ„Ÿè§‰ä¸è€ƒï¼Œè®°ä¸€è®°ä»¥é˜²é€‰æ‹©åˆ¤æ–­é¢˜è€ƒã€‚ ç‰©ç†æŸ¥è¯¢è®¡åˆ’ç”Ÿæˆ åº”è¯¥ä¸è€ƒ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:6:5","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#io-ä»£ä»·ä¼°è®¡"},{"categories":null,"content":" ä»£ä»·ä¼°è®¡ ä¸­é—´ç»“æœå¤§å°ä¼°è®¡ $T(R)$ï¼šR çš„å…ƒç»„æ•° $S(R)$ï¼šR ä¸­æ¯ä¸ªå…ƒç»„çš„å¤§å°(bytes) $V(R, A)$ï¼šR çš„å±æ€§ A ä¸Šçš„ä¸åŒå€¼æ•° $B(R)$ï¼šå®¹çº³ R æ‰€æœ‰å…ƒç»„æ‰€éœ€çš„å—æ•° è®¡ç®—ä¸­é—´ç»“æœçš„å¤§å°ï¼Œæˆ‘ä»¬éœ€è¦ å…ƒç»„æ•° * æ¯ä¸ªå…ƒç¥–å¤§å°ï¼Œå³ $T(R)$ å’Œ $S(R)$ã€‚ å¯¹äºç¬›å¡å°”ç§¯ $W= R_1 \\times R_2$ $T(W) = T(R_1) * T(R_2)$ $S(W) = S(R_1) + S(R_2)$ å¯¹äºé€‰æ‹©æ“ä½œ $W=\\sigma_p(R)$ $S(W) = S(R)$ $T(W)$ å¯¹äºç­‰å€¼æŸ¥è¯¢æ“ä½œ $p:{A=a}$ ä¸å¥½ä¼°è®¡ï¼Œå‡å¦‚åˆ— A ä¸Šçš„ä¸åŒå€¼å‡åŒ€åˆ†å¸ƒå°±æœ‰ $T(W)=\\frac{T(R)}{V(R,A)}$ ï¼ˆæ¢å¥è¯è¯´ï¼Œå‡å¦‚ R æœ‰ 10000è¡Œï¼Œ $V(R,A)=100$ ï¼Œå‡åŒ€åˆ†å¸ƒçš„è¯æ¯ä¸ªå€¼å‡ºç° 100 æ¬¡ã€‚ï¼‰ å¯¹äºåŒºé—´é€‰æ‹©æ“ä½œ $p:{A\u003ea}$ï¼Œä¸‰ç§æ–¹æ³•ï¼š$T(W)=\\frac{T(R)}{2}$ æˆ– $T(W)=\\frac{T(R)}{3}$ æˆ– $T(W)=\\frac{\\text{é€‰æ‹©å…ƒç´ }}{\\text{åŒºé—´èŒƒå›´}} \\times T(R)$ å¯¹äºä¸ç­‰å€¼æŸ¥è¯¢æ“ä½œ $p: {A \\neq a}$ ï¼Œ$T(W)=T(R) - \\frac{T(R)}{V(R,A)}$ å¯¹äºé€‰æ‹©æ“ä½œçš„ T(W) å…¬å¼ï¼Œæ ¹æœ¬ä¸Šæ˜¯ $T(W)=T(R)Ã—P(w)$ ï¼Œä¾‹å¦‚åœ¨ç­‰å€¼æŸ¥è¯¢æ—¶å€™ï¼Œå‡è®¾å‡åŒ€åˆ†å¸ƒï¼Œ$A=a$ çš„æ¦‚ç‡å°±æ˜¯ $\\frac{1}{V(R,A)}$ã€‚åœ¨è¿™ä¸ªåŸºç¡€ä¸Šæˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°ï¼Œå¸¦æœ‰ AND å’Œ OR çš„é€‰æ‹©æ“ä½œè¯¥æ€ä¹ˆè®¡ç®—ï¼š å¯¹äº $W = \\sigma_{p_1 \\land p_2}(R)$ï¼Œ p1 å’Œ p2 æ˜¯ A å’Œ B çš„ç­‰å€¼é€‰æ‹©ï¼Œæˆ‘ä»¬æœ‰ $T(W)=T(R)Ã—P(p1_â€‹)Ã—P(p_2â€‹)=\\frac{R}{V(R,A) \\times V(R, B)}$ å¯¹äº $W = \\sigma_{p_1 \\lor p_2}(R)$ï¼Œp1 å’Œ p2 æ˜¯ A å’Œ B çš„ç­‰å€¼é€‰æ‹©ï¼Œæˆ‘ä»¬æœ‰ $T(W)=T(R)Ã—(P(p_1â€‹)+P(p_2â€‹)âˆ’P(p_1â€‹)Ã—P(p_2â€‹))$ å¯¹äºè¿æ¥æ“ä½œ $W=R_1(A,B,C) \\Join R_2(A,D)$ $S(W) = S(R_1) + S(R_2) - S(A)$ $T(W)=\\frac{T(R_1) \\times T(R_2)}{\\max{(V(R_1,A), V(R_2,A))}}$ $V(W,*)$ $V(W,B)=V(R_1,B)$ $V(W,C)=V(R_1,C)$ $V(W,D)=V(R_2,D)$ $V(W,A)=\\min (V(R_1,A),V(R_2,A))$ å¯¹äºè¿æ¥æ“ä½œï¼Œå‡å¦‚å‡ºç°å¤šä¸ªå…³è”é”®ï¼Œä¾‹å¦‚ $W=R_1(A,B,C) \\Join R_2(A,B,D)$ $S(W) = S(R_1) + S(R_2) - S(A) - S(B)$ $T(W)=\\frac{T(R_1) \\times T(R_2)}{\\max{(V(R_1,A), V(R_2,A))} \\times \\max{(V(R_1,B), V(R_2,B))}}$ ä¸Šé¢å…¬å¼æ˜¯åŸºäºä¸‹é¢çš„å‡è®¾ï¼š $V(R_1,A) \\lt V(R_2,A)$ â‡’ R1.A ä¸Šçš„å€¼éƒ½åœ¨ R2 ä¸­ $V(R_2,A) \\lt V(R_1,A)$ â‡’ R2.A ä¸Šçš„å€¼éƒ½åœ¨ R1 ä¸­ å¯¹äº $R_1$ è€Œè¨€ï¼ŒA å‡ºç°åœ¨ $R_2$ çš„é¢„æœŸè¡Œæ•°ä¸º $\\frac{T(R_2)}{V(R_2, A)}$ ï¼Œå¯¹äº $R_2$ è€Œè¨€åŒç†ã€‚å‡å¦‚ $V(R_1,A) \\lt V(R_2,A)$ï¼ŒR2.A å¾ˆå¤šå€¼ä¸åœ¨ R1ï¼Œå¦‚æœç”¨ $T(R_2) * \\frac{T(R_1)}{V(R_1, A)}$ ä¸å‡†ã€‚ I/O ä»£ä»·ä¼°è®¡ ä¼°è®¡ç›®æ ‡ï¼šæŸ¥è¯¢è®¡åˆ’æ‰€å¿…é¡»è¯»ï¼ˆå†™ï¼‰çš„ç£ç›˜å—æ•°ç›® å½±å“æŸ¥è¯¢è®¡åˆ’ I/O ä»£ä»·çš„å› ç´ ï¼š å®ç°æŸ¥è¯¢è®¡åˆ’çš„é€»è¾‘æ“ä½œç¬¦ ä¸­é—´ç»“æœçš„å¤§å° å®ç°é€»è¾‘æ“ä½œç¬¦çš„ç‰©ç†æ“ä½œ e.g. è¿æ¥æ“ä½œæ˜¯ç”¨ç´¢å¼•è¿æ¥è¿˜æ˜¯æ•£åˆ—è¿æ¥ï¼Ÿ ç›¸ä¼¼æ“ä½œçš„é¡ºåº e.g. å¤šå…³ç³»çš„è¿æ¥é¡ºåº ç‰©ç†æ“ä½œç¬¦ä¹‹é—´çš„å‚æ•°ä¼ é€’æ–¹å¼ï¼ˆæµæ°´çº¿è¿˜æ˜¯ç‰©åŒ–ï¼Ÿï¼‰ ç‰©ç†æ“ä½œç¬¦çš„å‚æ•°ä¼ é€’æ–¹å¼ï¼š æµæ°´çº¿ï¼šå¤šä¸ªæ“ä½œåŒæ—¶æ‰§è¡Œï¼Œä¸€ä¸ªæ“ä½œäº§ç”Ÿçš„å…ƒç»„ç›´æ¥é€šè¿‡å…±äº«å†…å­˜ä¼ é€’ç»™å…¶ä»–æ“ä½œ èŠ‚çœ I/O å ç”¨ä¸»å­˜ï¼Œè‹¥ç¼“å†²åŒºå‡ºç°â€œé¢ ç°¸â€åˆ™ I/O å¢åŠ  ç‰©åŒ–ï¼šæ“ä½œä¾æ¬¡æ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸ªæ“ä½œçš„ç»“æœï¼ˆä¸­é—´å…³ç³»ï¼‰éƒ½å†™åˆ°ç£ç›˜ä¸Šä¾›å…¶ä»–æ“ä½œå­˜å– é€šè¿‡ç£ç›˜ç‰©ç†è¿›è¡Œæ•°æ®ä¼ é€’ èŠ‚çœä¸»å­˜ç©ºé—´ æ„Ÿè§‰ä¸è€ƒï¼Œè®°ä¸€è®°ä»¥é˜²é€‰æ‹©åˆ¤æ–­é¢˜è€ƒã€‚ ç‰©ç†æŸ¥è¯¢è®¡åˆ’ç”Ÿæˆ åº”è¯¥ä¸è€ƒ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:6:5","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç‰©ç†æŸ¥è¯¢è®¡åˆ’ç”Ÿæˆ"},{"categories":null,"content":" è¯¾åé¢˜ text å·²çŸ¥æœ‰å…³ç³»æ¨¡å¼R(A,B,C)å’ŒS(B,C,D),æ¯ä¸ªå±æ€§éƒ½å 10ä¸ªå­—èŠ‚ï¼Œè¯·ä¼°è®¡ä¸‹é¢çš„é€»è¾‘æŸ¥è¯¢è®¡åˆ’çš„T(U),S(U)ä»¥åŠç»“æœå…³ç³»ä¸­æ¯ä¸ªå±æ€§çš„Vå€¼ï¼ˆå‡è®¾æ»¡è¶³â€œContainment of ValueSets\",å¹¶ä¸”é€‰æ‹©æ¡ä»¶ä¸­çš„å€¼éƒ½åœ¨å…³ç³»ä¸­å­˜åœ¨)ï¼š U=Ï€ AD [(Ïƒ(A=3)âˆ©(B=5)R) è¿æ¥ S)] ç›¸åº”çš„ç»Ÿè®¡é‡å¦‚ä¸‹ï¼š T(R)=100000 V(R,A)=20, V(R,B)=50, V(R,C)=150 T(S)=5000, V(S,B)=100, V(s,C)=200, V(S,D)=30 çº é”™ $V(\\sigma{A=3 \\land B=5 (R)}, B)=1$ ï¼Œå› ä¸ºåªé€‰æ‹©äº† $B=1$ ï¼Œæ‰€ä»¥ B åˆ—åªæœ‰ä¸€ä¸ªä¸åŒçš„å€¼ $V(\\sigma{A=3 \\land B=5 (R)}, C)= \\min(V(R,C), T(Râ€™))$ text å·²çŸ¥æœ‰ä¸‹é¢çš„3ä¸ªåŸºæœ¬è¡¨ï¼š Movies (title,year) ä¸€ç”µå½±è¡¨ Actors (actorID,name)ä¸€ä¸€æ¼”å‘˜è¡¨ Acted in (actorID,title,year)-ä¸€æ¼”å‡ºè¡¨ 3ä¸ªåŸºæœ¬è¡¨ç›¸å…³çš„ç»Ÿè®¡é‡å¦‚ä¸‹ï¼š T(Movies)=50,000 T(Actors)=200,000 T(Acted_in)=1,000,000 V(Movies,title)=30,000 V(Movies,year)=90 V(Actors,actorID)=200,000 V(Actors,name)=160,000 V(Acted_in,actorID)=180,000 V(Acted_in,title)=29,000 V(Acted_in,year)=90 è¯·ä¼°è®¡ä¸‹é¢æŸ¥è¯¢çš„ç»“æœå…³ç³»å¤§å°ï¼ˆç²¾ç¡®åˆ°å°æ•°ç‚¹å3ä½ï¼‰ï¼š 1)SELECT FROM Movies WHERE year=2000 AND title='The Killer' 2)SELECT FROM Movies,Acted in WHERE Movies.title=Acted in.title AND Movies.year=Acted in.year [è€ƒè™‘ä¸¤ç§æƒ…å†µï¼š(title,year)æ˜¯Moviesçš„ä¸»é”®ï¼Œ(title,year)ä¸æ˜¯Moviesçš„ä¸»é”®] ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:6:6","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è¯¾åé¢˜-3"},{"categories":null,"content":" ç¬¬ä¸ƒç«  è¿æ¥ç®—æ³•é‡ç‚¹ï¼šæ¯ä¸ªè¿æ¥ç®—æ³•çš„ I/O ä»£ä»·ä¼°è®¡å’Œå†…å­˜å¼€é”€ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¬¬ä¸ƒç« -è¿æ¥ç®—æ³•"},{"categories":null,"content":" ç‰©ç†æŸ¥è¯¢è®¡åˆ’æ“ä½œç¬¦ æ„Ÿè§‰ä¸è€ƒï¼ŒPPTæ²¡çœ‹æ‡‚è®²ä»€ä¹ˆ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç‰©ç†æŸ¥è¯¢è®¡åˆ’æ“ä½œç¬¦"},{"categories":null,"content":" è¿æ¥æ“ä½œçš„å®ç°ç®—æ³• $R_1(A, C) \\Join R_2(C, D)$ åµŒå¥—å¾ªç¯è¿æ¥ å½’å¹¶è¿æ¥ ç´¢å¼•è¿æ¥ æ•£åˆ—è¿æ¥ åµŒå¥—å¾ªç¯è¿æ¥ python for r in R1: for s in R2: if r.c == s.c: output(r, s) å½’å¹¶è¿æ¥ python sort(R) sort(J) i = 0, j = 0 while i \u003c |R| and j \u003c |S|: if R[i].c \u003c S[j].c: i += 1 elif R[i].c \u003e S[j].c: j += 1 else: // ç›¸ç­‰ // æ”¶é›†å½“å‰å€¼çš„æ‰€æœ‰ R å…ƒç»„ï¼ˆä» i å¼€å§‹è¿ç»­ç›¸åŒï¼‰ // æ”¶é›†å½“å‰å€¼çš„æ‰€æœ‰ S å…ƒç»„ï¼ˆä» j å¼€å§‹è¿ç»­ç›¸åŒï¼‰ // ä¸¤ä¸¤ç¬›å¡å°”ç§¯è¾“å‡º // å‰è¿› i å’Œ j åˆ°ä¸‹ä¸€ä¸åŒå€¼ ç´¢å¼•è¿æ¥ text For each r âˆˆ R1 do { // å¤–å±‚å¾ªç¯ï¼šéå†å¤–å…³ç³» R1 çš„æ¯ä¸€è¡Œ r X â† index(R2, C, r.C) // ç”¨ R2 åœ¨å±æ€§ C ä¸Šçš„ç´¢å¼•ï¼Œå¿«é€ŸæŸ¥æ‰¾æ‰€æœ‰ C å€¼ç­‰äº r.C çš„è¡Œé›†åˆ X For each s âˆˆ X do // å†…å±‚å¾ªç¯ï¼šéå†åŒ¹é…çš„è¡Œé›†åˆ X Output r,s pair // è¾“å‡ºè¿æ¥ç»“æœ (r, s) } è¦æ±‚åœ¨ R2 ä¸Šæœ‰ç´¢å¼•ï¼Œç›¸å½“äºå¯¹åµŒå¥—å¾ªç¯è¿æ¥çš„ä¼˜åŒ–ï¼Œä½¿ç”¨ç´¢å¼•ç»“æ„ä¼˜åŒ– for s in R2 çš„æŸ¥æ‰¾æ—¶é—´ã€‚åœ¨æœ€åæƒ…å†µä¸‹(å½“ X ä¸º R2 å…¨é›†)ï¼Œç´¢å¼•è¿æ¥ç®—æ³•ä¼šæ¯”åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•å¤æ‚åº¦é«˜(å¤šäº†ä¸€æ¬¡ç´¢å¼•ä»£ä»·)ã€‚ æ•£åˆ—è¿æ¥ python # å‡è®¾ R è¾ƒå°ï¼Œä½œä¸º Build Input hash_table = {} # é”®: è¿æ¥å±æ€§å€¼, å€¼: å…ƒç»„åˆ—è¡¨ for r in R: key = r.a hash_table[key].append(r) # æ”¾å…¥å¯¹åº”æ¡¶ for s in S: key = s.b if key in hash_table: for r in hash_table[key]: output (r, s) é€šè¿‡ç©ºé—´æ¢æ—¶é—´ï¼ŒæŠŠåµŒå¥—å¾ªç¯çš„ $O(RS)$ å˜æˆ $O(Shash_len)$ ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è¿æ¥æ“ä½œçš„å®ç°ç®—æ³•"},{"categories":null,"content":" è¿æ¥æ“ä½œçš„å®ç°ç®—æ³• $R_1(A, C) \\Join R_2(C, D)$ åµŒå¥—å¾ªç¯è¿æ¥ å½’å¹¶è¿æ¥ ç´¢å¼•è¿æ¥ æ•£åˆ—è¿æ¥ åµŒå¥—å¾ªç¯è¿æ¥ python for r in R1: for s in R2: if r.c == s.c: output(r, s) å½’å¹¶è¿æ¥ python sort(R) sort(J) i = 0, j = 0 while i \u003c |R| and j \u003c |S|: if R[i].c \u003c S[j].c: i += 1 elif R[i].c \u003e S[j].c: j += 1 else: // ç›¸ç­‰ // æ”¶é›†å½“å‰å€¼çš„æ‰€æœ‰ R å…ƒç»„ï¼ˆä» i å¼€å§‹è¿ç»­ç›¸åŒï¼‰ // æ”¶é›†å½“å‰å€¼çš„æ‰€æœ‰ S å…ƒç»„ï¼ˆä» j å¼€å§‹è¿ç»­ç›¸åŒï¼‰ // ä¸¤ä¸¤ç¬›å¡å°”ç§¯è¾“å‡º // å‰è¿› i å’Œ j åˆ°ä¸‹ä¸€ä¸åŒå€¼ ç´¢å¼•è¿æ¥ text For each r âˆˆ R1 do { // å¤–å±‚å¾ªç¯ï¼šéå†å¤–å…³ç³» R1 çš„æ¯ä¸€è¡Œ r X â† index(R2, C, r.C) // ç”¨ R2 åœ¨å±æ€§ C ä¸Šçš„ç´¢å¼•ï¼Œå¿«é€ŸæŸ¥æ‰¾æ‰€æœ‰ C å€¼ç­‰äº r.C çš„è¡Œé›†åˆ X For each s âˆˆ X do // å†…å±‚å¾ªç¯ï¼šéå†åŒ¹é…çš„è¡Œé›†åˆ X Output r,s pair // è¾“å‡ºè¿æ¥ç»“æœ (r, s) } è¦æ±‚åœ¨ R2 ä¸Šæœ‰ç´¢å¼•ï¼Œç›¸å½“äºå¯¹åµŒå¥—å¾ªç¯è¿æ¥çš„ä¼˜åŒ–ï¼Œä½¿ç”¨ç´¢å¼•ç»“æ„ä¼˜åŒ– for s in R2 çš„æŸ¥æ‰¾æ—¶é—´ã€‚åœ¨æœ€åæƒ…å†µä¸‹(å½“ X ä¸º R2 å…¨é›†)ï¼Œç´¢å¼•è¿æ¥ç®—æ³•ä¼šæ¯”åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•å¤æ‚åº¦é«˜(å¤šäº†ä¸€æ¬¡ç´¢å¼•ä»£ä»·)ã€‚ æ•£åˆ—è¿æ¥ python # å‡è®¾ R è¾ƒå°ï¼Œä½œä¸º Build Input hash_table = {} # é”®: è¿æ¥å±æ€§å€¼, å€¼: å…ƒç»„åˆ—è¡¨ for r in R: key = r.a hash_table[key].append(r) # æ”¾å…¥å¯¹åº”æ¡¶ for s in S: key = s.b if key in hash_table: for r in hash_table[key]: output (r, s) é€šè¿‡ç©ºé—´æ¢æ—¶é—´ï¼ŒæŠŠåµŒå¥—å¾ªç¯çš„ $O(RS)$ å˜æˆ $O(Shash_len)$ ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#åµŒå¥—å¾ªç¯è¿æ¥"},{"categories":null,"content":" è¿æ¥æ“ä½œçš„å®ç°ç®—æ³• $R_1(A, C) \\Join R_2(C, D)$ åµŒå¥—å¾ªç¯è¿æ¥ å½’å¹¶è¿æ¥ ç´¢å¼•è¿æ¥ æ•£åˆ—è¿æ¥ åµŒå¥—å¾ªç¯è¿æ¥ python for r in R1: for s in R2: if r.c == s.c: output(r, s) å½’å¹¶è¿æ¥ python sort(R) sort(J) i = 0, j = 0 while i \u003c |R| and j \u003c |S|: if R[i].c \u003c S[j].c: i += 1 elif R[i].c \u003e S[j].c: j += 1 else: // ç›¸ç­‰ // æ”¶é›†å½“å‰å€¼çš„æ‰€æœ‰ R å…ƒç»„ï¼ˆä» i å¼€å§‹è¿ç»­ç›¸åŒï¼‰ // æ”¶é›†å½“å‰å€¼çš„æ‰€æœ‰ S å…ƒç»„ï¼ˆä» j å¼€å§‹è¿ç»­ç›¸åŒï¼‰ // ä¸¤ä¸¤ç¬›å¡å°”ç§¯è¾“å‡º // å‰è¿› i å’Œ j åˆ°ä¸‹ä¸€ä¸åŒå€¼ ç´¢å¼•è¿æ¥ text For each r âˆˆ R1 do { // å¤–å±‚å¾ªç¯ï¼šéå†å¤–å…³ç³» R1 çš„æ¯ä¸€è¡Œ r X â† index(R2, C, r.C) // ç”¨ R2 åœ¨å±æ€§ C ä¸Šçš„ç´¢å¼•ï¼Œå¿«é€ŸæŸ¥æ‰¾æ‰€æœ‰ C å€¼ç­‰äº r.C çš„è¡Œé›†åˆ X For each s âˆˆ X do // å†…å±‚å¾ªç¯ï¼šéå†åŒ¹é…çš„è¡Œé›†åˆ X Output r,s pair // è¾“å‡ºè¿æ¥ç»“æœ (r, s) } è¦æ±‚åœ¨ R2 ä¸Šæœ‰ç´¢å¼•ï¼Œç›¸å½“äºå¯¹åµŒå¥—å¾ªç¯è¿æ¥çš„ä¼˜åŒ–ï¼Œä½¿ç”¨ç´¢å¼•ç»“æ„ä¼˜åŒ– for s in R2 çš„æŸ¥æ‰¾æ—¶é—´ã€‚åœ¨æœ€åæƒ…å†µä¸‹(å½“ X ä¸º R2 å…¨é›†)ï¼Œç´¢å¼•è¿æ¥ç®—æ³•ä¼šæ¯”åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•å¤æ‚åº¦é«˜(å¤šäº†ä¸€æ¬¡ç´¢å¼•ä»£ä»·)ã€‚ æ•£åˆ—è¿æ¥ python # å‡è®¾ R è¾ƒå°ï¼Œä½œä¸º Build Input hash_table = {} # é”®: è¿æ¥å±æ€§å€¼, å€¼: å…ƒç»„åˆ—è¡¨ for r in R: key = r.a hash_table[key].append(r) # æ”¾å…¥å¯¹åº”æ¡¶ for s in S: key = s.b if key in hash_table: for r in hash_table[key]: output (r, s) é€šè¿‡ç©ºé—´æ¢æ—¶é—´ï¼ŒæŠŠåµŒå¥—å¾ªç¯çš„ $O(RS)$ å˜æˆ $O(Shash_len)$ ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å½’å¹¶è¿æ¥"},{"categories":null,"content":" è¿æ¥æ“ä½œçš„å®ç°ç®—æ³• $R_1(A, C) \\Join R_2(C, D)$ åµŒå¥—å¾ªç¯è¿æ¥ å½’å¹¶è¿æ¥ ç´¢å¼•è¿æ¥ æ•£åˆ—è¿æ¥ åµŒå¥—å¾ªç¯è¿æ¥ python for r in R1: for s in R2: if r.c == s.c: output(r, s) å½’å¹¶è¿æ¥ python sort(R) sort(J) i = 0, j = 0 while i \u003c |R| and j \u003c |S|: if R[i].c \u003c S[j].c: i += 1 elif R[i].c \u003e S[j].c: j += 1 else: // ç›¸ç­‰ // æ”¶é›†å½“å‰å€¼çš„æ‰€æœ‰ R å…ƒç»„ï¼ˆä» i å¼€å§‹è¿ç»­ç›¸åŒï¼‰ // æ”¶é›†å½“å‰å€¼çš„æ‰€æœ‰ S å…ƒç»„ï¼ˆä» j å¼€å§‹è¿ç»­ç›¸åŒï¼‰ // ä¸¤ä¸¤ç¬›å¡å°”ç§¯è¾“å‡º // å‰è¿› i å’Œ j åˆ°ä¸‹ä¸€ä¸åŒå€¼ ç´¢å¼•è¿æ¥ text For each r âˆˆ R1 do { // å¤–å±‚å¾ªç¯ï¼šéå†å¤–å…³ç³» R1 çš„æ¯ä¸€è¡Œ r X â† index(R2, C, r.C) // ç”¨ R2 åœ¨å±æ€§ C ä¸Šçš„ç´¢å¼•ï¼Œå¿«é€ŸæŸ¥æ‰¾æ‰€æœ‰ C å€¼ç­‰äº r.C çš„è¡Œé›†åˆ X For each s âˆˆ X do // å†…å±‚å¾ªç¯ï¼šéå†åŒ¹é…çš„è¡Œé›†åˆ X Output r,s pair // è¾“å‡ºè¿æ¥ç»“æœ (r, s) } è¦æ±‚åœ¨ R2 ä¸Šæœ‰ç´¢å¼•ï¼Œç›¸å½“äºå¯¹åµŒå¥—å¾ªç¯è¿æ¥çš„ä¼˜åŒ–ï¼Œä½¿ç”¨ç´¢å¼•ç»“æ„ä¼˜åŒ– for s in R2 çš„æŸ¥æ‰¾æ—¶é—´ã€‚åœ¨æœ€åæƒ…å†µä¸‹(å½“ X ä¸º R2 å…¨é›†)ï¼Œç´¢å¼•è¿æ¥ç®—æ³•ä¼šæ¯”åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•å¤æ‚åº¦é«˜(å¤šäº†ä¸€æ¬¡ç´¢å¼•ä»£ä»·)ã€‚ æ•£åˆ—è¿æ¥ python # å‡è®¾ R è¾ƒå°ï¼Œä½œä¸º Build Input hash_table = {} # é”®: è¿æ¥å±æ€§å€¼, å€¼: å…ƒç»„åˆ—è¡¨ for r in R: key = r.a hash_table[key].append(r) # æ”¾å…¥å¯¹åº”æ¡¶ for s in S: key = s.b if key in hash_table: for r in hash_table[key]: output (r, s) é€šè¿‡ç©ºé—´æ¢æ—¶é—´ï¼ŒæŠŠåµŒå¥—å¾ªç¯çš„ $O(RS)$ å˜æˆ $O(Shash_len)$ ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç´¢å¼•è¿æ¥"},{"categories":null,"content":" è¿æ¥æ“ä½œçš„å®ç°ç®—æ³• $R_1(A, C) \\Join R_2(C, D)$ åµŒå¥—å¾ªç¯è¿æ¥ å½’å¹¶è¿æ¥ ç´¢å¼•è¿æ¥ æ•£åˆ—è¿æ¥ åµŒå¥—å¾ªç¯è¿æ¥ python for r in R1: for s in R2: if r.c == s.c: output(r, s) å½’å¹¶è¿æ¥ python sort(R) sort(J) i = 0, j = 0 while i \u003c |R| and j \u003c |S|: if R[i].c \u003c S[j].c: i += 1 elif R[i].c \u003e S[j].c: j += 1 else: // ç›¸ç­‰ // æ”¶é›†å½“å‰å€¼çš„æ‰€æœ‰ R å…ƒç»„ï¼ˆä» i å¼€å§‹è¿ç»­ç›¸åŒï¼‰ // æ”¶é›†å½“å‰å€¼çš„æ‰€æœ‰ S å…ƒç»„ï¼ˆä» j å¼€å§‹è¿ç»­ç›¸åŒï¼‰ // ä¸¤ä¸¤ç¬›å¡å°”ç§¯è¾“å‡º // å‰è¿› i å’Œ j åˆ°ä¸‹ä¸€ä¸åŒå€¼ ç´¢å¼•è¿æ¥ text For each r âˆˆ R1 do { // å¤–å±‚å¾ªç¯ï¼šéå†å¤–å…³ç³» R1 çš„æ¯ä¸€è¡Œ r X â† index(R2, C, r.C) // ç”¨ R2 åœ¨å±æ€§ C ä¸Šçš„ç´¢å¼•ï¼Œå¿«é€ŸæŸ¥æ‰¾æ‰€æœ‰ C å€¼ç­‰äº r.C çš„è¡Œé›†åˆ X For each s âˆˆ X do // å†…å±‚å¾ªç¯ï¼šéå†åŒ¹é…çš„è¡Œé›†åˆ X Output r,s pair // è¾“å‡ºè¿æ¥ç»“æœ (r, s) } è¦æ±‚åœ¨ R2 ä¸Šæœ‰ç´¢å¼•ï¼Œç›¸å½“äºå¯¹åµŒå¥—å¾ªç¯è¿æ¥çš„ä¼˜åŒ–ï¼Œä½¿ç”¨ç´¢å¼•ç»“æ„ä¼˜åŒ– for s in R2 çš„æŸ¥æ‰¾æ—¶é—´ã€‚åœ¨æœ€åæƒ…å†µä¸‹(å½“ X ä¸º R2 å…¨é›†)ï¼Œç´¢å¼•è¿æ¥ç®—æ³•ä¼šæ¯”åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•å¤æ‚åº¦é«˜(å¤šäº†ä¸€æ¬¡ç´¢å¼•ä»£ä»·)ã€‚ æ•£åˆ—è¿æ¥ python # å‡è®¾ R è¾ƒå°ï¼Œä½œä¸º Build Input hash_table = {} # é”®: è¿æ¥å±æ€§å€¼, å€¼: å…ƒç»„åˆ—è¡¨ for r in R: key = r.a hash_table[key].append(r) # æ”¾å…¥å¯¹åº”æ¡¶ for s in S: key = s.b if key in hash_table: for r in hash_table[key]: output (r, s) é€šè¿‡ç©ºé—´æ¢æ—¶é—´ï¼ŒæŠŠåµŒå¥—å¾ªç¯çš„ $O(RS)$ å˜æˆ $O(Shash_len)$ ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ•£åˆ—è¿æ¥"},{"categories":null,"content":" I/O ä»£ä»·ä¼°è®¡ åµŒå¥—ç´¢å¼•è¿æ¥æƒ…å†µä¸€ï¼šä¸è¿ç»­å­˜æ”¾ text è®¾: T(R1) = 10,000 T(R2) = 5,000 S(R1) = S(R2) = 1/10 block MEM = 101 blocks æœ´ç´ ç®—æ³•ï¼šå¯¹äºæ¯ä¸€ä¸ª R1ï¼Œæ¯æ¬¡æ‹¿å‡ºæ‰€æœ‰ R2 ä¸­æ‰€æœ‰å…ƒç´ è¿›è¡Œå¯¹æ¯”ï¼Œ I/O æ€»æ¬¡æ•°æ˜¯ $10000*(1+5000)=50010000$ æ¬¡ã€‚ æ”¹è¿›ç®—æ³•ï¼š R1 ä¸€å…±å  1000 å—ï¼ŒR2 ä¸€å…±å  500 å—ï¼Œå†…å­˜å…± 101 å— R1 å­˜ 100 å—åˆ°å†…å­˜ï¼ŒR2 å­˜ä¸€å— R2 ä¸æ–­å’Œå†…å­˜ä¸­çš„ R1 æ¯”è¾ƒï¼Œä¸€å—è¯»å®Œæ¢ä¸‹ä¸€å—ï¼Œæ€» I/O æ¬¡æ•°ä¸ºï¼š$10000(R1) + \\frac{10000}{100} * 5000=510000$ æ¬¡ ä¸è¿ç»­ï¼Œæ‰€ä»¥ä¸€å—ä¸€ä¸ªè®°å½•ã€‚R1 å  10000 å—ï¼ŒR2 å  5000 å—ã€‚ç„¶åæ¯è½®è¯» 100 å— R1, R2 5000 å—å…¨è¯»ä¸€éï¼Œç„¶åä¸€å…±10000/100è½®ï¼Œæ‰€ä»¥ $100*(100+5000)$ æ¬¡ I/Oã€‚ æ”¹è¿›ç®—æ³•2ï¼šè¿ç”¨äº¤æ¢å¾‹ $R_2 \\Join R_1$ $5000(R_2) + \\frac{5000}{100}*10000=505000$ æ¬¡ æƒ…å†µäºŒï¼šè¿ç»­å­˜æ”¾ æ”¹è¿›ç®—æ³•2ï¼šè¿ç”¨äº¤æ¢å¾‹ $R_2 \\Join R_1$ $500(R_2) + \\frac{500}{100}*1000=5500$ æ¬¡ æ”¹è¿›ç®—æ³•çš„ I/O æ€»æ¬¡æ•°ä¸ºï¼š$I/O = B(R_out) + âŒˆ B(R_out) / (M âˆ’ 1) âŒ‰ Ã— B(R_in)$ ã€‚è¿ç»­æ—¶å€™ $B=T*S$ï¼Œä¸è¿ç»­æ—¶å€™ $B=T$ï¼Œæ¯å—ä¸€ä¸ªè®°å½•ã€‚ å½’å¹¶è¿æ¥ è¿ç»­ä¸”æœ‰åºï¼š$1000(R_1)+500(R_2)=1500$ æ¬¡ I/Oï¼Œå°±æ˜¯å…¨éƒ¨è¯»è¿›å†…å­˜ã€‚ è¿ç»­ä¸”æ— åºï¼šå…ˆæŠŠå…ƒç´ è¿›è¡Œæ’åºï¼Œç„¶åå†å…¨éƒ¨è¯»è¿›å†…å­˜ã€‚å‡å¦‚ç”¨çš„å½’å¹¶æ’åº é˜¶æ®µä¸€ï¼šR1 çš„å—å…¨éƒ¨è¯»è¿› bufferï¼Œåœ¨å†…å­˜æ’åºåå†™ä¼šç£ç›˜ï¼Œæœ€ç»ˆå¾—åˆ° n chunkï¼Œæ¯ä¸ª chunk å†…éƒ¨æœ‰åº é˜¶æ®µäºŒï¼šä¸åŒ chunk ä¸­è¯»è¿› buffer è¿›è¡Œå½’å¹¶æ’åºï¼Œæœ€åè¿˜è¦å†™å›ç£ç›˜ è¯»å†™åˆ†åˆ«ä¸¤æ¬¡ï¼š$(2+2)*(1000+500)=6000$ï¼ŒåŠ ä¸Šä¹‹å‰è®¡ç®—çš„ 1500 æ¬¡ I/Oï¼Œä¸€å…± 7500 æ¬¡ I/O å’ŒåµŒå¥—ç´¢å¼•è¿æ¥å¯¹æ¯”ï¼Œå…³ç³»å°‘çš„æ—¶å€™åµŒå¥—ç´¢å¼•è¿æ¥åè€Œæ›´å¿«ï¼Œä½†æ˜¯å…³ç³»è¾ƒå¤§é€‰æ‹©å½’å¹¶è¿æ¥æ›´ä¼˜ã€‚ å‡è®¾ å†…å­˜ä¸­ buffer å—æ•°ä¸º kï¼Œè®°å½•ä¸€å…±å  x å—ï¼Œé‚£ä¹ˆ chunk æ•°ä¸º x/kã€‚ç”±äº chunk æ•°è¦å°ç­‰äº buffer å—æ•°ï¼Œæ‰€ä»¥æœ‰ $\\frac{x}{k} \\leq k$ å³ $\\sqrt{x} \\leq k$ ï¼Œå¯¹äºä¸Šé¢ä¾‹å­ R1 å  1000 å—ï¼ŒR2 å  500 å—ï¼Œéœ€è¦ buffer 32 å—ã€‚ ä¼˜åŒ–æ–¹æ³•æ˜¯åœ¨æ’åºäºŒé˜¶æ®µæ—¶å€™è¿æ¥ï¼Œéœ€è¦ $3*(B(R_1) + B(R_2))$ æ¬¡ I/Oã€‚ ç´¢å¼•è¿æ¥å‰é¢è¯´è¿‡ï¼Œç´¢å¼•è¿æ¥ç›¸è¾ƒäºåµŒå¥—ç´¢å¼•è¿æ¥ä¼˜åŠ¿å°±æ˜¯ï¼šæŠŠå†…å­˜å¾ªç¯å®Œæ•´éå†ï¼Œå˜æˆåªéœ€è¦éå†ç´¢å¼•èŠ‚ç‚¹ã€‚æ‰€ä»¥ç´¢å¼•è¿æ¥çš„ä»£ä»·å°±æ˜¯å¤–å±‚ block è¯»å– + å†…å±‚ç´¢å¼•çš„ block è¯»å–ã€‚ å¤–å±‚ block è¯»å–æ˜¯å…¨éƒ¨è¯»å–ï¼Œå¼€é”€å›ºå®š ä½†æ˜¯å†…å±‚ç´¢å¼•æ•°é‡ä¸ç¡®å®šï¼Œæ€ä¹ˆè®¡ç®—å¼€é”€ï¼Ÿ Cost=B(R2)+T(R2)âˆ—p Cost = B(R_2) + T(R_2)*p Cost=B(R2â€‹)+T(R2â€‹)âˆ—p è‹¥ R1.C æ˜¯ä¸»é”®, å³ R1.C å”¯ä¸€, é€‰æ‹©åŸºæ•° p = 1 è‹¥ R1.C ä¸å”¯ä¸€ï¼ŒV(R1,C)=5,000, T(R1) = 10,000, åˆ™æ¯ä¸ª R2 tuple åœ¨ R1 ä¸­çš„é€‰æ‹©åŸºæ•°$p = \\frac{T(R_1)}{V(R_1,C)}=2$ å‡è®¾ R1.C çš„ç´¢å¼•ä¸æ˜¯å…¨éƒ¨åœ¨å†…å­˜ï¼Œä¸€å…± 200å—ï¼Œ102 å—åœ¨ç£ç›˜ï¼Œ98 å—åœ¨å†…å­˜ï¼Œé‚£ä¹ˆå¹³å‡éœ€è¦ $0 * (98/200)+ 1*(102/200)=0.5$ æ¬¡ I/Oã€‚ä¸€å…±éœ€è¦ $500 + 500*(0.5 + 1 or 2)$ æ¬¡ I/Oã€‚ æ•£åˆ—è¿æ¥ å‡è®¾å†…å­˜ç¼“å†²åŒºæœ‰ M ä¸ª block è¯»å–æ•´ä¸ª R1ï¼Œå°† R1 æ•£åˆ—åœ¨ M-1 ä¸ª block é‡Œé¢ï¼Œç„¶åé€ä¸ªè¯»å– R2 å—ï¼Œå’Œ R1 è¿›è¡Œæ•£åˆ—æŸ¥æ‰¾ç„¶å joinï¼Œä¸€å…± $cost=B(R_1)+B(R_2)$ è¯»å– R1 å’Œ R2ï¼Œç„¶åæ•£åˆ—åˆ†åˆ«å¾—åˆ° 100 ä¸ª buckets å­˜åœ¨ç£ç›˜ã€‚ç„¶åè¯»å– M-1 ä¸ª block çš„ R2 åˆ° bufferï¼Œç„¶åå†é¡ºåºè¯» R1 çš„ block å’Œ R2 è¿›è¡Œæ•£åˆ—è¿æ¥ã€‚ æœ‰æ²¡æœ‰å¯èƒ½ R1 æ•£åˆ—å‡ºæ¥çš„ R2 çš„ key ä¸åœ¨å†…å­˜é‡Œï¼Ÿæ¯•ç«Ÿ R2 æ²¡æœ‰å…¨éƒ¨è£…åˆ°å†…å­˜é‡Œã€‚ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå› ä¸ºå®ƒåˆ©ç”¨â€œç›¸åŒçš„æ•£åˆ—å‡½æ•°ï¼Œäº§ç”Ÿç›¸åŒçš„æ•£åˆ—å€¼â€è¿™ä¸€ç‰¹æ€§ã€‚å½“è¯» 1,2,3 å— R2 åˆ°å†…å­˜ï¼Œæˆ‘ä»¬å°±é¡ºåºåªå– 1,2,3 çš„ R1 åˆ°å†…å­˜ã€‚ æ•£åˆ—æ—¶å€™ä¸€è¯»ä¸€å†™ï¼Œæœ€åå„è¯»ä¸€æ¬¡ï¼š$cost=3*(B(R_1)+B(R_2)))$ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#io-ä»£ä»·ä¼°è®¡-1"},{"categories":null,"content":" I/O ä»£ä»·ä¼°è®¡ åµŒå¥—ç´¢å¼•è¿æ¥æƒ…å†µä¸€ï¼šä¸è¿ç»­å­˜æ”¾ text è®¾: T(R1) = 10,000 T(R2) = 5,000 S(R1) = S(R2) = 1/10 block MEM = 101 blocks æœ´ç´ ç®—æ³•ï¼šå¯¹äºæ¯ä¸€ä¸ª R1ï¼Œæ¯æ¬¡æ‹¿å‡ºæ‰€æœ‰ R2 ä¸­æ‰€æœ‰å…ƒç´ è¿›è¡Œå¯¹æ¯”ï¼Œ I/O æ€»æ¬¡æ•°æ˜¯ $10000*(1+5000)=50010000$ æ¬¡ã€‚ æ”¹è¿›ç®—æ³•ï¼š R1 ä¸€å…±å  1000 å—ï¼ŒR2 ä¸€å…±å  500 å—ï¼Œå†…å­˜å…± 101 å— R1 å­˜ 100 å—åˆ°å†…å­˜ï¼ŒR2 å­˜ä¸€å— R2 ä¸æ–­å’Œå†…å­˜ä¸­çš„ R1 æ¯”è¾ƒï¼Œä¸€å—è¯»å®Œæ¢ä¸‹ä¸€å—ï¼Œæ€» I/O æ¬¡æ•°ä¸ºï¼š$10000(R1) + \\frac{10000}{100} * 5000=510000$ æ¬¡ ä¸è¿ç»­ï¼Œæ‰€ä»¥ä¸€å—ä¸€ä¸ªè®°å½•ã€‚R1 å  10000 å—ï¼ŒR2 å  5000 å—ã€‚ç„¶åæ¯è½®è¯» 100 å— R1, R2 5000 å—å…¨è¯»ä¸€éï¼Œç„¶åä¸€å…±10000/100è½®ï¼Œæ‰€ä»¥ $100*(100+5000)$ æ¬¡ I/Oã€‚ æ”¹è¿›ç®—æ³•2ï¼šè¿ç”¨äº¤æ¢å¾‹ $R_2 \\Join R_1$ $5000(R_2) + \\frac{5000}{100}*10000=505000$ æ¬¡ æƒ…å†µäºŒï¼šè¿ç»­å­˜æ”¾ æ”¹è¿›ç®—æ³•2ï¼šè¿ç”¨äº¤æ¢å¾‹ $R_2 \\Join R_1$ $500(R_2) + \\frac{500}{100}*1000=5500$ æ¬¡ æ”¹è¿›ç®—æ³•çš„ I/O æ€»æ¬¡æ•°ä¸ºï¼š$I/O = B(R_out) + âŒˆ B(R_out) / (M âˆ’ 1) âŒ‰ Ã— B(R_in)$ ã€‚è¿ç»­æ—¶å€™ $B=T*S$ï¼Œä¸è¿ç»­æ—¶å€™ $B=T$ï¼Œæ¯å—ä¸€ä¸ªè®°å½•ã€‚ å½’å¹¶è¿æ¥ è¿ç»­ä¸”æœ‰åºï¼š$1000(R_1)+500(R_2)=1500$ æ¬¡ I/Oï¼Œå°±æ˜¯å…¨éƒ¨è¯»è¿›å†…å­˜ã€‚ è¿ç»­ä¸”æ— åºï¼šå…ˆæŠŠå…ƒç´ è¿›è¡Œæ’åºï¼Œç„¶åå†å…¨éƒ¨è¯»è¿›å†…å­˜ã€‚å‡å¦‚ç”¨çš„å½’å¹¶æ’åº é˜¶æ®µä¸€ï¼šR1 çš„å—å…¨éƒ¨è¯»è¿› bufferï¼Œåœ¨å†…å­˜æ’åºåå†™ä¼šç£ç›˜ï¼Œæœ€ç»ˆå¾—åˆ° n chunkï¼Œæ¯ä¸ª chunk å†…éƒ¨æœ‰åº é˜¶æ®µäºŒï¼šä¸åŒ chunk ä¸­è¯»è¿› buffer è¿›è¡Œå½’å¹¶æ’åºï¼Œæœ€åè¿˜è¦å†™å›ç£ç›˜ è¯»å†™åˆ†åˆ«ä¸¤æ¬¡ï¼š$(2+2)*(1000+500)=6000$ï¼ŒåŠ ä¸Šä¹‹å‰è®¡ç®—çš„ 1500 æ¬¡ I/Oï¼Œä¸€å…± 7500 æ¬¡ I/O å’ŒåµŒå¥—ç´¢å¼•è¿æ¥å¯¹æ¯”ï¼Œå…³ç³»å°‘çš„æ—¶å€™åµŒå¥—ç´¢å¼•è¿æ¥åè€Œæ›´å¿«ï¼Œä½†æ˜¯å…³ç³»è¾ƒå¤§é€‰æ‹©å½’å¹¶è¿æ¥æ›´ä¼˜ã€‚ å‡è®¾ å†…å­˜ä¸­ buffer å—æ•°ä¸º kï¼Œè®°å½•ä¸€å…±å  x å—ï¼Œé‚£ä¹ˆ chunk æ•°ä¸º x/kã€‚ç”±äº chunk æ•°è¦å°ç­‰äº buffer å—æ•°ï¼Œæ‰€ä»¥æœ‰ $\\frac{x}{k} \\leq k$ å³ $\\sqrt{x} \\leq k$ ï¼Œå¯¹äºä¸Šé¢ä¾‹å­ R1 å  1000 å—ï¼ŒR2 å  500 å—ï¼Œéœ€è¦ buffer 32 å—ã€‚ ä¼˜åŒ–æ–¹æ³•æ˜¯åœ¨æ’åºäºŒé˜¶æ®µæ—¶å€™è¿æ¥ï¼Œéœ€è¦ $3*(B(R_1) + B(R_2))$ æ¬¡ I/Oã€‚ ç´¢å¼•è¿æ¥å‰é¢è¯´è¿‡ï¼Œç´¢å¼•è¿æ¥ç›¸è¾ƒäºåµŒå¥—ç´¢å¼•è¿æ¥ä¼˜åŠ¿å°±æ˜¯ï¼šæŠŠå†…å­˜å¾ªç¯å®Œæ•´éå†ï¼Œå˜æˆåªéœ€è¦éå†ç´¢å¼•èŠ‚ç‚¹ã€‚æ‰€ä»¥ç´¢å¼•è¿æ¥çš„ä»£ä»·å°±æ˜¯å¤–å±‚ block è¯»å– + å†…å±‚ç´¢å¼•çš„ block è¯»å–ã€‚ å¤–å±‚ block è¯»å–æ˜¯å…¨éƒ¨è¯»å–ï¼Œå¼€é”€å›ºå®š ä½†æ˜¯å†…å±‚ç´¢å¼•æ•°é‡ä¸ç¡®å®šï¼Œæ€ä¹ˆè®¡ç®—å¼€é”€ï¼Ÿ Cost=B(R2)+T(R2)âˆ—p Cost = B(R_2) + T(R_2)*p Cost=B(R2â€‹)+T(R2â€‹)âˆ—p è‹¥ R1.C æ˜¯ä¸»é”®, å³ R1.C å”¯ä¸€, é€‰æ‹©åŸºæ•° p = 1 è‹¥ R1.C ä¸å”¯ä¸€ï¼ŒV(R1,C)=5,000, T(R1) = 10,000, åˆ™æ¯ä¸ª R2 tuple åœ¨ R1 ä¸­çš„é€‰æ‹©åŸºæ•°$p = \\frac{T(R_1)}{V(R_1,C)}=2$ å‡è®¾ R1.C çš„ç´¢å¼•ä¸æ˜¯å…¨éƒ¨åœ¨å†…å­˜ï¼Œä¸€å…± 200å—ï¼Œ102 å—åœ¨ç£ç›˜ï¼Œ98 å—åœ¨å†…å­˜ï¼Œé‚£ä¹ˆå¹³å‡éœ€è¦ $0 * (98/200)+ 1*(102/200)=0.5$ æ¬¡ I/Oã€‚ä¸€å…±éœ€è¦ $500 + 500*(0.5 + 1 or 2)$ æ¬¡ I/Oã€‚ æ•£åˆ—è¿æ¥ å‡è®¾å†…å­˜ç¼“å†²åŒºæœ‰ M ä¸ª block è¯»å–æ•´ä¸ª R1ï¼Œå°† R1 æ•£åˆ—åœ¨ M-1 ä¸ª block é‡Œé¢ï¼Œç„¶åé€ä¸ªè¯»å– R2 å—ï¼Œå’Œ R1 è¿›è¡Œæ•£åˆ—æŸ¥æ‰¾ç„¶å joinï¼Œä¸€å…± $cost=B(R_1)+B(R_2)$ è¯»å– R1 å’Œ R2ï¼Œç„¶åæ•£åˆ—åˆ†åˆ«å¾—åˆ° 100 ä¸ª buckets å­˜åœ¨ç£ç›˜ã€‚ç„¶åè¯»å– M-1 ä¸ª block çš„ R2 åˆ° bufferï¼Œç„¶åå†é¡ºåºè¯» R1 çš„ block å’Œ R2 è¿›è¡Œæ•£åˆ—è¿æ¥ã€‚ æœ‰æ²¡æœ‰å¯èƒ½ R1 æ•£åˆ—å‡ºæ¥çš„ R2 çš„ key ä¸åœ¨å†…å­˜é‡Œï¼Ÿæ¯•ç«Ÿ R2 æ²¡æœ‰å…¨éƒ¨è£…åˆ°å†…å­˜é‡Œã€‚ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå› ä¸ºå®ƒåˆ©ç”¨â€œç›¸åŒçš„æ•£åˆ—å‡½æ•°ï¼Œäº§ç”Ÿç›¸åŒçš„æ•£åˆ—å€¼â€è¿™ä¸€ç‰¹æ€§ã€‚å½“è¯» 1,2,3 å— R2 åˆ°å†…å­˜ï¼Œæˆ‘ä»¬å°±é¡ºåºåªå– 1,2,3 çš„ R1 åˆ°å†…å­˜ã€‚ æ•£åˆ—æ—¶å€™ä¸€è¯»ä¸€å†™ï¼Œæœ€åå„è¯»ä¸€æ¬¡ï¼š$cost=3*(B(R_1)+B(R_2)))$ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#åµŒå¥—ç´¢å¼•è¿æ¥"},{"categories":null,"content":" I/O ä»£ä»·ä¼°è®¡ åµŒå¥—ç´¢å¼•è¿æ¥æƒ…å†µä¸€ï¼šä¸è¿ç»­å­˜æ”¾ text è®¾: T(R1) = 10,000 T(R2) = 5,000 S(R1) = S(R2) = 1/10 block MEM = 101 blocks æœ´ç´ ç®—æ³•ï¼šå¯¹äºæ¯ä¸€ä¸ª R1ï¼Œæ¯æ¬¡æ‹¿å‡ºæ‰€æœ‰ R2 ä¸­æ‰€æœ‰å…ƒç´ è¿›è¡Œå¯¹æ¯”ï¼Œ I/O æ€»æ¬¡æ•°æ˜¯ $10000*(1+5000)=50010000$ æ¬¡ã€‚ æ”¹è¿›ç®—æ³•ï¼š R1 ä¸€å…±å  1000 å—ï¼ŒR2 ä¸€å…±å  500 å—ï¼Œå†…å­˜å…± 101 å— R1 å­˜ 100 å—åˆ°å†…å­˜ï¼ŒR2 å­˜ä¸€å— R2 ä¸æ–­å’Œå†…å­˜ä¸­çš„ R1 æ¯”è¾ƒï¼Œä¸€å—è¯»å®Œæ¢ä¸‹ä¸€å—ï¼Œæ€» I/O æ¬¡æ•°ä¸ºï¼š$10000(R1) + \\frac{10000}{100} * 5000=510000$ æ¬¡ ä¸è¿ç»­ï¼Œæ‰€ä»¥ä¸€å—ä¸€ä¸ªè®°å½•ã€‚R1 å  10000 å—ï¼ŒR2 å  5000 å—ã€‚ç„¶åæ¯è½®è¯» 100 å— R1, R2 5000 å—å…¨è¯»ä¸€éï¼Œç„¶åä¸€å…±10000/100è½®ï¼Œæ‰€ä»¥ $100*(100+5000)$ æ¬¡ I/Oã€‚ æ”¹è¿›ç®—æ³•2ï¼šè¿ç”¨äº¤æ¢å¾‹ $R_2 \\Join R_1$ $5000(R_2) + \\frac{5000}{100}*10000=505000$ æ¬¡ æƒ…å†µäºŒï¼šè¿ç»­å­˜æ”¾ æ”¹è¿›ç®—æ³•2ï¼šè¿ç”¨äº¤æ¢å¾‹ $R_2 \\Join R_1$ $500(R_2) + \\frac{500}{100}*1000=5500$ æ¬¡ æ”¹è¿›ç®—æ³•çš„ I/O æ€»æ¬¡æ•°ä¸ºï¼š$I/O = B(R_out) + âŒˆ B(R_out) / (M âˆ’ 1) âŒ‰ Ã— B(R_in)$ ã€‚è¿ç»­æ—¶å€™ $B=T*S$ï¼Œä¸è¿ç»­æ—¶å€™ $B=T$ï¼Œæ¯å—ä¸€ä¸ªè®°å½•ã€‚ å½’å¹¶è¿æ¥ è¿ç»­ä¸”æœ‰åºï¼š$1000(R_1)+500(R_2)=1500$ æ¬¡ I/Oï¼Œå°±æ˜¯å…¨éƒ¨è¯»è¿›å†…å­˜ã€‚ è¿ç»­ä¸”æ— åºï¼šå…ˆæŠŠå…ƒç´ è¿›è¡Œæ’åºï¼Œç„¶åå†å…¨éƒ¨è¯»è¿›å†…å­˜ã€‚å‡å¦‚ç”¨çš„å½’å¹¶æ’åº é˜¶æ®µä¸€ï¼šR1 çš„å—å…¨éƒ¨è¯»è¿› bufferï¼Œåœ¨å†…å­˜æ’åºåå†™ä¼šç£ç›˜ï¼Œæœ€ç»ˆå¾—åˆ° n chunkï¼Œæ¯ä¸ª chunk å†…éƒ¨æœ‰åº é˜¶æ®µäºŒï¼šä¸åŒ chunk ä¸­è¯»è¿› buffer è¿›è¡Œå½’å¹¶æ’åºï¼Œæœ€åè¿˜è¦å†™å›ç£ç›˜ è¯»å†™åˆ†åˆ«ä¸¤æ¬¡ï¼š$(2+2)*(1000+500)=6000$ï¼ŒåŠ ä¸Šä¹‹å‰è®¡ç®—çš„ 1500 æ¬¡ I/Oï¼Œä¸€å…± 7500 æ¬¡ I/O å’ŒåµŒå¥—ç´¢å¼•è¿æ¥å¯¹æ¯”ï¼Œå…³ç³»å°‘çš„æ—¶å€™åµŒå¥—ç´¢å¼•è¿æ¥åè€Œæ›´å¿«ï¼Œä½†æ˜¯å…³ç³»è¾ƒå¤§é€‰æ‹©å½’å¹¶è¿æ¥æ›´ä¼˜ã€‚ å‡è®¾ å†…å­˜ä¸­ buffer å—æ•°ä¸º kï¼Œè®°å½•ä¸€å…±å  x å—ï¼Œé‚£ä¹ˆ chunk æ•°ä¸º x/kã€‚ç”±äº chunk æ•°è¦å°ç­‰äº buffer å—æ•°ï¼Œæ‰€ä»¥æœ‰ $\\frac{x}{k} \\leq k$ å³ $\\sqrt{x} \\leq k$ ï¼Œå¯¹äºä¸Šé¢ä¾‹å­ R1 å  1000 å—ï¼ŒR2 å  500 å—ï¼Œéœ€è¦ buffer 32 å—ã€‚ ä¼˜åŒ–æ–¹æ³•æ˜¯åœ¨æ’åºäºŒé˜¶æ®µæ—¶å€™è¿æ¥ï¼Œéœ€è¦ $3*(B(R_1) + B(R_2))$ æ¬¡ I/Oã€‚ ç´¢å¼•è¿æ¥å‰é¢è¯´è¿‡ï¼Œç´¢å¼•è¿æ¥ç›¸è¾ƒäºåµŒå¥—ç´¢å¼•è¿æ¥ä¼˜åŠ¿å°±æ˜¯ï¼šæŠŠå†…å­˜å¾ªç¯å®Œæ•´éå†ï¼Œå˜æˆåªéœ€è¦éå†ç´¢å¼•èŠ‚ç‚¹ã€‚æ‰€ä»¥ç´¢å¼•è¿æ¥çš„ä»£ä»·å°±æ˜¯å¤–å±‚ block è¯»å– + å†…å±‚ç´¢å¼•çš„ block è¯»å–ã€‚ å¤–å±‚ block è¯»å–æ˜¯å…¨éƒ¨è¯»å–ï¼Œå¼€é”€å›ºå®š ä½†æ˜¯å†…å±‚ç´¢å¼•æ•°é‡ä¸ç¡®å®šï¼Œæ€ä¹ˆè®¡ç®—å¼€é”€ï¼Ÿ Cost=B(R2)+T(R2)âˆ—p Cost = B(R_2) + T(R_2)*p Cost=B(R2â€‹)+T(R2â€‹)âˆ—p è‹¥ R1.C æ˜¯ä¸»é”®, å³ R1.C å”¯ä¸€, é€‰æ‹©åŸºæ•° p = 1 è‹¥ R1.C ä¸å”¯ä¸€ï¼ŒV(R1,C)=5,000, T(R1) = 10,000, åˆ™æ¯ä¸ª R2 tuple åœ¨ R1 ä¸­çš„é€‰æ‹©åŸºæ•°$p = \\frac{T(R_1)}{V(R_1,C)}=2$ å‡è®¾ R1.C çš„ç´¢å¼•ä¸æ˜¯å…¨éƒ¨åœ¨å†…å­˜ï¼Œä¸€å…± 200å—ï¼Œ102 å—åœ¨ç£ç›˜ï¼Œ98 å—åœ¨å†…å­˜ï¼Œé‚£ä¹ˆå¹³å‡éœ€è¦ $0 * (98/200)+ 1*(102/200)=0.5$ æ¬¡ I/Oã€‚ä¸€å…±éœ€è¦ $500 + 500*(0.5 + 1 or 2)$ æ¬¡ I/Oã€‚ æ•£åˆ—è¿æ¥ å‡è®¾å†…å­˜ç¼“å†²åŒºæœ‰ M ä¸ª block è¯»å–æ•´ä¸ª R1ï¼Œå°† R1 æ•£åˆ—åœ¨ M-1 ä¸ª block é‡Œé¢ï¼Œç„¶åé€ä¸ªè¯»å– R2 å—ï¼Œå’Œ R1 è¿›è¡Œæ•£åˆ—æŸ¥æ‰¾ç„¶å joinï¼Œä¸€å…± $cost=B(R_1)+B(R_2)$ è¯»å– R1 å’Œ R2ï¼Œç„¶åæ•£åˆ—åˆ†åˆ«å¾—åˆ° 100 ä¸ª buckets å­˜åœ¨ç£ç›˜ã€‚ç„¶åè¯»å– M-1 ä¸ª block çš„ R2 åˆ° bufferï¼Œç„¶åå†é¡ºåºè¯» R1 çš„ block å’Œ R2 è¿›è¡Œæ•£åˆ—è¿æ¥ã€‚ æœ‰æ²¡æœ‰å¯èƒ½ R1 æ•£åˆ—å‡ºæ¥çš„ R2 çš„ key ä¸åœ¨å†…å­˜é‡Œï¼Ÿæ¯•ç«Ÿ R2 æ²¡æœ‰å…¨éƒ¨è£…åˆ°å†…å­˜é‡Œã€‚ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå› ä¸ºå®ƒåˆ©ç”¨â€œç›¸åŒçš„æ•£åˆ—å‡½æ•°ï¼Œäº§ç”Ÿç›¸åŒçš„æ•£åˆ—å€¼â€è¿™ä¸€ç‰¹æ€§ã€‚å½“è¯» 1,2,3 å— R2 åˆ°å†…å­˜ï¼Œæˆ‘ä»¬å°±é¡ºåºåªå– 1,2,3 çš„ R1 åˆ°å†…å­˜ã€‚ æ•£åˆ—æ—¶å€™ä¸€è¯»ä¸€å†™ï¼Œæœ€åå„è¯»ä¸€æ¬¡ï¼š$cost=3*(B(R_1)+B(R_2)))$ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å½’å¹¶è¿æ¥-1"},{"categories":null,"content":" I/O ä»£ä»·ä¼°è®¡ åµŒå¥—ç´¢å¼•è¿æ¥æƒ…å†µä¸€ï¼šä¸è¿ç»­å­˜æ”¾ text è®¾: T(R1) = 10,000 T(R2) = 5,000 S(R1) = S(R2) = 1/10 block MEM = 101 blocks æœ´ç´ ç®—æ³•ï¼šå¯¹äºæ¯ä¸€ä¸ª R1ï¼Œæ¯æ¬¡æ‹¿å‡ºæ‰€æœ‰ R2 ä¸­æ‰€æœ‰å…ƒç´ è¿›è¡Œå¯¹æ¯”ï¼Œ I/O æ€»æ¬¡æ•°æ˜¯ $10000*(1+5000)=50010000$ æ¬¡ã€‚ æ”¹è¿›ç®—æ³•ï¼š R1 ä¸€å…±å  1000 å—ï¼ŒR2 ä¸€å…±å  500 å—ï¼Œå†…å­˜å…± 101 å— R1 å­˜ 100 å—åˆ°å†…å­˜ï¼ŒR2 å­˜ä¸€å— R2 ä¸æ–­å’Œå†…å­˜ä¸­çš„ R1 æ¯”è¾ƒï¼Œä¸€å—è¯»å®Œæ¢ä¸‹ä¸€å—ï¼Œæ€» I/O æ¬¡æ•°ä¸ºï¼š$10000(R1) + \\frac{10000}{100} * 5000=510000$ æ¬¡ ä¸è¿ç»­ï¼Œæ‰€ä»¥ä¸€å—ä¸€ä¸ªè®°å½•ã€‚R1 å  10000 å—ï¼ŒR2 å  5000 å—ã€‚ç„¶åæ¯è½®è¯» 100 å— R1, R2 5000 å—å…¨è¯»ä¸€éï¼Œç„¶åä¸€å…±10000/100è½®ï¼Œæ‰€ä»¥ $100*(100+5000)$ æ¬¡ I/Oã€‚ æ”¹è¿›ç®—æ³•2ï¼šè¿ç”¨äº¤æ¢å¾‹ $R_2 \\Join R_1$ $5000(R_2) + \\frac{5000}{100}*10000=505000$ æ¬¡ æƒ…å†µäºŒï¼šè¿ç»­å­˜æ”¾ æ”¹è¿›ç®—æ³•2ï¼šè¿ç”¨äº¤æ¢å¾‹ $R_2 \\Join R_1$ $500(R_2) + \\frac{500}{100}*1000=5500$ æ¬¡ æ”¹è¿›ç®—æ³•çš„ I/O æ€»æ¬¡æ•°ä¸ºï¼š$I/O = B(R_out) + âŒˆ B(R_out) / (M âˆ’ 1) âŒ‰ Ã— B(R_in)$ ã€‚è¿ç»­æ—¶å€™ $B=T*S$ï¼Œä¸è¿ç»­æ—¶å€™ $B=T$ï¼Œæ¯å—ä¸€ä¸ªè®°å½•ã€‚ å½’å¹¶è¿æ¥ è¿ç»­ä¸”æœ‰åºï¼š$1000(R_1)+500(R_2)=1500$ æ¬¡ I/Oï¼Œå°±æ˜¯å…¨éƒ¨è¯»è¿›å†…å­˜ã€‚ è¿ç»­ä¸”æ— åºï¼šå…ˆæŠŠå…ƒç´ è¿›è¡Œæ’åºï¼Œç„¶åå†å…¨éƒ¨è¯»è¿›å†…å­˜ã€‚å‡å¦‚ç”¨çš„å½’å¹¶æ’åº é˜¶æ®µä¸€ï¼šR1 çš„å—å…¨éƒ¨è¯»è¿› bufferï¼Œåœ¨å†…å­˜æ’åºåå†™ä¼šç£ç›˜ï¼Œæœ€ç»ˆå¾—åˆ° n chunkï¼Œæ¯ä¸ª chunk å†…éƒ¨æœ‰åº é˜¶æ®µäºŒï¼šä¸åŒ chunk ä¸­è¯»è¿› buffer è¿›è¡Œå½’å¹¶æ’åºï¼Œæœ€åè¿˜è¦å†™å›ç£ç›˜ è¯»å†™åˆ†åˆ«ä¸¤æ¬¡ï¼š$(2+2)*(1000+500)=6000$ï¼ŒåŠ ä¸Šä¹‹å‰è®¡ç®—çš„ 1500 æ¬¡ I/Oï¼Œä¸€å…± 7500 æ¬¡ I/O å’ŒåµŒå¥—ç´¢å¼•è¿æ¥å¯¹æ¯”ï¼Œå…³ç³»å°‘çš„æ—¶å€™åµŒå¥—ç´¢å¼•è¿æ¥åè€Œæ›´å¿«ï¼Œä½†æ˜¯å…³ç³»è¾ƒå¤§é€‰æ‹©å½’å¹¶è¿æ¥æ›´ä¼˜ã€‚ å‡è®¾ å†…å­˜ä¸­ buffer å—æ•°ä¸º kï¼Œè®°å½•ä¸€å…±å  x å—ï¼Œé‚£ä¹ˆ chunk æ•°ä¸º x/kã€‚ç”±äº chunk æ•°è¦å°ç­‰äº buffer å—æ•°ï¼Œæ‰€ä»¥æœ‰ $\\frac{x}{k} \\leq k$ å³ $\\sqrt{x} \\leq k$ ï¼Œå¯¹äºä¸Šé¢ä¾‹å­ R1 å  1000 å—ï¼ŒR2 å  500 å—ï¼Œéœ€è¦ buffer 32 å—ã€‚ ä¼˜åŒ–æ–¹æ³•æ˜¯åœ¨æ’åºäºŒé˜¶æ®µæ—¶å€™è¿æ¥ï¼Œéœ€è¦ $3*(B(R_1) + B(R_2))$ æ¬¡ I/Oã€‚ ç´¢å¼•è¿æ¥å‰é¢è¯´è¿‡ï¼Œç´¢å¼•è¿æ¥ç›¸è¾ƒäºåµŒå¥—ç´¢å¼•è¿æ¥ä¼˜åŠ¿å°±æ˜¯ï¼šæŠŠå†…å­˜å¾ªç¯å®Œæ•´éå†ï¼Œå˜æˆåªéœ€è¦éå†ç´¢å¼•èŠ‚ç‚¹ã€‚æ‰€ä»¥ç´¢å¼•è¿æ¥çš„ä»£ä»·å°±æ˜¯å¤–å±‚ block è¯»å– + å†…å±‚ç´¢å¼•çš„ block è¯»å–ã€‚ å¤–å±‚ block è¯»å–æ˜¯å…¨éƒ¨è¯»å–ï¼Œå¼€é”€å›ºå®š ä½†æ˜¯å†…å±‚ç´¢å¼•æ•°é‡ä¸ç¡®å®šï¼Œæ€ä¹ˆè®¡ç®—å¼€é”€ï¼Ÿ Cost=B(R2)+T(R2)âˆ—p Cost = B(R_2) + T(R_2)*p Cost=B(R2â€‹)+T(R2â€‹)âˆ—p è‹¥ R1.C æ˜¯ä¸»é”®, å³ R1.C å”¯ä¸€, é€‰æ‹©åŸºæ•° p = 1 è‹¥ R1.C ä¸å”¯ä¸€ï¼ŒV(R1,C)=5,000, T(R1) = 10,000, åˆ™æ¯ä¸ª R2 tuple åœ¨ R1 ä¸­çš„é€‰æ‹©åŸºæ•°$p = \\frac{T(R_1)}{V(R_1,C)}=2$ å‡è®¾ R1.C çš„ç´¢å¼•ä¸æ˜¯å…¨éƒ¨åœ¨å†…å­˜ï¼Œä¸€å…± 200å—ï¼Œ102 å—åœ¨ç£ç›˜ï¼Œ98 å—åœ¨å†…å­˜ï¼Œé‚£ä¹ˆå¹³å‡éœ€è¦ $0 * (98/200)+ 1*(102/200)=0.5$ æ¬¡ I/Oã€‚ä¸€å…±éœ€è¦ $500 + 500*(0.5 + 1 or 2)$ æ¬¡ I/Oã€‚ æ•£åˆ—è¿æ¥ å‡è®¾å†…å­˜ç¼“å†²åŒºæœ‰ M ä¸ª block è¯»å–æ•´ä¸ª R1ï¼Œå°† R1 æ•£åˆ—åœ¨ M-1 ä¸ª block é‡Œé¢ï¼Œç„¶åé€ä¸ªè¯»å– R2 å—ï¼Œå’Œ R1 è¿›è¡Œæ•£åˆ—æŸ¥æ‰¾ç„¶å joinï¼Œä¸€å…± $cost=B(R_1)+B(R_2)$ è¯»å– R1 å’Œ R2ï¼Œç„¶åæ•£åˆ—åˆ†åˆ«å¾—åˆ° 100 ä¸ª buckets å­˜åœ¨ç£ç›˜ã€‚ç„¶åè¯»å– M-1 ä¸ª block çš„ R2 åˆ° bufferï¼Œç„¶åå†é¡ºåºè¯» R1 çš„ block å’Œ R2 è¿›è¡Œæ•£åˆ—è¿æ¥ã€‚ æœ‰æ²¡æœ‰å¯èƒ½ R1 æ•£åˆ—å‡ºæ¥çš„ R2 çš„ key ä¸åœ¨å†…å­˜é‡Œï¼Ÿæ¯•ç«Ÿ R2 æ²¡æœ‰å…¨éƒ¨è£…åˆ°å†…å­˜é‡Œã€‚ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå› ä¸ºå®ƒåˆ©ç”¨â€œç›¸åŒçš„æ•£åˆ—å‡½æ•°ï¼Œäº§ç”Ÿç›¸åŒçš„æ•£åˆ—å€¼â€è¿™ä¸€ç‰¹æ€§ã€‚å½“è¯» 1,2,3 å— R2 åˆ°å†…å­˜ï¼Œæˆ‘ä»¬å°±é¡ºåºåªå– 1,2,3 çš„ R1 åˆ°å†…å­˜ã€‚ æ•£åˆ—æ—¶å€™ä¸€è¯»ä¸€å†™ï¼Œæœ€åå„è¯»ä¸€æ¬¡ï¼š$cost=3*(B(R_1)+B(R_2)))$ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç´¢å¼•è¿æ¥-1"},{"categories":null,"content":" I/O ä»£ä»·ä¼°è®¡ åµŒå¥—ç´¢å¼•è¿æ¥æƒ…å†µä¸€ï¼šä¸è¿ç»­å­˜æ”¾ text è®¾: T(R1) = 10,000 T(R2) = 5,000 S(R1) = S(R2) = 1/10 block MEM = 101 blocks æœ´ç´ ç®—æ³•ï¼šå¯¹äºæ¯ä¸€ä¸ª R1ï¼Œæ¯æ¬¡æ‹¿å‡ºæ‰€æœ‰ R2 ä¸­æ‰€æœ‰å…ƒç´ è¿›è¡Œå¯¹æ¯”ï¼Œ I/O æ€»æ¬¡æ•°æ˜¯ $10000*(1+5000)=50010000$ æ¬¡ã€‚ æ”¹è¿›ç®—æ³•ï¼š R1 ä¸€å…±å  1000 å—ï¼ŒR2 ä¸€å…±å  500 å—ï¼Œå†…å­˜å…± 101 å— R1 å­˜ 100 å—åˆ°å†…å­˜ï¼ŒR2 å­˜ä¸€å— R2 ä¸æ–­å’Œå†…å­˜ä¸­çš„ R1 æ¯”è¾ƒï¼Œä¸€å—è¯»å®Œæ¢ä¸‹ä¸€å—ï¼Œæ€» I/O æ¬¡æ•°ä¸ºï¼š$10000(R1) + \\frac{10000}{100} * 5000=510000$ æ¬¡ ä¸è¿ç»­ï¼Œæ‰€ä»¥ä¸€å—ä¸€ä¸ªè®°å½•ã€‚R1 å  10000 å—ï¼ŒR2 å  5000 å—ã€‚ç„¶åæ¯è½®è¯» 100 å— R1, R2 5000 å—å…¨è¯»ä¸€éï¼Œç„¶åä¸€å…±10000/100è½®ï¼Œæ‰€ä»¥ $100*(100+5000)$ æ¬¡ I/Oã€‚ æ”¹è¿›ç®—æ³•2ï¼šè¿ç”¨äº¤æ¢å¾‹ $R_2 \\Join R_1$ $5000(R_2) + \\frac{5000}{100}*10000=505000$ æ¬¡ æƒ…å†µäºŒï¼šè¿ç»­å­˜æ”¾ æ”¹è¿›ç®—æ³•2ï¼šè¿ç”¨äº¤æ¢å¾‹ $R_2 \\Join R_1$ $500(R_2) + \\frac{500}{100}*1000=5500$ æ¬¡ æ”¹è¿›ç®—æ³•çš„ I/O æ€»æ¬¡æ•°ä¸ºï¼š$I/O = B(R_out) + âŒˆ B(R_out) / (M âˆ’ 1) âŒ‰ Ã— B(R_in)$ ã€‚è¿ç»­æ—¶å€™ $B=T*S$ï¼Œä¸è¿ç»­æ—¶å€™ $B=T$ï¼Œæ¯å—ä¸€ä¸ªè®°å½•ã€‚ å½’å¹¶è¿æ¥ è¿ç»­ä¸”æœ‰åºï¼š$1000(R_1)+500(R_2)=1500$ æ¬¡ I/Oï¼Œå°±æ˜¯å…¨éƒ¨è¯»è¿›å†…å­˜ã€‚ è¿ç»­ä¸”æ— åºï¼šå…ˆæŠŠå…ƒç´ è¿›è¡Œæ’åºï¼Œç„¶åå†å…¨éƒ¨è¯»è¿›å†…å­˜ã€‚å‡å¦‚ç”¨çš„å½’å¹¶æ’åº é˜¶æ®µä¸€ï¼šR1 çš„å—å…¨éƒ¨è¯»è¿› bufferï¼Œåœ¨å†…å­˜æ’åºåå†™ä¼šç£ç›˜ï¼Œæœ€ç»ˆå¾—åˆ° n chunkï¼Œæ¯ä¸ª chunk å†…éƒ¨æœ‰åº é˜¶æ®µäºŒï¼šä¸åŒ chunk ä¸­è¯»è¿› buffer è¿›è¡Œå½’å¹¶æ’åºï¼Œæœ€åè¿˜è¦å†™å›ç£ç›˜ è¯»å†™åˆ†åˆ«ä¸¤æ¬¡ï¼š$(2+2)*(1000+500)=6000$ï¼ŒåŠ ä¸Šä¹‹å‰è®¡ç®—çš„ 1500 æ¬¡ I/Oï¼Œä¸€å…± 7500 æ¬¡ I/O å’ŒåµŒå¥—ç´¢å¼•è¿æ¥å¯¹æ¯”ï¼Œå…³ç³»å°‘çš„æ—¶å€™åµŒå¥—ç´¢å¼•è¿æ¥åè€Œæ›´å¿«ï¼Œä½†æ˜¯å…³ç³»è¾ƒå¤§é€‰æ‹©å½’å¹¶è¿æ¥æ›´ä¼˜ã€‚ å‡è®¾ å†…å­˜ä¸­ buffer å—æ•°ä¸º kï¼Œè®°å½•ä¸€å…±å  x å—ï¼Œé‚£ä¹ˆ chunk æ•°ä¸º x/kã€‚ç”±äº chunk æ•°è¦å°ç­‰äº buffer å—æ•°ï¼Œæ‰€ä»¥æœ‰ $\\frac{x}{k} \\leq k$ å³ $\\sqrt{x} \\leq k$ ï¼Œå¯¹äºä¸Šé¢ä¾‹å­ R1 å  1000 å—ï¼ŒR2 å  500 å—ï¼Œéœ€è¦ buffer 32 å—ã€‚ ä¼˜åŒ–æ–¹æ³•æ˜¯åœ¨æ’åºäºŒé˜¶æ®µæ—¶å€™è¿æ¥ï¼Œéœ€è¦ $3*(B(R_1) + B(R_2))$ æ¬¡ I/Oã€‚ ç´¢å¼•è¿æ¥å‰é¢è¯´è¿‡ï¼Œç´¢å¼•è¿æ¥ç›¸è¾ƒäºåµŒå¥—ç´¢å¼•è¿æ¥ä¼˜åŠ¿å°±æ˜¯ï¼šæŠŠå†…å­˜å¾ªç¯å®Œæ•´éå†ï¼Œå˜æˆåªéœ€è¦éå†ç´¢å¼•èŠ‚ç‚¹ã€‚æ‰€ä»¥ç´¢å¼•è¿æ¥çš„ä»£ä»·å°±æ˜¯å¤–å±‚ block è¯»å– + å†…å±‚ç´¢å¼•çš„ block è¯»å–ã€‚ å¤–å±‚ block è¯»å–æ˜¯å…¨éƒ¨è¯»å–ï¼Œå¼€é”€å›ºå®š ä½†æ˜¯å†…å±‚ç´¢å¼•æ•°é‡ä¸ç¡®å®šï¼Œæ€ä¹ˆè®¡ç®—å¼€é”€ï¼Ÿ Cost=B(R2)+T(R2)âˆ—p Cost = B(R_2) + T(R_2)*p Cost=B(R2â€‹)+T(R2â€‹)âˆ—p è‹¥ R1.C æ˜¯ä¸»é”®, å³ R1.C å”¯ä¸€, é€‰æ‹©åŸºæ•° p = 1 è‹¥ R1.C ä¸å”¯ä¸€ï¼ŒV(R1,C)=5,000, T(R1) = 10,000, åˆ™æ¯ä¸ª R2 tuple åœ¨ R1 ä¸­çš„é€‰æ‹©åŸºæ•°$p = \\frac{T(R_1)}{V(R_1,C)}=2$ å‡è®¾ R1.C çš„ç´¢å¼•ä¸æ˜¯å…¨éƒ¨åœ¨å†…å­˜ï¼Œä¸€å…± 200å—ï¼Œ102 å—åœ¨ç£ç›˜ï¼Œ98 å—åœ¨å†…å­˜ï¼Œé‚£ä¹ˆå¹³å‡éœ€è¦ $0 * (98/200)+ 1*(102/200)=0.5$ æ¬¡ I/Oã€‚ä¸€å…±éœ€è¦ $500 + 500*(0.5 + 1 or 2)$ æ¬¡ I/Oã€‚ æ•£åˆ—è¿æ¥ å‡è®¾å†…å­˜ç¼“å†²åŒºæœ‰ M ä¸ª block è¯»å–æ•´ä¸ª R1ï¼Œå°† R1 æ•£åˆ—åœ¨ M-1 ä¸ª block é‡Œé¢ï¼Œç„¶åé€ä¸ªè¯»å– R2 å—ï¼Œå’Œ R1 è¿›è¡Œæ•£åˆ—æŸ¥æ‰¾ç„¶å joinï¼Œä¸€å…± $cost=B(R_1)+B(R_2)$ è¯»å– R1 å’Œ R2ï¼Œç„¶åæ•£åˆ—åˆ†åˆ«å¾—åˆ° 100 ä¸ª buckets å­˜åœ¨ç£ç›˜ã€‚ç„¶åè¯»å– M-1 ä¸ª block çš„ R2 åˆ° bufferï¼Œç„¶åå†é¡ºåºè¯» R1 çš„ block å’Œ R2 è¿›è¡Œæ•£åˆ—è¿æ¥ã€‚ æœ‰æ²¡æœ‰å¯èƒ½ R1 æ•£åˆ—å‡ºæ¥çš„ R2 çš„ key ä¸åœ¨å†…å­˜é‡Œï¼Ÿæ¯•ç«Ÿ R2 æ²¡æœ‰å…¨éƒ¨è£…åˆ°å†…å­˜é‡Œã€‚ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå› ä¸ºå®ƒåˆ©ç”¨â€œç›¸åŒçš„æ•£åˆ—å‡½æ•°ï¼Œäº§ç”Ÿç›¸åŒçš„æ•£åˆ—å€¼â€è¿™ä¸€ç‰¹æ€§ã€‚å½“è¯» 1,2,3 å— R2 åˆ°å†…å­˜ï¼Œæˆ‘ä»¬å°±é¡ºåºåªå– 1,2,3 çš„ R1 åˆ°å†…å­˜ã€‚ æ•£åˆ—æ—¶å€™ä¸€è¯»ä¸€å†™ï¼Œæœ€åå„è¯»ä¸€æ¬¡ï¼š$cost=3*(B(R_1)+B(R_2)))$ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ•£åˆ—è¿æ¥-1"},{"categories":null,"content":" è¯¾åé¢˜ text å›ºæ€ç¡¬ç›˜(Solid State Drive,SSD)æ˜¯ä¸€ç§åŸºäºé—ªå­˜çš„æ–°å‹å­˜å‚¨å™¨ï¼Œå®ƒä¸ä¼ ç»Ÿç£ç›˜çš„ä¸»è¦åŒºåˆ«ä¹‹æ˜¯ï¼šä¼ ç»Ÿç£ç›˜çš„è¯»å†™æ“ä½œçš„é€Ÿåº¦ç›¸åŒï¼Œè€ŒSSDçš„è¯»é€Ÿåº¦è¿œå¿«äºå†™é€Ÿåº¦ã€‚åŒæ—¶ï¼ŒSSDçš„è¯»é€Ÿåº¦è¦è¿œé«˜äºç£ç›˜ï¼Œè€Œå†™é€Ÿåº¦åˆ™æ¯”ç£ç›˜æ…¢ã€‚ç°åœ¨æˆ‘ä»¬æƒ³å°†ä¼ ç»Ÿçš„ä¸¤é˜¶æ®µå¤šè·¯å½’å¹¶æ’åºç®—æ³•ç§»æ¤åˆ°SSDä¸Šã€‚å‡è®¾SSDä¸Šä¸€æ¬¡è¯»å—æ“ä½œçš„æ—¶é—´æ˜¯t,ä¸€æ¬¡å†™å—æ“ä½œçš„æ—¶é—´æ˜¯50t,ç£ç›˜ä¸Šçš„è¯»/å†™å—æ—¶é—´æ˜¯30tã€‚å¯¹äºç»™å®šå…³ç³»R: - RåŒ…å«100000ä¸ªå…ƒç»„ï¼Œå³T(R)=100000 - ä¸€ä¸ªç£ç›˜å—å¤§å°ä¸º4000 bytes. - Rçš„å…ƒç»„å¤§å°ä¸º400 bytes,å³S(R)=400. - å…³ç³»Råœ¨ç£ç›˜ä¸Šéè¿ç»­å­˜æ”¾ - æ’åºå­—æ®µçš„å¤§å°ä¸º32 bytes.. - è®°å½•æŒ‡é’ˆçš„å¤§å°ä¸º8 bytes. ç°åœ¨æˆ‘ä»¬è€ƒè™‘ä¸‹é¢ä¸€ç§æ”¹è¿›çš„å½’å¹¶æ’åºç®—æ³•ã€‚åŸæ¥çš„ä¸¤é˜¶æ®µå½’å¹¶æ’åºçš„ç¬¬ä¸€é˜¶æ®µæ˜¯å°†æ’åºåçš„æ•´ä¸ªå…ƒç»„å†™åˆ°chunkä¸­ï¼Œç°åœ¨æˆ‘ä»¬ä»…å°†æ’åºåçš„\u003csortingKey,recordPointer\u003eå†™å‡ºã€‚ç¬¬ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬åœ¨å†…å­˜ä¸­å°†è®°å½•æŒ‰\u003csortingKey,recordPointer\u003eæ’åºï¼Œå½“\u003csortingKey,recordPointer\u003eè®°å½•å¡«æ»¡å†…å­˜æ—¶å°†å…¶å†™åˆ°chunkä¸­ã€‚ç¬¬äºŒé˜¶æ®µï¼Œè¯»å…¥å„ä¸ªchunkä¸­çš„\u003csortingKey,recordPointer\u003eå¹¶åœ¨å†…å­˜ä¸­å½’å¹¶ã€‚é€šè¿‡è®°å½•æŒ‡é’ˆ(recordPointer)æˆ‘ä»¬å¯ä»¥è¯»å–è®°å½•çš„å…¶å®ƒéƒ¨åˆ†(ä»Rçš„ç£ç›˜å—ä¸­)ï¼Œå¹¶å°†æ’å¥½åºçš„è®°å½•å†™å›åˆ°å¤– å­˜ã€‚è¯·å›ç­”ï¼š (1)å¦‚æœRå­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œè¿™ä¸€æ”¹è¿›æ’åºç®—æ³•çš„I/Oä»£ä»·ï¼ˆç”¨tçš„è¡¨è¾¾å¼è¡¨ç¤ºï¼ŒåŒ…æ‹¬æœ€åå†™å‡ºåˆ°æ’åºæ–‡ä»¶ä¸­çš„ä»£ä»·)æ˜¯å¤šå°‘ï¼Ÿå¹¶è§£é‡Šè¯¥ç®—æ³•æ€§èƒ½æ˜¯å¦èƒ½ä¼˜äºåŸæ¥çš„æ’åºç®—æ³•ã€‚ (2)å¦‚æœRå­˜å‚¨åœ¨SSDä¸Šï¼Œè¿™ä¸€æ”¹è¿›æ’åºç®—æ³•çš„I/Oä»£ä»·ï¼ˆç”¨tçš„è¡¨è¾¾å¼è¡¨ç¤ºï¼ŒåŒ…æ‹¬æœ€åå†™å‡ºåˆ°æ’åºæ–‡ä»¶ä¸­çš„ä»£ä»·)æ˜¯å¤šå°‘ï¼Ÿå¹¶è§£é‡Šè¯¥ç®—æ³•æ€§èƒ½æ˜¯å¦èƒ½ä¼˜äºåŸæ¥çš„æ’åºç®—æ³•ã€‚ text æˆ‘ä»¬åœ¨è¯¾æœ¬ä¸Šè®¨è®ºçš„å½’å¹¶æ’åºç®—æ³•æ˜¯ä¸€ä¸ªä¸¤è¶Ÿç®—æ³•ã€‚è®¾ä¸¤ä¸ªè¿æ¥å…³ç³»ä¸ºR1å’ŒR2,åœ¨åŸºäºä¸¤è¶Ÿå½’å¹¶æ’åºçš„æ’åºè¿æ¥ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬è¦æ±‚å†…å­˜Må¿…é¡»æ»¡è¶³æ¡ä»¶Mâ‰¥maxR1,.âˆšR2}ã€‚ç°åœ¨æˆ‘ä»¬è€ƒæŸ¥å…³ç³»Rçš„ä¸¤è¶Ÿå½’å¹¶æ’åºç®—æ³•ï¼Œæˆ‘ä»¬å‘ç°å½“å†…å­˜Mä¸æ»¡è¶³æ¡ä»¶Mâ‰¥âˆšRæ—¶ï¼Œæˆ‘ä»¬ä»å¯ä»¥é‡‡ç”¨ä¸€ç§å¤šè¶Ÿç®—æ³•æ¥å®Œæˆå½’å¹¶æ’åºæ“ä½œã€‚è¯·ç”¨è‡ªç„¶è¯­è¨€æˆ–ä¼ªç ç»™å‡ºè¿™ä¸€å¤šè¶Ÿå½’å¹¶è¿æ¥ç®—æ³•çš„ç®€è¦æè¿°å’Œæ­¥éª¤ï¼Œå¹¶ç»™å‡ºå½“B(R1)=10000,B(R2)=5000,M=20æ—¶è¯¥ç®—æ³•çš„I/Oä»£ä»·ï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾R1å’ŒR2éƒ½æ˜¯è¿ç»­å­˜æ”¾çš„ã€‚ æ€è·¯ï¼šé€šè¿‡å¤šè¶Ÿå½’å¹¶ã€‚å½“Mä¸æ»¡è¶³æ¡ä»¶Mâ‰¥âˆšRç®—æ³•å¤±æ•ˆçš„åŸå› æ˜¯ï¼ŒB(R)å—è®°å½•è¯»è¿›å†…å­˜ï¼Œå†…å­˜åªèƒ½å­˜Må—ï¼Œæ‰€ä»¥è®°å½•ä¼šè¢«åˆ†ä¸º $\\frac{B(R)}{M}$ ä¸ª chunkï¼Œæ¯ä¸ª chunk å†…éƒ¨æœ‰åºï¼Œå½“ chunk æ•°é‡è¶…è¿‡ Mï¼Œæˆ‘ä»¬å°±æ²¡æ³•æŠŠæ¯ä¸ª chunk è¯»è¿›å†…å­˜ã€‚è§£å†³æ–¹æ³•å°±æ˜¯å¯¹ M å— chunk å…ˆè¯»è¿›å†…å­˜æ’åºï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¾—åˆ° M * chunk å¤§å°çš„æ–° chunkï¼Œè¿™é‡Œé¢æ˜¯æœ‰åºçš„ï¼Œå¹¶ä¸”æ€» chunk æ•°å‡å°‘äº†ï¼Œæˆ‘ä»¬å¯ä»¥é‡å¤è¿™ä¸ªæ“ä½œï¼Œç›´åˆ° chunk æ•°å°ç­‰äº Mã€‚è®¡ç®—ç•¥: text æŸ¥è¯¢å¤„ç†å™¨åœ¨å›ç­”æ¶‰åŠR(A,B)å’ŒS(B,C)çš„æŸ¥è¯¢ \"Select R.*,S.*From R,S Where R.B=s.B and R.B\u003c\u003e10\"æ—¶ï¼Œç”Ÿæˆäº†é€»è¾‘æŸ¥è¯¢è®¡åˆ’oR.Bâ‰ 1o(R)å‡¶OR.B1o(S),å·²çŸ¥æœ‰å…³å‚æ•°å¦‚ä¸‹ï¼šRå’ŒSçš„å…ƒç»„éƒ½æ˜¯å®šé•¿çš„ï¼Œé•¿åº¦å‡ä¸º40å­—èŠ‚ã€‚é¡µå¤§å°ä¸º4000å­—èŠ‚ã€‚T(R)=500000,T(s)=100000,V(R,A)=100,V(R,B)=25,V(S,B)=25,V(S,C)=30ã€‚Rå’ŒSéƒ½åœ¨ç£ç›˜ä¸Šï¼Œä¸”Rä¸ºè¿ç»­å­˜å‚¨ï¼ŒSä¸ºä¸è¿ç»­å­˜å‚¨ã€‚å¯ç”¨å†…å­˜Mçš„å¤§å°ä¸º148ä¸ªé¡µã€‚ å¯¹äºä¸Šè¿°æŸ¥è¯¢è®¡åˆ’ä¸­çš„è¿æ¥æ“ä½œï¼Œæˆ‘ä»¬é‡‡ç”¨ä¸€ç§æ”¹è¿›çš„æ•£åˆ—è¿æ¥ç®—æ³•ã€‚è®¾è¿æ¥å…³ç³»ä¸º1å’Œ2å¯¹åº”çš„æ¡¶æ•°ç»„åˆ†åˆ«ä¸ºGå’ŒH: (1)æ•£åˆ—1æ—¶å°†å…¶ä¸­çš„1ä¸ªæ¡¶ï¼ˆè®¾G),æ”¾åœ¨å†…å­˜ä¸­ä¸å†™åˆ°ç£ç›˜ä¸­ï¼Œå…¶ä½™çš„æ¡¶å†™å…¥ç£ç›˜ï¼š (2)æ•£åˆ—R2æ—¶ï¼Œå°†è½åœ¨æ¡¶H1ä¸­çš„å…ƒç»„ç›´æ¥ä¸å†…å­˜ä¸­çš„G1æ¡¶ä¸­çš„å…ƒç»„è¿›è¡Œè¿æ¥ï¼Œå¹¶è¾“å‡ºè¿æ¥ ç»“æœï¼Œå…¶ä½™çš„æ¡¶å†™å…¥ç£ç›˜ï¼› (3)å¯¹ç£ç›˜ä¸­é™¤G1å’ŒH1æ¡¶å¤–çš„å…¶ä½™æ¡¶æ‰§è¡Œæ¡¶å¯¹æ¡¶çš„è¿æ¥å¹¶è¾“å‡ºè¿æ¥ç»“æœï¼›ï¼š (4)ä¸ºäº†å‡å°‘I/0ä»£ä»·ï¼Œæˆ‘ä»¬å¸Œæœ›å†…å­˜ä¸­çš„G1èƒ½å¤Ÿå°½å¯èƒ½åœ°å¤§ã€‚ æ‰€æœ‰ä¸­é—´ç»“æœå‡é‡‡ç”¨ç‰©åŒ–æ–¹å¼ä¼ é€’ã€‚è¯·ä¼°è®¡æ­¤æŸ¥è¯¢è®¡åˆ’çš„I/0ä»£ä»·ã€‚ text æŸ¥è¯¢å¤„ç†å™¨åœ¨å›ç­”æ¶‰åŠ R(A,B) å’Œ S(B,C) çš„æŸ¥è¯¢ â€œSelect * From R,S Where R.B=S.B and R.B=12â€ æ—¶ï¼Œç”Ÿæˆäº†ä¸‹é¢çš„é€»è¾‘æŸ¥è¯¢è®¡åˆ’ï¼šğœ_(ğ‘….ğµ=12 and ğ‘….ğµ=ğ‘†.ğµ) (ğ‘…â‹ˆğ‘†)ï¼Œå·²çŸ¥æœ‰å…³å‚æ•°ä¸º Rå’ŒSçš„å…ƒç»„éƒ½æ˜¯å®šé•¿çš„ï¼Œæ¯ä¸ªæ•°æ®å—å¯ä»¥å­˜å‚¨10ä¸ªå…ƒç»„ Rå’ŒSåœ¨ç£ç›˜å‡ä¸è¿ç»­å­˜å‚¨ ä¸­é—´ç»“æœé€šè¿‡ç‰©åŒ–æ–¹å¼ä¼ é€’ï¼› T(R)=10000, V(R,A)=100, V(R,B)=10, T(S)=5000, V(S,B)=50, V(S,C)=500 å‡è®¾ä¸Šè¿°é€»è¾‘æŸ¥è¯¢è®¡åˆ’åœ¨æŸ¥è¯¢é‡å†™é˜¶æ®µåº”ç”¨äº†ä¸‹æ¨é€‰æ‹©è§„åˆ™ï¼Œä¹‹åé‡‡ç”¨æ•£åˆ—è¿æ¥ç®—æ³•æ‰§è¡Œè¿æ¥æŸ¥è¯¢ï¼Œè¯·ä¼°è®¡è¯¥æŸ¥è¯¢çš„I/Oä»£ä»·ï¼ˆå‡è®¾å†…å­˜æ»¡è¶³æ‰§è¡Œæ•£åˆ—è¿æ¥çš„æœ€ä½è¦æ±‚ï¼‰ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:7:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è¯¾åé¢˜-4"},{"categories":null,"content":" ç¬¬å…«ç«  äº‹åŠ¡ç®¡ç†","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¬¬å…«ç« -äº‹åŠ¡ç®¡ç†"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ \u003cStart T\u003eï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ \u003cCommit T\u003eï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ \u003cAbort T\u003eï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• \u003cStart T\u003e å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ \u003cT, x, old_value\u003e ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† \u003cCommit T\u003e è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text \u003cStart T\u003e \u003cT, A, 1000\u003e \u003cT, B, 2000\u003e \u003cCommit T\u003e æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  \u003cCommit T\u003e å’Œ \u003cAbort T\u003e çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª \u003cT, x, v\u003e ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥\u003cAbort T\u003eåˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰\u003cCommit T\u003eçš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ª\u003cT, x, v\u003eï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥\u003cAbort T\u003eåˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰\u003cCommit T\u003eï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— \u003cCommit T\u003eä¸”æ— \u003cAbort T\u003eï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ª\u003cT, x, v, w\u003eï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ª\u003cT, x, v, w\u003eï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥\u003cAbort T\u003eåˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ—¥å¿—æ¢å¤"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#äº‹åŠ¡"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å®šä¹‰"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#acid-æ€§è´¨"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#äº‹åŠ¡çŠ¶æ€"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#åŸè¯­æ“ä½œ"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ•…éšœ"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ¢å¤ç­–ç•¥"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#undo-æ—¥å¿—"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#redo-æ—¥å¿—"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ä¸¤ç§æ›´æ–°æ–¹å¼"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#undoredo-æ—¥å¿—"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#checkpoint"},{"categories":null,"content":" æ—¥å¿—\u0026æ¢å¤ æ—¥å¿—åªè®°å½•æ•°æ®åº“çš„ DML æ“ä½œã€‚ ä¸€è‡´çŠ¶æ€ï¼šæ•°æ®åº“æ»¡è¶³æ‰€æœ‰å®Œæ•´æ€§çº¦æŸçš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šæ‰€æœ‰è´¦æˆ·ä½™é¢æ€»å’Œ = TOTã€å­—æ®µ color çš„å–å€¼åªèƒ½æ˜¯çº¢ã€è“ã€ç»¿ã€‚ ä¸€è‡´æ•°æ®åº“ï¼šæ»¡è¶³ä¸€è‡´çŠ¶æ€çš„æ•°æ®åº“ äº‹åŠ¡ å®šä¹‰ä¸å¯åˆ†å‰²çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¾‹å¦‚ï¼šé“¶è¡Œè½¬å¸ï¼šAå¸æˆ·è½¬å¸åˆ°Bå¸æˆ·100å…ƒã€‚è¯¥å¤„ç†åŒ…æ‹¬äº†ä¸¤ä¸ªæ›´æ–°æ­¥éª¤ï¼šA=A-100 å’ŒB=B+100ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†çš„ï¼šè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ACID æ€§è´¨ åŸå­æ€§(Atomicity)ï¼šåŒä¸€ä¸ªäº‹åŠ¡çš„è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ ä¸€è‡´æ€§(Consistency)ï¼šå¦‚æœäº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºä¸€è‡´çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œåä»ç„¶ä¸ºä¸€è‡´çŠ¶æ€ éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡ä¹‹é—´ä¸å—å½±å“ è€ç”¨æ€§(Durability)ï¼šå°†æ•°æ®æŒä¹…åŒ– äº‹åŠ¡çŠ¶æ€ ï¼šäº‹åŠ¡ T å¼€å§‹æ‰§è¡Œ ï¼šäº‹åŠ¡ T æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä¿®æ”¹å·²å†™å…¥ç£ç›˜ ï¼šäº‹åŠ¡ T ç»ˆæ­¢ï¼Œæ‰€æœ‰ä¿®æ”¹å·²æ’¤é”€ åŸè¯­æ“ä½œ Input (x)ï¼šå°†ç£ç›˜ä¸­åŒ…å« x çš„æ•°æ®å—è¯»å…¥å†…å­˜ç¼“å†²åŒº Output (x)ï¼šå°†å†…å­˜ç¼“å†²åŒºä¸­åŒ…å« x çš„æ•°æ®å—å†™å…¥ç£ç›˜ Read (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†ç¼“å†²åŒºä¸­ x çš„å€¼èµ‹ç»™å˜é‡ t Write (x,t)ï¼šå¿…è¦æ—¶æ‰§è¡Œ Input (x)ï¼Œå°†å˜é‡ t çš„å€¼æ›´æ–°åˆ°ç¼“å†²åŒºä¸­çš„ x å¯¹äºåˆšåˆšé“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œå¯ä»¥å†™ä¸ºï¼š text Read(A, t); t = t - 100; Write(A, t); Read(B, t); t = t + 100; Write(B, t); Output(A); Output(B); æ•…éšœ äº‹åŠ¡æ•…éšœï¼šä¾‹å¦‚è½¬è´¦ä½™é¢ä¸å¤Ÿã€è¿ç®—ç§»é™¤ç­‰ç­‰ ä»‹è´¨æ•…éšœï¼šç£ç›˜æŸå ç³»ç»Ÿæ•…éšœï¼šæ–­ç”µï¼ŒOS æ•…éšœç­‰ç­‰ äº‹åŠ¡æ•…éšœæ¯”è¾ƒå¥½è§£å†³ï¼Œåœ¨ exception æ—¶å€™ è¿›è¡Œä¸€ä¸ª rollbackå°±å¥½ã€‚ä»‹è´¨æ•…éšœå’Œç³»ç»Ÿæ•…éšœéœ€è¦é€šè¿‡ä¸€å®šçš„æ¢å¤ç­–ç•¥ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å­˜å‚¨å†—ä½™æ•°æ®ã€‚ ä¸¤å¤§å®ç°æ‰‹æ®µï¼š å®šæœŸè½¬å‚¨ï¼šåˆ¶ä½œæ•°æ®åº“å®Œæ•´å‰¯æœ¬ï¼ˆåº”å¯¹ä»‹è´¨æ•…éšœï¼‰ äº‹åŠ¡æ—¥å¿—ï¼šWAL è®°å½•æ‰€æœ‰äº‹åŠ¡çš„æ“ä½œç»†èŠ‚ï¼ˆåº”å¯¹äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼‰ é€šç”¨æ¢å¤æµç¨‹ï¼š ä»‹è´¨æ•…éšœï¼šå…ˆé‡è£…æ•°æ®åº“å‰¯æœ¬ï¼Œå†é€šè¿‡æ—¥å¿—æ¢å¤åˆ°æ•…éšœå‘ç”Ÿç‚¹ï¼› äº‹åŠ¡ / ç³»ç»Ÿæ•…éšœï¼šç›´æ¥é€šè¿‡æ—¥å¿—æ’¤é”€æœªæäº¤äº‹åŠ¡ã€é‡åšå·²æäº¤ä½†æœªå†™ç›˜çš„äº‹åŠ¡ã€‚ æ¢å¤ç­–ç•¥ Undo æ—¥å¿—Undo é¡¾åæ€ä¹‰ä¸º æ’¤é”€ï¼Œæ‰€ä»¥ Undo æ—¥å¿—çš„ä½œç”¨æ˜¯æ’¤é”€æ“ä½œï¼Œé‚£ä¹ˆå®ƒåªéœ€è¦è®°å½•æ¯ä¸€æ­¥æ“ä½œä¹‹å‰çš„ old value å°±å¥½ã€‚ äº‹åŠ¡å¼€å§‹æ—¶å€™ä¼šåœ¨ Undo æ—¥å¿—ä¸­è®°å½• å¼€å§‹æ ‡è®° äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šç”Ÿæˆ ï¼Œå…ˆè®°å½• LOG å†æŠŠæ•°æ®å†™ç£ç›˜(WAL)ã€‚ äº‹åŠ¡æ‰€æœ‰æ“ä½œéƒ½å†™å…¥ç£ç›˜ï¼Œä¼šå°† è®°å½•åˆ°ç£ç›˜ã€‚ å¯¹äºä¹‹å‰è½¬è´¦çš„ä¾‹å­ï¼ˆå‡è®¾ A åˆå€¼ä¸º 1000ï¼ŒB åˆå€¼ä¸º 2000ï¼‰å¯ä»¥å†™ä¸ºï¼š text æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æ—  å’Œ çš„äº‹åŠ¡ï¼ˆè‚¯å®šæ˜¯æœªå®Œæˆå°±å‡ºé”™çš„äº‹åŠ¡ï¼‰ï¼Œæ”¾å…¥åˆ—è¡¨ Lã€‚ ä»æ—¥å¿—å°¾éƒ¨åå‘æ‰«æï¼Œå¯¹ L ä¸­æ¯ä¸ª ï¼Œæ‰§è¡Œ Write(x, v)ï¼ˆæ¢å¤æ—§å€¼ï¼‰å’Œ Output(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼Œæ ‡è®°äº‹åŠ¡å·²æ’¤é”€ã€‚ Redo æ—¥å¿—æ¢å¤æµç¨‹ ä»å¤´æ‰«ææ—¥å¿—ï¼Œæ”¶é›†æ‰€æœ‰æœ‰çš„äº‹åŠ¡ï¼Œæ”¾å…¥åˆ—è¡¨ Lï¼ˆå·²æäº¤ä½†å¯èƒ½æœªå†™ç›˜çš„äº‹åŠ¡ï¼‰ï¼› ä»æ—¥å¿—é¦–éƒ¨æ­£å‘æ‰«æï¼Œå¯¹æ¯ä¸ªï¼ˆT åœ¨ L ä¸­ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆå†™å…¥æ–°å€¼ï¼‰å’ŒOutput(x)ï¼ˆå†™å…¥ç£ç›˜ï¼‰ï¼› å¯¹æ¯ä¸ª TâˆˆLï¼Œå†™å…¥åˆ°æ—¥å¿—ï¼ˆæ ‡è®°æ¢å¤å®Œæˆï¼‰ã€‚ ä¸¤ç§æ›´æ–°æ–¹å¼ ç«‹å³æ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯ä¹è§‚ï¼Œå‡è®¾å¤§å¤šæ•°äº‹åŠ¡ä¼šæˆåŠŸæäº¤ï¼Œå› æ­¤å…è®¸äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼ˆåœ¨ç¼“å†²åŒºä¸­ï¼Œç”šè‡³å¯èƒ½æå‰åˆ·åˆ°ç£ç›˜ï¼‰ã€‚ å»¶è¿Ÿæ›´æ–°ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯æ‚²è§‚ï¼Œå‡è®¾äº‹åŠ¡å¯èƒ½å¤±è´¥ï¼Œå› æ­¤åœ¨äº‹åŠ¡æäº¤å‰ç»ä¸ä¿®æ”¹æ•°æ®åº“é¡µé¢ï¼Œæ‰€æœ‰ä¿®æ”¹åªè®°å½•åœ¨æ—¥å¿—ä¸­ã€‚ å»¶è¿Ÿæ›´æ–°å¸¸å’Œ Redo æ—¥å¿—ç»“åˆï¼Œå‡è®¾é‡‡ç”¨å»¶è¿Ÿæ›´æ–°ï¼Œåœ¨ä¸€ç³»åˆ—å†™æ“ä½œä¹‹åæ‰ä¼šè½ç›˜åˆ°ç£ç›˜ä¸Šï¼Œè¿™æœŸé—´å¦‚æœå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šå¯¼è‡´ä¹‹å‰çš„è®°å½•æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šï¼Œæ‰€ä»¥éœ€è¦ Redo é‡å†™ã€‚Undo æ—¥å¿—å’Œç«‹å³æ›´æ–°ç»“åˆä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä½†æ˜¯å¹¶ä¸ä»£è¡¨ Undo æ—¥å¿—åªèƒ½å’Œå»¶è¿Ÿæ›´æ–°ä¸€èµ·ç”¨ï¼Œä¸¤ä¸¤æ··åˆéƒ½å¯ä»¥ã€‚ Undo/Redo æ—¥å¿—æ¢å¤æµç¨‹ æ­£å‘æ‰«ææ—¥å¿— æœ‰ï¼šæ”¾å…¥ Redo åˆ—è¡¨ï¼ˆéœ€é‡åšï¼Œç¡®ä¿ä¿®æ”¹å†™ç›˜ï¼‰ï¼› æ— ä¸”æ— ï¼šæ”¾å…¥ Undo åˆ—è¡¨ï¼ˆéœ€æ’¤é”€ï¼Œæ¢å¤æ—§å€¼ï¼‰ï¼› åå‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Undo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Undo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, v)ï¼ˆæ¢å¤æ—§å€¼ vï¼‰å’ŒOutput(x)ï¼› æ­£å‘æ‰«ææ—¥å¿—ï¼Œå¤„ç† Redo åˆ—è¡¨ï¼Œ å¯¹æ¯ä¸ªï¼ˆT åœ¨ Redo åˆ—è¡¨ï¼‰ï¼Œæ‰§è¡ŒWrite(x, w)ï¼ˆå†™å…¥æ–°å€¼ wï¼‰å’ŒOutput(x)ï¼› å¯¹ Undo åˆ—è¡¨ä¸­çš„æ¯ä¸ª Tï¼Œå†™å…¥åˆ°æ—¥å¿—ã€‚ æ³¨æ„ï¼Œæ¢å¤æ—¶å€™éœ€è¦å…ˆ Undo å†å¤„ç† Redo Checkpointæ£€æŸ¥ç‚¹æŠ€æœ¯å°±æ˜¯èƒ½ä¿è¯ checkpoint ä¹‹å‰çš„å…¨éƒ¨äº‹åŠ¡ï¼ˆæ•°æ®ï¼‰éƒ½å·²ç»å®Œæˆåˆ·å…¥åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨è¿›è¡Œæ¢å¤æ—¥å¿—æ—¶å€™ï¼Œåªéœ€è¦ç®¡ checkpoint æ ‡è®°ä¹‹åçš„ Redo æˆ–è€… Undoã€‚ undo/redo æ—¥å¿—ä¸­ï¼Œcheckpoint å¯¹ Undo æ¢å¤æ€§èƒ½å¸®åŠ©ä¸å¦‚ Redo æ¢å¤å¤§ æ—¥å¿—è½®è½¬æŠ€æœ¯æ•°æ®åº“æ—¥å¿—äº§ç”Ÿå¾ˆå¿«ï¼Œä¼šå ç”¨å¾ˆå¤šçš„ç£ç›˜å­˜å‚¨ã€‚ä½†å¤§éƒ¨åˆ†æ—¥å¿—éšæ—¶é—´æ¨ç§»å®é™…ä¸Šå·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥é‡‡ç”¨ Log Rotation èŠ‚çœå­˜å‚¨ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ—¥å¿—è½®è½¬æŠ€æœ¯"},{"categories":null,"content":" å¹¶å‘æ§åˆ¶ å­˜åœ¨çš„é—®é¢˜ ä¸¢å¤±æ›´æ–°ï¼šä¸¤ä¸ªäº‹åŠ¡åŒæ—¶è¯»å–åŒä¸€æ•°æ®ï¼Œå„è‡ªä¿®æ”¹åæäº¤ï¼Œåæäº¤çš„ç»“æœè¦†ç›–å…ˆæäº¤çš„ç»“æœï¼Œå¯¼è‡´å…ˆæäº¤çš„ä¿®æ”¹ â€œä¸¢å¤±â€ã€‚ è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªäº‹åŠ¡å·²ä¿®æ”¹ä½†æœªæäº¤çš„æ•°æ®ï¼ˆâ€œè„æ•°æ®â€ï¼‰ï¼Œåå› åŸäº‹åŠ¡å›æ»šï¼Œè¯»å–çš„æ•°æ®å¤±æ•ˆã€‚è¿™æ˜¯â€œä¸´æ—¶æ— æ•ˆæ•°æ®â€œæ•°æ®ã€‚ ä¸ä¸€è‡´åˆ†æ ä¸å¯é‡å¤è¯»ï¼šåŒä¸€äº‹åŠ¡å†…ï¼Œå†æ¬¡è¯»å–æ—¶æ•°æ®è¢«å…¶ä»–äº‹åŠ¡æ›´æ–° / åˆ é™¤ã€‚ å¹»è±¡è¯»ï¼šåŒä¸€äº‹åŠ¡å†…ï¼Œå†æ¬¡æŸ¥è¯¢æ—¶ï¼Œå…¶ä»–äº‹åŠ¡æ’å…¥äº†æ–°æ•°æ®ï¼Œå¯¼è‡´ç»“æœé›†è¡Œæ•°å˜åŒ–ã€‚ è§£å†³æ–¹æ³• ä¸²è¡Œï¼šæ•ˆç‡ä½ï¼Œä¸è€ƒè™‘ åœ¨ä¿è¯æ­£ç¡®æ€§æƒ…å†µä¸‹ï¼Œæ”¯æŒå¹¶å‘ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å¹¶å‘æ§åˆ¶"},{"categories":null,"content":" å¹¶å‘æ§åˆ¶ å­˜åœ¨çš„é—®é¢˜ ä¸¢å¤±æ›´æ–°ï¼šä¸¤ä¸ªäº‹åŠ¡åŒæ—¶è¯»å–åŒä¸€æ•°æ®ï¼Œå„è‡ªä¿®æ”¹åæäº¤ï¼Œåæäº¤çš„ç»“æœè¦†ç›–å…ˆæäº¤çš„ç»“æœï¼Œå¯¼è‡´å…ˆæäº¤çš„ä¿®æ”¹ â€œä¸¢å¤±â€ã€‚ è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªäº‹åŠ¡å·²ä¿®æ”¹ä½†æœªæäº¤çš„æ•°æ®ï¼ˆâ€œè„æ•°æ®â€ï¼‰ï¼Œåå› åŸäº‹åŠ¡å›æ»šï¼Œè¯»å–çš„æ•°æ®å¤±æ•ˆã€‚è¿™æ˜¯â€œä¸´æ—¶æ— æ•ˆæ•°æ®â€œæ•°æ®ã€‚ ä¸ä¸€è‡´åˆ†æ ä¸å¯é‡å¤è¯»ï¼šåŒä¸€äº‹åŠ¡å†…ï¼Œå†æ¬¡è¯»å–æ—¶æ•°æ®è¢«å…¶ä»–äº‹åŠ¡æ›´æ–° / åˆ é™¤ã€‚ å¹»è±¡è¯»ï¼šåŒä¸€äº‹åŠ¡å†…ï¼Œå†æ¬¡æŸ¥è¯¢æ—¶ï¼Œå…¶ä»–äº‹åŠ¡æ’å…¥äº†æ–°æ•°æ®ï¼Œå¯¼è‡´ç»“æœé›†è¡Œæ•°å˜åŒ–ã€‚ è§£å†³æ–¹æ³• ä¸²è¡Œï¼šæ•ˆç‡ä½ï¼Œä¸è€ƒè™‘ åœ¨ä¿è¯æ­£ç¡®æ€§æƒ…å†µä¸‹ï¼Œæ”¯æŒå¹¶å‘ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å­˜åœ¨çš„é—®é¢˜"},{"categories":null,"content":" å¹¶å‘æ§åˆ¶ å­˜åœ¨çš„é—®é¢˜ ä¸¢å¤±æ›´æ–°ï¼šä¸¤ä¸ªäº‹åŠ¡åŒæ—¶è¯»å–åŒä¸€æ•°æ®ï¼Œå„è‡ªä¿®æ”¹åæäº¤ï¼Œåæäº¤çš„ç»“æœè¦†ç›–å…ˆæäº¤çš„ç»“æœï¼Œå¯¼è‡´å…ˆæäº¤çš„ä¿®æ”¹ â€œä¸¢å¤±â€ã€‚ è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªäº‹åŠ¡å·²ä¿®æ”¹ä½†æœªæäº¤çš„æ•°æ®ï¼ˆâ€œè„æ•°æ®â€ï¼‰ï¼Œåå› åŸäº‹åŠ¡å›æ»šï¼Œè¯»å–çš„æ•°æ®å¤±æ•ˆã€‚è¿™æ˜¯â€œä¸´æ—¶æ— æ•ˆæ•°æ®â€œæ•°æ®ã€‚ ä¸ä¸€è‡´åˆ†æ ä¸å¯é‡å¤è¯»ï¼šåŒä¸€äº‹åŠ¡å†…ï¼Œå†æ¬¡è¯»å–æ—¶æ•°æ®è¢«å…¶ä»–äº‹åŠ¡æ›´æ–° / åˆ é™¤ã€‚ å¹»è±¡è¯»ï¼šåŒä¸€äº‹åŠ¡å†…ï¼Œå†æ¬¡æŸ¥è¯¢æ—¶ï¼Œå…¶ä»–äº‹åŠ¡æ’å…¥äº†æ–°æ•°æ®ï¼Œå¯¼è‡´ç»“æœé›†è¡Œæ•°å˜åŒ–ã€‚ è§£å†³æ–¹æ³• ä¸²è¡Œï¼šæ•ˆç‡ä½ï¼Œä¸è€ƒè™‘ åœ¨ä¿è¯æ­£ç¡®æ€§æƒ…å†µä¸‹ï¼Œæ”¯æŒå¹¶å‘ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è§£å†³æ–¹æ³•"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å¹¶å‘è°ƒåº¦"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å†²çªå¯ä¸²æ€§åˆ¤æ–­"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è§†å›¾å¯ä¸²æ€§åˆ¤æ–­"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#é”"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#2pl-é”"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å…¶ä»–é”"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å¤šç²’åº¦é”"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#intension-é”"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#äº‹åŠ¡éš”ç¦»"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ­»é”"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ­»é”æ£€æµ‹"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ­»é”é¢„é˜²"},{"categories":null,"content":" å¹¶å‘è°ƒåº¦ç”±äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ä»¥æ¨å¯¼å‡ºï¼Œä¸²è¡Œè°ƒåº¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆå‡å¦‚å­˜åœ¨äº‹åŠ¡ A å’Œ äº‹åŠ¡ Bï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå®Œ A å†æ‰§è¡Œ B è‚¯å®šæ²¡é—®é¢˜ï¼‰ã€‚é‚£ä¹ˆå¦‚æœä¸€ä¸ªè°ƒåº¦çš„ç»“æœå’Œä¸²è¡Œè°ƒåº¦ç›¸åŒï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ ok çš„ï¼Œç§°å®ƒä¸ºå¯ä¸²åŒ–è°ƒåº¦ï¼Œå¦åˆ™ä¸ºä¸å¯ä¸²åŒ–è°ƒåº¦ã€‚ è¿™é‡Œç»™å‡ºå†²çªæ“ä½œçš„å®šä¹‰ï¼šæ¶‰åŠåŒä¸€ä¸ªæ•°æ®åº“å…ƒç´ ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œã€‚ä¾‹å¦‚ï¼š r1(A)\u003c-\u003ew2(A) w2(A)\u003c-\u003er1(A) w1(A)\u003c-\u003ew2(A) å†²çªç­‰ä»·ï¼šå¦‚æœè°ƒåº¦ S1 å’Œ S2ï¼Œå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—éå†²çªçš„æ“ä½œäº¤æ¢å¾—åˆ°,åˆ™ç§°è¿™ä¸¤ä¸ªè°ƒåº¦å†²çªç­‰ä»·ã€‚ å†²çªå¯ä¸²æ€§ï¼šå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦å†²çªç­‰ä»·,åˆ™ç§°è¿™ä¸ªè°ƒåº¦æ»¡è¶³å†²çªå¯ä¸²æ€§ã€‚ å¦‚æœæ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡å®ƒæ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œæ˜¯ ok çš„ã€‚ å¦‚å›¾ï¼Œè°ƒåº¦ Sc ç»è¿‡ä¸€ç³»åˆ—éå†²çªæ“ä½œå˜æˆä¸²è¡Œè°ƒåº¦ã€‚ å†²çªå¯ä¸²æ€§åˆ¤æ–­ ç»“ç‚¹ï¼šäº‹åŠ¡ åˆ¤æ–­ï¼šè‹¥ P(S) ä¸­æ— ç¯ï¼Œåˆ™ S æ»¡è¶³å†²çªå¯ä¸²æ€§ æœ‰å‘è¾¹ï¼š$T_i \\rightarrow T_j$ éœ€è¦æ»¡è¶³ï¼šå‡å¦‚å­˜åœ¨ æ“ä½œ A1 ä½äº Tiï¼ŒA2 ä½äº Tj é‚£ä¹ˆ A1 åœ¨ A2 ä¹‹å‰ A1 å’Œ A2 æ˜¯å†²çªæ“ä½œ r2(A) å’Œ w3(A) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T3 r1(B) å’Œ w2(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T1 æŒ‡å‘ T2 w2(B) å’Œ w1(B) æ˜¯å†²çªæ“ä½œï¼Œæ‰€ä»¥ T2 æŒ‡å‘ T1 å…³é”®ç‚¹æ˜¯ç›¯ç€å†™æ“ä½œï¼Œåªæœ‰å†™æ“ä½œå¯èƒ½å¯¼è‡´å†²çªã€‚ è§†å›¾å¯ä¸²æ€§åˆ¤æ–­å†²çªå¯ä¸²æ€§è¿‡äºä¸¥æ ¼ï¼Œéƒ¨åˆ† â€œå®é™…ç­‰ä»·äºä¸²è¡Œâ€ çš„è°ƒåº¦æ— æ³•é€šè¿‡å†²çªå¯ä¸²æ€§åˆ¤æ–­ï¼Œå› æ­¤å¼•å…¥æ›´å®½æ¾çš„è§†å›¾å¯ä¸²æ€§ã€‚ è§†å›¾ç­‰ä»·å®šä¹‰ï¼šä¸¤ä¸ªè°ƒåº¦ S1 å’Œ S2 æ»¡è¶³ 3 ä¸ªæ¡ä»¶ï¼š åŒä¸€äº‹åŠ¡å¯¹åŒä¸€æ•°æ®çš„è¯»æ“ä½œï¼Œæ•°æ®æºç›¸åŒï¼ˆå¦‚ T1 åœ¨ S1 ä¸­è¯» T2 å†™çš„ Aï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯» T2 å†™çš„ Aï¼‰ è‹¥äº‹åŠ¡åœ¨ S1 ä¸­è¯»æ•°æ®çš„åˆå§‹å€¼ï¼Œåœ¨ S2 ä¸­ä¹Ÿè¯»åˆå§‹å€¼ï¼› å¯¹åŒä¸€æ•°æ®çš„æœ€åä¸€æ¬¡å†™æ“ä½œï¼Œåœ¨ S1 å’Œ S2 ä¸­ç”±åŒä¸€äº‹åŠ¡æ‰§è¡Œã€‚ å¦‚å›¾ï¼š S1 å’Œ S2 ä¸¤ç§è°ƒåº¦ä¸­ï¼ŒT1 éƒ½è¯» A çš„åˆå§‹å€¼ï¼ŒT2 éƒ½è¯» B çš„åˆå§‹å€¼ï¼Œ T3 éƒ½è¯» T1 å†™çš„ A A æœ€åéƒ½ç”± T2 å†™ï¼ŒB æœ€åéƒ½ç”± T3 å†™ å¯ä»¥çœ‹åˆ° S1 ä¸æ»¡è¶³å†²çªå¯ä¸²æ€§ï¼Œä½†æ˜¯ S1 å’Œ S2 éƒ½æ˜¯å¯ä¸²åŒ–è°ƒåº¦ï¼Œ S1 å’Œ S2 æ»¡è¶³è§†å›¾ç­‰ä»·ã€‚ æ–°å»ºäº‹åŠ¡ T1 â€¦ Tnï¼Œè¿˜æœ‰ Tb å’Œ Tfã€‚ åˆå§‹åŒ– Tb å¯¹æ‰€æœ‰ DB å…ƒç´ æ‰§è¡Œå†™æ“ä½œï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: wb(A) -\u003e wb(B) -\u003e wb(C)ã€‚é¡ºåº åº”è¯¥ æ— æ‰€è°“ã€‚ Tf è¯»å–æ‰€æœ‰DB å…ƒç´ ï¼Œå‡å¦‚å­˜åœ¨å…ƒç´  A,B,Cï¼Œé‚£ä¹ˆäº‹åŠ¡ Tb å¯ä»¥å†™ä¸º Tb: rb(A) -\u003e rb(B) -\u003e rb(C)ã€‚ å¯¹äºæ‰€æœ‰ wi(A) -\u003e rj(A) (ä¸­é—´å¯ä»¥æœ‰å…¶ä»–æ“ä½œ)ï¼Œæ·»åŠ ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ç”± Ti æŒ‡å‘ Tjï¼Œç„¶å å¦‚æœ wi ä¸º Tb åˆ™äº‹åŠ¡ j å‘æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœ rj æ“ä½œä¸º Tf åˆ™æ‰€æœ‰ å…¶ä»–ï¼ˆè²Œä¼¼ä¸åŒ…å« Tb,Tfï¼‰ å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡å‘äº‹åŠ¡ i è¿ä¸€æ¡æ ‡å·ä¸º 0 çš„è¾¹ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å«æœ‰å†™æ“ä½œçš„äº‹åŠ¡ï¼Œå‘ i è¿ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ï¼Œå¹¶ç”±äº‹åŠ¡ j å¾€è¯¥äº‹åŠ¡è¿æ¥ä¸€æ¡æ ‡å·ä¸º p çš„è¾¹ã€‚ å¯¹äºæ‰€æœ‰ Ti -\u003e Tj å’Œ Tj -\u003e Ti çš„è¾¹ï¼Œåˆ æ‰ä¸€ä¸ªå¦‚æœèƒ½ä½¿å¾—æ— ç¯å°±æ˜¯è§†å›¾å¯ä¸²ã€‚ å¦‚ä¸Šå›¾ä¾‹å­ï¼š ç”»å‡ºç»“ç‚¹ Tb,T1,T2,T3,Tf Tb:wb(A), Tf:rf(A),å¾—åˆ°æ–°çš„è°ƒåº¦ wb(A) -\u003e r1(A)w2(A) -\u003e r3(A)w1(A)w3(A)-\u003erf(A) wb(A)-\u003er1(A) æ»¡è¶³ç¬¬ä¸€æ¡ï¼Œæ‰€ä»¥ Tb å‘ T1 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘å…¶ä»–å«å†™æ“ä½œçš„äº‹åŠ¡ T2, T3 æŒ‡ä¸€æ¡ 0ã€‚ w2(A)-\u003er3(A) æ»¡è¶³ç¬¬ä¸‰æ¡ï¼Œæ‰€ä»¥ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å‘ T2 æŒ‡ä¸€æ¡ 1ï¼ŒT3 å‘ T1 æŒ‡ä¸€æ¡ 1ã€‚ w3(A)-\u003erf(A) æ»¡è¶³ç¬¬äºŒæ¡ï¼Œæ‰€ä»¥ T3 å‘ Tf æŒ‡ä¸€æ¡ 0ï¼Œå¹¶ä¸” T1 å’Œ T2 å‘ T3 æŒ‡ä¸€æ¡ 0ã€‚ T1 -\u003e T3 æœ‰ä¸¤æ¡ 0 è¾¹ï¼ŒT3 -\u003e T1 ä¸€æ¡ 1 è¾¹ï¼Œåˆ é™¤ 1 è¾¹å°±æ— ç¯äº†ã€‚ é” 2PL é”ä¸€ä¸ªäº‹åŠ¡çš„é”æ“ä½œå¿…é¡»åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œä¸èƒ½æ··åœ¨ä¸€èµ·ï¼š é˜¶æ®µ1ï¼šæˆé•¿é˜¶æ®µ åªèƒ½è·å–é”ï¼Œä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚ äº‹åŠ¡ä¸€å¼€å§‹éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å»ç”³è¯·é”ï¼Œé”è¶Šæ¥è¶Šå¤šï¼ˆåƒâ€œæˆé•¿â€ä¸€æ ·ï¼‰ã€‚ è¿™ä¸ªé˜¶æ®µå¯ä»¥æŒç»­å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°äº‹åŠ¡æ‹¿åˆ°äº†æ‰€æœ‰å®ƒéœ€è¦çš„é”ã€‚ é˜¶æ®µ2ï¼šæ”¶ç¼©é˜¶æ®µ åªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½å†è·å–ä»»ä½•æ–°é”ã€‚ ä¸€æ—¦äº‹åŠ¡å¼€å§‹é‡Šæ”¾ç¬¬ä¸€ä¸ªé”ï¼Œå°±è¿›å…¥äº†æ”¶ç¼©é˜¶æ®µï¼Œä¹‹åå°±åªèƒ½é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº†ã€‚ text T1: T2: lock(A) read(A) A = A + 100 lock(B) â† åœ¨ä»»ä½•unlockä¹‹å‰æ‹¿Bçš„é”ï¼ˆè¿˜åœ¨æˆé•¿é˜¶æ®µï¼‰ read(B) ... ï¼ˆT1å¤„ç†Bï¼‰ lock(A) â† T2æƒ³æ‹¿Aï¼Œä½†T1æŒæœ‰ï¼Œå¿…é¡»ç­‰ (ç­‰å¾…...) write(A) write(B) unlock(A) â† å¼€å§‹è¿›å…¥æ”¶ç¼©é˜¶æ®µ unlock(B) â† ç»§ç»­é‡Šæ”¾ï¼Œä¸èƒ½å†æ‹¿æ–°é”äº† lock(A) â† ç°åœ¨T2å¯ä»¥æ‹¿åˆ°äº† ... 2PL çš„ç¼ºç‚¹æ˜¯ï¼šå¹¶å‘åº¦ä½ã€å¹¶ä¸”å¯èƒ½å¯¼è‡´ æ­»é”ã€‚ 2PL å¯èƒ½å¯¼è‡´è„è¯»ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ä¸¢å¤±æ›´æ–°çš„åŸå› æ˜¯ ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å†™ä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªå…ˆæäº¤ä¸€ä¸ªåæäº¤ï¼Œä½†æ˜¯ 2PL å†™æ•°æ®æ—¶å€™è¦æ±‚æŒæœ‰ X é”ï¼Œå¹¶ä¸” X é”æ˜¯äº’æ–¥çš„ã€‚ ä½†æ˜¯ 2PL å¯èƒ½è„è¯»ï¼Œå› ä¸ºäº‹åŠ¡ A å†™äº†æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ B è¯»ï¼Œè¿™æ—¶å€™è¯»çš„æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¦‚æœ A å›æ»šï¼Œé‚£ä¹ˆ B è¯»çš„å°±æ˜¯è„æ•°æ®äº†ã€‚ å…¶ä»–é” Share é”ï¼šè¯»ä¹‹å‰ä¸Š S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰ S é” Exclusive é”ï¼šå†™ä¹‹å‰ä¸Š X é”ï¼Œå¯ä»¥è¯» + å†™ ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡ä¸èƒ½å†åŠ ä»»ä½•é”ï¼ˆS / X / Uï¼‰ã€‚å‡å¦‚æ•°æ®åªè¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ S é”ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸º Xé”ã€‚ ä»…ä»…ä½¿ç”¨ S é”å’Œ X é”å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š text T1: T2: S(A) S(A) // ä¸¤è€…åŒæ—¶æ‹¿Sé”è¯»Aï¼ŒOK read(A) read(A) A = A + 100 A = A * 2 upgrade to X(A) upgrade to X(A) // ä¸¤è€…åŒæ—¶æƒ³å‡çº§ä¸ºXé” (ç­‰å¾…T2é‡Šæ”¾S) (ç­‰å¾…T1é‡Šæ”¾S) // äº’ç›¸ç­‰ â†’ æ­»é”ï¼ ç”±äº S é”å‡çº§ä¸º X é”è¦æ±‚åªæœ‰è‡ªå·±æŒæœ‰ï¼Œæ‰€ä»¥è¯·æ±‚å‡çº§ä¹‹åä¼šç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾ S é”ï¼Œæ­¤æ—¶å°±ä¼šé™·å…¥æ­»é”çŠ¶æ€ã€‚ Update é”å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š text T1: T2: U(A) request U(A) // U é”ä¹‹é—´ä¸å…¼å®¹ read(A) (è¢«é˜»å¡) A = A + 100 upgrade to X(A) // U â†’ Xï¼ŒOKï¼ˆæ²¡äººç«äº‰ï¼‰ write(A) commit (release X) U(A) // T1 å®Œæˆåæ‰æ‹¿åˆ° read(A) A = A * 2 upgrade to X(A) // OK write(A) commit è¿™ä¹ˆçœ‹æ¥ U é”ä¸æ˜¯å’Œ X é”æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¸ºä»€ä¹ˆå¤šæ­¤ä¸€ä¸¾ï¼Ÿå®é™…ä¸Š U é”æ˜¯â€œåªå’Œ S å…±å­˜ã€ä½†å½¼æ­¤äº’æ–¥çš„è¯»é”â€ X é”æ˜¯â€œè°éƒ½ä¸èƒ½å…±å­˜çš„å†™é”â€ã€‚ text T1: T2: U(A) S(A) // S é”å’ŒU é”ä¹‹é—´ä¸äº’æ–¥ è¿™ä¸ªä¾‹å­ä¸‹ï¼ŒT1 ç”³è¯·äº† U é”ï¼Œ T2 ç”³è¯·äº† S é”ã€‚å‡å¦‚åç»­ U é”éœ€è¦å‡çº§ä¸º X é”ï¼Œä»ç„¶éœ€è¦ç­‰å¾… T2 é‡Šæ”¾ S é”ã€‚ä½†æ˜¯ç”±äºå‡ºç°äº† Update é”è¿™ä¸ªæ¦‚å¿µ(æˆ‘å…ˆçœ‹ï¼Œä½†å¯èƒ½è¦æ”¹)ï¼Œæ‰€ä»¥ S é”åç»­ä¸å¯èƒ½å‡çº§ä¸º X é”äº†ï¼ŒT2 åœ¨ä¸€å®šæ—¶é—´åè‚¯å®šä¼šé‡Šæ”¾ S é”ï¼Œä¸ä¼šå‡ºç° U é”å’Œ S é”éƒ½æƒ³å‡çº§å¯¼è‡´æ­»é”çš„æƒ…å†µã€‚ å¤šç²’åº¦é” æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œäº†è§£æ¦‚å¿µ å¯¹åŠ é”å¯¹è±¡å¤§å°æœ‰åŒºåˆ†ï¼šç²’åº¦è¶Šç»†å¹¶å‘åº¦è¶Šé«˜ï¼Œåä¹‹è¶Šä½ã€‚ éœ€è¦æ„é€ ä¸€æ£µå¤šç²’åº¦æ ‘ï¼Œæ·±åº¦è¶Šæ·±ç²’åº¦è¶Šç»†ã€‚ å¯¹æŸä¸ªèŠ‚ç‚¹ä¸Šé”åï¼Œå¯¹ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘å‡ä¸Šç›¸åŒçš„é”ã€‚ æ˜¾ç¤ºåŠ é”ï¼šå°±æ˜¯ç›´æ¥åŠ  éšå¼åŠ é”ï¼šæœ¬èº«æ²¡æœ‰è¢«æ˜¾å¼åŠ é”,ä½†å› å…¶ä¸Šå±‚ç»“ç‚¹åŠ äº†é”è€Œä½¿æ•°æ®å¯¹è±¡è¢«åŠ é” æ‰€ä»¥ç»™ä¸€ä¸ªç»“ç‚¹æ˜¾å¼åŠ é”æ—¶å¿…é¡»è€ƒè™‘ï¼š(1) è¯¥ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹é”å­˜åœ¨; (2) ä¸Šå±‚ç»“ç‚¹æ˜¯å¦å·²æœ‰ä¸ç›¸å®¹çš„çš„é”ï¼ˆä¸Šå±‚ç»“ç‚¹å¯¼è‡´çš„éšå¼é”å†²çªï¼‰ï¼›(3) æ‰€æœ‰ä¸‹å±‚ç»“ç‚¹ä¸­æ˜¯å¦å­˜åœ¨ä¸ç›¸å®¹çš„æ˜¾å¼é”ã€‚ Intension é” å¦‚æœå¯¹æŸä¸ªç»“ç‚¹åŠ  IS(IX) é”ï¼Œåˆ™è¯´æ˜äº‹åŠ¡è¦å¯¹è¯¥ç»“ç‚¹çš„æŸä¸ªä¸‹å±‚ç»“ç‚¹åŠ  S(X)é”ï¼› å¯¹ä»»ä¸€ç»“ç‚¹åŠ  S(X) é”ï¼Œå¿…é¡»å…ˆå¯¹ä»æ ¹ç»“ç‚¹åˆ°Pçš„è·¯å¾„ä¸Šçš„æ‰€æœ‰ç»“ç‚¹åŠ  IS(IX) é” äº‹åŠ¡éš”ç¦» æœªæäº¤è¯»ï¼šä¸åŠ é” æäº¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œæ•°æ®ä¸€æ—¦è¯»å‡ºï¼Œå°± é©¬ä¸Š é‡Šæ”¾æŒæœ‰çš„Sé” å¯é‡å¤è¯»ï¼šæ‰€è®¿é—®æ•°æ®ä¸ŠåŠ Sé”ï¼Œäº‹åŠ¡ç»“æŸ å†é‡Šæ”¾ S é”ã€‚ å¯ä¸²è¡Œè¯»ï¼šåœ¨ä¸Šé¢åŸºç¡€ä¸Šï¼Œäº‹åŠ¡è¿˜å¿…é¡»é”ä½è®¿é—®çš„æ•´ä¸ªè¡¨ï¼ˆå‰é¢åªé”ä½æ•°æ®é¡¹ï¼‰ã€‚ æ­»é” æ­»é”æ£€æµ‹ è®¾ç½®ä¸€ä¸ª timeoutï¼Œå›ºå®šæ—¶é—´äº‹åŠ¡æœªç»“æŸå°± abort ç­‰å¾…å›¾ï¼šå‡å¦‚ Ti éœ€è¦ Tj é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå°±ç”»ä¸€æ¡ Ti -\u003e Tj çš„è¾¹ï¼Œæœ‰ç¯è¯´æ˜æ­»é”ã€‚ æ­»é”é¢„é˜² Priority Orderï¼šæŠŠè¦åŠ é”çš„æ•°æ®åº“å…ƒç´ æŒ‰æŸç§é¡ºåºæ’åºï¼Œäº‹åŠ¡åªèƒ½æŒ‰ç…§å…ƒç´ é¡ºåºç”³è¯·é” ä¾‹å¦‚æ•°æ®åº“æœ‰å…ƒç´  A,B é‚£ä¹ˆè§„å®šé¡ºåºä¸º A -\u003e Bã€‚ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(B) â†’ lock(A) // é«˜ â†’ ä½ T2: lock(A) â†’ lock(B) // ä½ â†’ é«˜ text ======= ä¸å¼ºåˆ¶é¡ºåº ======= T1: lock(A) â†’ ... â†’ lock(B) â† T1å…ˆæ‹¿åˆ°Aå’ŒB T2: lock(A) â† ç­‰T1é‡Šæ”¾A Timestamp æ¯ä¸ªäº‹åŠ¡ T å¼€å§‹æ—¶ï¼Œç³»ç»Ÿèµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ä¹è§‚å¹¶å‘æ§åˆ¶"},{"categories":null,"content":" è¯¾åé¢˜ ä¸è€ƒæ„Ÿè§‰ ä¸è€ƒæ„Ÿè§‰ 2PL ä¼šè„è¯»ä¼šæ­»é”ï¼Œä½†æ˜¯ä¸ä¼šä¸¢å¤±æ›´æ–° ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:8:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è¯¾åé¢˜-5"},{"categories":null,"content":" ç¬¬ä¹ç«  NoSQL æ•°æ®åº“","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç¬¬ä¹ç« -nosql-æ•°æ®åº“"},{"categories":null,"content":" ä»‹ç»NoSQL æ•°æ®åº“ç‰¹ç‚¹ï¼š Non relationalï¼šå»é™¤å…³ç³»å‹ç‰¹ç‚¹ï¼Œæ•°æ®ä¹‹é—´æ— å…³ç³» Scalabilityï¼šæ˜“æ‹“å±•ï¼Œä¸»è¦åŸå› æ˜¯å› ä¸ºèˆå¼ƒäº†å…³ç³» No pre-defined schemaï¼šæ— éœ€é¢„å…ˆè®¾å®šæ•°æ®å­˜å‚¨å­—æ®µï¼Œéšæ—¶å­˜å‚¨éœ€è¦çš„å­—æ®µ CAP not ACIDï¼šå…³ç³»å‹æ•°æ®åº“éœ€è¦æ»¡è¶³ ACIDï¼Œå³åŸå­æ€§ï¼Œä¸€è‡´æ€§ï¼Œéš”ç¦»æ€§ï¼Œè€ç”¨æ€§ã€‚NoSQL éœ€è¦æ»¡è¶³ C(Consistency)ï¼ŒA(Availability)å’Œ P(Tolerance of Network Partition)ã€‚ NoSQLäº§ç”Ÿçš„åŸå› ï¼š RDBMS æ— æ³•æ»¡è¶³ Web 2.0çš„ éœ€æ±‚ï¼šæ•°æ®é‡æå‡ï¼Œå¹¶å‘æ€§è¦æ±‚æå‡ï¼Œé«˜å¯æ‰©å±•æ€§å’Œé«˜å¯ç”¨æ€§çš„éœ€æ±‚å¢åŠ  â€œOne size fits allâ€ æ¨¡å¼å¾ˆéš¾é€‚ç”¨äºæˆªç„¶ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œä¸€ä¸ªå¼ºè°ƒé«˜ååï¼Œä¸€ä¸ªå¼ºè°ƒä½å»¶æ—¶ï¼Œæ— æ³•ä½¿ç”¨åŒä¸€å¥—æ¨¡å‹æ¥æŠ½è±¡ å…³ç³»æ•°æ®åº“çš„å…³é”®ç‰¹æ€§åŒ…æ‹¬å®Œå–„çš„äº‹åŠ¡æœºåˆ¶å’Œé«˜æ•ˆçš„æŸ¥è¯¢æœºåˆ¶ã€‚è¿™äº›å…³é”®ç‰¹æ€§åœ¨Web 2.0æ—¶ä»£å‡ºç°äº†å˜åŒ–ï¼šä¸è¦æ±‚ä¸¥æ ¼çš„æ•°æ®åº“äº‹åŠ¡ï¼Œä¸è¦æ±‚ä¸¥æ ¼çš„è¯»å†™ä¸€è‡´æ€§ï¼Œä¸åŒ…å«å¤§é‡å¤æ‚çš„SQL æŸ¥è¯¢ ç®€è¨€ä¹‹ï¼š ä¼˜åŠ¿ï¼šæ•°æ®é—´æ— å…³ç³»ï¼Œæ‰€ä»¥ æ˜“æ‹“å±•ã€è§„æ¨¡å¤§ã€é«˜å¹¶å‘ åŠ£åŠ¿ï¼šå¤æ‚æŸ¥è¯¢æ€§èƒ½å·®ã€ä¸æ”¯æŒäº‹åŠ¡å¼ºä¸€è‡´æ€§ã€ç»´æŠ¤å›°éš¾ RDBMS åº”ç”¨åœºæ™¯ï¼šç”µä¿¡ã€é“¶è¡Œç­‰é¢†åŸŸçš„å…³é”®ä¸šåŠ¡ç³»ç»Ÿï¼Œéœ€è¦ä¿è¯å¼ºäº‹åŠ¡ä¸€è‡´æ€§ NoSQL åº”ç”¨åœºæ™¯ï¼šäº’è”ç½‘ä¼ä¸šã€ä¼ ç»Ÿä¼ä¸šçš„éå…³é”®ä¸šåŠ¡ï¼ˆæ¯”å¦‚æ•°æ®åˆ†æï¼‰ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ä»‹ç»"},{"categories":null,"content":" ç±»å‹ é”®å€¼æ•°æ®åº“ï¼šå°±æ˜¯ Redisï¼Œç»™ä¸€ä¸ª key å¾—åˆ° value æ–‡æ¡£æ•°æ®åº“ï¼šMongoDBï¼Œä¹Ÿæ˜¯ä¸€ç§ KV æ•°æ®åº“ï¼Œä½†æ˜¯ value æ˜¯æ–‡æ¡£ åˆ—å­˜å‚¨æ•°æ®åº“ï¼šåŒ…å«å¤šä¸ªåˆ—æ—(ç±»ä¼¼å…³ç³»å‹æ•°æ®åº“çš„è¡¨)ï¼Œåˆ—æ—ç”±å¤šè¡Œç»„æˆï¼Œæ¯ä¸€è¡Œå¯ä»¥åŒ…å«ä¸å…¶ä»–è¡Œä¸åŒæ•°é‡çš„åˆ—ã€‚è€Œä¸”è¿™äº›åˆ—ä¸å¿…ä¸å…¶ä»–è¡Œçš„åˆ—åŒ¹é…(ä¾‹å¦‚ç¬¬ä¸€åˆ—æ˜¯ Bob å­˜ä»–çš„å§“åå¹´é¾„ï¼Œç¬¬äºŒè¡Œæ˜¯ Tim å­˜ä»–çš„å§“åçˆ±å¥½)ã€‚ å›¾æ•°æ®åº“ï¼šç»“ç‚¹æ˜¯ä¸€ä¸ªä¸ªå®ä½“ï¼Œè¾¹æ˜¯ä»–ä»¬ä¹‹é—´çš„å…³ç³»ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:2","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#ç±»å‹"},{"categories":null,"content":" åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€ CAP C(Consistencyï¼‰ï¼šä¸€è‡´æ€§ï¼Œåˆ†å¸ƒå¼ç¯å¢ƒä¸­æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´å…·æœ‰ç›¸åŒçš„æ•°æ® A(Availabilityï¼‰ï¼šå¯ç”¨æ€§ï¼Œå³å¿«é€Ÿè·å–æ•°æ®ï¼Œå¯ä»¥åœ¨ç¡®å®šçš„æ—¶é—´å†…è¿”å›æ“ä½œç»“æœï¼Œä¿è¯æ¯ä¸ªè¯·æ±‚ ä¸ç®¡æˆåŠŸæˆ–è€…å¤±è´¥éƒ½æœ‰å“åº” P(Tolerance of Network Partitionï¼‰ï¼šåˆ†åŒºå®¹å¿æ€§ï¼Œç³»ç»Ÿä¸­ä»»æ„ä¿¡æ¯çš„ä¸¢å¤±æˆ–å¤±è´¥ä¸ä¼šå½±å“ç³»ç»Ÿçš„ç»§ç»­è¿ä½œ ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ã€ å¯ç”¨æ€§å’Œåˆ†åŒºå®¹å¿æ€§è¿™ä¸‰ä¸ªéœ€æ±‚ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³å…¶ä¸­ä¸¤ä¸ª CAï¼šä¹Ÿå°±æ˜¯å¼ºè°ƒä¸€è‡´æ€§ï¼ˆCï¼‰å’Œå¯ç”¨æ€§ï¼ˆAï¼‰ï¼Œæ”¾å¼ƒåˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼Œæœ€ç®€å•çš„åšæ³•æ˜¯æŠŠæ‰€æœ‰ä¸äº‹åŠ¡ç›¸å…³çš„å†…å®¹éƒ½æ”¾åˆ°åŒä¸€å°æœºå™¨ä¸Šã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ç§åšæ³•ä¼šä¸¥é‡å½±å“ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚ä¼ ç»Ÿçš„å…³ç³»æ•°æ®åº“ï¼ˆMySQLã€SQL Serverå’Œ PostgreSQLï¼‰ï¼Œéƒ½é‡‡ç”¨äº†è¿™ç§è®¾è®¡åŸåˆ™ï¼Œå› æ­¤ï¼Œæ‰©å±•æ€§éƒ½æ¯”è¾ƒå·® CPï¼šä¹Ÿå°±æ˜¯å¼ºè°ƒä¸€è‡´æ€§ï¼ˆCï¼‰å’Œåˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼Œæ”¾å¼ƒå¯ç”¨æ€§ï¼ˆAï¼‰ï¼Œå½“å‡ºç°ç½‘ç»œåˆ†åŒºçš„æƒ…å†µæ—¶ï¼Œå—å½±å“çš„æœåŠ¡éœ€è¦ç­‰å¾…æ•°æ®ä¸€è‡´ï¼Œå› æ­¤åœ¨ç­‰å¾…æœŸé—´å°±æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ APï¼šä¹Ÿå°±æ˜¯å¼ºè°ƒå¯ç”¨æ€§ï¼ˆAï¼‰å’Œåˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼Œæ”¾å¼ƒä¸€è‡´æ€§ï¼ˆCï¼‰ï¼Œå…è®¸ç³»ç»Ÿè¿”å›ä¸ä¸€è‡´çš„æ•°æ® BASEBASE ç†è®ºæ˜¯ CAP ç†è®ºçš„å»¶å±•ï¼š BA(Basic Availability)ï¼šåŸºæœ¬å¯ç”¨æ€§ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†å‘ç”Ÿé—®é¢˜å˜å¾—ä¸å¯ç”¨æ—¶ï¼Œå…¶ä»–éƒ¨åˆ†ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œå³å…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚ S(Soft-state)ï¼šâ€œè½¯çŠ¶æ€â€æ˜¯ä¸â€œç¡¬çŠ¶æ€â€ç›¸å¯¹åº” çš„ä¸€ç§ææ³•ã€‚æ•°æ®åº“ä¿å­˜çš„æ•°æ®æ˜¯â€œç¡¬çŠ¶æ€â€æ—¶ï¼Œå¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œå³ä¿è¯æ•°æ®ä¸€ç›´æ˜¯æ­£ç¡®çš„ã€‚â€œè½¯çŠ¶æ€â€æ˜¯æŒ‡çŠ¶æ€å¯ä»¥æœ‰ä¸€æ®µæ—¶é—´ä¸åŒæ­¥ï¼Œå…·æœ‰ä¸€å®šçš„æ»åæ€§ã€‚ E(Eventual Consistency)ï¼šå…è®¸åç»­çš„è®¿é—®æ“ä½œå¯ä»¥æš‚æ—¶è¯»ä¸åˆ°æ›´æ–°åçš„æ•°æ®ï¼Œä½†æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå¿…é¡»æœ€ç»ˆè¯»åˆ°æ›´æ–°åçš„æ•°æ®ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€"},{"categories":null,"content":" åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€ CAP C(Consistencyï¼‰ï¼šä¸€è‡´æ€§ï¼Œåˆ†å¸ƒå¼ç¯å¢ƒä¸­æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´å…·æœ‰ç›¸åŒçš„æ•°æ® A(Availabilityï¼‰ï¼šå¯ç”¨æ€§ï¼Œå³å¿«é€Ÿè·å–æ•°æ®ï¼Œå¯ä»¥åœ¨ç¡®å®šçš„æ—¶é—´å†…è¿”å›æ“ä½œç»“æœï¼Œä¿è¯æ¯ä¸ªè¯·æ±‚ ä¸ç®¡æˆåŠŸæˆ–è€…å¤±è´¥éƒ½æœ‰å“åº” P(Tolerance of Network Partitionï¼‰ï¼šåˆ†åŒºå®¹å¿æ€§ï¼Œç³»ç»Ÿä¸­ä»»æ„ä¿¡æ¯çš„ä¸¢å¤±æˆ–å¤±è´¥ä¸ä¼šå½±å“ç³»ç»Ÿçš„ç»§ç»­è¿ä½œ ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ã€ å¯ç”¨æ€§å’Œåˆ†åŒºå®¹å¿æ€§è¿™ä¸‰ä¸ªéœ€æ±‚ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³å…¶ä¸­ä¸¤ä¸ª CAï¼šä¹Ÿå°±æ˜¯å¼ºè°ƒä¸€è‡´æ€§ï¼ˆCï¼‰å’Œå¯ç”¨æ€§ï¼ˆAï¼‰ï¼Œæ”¾å¼ƒåˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼Œæœ€ç®€å•çš„åšæ³•æ˜¯æŠŠæ‰€æœ‰ä¸äº‹åŠ¡ç›¸å…³çš„å†…å®¹éƒ½æ”¾åˆ°åŒä¸€å°æœºå™¨ä¸Šã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ç§åšæ³•ä¼šä¸¥é‡å½±å“ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚ä¼ ç»Ÿçš„å…³ç³»æ•°æ®åº“ï¼ˆMySQLã€SQL Serverå’Œ PostgreSQLï¼‰ï¼Œéƒ½é‡‡ç”¨äº†è¿™ç§è®¾è®¡åŸåˆ™ï¼Œå› æ­¤ï¼Œæ‰©å±•æ€§éƒ½æ¯”è¾ƒå·® CPï¼šä¹Ÿå°±æ˜¯å¼ºè°ƒä¸€è‡´æ€§ï¼ˆCï¼‰å’Œåˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼Œæ”¾å¼ƒå¯ç”¨æ€§ï¼ˆAï¼‰ï¼Œå½“å‡ºç°ç½‘ç»œåˆ†åŒºçš„æƒ…å†µæ—¶ï¼Œå—å½±å“çš„æœåŠ¡éœ€è¦ç­‰å¾…æ•°æ®ä¸€è‡´ï¼Œå› æ­¤åœ¨ç­‰å¾…æœŸé—´å°±æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ APï¼šä¹Ÿå°±æ˜¯å¼ºè°ƒå¯ç”¨æ€§ï¼ˆAï¼‰å’Œåˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼Œæ”¾å¼ƒä¸€è‡´æ€§ï¼ˆCï¼‰ï¼Œå…è®¸ç³»ç»Ÿè¿”å›ä¸ä¸€è‡´çš„æ•°æ® BASEBASE ç†è®ºæ˜¯ CAP ç†è®ºçš„å»¶å±•ï¼š BA(Basic Availability)ï¼šåŸºæœ¬å¯ç”¨æ€§ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†å‘ç”Ÿé—®é¢˜å˜å¾—ä¸å¯ç”¨æ—¶ï¼Œå…¶ä»–éƒ¨åˆ†ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œå³å…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚ S(Soft-state)ï¼šâ€œè½¯çŠ¶æ€â€æ˜¯ä¸â€œç¡¬çŠ¶æ€â€ç›¸å¯¹åº” çš„ä¸€ç§ææ³•ã€‚æ•°æ®åº“ä¿å­˜çš„æ•°æ®æ˜¯â€œç¡¬çŠ¶æ€â€æ—¶ï¼Œå¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œå³ä¿è¯æ•°æ®ä¸€ç›´æ˜¯æ­£ç¡®çš„ã€‚â€œè½¯çŠ¶æ€â€æ˜¯æŒ‡çŠ¶æ€å¯ä»¥æœ‰ä¸€æ®µæ—¶é—´ä¸åŒæ­¥ï¼Œå…·æœ‰ä¸€å®šçš„æ»åæ€§ã€‚ E(Eventual Consistency)ï¼šå…è®¸åç»­çš„è®¿é—®æ“ä½œå¯ä»¥æš‚æ—¶è¯»ä¸åˆ°æ›´æ–°åçš„æ•°æ®ï¼Œä½†æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå¿…é¡»æœ€ç»ˆè¯»åˆ°æ›´æ–°åçš„æ•°æ®ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#cap"},{"categories":null,"content":" åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€ CAP C(Consistencyï¼‰ï¼šä¸€è‡´æ€§ï¼Œåˆ†å¸ƒå¼ç¯å¢ƒä¸­æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´å…·æœ‰ç›¸åŒçš„æ•°æ® A(Availabilityï¼‰ï¼šå¯ç”¨æ€§ï¼Œå³å¿«é€Ÿè·å–æ•°æ®ï¼Œå¯ä»¥åœ¨ç¡®å®šçš„æ—¶é—´å†…è¿”å›æ“ä½œç»“æœï¼Œä¿è¯æ¯ä¸ªè¯·æ±‚ ä¸ç®¡æˆåŠŸæˆ–è€…å¤±è´¥éƒ½æœ‰å“åº” P(Tolerance of Network Partitionï¼‰ï¼šåˆ†åŒºå®¹å¿æ€§ï¼Œç³»ç»Ÿä¸­ä»»æ„ä¿¡æ¯çš„ä¸¢å¤±æˆ–å¤±è´¥ä¸ä¼šå½±å“ç³»ç»Ÿçš„ç»§ç»­è¿ä½œ ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ã€ å¯ç”¨æ€§å’Œåˆ†åŒºå®¹å¿æ€§è¿™ä¸‰ä¸ªéœ€æ±‚ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³å…¶ä¸­ä¸¤ä¸ª CAï¼šä¹Ÿå°±æ˜¯å¼ºè°ƒä¸€è‡´æ€§ï¼ˆCï¼‰å’Œå¯ç”¨æ€§ï¼ˆAï¼‰ï¼Œæ”¾å¼ƒåˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼Œæœ€ç®€å•çš„åšæ³•æ˜¯æŠŠæ‰€æœ‰ä¸äº‹åŠ¡ç›¸å…³çš„å†…å®¹éƒ½æ”¾åˆ°åŒä¸€å°æœºå™¨ä¸Šã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ç§åšæ³•ä¼šä¸¥é‡å½±å“ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚ä¼ ç»Ÿçš„å…³ç³»æ•°æ®åº“ï¼ˆMySQLã€SQL Serverå’Œ PostgreSQLï¼‰ï¼Œéƒ½é‡‡ç”¨äº†è¿™ç§è®¾è®¡åŸåˆ™ï¼Œå› æ­¤ï¼Œæ‰©å±•æ€§éƒ½æ¯”è¾ƒå·® CPï¼šä¹Ÿå°±æ˜¯å¼ºè°ƒä¸€è‡´æ€§ï¼ˆCï¼‰å’Œåˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼Œæ”¾å¼ƒå¯ç”¨æ€§ï¼ˆAï¼‰ï¼Œå½“å‡ºç°ç½‘ç»œåˆ†åŒºçš„æƒ…å†µæ—¶ï¼Œå—å½±å“çš„æœåŠ¡éœ€è¦ç­‰å¾…æ•°æ®ä¸€è‡´ï¼Œå› æ­¤åœ¨ç­‰å¾…æœŸé—´å°±æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ APï¼šä¹Ÿå°±æ˜¯å¼ºè°ƒå¯ç”¨æ€§ï¼ˆAï¼‰å’Œåˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼Œæ”¾å¼ƒä¸€è‡´æ€§ï¼ˆCï¼‰ï¼Œå…è®¸ç³»ç»Ÿè¿”å›ä¸ä¸€è‡´çš„æ•°æ® BASEBASE ç†è®ºæ˜¯ CAP ç†è®ºçš„å»¶å±•ï¼š BA(Basic Availability)ï¼šåŸºæœ¬å¯ç”¨æ€§ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†å‘ç”Ÿé—®é¢˜å˜å¾—ä¸å¯ç”¨æ—¶ï¼Œå…¶ä»–éƒ¨åˆ†ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œå³å…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚ S(Soft-state)ï¼šâ€œè½¯çŠ¶æ€â€æ˜¯ä¸â€œç¡¬çŠ¶æ€â€ç›¸å¯¹åº” çš„ä¸€ç§ææ³•ã€‚æ•°æ®åº“ä¿å­˜çš„æ•°æ®æ˜¯â€œç¡¬çŠ¶æ€â€æ—¶ï¼Œå¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œå³ä¿è¯æ•°æ®ä¸€ç›´æ˜¯æ­£ç¡®çš„ã€‚â€œè½¯çŠ¶æ€â€æ˜¯æŒ‡çŠ¶æ€å¯ä»¥æœ‰ä¸€æ®µæ—¶é—´ä¸åŒæ­¥ï¼Œå…·æœ‰ä¸€å®šçš„æ»åæ€§ã€‚ E(Eventual Consistency)ï¼šå…è®¸åç»­çš„è®¿é—®æ“ä½œå¯ä»¥æš‚æ—¶è¯»ä¸åˆ°æ›´æ–°åçš„æ•°æ®ï¼Œä½†æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå¿…é¡»æœ€ç»ˆè¯»åˆ°æ›´æ–°åçš„æ•°æ®ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:3","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#base"},{"categories":null,"content":" B+ æ ‘B+ æ ‘é‡‡ç”¨ In-Place Updateï¼Œå†™ä»£ä»·é«˜æ€§èƒ½å·®ï¼š å¶èŠ‚ç‚¹çš„å†™éƒ½æ˜¯éšæœºå†™ï¼Œç›¸å¯¹ä¸é¡ºåºå†™æ€§èƒ½å·® åˆ†è£‚ã€åˆå¹¶ç­‰ SMO æ“ä½œå¸¦æ¥å¤§é‡éšæœºå†™ SMO æŒ‡çš„æ˜¯ Structure Modifying Operation è§£å†³æ–¹æ³•å¯ä»¥å‚è€ƒæ—¥å¿—è®°å½•ï¼Œé€šè¿‡ Append-Only é¿å…éšæœºå†™ï¼Œä½†æ˜¯å®ƒä¸ B+ æ ‘å¶èŠ‚ç‚¹æœ‰åºçš„æ€§è´¨çŸ›ç›¾ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å¤šä¸ªéšæœºå†™æ“ä½œåˆå¹¶èµ·æ¥æ‰¹é‡å†™å…¥ï¼Œå®ç°é¡ºåºå†™ã€‚LSM-Tree å°±æ˜¯é€šè¿‡è¿™ä¸¤ç§æ–¹æ³•å®ç°äº†å†™å¿«ï¼Œè¯»ä¹Ÿæ¯”è¾ƒå¿«ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:4","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#b-æ ‘"},{"categories":null,"content":" LSM-Tree è®¾è®¡æ€è·¯ åŒæ—¶ç»“åˆå†…å­˜ç»“æ„å’Œç£ç›˜ç»“æ„ï¼šæ•°æ®å…ˆå†™åˆ°å†…å­˜ç»“æ„ï¼Œç„¶åå†å†™å…¥ç£ç›˜ Log-Structuredï¼šé‡‡ç”¨ Append æ–¹å¼å†™ç£ç›˜æ•°æ® Merge Writeï¼šå†…å­˜æ•°æ®æ‰¹é‡åˆå¹¶å†™å…¥ç£ç›˜ï¼Œå°†å¤šä¸ªå°çš„éšæœºå†™è½¬æ¢ä¸ºé¡ºåºå†™ æ•°æ®åˆ†å±‚å†™å…¥ç£ç›˜ï¼šé¿å…ä¸€æ¬¡æ‰¹é‡å†™çš„æ•°æ®é‡è¿‡å¤§ï¼Œå†…å­˜å‹åŠ›è¿‡å¤§ï¼Œæ‰¹é‡å†™æ—¶ I/O å¤ªå¤š æ¯ä¸€å±‚çš„æ•°æ®å‡æœ‰åº åœ¨ä¼ ç»Ÿ B+ æ ‘ç­‰ page-based å­˜å‚¨ç»“æ„ä¸­ï¼Œæ•°æ®å­˜æ”¾åœ¨å›ºå®šå¤§å°çš„ page é‡Œã€‚æ’å…¥æˆ–æ›´æ–°ä¸€æ¡è®°å½•æ—¶ï¼Œç³»ç»Ÿéœ€è¦æ‰¾åˆ°å¯¹åº”çš„ pageï¼Œç„¶åç›´æ¥ä¿®æ”¹è¿™ä¸ª pageã€‚å¦‚æœè¯¥ page å·²ç»åœ¨ç£ç›˜ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸€æ­¥é€šå¸¸è¡¨ç°ä¸ºä¸€æ¬¡éšæœºå†™ï¼šç£å¤´éœ€è¦å¯»å€åˆ°æŸä¸ªä½ç½®ï¼Œè¯»å…¥ pageï¼Œä¿®æ”¹ï¼Œå†å†™å›åŸä½ç½®ã€‚ è€Œ LSM-Tree ä¸­ MemTable é‡Œé¢è®°å½•æ•°è¾¾åˆ°é˜ˆå€¼åï¼Œè¢«å†»ç»“ä¸º immutable MemTable åˆ·ç›˜åˆ°ç£ç›˜ä¸­ï¼Œå°†éšæœºå†™åˆå¹¶ä¸ºé¡ºåºå†™ã€‚ æ•´ä½“æ¶æ„ Log LevelDB ä½¿ç”¨ WAL ä¹Ÿå°±æ˜¯ Write-Ahead-Logging æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚å½“ LevelDB è¿›è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼Œä¼šå°†æ“ä½œå…ˆå†™å…¥ LOG æ—¥å¿—æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶å­˜å‚¨ï¼‰ä¸­ï¼ˆæ³¨æ„æ˜¯å°†æ“ä½œå†™å…¥æ—¥å¿—ï¼Œè€Œä¸æ˜¯æ•°æ®å†™å…¥æ—¥å¿—)ã€‚WAL å°†æ“ä½œå†™å…¥ç£ç›˜ä¸­çš„ LOG æ—¥å¿—è¿›è¡ŒæŒä¹…åŒ–ï¼Œå½“ç³»ç»Ÿå´©æºƒæ—¶å¯ä»¥é‡æ”¾ LOG ä¸­çš„æ“ä½œæ¢å¤æ•°æ®ã€‚ MemTable \u0026 Immutable Memtable å½“æ“ä½œè¢«å†™å…¥ç£ç›˜çš„æ—¥å¿—ä¸­ä¹‹åï¼Œæ•°æ®ä¼šè¢«å†™å…¥å†…å­˜çš„ MemTableï¼Œå½“ MemTable ä¸­ç§¯ç´¯ä¸€å®šæ•°æ®å°±ä¼šæŠŠè¿™éƒ¨åˆ†æ•°æ®è½¬ä¸º Immutable Memtable å¹¶ä¸” new ä¸€ä¸ª MemTable ä»¥ä¾›å†™å…¥ï¼Œé¿å…å†™é˜»å¡ã€‚åå°çº¿ç¨‹ä¼šæŠŠ Immutable Memtable çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œç›®çš„æ˜¯ä¸ºäº†é™åˆ¶å†…å­˜å ç”¨ã€‚MemTable è¿™ä¸ªæ•°æ®ç»“æ„ä½¿å¾—æˆ‘ä»¬åœ¨å†…å­˜ä¸­å¯ä»¥è¿›è¡Œé«˜æ•ˆçš„è¯»å†™æ“ä½œï¼Œä»–æ˜¯åŸºäº Skiplist å®ç°çš„ã€‚ SSTable Immutable Memtable çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹åç§°ä¸º Level-0 SSTableï¼Œè¿™ä¸ªæ“ä½œç§°ä¸º Mirror Compactionã€‚SSTable ä¸€å…±æœ‰ 7 å±‚ï¼Œéšç€ä¸Šå±‚çš„ SSTable æ•°æ®å¢åŠ ï¼Œä¼šè¢«å¤šè·¯å½’å¹¶è¿›å…¥ä¸‹ä¸€å±‚çš„ SSTableï¼Œè¿™ä¸ªæ“ä½œç§°ä¸º Major Compactionã€‚å±‚æ•°è¶Šå¤§ï¼Œæ•°æ®è¶Šå¤šè¶Šæ—§ã€‚ å¤šå±‚ SSTable çš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå½“ Immutable Memtable å†™å…¥ç£ç›˜åä¼šå½¢æˆå¤šä¸ª Level-0 SSTableï¼Œè¿™äº›æŒä¹…åŒ–æ–‡ä»¶å¯èƒ½æ˜¯æœ‰äº¤é›†çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šè·¯åˆå¹¶ä¸Šå±‚ SSTable æ–‡ä»¶æ¥å‡å°‘å ç”¨çš„ç©ºé—´ï¼Œcompact æ“ä½œä¹Ÿç”±åå°çº¿ç¨‹å®Œæˆã€‚ å¯¹ level \u003e 0 çš„ SSTables, é€‰æ‹©å…¶ä¸­ä¸€ä¸ª SSTable ä¸ ä¸‹ä¸€å±‚ SSTables åšåˆå¹¶. å¯¹ level = 0 çš„ SSTables, åœ¨é€‰æ‹©ä¸€ä¸ª SSTable å, è¿˜éœ€è¦æ‰¾å‡ºæ‰€æœ‰ä¸è¿™ä¸ª SSTable æœ‰ key èŒƒå›´é‡å çš„ SSTables, æœ€åç»Ÿç»Ÿä¸ Level 1 çš„ SSTables åšåˆå¹¶. æ‰€ä»¥æ•°æ®çš„æµå‘æ˜¯ï¼šwrite -\u003e log(ç£ç›˜) -\u003e memTable(å†…å­˜) -\u003e immutable memtable(å†…å­˜) -\u003e sstable(ç£ç›˜) ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:5","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#lsm-tree"},{"categories":null,"content":" LSM-Tree è®¾è®¡æ€è·¯ åŒæ—¶ç»“åˆå†…å­˜ç»“æ„å’Œç£ç›˜ç»“æ„ï¼šæ•°æ®å…ˆå†™åˆ°å†…å­˜ç»“æ„ï¼Œç„¶åå†å†™å…¥ç£ç›˜ Log-Structuredï¼šé‡‡ç”¨ Append æ–¹å¼å†™ç£ç›˜æ•°æ® Merge Writeï¼šå†…å­˜æ•°æ®æ‰¹é‡åˆå¹¶å†™å…¥ç£ç›˜ï¼Œå°†å¤šä¸ªå°çš„éšæœºå†™è½¬æ¢ä¸ºé¡ºåºå†™ æ•°æ®åˆ†å±‚å†™å…¥ç£ç›˜ï¼šé¿å…ä¸€æ¬¡æ‰¹é‡å†™çš„æ•°æ®é‡è¿‡å¤§ï¼Œå†…å­˜å‹åŠ›è¿‡å¤§ï¼Œæ‰¹é‡å†™æ—¶ I/O å¤ªå¤š æ¯ä¸€å±‚çš„æ•°æ®å‡æœ‰åº åœ¨ä¼ ç»Ÿ B+ æ ‘ç­‰ page-based å­˜å‚¨ç»“æ„ä¸­ï¼Œæ•°æ®å­˜æ”¾åœ¨å›ºå®šå¤§å°çš„ page é‡Œã€‚æ’å…¥æˆ–æ›´æ–°ä¸€æ¡è®°å½•æ—¶ï¼Œç³»ç»Ÿéœ€è¦æ‰¾åˆ°å¯¹åº”çš„ pageï¼Œç„¶åç›´æ¥ä¿®æ”¹è¿™ä¸ª pageã€‚å¦‚æœè¯¥ page å·²ç»åœ¨ç£ç›˜ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸€æ­¥é€šå¸¸è¡¨ç°ä¸ºä¸€æ¬¡éšæœºå†™ï¼šç£å¤´éœ€è¦å¯»å€åˆ°æŸä¸ªä½ç½®ï¼Œè¯»å…¥ pageï¼Œä¿®æ”¹ï¼Œå†å†™å›åŸä½ç½®ã€‚ è€Œ LSM-Tree ä¸­ MemTable é‡Œé¢è®°å½•æ•°è¾¾åˆ°é˜ˆå€¼åï¼Œè¢«å†»ç»“ä¸º immutable MemTable åˆ·ç›˜åˆ°ç£ç›˜ä¸­ï¼Œå°†éšæœºå†™åˆå¹¶ä¸ºé¡ºåºå†™ã€‚ æ•´ä½“æ¶æ„ Log LevelDB ä½¿ç”¨ WAL ä¹Ÿå°±æ˜¯ Write-Ahead-Logging æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚å½“ LevelDB è¿›è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼Œä¼šå°†æ“ä½œå…ˆå†™å…¥ LOG æ—¥å¿—æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶å­˜å‚¨ï¼‰ä¸­ï¼ˆæ³¨æ„æ˜¯å°†æ“ä½œå†™å…¥æ—¥å¿—ï¼Œè€Œä¸æ˜¯æ•°æ®å†™å…¥æ—¥å¿—)ã€‚WAL å°†æ“ä½œå†™å…¥ç£ç›˜ä¸­çš„ LOG æ—¥å¿—è¿›è¡ŒæŒä¹…åŒ–ï¼Œå½“ç³»ç»Ÿå´©æºƒæ—¶å¯ä»¥é‡æ”¾ LOG ä¸­çš„æ“ä½œæ¢å¤æ•°æ®ã€‚ MemTable \u0026 Immutable Memtable å½“æ“ä½œè¢«å†™å…¥ç£ç›˜çš„æ—¥å¿—ä¸­ä¹‹åï¼Œæ•°æ®ä¼šè¢«å†™å…¥å†…å­˜çš„ MemTableï¼Œå½“ MemTable ä¸­ç§¯ç´¯ä¸€å®šæ•°æ®å°±ä¼šæŠŠè¿™éƒ¨åˆ†æ•°æ®è½¬ä¸º Immutable Memtable å¹¶ä¸” new ä¸€ä¸ª MemTable ä»¥ä¾›å†™å…¥ï¼Œé¿å…å†™é˜»å¡ã€‚åå°çº¿ç¨‹ä¼šæŠŠ Immutable Memtable çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œç›®çš„æ˜¯ä¸ºäº†é™åˆ¶å†…å­˜å ç”¨ã€‚MemTable è¿™ä¸ªæ•°æ®ç»“æ„ä½¿å¾—æˆ‘ä»¬åœ¨å†…å­˜ä¸­å¯ä»¥è¿›è¡Œé«˜æ•ˆçš„è¯»å†™æ“ä½œï¼Œä»–æ˜¯åŸºäº Skiplist å®ç°çš„ã€‚ SSTable Immutable Memtable çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹åç§°ä¸º Level-0 SSTableï¼Œè¿™ä¸ªæ“ä½œç§°ä¸º Mirror Compactionã€‚SSTable ä¸€å…±æœ‰ 7 å±‚ï¼Œéšç€ä¸Šå±‚çš„ SSTable æ•°æ®å¢åŠ ï¼Œä¼šè¢«å¤šè·¯å½’å¹¶è¿›å…¥ä¸‹ä¸€å±‚çš„ SSTableï¼Œè¿™ä¸ªæ“ä½œç§°ä¸º Major Compactionã€‚å±‚æ•°è¶Šå¤§ï¼Œæ•°æ®è¶Šå¤šè¶Šæ—§ã€‚ å¤šå±‚ SSTable çš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå½“ Immutable Memtable å†™å…¥ç£ç›˜åä¼šå½¢æˆå¤šä¸ª Level-0 SSTableï¼Œè¿™äº›æŒä¹…åŒ–æ–‡ä»¶å¯èƒ½æ˜¯æœ‰äº¤é›†çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šè·¯åˆå¹¶ä¸Šå±‚ SSTable æ–‡ä»¶æ¥å‡å°‘å ç”¨çš„ç©ºé—´ï¼Œcompact æ“ä½œä¹Ÿç”±åå°çº¿ç¨‹å®Œæˆã€‚ å¯¹ level \u003e 0 çš„ SSTables, é€‰æ‹©å…¶ä¸­ä¸€ä¸ª SSTable ä¸ ä¸‹ä¸€å±‚ SSTables åšåˆå¹¶. å¯¹ level = 0 çš„ SSTables, åœ¨é€‰æ‹©ä¸€ä¸ª SSTable å, è¿˜éœ€è¦æ‰¾å‡ºæ‰€æœ‰ä¸è¿™ä¸ª SSTable æœ‰ key èŒƒå›´é‡å çš„ SSTables, æœ€åç»Ÿç»Ÿä¸ Level 1 çš„ SSTables åšåˆå¹¶. æ‰€ä»¥æ•°æ®çš„æµå‘æ˜¯ï¼šwrite -\u003e log(ç£ç›˜) -\u003e memTable(å†…å­˜) -\u003e immutable memtable(å†…å­˜) -\u003e sstable(ç£ç›˜) ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:5","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è®¾è®¡æ€è·¯"},{"categories":null,"content":" LSM-Tree è®¾è®¡æ€è·¯ åŒæ—¶ç»“åˆå†…å­˜ç»“æ„å’Œç£ç›˜ç»“æ„ï¼šæ•°æ®å…ˆå†™åˆ°å†…å­˜ç»“æ„ï¼Œç„¶åå†å†™å…¥ç£ç›˜ Log-Structuredï¼šé‡‡ç”¨ Append æ–¹å¼å†™ç£ç›˜æ•°æ® Merge Writeï¼šå†…å­˜æ•°æ®æ‰¹é‡åˆå¹¶å†™å…¥ç£ç›˜ï¼Œå°†å¤šä¸ªå°çš„éšæœºå†™è½¬æ¢ä¸ºé¡ºåºå†™ æ•°æ®åˆ†å±‚å†™å…¥ç£ç›˜ï¼šé¿å…ä¸€æ¬¡æ‰¹é‡å†™çš„æ•°æ®é‡è¿‡å¤§ï¼Œå†…å­˜å‹åŠ›è¿‡å¤§ï¼Œæ‰¹é‡å†™æ—¶ I/O å¤ªå¤š æ¯ä¸€å±‚çš„æ•°æ®å‡æœ‰åº åœ¨ä¼ ç»Ÿ B+ æ ‘ç­‰ page-based å­˜å‚¨ç»“æ„ä¸­ï¼Œæ•°æ®å­˜æ”¾åœ¨å›ºå®šå¤§å°çš„ page é‡Œã€‚æ’å…¥æˆ–æ›´æ–°ä¸€æ¡è®°å½•æ—¶ï¼Œç³»ç»Ÿéœ€è¦æ‰¾åˆ°å¯¹åº”çš„ pageï¼Œç„¶åç›´æ¥ä¿®æ”¹è¿™ä¸ª pageã€‚å¦‚æœè¯¥ page å·²ç»åœ¨ç£ç›˜ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸€æ­¥é€šå¸¸è¡¨ç°ä¸ºä¸€æ¬¡éšæœºå†™ï¼šç£å¤´éœ€è¦å¯»å€åˆ°æŸä¸ªä½ç½®ï¼Œè¯»å…¥ pageï¼Œä¿®æ”¹ï¼Œå†å†™å›åŸä½ç½®ã€‚ è€Œ LSM-Tree ä¸­ MemTable é‡Œé¢è®°å½•æ•°è¾¾åˆ°é˜ˆå€¼åï¼Œè¢«å†»ç»“ä¸º immutable MemTable åˆ·ç›˜åˆ°ç£ç›˜ä¸­ï¼Œå°†éšæœºå†™åˆå¹¶ä¸ºé¡ºåºå†™ã€‚ æ•´ä½“æ¶æ„ Log LevelDB ä½¿ç”¨ WAL ä¹Ÿå°±æ˜¯ Write-Ahead-Logging æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚å½“ LevelDB è¿›è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼Œä¼šå°†æ“ä½œå…ˆå†™å…¥ LOG æ—¥å¿—æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶å­˜å‚¨ï¼‰ä¸­ï¼ˆæ³¨æ„æ˜¯å°†æ“ä½œå†™å…¥æ—¥å¿—ï¼Œè€Œä¸æ˜¯æ•°æ®å†™å…¥æ—¥å¿—)ã€‚WAL å°†æ“ä½œå†™å…¥ç£ç›˜ä¸­çš„ LOG æ—¥å¿—è¿›è¡ŒæŒä¹…åŒ–ï¼Œå½“ç³»ç»Ÿå´©æºƒæ—¶å¯ä»¥é‡æ”¾ LOG ä¸­çš„æ“ä½œæ¢å¤æ•°æ®ã€‚ MemTable \u0026 Immutable Memtable å½“æ“ä½œè¢«å†™å…¥ç£ç›˜çš„æ—¥å¿—ä¸­ä¹‹åï¼Œæ•°æ®ä¼šè¢«å†™å…¥å†…å­˜çš„ MemTableï¼Œå½“ MemTable ä¸­ç§¯ç´¯ä¸€å®šæ•°æ®å°±ä¼šæŠŠè¿™éƒ¨åˆ†æ•°æ®è½¬ä¸º Immutable Memtable å¹¶ä¸” new ä¸€ä¸ª MemTable ä»¥ä¾›å†™å…¥ï¼Œé¿å…å†™é˜»å¡ã€‚åå°çº¿ç¨‹ä¼šæŠŠ Immutable Memtable çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œç›®çš„æ˜¯ä¸ºäº†é™åˆ¶å†…å­˜å ç”¨ã€‚MemTable è¿™ä¸ªæ•°æ®ç»“æ„ä½¿å¾—æˆ‘ä»¬åœ¨å†…å­˜ä¸­å¯ä»¥è¿›è¡Œé«˜æ•ˆçš„è¯»å†™æ“ä½œï¼Œä»–æ˜¯åŸºäº Skiplist å®ç°çš„ã€‚ SSTable Immutable Memtable çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹åç§°ä¸º Level-0 SSTableï¼Œè¿™ä¸ªæ“ä½œç§°ä¸º Mirror Compactionã€‚SSTable ä¸€å…±æœ‰ 7 å±‚ï¼Œéšç€ä¸Šå±‚çš„ SSTable æ•°æ®å¢åŠ ï¼Œä¼šè¢«å¤šè·¯å½’å¹¶è¿›å…¥ä¸‹ä¸€å±‚çš„ SSTableï¼Œè¿™ä¸ªæ“ä½œç§°ä¸º Major Compactionã€‚å±‚æ•°è¶Šå¤§ï¼Œæ•°æ®è¶Šå¤šè¶Šæ—§ã€‚ å¤šå±‚ SSTable çš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå½“ Immutable Memtable å†™å…¥ç£ç›˜åä¼šå½¢æˆå¤šä¸ª Level-0 SSTableï¼Œè¿™äº›æŒä¹…åŒ–æ–‡ä»¶å¯èƒ½æ˜¯æœ‰äº¤é›†çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šè·¯åˆå¹¶ä¸Šå±‚ SSTable æ–‡ä»¶æ¥å‡å°‘å ç”¨çš„ç©ºé—´ï¼Œcompact æ“ä½œä¹Ÿç”±åå°çº¿ç¨‹å®Œæˆã€‚ å¯¹ level \u003e 0 çš„ SSTables, é€‰æ‹©å…¶ä¸­ä¸€ä¸ª SSTable ä¸ ä¸‹ä¸€å±‚ SSTables åšåˆå¹¶. å¯¹ level = 0 çš„ SSTables, åœ¨é€‰æ‹©ä¸€ä¸ª SSTable å, è¿˜éœ€è¦æ‰¾å‡ºæ‰€æœ‰ä¸è¿™ä¸ª SSTable æœ‰ key èŒƒå›´é‡å çš„ SSTables, æœ€åç»Ÿç»Ÿä¸ Level 1 çš„ SSTables åšåˆå¹¶. æ‰€ä»¥æ•°æ®çš„æµå‘æ˜¯ï¼šwrite -\u003e log(ç£ç›˜) -\u003e memTable(å†…å­˜) -\u003e immutable memtable(å†…å­˜) -\u003e sstable(ç£ç›˜) ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:5","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æ•´ä½“æ¶æ„"},{"categories":null,"content":" MemTableMemTable å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª Skiplistï¼Œå®ƒæ”¯æŒé«˜æ•ˆçš„æ’å…¥å’ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œç›¸æ¯” B+ æ ‘ä¼˜åŠ¿åœ¨äºé¿å…äº†æ’å…¥æ“ä½œæ—¶å€™çš„ SMO æ“ä½œçš„å¼€é”€ã€‚ä½†æ˜¯ Skiplist å®ƒåªæ”¯æŒå­˜å‚¨ä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬æ˜¯æ€ä¹ˆåšåˆ°é€šè¿‡ key æŸ¥æ‰¾ value çš„å‘¢ï¼Ÿ MemTable å°† key å’Œ value ç»„åˆæˆä¸€ä¸ªæ–°çš„ SkipList Keyï¼ˆkey å’Œ value éƒ½æ˜¯å˜é•¿å­—èŠ‚æµï¼‰ä¸­ï¼ŒKey/Value é”®å€¼å¯¹å­˜å‚¨æ ¼å¼å¦‚ä¸Šå›¾ã€‚è¿™æ ·é€šè¿‡ UserKey è¿›è¡ŒæŸ¥æ‰¾æ“ä½œæ—¶å€™ï¼Œåªéœ€è¦å¯¹ InternalKey çš„å›ºå®šéƒ¨åˆ†ï¼ˆSequenceNumber å’Œ ValueType çš„é•¿åº¦å›ºå®šï¼‰è¿›è¡Œåˆ¤æ–­å°±å¯ä»¥äº†ã€‚ SkipList Key é‡Œé¢å­˜çš„ ValueType æ ‡è¯†è¿™è¿™æ¡è®°å½•æ˜¯ Delete æˆ–è€… Updateï¼Œä»¥æ­¤å®ç°äº†éå°±åœ°æ›´æ–°ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:6","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#memtable"},{"categories":null,"content":" SSTable SSTable ä¸­çš„æ•°æ®æŒ‰ç…§åŠŸèƒ½å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ å—åŒºï¼š Data Block åŒºï¼šå­˜æ”¾ key/value æ•°æ®ã€‚ Meta Block åŒºï¼šå­˜æ”¾è¿‡æ»¤å™¨æˆ–å½“å‰ SSTable ç›¸å…³çš„ç»Ÿè®¡æ•°æ®ã€‚ MetaIndex Blockï¼šä»…æœ‰ 1 ä¸ª Blockï¼Œè¯¥ Block ä¸­å­˜æ”¾äº†æ‰€æœ‰ Meta Block çš„ç´¢å¼•ã€‚ Index Block åŒºï¼šæ‰€æœ‰ Data Block çš„ç´¢å¼•ï¼ˆå®é™…ä¸Šåªæœ‰ä¸€ä¸ª Index Blockï¼‰ã€‚ Footerï¼šå¤§å°å›ºå®šçš„ä¸€ä¸ªåŒºåŸŸï¼ˆ48Bï¼‰ã€‚ ç”±äºæ¯ä¸ª SSTable çš„å¤§å°å›ºå®šï¼Œå› æ­¤å½“æˆ‘ä»¬éœ€è¦æ¢å¤/è¯»å–ä¸€ä¸ª SSTable æ–‡ä»¶æ—¶ï¼Œé¦–å…ˆä¼šè¯»å–æ–‡ä»¶çš„ Footer å¾—åˆ° MetaIndex Block å’Œ Index Block çš„ä½ç½®ï¼Œå†é€šè¿‡ä»–ä»¬ä¸¤ä¸ªçŸ¥é“ Data Blocks å’Œ Meta Blocks çš„ä½ç½®ï¼ˆåç§»é‡ï¼‰ï¼Œè¿™æ—¶å€™æ—¢å¯ä»¥éå†æ•°æ®äº†ã€‚ Meta Block é‡Œé¢å­˜äº†å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ç§å·§å¦™çš„æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œç‰¹ç‚¹æ˜¯é«˜æ•ˆåœ°æ’å…¥å’ŒæŸ¥è¯¢ï¼Œå¯ä»¥ç”¨æ¥å‘Šè¯‰ä½ æŸä¸ªé”®ä¸€å®šä¸å­˜åœ¨æˆ–è€…å¯èƒ½å­˜åœ¨ã€‚ç›¸æ¯” Map å’Œ Set å¸ƒéš†è¿‡æ»¤å™¨å ç”¨çš„ç©ºé—´å°‘å¾ˆå¤šï¼Œä½†æ˜¯ç»“æœå…·æœ‰å‡é˜³æ€§ï¼Œå¦‚æœè¿”å›é”®ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆé”®ä¸€å®šä¸å­˜åœ¨ï¼Œå¦‚æœè¿”å›é”®å­˜åœ¨ï¼Œé‚£ä¹ˆé”®æœ‰å¯èƒ½ä¸å­˜åœ¨ã€åˆæœ‰å¯èƒ½å­˜åœ¨ã€‚ é‚£å¸ƒéš†è¿‡æ»¤å™¨æ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬æé«˜æŸ¥æ‰¾æ•ˆç‡çš„å‘¢ï¼Ÿæˆ‘ä»¬å›å¿†ä¸€ä¸‹åœ¨ SSTable ä¸­è¯»å–ä¸€ä¸ª Key çš„è¿‡ç¨‹ï¼š è¯»å– SSTable çš„ Footerï¼Œæ ¹æ®é‡Œé¢çš„ä¿¡æ¯å†è¯»å– Index Block ä¸ Meta Index Blockã€‚ æ ¹æ® Meta Index Block è¯»å–å¸ƒéš†è¿‡æ»¤å™¨åˆ°å†…å­˜ã€‚ åœ¨å†…å­˜ä¸­å¯¹ Index Block è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå¾—åˆ° Key æ‰€åœ¨çš„ BlockHandleï¼ˆä¹Ÿå°±æ˜¯åç§»ï¼‰ã€‚ æ ¹æ® BlockHandle è·å–å¸ƒéš†è¿‡æ»¤å™¨çš„ç¼–å·ï¼Œä¹Ÿå°±æ˜¯åç§»ã€‚ é€šè¿‡å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ Key æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ç»“æŸã€‚ï¼ˆè¿™é‡ŒèŠ‚çœäº†æ—¶é—´å¼€é”€ï¼‰ å¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆè¯»å–å¯¹åº”çš„ Data Blockï¼Œè¿›è¡ŒæŸ¥æ‰¾ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:7","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#sstable"},{"categories":null,"content":" å†™æ“ä½œ å½“æ”¶åˆ°ä¸€ä¸ªå†™è¯·æ±‚æ—¶ï¼Œä¼šå…ˆæŠŠè¯¥æ¡æ•°æ®è®°å½•åœ¨ WAL Log é‡Œé¢ï¼Œç”¨ä½œæ•…éšœæ¢å¤ å½“å†™å®Œ WAL Log åï¼Œä¼šæŠŠè¯¥æ¡æ•°æ®å†™å…¥ Memtable å½“ Memtable è¶…è¿‡ä¸€å®šçš„å¤§å°åï¼Œä¼šåœ¨å†…å­˜é‡Œé¢å†»ç»“ï¼Œå˜æˆä¸å¯æ›´æ–°çš„ Immutable Memtableï¼ŒåŒæ—¶æ–°ç”Ÿæˆä¸€ä¸ª Memtable ç»§ç»­æä¾›æœåŠ¡ å½“ Immutable Memtable æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶ Flush åˆ°ç£ç›˜ä¸Šçš„ L0 å±‚ï¼Œæ­¤æ­¥éª¤ä¹Ÿç§°ä¸º Minor Compaction Flushæ˜¯é¡ºåºå†™ L0 å±‚çš„ SSTable çš„ key å¯èƒ½ä¼šå‡ºç°é‡å ï¼Œåœ¨å±‚æ•°å¤§äº L0 å±‚ä¹‹åçš„ SSTable ä¸å­˜åœ¨é‡å  key å½“æ¯å±‚çš„ SSTable çš„ score è¶…è¿‡é˜ˆå€¼ï¼ˆscoreåŸºäºå¤§å°æˆ– è€…SSTæ–‡ä»¶ä¸ªæ•°è®¡ç®—ï¼‰ï¼Œè§¦å‘ Major Compactionï¼Œé¿å…æµªè´¹ç©ºé—´ æ³¨æ„ç”±äº SSTable éƒ½æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥é‡‡ç”¨ merge sort è¿›è¡Œé«˜æ•ˆåˆå¹¶ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:8","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#å†™æ“ä½œ"},{"categories":null,"content":" è¯»æ“ä½œ å½“æ”¶åˆ°ä¸€ä¸ªè¯»è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šç›´æ¥å…ˆåœ¨ Memtable å’Œ Immutable Memtable é‡ŒæŸ¥è¯¢ ï¼Œå¦‚æœæŸ¥è¯¢åˆ°å°±è¿”å› å¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°å°±ä¼šä¾æ¬¡ä¸‹æ²‰ï¼Œç›´åˆ°æŠŠæ‰€æœ‰çš„ Level çš„ SSTable æŸ¥è¯¢ä¸€éå¾—åˆ°æœ€ç»ˆç»“æœï¼ˆå¾ˆæ˜¾ç„¶ï¼Œè¶Šå¾€ä¸‹å±‚æŸ¥è¯¢ IO ä»£ä»·è¶Šé«˜ï¼‰ LevelDBé‡‡ç”¨çš„è¯»ä¼˜åŒ–ç­–ç•¥ï¼š å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¦‚æœ Key ä¸åœ¨ SSTable å°±å¯ä»¥é¿å…æ‰«æ SSTable å¢åŠ Index Blockï¼Œé¿å…æ‰«ææ•´ä¸ªSSTableçš„æ‰€æœ‰ Block ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:9","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#è¯»æ“ä½œ"},{"categories":null,"content":" Compaction Minor CompactionMinor Compaction å°±æ˜¯å†…å­˜ MemTable è¾¾åˆ°é˜ˆå€¼è½¬ä¸º Immutable Memtable ç„¶åè½ç›˜åˆ°ç£ç›˜ï¼Œå½¢æˆ SSTable çš„è¿‡ç¨‹ã€‚å› ä¸ºæ˜¯æ•´ä¸ª Immutable Memtable dumpåˆ°æ–‡ä»¶ï¼Œæ‰€ä»¥ L0 çš„ SSTable ä¹‹é—´å¯èƒ½ä¼šå­˜åœ¨é‡å¤çš„keyã€‚ Major CompactionMajor Compaction åˆ†ä¸º Size Compaction å’Œ Seek Compactionï¼š Size Compactionï¼šæ ¹æ®æ¯å±‚æ€» SSTable å¤§å°è§¦å‘ï¼ˆ Level-0 æ ¹æ® SSTable æ•°é‡ï¼‰ Seek Compactionï¼šæ¯ä¸ªæ–°çš„ SSTable æ–‡ä»¶ç»´æŠ¤ä¸€ä¸ª allowed_seek çš„åˆå§‹é˜ˆå€¼ï¼Œè¡¨ç¤ºæœ€å¤šå®¹å¿å¤šå°‘æ¬¡ seek missã€‚å½“ allowed_seeks é€’å‡åˆ°å°äº 0 çš„æ—¶å€™ï¼Œå°±ä¼šå°†å¯¹åº”æ–‡ä»¶æ ‡è®°ä¸ºéœ€è¦ Compactionã€‚ L0 â†’ L1 Compactionï¼š é€‰æ‹© L0 å±‚çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ å°† L0 ä¸ L1 ä¸­æ‰€æœ‰ä¸é€‰ä¸­æ–‡ä»¶çš„ key range é‡å çš„æ–‡ä»¶éƒ½è¯»å…¥å†…å­˜ å¤šè·¯å½’å¹¶æ’åºï¼Œå¹¶æŠ›å¼ƒæ‰æ— æ•ˆçš„ KV æŒ‰ç…§ SSTable å¤§å°é‡æ–°å†™å…¥ L1å±‚ å¦‚æœ L1 å±‚ä¹Ÿè§¦å‘äº†compactionæ¡ä»¶ï¼Œåˆ™ä¼šç»§ç»­è§¦å‘ L1 åˆå¹¶ æ ¹æ® SequenceNumber å’Œ ValueTypeï¼Œæœ‰äº›è®°å½•ä¼šè¢«æŠ›å¼ƒ æ›´é«˜å±‚çš„ Compaction ç”±äº SSTable é‡Œé¢çš„ key ä¸é‡å ï¼Œæ‰€ä»¥å°† Li+1 å±‚ä¸­æ‰€æœ‰ä¸ Li å±‚é€‰ä¸­çš„ SSTable æ–‡ä»¶çš„ key range éƒ½é‡å çš„æ–‡ä»¶ä½œä¸ºå€™é€‰åˆå¹¶å¯¹è±¡ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:10","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#compaction"},{"categories":null,"content":" Compaction Minor CompactionMinor Compaction å°±æ˜¯å†…å­˜ MemTable è¾¾åˆ°é˜ˆå€¼è½¬ä¸º Immutable Memtable ç„¶åè½ç›˜åˆ°ç£ç›˜ï¼Œå½¢æˆ SSTable çš„è¿‡ç¨‹ã€‚å› ä¸ºæ˜¯æ•´ä¸ª Immutable Memtable dumpåˆ°æ–‡ä»¶ï¼Œæ‰€ä»¥ L0 çš„ SSTable ä¹‹é—´å¯èƒ½ä¼šå­˜åœ¨é‡å¤çš„keyã€‚ Major CompactionMajor Compaction åˆ†ä¸º Size Compaction å’Œ Seek Compactionï¼š Size Compactionï¼šæ ¹æ®æ¯å±‚æ€» SSTable å¤§å°è§¦å‘ï¼ˆ Level-0 æ ¹æ® SSTable æ•°é‡ï¼‰ Seek Compactionï¼šæ¯ä¸ªæ–°çš„ SSTable æ–‡ä»¶ç»´æŠ¤ä¸€ä¸ª allowed_seek çš„åˆå§‹é˜ˆå€¼ï¼Œè¡¨ç¤ºæœ€å¤šå®¹å¿å¤šå°‘æ¬¡ seek missã€‚å½“ allowed_seeks é€’å‡åˆ°å°äº 0 çš„æ—¶å€™ï¼Œå°±ä¼šå°†å¯¹åº”æ–‡ä»¶æ ‡è®°ä¸ºéœ€è¦ Compactionã€‚ L0 â†’ L1 Compactionï¼š é€‰æ‹© L0 å±‚çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ å°† L0 ä¸ L1 ä¸­æ‰€æœ‰ä¸é€‰ä¸­æ–‡ä»¶çš„ key range é‡å çš„æ–‡ä»¶éƒ½è¯»å…¥å†…å­˜ å¤šè·¯å½’å¹¶æ’åºï¼Œå¹¶æŠ›å¼ƒæ‰æ— æ•ˆçš„ KV æŒ‰ç…§ SSTable å¤§å°é‡æ–°å†™å…¥ L1å±‚ å¦‚æœ L1 å±‚ä¹Ÿè§¦å‘äº†compactionæ¡ä»¶ï¼Œåˆ™ä¼šç»§ç»­è§¦å‘ L1 åˆå¹¶ æ ¹æ® SequenceNumber å’Œ ValueTypeï¼Œæœ‰äº›è®°å½•ä¼šè¢«æŠ›å¼ƒ æ›´é«˜å±‚çš„ Compaction ç”±äº SSTable é‡Œé¢çš„ key ä¸é‡å ï¼Œæ‰€ä»¥å°† Li+1 å±‚ä¸­æ‰€æœ‰ä¸ Li å±‚é€‰ä¸­çš„ SSTable æ–‡ä»¶çš„ key range éƒ½é‡å çš„æ–‡ä»¶ä½œä¸ºå€™é€‰åˆå¹¶å¯¹è±¡ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:10","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#minor-compaction"},{"categories":null,"content":" Compaction Minor CompactionMinor Compaction å°±æ˜¯å†…å­˜ MemTable è¾¾åˆ°é˜ˆå€¼è½¬ä¸º Immutable Memtable ç„¶åè½ç›˜åˆ°ç£ç›˜ï¼Œå½¢æˆ SSTable çš„è¿‡ç¨‹ã€‚å› ä¸ºæ˜¯æ•´ä¸ª Immutable Memtable dumpåˆ°æ–‡ä»¶ï¼Œæ‰€ä»¥ L0 çš„ SSTable ä¹‹é—´å¯èƒ½ä¼šå­˜åœ¨é‡å¤çš„keyã€‚ Major CompactionMajor Compaction åˆ†ä¸º Size Compaction å’Œ Seek Compactionï¼š Size Compactionï¼šæ ¹æ®æ¯å±‚æ€» SSTable å¤§å°è§¦å‘ï¼ˆ Level-0 æ ¹æ® SSTable æ•°é‡ï¼‰ Seek Compactionï¼šæ¯ä¸ªæ–°çš„ SSTable æ–‡ä»¶ç»´æŠ¤ä¸€ä¸ª allowed_seek çš„åˆå§‹é˜ˆå€¼ï¼Œè¡¨ç¤ºæœ€å¤šå®¹å¿å¤šå°‘æ¬¡ seek missã€‚å½“ allowed_seeks é€’å‡åˆ°å°äº 0 çš„æ—¶å€™ï¼Œå°±ä¼šå°†å¯¹åº”æ–‡ä»¶æ ‡è®°ä¸ºéœ€è¦ Compactionã€‚ L0 â†’ L1 Compactionï¼š é€‰æ‹© L0 å±‚çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ å°† L0 ä¸ L1 ä¸­æ‰€æœ‰ä¸é€‰ä¸­æ–‡ä»¶çš„ key range é‡å çš„æ–‡ä»¶éƒ½è¯»å…¥å†…å­˜ å¤šè·¯å½’å¹¶æ’åºï¼Œå¹¶æŠ›å¼ƒæ‰æ— æ•ˆçš„ KV æŒ‰ç…§ SSTable å¤§å°é‡æ–°å†™å…¥ L1å±‚ å¦‚æœ L1 å±‚ä¹Ÿè§¦å‘äº†compactionæ¡ä»¶ï¼Œåˆ™ä¼šç»§ç»­è§¦å‘ L1 åˆå¹¶ æ ¹æ® SequenceNumber å’Œ ValueTypeï¼Œæœ‰äº›è®°å½•ä¼šè¢«æŠ›å¼ƒ æ›´é«˜å±‚çš„ Compaction ç”±äº SSTable é‡Œé¢çš„ key ä¸é‡å ï¼Œæ‰€ä»¥å°† Li+1 å±‚ä¸­æ‰€æœ‰ä¸ Li å±‚é€‰ä¸­çš„ SSTable æ–‡ä»¶çš„ key range éƒ½é‡å çš„æ–‡ä»¶ä½œä¸ºå€™é€‰åˆå¹¶å¯¹è±¡ã€‚ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:9:10","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#major-compaction"},{"categories":null,"content":" çœŸé¢˜","date":"2026-01-13","objectID":"/posts/ustc-db-review/:10:0","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#çœŸé¢˜"},{"categories":null,"content":" æœªçŸ¥å¹´ä»½å•é€‰é¢˜ Cï¼šLRU é€‰æ‹©ç½®æ¢é¡µå–è¡¨å¤´ï¼Œåªè€ƒè™‘æ—¶é—´å±€éƒ¨æ€§ï¼Œä¼šå¸¦æ¥ç¼“å­˜æ±¡æŸ“ Aï¼šSetDirty åªä¼šå†…å­˜ä¸­æ ‡è®°è„ Aï¼šRedo Undo å’Œ æ›´æ–°ç­–ç•¥å¯ä»¥ä¸¤ä¸¤ç»„åˆï¼Œcheckpoint æ—¶å€™æœªå®Œæˆäº‹åŠ¡ä¸ä¼š abort Aï¼šå’Œ CPU æ— å…³ Cï¼šæ•£åˆ—è¡¨ä¸èƒ½èŒƒå›´æŸ¥è¯¢ï¼Œå› ä¸ºä¸æ˜¯é¡ºåºå­˜å‚¨ åˆ¤æ–­é¢˜ âˆš âˆš âˆš âˆš Ã—ï¼šä¸æ”¯æŒäº‹åŠ¡ Ã—ï¼šå›ºå®šæ ¼å¼å¯èƒ½å˜é•¿ âˆš Ã—ï¼šæ³¨æ„æ˜¯åœ¨ç£ç›˜å†™ä¹‹å‰å°†æ—¥è®°å†™å…¥ç£ç›˜ï¼Œè€Œä¸æ˜¯ write æ“ä½œä¹‹å‰ï¼Œwrite åªæ˜¯å†™åˆ°å†…å­˜çš„ Memtable Ã—ï¼šSQL ä¹Ÿå¯ä»¥å˜é•¿ Ã—ï¼š2PL ä¼šè„è¯» åº”ç”¨é¢˜ ","date":"2026-01-13","objectID":"/posts/ustc-db-review/:10:1","series":["æœŸæœ«å¤ä¹ "],"tags":["æ•°æ®åº“","å¤ä¹ "],"title":"é«˜çº§æ•°æ®åº“ç³»ç»Ÿå¤ä¹ ","uri":"/posts/ustc-db-review/#æœªçŸ¥å¹´ä»½"},{"categories":null,"content":" ç¬¬äºŒç«  ç®—æ³•åˆæ­¥","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:1:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬äºŒç« -ç®—æ³•åˆæ­¥"},{"categories":null,"content":" æ’å…¥æ’åº python arr = [] for i in range(1, n): key = arr[i] j = i - 1 while j and arr[j] \u003e key: arr[j] = arr[j-1] j -= 1 arr[j+1] = key Note å‡è®¾å‰é¢å…ƒç´ å·²ç»æœ‰åºï¼Œä¸æ–­å°†æ–°å…ƒç´ æ’å…¥åˆ°åˆé€‚çš„ä½ç½®ï¼Œä¿è¯ä¾ç„¶æœ‰åº èƒ½ä¸èƒ½ç”¨äºŒåˆ†æŸ¥æ‰¾ä¼˜åŒ–æœ€åæƒ…å†µçš„æ—¶é—´å¤æ‚åº¦ï¼Ÿ ä¸è¡Œã€‚å› ä¸ºæŸ¥æ‰¾çš„æ—¶é—´é™ä¸‹æ¥äº†ï¼Œä½†æ˜¯è¿˜æœ‰ç§»åŠ¨å…ƒç´ çš„æ—¶é—´ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:1:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ’å…¥æ’åº"},{"categories":null,"content":" å¾ªç¯ä¸å˜å¼æ¯”å¦‚æ’å…¥æ’åºï¼Œæ¯æ¬¡å¾ªç¯ä»æ•°ç»„ A ä¸­å–å‡ºç¬¬ j ä¸ªå…ƒç´ æ’å…¥æœ‰åºåŒº A[1 .. j-1]ï¼Œç„¶åé€’å¢ jã€‚è¿™æ ·A[1 .. j-1] çš„æœ‰åºæ€§å§‹ç»ˆå¾—åˆ°ä¿æŒï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œå¾ªç¯ä¸å˜â€äº†ã€‚ è¦ç”¨å¾ªç¯ä¸å˜å¼è¯æ˜ä¸€ä¸ªå¾ªç¯çš„æ­£ç¡®æ€§ï¼Œé€šå¸¸éœ€è¦è¯æ˜ä»¥ä¸‹ä¸‰ç‚¹ï¼š åˆå§‹åŒ–ï¼šå¾ªç¯çš„ç¬¬ä¸€æ¬¡è¿­ä»£ä¹‹å‰ï¼Œå®ƒä¸ºçœŸã€‚ ä¿æŒï¼šå¦‚æœå¾ªç¯çš„æŸæ¬¡è¿­ä»£ä¹‹å‰å®ƒä¸ºçœŸï¼Œé‚£ä¹ˆä¸‹æ¬¡è¿­ä»£ä¹‹å‰å®ƒä»ä¸ºçœŸã€‚ ç»ˆæ­¢ï¼šåœ¨å¾ªç¯ç»ˆæ­¢æ—¶ä»ä¸ºçœŸï¼Œä¸å˜å¼ä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªæœ‰ç”¨çš„æ€§è´¨ï¼Œè¯¥æ€§è´¨æœ‰åŠ©åƒè¯æ˜ç®—æ³•æ˜¯æ­£ç¡®çš„ ä¾‹ï¼šç”¨å¾ªç¯ä¸å˜å¼è¯æ˜æ’å…¥æ’åºç®—æ³•çš„æ­£ç¡®æ€§ å¾ªç¯ä¸å˜å¼ï¼šåœ¨æ¯æ¬¡å¾ªç¯ i å¼€å§‹å‰ï¼Œæ•°ç»„çš„ [0, â€¦, i-1] éƒ½æ˜¯æœ‰åºçš„ åˆå§‹åŒ–ï¼šåœ¨ç¬¬ä¸€æ¬¡å¾ªç¯ä¹‹å‰ï¼Œi=1ï¼Œæ•°ç»„ [0,â€¦,i-1] åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥æ˜¯æœ‰åºçš„ ä¿æŒï¼šåœ¨æ¯æ¬¡è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œå‡è®¾ [1â€¦i-1]æ˜¯å·²ç»æ’å¥½åºçš„åºåˆ—ï¼Œå¾…æ’åºçš„å…ƒç´  A[i] ä¾æ¬¡ä¸A[i-1]ã€A[i-2] è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœ A[i-1] ç­‰å¤§äº A[i]ï¼Œåˆ™ä¾æ¬¡å°†å…¶å‘å³ç§»åŠ¨ä¸€ä½ A[j+1]\u003câ€”A[j]ï¼Œå½“é‡åˆ°å¼€å§‹å°äº A[i] çš„å…ƒç´ æ—¶ï¼Œåˆ™ A[i] æ‰¾åˆ°äº†åˆé€‚çš„æ’å…¥ä½ç½®ï¼Œæ’å…¥ä¹‹åï¼Œæ•´ä¸ªåºåˆ—åˆæ˜¯æ’å¥½åºçš„äº†ã€‚ å½“ i=n+1 æ—¶ï¼Œå¾ªç¯ç»“æŸï¼Œæ­¤æ—¶A[1â€¦n]ä¸­å·²ç»æœ‰nä¸ªå…ƒç´ ï¼Œä¸”å·²ç»æ’å¥½åºã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:1:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å¾ªç¯ä¸å˜å¼"},{"categories":null,"content":" å¤æ‚æ€§åˆ†æ å¯¹äºæ’å…¥æ’åºï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ¯æ¡ä»£ç æ‰§è¡Œæ¬¡æ•°å¦‚ä¸Šå›¾ï¼Œæ‰€ä»¥æ€»è¿è¡Œæ—¶é—´ä¸ºï¼š T(n)=c1n+c2(nâˆ’1)+c4(nâˆ’1)+c5âˆ‘j=2ntj+c6âˆ‘j=2n(tjâˆ’1)+c7âˆ‘j=2n(tjâˆ’1)+c8(nâˆ’1) T(n)=c_1n+c_2(n-1)+c_4(n-1)+c_5\\sum_{j=2}^nt_j+c_6\\sum_{j=2}^n(t_j-1)+c_7\\sum_{j=2}^n(t_j-1)+c_8(n-1) T(n)=c1â€‹n+c2â€‹(nâˆ’1)+c4â€‹(nâˆ’1)+c5â€‹j=2âˆ‘nâ€‹tjâ€‹+c6â€‹j=2âˆ‘nâ€‹(tjâ€‹âˆ’1)+c7â€‹j=2âˆ‘nâ€‹(tjâ€‹âˆ’1)+c8â€‹(nâˆ’1) å½“æ•°ç»„åŸºæœ¬æœ‰åºæ—¶å€™ï¼Œä¼šå‡ºç°æœ€ä½³æƒ…å†µ $t_j=1$ï¼Œæ€»è¿è¡Œæ—¶é—´ä¸º T(n)=c1n+c2(nâˆ’1)+c4(nâˆ’1)+c8(nâˆ’1)=(c1+c2+c4+c5+c8)nâˆ’(c2+c4+c5+c8) T(n)=c_1n+c_2(n-1)+c_4(n-1)+c_8(n-1)=(c_1+c_2+c_4+c_5+c_8)n-(c_2+c_4+c_5+c_8) T(n)=c1â€‹n+c2â€‹(nâˆ’1)+c4â€‹(nâˆ’1)+c8â€‹(nâˆ’1)=(c1â€‹+c2â€‹+c4â€‹+c5â€‹+c8â€‹)nâˆ’(c2â€‹+c4â€‹+c5â€‹+c8â€‹)å¯ä»¥è¡¨ç¤ºä¸º $T(n)=an+b$ï¼Œæ˜¯å…³äº n çš„çº¿æ€§å‡½æ•°ã€‚ä½†æ˜¯å½“æ•°ç»„åå‘æ’åºæ—¶å€™å‡ºç°æœ€åæƒ…å†µï¼Œæ¯æ¬¡éƒ½éœ€è¦å’Œ A[0,â€¦,j-1] å¯¹æ¯”ï¼Œæ‰€ä»¥è¿™æ—¶å€™ $t_j=j$ï¼Œå˜æˆäºŒæ¬¡å‡½æ•°ã€‚ å…·ä½“è¯æ˜å¦‚ä¹¦p15ã€‚ ä¸€èˆ¬æ¥è¯´å¹³å‡æ—¶é—´å¤æ‚åº¦å’Œæœ€åæ—¶é—´å¤æ‚åº¦ä¸€æ ·åï¼Œæœ€åæƒ…å†µæ—¶é—´å¤æ‚åº¦ç”¨ $\\Theta$ æ¥è¡¨ç¤ºï¼Œæ’å…¥æ’åºå°±æ˜¯ $\\Theta(n^2)$ ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:1:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å¤æ‚æ€§åˆ†æ"},{"categories":null,"content":" å½’å¹¶æ’åºåŠå…¶æ—¶é—´å¤æ‚åº¦ python def MergeSort(arr, p, r): if p \u003c r: q = (q + r) / 2 MergeSort(arr, p, q) MergeSort(arr, q+1, r) Merge(arr, p, q, r) def Merge(arr, p, q, r): n1 = q - p + 1 n2 = r - q l = arr[p:q+1] l.append(INF) r = arr[q+1:r+1] r.append(INF) i = j = 0 for k in range(p, r+1): if l[i] \u003e r[j]: arr[k] = r[j] j += 1 else: arr[k] = l[i] i += 1 åŸæœ¬çš„ä»£ç éœ€è¦åˆ¤æ–­ i å’Œ j æ˜¯å¦è¶…è¿‡äº†è¾¹ç•Œï¼Œç°åœ¨ç”¨å“¨å…µ INF å°±èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ T(n)={Î˜(1),n=12Tâ€‰â£(n2)+Î˜(n),n\u003e1 T(n) = \\begin{cases} \\Theta(1), \u0026 n = 1 \\\\ 2T\\!\\left(\\frac{n}{2}\\right) + \\Theta(n), \u0026 n \u003e 1 \\end{cases} T(n)={Î˜(1),2T(2nâ€‹)+Î˜(n),â€‹n=1n\u003e1â€‹æ¯ä¸ªè§„æ¨¡ä¸º n çš„é—®é¢˜å¯ä»¥è¢«åˆ†è§£ä¸ºä¸¤ä¸ªè§„æ¨¡ä¸º $\\frac{n}{2}$ çš„å­é—®é¢˜ï¼ŒåŠ ä¸Šåˆå¹¶çš„æ—¶é—´å¤æ‚åº¦ $\\Theta(n)$ ï¼Œå°±å¯ä»¥å¾—åˆ°å½’å¹¶æ’åºçš„æ—¶é—´é€’æ¨å¼ã€‚å…·ä½“ T(n) æ€ä¹ˆæ¨å‡ºæ—¶é—´å¤æ‚åº¦ä¸º $O(nlogn)$ åœ¨åé¢è¯´ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:1:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å½’å¹¶æ’åºåŠå…¶æ—¶é—´å¤æ‚åº¦"},{"categories":null,"content":" è¯¾åé¢˜ text 31 41 59 26 41 58 31 41 59 26 41 58 31 41 58 26 41 58 26 31 41 58 41 58 26 31 41 41 58 58 26 31 41 41 58 58 text def linear_find(A, v): for i, x in enumerate(A): if v == x: return i return -1 å¾ªç¯ä¸å˜å¼ï¼šæ¯æ¬¡å¾ªç¯ i å‰ï¼Œæ•°ç»„ A[0, .. i-1] ä¸å«å…ƒç´  v åˆå§‹ï¼šç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œå¾ªç¯ä¸å˜å¼ä¸ºç©ºï¼Œè‚¯å®šä¸å« v ç»´æŠ¤ï¼šä¹‹åæ¯ä¸€æ¬¡å¾ªç¯ï¼Œå¦‚æœæ–°å…ƒç´ ç­‰äº v å°±è¿”å›é€€å‡ºäº†ï¼›å¦‚æœä¸ç­‰äº v æ‰åŠ å…¥å¾ªç¯ä¸å˜å¼ï¼Œæ‰€ä»¥ A[0, .. k-1] è‚¯å®šä¸å«å…ƒç´  v ç»“æŸï¼šå½“ i=n+1 æ—¶å€™å¾ªç¯ç»“æŸï¼Œæ­¤æ—¶å¾ªç¯å†… n ä¸ªå…ƒç´ éƒ½ä¸ä¸º vï¼Œæ»¡è¶³å¾ªç¯ä¸å˜å¼ã€‚å¦‚æœå«å…ƒç´  v åˆ™åœ¨ç»“æŸå‰é€€å‡ºã€‚ python def SelectSort(arr): n = len(arr) for i in range(0, n): min_val = INF min_idx = -1 for i in range(i+1, n): if arr[i] \u003c min_val: min_val = arr[i] min_idx = i swap(arr[i], arr[idx]) æœ€åæƒ…å†µ $O(n^2)$ æœ€å¥½æƒ…å†µ $O(n)$ å¾ªç¯ä¸å˜å¼ï¼šæ¯æ¬¡å¾ªç¯ i å‰ï¼Œæ•°ç»„ A[0, ..., i-1] é€’å¢ åˆå§‹ï¼šç¬¬ä¸€æ¬¡å¾ªç¯å‰ï¼Œå¾ªç¯ä¸å˜å¼ä¸ºç©ºï¼Œæ‰€ä»¥æ»¡è¶³æ¡ä»¶ ç»´æŠ¤ï¼šæ¯ä¸€æ¬¡å¾ªç¯ k ä¹‹åï¼Œä¼šä»æ•°ç»„ A[k-1:n] ä¸­æŒ‘é€‰æœ€å°çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„ç¬¬ k å°çš„å…ƒç´ æ’å…¥ï¼Œä¿è¯äº†ä¾æ—§æ˜¯å•è°ƒé€’å¢ ç»“æŸï¼šå½“ i=n+1 æ—¶å€™å¾ªç¯ç»“æŸï¼Œæ•°ç»„å†…å…ƒç´ ä¾æ¬¡ä¸ºç¬¬ä¸€å°ï¼Œç¬¬äºŒå°ï¼Œâ€¦ï¼Œä¾æ¬¡é€’å¢ï¼Œæ»¡è¶³å¾ªç¯ä¸å˜å¼ python def Merge(arr, p, q, r): n1 = q - p + 1 n2 = r - q l = arr[p:q+1] r = arr[q+1:r+1] i = j = 0 k = p while i \u003c n1 and j \u003c n2: if l[i] \u003e r[j]: arr[k] = r[j] j += 1 else: arr[k] = l[i] i += 1 k += 1 while i \u003c n1: arr[k] = l[i] k += 1 i += 1 while j \u003c n2: arr[k] = r[j] k += 1 j += 1 ä¸è¡Œï¼Œå› ä¸ºæŸ¥æ‰¾çš„æ—¶é—´é™ä¸‹æ¥äº†ï¼Œä½†æ˜¯è¿˜æœ‰ç§»åŠ¨å…ƒç´ çš„æ—¶é—´ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:1:5","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜"},{"categories":null,"content":" ç¬¬ä¸‰ç«  å‡½æ•°å¢é•¿ç‡","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:2:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬ä¸‰ç« -å‡½æ•°å¢é•¿ç‡"},{"categories":null,"content":" ä¸åŒæ¸è¿›ç¬¦å· è®°å· å«ä¹‰ ç†è§£ $\\theta$ ç´§ç¡®ç•Œ = O ä¸Šç•Œ \u003c= o éç´§ä¸Šç•Œ \u003c $\\Omega$ ä¸‹ç•Œ \u003e= $\\omega$ éç´§ä¸‹ç•Œ \u003e å®šä¹‰ $f(n) = \\Theta(g(n))$ï¼Œå­˜åœ¨å¸¸æ•° câ‚, câ‚‚ \u003e 0 å’Œ nâ‚€ï¼Œä½¿å¾—å¯¹æ‰€æœ‰ n â‰¥ nâ‚€ï¼š 0â‰¤c1g(n)â‰¤f(n)â‰¤c2g(n) 0 \\le c_1 g(n) \\le f(n) \\le c_2 g(n) 0â‰¤c1â€‹g(n)â‰¤f(n)â‰¤c2â€‹g(n) ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:2:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ä¸åŒæ¸è¿›ç¬¦å·"},{"categories":null,"content":" å’Œå¼ç•Œçš„è¯æ˜æ–¹æ³• ç­‰å·®å’Œâˆ‘i=1ni=n(n+1)2=Î˜(n2) \\sum_{i=1}^n i = \\frac{n(n+1)}{2} = \\Theta(n^2) i=1âˆ‘nâ€‹i=2n(n+1)â€‹=Î˜(n2) ç­‰æ¯”å’Œâˆ‘i=0n2i=2n+1âˆ’1=Î˜(2n) \\sum_{i=0}^{n} 2^i = 2^{n+1} - 1 = \\Theta(2^n) i=0âˆ‘nâ€‹2i=2n+1âˆ’1=Î˜(2n) è°ƒå’Œçº§æ•°âˆ‘i=1n1i=Î˜(logâ¡n) \\sum_{i=1}^n \\frac{1}{i} = \\Theta(\\log n) i=1âˆ‘nâ€‹i1â€‹=Î˜(logn) æ”¾ç¼©æ³•âˆ‘i=1nlogâ¡i\u003câˆ‘i=1nlogâ¡n=nlogâ¡n \\sum_{i=1}^n \\log{i} \u003c \\sum_{i=1}^n \\log{n} = n\\log{n} i=1âˆ‘nâ€‹logi\u003ci=1âˆ‘nâ€‹logn=nlognâˆ‘i=1nlogâ¡i\u003eâˆ‘i=n2nlogâ¡i\u003en2logn2 \\sum_{i=1}^n \\log{i} \u003e \\sum_{i=\\frac{n}{2}}^n \\log{i} \u003e \\frac{n}{2} log{\\frac{n}{2}} i=1âˆ‘nâ€‹logi\u003ei=2nâ€‹âˆ‘nâ€‹logi\u003e2nâ€‹log2nâ€‹æ‰€ä»¥ç´§ç¡®ç•Œæ˜¯ $\\Theta(n\\log n)$ ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:2:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å’Œå¼ç•Œçš„è¯æ˜æ–¹æ³•"},{"categories":null,"content":" å’Œå¼ç•Œçš„è¯æ˜æ–¹æ³• ç­‰å·®å’Œâˆ‘i=1ni=n(n+1)2=Î˜(n2) \\sum_{i=1}^n i = \\frac{n(n+1)}{2} = \\Theta(n^2) i=1âˆ‘nâ€‹i=2n(n+1)â€‹=Î˜(n2) ç­‰æ¯”å’Œâˆ‘i=0n2i=2n+1âˆ’1=Î˜(2n) \\sum_{i=0}^{n} 2^i = 2^{n+1} - 1 = \\Theta(2^n) i=0âˆ‘nâ€‹2i=2n+1âˆ’1=Î˜(2n) è°ƒå’Œçº§æ•°âˆ‘i=1n1i=Î˜(logâ¡n) \\sum_{i=1}^n \\frac{1}{i} = \\Theta(\\log n) i=1âˆ‘nâ€‹i1â€‹=Î˜(logn) æ”¾ç¼©æ³•âˆ‘i=1nlogâ¡i\u003câˆ‘i=1nlogâ¡n=nlogâ¡n \\sum_{i=1}^n \\log{i} \u003c \\sum_{i=1}^n \\log{n} = n\\log{n} i=1âˆ‘nâ€‹logi","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:2:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç­‰å·®å’Œ"},{"categories":null,"content":" å’Œå¼ç•Œçš„è¯æ˜æ–¹æ³• ç­‰å·®å’Œâˆ‘i=1ni=n(n+1)2=Î˜(n2) \\sum_{i=1}^n i = \\frac{n(n+1)}{2} = \\Theta(n^2) i=1âˆ‘nâ€‹i=2n(n+1)â€‹=Î˜(n2) ç­‰æ¯”å’Œâˆ‘i=0n2i=2n+1âˆ’1=Î˜(2n) \\sum_{i=0}^{n} 2^i = 2^{n+1} - 1 = \\Theta(2^n) i=0âˆ‘nâ€‹2i=2n+1âˆ’1=Î˜(2n) è°ƒå’Œçº§æ•°âˆ‘i=1n1i=Î˜(logâ¡n) \\sum_{i=1}^n \\frac{1}{i} = \\Theta(\\log n) i=1âˆ‘nâ€‹i1â€‹=Î˜(logn) æ”¾ç¼©æ³•âˆ‘i=1nlogâ¡i\u003câˆ‘i=1nlogâ¡n=nlogâ¡n \\sum_{i=1}^n \\log{i} \u003c \\sum_{i=1}^n \\log{n} = n\\log{n} i=1âˆ‘nâ€‹logi","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:2:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç­‰æ¯”å’Œ"},{"categories":null,"content":" å’Œå¼ç•Œçš„è¯æ˜æ–¹æ³• ç­‰å·®å’Œâˆ‘i=1ni=n(n+1)2=Î˜(n2) \\sum_{i=1}^n i = \\frac{n(n+1)}{2} = \\Theta(n^2) i=1âˆ‘nâ€‹i=2n(n+1)â€‹=Î˜(n2) ç­‰æ¯”å’Œâˆ‘i=0n2i=2n+1âˆ’1=Î˜(2n) \\sum_{i=0}^{n} 2^i = 2^{n+1} - 1 = \\Theta(2^n) i=0âˆ‘nâ€‹2i=2n+1âˆ’1=Î˜(2n) è°ƒå’Œçº§æ•°âˆ‘i=1n1i=Î˜(logâ¡n) \\sum_{i=1}^n \\frac{1}{i} = \\Theta(\\log n) i=1âˆ‘nâ€‹i1â€‹=Î˜(logn) æ”¾ç¼©æ³•âˆ‘i=1nlogâ¡i\u003câˆ‘i=1nlogâ¡n=nlogâ¡n \\sum_{i=1}^n \\log{i} \u003c \\sum_{i=1}^n \\log{n} = n\\log{n} i=1âˆ‘nâ€‹logi","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:2:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è°ƒå’Œçº§æ•°"},{"categories":null,"content":" å’Œå¼ç•Œçš„è¯æ˜æ–¹æ³• ç­‰å·®å’Œâˆ‘i=1ni=n(n+1)2=Î˜(n2) \\sum_{i=1}^n i = \\frac{n(n+1)}{2} = \\Theta(n^2) i=1âˆ‘nâ€‹i=2n(n+1)â€‹=Î˜(n2) ç­‰æ¯”å’Œâˆ‘i=0n2i=2n+1âˆ’1=Î˜(2n) \\sum_{i=0}^{n} 2^i = 2^{n+1} - 1 = \\Theta(2^n) i=0âˆ‘nâ€‹2i=2n+1âˆ’1=Î˜(2n) è°ƒå’Œçº§æ•°âˆ‘i=1n1i=Î˜(logâ¡n) \\sum_{i=1}^n \\frac{1}{i} = \\Theta(\\log n) i=1âˆ‘nâ€‹i1â€‹=Î˜(logn) æ”¾ç¼©æ³•âˆ‘i=1nlogâ¡i\u003câˆ‘i=1nlogâ¡n=nlogâ¡n \\sum_{i=1}^n \\log{i} \u003c \\sum_{i=1}^n \\log{n} = n\\log{n} i=1âˆ‘nâ€‹logi","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:2:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ”¾ç¼©æ³•"},{"categories":null,"content":" è¯¾åé¢˜ æ ¹æ®å¤šé¡¹å¼å±•å¼€å®šç†ï¼š (n+a)b=C0bnba0+C1bnbâˆ’1a1+â‹¯+Cbbn0ab (n + a)^b = C_0^b n^b a^0 + C_1^b n^{b - 1} a^1 + \\cdots + C_b^b n^0 a^b (n+a)b=C0bâ€‹nba0+C1bâ€‹nbâˆ’1a1+â‹¯+Cbbâ€‹n0ab ç»è¿‡æ”¾ç¼©ï¼š a0x0+a1x1+â‹¯+anxnâ‰¤(a0+a1+â‹¯+an)xn a_0 x^0 + a_1 x^1 + \\cdots + a_n x^n \\le (a_0 + a_1 + \\cdots + a_n) x^n a0â€‹x0+a1â€‹x1+â‹¯+anâ€‹xnâ‰¤(a0â€‹+a1â€‹+â‹¯+anâ€‹)xn æ‰€ä»¥ï¼š C0bnbâ‰¤C0bnba0+C1bnbâˆ’1a1+â‹¯+Cbbn0abâ‰¤(C0b+C1b+â‹¯+Cbb)nb=2bnb C_0^b n^b \\le C_0^b n^b a^0 + C_1^b n^{b - 1} a^1 + \\cdots + C_b^b n^0 a^b \\le (C_0^b + C_1^b + \\cdots + C_b^b) n^b = 2^b n^b C0bâ€‹nbâ‰¤C0bâ€‹nba0+C1bâ€‹nbâˆ’1a1+â‹¯+Cbbâ€‹n0abâ‰¤(C0bâ€‹+C1bâ€‹+â‹¯+Cbbâ€‹)nb=2bnb 2n+1=2âˆ—2nâ‰¤câˆ—2n(câ‰¥2) 2^{n+1} =2*2^n \\le c*2^n(c \\ge 2) 2n+1=2âˆ—2nâ‰¤câˆ—2n(câ‰¥2)å¯¹äºç­‰å¼ 2ï¼Œæ‰¾ä¸åˆ°ä¸€ä¸ª c å¯ä»¥ä½¿ $2^{2n} \\le c*2^n$ æ‰€ä»¥ä¸æˆç«‹ã€‚ 3.2-3 å’Œ 3.2-5 å¤ªåæ•°å­¦äº†è‚¯å®šä¸è€ƒã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:2:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-1"},{"categories":null,"content":" ç¬¬å››ç«  é€’å½’å…³ç³»å¼","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:3:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬å››ç« -é€’å½’å…³ç³»å¼"},{"categories":null,"content":" ä»£å…¥æ³•å¯¹äºä¹‹å‰å½’å¹¶æ’åºçš„ä¾‹å­ï¼Œæˆ‘ä»¬å‡è®¾å®ƒçš„è§£æ˜¯ $T \\left(n\\right) = O \\left( n lgn \\right)$ ï¼Œå³æˆ‘ä»¬éœ€è¦è¯æ˜ $T\\left( n \\right) \\le c_1nlgn$ã€‚ æ ¹æ®æ•°å­¦å½’çº³æ³•ï¼Œé¦–å…ˆæˆ‘ä»¬è¦ç¡®å®šå½“ n æ¯”è¾ƒå°æ—¶è¯¥çŒœæµ‹æˆç«‹ã€‚å½“ $n=1$ æ—¶ï¼Œ$T\\left(1\\right) = \\Theta \\left(1 \\right) = d_1$Â ï¼Œå…¶ä¸­ $d_1$ æ˜¯æŸä¸ªå¤§äº 0 çš„å¸¸æ•°ã€‚æ ¹æ®çŒœæµ‹ï¼Œæˆ‘ä»¬å¸Œæœ› $T\\left(1\\right) \\le c_1 lg1 = 0$Â ï¼Œå¯æ˜¯ï¼Œæ— è®ºæ€æ ·å–Â cÂ ï¼Œè¯¥å¼éƒ½ä¸å¯èƒ½æˆç«‹ï¼Œå› ä¸ºÂ $T\\left(1\\right) = d_1$Â å¿…ç„¶å¤§äº 0ã€‚æ•°å­¦å½’çº³æ³•è¿˜æ²¡å¼€å§‹å°±å¤±è´¥äº†ã€‚ä¸è¿‡ä¸å¿…æ‹…å¿ƒï¼Œè¿™åªæ˜¯ä¸€ä¸ªÂ $lg1 = 0$Â å¯¼è‡´çš„ç‰¹æ®Šæƒ…å†µï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠæ•°å­¦å½’çº³æ³•çš„åˆå§‹çŠ¶æ€æ”¾åœ¨Â $n \\gt 1$Â çš„ä½ç½®ï¼ŒåŒæ—¶ä¸å½±å“æ•°å­¦å½’çº³æ³•çš„ç»“æœã€‚å› ä¸ºæˆ‘ä»¬åªå…³å¿ƒå½“Â nÂ è¶³å¤Ÿå¤§æ—¶ $T\\left(n\\right)$Â çš„æ¸è¿›æ€§è´¨ï¼Œè€Œä¸å…³å¿ƒåˆå§‹é˜¶æ®µã€‚ ç°åœ¨ä»¤Â n=2Â ï¼Œåˆ™Â $T\\left(2\\right) = 2T\\left(1\\right) + d_2 = 2d_1 + d_2$Â ï¼Œæˆ‘ä»¬å¸Œæœ›Â $T\\left( 2 \\right) \\le c_12lg2$Â æˆç«‹ï¼ŒåŒ–ç®€åå¾—Â $c_1 \\ge d_1 + d_2/2$Â ï¼Œç”±äºÂ $d_1$Â å’ŒÂ $d_2$Â æ˜¯å¸¸æ•°ï¼Œå› æ­¤è¿™æ ·çš„Â $c_1$Â æ˜¯å­˜åœ¨çš„ï¼Œåˆå§‹æƒ…å†µæˆç«‹ã€‚ æ¥ä¸‹æ¥ï¼Œæ•°å­¦å½’çº³æ³•éœ€è¦å‡è®¾è§£åœ¨Â $n/2$Â å¤„æˆç«‹ï¼Œå³Â $T\\left( \\frac{n}{2} \\right) \\le c_1 \\frac{n}{2} lg\\frac{n}{2} = \\frac{1}{2}c_1n\\left(lgn - 1\\right)$Â æˆç«‹ã€‚ç„¶åæˆ‘ä»¬æ¥è¯æ˜Â $T\\left( n \\right) \\le c_1nlgn$Â ä¹Ÿæˆç«‹ã€‚ T(n)=2T(n2)+Î˜(n)â‰¤212c1n(lgnâˆ’1)+d2n=c1nlgn+(d2âˆ’c1)nâ‰¤c1nlgn \\begin{equation} \\begin{aligned} T\\left(n\\right) \u0026 = 2 T\\left(\\frac{n}{2} \\right) + \\Theta\\left(n\\right) \\\\ \u0026 \\le 2 \\frac{1}{2}c_1n\\left(lgn - 1\\right) + d_2n \\\\ \u0026 = c_1nlgn + \\left(d_2 - c_1\\right) n \\\\ \u0026 \\le c_1nlgn \\end{aligned} \\end{equation} T(n)â€‹=2T(2nâ€‹)+Î˜(n)â‰¤221â€‹c1â€‹n(lgnâˆ’1)+d2â€‹n=c1â€‹nlgn+(d2â€‹âˆ’c1â€‹)nâ‰¤c1â€‹nlgnâ€‹â€‹â€‹åŒç†åªéœ€è¦è¯æ˜ $T \\left(n\\right) = \\Omega \\left( n lgn \\right)$ï¼Œå°±å¯ä»¥å¾—è¯ $T \\left(n\\right) = \\Theta \\left( n lgn \\right)$ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:3:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ä»£å…¥æ³•"},{"categories":null,"content":" é€’å½’æ ‘æ­¥éª¤ï¼š æŠŠé€’å½’å¼ä¸­åˆ†æˆé€’å½’éƒ¨åˆ† $T(\\frac{n}{2})$ $2T(\\frac{n}{4})$ å’Œæ¯å±‚çš„å¤„ç†æ—¶é—´ $O(n)$ é€’å½’æ ‘æ¯ä¸€å±‚éƒ½æŒ‰ç…§é€’å½’éƒ¨åˆ†çš„è§„åˆ™ï¼ŒæŠŠä¸Šä¸€å±‚ç“œåˆ†ï¼›ç¬¬ä¸€å±‚ç“œåˆ†çš„æ˜¯ $O(n)$ ç»Ÿè®¡æ¯ä¸€å±‚çš„æ€»è€—æ—¶ï¼Œæœ€åç´¯åŠ  é€šè¿‡æ”¾ç¼©å¾—åˆ°æœ€åæ—¶é—´å¤æ‚åº¦ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:3:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#é€’å½’æ ‘"},{"categories":null,"content":" ä¸»å®šç† ç®€å•çš„ç†è§£ï¼š è‹¥ f(n) å¢é•¿è¾ƒæ…¢ï¼ˆæƒ…å†µ 1ï¼‰ï¼Œåˆ™é€’å½’éƒ¨åˆ†å ä¸»å¯¼ã€‚ è‹¥ f(n) å’Œé€’å½’å¢é•¿ç›¸ç­‰ï¼ˆæƒ…å†µ 2ï¼‰ï¼Œéœ€é¢å¤–ä¹˜ä»¥ log nã€‚ è‹¥ f(n) å¢é•¿è¾ƒå¿«ä¸”æ»¡è¶³å¹³è¡¡æ¡ä»¶ï¼Œåˆ™éé€’å½’éƒ¨åˆ†å ä¸»å¯¼ã€‚ Warning ä¸»å®šç†åœ¨æŸäº›æƒ…å†µä¸‹ä¸é€‚ç”¨ï¼š å‡å¦‚ $f(n) = n Â· (1 + sin(log n))$ ä¸æ˜¯æ¸è¿›å¹³æ»‘çš„ï¼Œé‚£ä¹ˆä¸èƒ½ç”¨æƒ…å†µ 2ã€‚æƒ…å†µ 2 éšå«äº†ï¼šåœ¨é€’å½’æ ‘çš„æ¯ä¸€å±‚ï¼Œæ€»ä»£ä»·å¤§è‡´æ˜¯â€œåŒä¸€ä¸ªé‡çº§â€ï¼Œç„¶åä¸€å±‚ä¸€å±‚ç´¯åŠ å‡ºä¸€ä¸ª log n å› å­ã€‚è€Œè¿™ä¸ª $f(n)$ æ ¹æ®ä¸åŒçš„ n $sin(log n)$ å–å€¼ä¸åŒï¼Œæ‰€ä»¥ä¸è¡Œã€‚ å¯¹äº $Tn=2T(\\frac{n}{2}))+nlgn$ ï¼Œç”±äº $n\\lg n$ ä¸æ˜¯å¤šé¡¹å¼å¤§äº nï¼ˆä¸»å®šç†çœŸæ­£æ¯”è¾ƒçš„æ˜¯ $f(n)$ å’Œ $n^{1+Îµ}$ çš„å¤§å°å…³ç³»ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½å¥—ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:3:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ä¸»å®šç†"},{"categories":null,"content":" æœ€å¤§å­æ•°ç»„ æœ€å¤§å­æ•°ç»„çš„ä¸‰ç§æƒ…å†µï¼š1 åœ¨å·¦åŠè¾¹ï¼Œ2 åœ¨å³åŠè¾¹ï¼Œ3 æ¨ªè·¨ï¼ˆä» mid å‘ä¸¤è¾¹æ‰©å±•å³å¯ï¼Œçº¿æ€§çš„ï¼‰ python def FindMaxSubarray(arr, l, r): if l == r: return l, r, arr[l] else: mid = (l + r) / 2 left_l, left_r, left_sum = FindMaxSubarray(arr, l, mid) right_l, right_r, right_sum = FindMaxSubarray(arr, mid+1, r) mid_l, mid_r, mid_sum = FindMaxCross(arr, l, mid, r) return ... def FindMaxCross(arr, l, mid, r): left_max = -INF right_max = -INF sum = 0 for i in range(mid, l, -1): sum += arr[i] if sum \u003e left_max: left_max = sum max_left = i sum = 0 for i in range(mid+1, r): sum += arr[i] if sum \u003e right_sum: right_sum = sum max_right = i return max_left, max_right, left_max+right_max FindMaxCross æ—¶é—´å¤æ‚åº¦æ˜¯ $O(n)$ï¼Œæ¯æ¬¡éƒ½åˆ†æˆä¸¤ä¸ªå­ä»»åŠ¡ï¼Œæ‰€ä»¥é€’æ¨å¼å¾® $T(n)=2T(n/2)+ \\Theta(n)$ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(n\\lg n)$ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:3:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æœ€å¤§å­æ•°ç»„"},{"categories":null,"content":" Stranssen çŸ©é˜µä¹˜æ³•ç»™å®šä¸¤ä¸ª $n \\times n$ çŸ©é˜µ A,Bï¼Œè®¡ç®—ï¼š AÃ—B,Cij=âˆ‘k=1nAikBkj A \\times B,\\quad C_{ij} = \\sum_{k=1}^{n} A_{ik} B_{kj} AÃ—B,Cijâ€‹=k=1âˆ‘nâ€‹Aikâ€‹Bkjâ€‹ ä¸‰é‡å¾ªç¯ æ¯ä¸ª $C_{ij}$ éœ€è¦ n æ¬¡ä¹˜æ³• ä¸€å…± $n^2$ ä¸ªå…ƒç´  å‡è®¾ n æ˜¯ 2 çš„å¹‚ï¼ˆä¸æ˜¯ä¹Ÿèƒ½ paddingï¼‰ã€‚ æŠŠçŸ©é˜µåˆ†æˆå››ä¸ª $\\frac{n}{2} \\times \\frac{n}{2}$ å­çŸ©é˜µï¼š A=[A11A12A21A22],B=[B11B12B21B22] \\begin{array}{c} A = \\begin{bmatrix} A_{11} \u0026 A_{12} \\\\ A_{21} \u0026 A_{22} \\end{bmatrix}, \\quad B = \\begin{bmatrix} B_{11} \u0026 B_{12} \\\\ B_{21} \u0026 B_{22} \\end{bmatrix} \\end{array} A=[A11â€‹A21â€‹â€‹A12â€‹A22â€‹â€‹],B=[B11â€‹B21â€‹â€‹B12â€‹B22â€‹â€‹]â€‹æ™®é€šåˆ†æ²»ä¹˜æ³•ï¼š C11=A11B11+A12B21C12=A11B12+A12B22C21=A21B11+A22B21C22=A21B12+A22B22 \\begin{aligned} C_{11} \u0026= A_{11}B_{11} + A_{12}B_{21} \\\\\\\\ C_{12} \u0026= A_{11}B_{12} + A_{12}B_{22} \\\\\\\\ C_{21} \u0026= A_{21}B_{11} + A_{22}B_{21} \\\\\\\\ C_{22} \u0026= A_{21}B_{12} + A_{22}B_{22} \\end{aligned} C11â€‹C12â€‹C21â€‹C22â€‹â€‹=A11â€‹B11â€‹+A12â€‹B21â€‹=A11â€‹B12â€‹+A12â€‹B22â€‹=A21â€‹B11â€‹+A22â€‹B21â€‹=A21â€‹B12â€‹+A22â€‹B22â€‹â€‹é€’æ¨å¼æ˜¯ $T(n)=8T(n/2)+Î˜(n2)$ è¿˜æ˜¯æ²¡æœ‰æ”¹è¿›ï¼ŒStranssen çš„æ€è·¯æ˜¯ï¼šçŸ©é˜µåŠ å‡æ³•æ˜¯ $O(n^2)$ï¼Œæ¯”ä¹˜æ³•ä¾¿å®œï¼Œç”¨åŠ æ³•ä»£æ›¿ä¹˜æ³•ã€‚ M1=(A11+A22)(B11+B22)M2=(A21+A22)B11M3=A11(B12âˆ’B22)M4=A22(B21âˆ’B11)M5=(A11+A12)B22M6=(A12âˆ’A22)(B21+B22)M7=(A11âˆ’A21)(B11+B12) \\begin{align*} M_1 \u0026= (A_{11} + A_{22})(B_{11} + B_{22}) \\\\ M_2 \u0026= (A_{21} + A_{22}) B_{11} \\\\ M_3 \u0026= A_{11} (B_{12} - B_{22}) \\\\ M_4 \u0026= A_{22} (B_{21} - B_{11}) \\\\ M_5 \u0026= (A_{11} + A_{12}) B_{22} \\\\ M_6 \u0026= (A_{12} - A_{22}) (B_{21} + B_{22}) \\\\ M_7 \u0026= (A_{11} - A_{21}) (B_{11} + B_{12}) \\end{align*} M1â€‹M2â€‹M3â€‹M4â€‹M5â€‹M6â€‹M7â€‹â€‹=(A11â€‹+A22â€‹)(B11â€‹+B22â€‹)=(A21â€‹+A22â€‹)B11â€‹=A11â€‹(B12â€‹âˆ’B22â€‹)=A22â€‹(B21â€‹âˆ’B11â€‹)=(A11â€‹+A12â€‹)B22â€‹=(A12â€‹âˆ’A22â€‹)(B21â€‹+B22â€‹)=(A11â€‹âˆ’A21â€‹)(B11â€‹+B12â€‹)â€‹å°±èƒ½å¾—åˆ°ï¼š C11=M1+M4âˆ’M5+M7C12=M3+M5C21=M2+M4C22=M1âˆ’M2+M3+M6 \\begin{align*} C_{11} \u0026= M_1 + M_4 - M_5 + M_7 \\\\ C_{12} \u0026= M_3 + M_5 \\\\ C_{21} \u0026= M_2 + M_4 \\\\ C_{22} \u0026= M_1 - M_2 + M_3 + M_6 \\end{align*} C11â€‹C12â€‹C21â€‹C22â€‹â€‹=M1â€‹+M4â€‹âˆ’M5â€‹+M7â€‹=M3â€‹+M5â€‹=M2â€‹+M4â€‹=M1â€‹âˆ’M2â€‹+M3â€‹+M6â€‹â€‹æ‰€ä»¥åªéœ€è¦ 7 æ¬¡çŸ©é˜µä¹˜æ³•åŠ ä¸Šè‹¥å¹²æ¬¡çŸ©é˜µåŠ å‡æ³•ï¼Œ$T(n) = 7T(n/2) + \\Theta(n^2)$ï¼Œæ ¹æ®ä¸»å®šç†é€’æ¨éƒ¨åˆ†æ—¶é—´å¤æ‚åº¦æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä¸º $\\Theta(n^{log_2^7})$ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:3:5","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#stranssen-çŸ©é˜µä¹˜æ³•"},{"categories":null,"content":" è¯¾åé¢˜ å‡ºç° n ä¸æ˜¯ 2 çš„å¹‚çš„æƒ…å†µï¼Œåªéœ€è¦å¡«å…… 0 å³å¯ã€‚Strassen ç®—æ³•ä¼šæŠŠè§„æ¨¡ä¸º n çš„çŸ©é˜µåˆ†è£‚ä¸º 4 ä¸ª è§„æ¨¡ä¸º n/2 çš„å­çŸ©é˜µï¼Œè¿›è¡Œ 7 æ¬¡ä¹˜æ³•å’Œè‹¥å¹²æ¬¡åŠ æ³•ï¼Œæ‰€ä»¥é€’æ¨å¼ä¸º $T(n)=7T(\\frac{n}{2})+O(n)$ï¼Œæ ¹æ®ä¸»å®šç†ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(n^{\\lg7})$ã€‚ æ—¢ç„¶ Strassen ç®—æ³•æŠŠè§„æ¨¡ä¸º n çš„çŸ©é˜µåˆ†è£‚ä¸º 4 ä¸ª è§„æ¨¡ä¸º n/2 çš„å­çŸ©é˜µï¼Œè¿›è¡Œ 7 æ¬¡ä¹˜æ³•å’Œè‹¥å¹²æ¬¡åŠ æ³•ï¼Œé€’æ¨å¼å†™ä¸º $T(n)=7T(\\frac{n}{2})+O(n)$ï¼Œé‚£å¯ä»¥æŠŠç¬¬ä¸€ç§æ–¹æ³•å†™ä¸º $T(n)=143640T(\\frac{n}{70})$ï¼Œæ ¹æ®ä¸»å®šç†å¾—åˆ° $n^{log_{70}^{143640}} \\approx n^{2.7951284873613815}$ã€‚å…¶ä»–æ–¹æ³•åŒç†ï¼Œå’Œ $\\log_2^7$ å¯¹æ¯”å³å¯ã€‚ çŒœæµ‹ï¼šT(n) \u003e= cÂ Â·Â n Â· lgn è¯æ˜ï¼šn = 1 ä¸ºé€’å½’å¼åŸºæœ¬æƒ…å†µï¼ŒT(1) = 2T(âŒŠn/2âŒ‹) + n = 1 ã€‚å½“ n \u003e= 2 æ—¶ï¼Œæœ‰Â T(n) = 2T(âŒŠn/2âŒ‹) + n \u003e= 2Â Â· cÂ Â·Â ( âŒŠn/2âŒ‹ Â· lgâŒŠn/2âŒ‹Â ) + n \u003e= ï¼Ÿï¼Œæˆ‘çš„æ€è·¯åˆ°è¿™å°±å¡ç€äº†ï¼Œå› ä¸ºå‘ä¸‹å–æ•´çš„ç¬¦å·ä¼šè®©å·¦è¾¹ \u003c= å³è¾¹ï¼Œè®©æ¥ä¸‹å»çš„æ¨å¯¼æ— æ³•æˆç«‹ï¼Œã€‚å¦‚æœè¿™é‡Œæ˜¯å‘ä¸Šå–æ•´çš„ç¬¦å·çš„è¯ï¼Œå°±å¯ä»¥æ¨å‡ºÂ 2Â Â· cÂ Â·Â ( âŒˆn/2âŒ‰ Â·Â lgâŒˆn/2âŒ‰ ) + n \u003e= cÂ Â· n Â· (lgn - 1)+ n =Â cÂ Â· n Â· lgn ã€‚ çœ‹æ¥æ˜¯è¦æ¢çŒœæƒ³äº†ã€‚åŠ ä¸Šäº›å¸¸æ•°å¦‚ä½•ï¼Ÿå‚è€ƒäº†åˆ«äººçš„è§£æ³•ï¼Œæ–°çŒœæµ‹ï¼š$T(n) \\ge c(n+2)\\lg(n+2)$ è¯æ˜ï¼šè¿˜æ˜¯ä¸€æ ·ï¼Œn = 1 ä¸ºé€’å½’å¼çš„åŸºæœ¬æƒ…å†µï¼ŒT(1) = 2T(âŒŠn/2âŒ‹) + n = 1 ã€‚å½“ n \u003e= 2 æ—¶ï¼ŒT(n) =Â 2T(âŒŠn/2âŒ‹) + n \u003e= 2cÂ Â· ((âŒŠn/2âŒ‹ + 2) Â·Â (lgâŒŠn/2âŒ‹ + 2) + n \u003e=Â 2cÂ Â· ((n/2 - 1 + 2)Â Â·Â (lg(n/2)Â - 1 + 2) + n =Â 2cÂ Â· ((n/2 + 1)Â Â· lgn) + n =Â cÂ Â· (n + 2)Â Â· lgn + n \u003e=Â cÂ Â·Â n Â· lgn ï¼Œå…¶ä¸­å­˜åœ¨ c \u003e 0ï¼Œä½¿å¾—æœ€åä¸€æ­¥æ¨å¯¼æˆç«‹ï¼Œæ‰€ä»¥Â T(n) = Î©( nÂ·lgn )ã€‚ è¯æ³•ç±»ä¼¼ 4.3-3ï¼Œå¦‚æœå‘ç°ä¸Šç•Œ/ä¸‹ç•Œæ•´ä¸å‡ºæ¥ï¼Œå¯èƒ½æ˜¯çŒœæµ‹å¤ªç´§äº†ï¼Œå¯ä»¥åŠ å‡å¸¸æ•°ã€‚ ä¸è¡Œï¼Œ$n^{log_b^a}=n^2$ ä½†æ˜¯ $n^2\\lg n$ å¹¶ä¸æ˜¯å¤šé¡¹å¼å¤§äº $n^2$ ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:3:6","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-2"},{"categories":null,"content":" ç¬¬å…­ç«  å †æ’åº","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:4:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬å…­ç« -å †æ’åº"},{"categories":null,"content":" Heapifyå †çš„ç»´æŠ¤ä»ä¸Šåˆ°ä¸‹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(\\lg n)$ ï¼Œå°±æ˜¯äºŒå‰å †çš„é«˜ã€‚ python def MaxHeapify(arr, i): l = i.left r = i.right if l \u003c= size and arr[l] \u003e arr[i]: largest = l elif r \u003c= size and arr[r] \u003e arr[i]: largest = r else: largest = i if largest != i: swap(arr[i], arr[largest]) MaxHeapify(arr, largest) éé€’å½’çš„ MaxHeapify ç”¨ while True å³å¯ï¼Œæ¯æ¬¡ i = largestã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:4:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#heapify"},{"categories":null,"content":" BuildHeapç”±äºæ•°ç»„ [n/2, â€¦, n] éƒ½æ˜¯å¶èŠ‚ç‚¹ï¼Œå¶èŠ‚ç‚¹å¯ä»¥çœ‹ä½œä¸€ä¸ªå…ƒç´ çš„å †ï¼Œæ‰€ä»¥å»ºå †æ—¶å€™ï¼Œåªéœ€è¦ç»´æŠ¤ [1, â€¦, n/2] çš„éå¶èŠ‚ç‚¹å°±å¥½ã€‚ python def BuildHeap(arr): for i in range(n/2, 1, -1): MaxHeapify(arr, i) æ¯æ¬¡è°ƒç”¨ MaxHeapify æ—¶é—´å¤æ‚åº¦æ˜¯ $O(\\lg n)$ï¼Œéœ€è¦è°ƒç”¨ $O(n)$ æ¬¡ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¸º $O(n\\lg n)$ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:4:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#buildheap"},{"categories":null,"content":" HeapSortä¸æ–­æŠŠå †é¡¶ï¼ˆæœ€å¤§å…ƒç´ ï¼‰æ”¾åˆ°é˜Ÿå°¾ï¼Œå¹¶ä¸”å †å¤§å°å‡ä¸€ã€‚ python def HeapSort(arr): BuildHeap(arr) for i in range(arr.size): swap(arr[1], arr[-1]) arr.size -= 1 MaxHeapify(arr, 1) ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:4:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#heapsort"},{"categories":null,"content":" ä¼˜å…ˆé˜Ÿåˆ—å‡è®¾ä½ æœ‰ä¸€ç»„æ•°æ®ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œä½ éœ€è¦åå¤åšä¸¤ä»¶äº‹ï¼š æ’å…¥æ–°å…ƒç´  å¿«é€Ÿæ‰¾åˆ°å¹¶åˆ é™¤å½“å‰ä¼˜å…ˆçº§æœ€é«˜ï¼ˆæˆ–æœ€ä½ï¼‰çš„å…ƒç´  æ•°æ®ç»“æ„ æ’å…¥ æ‰¾æœ€å¤§/æœ€å° åˆ é™¤æœ€å¤§/æœ€å° æ™®é€šæ•°ç»„ O(1) O(n) O(n) æ’åºæ•°ç»„ O(n) O(1) O(1) é“¾è¡¨ O(1) O(n) O(n) ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆå †ï¼‰ O(log n) O(1) O(log n) å› ä¸ºå †çš„æ’å…¥åªéœ€è¦å¯¹æ’å…¥ä½ç½®å‘ä¸Šè¿›è¡Œç»´æŠ¤ï¼Œæ ‘é«˜ä¸º $O(\\log n)$ï¼›å–æœ€å¤§æœ€å°å…ƒç´ åªéœ€è¦å–å †é¡¶å…ƒç´ å°±å¥½ã€‚åˆ é™¤çš„è¯éœ€è¦å †é¡¶å’Œé˜Ÿå°¾äº¤æ¢ï¼Œç„¶åè‡ªä¸Šè€Œä¸‹ç»´æŠ¤ï¼Œä¹Ÿæ˜¯ $O(\\log n)$ ã€‚ python def Insert(heap, x): heap.size += 1 heap[heap.size] = 0 Increase(heap, heap.size, x) def Maximum(heap): return heap[1] def ExtractMax(heap): swap(heap[1], heap[-1]) heap.size -= 1 Heapify(heap, 1) return heap[-1] def Increase(heap, i, x): heap[i] += x while i \u003e 1 and heap[i // 2] \u003c heap[i]: swap(heap[i//2], heap[i]) i = i // 2 ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:4:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ä¼˜å…ˆé˜Ÿåˆ—"},{"categories":null,"content":" è¯¾åé¢˜ éé€’å½’çš„ MaxHeapify ç”¨Â while TrueÂ å³å¯ï¼Œæ¯æ¬¡Â i = largestï¼Œå¦‚æœå‘ç°æ²¡æœ‰äº¤æ¢ï¼Œé‚£ä¹ˆé€€å‡ºå¾ªç¯ã€‚ python def MaxHeapify(heap, i): while True: l = i.left r = i.right if l \u003c= size and heap[l] \u003e heap[i]: largest = l elif r \u003c= size and heap[r] \u003e heap[i]: largest = r else: largest = i if largest == i: return swap(arr[i], arr[largest]) i = largest 6.3-3 åæ•°å­¦ä¸çœ‹äº† æœ€åæƒ…å†µä¸‹ï¼Œä» $\\lfloor \\frac{n}{2} \\rfloor$ åˆ° 1 çš„æ¯ä¸ªéå¶å­ç»“ç‚¹è¿›è¡Œ Heapify éƒ½éœ€è¦è¿›è¡Œåˆ°æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ $\\sum_{k=1}^{\\lfloor \\frac{n}{2} \\rfloor}{h(k)}=\\Omega(n\\lg n)$ ï¼Œè¿™é‡Œ $h(k)$ æ˜¯èŠ‚ç‚¹ k çš„é«˜åº¦ã€‚ å‡è®¾æ˜¯æœ€å°å † python def HeapDelete(heap, i): heap[i] = INF MinHeapify(heap, i) heap.size -= 1 ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:4:5","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-3"},{"categories":null,"content":" ç¬¬ä¸ƒç«  å¿«é€Ÿæ’åº","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:5:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬ä¸ƒç« -å¿«é€Ÿæ’åº"},{"categories":null,"content":" ä»£ç  python def QuickSort(arr, l, r): if l \u003c r: mid = Partition(arr, l, r) QuickSort(arr, l, mid-1) QuickSort(arr, mid+1, r) def Partition(arr, l, r): pivot = arr[r] left = l - 1 for i in range(l, r+1): if arr[i] \u003c= pivot: left += 1 swap(arr[left], arr[i]) swap(arr[left+1], arr[r]) return left + 1 ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:5:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ä»£ç "},{"categories":null,"content":" æ€§èƒ½å¿«æ’çš„æœ€åæƒ…å†µå‘ç”Ÿåœ¨ï¼Œpivotåˆ’åˆ†ä¸¤ä¸ªåŒºåŸŸï¼Œä¸€è¾¹å…ƒç´ ä¸º0ï¼Œä¸€è¾¹ä¸º n-1ã€‚è¿™æ—¶å€™å¿«æ’çš„é€’æ¨å¼ä¸ºï¼š$T(n)=T(n-1)+T(0)+O(n)$ æœ€ç»ˆå¾—åˆ° $O(n^2)$ã€‚æœ€å¥½æƒ…å†µå°±æ˜¯ pivot å‡åˆ†ï¼Œè¿™æ—¶å€™ $T(n)=2T(n/2)+O(n)$ å¾—åˆ° $O(n\\log n)$ã€‚ å¿«é€Ÿæ’åºçš„å¹³å‡æƒ…å†µæ›´æ¥è¿‘ æœ€å¥½æƒ…å†µï¼Œå› ä¸ºä»»ä½•ä¸€ç§å¸¸æ•°æ¯”ä¾‹çš„åˆ’åˆ†éƒ½ä¼šç”Ÿæˆé«˜åº¦ä¸º $\\Theta(\\lg n)$ çš„é€’å½’æ ‘ï¼Œæ¯ä¸€å±‚çš„æ—¶é—´ä»£ä»·éƒ½æ˜¯ $\\Theta(n)$ï¼Œæ‰€ä»¥è¿è¡Œæ—¶é—´æ˜¯ $\\Theta(n\\lg n)$ã€‚ ä¸ºä»€ä¹ˆå¿«é€Ÿæ’åºæ¯”å½’å¹¶æ’åºæ›´å¥½ å°½ç®¡å½’å¹¶æ’åºåœ¨ç†è®ºä¸Šå…·æœ‰ç¨³å®šçš„ $O(n \\log n)$ æ—¶é—´å¤æ‚åº¦ï¼Œå¹¶ä¸”æ˜¯ç¨³å®šæ’åºï¼Œä½†å¿«é€Ÿæ’åºåœ¨å¤šæ•°åœºæ™¯ä¸‹ä»ç„¶è¢«æ›´å¹¿æ³›ä½¿ç”¨ ç©ºé—´å¼€é”€æ˜¾è‘—æ›´å°ï¼šå½’å¹¶æ’åºåœ¨æ•°ç»„å®ç°ä¸‹éœ€è¦é¢å¤–çš„ O(n) è¾…åŠ©ç©ºé—´ï¼Œè€Œå¿«æ’æ˜¯åŸåœ°æ’åº å¸¸æ•°å› å­æ›´å°ï¼Œå®é™…è¿è¡Œæ›´å¿«ï¼šå½’å¹¶æ’åºåœ¨â€œåˆå¹¶â€é˜¶æ®µéœ€è¦é¢‘ç¹åœ°è¿›è¡Œæ•°ç»„æ‹·è´ä¸å†™å…¥è¾…åŠ©æ•°ç»„ï¼Œå¸¸æ•°å¼€é”€æ˜æ˜¾æ›´å¤§ ç¼“å­˜å±€éƒ¨æ€§æ›´å¥½ï¼šå¿«é€Ÿæ’åºåœ¨åˆ’åˆ†è¿‡ç¨‹ä¸­ï¼Œä¸»è¦åœ¨å½“å‰å­æ•°ç»„ä¸Šè¿›è¡Œé¡ºåºè®¿é—®å’Œå±€éƒ¨äº¤æ¢ï¼Œå…·æœ‰è‰¯å¥½çš„ç©ºé—´å±€éƒ¨æ€§ï¼Œèƒ½å……åˆ†åˆ©ç”¨ CPU cacheã€‚å½’å¹¶æ’åºåœ¨åˆå¹¶é˜¶æ®µéœ€è¦åœ¨å¤šä¸ªæ•°ç»„ä¹‹é—´æ¥å›è¯»å†™ï¼Œç¼“å­˜å‘½ä¸­ç‡è¾ƒä½ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:5:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ€§èƒ½"},{"categories":null,"content":" éšæœºæ€§æ™®é€š quicksort çš„æ€§èƒ½å¼ºçƒˆä¾èµ– pivot çš„é€‰æ‹©ï¼šå¦‚æœ pivot æ¯æ¬¡éƒ½é€‰åˆ°æœ€å° / æœ€å¤§ ï¼Œä¼šå¯¼è‡´åˆ’åˆ†æä¸å¹³è¡¡ï¼Œ é€’å½’æ·±åº¦ nï¼Œæœ€ç»ˆæ—¶é—´å¤æ‚åº¦ä¸º $O(n^2)$ã€‚éšæœºå¿«æ’å°±æ˜¯ pivot éšæœºé€‰æ‹©ä¸€ä¸ªå…ƒç´ ï¼Œè€Œä¸æ˜¯å›ºå®šå¤´å°¾æˆ–è€…ä¸­é—´ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:5:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#éšæœºæ€§"},{"categories":null,"content":" è¯¾åé¢˜ æ‰€æœ‰å…ƒç´ éƒ½ç›¸åŒæ—¶ï¼Œè¿”å›çš„ q æ˜¯é€‰æ‹©çš„ pivot çš„ä¸‹æ ‡ï¼Œæ‰€ä»¥åªæœ‰é€‰æ‹©ä¸­é—´çš„å…ƒç´ å½“ pivot å°±è¡Œäº†ã€‚ nlgâ¡nâ‰¥nk+nlgâ¡n/kâ‡’lgâ¡nâ‰¥k+lgâ¡nâˆ’lgâ¡kâ‡’lgâ¡kâ‰¥k. \\begin{aligned} \u0026 n\\lg n \\ge nk + n\\lg{n / k} \\\\ \\Rightarrow \u0026 \\lg n \\ge k + \\lg n - \\lg k \\\\ \\Rightarrow \u0026 \\lg k \\ge k. \\end{aligned} â‡’â‡’â€‹nlgnâ‰¥nk+nlgn/klgnâ‰¥k+lgnâˆ’lgklgkâ‰¥k.â€‹ç”±äºæ— æ³•å®ç°ï¼Œæ‰€ä»¥åŠ äº†å¸¸æ•°ï¼š cqnlgâ¡nâ‰¥cink+cqnlgâ¡(n/k)â‡’cqlgâ¡nâ‰¥cik+cqlgâ¡nâˆ’cqlgâ¡kâ‡’lgâ¡kâ‰¥cicqk. \\begin{aligned} \u0026 c_qn\\lg n \\ge c_ink + c_qn\\lg(n / k) \\\\ \\Rightarrow \u0026 c_q\\lg n \\ge c_ik + c_q\\lg n - c_q\\lg k \\\\ \\Rightarrow \u0026 \\lg k \\ge \\frac{c_i}{c_q}k. \\end{aligned} â‡’â‡’â€‹cqâ€‹nlgnâ‰¥ciâ€‹nk+cqâ€‹nlg(n/k)cqâ€‹lgnâ‰¥ciâ€‹k+cqâ€‹lgnâˆ’cqâ€‹lgklgkâ‰¥cqâ€‹ciâ€‹â€‹k.â€‹","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:5:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-4"},{"categories":null,"content":" ç¬¬å…«ç«  çº¿æ€§æ—¶é—´æ’åº","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:6:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬å…«ç« -çº¿æ€§æ—¶é—´æ’åº"},{"categories":null,"content":" åŸºäºæ¯”è¾ƒçš„æ’åºç®—æ³•ä¸‹ç•Œæœ€åæƒ…å†µä¸‹ï¼Œä»»ä½•æ¯”è¾ƒæ’åºéƒ½éœ€è¦è¿›è¡Œ $\\Omega(n\\lg n)$ æ¬¡æ¯”è¾ƒã€‚ æ²¡çœ‹æ‡‚ï¼Œè®°ä½ç»“è®º ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:6:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#åŸºäºæ¯”è¾ƒçš„æ’åºç®—æ³•ä¸‹ç•Œ"},{"categories":null,"content":" è®¡æ•°æ’åº python def CountingSort(arr, n): b, c = [0] * (n+1), [0] * (n+1) for i in range(n): b[arr[i]] += 1 for i in range(1, n+1): # å› ä¸ºæ˜¯ 0-n ä¸€å…± n+1 ä¸ªå…ƒç´  b[i] += b[i-1] for i in arr[::-1]: c[b[i]] = i b[i] -= 1 return c è¿™ä¸ªæ˜¯ç®€æ˜“ç‰ˆæœ¬ï¼Œè¿˜éœ€è¦ç”¨ max å’Œ min è®¡ç®—åç§»ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ç©ºé—´æµªè´¹ã€‚ è®¡æ•°æ’åºæœ€ç®€å•çš„æ€è·¯å°±æ˜¯ï¼Œå‡å¦‚æœ‰æ•°ç»„ 0,1,2,4,2ï¼Œé‚£ä¹ˆè®°å½•å…ƒç´  0-4 åˆ†åˆ«å‡ºç° 1,1,2,0,1 æ¬¡ï¼Œåªéœ€è¦æŒ‰ 0-4 çš„é¡ºåºï¼Œè¾“å‡ºå¯¹åº”æ¬¡æ•°çš„å…ƒç´ å³å¯ã€‚ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿™ä¸ªæ’åºæ˜¯ä¸ç¨³å®šçš„ã€‚ç°åœ¨éœ€è¦è®°å½•ç´¯è®¡æ¬¡æ•°ï¼Œ1,2,4,4,5 ï¼Œç„¶åæŒ‰ç…§é€†å‘éå†åŸæ•°ç»„å³å¯ã€‚ä¾‹å¦‚ï¼Œé¦–å…ˆéå†åˆ°å…ƒç´  2ï¼Œæ‰¾åˆ°å®ƒçš„å‰ç¼€æ•°ç»„å€¼ä¸º 4ï¼Œæ‰€ä»¥ 4 çš„ä½ç½®æ”¾ 2ï¼Œå‰ç¼€å€¼å‡ä¸€ã€‚é‚£ä¹ˆä¸‹ä¸€æ¬¡å†éå†åˆ° 2 çš„æ—¶å€™ï¼Œå®ƒå°±ä¼šæ ¹æ®å‰ç¼€å€¼ 3 æ”¾åœ¨ 3 çš„ä½ç½®ã€‚ æ—¶é—´å¤æ‚åº¦æ˜¯ $O(n+k)$ï¼Œn æ˜¯å…ƒç´ ä¸ªæ•°ï¼Œk æ˜¯åŒºé—´èŒƒå›´ã€‚ ç¼ºç‚¹ï¼š åªé€‚ç”¨äºæ•´æ•°ï¼ˆæˆ–å¯æ˜ å°„åˆ°æ•´æ•°ï¼‰ã€‚ èŒƒå›´ k å¤ªå¤§æ—¶ç©ºé—´æµªè´¹ä¸¥é‡ã€‚ ä¸é€‚åˆç¨€ç–æ•°æ®ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:6:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è®¡æ•°æ’åº"},{"categories":null,"content":" åŸºæ•°æ’åºå‡è®¾æœ‰ n ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ ä¸º d ä½ python def RadixSort(arr, d): for i in range(d): SortOnDigit(arr, i) å¯¹äºæ¯ä¸€æ¬¡å¾ªç¯ï¼Œå‡å¦‚å¯¹ç¬¬ i ä½é‡‡ç”¨ $O(n+k)$ çš„ç¨³å®šæ’åºï¼ˆæ¯ä¸ªå…ƒç´ æœ‰ k ç§å–å€¼ï¼‰ï¼Œä¾‹å¦‚è®¡æ•°æ’åºï¼Œé‚£ä¹ˆæ€»è€—æ—¶ $\\Theta(d(n+k))$ã€‚ è®°ä½ä»ä½ä½åˆ°é«˜ä½æ’åº ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:6:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#åŸºæ•°æ’åº"},{"categories":null,"content":" æ¡¶æ’åº æ¯ä¸ªæ¡¶å†…å†ç”¨å…¶ä»–çš„æ’åºç®—æ³•è¿›è¡Œæ’åºï¼ˆæ¯”å¦‚å¿«æ’ï¼‰ï¼Œè¿™æ ·å­æ—¶é—´å¤æ‚åº¦ä¸è¿˜æ˜¯ $O(n\\log n)$ å—ï¼Ÿ å¦‚æœè¦æ’åºçš„æ•°æ®æœ‰ n ä¸ªï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬åˆ†åœ¨ m ä¸ªæ¡¶ä¸­ï¼Œè¿™æ ·æ¯ä¸ªæ¡¶é‡Œçš„æ•°æ®å°±æ˜¯ $k=\\frac{n}{m}$ã€‚æ¯ä¸ªæ¡¶å†…æ’åºçš„æ—¶é—´å¤æ‚åº¦å°±ä¸º $O(k\\log k)$ã€‚m ä¸ªæ¡¶å°±æ˜¯ $m * O((n / m)*log(n / m))=O(nlog(n / m))$ã€‚å½“æ¡¶çš„ä¸ªæ•° m æ¥è¿‘æ•°æ®ä¸ªæ•° n æ—¶ï¼Œ$log(n/m)$å°±æ˜¯ä¸€ä¸ªè¾ƒå°çš„å¸¸æ•°ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦æ¥è¿‘O(n)ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:6:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ¡¶æ’åº"},{"categories":null,"content":" è¯¾åé¢˜ å‰ç¼€å’Œï¼Œå¾—åˆ°ç´¯ç§¯æ•°ç»„ä¹‹åï¼Œç”¨ c[b] - c[a] å°±å¯ä»¥äº†ã€‚ å½“æ¡¶æ’åºæ‰€æœ‰å…ƒç´ éƒ½è¢«é›†ä¸­åœ¨ä¸€ä¸ªæ¡¶çš„æ—¶å€™ï¼Œæ¡¶æ’åºå°±ä¼šé€€åŒ–ä¸ºå¿«é€Ÿæ’åºï¼Œå¦‚æœå‡ºç°å¿«æ’çš„æœ€åæƒ…å†µï¼šæ¯æ¬¡é€‰æ‹©çš„ pivot éƒ½æ˜¯æœ€å¤§æœ€å°å€¼ï¼Œå°±ä¼šå‡ºç° $O(n^2)$ çš„æ—¶é—´å¤æ‚åº¦ã€‚å¯ä»¥é€šè¿‡å½’å¹¶æ’åºæˆ–è€…æ¡¶æ’åºï¼Œä½¿å¾—æœ€åæƒ…å†µä¸‹ä¹Ÿæ˜¯ $O(n\\lg n)$ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:6:5","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-5"},{"categories":null,"content":" ç¬¬ä¹ç«  ä¸­ä½æ•°å’Œé¡ºåºç»Ÿè®¡","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:7:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬ä¹ç« -ä¸­ä½æ•°å’Œé¡ºåºç»Ÿè®¡"},{"categories":null,"content":" æœ€å€¼ å•ç‹¬è·å¾—æœ€å¤§å€¼æˆ–è€…æœ€å°å€¼ï¼Œæœ€å°‘éœ€è¦ n-1 æ¬¡æ¯”è¾ƒ åŒæ—¶è·å¾—æœ€å¤§å’Œæœ€å°å€¼ä¸éœ€è¦ 2(n-1) æ¬¡æ¯”è¾ƒï¼Œåªéœ€ $3*\\lfloor\\frac{n}{2}\\rfloor$ ï¼Œæ–¹æ³•å°±æ˜¯åŒæ—¶å–ä¸¤ä¸ªè¾“å…¥ï¼Œç„¶åå°†ä»–ä»¬å…ˆè¿›è¡Œä¸€æ¬¡æ¯•ç«Ÿï¼Œç„¶åæ‹¿è¾ƒå°çš„å…ƒç´ å’Œæœ€å°å€¼æ¯”è¾ƒï¼Œè¾ƒå¤§çš„å…ƒç´ å’Œæœ€å¤§å€¼è¿›è¡Œæ¯”è¾ƒï¼Œåªéœ€è¦ä¸‰æ¬¡æ¯”è¾ƒã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:7:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æœ€å€¼"},{"categories":null,"content":" æœŸæœ›æ—¶é—´ä¸ºçº¿æ€§çš„é€‰æ‹©ç®—æ³•é€‰æ‹©ç®—æ³•ï¼šç»™å®šæ— åºæ•°ç»„ A å’Œæ•´æ•° kï¼ˆ1 â‰¤ k â‰¤ nï¼‰ï¼Œæ‰¾å‡ºæ•°ç»„ä¸­ç¬¬ k å°çš„å…ƒç´ ï¼ˆå³æ’åºåä½äºä½ç½® k çš„å…ƒç´ ï¼‰ã€‚ æ€æƒ³ç±»ä¼¼å¿«æ’ï¼Œ éšæœºé€‰æ‹©ä¸€ä¸ªä¸»å…ƒ pivotï¼Œå¯¹æ•°ç»„è¿›è¡Œåˆ†åŒºï¼ˆpartitionï¼‰ï¼šå·¦è¾¹ \u003c pivotï¼Œå³è¾¹ \u003e pivotï¼Œpivot è‡ªå·±æ”¾ä¸­é—´ã€‚ åˆ†åŒºåï¼Œpivot è½åœ¨æœ€ç»ˆä½ç½® rankï¼ˆå‡è®¾ rank æ˜¯ pivot çš„æ’åï¼Œä»1å¼€å§‹ï¼‰ã€‚ å¦‚æœ rank == kï¼Œç›´æ¥è¿”å› pivotã€‚ å¦‚æœ k \u003c rankï¼Œé€’å½’åœ¨å·¦å­æ•°ç»„æ‰¾ç¬¬ k å°ã€‚ å¦‚æœ k \u003e rankï¼Œé€’å½’åœ¨å³å­æ•°ç»„æ‰¾ç¬¬ (k - rank) å°ã€‚ python def SelectK(arr, l, r, k): if l == r: return arr[l] pivot_idx = random.randint(l, r) swap(arr[pivot_idx], arr[r]) i = l - 1 for j in range(l, r+1): if arr[j] \u003c= arr[r]: i += 1 swap(arr[i], arr[j]) swap(arr[i], arr[r]) i += 1 rank = i - l + 1 if rank == k: return arr[] elif rank \u003e k: return SelectK(arr, l, rank-1, k) else: return SelectK(arr, rank+1, r, k - rank) ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:7:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æœŸæœ›æ—¶é—´ä¸ºçº¿æ€§çš„é€‰æ‹©ç®—æ³•"},{"categories":null,"content":" æœ€åæ—¶é—´ä¸ºçº¿æ€§çš„é€‰æ‹©ç®—æ³•åŠå…¶æ—¶é—´åˆ†æBfprt ç®—æ³•çš„æ€è·¯æ˜¯é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ pivot ä½¿å¾—æœ€åæƒ…å†µä¸‹ï¼Œæ—¶é—´å¤æ‚åº¦è¿˜æ˜¯çº¿æ€§çš„ã€‚é€‰æ‹©åˆé€‚ pivot çš„æ–¹æ³•æ˜¯ï¼Œå°†æ•°æ®åˆ†ä¸ºå¤šä¸ªåŒºé—´ï¼Œé€’å½’è°ƒç”¨ Bfprt æ‰¾åˆ°æ¯ä¸ªåŒºé—´ä¸­ä½æ•°çš„ä¸­ä½æ•°ã€‚ python def bfprt(arr, low, high, k): n = high - low + 1 if n \u003c= 5: # æ’åºå­æ•°ç»„å¹¶è¿”å›ç¬¬ k å° sub = sorted(arr[low:high+1]) return sub[k-1] # æ­¥éª¤2-3: åˆ†ç»„æ‰¾æ¯ç»„ä¸­ä½æ•° medians = [] for i in range(low, high+1, 5): group = arr[i:min(i+5, high+1)] group.sort() medians.append(group[len(group)//2]) # æ­¥éª¤4: é€’å½’æ‰¾ä¸­ä½æ•°çš„ä¸­ä½æ•° mom mom = bfprt(medians, 0, len(medians)-1, len(medians)//2 + 1) # æ­¥éª¤5: ç”¨ mom åˆ†åŒºï¼ˆç±»ä¼¼å¿«é€Ÿæ’åº partitionï¼‰ # ...ï¼ˆäº¤æ¢ mom åˆ°æœ«å°¾ï¼Œpartitionï¼Œè¿”å› rankï¼‰ # æ­¥éª¤6: é€’å½’åˆ¤æ–­ if k == rank: return mom elif k \u003c rank: return bfprt(arr, low, pivot_pos-1, k) else: return bfprt(arr, pivot_pos+1, high, k - rank) ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:7:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æœ€åæ—¶é—´ä¸ºçº¿æ€§çš„é€‰æ‹©ç®—æ³•åŠå…¶æ—¶é—´åˆ†æ"},{"categories":null,"content":" è¯¾åé¢˜ é‡‡ç”¨é”¦æ ‡èµ›åˆ¶ï¼Œå¯¹å…ƒç´ è¿›è¡Œä¸¤ä¸¤æ¯”è¾ƒï¼Œæœ€ç»ˆç»è¿‡ $\\lceil \\log_2 n \\rceil$ è½® n-1 æ¬¡æ¯”è¾ƒå¾—åˆ°æœ€å°å…ƒç´ ã€‚è¿™æ—¶å€™è‡³å°‘æœ‰ $\\lceil \\log_2 n \\rceil$ ä¸ªå…ƒç´ ç›´æ¥è¾“ç»™è¿‡æœ€å°å…ƒç´ ï¼Œç¬¬äºŒå°å…ƒç´ åªæœ‰å¯èƒ½åœ¨è¿™é‡Œé¢ã€‚è¿™æ—¶å€™æ¯”è¾ƒ $\\lceil \\log_2 n \\rceil - 1$ æ¬¡å°±èƒ½å¾—åˆ°é‡Œé¢æœ€å°å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒå°å…ƒç´ ã€‚ kåˆ†ä½æ•°æ˜¯å¤§å°ä¸ºnçš„é›†åˆï¼ˆæ¯”å¦‚æ•°ç»„ï¼‰é‡Œé¢çš„k-1ä¸ªæ•°ï¼Œå®ƒä»¬æŠŠæœ‰åºçš„é›†åˆåˆ†ä¸ºkä¸ªåˆ†ç»„ï¼Œä»»ä½•ä¸¤ä¸ªä¸ªåˆ†ç»„ä¹‹é—´çš„å¤§å°ä¹‹å·®çš„ç»å¯¹å€¼ä¸è¶…è¿‡1ï¼ˆæœ‰ç‚¹ç±»ä¼¼äºå¹³è¡¡äºŒå‰æ ‘ï¼‰ï¼Œæ¯”å¦‚é›†åˆ{3ï¼Œ 5ï¼Œ 9ï¼Œ 4ï¼Œ 2ï¼Œ 1ï¼Œ 6ï¼Œ 8ï¼Œ 9ï¼Œ 10ï¼Œ 12ï¼Œ 7ï¼Œ 6}ï¼Œæ’åºåä¸º{1ï¼Œ 2ï¼Œ 3ï¼Œ 4ï¼Œ 5ï¼Œ 6ï¼Œ 6ï¼Œ 7ï¼Œ 8ï¼Œ 9ï¼Œ 9ï¼Œ 10ï¼Œ 12}ï¼Œå®ƒçš„4ï¼ˆk = 4ï¼‰åˆ†ä½æ•°ä¸º{4ï¼Œ 6ï¼Œ 9}ï¼Œ åˆ†ç»„åçš„å­é›†åˆåˆ†åˆ«ä¸º{1ï¼Œ 2ï¼Œ 3ï¼Œ 4}ï¼Œ {5ï¼Œ 6ï¼Œ 6}ï¼Œ {7ï¼Œ 8ï¼Œ 9}ï¼Œ {9ï¼Œ 10ï¼Œ 12}ã€‚è¦æ±‚ä»é›†åˆä¸­æ‰¾å‡ºè¿™k-1ä¸ªæ•°ï¼Œå¹¶ä¸”æ—¶é—´å¤æ‚åº¦ä¸ºO(nlgk)ã€‚ æ€è·¯ï¼šå¦‚æœå¯¹è¿™ k-1 ä¸ªæ•°åˆ†åˆ«ä½¿ç”¨ Order Statistics ç®—æ³•ï¼Œç¬¬ä¸€æ¬¡æ‰¾å‡ºç¬¬4å°çš„æ•°ï¼Œç¬¬äºŒæ¬¡æ‰¾å‡ºç¬¬7å°çš„æ•°ï¼Œç¬¬ä¸‰æ¬¡æ‰¾å‡ºç¬¬10å°çš„æ•°ï¼Œè™½ç„¶æ¯æ¬¡çš„æ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œä½† k-1 æ¬¡åˆ™ä¸º$O(nk)$ï¼Œä¸æ˜¯ $O(nlgk)$ã€‚æ‰€ä»¥å¯ä»¥é‡‡ç”¨åˆ†æ²»çš„æ€è·¯ã€‚ å‡å¦‚éœ€è¦æ‰¾åˆ° k åˆ†ä½æ•°ï¼Œk=4 é‚£ä¹ˆå°±å…ˆå‡åŠæ‰¾åˆ° k=2 åˆ†ä½æ•°ï¼Œè¿™æ—¶å€™æ—¶é—´å¤æ‚åº¦ $O(n)$ ç„¶åæˆ‘ä»¬é€’å½’çš„å¤„ç†å·¦è¾¹éƒ¨åˆ†å’Œå³è¾¹çš„åˆ†ä½æ•° ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:7:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-6"},{"categories":null,"content":" ç¬¬åä¸‰ç«  çº¢é»‘æ ‘äºŒå‰æœç´¢æ ‘æ²¡æœ‰æ§åˆ¶æ ‘é«˜ï¼Œçº¢é»‘æ ‘åœ¨äºŒå‰æœç´¢æ ‘åŸºç¡€ä¸Šï¼Œé€šè¿‡åœ¨èŠ‚ç‚¹æ•°å¢åŠ é¢œè‰²ï¼Œæ§åˆ¶æ²¡æœ‰ä¸€æ¡è·¯å¾„ä¼šæ¯”å…¶ä»–è·¯å¾„é•¿å‡º 2 å€ï¼Œä½¿å¾—è¿‘ä¹å¹³è¡¡ã€‚ æ ¹å¶é»‘ ä¸çº¢çº¢ é»‘è·¯åŒ æœ‰ n ä¸ªèŠ‚ç‚¹çš„çº¢é»‘æ ‘ï¼Œé«˜åº¦è‡³å¤šä¸º $2lg(n+1)$ ä¸€æ£µé»‘é«˜ä¸º K çš„çº¢é»‘æ ‘ä¸­ï¼Œç»“ç‚¹æœ€å¤šä¸º $2^{2k+1}-1$ï¼ˆçº¢é»‘äº¤æ›¿ï¼‰ï¼Œæœ€å°‘ $2^{k+1}-1$ ï¼ˆå…¨é»‘ï¼‰ ä¸è€ƒç”»å›¾ï¼Œéšä¾¿çœ‹çœ‹ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:8:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬åä¸‰ç« -çº¢é»‘æ ‘"},{"categories":null,"content":" ç¬¬åå››ç«  æ•°æ®ç»“æ„çš„æ‰©å¼ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:9:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬åå››ç« -æ•°æ®ç»“æ„çš„æ‰©å¼ "},{"categories":null,"content":" é¡ºåºæŸ¥æ‰¾æ ‘ å‰é¢å­¦çš„ Order-Statistics ç®—æ³•å¯ä»¥åœ¨ $O(n)$ çš„æ—¶é—´å†…æ‰¾åˆ°ç¬¬ i ä¸ªå…ƒç´ ï¼Œä½†æ˜¯å¦‚æœéœ€è¦è¿›è¡Œå¤šæ¬¡æŸ¥æ‰¾æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦è¿˜æ˜¯è›®é«˜çš„ã€‚é¡ºåºæŸ¥æ‰¾æ ‘èƒ½åšåˆ°ä¸€æ¬¡é¢„å¤„ç†ä¹‹åï¼Œæ¯æ¬¡æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(\\lg n)$ã€‚ å®ƒåœ¨çº¢é»‘æ ‘åŸºç¡€ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤äº†ä¸€ä¸ª size å±æ€§ï¼Œæ ‡å¿—äº†ä»¥è‡ªå·±ä¸ºæ ¹çš„å­æ ‘ä¸ªæ•°ï¼Œå®ƒçš„åŠŸèƒ½åŒ…æ‹¬ï¼š æ ¹æ®å…ƒç´  x è·å¾—å®ƒçš„ rank æ ¹æ® rank è·å– x python def Rank2Ele(t, r): rank = t.left.size + 1 if rank == r: return elif rank \u003e r: return Rank2Ele(t.left, r) else: return Rank2Ele(t.right, r - rank) def Ele2Rank(t, x): if t == x: return t.left.size + 1 elif t \u003e x: return Ele2Rank(t.left, x) else: return t.left.size + 1 + Ele2Rank(t.right, x) ç®€å•æ¥è¯´ï¼šå¦‚æœæ‰©å¼ å±æ€§åªå½±å“åˆ°çˆ¶èŠ‚ç‚¹æˆ–åªå½±å“åˆ°å­èŠ‚ç‚¹ï¼Œå°±å¯ä»¥åœ¨çº¢é»‘æ ‘ä¸Šæ‰©å¼ ã€‚ èƒ½ä¸èƒ½æ‹“å±•æ·±åº¦å±æ€§å‘¢ï¼Ÿ ä¸è¡Œï¼Œå‡å¦‚æ ¹èŠ‚ç‚¹åˆ é™¤äº†ï¼Œé‚£ä¹ˆä¸‹é¢æ‰€æœ‰å­èŠ‚ç‚¹éƒ½éœ€è¦ä¿®æ”¹æ·±åº¦â€“ï¼Œå½±å“çš„æ˜¯ $O(n)$ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:9:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#é¡ºåºæŸ¥æ‰¾æ ‘"},{"categories":null,"content":" åŒºé—´æ ‘ åŒºé—´æ ‘ä»¥çº¢é»‘æ ‘ä¸ºåŸºç¡€ åŒºé—´æ ‘çš„èŠ‚ç‚¹å…³é”®è¯å­˜å‚¨çš„æ˜¯ä¸€ä¸ªåŒºé—´ i.left, i.right åŒºé—´æ ‘èŠ‚ç‚¹é™„åŠ ä¿¡æ¯æ˜¯ maxï¼Œä»£è¡¨èŠ‚ç‚¹æ‰€åœ¨çš„æ‰€æœ‰å­æ ‘ï¼Œæœ€å¤§çš„å³ç«¯ç‚¹ ç”±äº x.max = max(x.left.max, x.int.right, x.right.max) ï¼Œæ ¹æ®å®šç†å¯ä»¥åœ¨çº¢é»‘æ ‘ä¸Šæ‰©å±•ã€‚ python def IntervalSearch(T, i): res = [] x = T.root if x != T.nil and overlap(x.i, i): res.append(x) if x.left != T.nil and x.left.max \u003e i.left: IntervalSearch(x.left, i) elif x.right != T.nil: IntervalSearch(x.right, i) Note åŒºé—´æ ‘çš„å·¦èŠ‚ç‚¹åŒºé—´çš„å·¦ç«¯ç‚¹ä¸€å®šæ¯”çˆ¶èŠ‚ç‚¹çš„å·¦ç«¯ç‚¹å°ï¼Œä½†æ˜¯å³ç«¯ç‚¹ä¸ä¸€å®šï¼Œå¹¶ä¸æ˜¯è¯´å·¦ç«¯ç‚¹æ•´ä¸ªåŒºé—´éƒ½åœ¨çˆ¶èŠ‚ç‚¹åŒºé—´çš„å·¦ä¾§ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:9:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#åŒºé—´æ ‘"},{"categories":null,"content":" è¯¾åé¢˜ python def i_after_x(T, x, i): idx = Ele2Rank(T, x) return Rank2Ele(T, i + idx) æ ¹æ®å…ƒç´ æŸ¥ rank å’Œä½ æ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ $O(\\lg n)$ï¼Œæ‰€ä»¥è¿˜æ˜¯ $O(\\lg n)$ã€‚ å¯ä»¥ï¼Œå› ä¸ºå½“ä¸€ä¸ªèŠ‚ç‚¹çš„é¢œè‰²åè½¬æ—¶å€™ï¼Œå®ƒåªä¼šå½±å“çˆ¶èŠ‚ç‚¹çš„é»‘é«˜ï¼Œä¾‹å¦‚çº¢å˜é»‘ï¼Œé‚£ä¹ˆçˆ¶èŠ‚ç‚¹é»‘é«˜++ï¼Œåªä¼šåœ¨è¿™é¢—å­æ ‘å‘ä¸Šæˆ–è€…å‘ä¸‹å½±å“ï¼Œæœ€å¤š $O(\\lg n)$ã€‚ python def min_overlap(T, i): res = T.nil rec = INF x = T.root while x != T.nil: if overlaps(x.int, i) and x.int.left \u003c rec: rec = x.int.left res = x if x.left != T.nil and x.left.max \u003e= i.right: x = x.left else: x = x.right return res ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:9:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-7"},{"categories":null,"content":" ç¬¬åäº”ç«  åŠ¨æ€è§„åˆ’","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:10:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬åäº”ç« -åŠ¨æ€è§„åˆ’"},{"categories":null,"content":" æ€æƒ³\u0026æ­¥éª¤ è§£å†³çš„æ˜¯å¯»æ‰¾é—®é¢˜çš„ä¸€ä¸ªæœ€ä¼˜è§£ å…·å¤‡çš„ä¸¤ä¸ªè¦ç´ ï¼šæœ€ä¼˜å­ç»“æ„å’Œå­é—®é¢˜é‡å  é—®é¢˜çš„æœ€ä¼˜è§£ç”±ç›¸å…³å­é—®é¢˜çš„æœ€ä¼˜è§£ç»„åˆè€Œæˆ å­é—®é¢˜é‡å ï¼šä¾‹å¦‚æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œé‡å¤æ±‚åŒä¸€ä¸ªå­é—®é¢˜ æ­¥éª¤ï¼š è¯†åˆ«æœ€ä¼˜è§£çš„ç‰¹å¾ é€’å½’çš„å®šä¹‰æœ€ä¼˜è§£çš„å€¼ï¼ˆå°±æ˜¯çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼‰ è‡ªåº•å‘ä¸Šæ±‚è§£ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:10:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ€æƒ³æ­¥éª¤"},{"categories":null,"content":" å’Œåˆ†æ²»æ³•åŒºåˆ« åˆ†æ²»æ³•æ˜¯åˆ†è§£ä¸ºäº’ä¸ç›¸å¹²çš„å­é—®é¢˜æ±‚è§£ä¹‹ååˆå¹¶ åŠ¨æ€è§„åˆ’æ˜¯é‡å çš„å­é—®é¢˜ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:10:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å’Œåˆ†æ²»æ³•åŒºåˆ«"},{"categories":null,"content":" ç®—æ³•è®¾è®¡ä¾‹ï¼šç»™å®šä¸åŒé¢é¢çš„ç¡¬å¸ coins å’Œä¸€ä¸ªæ€»é‡‘é¢ amountã€‚ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥è®¡ç®—å¯ä»¥å‡‘æˆæ€»é‡‘é¢æ‰€éœ€çš„æœ€å°‘çš„ç¡¬å¸ä¸ªæ•°ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•ä¸€ç§ç¡¬å¸ç»„åˆèƒ½ç»„æˆæ€»é‡‘é¢ï¼Œè¿”å›-1ã€‚ä½ å¯ä»¥è®¤ä¸ºæ¯ç§ç¡¬å¸çš„æ•°é‡æ˜¯æ— é™çš„ã€‚ å‡è®¾æˆ‘ä»¬ç”¨ Func(coins, amount) æ±‚è§£æ‰€éœ€çš„æœ€å°‘çš„ç¡¬å¸ä¸ªæ•°ï¼Œå¹¶ä¸” ç¡¬å¸ä¸º 1 å’Œ 2ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠä»–åˆ†è§£ä¸ºï¼Œæ±‚è§£ amount-1 æ‰€éœ€æœ€å°‘ç¡¬å¸å’Œ amount -2 æ‰€éœ€æœ€å°‘ç¡¬å¸çš„æœ€å°å€¼ + 1ã€‚å†™æˆé€’æ¨å¼å³ä¸ºï¼š$T(n)=min(T(n-1)+T(n-2))+1$ python def MinimumCoins(coins, amount): dp = [INF] * (amount+1) dp[0] = 0 for i in range(1, len(dp)): for coin in coins: if i - coin \u003c 0: continue dp[i] = min(dp[i], dp[i-coin]) + 1 return dp[amount] è¿™ä¸ªé¢˜æ€è·¯å’Œå‡‘ç¡¬å¸å®Œå…¨ä¸€æ ·ï¼ŒæŠŠæœ€å°å€¼å˜æˆæœ€å¤§å€¼ï¼Œå°±è¡Œäº†ã€‚ m[i][j] ä¾èµ–äºåŒºé—´æ›´çŸ­çš„å­é—®é¢˜ï¼Œæ‰€ä»¥å¿…é¡»æŒ‰åŒºé—´é•¿åº¦é€’å¢è®¡ç®—ï¼Œå¸¸è§é¡ºåºæ˜¯ï¼š text for l = 2 to n // é“¾é•¿åº¦ for i = 1 to nâˆ’l+1 j = i + l âˆ’ 1 è®¡ç®— m[i][j] è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„åŒºé—´ DPã€‚ python def MatrixMultiply(m): dp = [[INF for i in range(n+1)] * (n+1)] for i in range(n+1): dp[i][i] = 0 for l in range(2, n+1): for i in range(1, n+1-l): j = i + l - 1 for k in range(i, j): cost = dp[i][k]+dp[k+1][j]+m[i].p*m[k].q*m[j].q if cost \u003c dp[i][j]: dp[i][j] = cost res[i][j] = k ä¾‹ï¼šç»™å®šä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•´æ•°åºåˆ— A[1â€¦n]ï¼ˆå¯æ­£å¯è´Ÿï¼‰ï¼Œè¦æ±‚æ‰¾ä¸€ä¸ªè¿ç»­å­æ®µ A[iâ€¦j]ï¼Œä½¿å…¶å…ƒç´ å’Œæœ€å¤§ã€‚ python ans = -INF dp = [0]*(n+1) dp[1] = A[1] for i in range(2, n+1): dp[i] = A[i] if dp[i-1] \u003c 0 else A[i] + dp[i-1] ans = max(ans, dp[i]) return ans Note è¿™é‡Œæˆ‘ä»¬ä¸åº”è¯¥çº ç»“äºï¼Œå‡å¦‚åä¸€ä¸ªæ•°å­—æ˜¯è´Ÿæ•°ï¼Œåé¢ä¼šä¸ä¼šæœ‰æ›´å¤§çš„æ­£æ•°æ¥å¼¥è¡¥ã€‚æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œå­ä¸²å’Œè¿™ä¸ªæ¦‚å¿µä»£è¡¨äº†â€œä»¥ä½ç½® i ç»“å°¾çš„æœ€å¤§å­æ®µå’Œåªå’Œ iâˆ’1 æœ‰å…³â€ã€‚å¦‚ 1 2 -5 6 è¿™ä¸ªä¾‹å­ï¼Œå‡å¦‚æˆ‘ä»¬çº ç»“æ€ä¹ˆåˆ¤æ–­ -5 ä¹‹å 6 åŠ ä¸Šå»å­ä¸²å’Œæ›´å¤§å°±ä¼šä¹±ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨ -5 çš„è§†è§’ï¼Œå¯¹äº -5 æ¥è¯´å¦‚æœå‰é¢çš„å­ä¸²å¤§äº 0ï¼Œé‚£ä¹ˆå¯¹å®ƒå°±æ˜¯æœ‰åˆ©çš„åº”è¯¥åŠ ä¸Šå»ã€‚ æ³¨æ„å­åºåˆ—å’Œå­ä¸²åŒºåˆ« python for i in range(1, m+1): for j in range(1, n+1): if x[i] == y[j]: dp[i][j] = dp[i-1][j-1] + 1 else: dp[i][j] = max(dp[i-1][j], dp[i][j-1]) text æ‰¾å‡ºä¸¤ä¸ªé•¿åº¦åˆ†åˆ«ä¸ºmå’Œnå­—ç¬¦ä¸²åºåˆ—çš„æœ€é•¿å…¬å…±å­—ä¸²ï¼ˆå­—ä¸²ä¸ºä¸‹æ ‡è¿ç»­çš„å­ åºåˆ—ï¼‰ï¼Œè¯•ï¼š ï¼ˆ1ï¼‰ å…ˆç»™å‡ºæœ´ç´ ç®—æ³•çš„ç®—æ³•æ€æƒ³ã€ä¼ªä»£ç åŠè®¡ç®—æ—¶é—´å¤æ‚åº¦ ï¼ˆ2ï¼‰ å†ç»™å‡ºç®—æ³•æ”¹è¿›æ€è·¯æˆ–ä¸€ä¸ªæ›´æœ‰æ•ˆçš„ç®—æ³• è¿™ä¸ªé—®é¢˜å¯ä»¥ç»“åˆ æœ€é•¿å…¬å…±å­åºåˆ— å’Œ æœ€é•¿è¿ç»­å­ä¸² ä¸¤ä¸ªé—®é¢˜ã€‚ä»¤ dp[i][j] ä¸º ä»¥ X[i] å’Œ Y[j] ç»“å°¾çš„æœ€é•¿å…¬å…±å­ä¸²é•¿åº¦ï¼Œè‹¥å­—ç¬¦ç›¸ç­‰ï¼šdp[i][j] = dp[iâˆ’1][jâˆ’1] + 1 ï¼Œè‹¥å­—ç¬¦ä¸ç­‰ï¼šdp[i][j] = 0ã€‚ text LongestCommonSubstring(X, Y): n = length(X) m = length(Y) create array dp[0..n][0..m] maxLen = 0 endPos = 0 for i = 0 to n: dp[i][0] = 0 for j = 0 to m: dp[0][j] = 0 for i = 1 to n: for j = 1 to m: if X[i] == Y[j]: dp[i][j] = dp[i-1][j-1] + 1 if dp[i][j] \u003e maxLen: maxLen = dp[i][j] endPos = i else: dp[i][j] = 0 return maxLen // å­ä¸²ä¸º X[endPos-maxLen+1 .. endPos] ä¾‹ï¼šç»™ä½ ä¸€ä¸ªæ•´æ•°Â nÂ ï¼Œè¿”å›å’Œä¸ºÂ nÂ çš„å®Œå…¨å¹³æ–¹æ•°çš„æœ€å°‘æ•°é‡ã€‚å®Œå…¨å¹³æ–¹æ•°Â æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå…¶å€¼ç­‰äºå¦ä¸€ä¸ªæ•´æ•°çš„å¹³æ–¹ï¼›æ¢å¥è¯è¯´ï¼Œå…¶å€¼ç­‰äºä¸€ä¸ªæ•´æ•°è‡ªä¹˜çš„ç§¯ã€‚ä¾‹å¦‚ï¼Œ1ã€4ã€9Â å’ŒÂ 16Â éƒ½æ˜¯å®Œå…¨å¹³æ–¹æ•°ï¼Œè€ŒÂ 3Â å’ŒÂ 11Â ä¸æ˜¯ã€‚ python import math class Solution: def numSquares(self, n: int) -\u003e int: pow = [i**2 for i in range(1, math.floor(math.sqrt(n))+1)] dp = [float(\"inf\") for _ in range(n+1)] dp[0] = 0 for i in range(1, n+1): for k in pow: if i-k \u003e= 0: dp[i] = min(dp[i], dp[i-k] + 1) return dp[n] ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:10:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç®—æ³•è®¾è®¡"},{"categories":null,"content":" è¯¾åé¢˜ å› ä¸ºå½’å¹¶æ’åºè¿™ç§åˆ†æ²»ç®—æ³•ä¸ä¼šå‡ºç°é‡å å­é—®é¢˜ï¼Œæ‰€ä»¥ä¸éœ€è¦å¤‡å¿˜æŠ€æœ¯è®°å½•é‡å¤ç»“æœã€‚ 1 0 0 1 1 0 å¯¹äº $2 \\times \\min(m,n)$ ç©ºé—´å¤æ‚åº¦çš„ç®—æ³•ï¼Œç”±äºæ¯æ¬¡éå†åªéœ€è¦ç”¨åˆ° dp æ•°ç»„çš„å½“å‰è¡Œå’Œä¸Šä¸€è¡Œï¼Œæ‰€ä»¥å¯ä»¥åªéœ€è¦ä¿ç•™è¿™ä¸¤è¡Œ å¯¹äº $\\min(m,n)$ ç©ºé—´å¤æ‚åº¦çš„ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä»…ä»…ä¿ç•™ä¸€è¡Œ dp æ•°ç»„ï¼Œæ‰§è¡Œåˆ° dp[i][j] = max(dp[i-1][j], dp[i][j-1]) æ—¶å€™ï¼Œç”±äº dp[i][j-1] è¿˜æ²¡è¢« dp[i][j] è¦†ç›–å¯ä»¥ç›´æ¥è¯»å–ï¼›dp[i][j] = dp[i-1][j-1] + 1 é‡Œé¢çš„ dp[i-1][j-1] å·²ç»è¢« dp[i-1][j] è¦†ç›–ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬çš„å˜é‡è®°å½•å°±å¯ä»¥äº†ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:10:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-8"},{"categories":null,"content":" ç¬¬åå…­ç«  è´ªå¿ƒç®—æ³•","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:11:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬åå…­ç« -è´ªå¿ƒç®—æ³•"},{"categories":null,"content":" æ€æƒ³\u0026å¯¹æ¯” æ ¸å¿ƒæ€æƒ³ï¼šåœ¨æ„é€ è§£çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€æ­¥éƒ½åšå‡ºå½“å‰çœ‹æ¥æœ€ä¼˜ï¼ˆå±€éƒ¨æœ€ä¼˜ï¼‰çš„é€‰æ‹©ï¼Œå¹¶æœŸæœ›é€šè¿‡ä¸€ç³»åˆ—å±€éƒ¨æœ€ä¼˜é€‰æ‹©æœ€ç»ˆå¾—åˆ°å…¨å±€æœ€ä¼˜è§£ã€‚ å’ŒåŠ¨æ€è§„åˆ’çš„åŒºåˆ«ï¼šdp åªè¦æ±‚æœ‰æœ€ä¼˜å­ç»“æ„ï¼Œè´ªå¿ƒè¿˜è¦æ±‚æ»¡è¶³è´ªå¿ƒé€‰æ‹©æ€§è´¨ï¼šå­˜åœ¨ä¸€ä¸ªæœ€ä¼˜è§£ï¼Œå…¶ç¬¬ä¸€æ­¥é€‰æ‹©ç­‰äºè´ªå¿ƒç®—æ³•æ‰€åšçš„é€‰æ‹©ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:11:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ€æƒ³å¯¹æ¯”"},{"categories":null,"content":" å“ˆå¤«æ›¼æ ‘è´ªå¿ƒæ­£ç¡®æ€§è¯æ˜ï¼šå‡è®¾æ ‘å¶èŠ‚ç‚¹é¢‘ç‡æœ€å°çš„ä¸¤ä¸ªèŠ‚ç‚¹ aï¼Œb çš„é¢‘ç‡åˆ†åˆ«æ˜¯ fa å’Œ fbï¼Œå…¨éƒ¨å…ƒç´ ä¸­ï¼Œé¢‘ç‡æœ€å°çš„ç»“ç‚¹ä¸º x å’Œ yï¼Œé¢‘ç‡ä¸º fx å’Œ fyã€‚é‚£ä¹ˆç”¨ xy æ›¿æ¢ abï¼Œä»–ä»¬ä»ç„¶åœ¨æœ€æ·±å¤„ï¼Œå¹¶ä¸”åŠ æƒè·¯å¾„é•¿åº¦åªå¯èƒ½å°ç­‰äº åŸå…ˆçš„ abï¼Œæ‰€ä»¥å¾—åˆ°äº†å¦ä¸€è¯¾æœ€ä¼˜çš„ç¼–ç æ ‘ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:11:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å“ˆå¤«æ›¼æ ‘"},{"categories":null,"content":" ç®—æ³•è®¾è®¡ä¾‹ï¼šç»™å®š n ä¸ªæ´»åŠ¨ï¼Œ æ´»åŠ¨ i çš„å¼€å§‹æ—¶é—´ä¸º $s_i$ï¼Œç»“æŸæ—¶é—´ä¸º $f_i$ï¼Œé€‰æ‹©å°½å¯èƒ½å¤šçš„äº’ä¸å†²çªçš„æ´»åŠ¨ã€‚ æŒ‰æ´»åŠ¨ç»“æŸæ—¶é—´é€’å¢æ’åºï¼› é€‰æ‹©ç¬¬ä¸€ä¸ªç»“æŸæœ€æ—©çš„æ´»åŠ¨ï¼› åœ¨å‰©ä½™æ´»åŠ¨ä¸­ï¼Œé€‰æ‹©å¼€å§‹æ—¶é—´ â‰¥ å½“å‰æ´»åŠ¨ç»“æŸæ—¶é—´çš„ã€ç»“æŸæœ€æ—©çš„æ´»åŠ¨ï¼› é‡å¤ç›´åˆ°æ— æ³•é€‰æ‹©ã€‚ è´ªå¿ƒæ€§è´¨è¯æ˜ï¼š è®¾ A* æ˜¯ä»»æ„ä¸€ä¸ªæœ€ä¼˜è§£ï¼ˆå³åŒ…å«æœ€å¤šæ´»åŠ¨çš„é›†åˆï¼‰ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªæ´»åŠ¨æ˜¯ bï¼Œå…¶ç»“æŸæ—¶é—´ä¸º f_bã€‚ç”±äº a æ˜¯æ‰€æœ‰æ´»åŠ¨ä¸­ç»“æŸæ—¶é—´æœ€æ—©çš„æ´»åŠ¨ï¼Œå› æ­¤æœ‰ï¼šf_a â‰¤ f_bã€‚ åˆ†ä¸¤ç§æƒ…å†µè®¨è®ºï¼š å¦‚æœ a = bï¼šé‚£ä¹ˆ A* æœ¬èº«å·²ç»åŒ…å«è´ªå¿ƒé€‰æ‹© aï¼Œå‘½é¢˜æˆç«‹ã€‚ å¦‚æœ a â‰  bï¼šé‚£ä¹ˆå¯ä»¥ç”¨ a æ›¿æ¢ bï¼Œå› ä¸º a æ¯” b æ—©ç»“æŸï¼Œä¸ä¼šå½±å“åé¢æ´»åŠ¨ã€‚å¹¶ä¸”æ›¿æ¢åæ´»åŠ¨æ•°é‡ä¸€è‡´ï¼Œä»ç„¶æ˜¯æœ€ä¼˜è§£ã€‚ ä¾‹ï¼šæœ‰ n ä¸ªç‰©å“ï¼Œç‰©å“ i çš„ä»·å€¼ä¸º $v_i$ï¼Œé‡é‡ä¸º $w_i$ï¼ŒèƒŒåŒ…å®¹é‡ä¸º Wï¼Œæ¯ä¸ªç‰©å“å¯ä»¥å–ä»»æ„æ¯”ä¾‹ï¼ˆå¯åˆ†å‰²ï¼‰ã€‚ æŒ‰ç…§å•ä½ä»·å€¼ä»é«˜åˆ°ä½æ’åº ä¾æ¬¡é€‰æ‹©ç‰©å“åŠ å…¥èƒŒåŒ… å¦‚æœæœ€åä¸€ä»¶ç‰©å“æ— æ³•å…¨éƒ¨è£…å…¥ï¼Œåˆ™è®¡ç®—å¯ä»¥è£…å…¥çš„æ¯”ä¾‹ï¼Œç„¶åæŒ‰æ¯”ä¾‹è£…å…¥ã€‚ è´ªå¿ƒæ€§è´¨è¯æ˜ï¼šè®¾ a ä¸ºå•ä½é‡é‡ä»·å€¼æœ€å¤§çš„ç‰©å“ã€‚è‹¥æŸæœ€ä¼˜è§£ä¸åŒ…å« aï¼Œåˆ™ä»ä¸­å–å‡ºé‡é‡ä¸º x çš„ä½å•ä½ä»·å€¼ç‰©å“ï¼Œç”¨åŒé‡é‡çš„ a æ›¿æ¢ï¼Œæ€»ä»·å€¼ä¸å‡ã€‚åå¤äº¤æ¢å¯å¾—åŒ…å« a çš„æœ€ä¼˜è§£ï¼Œæ•…è´ªå¿ƒé€‰æ‹©æ€§è´¨æˆç«‹ï¼Œå°æ•°èƒŒåŒ…è´ªå¿ƒç®—æ³•æ­£ç¡®ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:11:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç®—æ³•è®¾è®¡-1"},{"categories":null,"content":" è¯¾åé¢˜ ç®—æ³•æ€è·¯ï¼šæŒ‰ç…§é‡é‡æ’åºï¼Œæ¯æ¬¡é€‰é‡é‡æœ€å°çš„ è´ªå¿ƒæ€§è´¨è¯æ˜ï¼š è®¾ $S^$ æ˜¯ä»»æ„ä¸€ä¸ªæœ€ä¼˜è§£ï¼Œ$S^$ é€‰æ‹©çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸‹æ ‡æ˜¯ i å‡è®¾æŒ‰ç…§è´ªå¿ƒç®—æ³•é€‰æ‹©çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸‹æ ‡ä¸º 0 å‡å¦‚ i==0ï¼Œé‚£ä¹ˆæœ€ä¼˜è§£ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯è´ªå¿ƒ å‡å¦‚ i != 0ï¼Œé‚£ä¹ˆæœ€ä¼˜è§£çš„ç¬¬ä¸€ä¸ªå…ƒç´ è‚¯å®šæ¯” 0 é‡ä»·å€¼ä½ï¼Œé‚£ä¹ˆæ›¿æ¢ä¸º 0 å°±å¯ä»¥å¾—åˆ°æ›´ä¼˜è§£ã€‚ ç®—æ³•æ€è·¯ï¼šå¯¹ç‚¹é›†è¿›è¡Œæ’åºï¼Œæ¯æ¬¡éƒ½å–å‰©ä½™ç‚¹é›†ä¸­æœ€é å·¦çš„ç‚¹å½“æ–°åŒºé—´çš„å·¦ç«¯ç‚¹ è´ªå¿ƒæ€§è´¨è¯æ˜ï¼š å‡è®¾ï¼š$x_1$â€‹ æ˜¯å½“å‰æœ€å·¦çš„ç‚¹ï¼Œè´ªå¿ƒç®—æ³•é€‰æ‹©çš„ç¬¬ä¸€ä¸ªåŒºé—´ä¸º $I_a = [x_1,; x_1+1]$ è®¾ $S^*$ æ˜¯ä»»æ„ä¸€ä¸ªæœ€ä¼˜è§£ï¼Œè¦†ç›– $x_1$ çš„åŒºé—´ä¸º $I_b = [l_b,; l_b+1]$ï¼Œé‚£ä¹ˆå¿…æœ‰ $l_b \\le x_1 \\le l_b + 1$ã€‚ æŒ‰ç…§æ€è·¯ï¼Œè´ªå¿ƒåŒºé—´çš„å³ç«¯ç‚¹ä¸º $r_a = x_1 + 1$ï¼Œæœ‰ $r_b \\le r_a$ã€‚ å‡è®¾ $I_a = I_b$ åˆ™æœ€ä¼˜è§£ $S^*$ æœ¬èº«å·²ç»åŒ…å«è´ªå¿ƒé€‰æ‹©çš„åŒºé—´ï¼Œå‘½é¢˜æˆç«‹ã€‚ å‡è®¾ $I_a \\ne I_b$ï¼Œåˆ™æ–°åŒºé—´ $Sâ€™ = (S^* \\setminus {I_b}) \\cup {I_a}$ï¼Œè¿™æ˜¯ä¸€ä¸ªæ›´ä¼˜è§£ã€‚ æ–æ³¢é‚£å¥‘æ•°åˆ—æ„é€ çš„å“ˆå¤«æ›¼æ ‘ï¼Œæ‰€æœ‰èŠ‚ç‚¹å·¦å­æ ‘éƒ½åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚ æœ€ä¼˜å‰ç¼€ç ä¸ºï¼š0,01,001,0001 ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:11:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-9"},{"categories":null,"content":" å®éªŒäºŒ å›æº¯æ³•","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:12:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å®éªŒäºŒ-å›æº¯æ³•"},{"categories":null,"content":" è§£ç©ºé—´æ ‘æ ¹æ®é—®é¢˜çš„ä¸åŒï¼Œè§£ç©ºé—´é€šå¸¸è¡¨ç°ä¸ºä»¥ä¸‹ä¸‰ç§å½¢å¼ä¹‹ä¸€ï¼š å­é›†ç©ºé—´ï¼ˆå­é›†æ ‘ï¼‰ æ¯ä¸ªå…ƒç´ åªæœ‰â€œé€‰â€æˆ–â€œä¸é€‰â€ä¸¤ç§çŠ¶æ€ã€‚ å¸¸è§äº 0-1 èƒŒåŒ…ã€å­é›†å’Œé—®é¢˜ã€‚ è§£ç©ºé—´æ ‘é€šå¸¸æ˜¯ä¸€æ£µäºŒå‰æ ‘ã€‚ æ’åˆ—ç©ºé—´ï¼ˆæ’åˆ—æ ‘ï¼‰ å…ƒç´ çš„é¡ºåºä¸åŒå³æ„æˆä¸åŒè§£ã€‚ å¸¸è§äºå…¨æ’åˆ—ã€TSP ç­‰é—®é¢˜ã€‚ æ ‘çš„åˆ†æ”¯æ•°éšå±‚æ•°é€’å‡ã€‚ ç»„åˆç©ºé—´ ä»‹äºå­é›†å’Œæ’åˆ—ä¹‹é—´ã€‚ å¸¸è§äºä» n ä¸ªå…ƒç´ ä¸­é€‰ k ä¸ªçš„ç»„åˆé—®é¢˜ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:12:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è§£ç©ºé—´æ ‘"},{"categories":null,"content":" ç®—æ³•è®¾è®¡","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:12:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç®—æ³•è®¾è®¡-2"},{"categories":null,"content":" n åé—®é¢˜é—®é¢˜æè¿°ï¼š åœ¨ nÃ—n çš„æ£‹ç›˜ä¸Šæ”¾ç½® n ä¸ªçš‡åï¼Œä½¿å¾—ä»»æ„ä¸¤ä¸ªçš‡åä¸åœ¨åŒä¸€è¡Œã€åŒä¸€åˆ—æˆ–åŒä¸€å¯¹è§’çº¿ä¸Šã€‚ python def n_queen(chess, line): if line == n+1 and check(chess): print(chess) for i in range(n): chess[line][i] = True # å¯ä»¥åœ¨è¿™é‡Œå‰ªæï¼Œç”¨colè®°å½•é‚£äº›åˆ—æœ‰çš‡åäº† # if i in col: # continue # else: # col[i] = True n_queen(chess, line+1) chess[line][i] = False # col[i] = False ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:12:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#n-åé—®é¢˜"},{"categories":null,"content":" 0-1èƒŒåŒ…é—®é¢˜æè¿°ï¼š æ¯ä¸ªç‰©å“åªèƒ½é€‰æˆ–ä¸é€‰ï¼Œåœ¨å®¹é‡é™åˆ¶ä¸‹æœ€å¤§åŒ–æ€»ä»·å€¼ã€‚ cpp void dfs(int i, int cw, int cv) { if (i == n) { ans = max(ans, cv); return; } // ä¸é€‰ç¬¬ i ä¸ª dfs(i + 1, cw, cv); // é€‰ç¬¬ i ä¸ª if (cw + w[i] \u003c= W) { dfs(i + 1, cw + w[i], cv + v[i]); } } ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:12:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#0-1èƒŒåŒ…"},{"categories":null,"content":" TSP é—®é¢˜é—®é¢˜æè¿°ï¼š ç»™å®š n ä¸ªåŸå¸‚åŠå…¶è·ç¦»ï¼Œå¯»æ‰¾ä¸€æ¡ç»è¿‡æ¯ä¸ªåŸå¸‚ä¸€æ¬¡å¹¶å›åˆ°èµ·ç‚¹çš„æœ€çŸ­å›è·¯ã€‚ python visited = [0]*(n+1) def dfs(dis): if sum(visited) == n: ans = min(ans, dis) return for i in range(1, n+1): if visited[i]: continue visited[i] = True dfs(dis+cost[i]) visited[i] = False ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:12:5","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#tsp-é—®é¢˜"},{"categories":null,"content":" ç¬¬åä¸ƒç«  å¹³æ‘Šåˆ†æ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:13:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬åä¸ƒç« -å¹³æ‘Šåˆ†æ"},{"categories":null,"content":" èšåˆåˆ†æå¯¹äºä¸€ä¸ªæ ˆï¼Œå‡è®¾æœ‰ pop, push, multi-pop(n) ä¸‰ä¸ªæ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦åˆ†åˆ«ä¸º O(1), O(1) å’Œ O(n)ã€‚è¿›è¡Œ n æ¬¡æ“ä½œï¼Œæ¯æ¬¡æ“ä½œä»»é€‰ä¸€ä¸ªï¼Œé‚£ä¹ˆæ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿå¦‚æœæŒ‰æœ€åæƒ…å†µï¼Œæ¯æ¬¡æ“ä½œéƒ½æ˜¯ multi-popï¼Œé‚£ä¹ˆæ€»æ—¶é—´å¤æ‚åº¦ä¸º $O(n^2)$ ã€‚ä½†å®é™…æƒ…å†µæ˜¯ï¼Œpush ä¸€æ¬¡æ‰èƒ½ popä¸€æ¬¡ï¼Œæ‰€ä»¥ pop å’Œ multi-pop çš„æ¬¡æ•°å’Œ push æ¬¡æ•°ç›¸å…³ã€‚ç»è¿‡ä¸€ç³»åˆ—è¯æ˜å¯ä»¥å¾—åˆ°å®é™…çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œæ‰€ä»¥å¹³å‡åˆ°æ¯ä¸ªæ“ä½œï¼Œä»–ä»¬çš„æ‘Šè¿˜ä»£ä»·æ˜¯ O(1)ã€‚ åŒæ ·å¯¹äºä¸€ä¸ª n ä½äºŒè¿›åˆ¶ä¸² 0000000ï¼Œæ¯æ¬¡è¿›è¡Œ Increment æ“ä½œï¼Œç¬¬ä¸€æ¬¡åªéœ€è¦æ”¹å˜ä¸€ä¸ªå€¼ï¼Œç¬¬äºŒæ¬¡éœ€è¦æ”¹å˜ä¸¤ä¸ª 01 -\u003e 10ï¼Œç¬¬å››æ¬¡éœ€è¦æ ¹æœ¬ä¸‰ä¸ª 011 -\u003e 100ï¼Œæœ€ç»ˆéœ€è¦æ”¹å˜ n ä¸ªå€¼ã€‚æ‰€ä»¥è¿›è¡Œ n æ¬¡æ“ä½œï¼Œæœ€åæƒ…å†µæ˜¯ $O(n^2)$ã€‚ä½†å®é™…ä¸Šæ¯ $2^i$ æ¬¡æ“ä½œç¿»è½¬ä½æ•°æ‰ä¼šåŠ ä¸€ï¼Œæ‰€ä»¥ç»è¿‡ä¸€ç³»åˆ—è¯æ˜ï¼Œæœ€åæƒ…å†µçš„æ—¶é—´æ˜¯ O(n)ï¼Œä»–ä»¬çš„æ‘Šè¿˜ä»£ä»·æ˜¯ O(1)ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:13:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#èšåˆåˆ†æ"},{"categories":null,"content":" æ ¸ç®—æ³•å‡è®¾æˆ‘ä»¬å®ç°ä¸€ä¸ªåŠ¨æ€æ•°ç»„ï¼Œæ”¯æŒpush_backï¼Œæ¯æ¬¡å®¹é‡ä¸å¤Ÿæ—¶ç¿»å€æ‰©å®¹ã€‚ å¤§å¤šæ•°æ’å…¥ä»£ä»·1ï¼ˆåªæ”¾ä¸€ä¸ªå…ƒç´ ï¼‰ã€‚ å¶å°”æ‰©å®¹æ—¶ä»£ä»·â‰ˆå½“å‰sizeï¼ˆè¦å¤åˆ¶ï¼‰ã€‚ ç”¨æ ¸ç®—æ³•ï¼š æ¯ä¸ªæ’å…¥æ“ä½œæˆ‘ä»¬æ”¶å–æ‘Šè¿˜è´¹ç”¨ Ã¢ = 2ï¼ˆå•ä½ä»£ä»·ï¼‰ã€‚ ä½¿ç”¨è§„åˆ™ï¼š 1å•ä½æ”¯ä»˜å½“å‰æ’å…¥æœ¬èº«ï¼ˆæ”¾æ–°å…ƒç´ ï¼‰ã€‚ 1å•ä½å­˜å…¥é“¶è¡Œï¼ˆä¸ºè¿™ä¸ªæ–°å…ƒç´ â€œé¢„å­˜â€æœªæ¥çš„å¤åˆ¶è´¹ç”¨ï¼‰ã€‚ å½“å‘ç”Ÿæ‰©å®¹ï¼ˆä»kåˆ°2kï¼‰æ—¶ï¼š éœ€è¦å¤åˆ¶kä¸ªæ—§å…ƒç´ ï¼Œæ¯ä¸ªæ—§å…ƒç´ åœ¨ä¹‹å‰æ’å…¥æ—¶å·²ç»ä¸ºå®ƒé¢„å­˜äº†1å•ä½ã€‚ æ€»å…±å¯ä»¥ä»é“¶è¡Œå–å‡º k å•ä½ã€‚ å®é™…æ‰©å®¹å¤åˆ¶ä»£ä»· â‰ˆ k å®¹æ˜“å½’çº³è¯æ˜ï¼šé“¶è¡Œä½™é¢å§‹ç»ˆ â‰¥ 0ï¼ˆå®é™…ä¸Šæ€»æ˜¯æ­£çš„ï¼‰ã€‚ å› æ­¤ï¼š æ¯ä¸ªæ’å…¥çš„æ‘Šè¿˜ä»£ä»· = 2 = O(1) næ¬¡æ’å…¥çš„æ€»æ‘Šè¿˜è´¹ç”¨ = 2n = O(n) æ€»å®é™…ä»£ä»· â‰¤ 2n = O(n)ï¼ˆä¸¥æ ¼ä¸Šç•Œï¼‰ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:13:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ ¸ç®—æ³•"},{"categories":null,"content":" åŠ¿èƒ½æ³•é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰çŠ¶æ€ S ä¸ºå½“å‰æŸä¸€æ•°æ®ç»“æ„çš„çŠ¶æ€ã€‚è¯¥çŠ¶æ€ååº”å‡ºè¯¥æ•°æ®ç»“æ„çš„å…ƒç´ å€¼ã€å…ƒç´ ä¸ªæ•°ç­‰ä¿¡æ¯ã€‚ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŠ¿èƒ½å‡½æ•° $\\Phi(S)$ï¼Œè¡¨ç¤ºå½“è¯¥æ•°æ®ç»“æ„å¤„äºçŠ¶æ€ S ä¸‹çš„åŠ¿èƒ½ã€‚å’Œç‰©ç†ä¸­çš„å®šä¹‰ç±»ä¼¼ï¼Œä½ éœ€è¦ä¿è¯ä½ å®šä¹‰çš„è¿™ä¸ªåŠ¿èƒ½æ¶µå‡½æ•°åœ¨åˆå§‹æ—¶å€¼ä¸º 0ï¼Œä¸”åœ¨ç®—æ³•æ‰§è¡Œçš„ä»»æ„è¿‡ç¨‹ä¸­å€¼éè´Ÿã€‚å¹¶ä¸”åŠ¿èƒ½çš„å˜åŒ–é‡åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ååº”å‡ºè¯¥å¯¹è±¡çš„å½¢æ€æ”¹å˜ç¨‹åº¦ã€‚ å¯¹äºæ¯ä¸ªæ“ä½œï¼Œæˆ‘ä»¬å®šä¹‰æ‘Šè¿˜ä»£ä»· $câ€™=c+\\Phi(Sâ€™)ä¸€\\Phi(S)$ã€‚å…¶ä¸­ï¼Œc è¡¨ç¤ºè¯¥æ“ä½œçš„å®é™…æˆæœ¬ï¼ŒSå’ŒSâ€™è¡¨ç¤ºè¯¥æ“ä½œå‰åæ•°æ®ç»“æ„çš„çŠ¶æ€ã€‚ç›´è§‚åœ°ï¼Œå‡æ‘Šæˆæœ¬ç­‰äºå®é™…æˆæœ¬åŠ ä¸ŠåŠ¿èƒ½å˜åŒ–é‡ã€‚ å¯¹äºåŠ¨æ€æ•°ç»„æ‰©å®¹çš„ä¾‹å­ï¼Œæˆ‘ä»¬å®šä¹‰åŠ¿èƒ½å‡½æ•°ä¸º $\\Phi(S)=2n-m$ï¼Œn æ˜¯åŠ¨æ€æ•°ç»„å®é™…é•¿åº¦ï¼Œm æ˜¯æ€»é•¿åº¦ã€‚è¿™ä¹ˆå®šä¹‰æ˜¯å› ä¸ºèƒ½ä¿è¯å¤§äº 0 ï¼Œå¹¶ä¸”æ’å…¥å…ƒç´ ä¼šå¯¼è‡´ n å’Œ m æ”¹å˜ç„¶ååŠ¿èƒ½å˜åŒ–ã€‚ å®é™…æˆæœ¬ åŠ¿èƒ½å˜åŒ–é‡ æ‘Šè¿˜ä»£ä»· ä¸è§¦å‘æ‰©å®¹ 1 $\\Phi(Sâ€™)-\\Phi(S)=2(n+1)-m-(2n-m)=2$ 1+2=3 è§¦å‘æ‰©å®¹ n+1 $\\Phi(Sâ€™)-\\Phi(S)=2(n+1)-2n-(2n-n)=2-n$ n+1+2-n=3 æ‘Šè¿˜ä»£ä»·éƒ½æ˜¯ 3 ä¹Ÿå°±æ˜¯ O(1) çš„æ—¶é—´ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:13:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#åŠ¿èƒ½æ³•"},{"categories":null,"content":" è¯¾åé¢˜ æ„Ÿè§‰ä¸ä¼šè€ƒï¼Œå…¨æ˜¯æ•°å­¦è¯æ˜ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:13:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-10"},{"categories":null,"content":" ç¬¬åä¹ç«  äºŒé¡¹å †","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:14:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬åä¹ç« -äºŒé¡¹å †"},{"categories":null,"content":" ä¸ºä»€ä¹ˆéœ€è¦äºŒé¡¹å †ä¼˜å…ˆé˜Ÿåˆ—é€šå¸¸æ˜¯ä½¿ç”¨äºŒå‰å †è¿™ä¸ªæ•°æ®ç»“æ„æ¥å®ç°ï¼Œåœ¨æŸäº›åº”ç”¨ä¸­ï¼Œåˆå¹¶ä¸¤ä¸ªä¼˜å…ˆé˜Ÿåˆ—æ˜¯æ ¸å¿ƒéœ€æ±‚ï¼Œè€ŒäºŒå‰å †çš„ Union æ“ä½œéœ€è¦æŠŠå¦ä¸€ä¸ªäºŒå‰å †çš„å…ƒç´ é€ä¸ªæ’å…¥ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦æ˜¯ $O(n\\lg n)$ã€‚äºŒå‰å †çš„ç›®çš„å°±æ˜¯ç»´æŒä¼˜å…ˆé˜Ÿåˆ—çš„æ€§è´¨ï¼Œå¹¶ä¸”é™ä½åˆå¹¶æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ã€‚ æ“ä½œ äºŒå‰å † äºŒé¡¹å † make-heap O(1) O(1) insert O(logn) O(logn) minimum O(1) O(logn) extract-min O(logn) O(logn) increase/decrease O(logn) O(logn) union O(nlogn) O(logn) å¯ä»¥çœ‹åˆ°äºŒé¡¹å †ç›¸å¯¹äºäºŒå‰å †ï¼Œåˆå¹¶æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸‹é™äº†ï¼Œä½†æ˜¯å–æœ€å€¼çš„æ—¶é—´å¤æ‚åº¦ä¸Šå‡äº†ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:14:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ä¸ºä»€ä¹ˆéœ€è¦äºŒé¡¹å †"},{"categories":null,"content":" å®šä¹‰å’Œå­˜å‚¨ç»“æ„å…ˆè¯´äºŒé¡¹æ ‘ï¼š å‡è®¾æ ‘é«˜ä¸º kï¼Œæœ‰ $2^k$ ä¸ªèŠ‚ç‚¹ ç¬¬ i å±‚æœ‰ $C_k^i$ ä¸ªèŠ‚ç‚¹ æ ¹çš„åº¦æœ€å¤§ä¸”ä¸º $C_k^1=k$ äºŒé¡¹æ ‘ $B_k$ æ˜¯æœ‰ä¸¤é¢— $B_{k-1}$ åˆå¹¶è€Œæˆï¼Œå°†ä¸€æ£µ $B_{k-1}$ çš„æ ¹ä½œä¸ºå¦ä¸€æ£µ $B_{k-1}$ æ ¹çš„æœ€å·¦å­©å­ã€‚ äºŒé¡¹å †æ˜¯æ»¡è¶³ä¸‹è¿°æ¡ä»¶çš„äºŒé¡¹æ ‘çš„é›†åˆï¼š H ä¸­çš„æ¯æ£µäºŒé¡¹æ ‘æ»¡è¶³æœ€å°å †æ€§è´¨ï¼ˆæ ¹å°äºä»»æ„å­èŠ‚ç‚¹ï¼‰ å¯¹ä»»æ„çš„éè´Ÿæ•´æ•° kï¼ŒH ä¸­è‡³å¤šæœ‰ä¸€æ£µäºŒé¡¹æ ‘æ ¹çš„åº¦ä¸º k äºŒé¡¹å †ä¸­çš„æ‰€æœ‰äºŒé¡¹æ ‘çš„æ ¹èŠ‚ç‚¹ç”±ä¸€ä¸ªå•é“¾è¡¨è¿æ¥ï¼ŒæŒ‰ç…§åº¦ï¼ˆæˆ–è€…è¯´äºŒé¡¹æ ‘é«˜åº¦ï¼‰å¢åºã€‚äºŒé¡¹æ ‘çš„èŠ‚ç‚¹å®šä¹‰å¦‚ä¸‹ï¼š python @dataclass class Node: p: Node # çˆ¶èŠ‚ç‚¹ key: int # å…³é”®å­— degree: int # åº¦ï¼šå­èŠ‚ç‚¹ä¸ªæ•°ï¼Œå°±æ˜¯C_k^i child: Node # å·¦å­©å­ sibling: Node # å³å…„å¼Ÿ å…ˆè¯´ä¸€ä¸‹ Minimum æ“ä½œï¼Œå‰é¢è¯´è¿‡â€œäºŒé¡¹å †ä¸­çš„æ‰€æœ‰äºŒé¡¹æ ‘çš„æ ¹èŠ‚ç‚¹ç”±ä¸€ä¸ªå•é“¾è¡¨è¿æ¥â€ï¼Œæ‰€ä»¥éœ€è¦ç”¨ä¸€ä¸ªçº¿æ€§æŸ¥æ‰¾ï¼Œéå†æ‰€æœ‰æ ¹èŠ‚ç‚¹ã€‚å‡è®¾äºŒé¡¹å †æ€»èŠ‚ç‚¹æ•°ä¸º nï¼Œæœ€å¤š âŒŠlogâ‚‚ nâŒ‹ + 1 æ£µæ ‘ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¸º $O(\\lg n)$ã€‚ äºŒé¡¹å †æ¯æ£µæ ‘éƒ½æ˜¯æŸä¸ª Bâ‚–ï¼Œä»»æ„ä¸¤æ£µæ ‘çš„ degree ä¸åŒï¼Œæ‰€ä»¥ 1+2+4+8+â€¦=nã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:14:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å®šä¹‰å’Œå­˜å‚¨ç»“æ„"},{"categories":null,"content":" åˆå¹¶æ“ä½œ æŠŠä¸¤ä¸ªäºŒé¡¹å †é“¾è¡¨åˆæˆä¸€ä¸ªé“¾è¡¨ï¼Œä»ç„¶æŒ‰ç…§åº¦æ’åºæ ¹èŠ‚ç‚¹ï¼Œå¤æ‚åº¦æ˜¯ $O(\\lg n)$ï¼ˆå› ä¸ºæ ¹èŠ‚ç‚¹æœ€å¤š âŒŠlogâ‚‚ nâŒ‹ + 1 ä¸ªï¼‰ å¯¹æ‰€æœ‰åº¦ç›¸åŒçš„äºŒé¡¹æ ‘è¿›è¡Œåˆå¹¶ï¼Œå‡è®¾å¾…åˆå¹¶çš„ä¸¤æ£µæ ‘ä¸º $B_{k-1}$ å°†å…³é”®å­—è¾ƒå¤§çš„æ ¹æŒ‚åˆ°å…³é”®å­—è¾ƒå°çš„æ ¹ä¸‹ï¼ˆç¬¬ä¸€ä¸ªå·¦å­©å­ï¼‰ï¼Œå¾—åˆ°ä¸€ä¸ª $B_k$ çš„æ–°äºŒé¡¹æ ‘ degree+1ï¼Œæ ‘é«˜ä¹Ÿ+1 æ¯æ¬¡äºŒé¡¹æ ‘åˆå¹¶æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œæœ€åæƒ…å†µæ¯æ£µæ ‘åº¦éƒ½ç›¸åŒï¼Œåˆå¹¶ $O(\\lg n)$ æ¬¡ï¼Œæ—¶é—´å¤æ‚åº¦ $O(\\lg n)$ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:14:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#åˆå¹¶æ“ä½œ"},{"categories":null,"content":" ç¬¬äºŒåä¸€ç«  ä¸ç›¸äº¤é›†æ•°æ®ç»“æ„","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:15:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬äºŒåä¸€ç« -ä¸ç›¸äº¤é›†æ•°æ®ç»“æ„"},{"categories":null,"content":" æ¦‚å¿µä¸ç›¸äº¤é›†ç”¨äºç»´æŠ¤ä¸€ç»„åŠ¨æ€å˜åŒ–çš„é›†åˆåˆ’åˆ†ï¼Œè¦æ±‚è¿™äº›é›†åˆä¸¤ä¸¤ä¸ç›¸äº¤ã€‚å…¶æ ¸å¿ƒç›®æ ‡ä¸æ˜¯å­˜å‚¨é›†åˆä¸­çš„å…ƒç´ å†…å®¹ï¼Œè€Œæ˜¯é«˜æ•ˆç»´æŠ¤â€œå…ƒç´ å±äºå“ªä¸ªé›†åˆâ€ä»¥åŠâ€œé›†åˆæ˜¯å¦éœ€è¦åˆå¹¶â€ã€‚ å½¢å¼åŒ–å®šä¹‰å¦‚ä¸‹ï¼šç»™å®šä¸€ä¸ªå…¨é›† $S = {xâ‚, xâ‚‚, â€¦, xâ‚™}$ï¼Œä¸ç›¸äº¤é›†ç»´æŠ¤çš„æ˜¯ S çš„ä¸€ä¸ªåˆ’åˆ† ${Sâ‚, Sâ‚‚, â€¦, Sâ‚–}$ï¼Œæ»¡è¶³ï¼š Sáµ¢ â‰  âˆ… Sáµ¢ âˆ© Sâ±¼ = âˆ…ï¼ˆi â‰  jï¼‰ â‹ƒ Sáµ¢ = S æ”¯æŒä¸‰ç§åŸºæœ¬æ“ä½œï¼š MAKE-SET(x)ï¼šåˆ›å»ºä¸€ä¸ªæ–°é›†åˆï¼Œä»…åŒ…å«å…ƒç´  xã€‚ FIND-SET(x)ï¼šè¿”å›åŒ…å« x çš„é›†åˆçš„ä¸€ä¸ªä»£è¡¨ï¼ˆrepresentativeï¼‰ã€‚ UNION(x, y)ï¼šå°†åŒ…å« x å’Œ y çš„ä¸¤ä¸ªé›†åˆåˆå¹¶ä¸ºä¸€ä¸ªé›†åˆã€‚ æ³¨æ„ find-set è¿”å›çš„ä¸æ˜¯é›†åˆï¼Œè€Œæ˜¯é›†åˆçš„ä»£è¡¨ FIND-SET(x) == FIND-SET(y) å¯ä»¥åˆ¤æ–­ä¸¤ä¸ªå…ƒç´ æ˜¯ä¸æ˜¯åœ¨åŒä¸€ä¸ªé›†åˆ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:15:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ¦‚å¿µ"},{"categories":null,"content":" å®ç°æ–¹æ³• é“¾è¡¨æ¯ä¸ªé›†åˆç”¨ä¸€ä¸ªé“¾è¡¨è¡¨ç¤ºï¼š é“¾è¡¨ä¸­å­˜å‚¨è¯¥é›†åˆçš„æ‰€æœ‰å…ƒç´ ï¼šhead â†’ a â†’ b â†’ c æ¯ä¸ªèŠ‚ç‚¹å­˜ä¸€ä¸ªæŒ‡å‘â€œé›†åˆå¤´èŠ‚ç‚¹â€çš„æŒ‡é’ˆï¼ša.head = b.head = c.head = head å¤´èŠ‚ç‚¹ä»£è¡¨è¯¥é›†åˆï¼ˆä½œä¸º representativeï¼‰ make-set(x)ï¼šåˆ›å»ºä¸€ä¸ªåªå« x çš„é“¾è¡¨ï¼ŒO(1) find-set(x)ï¼šè¿”å› x.headï¼ŒO(1) union(x, y)ï¼šæŠŠ y å»æ‰ head è¿åˆ° x å°¾éƒ¨ï¼ŒO(n) FIND éå¸¸å¿«ï¼Œä½†åˆå¹¶ä»£ä»·é«˜ æ£®æ—(å°±æ˜¯å¹¶æŸ¥é›†) make-set(x)ï¼šparent[x] = xï¼ŒO(1) find-set(x)ï¼šwhile x = parent[x]: return xï¼ŒO(logn)ï¼Œæ ‘é«˜ union(x, y)ï¼šroot_x = find_set(x), root_y = find_set(y), parent[root_y]=root_xï¼ŒO(logn)ï¼Œæ—¶é—´å¤æ‚åº¦å–å†³äº find-setï¼Œä¸æ§åˆ¶ä¼šé€€åŒ–ä¸ºé“¾è¡¨ é‡‡ç”¨è·¯å¾„å‹ç¼©åœ¨find_setæ—¶å€™æŠŠè·¯å¾„ä¸Šæ‰€æœ‰èŠ‚ç‚¹ç›´æ¥æŒ‡å‘æ ¹ï¼Œå¯ä»¥è®© find-set å’Œ union æ˜¯å¸¸æ•°æ—¶é—´ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:15:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å®ç°æ–¹æ³•"},{"categories":null,"content":" å®ç°æ–¹æ³• é“¾è¡¨æ¯ä¸ªé›†åˆç”¨ä¸€ä¸ªé“¾è¡¨è¡¨ç¤ºï¼š é“¾è¡¨ä¸­å­˜å‚¨è¯¥é›†åˆçš„æ‰€æœ‰å…ƒç´ ï¼šhead â†’ a â†’ b â†’ c æ¯ä¸ªèŠ‚ç‚¹å­˜ä¸€ä¸ªæŒ‡å‘â€œé›†åˆå¤´èŠ‚ç‚¹â€çš„æŒ‡é’ˆï¼ša.head = b.head = c.head = head å¤´èŠ‚ç‚¹ä»£è¡¨è¯¥é›†åˆï¼ˆä½œä¸º representativeï¼‰ make-set(x)ï¼šåˆ›å»ºä¸€ä¸ªåªå« x çš„é“¾è¡¨ï¼ŒO(1) find-set(x)ï¼šè¿”å› x.headï¼ŒO(1) union(x, y)ï¼šæŠŠ y å»æ‰ head è¿åˆ° x å°¾éƒ¨ï¼ŒO(n) FIND éå¸¸å¿«ï¼Œä½†åˆå¹¶ä»£ä»·é«˜ æ£®æ—(å°±æ˜¯å¹¶æŸ¥é›†) make-set(x)ï¼šparent[x] = xï¼ŒO(1) find-set(x)ï¼šwhile x = parent[x]: return xï¼ŒO(logn)ï¼Œæ ‘é«˜ union(x, y)ï¼šroot_x = find_set(x), root_y = find_set(y), parent[root_y]=root_xï¼ŒO(logn)ï¼Œæ—¶é—´å¤æ‚åº¦å–å†³äº find-setï¼Œä¸æ§åˆ¶ä¼šé€€åŒ–ä¸ºé“¾è¡¨ é‡‡ç”¨è·¯å¾„å‹ç¼©åœ¨find_setæ—¶å€™æŠŠè·¯å¾„ä¸Šæ‰€æœ‰èŠ‚ç‚¹ç›´æ¥æŒ‡å‘æ ¹ï¼Œå¯ä»¥è®© find-set å’Œ union æ˜¯å¸¸æ•°æ—¶é—´ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:15:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#é“¾è¡¨"},{"categories":null,"content":" å®ç°æ–¹æ³• é“¾è¡¨æ¯ä¸ªé›†åˆç”¨ä¸€ä¸ªé“¾è¡¨è¡¨ç¤ºï¼š é“¾è¡¨ä¸­å­˜å‚¨è¯¥é›†åˆçš„æ‰€æœ‰å…ƒç´ ï¼šhead â†’ a â†’ b â†’ c æ¯ä¸ªèŠ‚ç‚¹å­˜ä¸€ä¸ªæŒ‡å‘â€œé›†åˆå¤´èŠ‚ç‚¹â€çš„æŒ‡é’ˆï¼ša.head = b.head = c.head = head å¤´èŠ‚ç‚¹ä»£è¡¨è¯¥é›†åˆï¼ˆä½œä¸º representativeï¼‰ make-set(x)ï¼šåˆ›å»ºä¸€ä¸ªåªå« x çš„é“¾è¡¨ï¼ŒO(1) find-set(x)ï¼šè¿”å› x.headï¼ŒO(1) union(x, y)ï¼šæŠŠ y å»æ‰ head è¿åˆ° x å°¾éƒ¨ï¼ŒO(n) FIND éå¸¸å¿«ï¼Œä½†åˆå¹¶ä»£ä»·é«˜ æ£®æ—(å°±æ˜¯å¹¶æŸ¥é›†) make-set(x)ï¼šparent[x] = xï¼ŒO(1) find-set(x)ï¼šwhile x = parent[x]: return xï¼ŒO(logn)ï¼Œæ ‘é«˜ union(x, y)ï¼šroot_x = find_set(x), root_y = find_set(y), parent[root_y]=root_xï¼ŒO(logn)ï¼Œæ—¶é—´å¤æ‚åº¦å–å†³äº find-setï¼Œä¸æ§åˆ¶ä¼šé€€åŒ–ä¸ºé“¾è¡¨ é‡‡ç”¨è·¯å¾„å‹ç¼©åœ¨find_setæ—¶å€™æŠŠè·¯å¾„ä¸Šæ‰€æœ‰èŠ‚ç‚¹ç›´æ¥æŒ‡å‘æ ¹ï¼Œå¯ä»¥è®© find-set å’Œ union æ˜¯å¸¸æ•°æ—¶é—´ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:15:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ£®æ—å°±æ˜¯å¹¶æŸ¥é›†"},{"categories":null,"content":" åº”ç”¨ kruskalï¼šç”¨å¹¶æŸ¥é›†åˆ¤æ–­ u å’Œ væ˜¯å¦è¿é€šï¼Œä¸è¿é€šåˆ™é€‰æ‹©è¯¥è¾¹ æ— å‘å›¾è¿é€šåˆ†é‡ï¼šå¯¹æ¯æ¡è¾¹çš„ä¸¤ä¸ªèŠ‚ç‚¹ u å’Œ v è¿›è¡Œ unionï¼Œæœ€åå‡ ä¸ªæ ¹èŠ‚ç‚¹å°±æ˜¯å‡ ä¸ªè¿é€šåˆ†é‡ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:15:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#åº”ç”¨"},{"categories":null,"content":" è¯¾åé¢˜ å…ˆæ‰¾åˆ°æ ¹ï¼Œç„¶åè‡ªåº•å‘ä¸Šæ›´æ–°å…¨éƒ¨ parent ä¸ºæ ¹ã€‚ python def find_set(T, x): root = x while T[root] != root: root = T[root] while x != root: p = T[x] T[x] = root x = p return root ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:15:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯¾åé¢˜-11"},{"categories":null,"content":" ç¬¬äºŒåäºŒç«  å›¾è®ºç®—æ³•","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:16:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬äºŒåäºŒç« -å›¾è®ºç®—æ³•"},{"categories":null,"content":" DFS å’Œ BFS ç™½è‰²èŠ‚ç‚¹æ˜¯æœªè®¿é—®è¿‡çš„èŠ‚ç‚¹ ç°è‰²èŠ‚ç‚¹æ˜¯å·²è®¿é—®ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æœç´¢å‘¨å›´èŠ‚ç‚¹çš„èŠ‚ç‚¹ é»‘è‰²èŠ‚ç‚¹è¡¨ç¤ºè¯¥ç»“ç‚¹çš„æ‰€æœ‰é‚»æ¥ç»“ç‚¹å‡å·²è¢«æ£€æŸ¥å®Œæ¯• é¢œè‰²æœºåˆ¶çš„æœ¬è´¨ä½œç”¨æ˜¯ä¿è¯ æ¯ä¸ªç»“ç‚¹æœ€å¤šè¢«å‘ç°ä¸€æ¬¡ï¼Œç”¨ visited æ•°ç»„ä¸€æ ·æ•ˆæœ é‚»æ¥è¡¨ é‚»æ¥çŸ©é˜µ DFS O(V+E) O(V^2) BFS O(V+E) O(V^2) ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:16:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#dfs-å’Œ-bfs"},{"categories":null,"content":" æœ€å°ç”Ÿæˆæ ‘å®‰å…¨è¾¹ï¼šå‡è®¾ A æ˜¯æœ€å°ç”Ÿæˆæ ‘çš„ä¸€ä¸ªå­é›†ï¼Œå‡å¦‚æŠŠä¸€æ¡è¾¹åŠ å…¥ A åå®ƒä»ç„¶æ˜¯æœ€å°ç”Ÿæˆæ ‘çš„å­é›†ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å®‰å…¨è¾¹ã€‚ æœ€å°ç”Ÿæˆæ ‘çš„ç®—æ³•å°±æ˜¯ä¸æ–­æ‰¾åˆ°ä¸€æ¡å®‰å…¨è¾¹ï¼ŒæŠŠå®ƒåŠ å…¥é›†åˆä¸­ã€‚æœ€ç»ˆé›†åˆåŒ…å«æ‰€æœ‰è¾¹ï¼Œé‚£ä¹ˆä»–å°±æ˜¯æœ€å°ç”Ÿæˆæ ‘ã€‚ Primï¼š åŠ ç‚¹æ³•ï¼šç„¶å S æ˜¯å·²é€‰æ‹©ç‚¹çš„é›†å’Œï¼Œé‚£ä¹ˆä¸æ–­æŒ‘é€‰ç¦» S æœ€è¿‘çš„ç‚¹åŠ å…¥ï¼Œè¿ä¸Šé‚£æ¡è¾¹ æ•°ç»„è¡¨ç¤ºçš„è¯O(V^2)ï¼Œç”¨æœ€å°ä¼˜å…ˆé˜Ÿåˆ—(äºŒå‰å †)æ˜¯O(ElogV)ã€‚äºŒå‰å † Extract-minimum æ—¶é—´å¤æ‚åº¦æ˜¯ logVï¼Œæ€»å¼€é”€ VlogVã€‚ä½†æ˜¯æ¯æ¬¡åŠ ç‚¹ä¹‹åï¼Œéœ€è¦æ›´æ–°å…¶ä»–ç‚¹ç¦» S çš„æœ€è¿‘è·ç¦»ï¼Œä¹Ÿå°±æ˜¯äºŒå‰å †çš„ decrease-key æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(logV)ï¼Œæœ€åæƒ…å†µæ˜¯ E æ¬¡ï¼Œæ‰€ä»¥ O(ElogV)ã€‚ Kruskalï¼š åŠ è¾¹æ³•ï¼šä¸æ–­é€‰æ‹©æƒå€¼æœ€å°å¹¶ä¸”ä¸å½¢æˆè¿é€šåˆ†é‡çš„è¾¹ æ—¶é—´å¤æ‚åº¦O(ElogV)ï¼Œé¦–å…ˆç»™è¾¹æ’åºçš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(E\\lg E)=O(E\\lg V)$ï¼Œç„¶åä¸€å…± E æ¬¡å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯æœ€å¤šéœ€è¦ 2 æ¬¡ find 1æ¬¡ unionï¼Œå¦‚æœç»è¿‡è·¯å¾„å‹ç¼©ï¼Œé‚£ä¹ˆæ‘Šè¿˜ä»£ä»·æ˜¯ $\\alpha(V)$ ï¼Œæ‰€ä»¥æ€»æ—¶é—´å¤æ‚åº¦ $O(E*\\alpha(V))=O(E)$ï¼Œæ’åºå ä¸»å¯¼æ‰€ä»¥æ˜¯ O(ElgV) ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:16:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æœ€å°ç”Ÿæˆæ ‘"},{"categories":null,"content":" å•æºæœ€çŸ­è·¯Î´(s, v) ä¸ d[v] æ˜¯ä»€ä¹ˆï¼Ÿ Î´(s, v)ï¼šä»æºç‚¹ s åˆ° v çš„çœŸå®æœ€çŸ­è·¯å¾„é•¿åº¦ï¼ˆç†è®ºå€¼ï¼‰ï¼› d[v]ï¼šç®—æ³•è¿è¡Œè¿‡ç¨‹ä¸­ç»´æŠ¤çš„ä¸Šç•Œä¼°è®¡ï¼Œå§‹ç»ˆæ»¡è¶³ d[v] â‰¥ Î´(s, v)ã€‚ è¾¹æ¾å¼›ï¼š è‹¥ d[v] \u003e d[u] + w(u, v)ï¼š d[v] = d[u] + w(u, v) Ï€[v] = u Bellman-Ford ç®—æ³•ï¼š è®¾ç½® dis[èµ·ç‚¹]=0ï¼Œdis[å…¶ä»–ç‚¹]=inf è¿›è¡Œ v-1 è½®éå† éå†æ¯ä¸€æ¡è¾¹ \u003cu,v \u003eï¼Œå¯¹ dis[v] è¿›è¡Œæ›´æ–°ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½ dis[v] = dis[u]+w[u,v] æ¾å¼› æœ€åéå†ä¸€è½®ï¼Œå¦‚æœè¿˜æœ‰æ›´æ–°ï¼Œè¯´æ˜ä¸èƒ½æ”¶æ•›ï¼Œæœ‰è´Ÿæƒç¯ï¼Œreturn Falseã€‚ æ—¶é—´å¤æ‚åº¦ O(EV) å¯ä»¥ç”¨äºè´Ÿæƒå›¾ï¼Œä¸èƒ½è´Ÿæƒå›è·¯ Dijkstra ç®—æ³•ï¼š è®¾ç½® dis[èµ·ç‚¹]=0ï¼Œå…¶ä»–ä¸ºinf æ›´æ–°èµ·ç‚¹ç›¸è¿èŠ‚ç‚¹çš„dis æŒ‰ç…§disï¼Œéå†æœªè®¿é—®çš„æ‰€æœ‰èŠ‚ç‚¹ å°†èŠ‚ç‚¹è®¾ä¸º visited æ›´æ–°è¿™ä¸ªèŠ‚ç‚¹ç›¸è¿èŠ‚ç‚¹çš„dis å’Œ prim ç®—æ³•ä¸€æ ·ï¼Œæ—¶é—´å¼€é”€å—é™äºäºŒå‰å †çš„ decrease-key æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(logV)ï¼Œæœ€åæƒ…å†µæ˜¯ E æ¬¡ï¼Œæ‰€ä»¥ O(ElogV)ã€‚ å¦‚æœç”¨æ–æ³¢é‚£å¥‘å †è¿›è¡Œä¼˜åŒ–ï¼ˆäºŒå‰å †ä¼˜åŒ–ï¼‰ï¼Œé‚£ä¹ˆå¼€é”€æ˜¯ O(VlogV+E)ã€‚ ç”¨äºéè´Ÿæƒã€æœ‰å‘å›¾ï¼Œå¯ä»¥æœ‰ç¯ ä¸ºä»€ä¹ˆä¸æ˜¯$O(V*(\\lg V + E))$ å‘¢ï¼Ÿ è¿™ä¸ªå¼å­éšå«ç”¨äº†è¿™æ ·ä¸€ä¸ªå‡è®¾ï¼šæ¯ä¸€è½® Extract-Min ä¹‹åï¼Œæœ€å¤šä¼šå‘ç”Ÿ EEE æ¬¡ Decrease-Key è¿™æ˜¯ä¸æˆç«‹çš„ã€‚å› ä¸º æ¯æ¡è¾¹åªåœ¨å…¶èµ·ç‚¹è¢« Extract-Min æ—¶è¢«æ‰«æä¸€æ¬¡ï¼Œæ‰€ä»¥å†…å±‚å¾ªç¯ æ‰€æœ‰è½®æ¬¡åŠ èµ·æ¥ï¼Œæ€»å…±åªè·‘ E æ¬¡ã€‚ DAG ç®—æ³• åªèƒ½æœ‰å‘æ— ç¯å›¾ -\u003e è¿™æ ·æ‰ä¿è¯å­˜åœ¨æ‹“æ‰‘æ’åºï¼Œæ‹“æ‰‘æ’åºä¿è¯åœ¨å¤„ç† u ä¹‹å‰ï¼Œæ‰€æœ‰å¯èƒ½åˆ°è¾¾ u çš„å‰é©±é¡¶ç‚¹ x çš„æœ€çŸ­è·¯å¾„éƒ½å·²ç»è¢«æ­£ç¡®è®¡ç®— å…ˆè¿›è¡Œä¸€æ¬¡æ‹“æ‰‘æ’åº æŒ‰æ‹“æ‰‘æ’åºæ‰«æé¡¶ç‚¹ï¼Œå¯¹æ¯ä¸ªé¡¶ç‚¹ uï¼š å¯¹æ¯æ¡å‡ºè¾¹ (u, v) è¿›è¡Œæ¾å¼› æ—¶é—´å¤æ‚åº¦ O(E+V)ï¼Œå—é™äºæ‹“æ‰‘æ’åºå¼€é”€ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:16:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å•æºæœ€çŸ­è·¯"},{"categories":null,"content":" å¤šæºæœ€çŸ­è·¯floyd çš„æ€è·¯å°±æ˜¯ä¾æ¬¡å¢åŠ ä¸­è½¬é¡¶ç‚¹ï¼Œçœ‹ i å’Œ j ä¹‹é—´çš„è·ç¦»èƒ½ä¸èƒ½é€šè¿‡ä¸­è½¬é¡¶ç‚¹ç¼©å‡ã€‚ python def floyd(): for k in range(V): for i in range(V): for j in range(V): new_dis = dis[i][k] + dis[k][j] if (new_dis \u003c dis[i][j]): dis[i][j] = new_dis path[i][j] = path[k][j] path[i][j] è¡¨ç¤ºï¼šâ€œåœ¨ä» i åˆ° j çš„æœ€çŸ­è·¯å¾„ä¸Šï¼Œj çš„å‰ä¸€ä¸ªé¡¶ç‚¹æ˜¯è°â€ å¦‚æœ d[i][j] \u003e d[i][k] + d[k][j] ï¼Œè¯´æ˜ i â†’ â€¦ â†’ k â†’ â€¦ â†’ jã€‚æ‰€ä»¥ j ä¹‹å‰ä¸€ä¸ªé¡¶ç‚¹åº”è¯¥æ˜¯ d[k][j] æ‰¾ i - j è·¯å¾„çš„æ–¹æ³•å°±æ˜¯ï¼Œä¸æ–­é€’å½’æ‰¾ d[i][j]=k ç„¶åæ‰¾ d[i][k] æ—¶é—´å¼€é”€ $O(V^3)$ï¼Œé€‚åˆç¨ å¯†å›¾ã€‚ Johnson ç®—æ³• é‚£ä¹ˆå¯¹æ¯ä¸ªèŠ‚ç‚¹è¿›è¡Œ Dijsktraï¼Œç”¨æ–æ³¢é‚£å¥‘å †å¼€é”€æ˜¯ O(VlogV+E)ï¼Œæ€»æ—¶é—´O(V^2logV+VE)ã€‚å¦‚æœç”¨äºŒå‰å †æ˜¯O(VElogv) ä½†æ˜¯ Dijsktra åªèƒ½ç”¨äºéè´Ÿæƒå›¾ï¼Œæ‰€ä»¥éœ€è¦ç”¨ bellman-ford è®¡ç®—ä¸€ä¸ªåŠ¿èƒ½å‡½æ•°ï¼Œå¾—åˆ°æ–°çš„æƒå€¼ï¼Œä»£æ›¿åŸå…ˆå¯èƒ½ä¸ºè´Ÿæ•°çš„æƒå€¼ å‡å¦‚ä¸€ä¸ªæ–°èŠ‚ç‚¹sï¼Œå¯¹å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹çš„dis=0 ç„¶å bellman-ford å¾—åˆ° s å¯¹å…¶ä»–èŠ‚ç‚¹ v çš„è·ç¦»ï¼Œä½œä¸º h(v) ç„¶åæ¯æ¡è¾¹ \u003cu,v\u003e æ–°çš„æƒé‡å°±æ˜¯ w[u,v] +h(u)-h(v) é€‚ç”¨äºç¨€ç–å›¾ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:16:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å¤šæºæœ€çŸ­è·¯"},{"categories":null,"content":" ç¬¬ä¸‰åä¸€ç«  æ•°è®ºç®—æ³•","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬ä¸‰åä¸€ç« -æ•°è®ºç®—æ³•"},{"categories":null,"content":" æœ€å¤§å…¬çº¦æ•° æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def gcd(a, b): if b == 0: return a else: return gcd(b, a % b) æ—¶é—´å¤æ‚åº¦ä¸ºï¼šO(log(min(a, b)))Â æˆ–Â O(log(max(a, b))) è¯æ˜æˆ‘ä»¬é¦–å…ˆå‡è®¾æœ‰ä¸¤ä¸ªæ•° $a$ å’Œ $b$ï¼Œå…¶ä¸­ $a$ æ˜¯ä¸å°äº $b$ çš„æ•°ï¼Œè®° $a$ è¢« $b$ é™¤çš„ä½™æ•°ä¸º $r$ï¼Œé‚£ä¹ˆ $a$ å¯ä»¥å†™æˆè¿™æ ·çš„å½¢å¼ï¼š a=bq+r a = bq + r a=bq+rå…¶ä¸­ $q$ æ˜¯æ•´æ•°ã€‚ç°åœ¨å‡è®¾ $a$ å’Œ $b$ çš„ä¸€ä¸ªçº¦æ•°ä¸º $u$ï¼Œé‚£ä¹ˆ $a$ å’Œ $b$ éƒ½èƒ½è¢« $u$ æ•´é™¤ï¼Œå³ a=sub=tu \\begin{align} a\u0026=su\\\\ b\u0026=tu \\end{align} abâ€‹=su=tuâ€‹â€‹$s$ å’Œ $t$ éƒ½æ˜¯æ•´æ•°ã€‚è¿™æ ·å¯ä»¥å¾—å‡ºï¼š r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)u r = a - bq = su - (tu)q = (s - tq)u r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)uæ‰€ä»¥ $r$ ä¹Ÿèƒ½è¢« $u$ æ•´é™¤ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°ä¸€èˆ¬è§„å¾‹å¦‚ä¸‹ï¼š $a$ å’Œ $b$ çš„çº¦æ•°ä¹Ÿæ•´é™¤å®ƒä»¬çš„ä½™æ•° $r$ï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $b$ å’Œ $r$ çš„çº¦æ•°ã€‚ åè¿‡æ¥å¯ä»¥å¾—å‡ºï¼š $b$ å’Œ $r$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $a$ å’Œ $b$ çš„çº¦æ•°ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å‡ºï¼š$a$ å’Œ $b$ çš„çº¦æ•°çš„é›†åˆï¼Œå…¨ç­‰äº $b$ å’Œ $r$ çš„çº¦æ•°çš„é›†åˆï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„æœ€å¤§å…¬çº¦æ•°ï¼Œå°±æ˜¯ $b$ å’Œ $r$ çš„æœ€å¤§å…¬çº¦æ•°ã€‚ gcd(a,b)=gcd(b,r) \\text{gcd}(a,b) = \\text{gcd}(b, r) gcd(a,b)=gcd(b,r)æ ¹æ®é€’æ¨æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­å‡å° $b$ ä½¿å¾—å…¬å¼å˜ä¸º $gcd(x,0)$ï¼Œç»“æœå°±æ˜¯ xã€‚ æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def extended_gcd(a, b): if b == 0: return a, 1, 0 gcd, x1, y1 = extended_gcd(b, a % b) x = y1 y = x1 - (a / b) * y1 return gcd, x, y è¯æ˜æ¬§å‡ é‡Œå¾—ç®—æ³•äº§ç”Ÿå¦‚ä¸‹é™¤æ³•åºåˆ—ï¼š $a = qâ‚ b + râ‚ (0 â‰¤ râ‚ \u003c b)$ $b = qâ‚‚ râ‚ + râ‚‚ (0 â‰¤ râ‚‚ \u003c râ‚)$ $râ‚ = qâ‚ƒ râ‚‚ + râ‚ƒ (0 â‰¤ râ‚ƒ \u003c râ‚‚)$ â€¦ $r_{k-2} = q_k r_{k-1} + r_k$ $r_{k-1} = q_{k+1} r_k + 0$ åˆ™ $gcd(a, b) = r_k$ æœ€åä¸€ä¸ªéé›¶ä½™æ•°ã€‚ç°åœ¨ä»åå¾€å‰å›ä»£ï¼Œè¯æ˜ $r_k$ å¯ä»¥è¡¨ç¤ºä¸º $a$ å’Œ $b$ çš„çº¿æ€§ç»„åˆã€‚ ä»å€’æ•°ç¬¬äºŒæ­¥ï¼š $r_k = r_{k-2} - q_k r_{k-1}$ ï¼ˆè¿™æ˜¯ $r_{k-2}$ å’Œ $r_{k-1}$ çš„çº¿æ€§ç»„åˆï¼‰ å°† $r_{k-1}$ ä»£å…¥ä¸Šä¸€å¼ï¼š $r_{k-1} = r_{k-3} - q_{k-1} r_{k-2}$ â†’ $r_k = r_{k-2} - q_k (r_{k-3} - q_{k-1} r_{k-2}) = (1 + q_k q_{k-1}) r_{k-2} - q_k r_{k-3}$ ç»§ç»­å›ä»£ï¼Œæœ€ç»ˆæ‰€æœ‰ä½™æ•°éƒ½ä¼šè¢«è¡¨è¾¾ä¸ºæ›´æ—©çš„ä½™æ•°ï¼Œç›´è‡³ï¼š $râ‚$ ç”¨ $a$ å’Œ $b$ è¡¨ç¤ºï¼š$râ‚ = a - qâ‚ b$ $b$ ç”¨ $b$ è¡¨ç¤ºï¼ˆè‡ªèº«ï¼‰ æœ€ç»ˆï¼Œ$r_k$ï¼ˆå³ gcdï¼‰å°†è¢«è¡¨è¾¾ä¸º $a$ å’Œ $b$ çš„æ•´æ•°ç³»æ•°çº¿æ€§ç»„åˆï¼š gcd(a, b) = r_k = a x + b y ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æœ€å¤§å…¬çº¦æ•°"},{"categories":null,"content":" æœ€å¤§å…¬çº¦æ•° æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def gcd(a, b): if b == 0: return a else: return gcd(b, a % b) æ—¶é—´å¤æ‚åº¦ä¸ºï¼šO(log(min(a, b)))Â æˆ–Â O(log(max(a, b))) è¯æ˜æˆ‘ä»¬é¦–å…ˆå‡è®¾æœ‰ä¸¤ä¸ªæ•° $a$ å’Œ $b$ï¼Œå…¶ä¸­ $a$ æ˜¯ä¸å°äº $b$ çš„æ•°ï¼Œè®° $a$ è¢« $b$ é™¤çš„ä½™æ•°ä¸º $r$ï¼Œé‚£ä¹ˆ $a$ å¯ä»¥å†™æˆè¿™æ ·çš„å½¢å¼ï¼š a=bq+r a = bq + r a=bq+rå…¶ä¸­ $q$ æ˜¯æ•´æ•°ã€‚ç°åœ¨å‡è®¾ $a$ å’Œ $b$ çš„ä¸€ä¸ªçº¦æ•°ä¸º $u$ï¼Œé‚£ä¹ˆ $a$ å’Œ $b$ éƒ½èƒ½è¢« $u$ æ•´é™¤ï¼Œå³ a=sub=tu \\begin{align} a\u0026=su\\\\ b\u0026=tu \\end{align} abâ€‹=su=tuâ€‹â€‹$s$ å’Œ $t$ éƒ½æ˜¯æ•´æ•°ã€‚è¿™æ ·å¯ä»¥å¾—å‡ºï¼š r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)u r = a - bq = su - (tu)q = (s - tq)u r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)uæ‰€ä»¥ $r$ ä¹Ÿèƒ½è¢« $u$ æ•´é™¤ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°ä¸€èˆ¬è§„å¾‹å¦‚ä¸‹ï¼š $a$ å’Œ $b$ çš„çº¦æ•°ä¹Ÿæ•´é™¤å®ƒä»¬çš„ä½™æ•° $r$ï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $b$ å’Œ $r$ çš„çº¦æ•°ã€‚ åè¿‡æ¥å¯ä»¥å¾—å‡ºï¼š $b$ å’Œ $r$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $a$ å’Œ $b$ çš„çº¦æ•°ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å‡ºï¼š$a$ å’Œ $b$ çš„çº¦æ•°çš„é›†åˆï¼Œå…¨ç­‰äº $b$ å’Œ $r$ çš„çº¦æ•°çš„é›†åˆï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„æœ€å¤§å…¬çº¦æ•°ï¼Œå°±æ˜¯ $b$ å’Œ $r$ çš„æœ€å¤§å…¬çº¦æ•°ã€‚ gcd(a,b)=gcd(b,r) \\text{gcd}(a,b) = \\text{gcd}(b, r) gcd(a,b)=gcd(b,r)æ ¹æ®é€’æ¨æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­å‡å° $b$ ä½¿å¾—å…¬å¼å˜ä¸º $gcd(x,0)$ï¼Œç»“æœå°±æ˜¯ xã€‚ æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def extended_gcd(a, b): if b == 0: return a, 1, 0 gcd, x1, y1 = extended_gcd(b, a % b) x = y1 y = x1 - (a / b) * y1 return gcd, x, y è¯æ˜æ¬§å‡ é‡Œå¾—ç®—æ³•äº§ç”Ÿå¦‚ä¸‹é™¤æ³•åºåˆ—ï¼š $a = qâ‚ b + râ‚ (0 â‰¤ râ‚ \u003c b)$ $b = qâ‚‚ râ‚ + râ‚‚ (0 â‰¤ râ‚‚ \u003c râ‚)$ $râ‚ = qâ‚ƒ râ‚‚ + râ‚ƒ (0 â‰¤ râ‚ƒ \u003c râ‚‚)$ â€¦ $r_{k-2} = q_k r_{k-1} + r_k$ $r_{k-1} = q_{k+1} r_k + 0$ åˆ™ $gcd(a, b) = r_k$ æœ€åä¸€ä¸ªéé›¶ä½™æ•°ã€‚ç°åœ¨ä»åå¾€å‰å›ä»£ï¼Œè¯æ˜ $r_k$ å¯ä»¥è¡¨ç¤ºä¸º $a$ å’Œ $b$ çš„çº¿æ€§ç»„åˆã€‚ ä»å€’æ•°ç¬¬äºŒæ­¥ï¼š $r_k = r_{k-2} - q_k r_{k-1}$ ï¼ˆè¿™æ˜¯ $r_{k-2}$ å’Œ $r_{k-1}$ çš„çº¿æ€§ç»„åˆï¼‰ å°† $r_{k-1}$ ä»£å…¥ä¸Šä¸€å¼ï¼š $r_{k-1} = r_{k-3} - q_{k-1} r_{k-2}$ â†’ $r_k = r_{k-2} - q_k (r_{k-3} - q_{k-1} r_{k-2}) = (1 + q_k q_{k-1}) r_{k-2} - q_k r_{k-3}$ ç»§ç»­å›ä»£ï¼Œæœ€ç»ˆæ‰€æœ‰ä½™æ•°éƒ½ä¼šè¢«è¡¨è¾¾ä¸ºæ›´æ—©çš„ä½™æ•°ï¼Œç›´è‡³ï¼š $râ‚$ ç”¨ $a$ å’Œ $b$ è¡¨ç¤ºï¼š$râ‚ = a - qâ‚ b$ $b$ ç”¨ $b$ è¡¨ç¤ºï¼ˆè‡ªèº«ï¼‰ æœ€ç»ˆï¼Œ$r_k$ï¼ˆå³ gcdï¼‰å°†è¢«è¡¨è¾¾ä¸º $a$ å’Œ $b$ çš„æ•´æ•°ç³»æ•°çº¿æ€§ç»„åˆï¼š gcd(a, b) = r_k = a x + b y ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ¬§å‡ é‡Œå¾—ç®—æ³•"},{"categories":null,"content":" æœ€å¤§å…¬çº¦æ•° æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def gcd(a, b): if b == 0: return a else: return gcd(b, a % b) æ—¶é—´å¤æ‚åº¦ä¸ºï¼šO(log(min(a, b)))Â æˆ–Â O(log(max(a, b))) è¯æ˜æˆ‘ä»¬é¦–å…ˆå‡è®¾æœ‰ä¸¤ä¸ªæ•° $a$ å’Œ $b$ï¼Œå…¶ä¸­ $a$ æ˜¯ä¸å°äº $b$ çš„æ•°ï¼Œè®° $a$ è¢« $b$ é™¤çš„ä½™æ•°ä¸º $r$ï¼Œé‚£ä¹ˆ $a$ å¯ä»¥å†™æˆè¿™æ ·çš„å½¢å¼ï¼š a=bq+r a = bq + r a=bq+rå…¶ä¸­ $q$ æ˜¯æ•´æ•°ã€‚ç°åœ¨å‡è®¾ $a$ å’Œ $b$ çš„ä¸€ä¸ªçº¦æ•°ä¸º $u$ï¼Œé‚£ä¹ˆ $a$ å’Œ $b$ éƒ½èƒ½è¢« $u$ æ•´é™¤ï¼Œå³ a=sub=tu \\begin{align} a\u0026=su\\\\ b\u0026=tu \\end{align} abâ€‹=su=tuâ€‹â€‹$s$ å’Œ $t$ éƒ½æ˜¯æ•´æ•°ã€‚è¿™æ ·å¯ä»¥å¾—å‡ºï¼š r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)u r = a - bq = su - (tu)q = (s - tq)u r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)uæ‰€ä»¥ $r$ ä¹Ÿèƒ½è¢« $u$ æ•´é™¤ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°ä¸€èˆ¬è§„å¾‹å¦‚ä¸‹ï¼š $a$ å’Œ $b$ çš„çº¦æ•°ä¹Ÿæ•´é™¤å®ƒä»¬çš„ä½™æ•° $r$ï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $b$ å’Œ $r$ çš„çº¦æ•°ã€‚ åè¿‡æ¥å¯ä»¥å¾—å‡ºï¼š $b$ å’Œ $r$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $a$ å’Œ $b$ çš„çº¦æ•°ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å‡ºï¼š$a$ å’Œ $b$ çš„çº¦æ•°çš„é›†åˆï¼Œå…¨ç­‰äº $b$ å’Œ $r$ çš„çº¦æ•°çš„é›†åˆï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„æœ€å¤§å…¬çº¦æ•°ï¼Œå°±æ˜¯ $b$ å’Œ $r$ çš„æœ€å¤§å…¬çº¦æ•°ã€‚ gcd(a,b)=gcd(b,r) \\text{gcd}(a,b) = \\text{gcd}(b, r) gcd(a,b)=gcd(b,r)æ ¹æ®é€’æ¨æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­å‡å° $b$ ä½¿å¾—å…¬å¼å˜ä¸º $gcd(x,0)$ï¼Œç»“æœå°±æ˜¯ xã€‚ æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def extended_gcd(a, b): if b == 0: return a, 1, 0 gcd, x1, y1 = extended_gcd(b, a % b) x = y1 y = x1 - (a / b) * y1 return gcd, x, y è¯æ˜æ¬§å‡ é‡Œå¾—ç®—æ³•äº§ç”Ÿå¦‚ä¸‹é™¤æ³•åºåˆ—ï¼š $a = qâ‚ b + râ‚ (0 â‰¤ râ‚ \u003c b)$ $b = qâ‚‚ râ‚ + râ‚‚ (0 â‰¤ râ‚‚ \u003c râ‚)$ $râ‚ = qâ‚ƒ râ‚‚ + râ‚ƒ (0 â‰¤ râ‚ƒ \u003c râ‚‚)$ â€¦ $r_{k-2} = q_k r_{k-1} + r_k$ $r_{k-1} = q_{k+1} r_k + 0$ åˆ™ $gcd(a, b) = r_k$ æœ€åä¸€ä¸ªéé›¶ä½™æ•°ã€‚ç°åœ¨ä»åå¾€å‰å›ä»£ï¼Œè¯æ˜ $r_k$ å¯ä»¥è¡¨ç¤ºä¸º $a$ å’Œ $b$ çš„çº¿æ€§ç»„åˆã€‚ ä»å€’æ•°ç¬¬äºŒæ­¥ï¼š $r_k = r_{k-2} - q_k r_{k-1}$ ï¼ˆè¿™æ˜¯ $r_{k-2}$ å’Œ $r_{k-1}$ çš„çº¿æ€§ç»„åˆï¼‰ å°† $r_{k-1}$ ä»£å…¥ä¸Šä¸€å¼ï¼š $r_{k-1} = r_{k-3} - q_{k-1} r_{k-2}$ â†’ $r_k = r_{k-2} - q_k (r_{k-3} - q_{k-1} r_{k-2}) = (1 + q_k q_{k-1}) r_{k-2} - q_k r_{k-3}$ ç»§ç»­å›ä»£ï¼Œæœ€ç»ˆæ‰€æœ‰ä½™æ•°éƒ½ä¼šè¢«è¡¨è¾¾ä¸ºæ›´æ—©çš„ä½™æ•°ï¼Œç›´è‡³ï¼š $râ‚$ ç”¨ $a$ å’Œ $b$ è¡¨ç¤ºï¼š$râ‚ = a - qâ‚ b$ $b$ ç”¨ $b$ è¡¨ç¤ºï¼ˆè‡ªèº«ï¼‰ æœ€ç»ˆï¼Œ$r_k$ï¼ˆå³ gcdï¼‰å°†è¢«è¡¨è¾¾ä¸º $a$ å’Œ $b$ çš„æ•´æ•°ç³»æ•°çº¿æ€§ç»„åˆï¼š gcd(a, b) = r_k = a x + b y ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ä»£ç -1"},{"categories":null,"content":" æœ€å¤§å…¬çº¦æ•° æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def gcd(a, b): if b == 0: return a else: return gcd(b, a % b) æ—¶é—´å¤æ‚åº¦ä¸ºï¼šO(log(min(a, b)))Â æˆ–Â O(log(max(a, b))) è¯æ˜æˆ‘ä»¬é¦–å…ˆå‡è®¾æœ‰ä¸¤ä¸ªæ•° $a$ å’Œ $b$ï¼Œå…¶ä¸­ $a$ æ˜¯ä¸å°äº $b$ çš„æ•°ï¼Œè®° $a$ è¢« $b$ é™¤çš„ä½™æ•°ä¸º $r$ï¼Œé‚£ä¹ˆ $a$ å¯ä»¥å†™æˆè¿™æ ·çš„å½¢å¼ï¼š a=bq+r a = bq + r a=bq+rå…¶ä¸­ $q$ æ˜¯æ•´æ•°ã€‚ç°åœ¨å‡è®¾ $a$ å’Œ $b$ çš„ä¸€ä¸ªçº¦æ•°ä¸º $u$ï¼Œé‚£ä¹ˆ $a$ å’Œ $b$ éƒ½èƒ½è¢« $u$ æ•´é™¤ï¼Œå³ a=sub=tu \\begin{align} a\u0026=su\\\\ b\u0026=tu \\end{align} abâ€‹=su=tuâ€‹â€‹$s$ å’Œ $t$ éƒ½æ˜¯æ•´æ•°ã€‚è¿™æ ·å¯ä»¥å¾—å‡ºï¼š r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)u r = a - bq = su - (tu)q = (s - tq)u r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)uæ‰€ä»¥ $r$ ä¹Ÿèƒ½è¢« $u$ æ•´é™¤ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°ä¸€èˆ¬è§„å¾‹å¦‚ä¸‹ï¼š $a$ å’Œ $b$ çš„çº¦æ•°ä¹Ÿæ•´é™¤å®ƒä»¬çš„ä½™æ•° $r$ï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $b$ å’Œ $r$ çš„çº¦æ•°ã€‚ åè¿‡æ¥å¯ä»¥å¾—å‡ºï¼š $b$ å’Œ $r$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $a$ å’Œ $b$ çš„çº¦æ•°ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å‡ºï¼š$a$ å’Œ $b$ çš„çº¦æ•°çš„é›†åˆï¼Œå…¨ç­‰äº $b$ å’Œ $r$ çš„çº¦æ•°çš„é›†åˆï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„æœ€å¤§å…¬çº¦æ•°ï¼Œå°±æ˜¯ $b$ å’Œ $r$ çš„æœ€å¤§å…¬çº¦æ•°ã€‚ gcd(a,b)=gcd(b,r) \\text{gcd}(a,b) = \\text{gcd}(b, r) gcd(a,b)=gcd(b,r)æ ¹æ®é€’æ¨æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­å‡å° $b$ ä½¿å¾—å…¬å¼å˜ä¸º $gcd(x,0)$ï¼Œç»“æœå°±æ˜¯ xã€‚ æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def extended_gcd(a, b): if b == 0: return a, 1, 0 gcd, x1, y1 = extended_gcd(b, a % b) x = y1 y = x1 - (a / b) * y1 return gcd, x, y è¯æ˜æ¬§å‡ é‡Œå¾—ç®—æ³•äº§ç”Ÿå¦‚ä¸‹é™¤æ³•åºåˆ—ï¼š $a = qâ‚ b + râ‚ (0 â‰¤ râ‚ \u003c b)$ $b = qâ‚‚ râ‚ + râ‚‚ (0 â‰¤ râ‚‚ \u003c râ‚)$ $râ‚ = qâ‚ƒ râ‚‚ + râ‚ƒ (0 â‰¤ râ‚ƒ \u003c râ‚‚)$ â€¦ $r_{k-2} = q_k r_{k-1} + r_k$ $r_{k-1} = q_{k+1} r_k + 0$ åˆ™ $gcd(a, b) = r_k$ æœ€åä¸€ä¸ªéé›¶ä½™æ•°ã€‚ç°åœ¨ä»åå¾€å‰å›ä»£ï¼Œè¯æ˜ $r_k$ å¯ä»¥è¡¨ç¤ºä¸º $a$ å’Œ $b$ çš„çº¿æ€§ç»„åˆã€‚ ä»å€’æ•°ç¬¬äºŒæ­¥ï¼š $r_k = r_{k-2} - q_k r_{k-1}$ ï¼ˆè¿™æ˜¯ $r_{k-2}$ å’Œ $r_{k-1}$ çš„çº¿æ€§ç»„åˆï¼‰ å°† $r_{k-1}$ ä»£å…¥ä¸Šä¸€å¼ï¼š $r_{k-1} = r_{k-3} - q_{k-1} r_{k-2}$ â†’ $r_k = r_{k-2} - q_k (r_{k-3} - q_{k-1} r_{k-2}) = (1 + q_k q_{k-1}) r_{k-2} - q_k r_{k-3}$ ç»§ç»­å›ä»£ï¼Œæœ€ç»ˆæ‰€æœ‰ä½™æ•°éƒ½ä¼šè¢«è¡¨è¾¾ä¸ºæ›´æ—©çš„ä½™æ•°ï¼Œç›´è‡³ï¼š $râ‚$ ç”¨ $a$ å’Œ $b$ è¡¨ç¤ºï¼š$râ‚ = a - qâ‚ b$ $b$ ç”¨ $b$ è¡¨ç¤ºï¼ˆè‡ªèº«ï¼‰ æœ€ç»ˆï¼Œ$r_k$ï¼ˆå³ gcdï¼‰å°†è¢«è¡¨è¾¾ä¸º $a$ å’Œ $b$ çš„æ•´æ•°ç³»æ•°çº¿æ€§ç»„åˆï¼š gcd(a, b) = r_k = a x + b y ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯æ˜"},{"categories":null,"content":" æœ€å¤§å…¬çº¦æ•° æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def gcd(a, b): if b == 0: return a else: return gcd(b, a % b) æ—¶é—´å¤æ‚åº¦ä¸ºï¼šO(log(min(a, b)))Â æˆ–Â O(log(max(a, b))) è¯æ˜æˆ‘ä»¬é¦–å…ˆå‡è®¾æœ‰ä¸¤ä¸ªæ•° $a$ å’Œ $b$ï¼Œå…¶ä¸­ $a$ æ˜¯ä¸å°äº $b$ çš„æ•°ï¼Œè®° $a$ è¢« $b$ é™¤çš„ä½™æ•°ä¸º $r$ï¼Œé‚£ä¹ˆ $a$ å¯ä»¥å†™æˆè¿™æ ·çš„å½¢å¼ï¼š a=bq+r a = bq + r a=bq+rå…¶ä¸­ $q$ æ˜¯æ•´æ•°ã€‚ç°åœ¨å‡è®¾ $a$ å’Œ $b$ çš„ä¸€ä¸ªçº¦æ•°ä¸º $u$ï¼Œé‚£ä¹ˆ $a$ å’Œ $b$ éƒ½èƒ½è¢« $u$ æ•´é™¤ï¼Œå³ a=sub=tu \\begin{align} a\u0026=su\\\\ b\u0026=tu \\end{align} abâ€‹=su=tuâ€‹â€‹$s$ å’Œ $t$ éƒ½æ˜¯æ•´æ•°ã€‚è¿™æ ·å¯ä»¥å¾—å‡ºï¼š r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)u r = a - bq = su - (tu)q = (s - tq)u r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)uæ‰€ä»¥ $r$ ä¹Ÿèƒ½è¢« $u$ æ•´é™¤ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°ä¸€èˆ¬è§„å¾‹å¦‚ä¸‹ï¼š $a$ å’Œ $b$ çš„çº¦æ•°ä¹Ÿæ•´é™¤å®ƒä»¬çš„ä½™æ•° $r$ï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $b$ å’Œ $r$ çš„çº¦æ•°ã€‚ åè¿‡æ¥å¯ä»¥å¾—å‡ºï¼š $b$ å’Œ $r$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $a$ å’Œ $b$ çš„çº¦æ•°ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å‡ºï¼š$a$ å’Œ $b$ çš„çº¦æ•°çš„é›†åˆï¼Œå…¨ç­‰äº $b$ å’Œ $r$ çš„çº¦æ•°çš„é›†åˆï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„æœ€å¤§å…¬çº¦æ•°ï¼Œå°±æ˜¯ $b$ å’Œ $r$ çš„æœ€å¤§å…¬çº¦æ•°ã€‚ gcd(a,b)=gcd(b,r) \\text{gcd}(a,b) = \\text{gcd}(b, r) gcd(a,b)=gcd(b,r)æ ¹æ®é€’æ¨æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­å‡å° $b$ ä½¿å¾—å…¬å¼å˜ä¸º $gcd(x,0)$ï¼Œç»“æœå°±æ˜¯ xã€‚ æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def extended_gcd(a, b): if b == 0: return a, 1, 0 gcd, x1, y1 = extended_gcd(b, a % b) x = y1 y = x1 - (a / b) * y1 return gcd, x, y è¯æ˜æ¬§å‡ é‡Œå¾—ç®—æ³•äº§ç”Ÿå¦‚ä¸‹é™¤æ³•åºåˆ—ï¼š $a = qâ‚ b + râ‚ (0 â‰¤ râ‚ \u003c b)$ $b = qâ‚‚ râ‚ + râ‚‚ (0 â‰¤ râ‚‚ \u003c râ‚)$ $râ‚ = qâ‚ƒ râ‚‚ + râ‚ƒ (0 â‰¤ râ‚ƒ \u003c râ‚‚)$ â€¦ $r_{k-2} = q_k r_{k-1} + r_k$ $r_{k-1} = q_{k+1} r_k + 0$ åˆ™ $gcd(a, b) = r_k$ æœ€åä¸€ä¸ªéé›¶ä½™æ•°ã€‚ç°åœ¨ä»åå¾€å‰å›ä»£ï¼Œè¯æ˜ $r_k$ å¯ä»¥è¡¨ç¤ºä¸º $a$ å’Œ $b$ çš„çº¿æ€§ç»„åˆã€‚ ä»å€’æ•°ç¬¬äºŒæ­¥ï¼š $r_k = r_{k-2} - q_k r_{k-1}$ ï¼ˆè¿™æ˜¯ $r_{k-2}$ å’Œ $r_{k-1}$ çš„çº¿æ€§ç»„åˆï¼‰ å°† $r_{k-1}$ ä»£å…¥ä¸Šä¸€å¼ï¼š $r_{k-1} = r_{k-3} - q_{k-1} r_{k-2}$ â†’ $r_k = r_{k-2} - q_k (r_{k-3} - q_{k-1} r_{k-2}) = (1 + q_k q_{k-1}) r_{k-2} - q_k r_{k-3}$ ç»§ç»­å›ä»£ï¼Œæœ€ç»ˆæ‰€æœ‰ä½™æ•°éƒ½ä¼šè¢«è¡¨è¾¾ä¸ºæ›´æ—©çš„ä½™æ•°ï¼Œç›´è‡³ï¼š $râ‚$ ç”¨ $a$ å’Œ $b$ è¡¨ç¤ºï¼š$râ‚ = a - qâ‚ b$ $b$ ç”¨ $b$ è¡¨ç¤ºï¼ˆè‡ªèº«ï¼‰ æœ€ç»ˆï¼Œ$r_k$ï¼ˆå³ gcdï¼‰å°†è¢«è¡¨è¾¾ä¸º $a$ å’Œ $b$ çš„æ•´æ•°ç³»æ•°çº¿æ€§ç»„åˆï¼š gcd(a, b) = r_k = a x + b y ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³•"},{"categories":null,"content":" æœ€å¤§å…¬çº¦æ•° æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def gcd(a, b): if b == 0: return a else: return gcd(b, a % b) æ—¶é—´å¤æ‚åº¦ä¸ºï¼šO(log(min(a, b)))Â æˆ–Â O(log(max(a, b))) è¯æ˜æˆ‘ä»¬é¦–å…ˆå‡è®¾æœ‰ä¸¤ä¸ªæ•° $a$ å’Œ $b$ï¼Œå…¶ä¸­ $a$ æ˜¯ä¸å°äº $b$ çš„æ•°ï¼Œè®° $a$ è¢« $b$ é™¤çš„ä½™æ•°ä¸º $r$ï¼Œé‚£ä¹ˆ $a$ å¯ä»¥å†™æˆè¿™æ ·çš„å½¢å¼ï¼š a=bq+r a = bq + r a=bq+rå…¶ä¸­ $q$ æ˜¯æ•´æ•°ã€‚ç°åœ¨å‡è®¾ $a$ å’Œ $b$ çš„ä¸€ä¸ªçº¦æ•°ä¸º $u$ï¼Œé‚£ä¹ˆ $a$ å’Œ $b$ éƒ½èƒ½è¢« $u$ æ•´é™¤ï¼Œå³ a=sub=tu \\begin{align} a\u0026=su\\\\ b\u0026=tu \\end{align} abâ€‹=su=tuâ€‹â€‹$s$ å’Œ $t$ éƒ½æ˜¯æ•´æ•°ã€‚è¿™æ ·å¯ä»¥å¾—å‡ºï¼š r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)u r = a - bq = su - (tu)q = (s - tq)u r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)uæ‰€ä»¥ $r$ ä¹Ÿèƒ½è¢« $u$ æ•´é™¤ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°ä¸€èˆ¬è§„å¾‹å¦‚ä¸‹ï¼š $a$ å’Œ $b$ çš„çº¦æ•°ä¹Ÿæ•´é™¤å®ƒä»¬çš„ä½™æ•° $r$ï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $b$ å’Œ $r$ çš„çº¦æ•°ã€‚ åè¿‡æ¥å¯ä»¥å¾—å‡ºï¼š $b$ å’Œ $r$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $a$ å’Œ $b$ çš„çº¦æ•°ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å‡ºï¼š$a$ å’Œ $b$ çš„çº¦æ•°çš„é›†åˆï¼Œå…¨ç­‰äº $b$ å’Œ $r$ çš„çº¦æ•°çš„é›†åˆï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„æœ€å¤§å…¬çº¦æ•°ï¼Œå°±æ˜¯ $b$ å’Œ $r$ çš„æœ€å¤§å…¬çº¦æ•°ã€‚ gcd(a,b)=gcd(b,r) \\text{gcd}(a,b) = \\text{gcd}(b, r) gcd(a,b)=gcd(b,r)æ ¹æ®é€’æ¨æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­å‡å° $b$ ä½¿å¾—å…¬å¼å˜ä¸º $gcd(x,0)$ï¼Œç»“æœå°±æ˜¯ xã€‚ æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def extended_gcd(a, b): if b == 0: return a, 1, 0 gcd, x1, y1 = extended_gcd(b, a % b) x = y1 y = x1 - (a / b) * y1 return gcd, x, y è¯æ˜æ¬§å‡ é‡Œå¾—ç®—æ³•äº§ç”Ÿå¦‚ä¸‹é™¤æ³•åºåˆ—ï¼š $a = qâ‚ b + râ‚ (0 â‰¤ râ‚ \u003c b)$ $b = qâ‚‚ râ‚ + râ‚‚ (0 â‰¤ râ‚‚ \u003c râ‚)$ $râ‚ = qâ‚ƒ râ‚‚ + râ‚ƒ (0 â‰¤ râ‚ƒ \u003c râ‚‚)$ â€¦ $r_{k-2} = q_k r_{k-1} + r_k$ $r_{k-1} = q_{k+1} r_k + 0$ åˆ™ $gcd(a, b) = r_k$ æœ€åä¸€ä¸ªéé›¶ä½™æ•°ã€‚ç°åœ¨ä»åå¾€å‰å›ä»£ï¼Œè¯æ˜ $r_k$ å¯ä»¥è¡¨ç¤ºä¸º $a$ å’Œ $b$ çš„çº¿æ€§ç»„åˆã€‚ ä»å€’æ•°ç¬¬äºŒæ­¥ï¼š $r_k = r_{k-2} - q_k r_{k-1}$ ï¼ˆè¿™æ˜¯ $r_{k-2}$ å’Œ $r_{k-1}$ çš„çº¿æ€§ç»„åˆï¼‰ å°† $r_{k-1}$ ä»£å…¥ä¸Šä¸€å¼ï¼š $r_{k-1} = r_{k-3} - q_{k-1} r_{k-2}$ â†’ $r_k = r_{k-2} - q_k (r_{k-3} - q_{k-1} r_{k-2}) = (1 + q_k q_{k-1}) r_{k-2} - q_k r_{k-3}$ ç»§ç»­å›ä»£ï¼Œæœ€ç»ˆæ‰€æœ‰ä½™æ•°éƒ½ä¼šè¢«è¡¨è¾¾ä¸ºæ›´æ—©çš„ä½™æ•°ï¼Œç›´è‡³ï¼š $râ‚$ ç”¨ $a$ å’Œ $b$ è¡¨ç¤ºï¼š$râ‚ = a - qâ‚ b$ $b$ ç”¨ $b$ è¡¨ç¤ºï¼ˆè‡ªèº«ï¼‰ æœ€ç»ˆï¼Œ$r_k$ï¼ˆå³ gcdï¼‰å°†è¢«è¡¨è¾¾ä¸º $a$ å’Œ $b$ çš„æ•´æ•°ç³»æ•°çº¿æ€§ç»„åˆï¼š gcd(a, b) = r_k = a x + b y ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ä»£ç -2"},{"categories":null,"content":" æœ€å¤§å…¬çº¦æ•° æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def gcd(a, b): if b == 0: return a else: return gcd(b, a % b) æ—¶é—´å¤æ‚åº¦ä¸ºï¼šO(log(min(a, b)))Â æˆ–Â O(log(max(a, b))) è¯æ˜æˆ‘ä»¬é¦–å…ˆå‡è®¾æœ‰ä¸¤ä¸ªæ•° $a$ å’Œ $b$ï¼Œå…¶ä¸­ $a$ æ˜¯ä¸å°äº $b$ çš„æ•°ï¼Œè®° $a$ è¢« $b$ é™¤çš„ä½™æ•°ä¸º $r$ï¼Œé‚£ä¹ˆ $a$ å¯ä»¥å†™æˆè¿™æ ·çš„å½¢å¼ï¼š a=bq+r a = bq + r a=bq+rå…¶ä¸­ $q$ æ˜¯æ•´æ•°ã€‚ç°åœ¨å‡è®¾ $a$ å’Œ $b$ çš„ä¸€ä¸ªçº¦æ•°ä¸º $u$ï¼Œé‚£ä¹ˆ $a$ å’Œ $b$ éƒ½èƒ½è¢« $u$ æ•´é™¤ï¼Œå³ a=sub=tu \\begin{align} a\u0026=su\\\\ b\u0026=tu \\end{align} abâ€‹=su=tuâ€‹â€‹$s$ å’Œ $t$ éƒ½æ˜¯æ•´æ•°ã€‚è¿™æ ·å¯ä»¥å¾—å‡ºï¼š r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)u r = a - bq = su - (tu)q = (s - tq)u r=aâˆ’bq=suâˆ’(tu)q=(sâˆ’tq)uæ‰€ä»¥ $r$ ä¹Ÿèƒ½è¢« $u$ æ•´é™¤ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°ä¸€èˆ¬è§„å¾‹å¦‚ä¸‹ï¼š $a$ å’Œ $b$ çš„çº¦æ•°ä¹Ÿæ•´é™¤å®ƒä»¬çš„ä½™æ•° $r$ï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $b$ å’Œ $r$ çš„çº¦æ•°ã€‚ åè¿‡æ¥å¯ä»¥å¾—å‡ºï¼š $b$ å’Œ $r$ çš„ä»»ä¸€çº¦æ•°åŒæ—¶ä¹Ÿæ˜¯ $a$ å’Œ $b$ çš„çº¦æ•°ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å‡ºï¼š$a$ å’Œ $b$ çš„çº¦æ•°çš„é›†åˆï¼Œå…¨ç­‰äº $b$ å’Œ $r$ çš„çº¦æ•°çš„é›†åˆï¼Œæ‰€ä»¥ $a$ å’Œ $b$ çš„æœ€å¤§å…¬çº¦æ•°ï¼Œå°±æ˜¯ $b$ å’Œ $r$ çš„æœ€å¤§å…¬çº¦æ•°ã€‚ gcd(a,b)=gcd(b,r) \\text{gcd}(a,b) = \\text{gcd}(b, r) gcd(a,b)=gcd(b,r)æ ¹æ®é€’æ¨æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­å‡å° $b$ ä½¿å¾—å…¬å¼å˜ä¸º $gcd(x,0)$ï¼Œç»“æœå°±æ˜¯ xã€‚ æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³• ä»£ç  python def extended_gcd(a, b): if b == 0: return a, 1, 0 gcd, x1, y1 = extended_gcd(b, a % b) x = y1 y = x1 - (a / b) * y1 return gcd, x, y è¯æ˜æ¬§å‡ é‡Œå¾—ç®—æ³•äº§ç”Ÿå¦‚ä¸‹é™¤æ³•åºåˆ—ï¼š $a = qâ‚ b + râ‚ (0 â‰¤ râ‚ \u003c b)$ $b = qâ‚‚ râ‚ + râ‚‚ (0 â‰¤ râ‚‚ \u003c râ‚)$ $râ‚ = qâ‚ƒ râ‚‚ + râ‚ƒ (0 â‰¤ râ‚ƒ \u003c râ‚‚)$ â€¦ $r_{k-2} = q_k r_{k-1} + r_k$ $r_{k-1} = q_{k+1} r_k + 0$ åˆ™ $gcd(a, b) = r_k$ æœ€åä¸€ä¸ªéé›¶ä½™æ•°ã€‚ç°åœ¨ä»åå¾€å‰å›ä»£ï¼Œè¯æ˜ $r_k$ å¯ä»¥è¡¨ç¤ºä¸º $a$ å’Œ $b$ çš„çº¿æ€§ç»„åˆã€‚ ä»å€’æ•°ç¬¬äºŒæ­¥ï¼š $r_k = r_{k-2} - q_k r_{k-1}$ ï¼ˆè¿™æ˜¯ $r_{k-2}$ å’Œ $r_{k-1}$ çš„çº¿æ€§ç»„åˆï¼‰ å°† $r_{k-1}$ ä»£å…¥ä¸Šä¸€å¼ï¼š $r_{k-1} = r_{k-3} - q_{k-1} r_{k-2}$ â†’ $r_k = r_{k-2} - q_k (r_{k-3} - q_{k-1} r_{k-2}) = (1 + q_k q_{k-1}) r_{k-2} - q_k r_{k-3}$ ç»§ç»­å›ä»£ï¼Œæœ€ç»ˆæ‰€æœ‰ä½™æ•°éƒ½ä¼šè¢«è¡¨è¾¾ä¸ºæ›´æ—©çš„ä½™æ•°ï¼Œç›´è‡³ï¼š $râ‚$ ç”¨ $a$ å’Œ $b$ è¡¨ç¤ºï¼š$râ‚ = a - qâ‚ b$ $b$ ç”¨ $b$ è¡¨ç¤ºï¼ˆè‡ªèº«ï¼‰ æœ€ç»ˆï¼Œ$r_k$ï¼ˆå³ gcdï¼‰å°†è¢«è¡¨è¾¾ä¸º $a$ å’Œ $b$ çš„æ•´æ•°ç³»æ•°çº¿æ€§ç»„åˆï¼š gcd(a, b) = r_k = a x + b y ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯æ˜-1"},{"categories":null,"content":" çº¿æ€§æ¨¡æ–¹ç¨‹ é—®é¢˜èƒŒæ™¯åœ¨æ¨¡ n çš„ä¸–ç•Œé‡Œï¼Œåªå‰©ä¸‹ n ä¸ªâ€œåŸºæœ¬å…ƒç´ â€ ${0, 1, 2, â€¦, nâˆ’1}$ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å®é™…ä¸Šä»£è¡¨ä¸€ä¸ªæ— é™é›†åˆ $[k] = { k + tn | t âˆˆ â„¤ }$ã€‚ä¾‹å¦‚åœ¨æ¨¡ 7 çš„ä¸–ç•Œé‡Œï¼š 0 ä»£è¡¨ ${â€¦, âˆ’14, âˆ’7, 0, 7, 14, â€¦}$ 3 ä»£è¡¨ ${â€¦, âˆ’11, âˆ’4, 3, 10, 17, â€¦}$ å› æ­¤æˆ‘ä»¬å¯ä»¥å†™å‡º $7 \\equiv 12 (\\text{mod} 5)$ï¼Œå› ä¸ºå®ƒä»¬å¯¹ 5 çš„ä½™æ•°ç›¸åŒã€‚è€Œçº¿æ€§æ¨¡æ–¹ç¨‹è§£å†³çš„å°±æ˜¯ï¼š axâ‰¡b(modâ€‰n) ax \\equiv b (mod \\,n) axâ‰¡b(modn)å…¶ä¸­ a, b, n æ˜¯å·²çŸ¥æ•´æ•°ï¼Œn \u003e 0ï¼Œx æ˜¯æœªçŸ¥æ•´æ•°ï¼Œæˆ‘ä»¬è¦æ±‚çš„å°±æ˜¯ x åœ¨æ¨¡ n æ„ä¹‰ä¸‹çš„è§£ã€‚ä½†æ˜¯åœ¨æ¨¡ n çš„ä¸–ç•Œé‡Œï¼Œé™¤æ³•å¹¶ä¸å¤©ç„¶å­˜åœ¨ã€‚æ‰€ä»¥çº¿æ€§æ¨¡æ–¹ç¨‹è§£å†³çš„æ˜¯ï¼š åœ¨æ¨¡è¿ç®—ä½“ç³»ä¸­ï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥åšâ€œé™¤æ³•â€ï¼Œä»¥åŠæ€ä¹ˆåšã€‚ é™¤æ³•å­˜åœ¨çš„æ¡ä»¶å‡è®¾ $d=\\text{gcd}(a, n)$ï¼Œå½“ä¸”ä»…å½“ $d | b$ï¼ˆæ•´é™¤ï¼‰ æ—¶ï¼Œæ–¹ç¨‹ $ax \\equiv b (mod , n)$ æœ‰è§£ï¼Œå¹¶ä¸”åœ¨æ¨¡æ„ä¹‰ä¸‹å­˜åœ¨ d ä¸ªä¸åŒçš„è§£ã€‚ æ€ä¹ˆåš python def linear_mod(a, b, n): d, x, y = gcd_extened(a, b) if d % b: return -1 x0 = (x * b / d) % n for i in range(n): print(x0 + i * n / d) % n æ„Ÿè§‰ä¸è€ƒï¼Œå…·ä½“åŸç†çœ‹ä¸æ‡‚ æ‰‹ç®—ä¾‹ï¼š æ±‚ $35x=10(mod 50)$ çš„æ‰€æœ‰è§£ å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰è§£ï¼š$d=gcd(35, 50)=5$ ï¼Œ5 æ•´é™¤ 10 æ‰€ä»¥æœ‰å”¯ä¸€è§£ï¼Œè§£çš„æ•°é‡ä¸º 5 ç­‰å¼ä¸¤è¾¹åŒé™¤ d å¾—åˆ° $7x \\equiv 2(mod 10)$ è®¡ç®—æ¨¡ 50 ç©ºé—´ä¸‹ 7 çš„é€†å…ƒï¼Œå°±å¯ä»¥æŠŠ x çš„ç³»æ•°æ¶ˆæ‰ï¼Œç»è¿‡è®¡ç®— $7 \\times 3 = 1 (mod 10)$ ç­‰å¼ä¸¤è¾¹åŒä¹˜ 3ï¼Œå¾—åˆ° $x \\equiv 6(mod 10)$ æ‰€ä»¥è§£ä¸º $x=6 + 10t$ é€†å…ƒå…¶å®å°±æ˜¯æ™®é€šæ„ä¹‰ä¸Šçš„ç›¸åæ•°ï¼Œæˆ‘ä»¬éœ€è¦æ±‚ $kx=b$ é‡Œé¢ k çš„ç›¸åæ•°ï¼Œè¿™æ ·ä¸¤è¾¹åŒä¹˜å°±å¯ä»¥å»æ‰ x çš„ç³»æ•°ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#çº¿æ€§æ¨¡æ–¹ç¨‹"},{"categories":null,"content":" çº¿æ€§æ¨¡æ–¹ç¨‹ é—®é¢˜èƒŒæ™¯åœ¨æ¨¡ n çš„ä¸–ç•Œé‡Œï¼Œåªå‰©ä¸‹ n ä¸ªâ€œåŸºæœ¬å…ƒç´ â€ ${0, 1, 2, â€¦, nâˆ’1}$ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å®é™…ä¸Šä»£è¡¨ä¸€ä¸ªæ— é™é›†åˆ $[k] = { k + tn | t âˆˆ â„¤ }$ã€‚ä¾‹å¦‚åœ¨æ¨¡ 7 çš„ä¸–ç•Œé‡Œï¼š 0 ä»£è¡¨ ${â€¦, âˆ’14, âˆ’7, 0, 7, 14, â€¦}$ 3 ä»£è¡¨ ${â€¦, âˆ’11, âˆ’4, 3, 10, 17, â€¦}$ å› æ­¤æˆ‘ä»¬å¯ä»¥å†™å‡º $7 \\equiv 12 (\\text{mod} 5)$ï¼Œå› ä¸ºå®ƒä»¬å¯¹ 5 çš„ä½™æ•°ç›¸åŒã€‚è€Œçº¿æ€§æ¨¡æ–¹ç¨‹è§£å†³çš„å°±æ˜¯ï¼š axâ‰¡b(modâ€‰n) ax \\equiv b (mod \\,n) axâ‰¡b(modn)å…¶ä¸­ a, b, n æ˜¯å·²çŸ¥æ•´æ•°ï¼Œn \u003e 0ï¼Œx æ˜¯æœªçŸ¥æ•´æ•°ï¼Œæˆ‘ä»¬è¦æ±‚çš„å°±æ˜¯ x åœ¨æ¨¡ n æ„ä¹‰ä¸‹çš„è§£ã€‚ä½†æ˜¯åœ¨æ¨¡ n çš„ä¸–ç•Œé‡Œï¼Œé™¤æ³•å¹¶ä¸å¤©ç„¶å­˜åœ¨ã€‚æ‰€ä»¥çº¿æ€§æ¨¡æ–¹ç¨‹è§£å†³çš„æ˜¯ï¼š åœ¨æ¨¡è¿ç®—ä½“ç³»ä¸­ï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥åšâ€œé™¤æ³•â€ï¼Œä»¥åŠæ€ä¹ˆåšã€‚ é™¤æ³•å­˜åœ¨çš„æ¡ä»¶å‡è®¾ $d=\\text{gcd}(a, n)$ï¼Œå½“ä¸”ä»…å½“ $d | b$ï¼ˆæ•´é™¤ï¼‰ æ—¶ï¼Œæ–¹ç¨‹ $ax \\equiv b (mod , n)$ æœ‰è§£ï¼Œå¹¶ä¸”åœ¨æ¨¡æ„ä¹‰ä¸‹å­˜åœ¨ d ä¸ªä¸åŒçš„è§£ã€‚ æ€ä¹ˆåš python def linear_mod(a, b, n): d, x, y = gcd_extened(a, b) if d % b: return -1 x0 = (x * b / d) % n for i in range(n): print(x0 + i * n / d) % n æ„Ÿè§‰ä¸è€ƒï¼Œå…·ä½“åŸç†çœ‹ä¸æ‡‚ æ‰‹ç®—ä¾‹ï¼š æ±‚ $35x=10(mod 50)$ çš„æ‰€æœ‰è§£ å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰è§£ï¼š$d=gcd(35, 50)=5$ ï¼Œ5 æ•´é™¤ 10 æ‰€ä»¥æœ‰å”¯ä¸€è§£ï¼Œè§£çš„æ•°é‡ä¸º 5 ç­‰å¼ä¸¤è¾¹åŒé™¤ d å¾—åˆ° $7x \\equiv 2(mod 10)$ è®¡ç®—æ¨¡ 50 ç©ºé—´ä¸‹ 7 çš„é€†å…ƒï¼Œå°±å¯ä»¥æŠŠ x çš„ç³»æ•°æ¶ˆæ‰ï¼Œç»è¿‡è®¡ç®— $7 \\times 3 = 1 (mod 10)$ ç­‰å¼ä¸¤è¾¹åŒä¹˜ 3ï¼Œå¾—åˆ° $x \\equiv 6(mod 10)$ æ‰€ä»¥è§£ä¸º $x=6 + 10t$ é€†å…ƒå…¶å®å°±æ˜¯æ™®é€šæ„ä¹‰ä¸Šçš„ç›¸åæ•°ï¼Œæˆ‘ä»¬éœ€è¦æ±‚ $kx=b$ é‡Œé¢ k çš„ç›¸åæ•°ï¼Œè¿™æ ·ä¸¤è¾¹åŒä¹˜å°±å¯ä»¥å»æ‰ x çš„ç³»æ•°ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#é—®é¢˜èƒŒæ™¯"},{"categories":null,"content":" çº¿æ€§æ¨¡æ–¹ç¨‹ é—®é¢˜èƒŒæ™¯åœ¨æ¨¡ n çš„ä¸–ç•Œé‡Œï¼Œåªå‰©ä¸‹ n ä¸ªâ€œåŸºæœ¬å…ƒç´ â€ ${0, 1, 2, â€¦, nâˆ’1}$ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å®é™…ä¸Šä»£è¡¨ä¸€ä¸ªæ— é™é›†åˆ $[k] = { k + tn | t âˆˆ â„¤ }$ã€‚ä¾‹å¦‚åœ¨æ¨¡ 7 çš„ä¸–ç•Œé‡Œï¼š 0 ä»£è¡¨ ${â€¦, âˆ’14, âˆ’7, 0, 7, 14, â€¦}$ 3 ä»£è¡¨ ${â€¦, âˆ’11, âˆ’4, 3, 10, 17, â€¦}$ å› æ­¤æˆ‘ä»¬å¯ä»¥å†™å‡º $7 \\equiv 12 (\\text{mod} 5)$ï¼Œå› ä¸ºå®ƒä»¬å¯¹ 5 çš„ä½™æ•°ç›¸åŒã€‚è€Œçº¿æ€§æ¨¡æ–¹ç¨‹è§£å†³çš„å°±æ˜¯ï¼š axâ‰¡b(modâ€‰n) ax \\equiv b (mod \\,n) axâ‰¡b(modn)å…¶ä¸­ a, b, n æ˜¯å·²çŸ¥æ•´æ•°ï¼Œn \u003e 0ï¼Œx æ˜¯æœªçŸ¥æ•´æ•°ï¼Œæˆ‘ä»¬è¦æ±‚çš„å°±æ˜¯ x åœ¨æ¨¡ n æ„ä¹‰ä¸‹çš„è§£ã€‚ä½†æ˜¯åœ¨æ¨¡ n çš„ä¸–ç•Œé‡Œï¼Œé™¤æ³•å¹¶ä¸å¤©ç„¶å­˜åœ¨ã€‚æ‰€ä»¥çº¿æ€§æ¨¡æ–¹ç¨‹è§£å†³çš„æ˜¯ï¼š åœ¨æ¨¡è¿ç®—ä½“ç³»ä¸­ï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥åšâ€œé™¤æ³•â€ï¼Œä»¥åŠæ€ä¹ˆåšã€‚ é™¤æ³•å­˜åœ¨çš„æ¡ä»¶å‡è®¾ $d=\\text{gcd}(a, n)$ï¼Œå½“ä¸”ä»…å½“ $d | b$ï¼ˆæ•´é™¤ï¼‰ æ—¶ï¼Œæ–¹ç¨‹ $ax \\equiv b (mod , n)$ æœ‰è§£ï¼Œå¹¶ä¸”åœ¨æ¨¡æ„ä¹‰ä¸‹å­˜åœ¨ d ä¸ªä¸åŒçš„è§£ã€‚ æ€ä¹ˆåš python def linear_mod(a, b, n): d, x, y = gcd_extened(a, b) if d % b: return -1 x0 = (x * b / d) % n for i in range(n): print(x0 + i * n / d) % n æ„Ÿè§‰ä¸è€ƒï¼Œå…·ä½“åŸç†çœ‹ä¸æ‡‚ æ‰‹ç®—ä¾‹ï¼š æ±‚ $35x=10(mod 50)$ çš„æ‰€æœ‰è§£ å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰è§£ï¼š$d=gcd(35, 50)=5$ ï¼Œ5 æ•´é™¤ 10 æ‰€ä»¥æœ‰å”¯ä¸€è§£ï¼Œè§£çš„æ•°é‡ä¸º 5 ç­‰å¼ä¸¤è¾¹åŒé™¤ d å¾—åˆ° $7x \\equiv 2(mod 10)$ è®¡ç®—æ¨¡ 50 ç©ºé—´ä¸‹ 7 çš„é€†å…ƒï¼Œå°±å¯ä»¥æŠŠ x çš„ç³»æ•°æ¶ˆæ‰ï¼Œç»è¿‡è®¡ç®— $7 \\times 3 = 1 (mod 10)$ ç­‰å¼ä¸¤è¾¹åŒä¹˜ 3ï¼Œå¾—åˆ° $x \\equiv 6(mod 10)$ æ‰€ä»¥è§£ä¸º $x=6 + 10t$ é€†å…ƒå…¶å®å°±æ˜¯æ™®é€šæ„ä¹‰ä¸Šçš„ç›¸åæ•°ï¼Œæˆ‘ä»¬éœ€è¦æ±‚ $kx=b$ é‡Œé¢ k çš„ç›¸åæ•°ï¼Œè¿™æ ·ä¸¤è¾¹åŒä¹˜å°±å¯ä»¥å»æ‰ x çš„ç³»æ•°ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#é™¤æ³•å­˜åœ¨çš„æ¡ä»¶"},{"categories":null,"content":" çº¿æ€§æ¨¡æ–¹ç¨‹ é—®é¢˜èƒŒæ™¯åœ¨æ¨¡ n çš„ä¸–ç•Œé‡Œï¼Œåªå‰©ä¸‹ n ä¸ªâ€œåŸºæœ¬å…ƒç´ â€ ${0, 1, 2, â€¦, nâˆ’1}$ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å®é™…ä¸Šä»£è¡¨ä¸€ä¸ªæ— é™é›†åˆ $[k] = { k + tn | t âˆˆ â„¤ }$ã€‚ä¾‹å¦‚åœ¨æ¨¡ 7 çš„ä¸–ç•Œé‡Œï¼š 0 ä»£è¡¨ ${â€¦, âˆ’14, âˆ’7, 0, 7, 14, â€¦}$ 3 ä»£è¡¨ ${â€¦, âˆ’11, âˆ’4, 3, 10, 17, â€¦}$ å› æ­¤æˆ‘ä»¬å¯ä»¥å†™å‡º $7 \\equiv 12 (\\text{mod} 5)$ï¼Œå› ä¸ºå®ƒä»¬å¯¹ 5 çš„ä½™æ•°ç›¸åŒã€‚è€Œçº¿æ€§æ¨¡æ–¹ç¨‹è§£å†³çš„å°±æ˜¯ï¼š axâ‰¡b(modâ€‰n) ax \\equiv b (mod \\,n) axâ‰¡b(modn)å…¶ä¸­ a, b, n æ˜¯å·²çŸ¥æ•´æ•°ï¼Œn \u003e 0ï¼Œx æ˜¯æœªçŸ¥æ•´æ•°ï¼Œæˆ‘ä»¬è¦æ±‚çš„å°±æ˜¯ x åœ¨æ¨¡ n æ„ä¹‰ä¸‹çš„è§£ã€‚ä½†æ˜¯åœ¨æ¨¡ n çš„ä¸–ç•Œé‡Œï¼Œé™¤æ³•å¹¶ä¸å¤©ç„¶å­˜åœ¨ã€‚æ‰€ä»¥çº¿æ€§æ¨¡æ–¹ç¨‹è§£å†³çš„æ˜¯ï¼š åœ¨æ¨¡è¿ç®—ä½“ç³»ä¸­ï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥åšâ€œé™¤æ³•â€ï¼Œä»¥åŠæ€ä¹ˆåšã€‚ é™¤æ³•å­˜åœ¨çš„æ¡ä»¶å‡è®¾ $d=\\text{gcd}(a, n)$ï¼Œå½“ä¸”ä»…å½“ $d | b$ï¼ˆæ•´é™¤ï¼‰ æ—¶ï¼Œæ–¹ç¨‹ $ax \\equiv b (mod , n)$ æœ‰è§£ï¼Œå¹¶ä¸”åœ¨æ¨¡æ„ä¹‰ä¸‹å­˜åœ¨ d ä¸ªä¸åŒçš„è§£ã€‚ æ€ä¹ˆåš python def linear_mod(a, b, n): d, x, y = gcd_extened(a, b) if d % b: return -1 x0 = (x * b / d) % n for i in range(n): print(x0 + i * n / d) % n æ„Ÿè§‰ä¸è€ƒï¼Œå…·ä½“åŸç†çœ‹ä¸æ‡‚ æ‰‹ç®—ä¾‹ï¼š æ±‚ $35x=10(mod 50)$ çš„æ‰€æœ‰è§£ å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰è§£ï¼š$d=gcd(35, 50)=5$ ï¼Œ5 æ•´é™¤ 10 æ‰€ä»¥æœ‰å”¯ä¸€è§£ï¼Œè§£çš„æ•°é‡ä¸º 5 ç­‰å¼ä¸¤è¾¹åŒé™¤ d å¾—åˆ° $7x \\equiv 2(mod 10)$ è®¡ç®—æ¨¡ 50 ç©ºé—´ä¸‹ 7 çš„é€†å…ƒï¼Œå°±å¯ä»¥æŠŠ x çš„ç³»æ•°æ¶ˆæ‰ï¼Œç»è¿‡è®¡ç®— $7 \\times 3 = 1 (mod 10)$ ç­‰å¼ä¸¤è¾¹åŒä¹˜ 3ï¼Œå¾—åˆ° $x \\equiv 6(mod 10)$ æ‰€ä»¥è§£ä¸º $x=6 + 10t$ é€†å…ƒå…¶å®å°±æ˜¯æ™®é€šæ„ä¹‰ä¸Šçš„ç›¸åæ•°ï¼Œæˆ‘ä»¬éœ€è¦æ±‚ $kx=b$ é‡Œé¢ k çš„ç›¸åæ•°ï¼Œè¿™æ ·ä¸¤è¾¹åŒä¹˜å°±å¯ä»¥å»æ‰ x çš„ç³»æ•°ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ€ä¹ˆåš"},{"categories":null,"content":" çº¿æ€§æ¨¡æ–¹ç¨‹ é—®é¢˜èƒŒæ™¯åœ¨æ¨¡ n çš„ä¸–ç•Œé‡Œï¼Œåªå‰©ä¸‹ n ä¸ªâ€œåŸºæœ¬å…ƒç´ â€ ${0, 1, 2, â€¦, nâˆ’1}$ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å®é™…ä¸Šä»£è¡¨ä¸€ä¸ªæ— é™é›†åˆ $[k] = { k + tn | t âˆˆ â„¤ }$ã€‚ä¾‹å¦‚åœ¨æ¨¡ 7 çš„ä¸–ç•Œé‡Œï¼š 0 ä»£è¡¨ ${â€¦, âˆ’14, âˆ’7, 0, 7, 14, â€¦}$ 3 ä»£è¡¨ ${â€¦, âˆ’11, âˆ’4, 3, 10, 17, â€¦}$ å› æ­¤æˆ‘ä»¬å¯ä»¥å†™å‡º $7 \\equiv 12 (\\text{mod} 5)$ï¼Œå› ä¸ºå®ƒä»¬å¯¹ 5 çš„ä½™æ•°ç›¸åŒã€‚è€Œçº¿æ€§æ¨¡æ–¹ç¨‹è§£å†³çš„å°±æ˜¯ï¼š axâ‰¡b(modâ€‰n) ax \\equiv b (mod \\,n) axâ‰¡b(modn)å…¶ä¸­ a, b, n æ˜¯å·²çŸ¥æ•´æ•°ï¼Œn \u003e 0ï¼Œx æ˜¯æœªçŸ¥æ•´æ•°ï¼Œæˆ‘ä»¬è¦æ±‚çš„å°±æ˜¯ x åœ¨æ¨¡ n æ„ä¹‰ä¸‹çš„è§£ã€‚ä½†æ˜¯åœ¨æ¨¡ n çš„ä¸–ç•Œé‡Œï¼Œé™¤æ³•å¹¶ä¸å¤©ç„¶å­˜åœ¨ã€‚æ‰€ä»¥çº¿æ€§æ¨¡æ–¹ç¨‹è§£å†³çš„æ˜¯ï¼š åœ¨æ¨¡è¿ç®—ä½“ç³»ä¸­ï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥åšâ€œé™¤æ³•â€ï¼Œä»¥åŠæ€ä¹ˆåšã€‚ é™¤æ³•å­˜åœ¨çš„æ¡ä»¶å‡è®¾ $d=\\text{gcd}(a, n)$ï¼Œå½“ä¸”ä»…å½“ $d | b$ï¼ˆæ•´é™¤ï¼‰ æ—¶ï¼Œæ–¹ç¨‹ $ax \\equiv b (mod , n)$ æœ‰è§£ï¼Œå¹¶ä¸”åœ¨æ¨¡æ„ä¹‰ä¸‹å­˜åœ¨ d ä¸ªä¸åŒçš„è§£ã€‚ æ€ä¹ˆåš python def linear_mod(a, b, n): d, x, y = gcd_extened(a, b) if d % b: return -1 x0 = (x * b / d) % n for i in range(n): print(x0 + i * n / d) % n æ„Ÿè§‰ä¸è€ƒï¼Œå…·ä½“åŸç†çœ‹ä¸æ‡‚ æ‰‹ç®—ä¾‹ï¼š æ±‚ $35x=10(mod 50)$ çš„æ‰€æœ‰è§£ å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰è§£ï¼š$d=gcd(35, 50)=5$ ï¼Œ5 æ•´é™¤ 10 æ‰€ä»¥æœ‰å”¯ä¸€è§£ï¼Œè§£çš„æ•°é‡ä¸º 5 ç­‰å¼ä¸¤è¾¹åŒé™¤ d å¾—åˆ° $7x \\equiv 2(mod 10)$ è®¡ç®—æ¨¡ 50 ç©ºé—´ä¸‹ 7 çš„é€†å…ƒï¼Œå°±å¯ä»¥æŠŠ x çš„ç³»æ•°æ¶ˆæ‰ï¼Œç»è¿‡è®¡ç®— $7 \\times 3 = 1 (mod 10)$ ç­‰å¼ä¸¤è¾¹åŒä¹˜ 3ï¼Œå¾—åˆ° $x \\equiv 6(mod 10)$ æ‰€ä»¥è§£ä¸º $x=6 + 10t$ é€†å…ƒå…¶å®å°±æ˜¯æ™®é€šæ„ä¹‰ä¸Šçš„ç›¸åæ•°ï¼Œæˆ‘ä»¬éœ€è¦æ±‚ $kx=b$ é‡Œé¢ k çš„ç›¸åæ•°ï¼Œè¿™æ ·ä¸¤è¾¹åŒä¹˜å°±å¯ä»¥å»æ‰ x çš„ç³»æ•°ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æ‰‹ç®—"},{"categories":null,"content":" ä¸­å›½ä½™æ•°å®šç†ä¸­å›½ä½™æ•°å®šç†ä¸»è¦è§£å†³ä¸€ç»„çº¿æ€§åŒä½™æ–¹ç¨‹ç»„çš„æ±‚è§£é—®é¢˜ï¼Œå³ï¼š ç»™å®šå¤šä¸ªæ¨¡æ•°å’Œå¯¹åº”çš„ä½™æ•°ï¼Œæ±‚ä¸€ä¸ªæ•´æ•° x ä½¿å¾—å®ƒåŒæ—¶æ»¡è¶³æ‰€æœ‰è¿™äº›åŒä½™æ¡ä»¶ã€‚ç®€å•åœ°è¯´å°±æ˜¯çº¿æ€§æ¨¡æ–¹ç¨‹ç»„æ±‚è§£ã€‚ {xâ‰¡a1(modm1)xâ‰¡a2(modm2)â‹®xâ‰¡ak(modmk) \\begin{cases} x \\equiv a_1 \\pmod{m_1} \\\\ x \\equiv a_2 \\pmod{m_2} \\\\ \\vdots \\\\ x \\equiv a_k \\pmod{m_k} \\end{cases} â©â¨â§â€‹xâ‰¡a1â€‹(modm1â€‹)xâ‰¡a2â€‹(modm2â€‹)â‹®xâ‰¡akâ€‹(modmkâ€‹)â€‹å‡è®¾ $m_1,m_2,â€¦,m_k$ ä¸¤ä¸¤äº’è´¨ï¼Œé‚£ä¹ˆæ–¹ç¨‹ç»„åœ¨æ¨¡ $M=m_1m_2â€¦m_k$ ç©ºé—´ä¸‹æœ‰å”¯ä¸€è§£ã€‚ å”¯ä¸€è§£ æ³¨æ„ï¼šè¿™é‡Œçš„å”¯ä¸€è§£å¹¶ä¸æ˜¯è¯´ x åªæœ‰å”¯ä¸€å€¼ ï¼Œè€Œæ˜¯è¯´åœ¨æ¨¡ M ç©ºé—´ä¸‹ x å”¯ä¸€ã€‚ è§£æ–¹ç¨‹ç»„æ­¥éª¤ï¼š è®¡ç®— $M$ å’Œ $M_i$ $M=m_1m_2â€¦m_k$ $M_i=M / m_i$ è®¡ç®— $M_i$ åœ¨æ¨¡ $m_i$ ä¸‹çš„ä¹˜æ³•é€†å…ƒ $M_i^{-1}$ ï¼Œ$M_i Â· M_i^{-1} â‰¡ 1 (mod , m_i)$ è®¡ç®— $c_i=M_i \\times (M_i^{-1} \\mod m_i)$ $x = \\sum{c_i \\times a_i (mod , M)}$ ç»“æœä¸º M*k+ xï¼Œk ä¸ºä»»æ„æ•´æ•° ä¾‹ï¼šæ‰¾å‡ºè¢«9,8,7é™¤æ—¶ï¼Œä½™æ•°åˆ†åˆ«ä¸º1,2,3çš„ x {xâ‰¡1(mod9)xâ‰¡2(mod8)xâ‰¡3(mod7) \\begin{cases} x \\equiv 1 \\pmod{9} \\\\ x \\equiv 2 \\pmod{8} \\\\ x \\equiv 3 \\pmod{7} \\end{cases} â©â¨â§â€‹xâ‰¡1(mod9)xâ‰¡2(mod8)xâ‰¡3(mod7)â€‹ $M=9\\times8\\times7=504$ $M_1=56,M_2=63,M_3=72$ è®¡ç®—é€†å…ƒ $56\\times M_1^{-1}=9N+1 \\rightarrow M_1^{-1}=5$ $63\\times M_2^{-1}=8N+1 \\rightarrow M_2^{-1}=7$ $72\\times M_3^{-1}=7N+1 \\rightarrow M_3^{-1}=4$ è®¡ç®— c $c_1=56 \\times (5 \\mod 9)=280$ $c_2=63 \\times (7 \\mod 8)=441$ $c_3=72 \\times (4 \\mod 7)=288$ æ±‚å’Œ $x=1280+2441+3*288=2026 \\mod 504 = 10$ ç»“æœä¸º 504k+10 ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ä¸­å›½ä½™æ•°å®šç†"},{"categories":null,"content":" RSAç®—æ³• éšæœºæŒ‘ä¸¤ä¸ªå¤§ç´ æ•° p å’Œ q $n=pq$ ä¸” $\\phi(n)=(p-1)(q-1)$ æ‰¾ä¸€ä¸ª e ä½¿å¾— $gcd(e, \\phi(n)) = 1$ ï¼Œä¹Ÿå°±æ˜¯æ‰¾ä¸€ä¸ªå’Œ $\\phi(n)$ äº’è´¨çš„æ•° è®¡ç®—æ¨¡ $\\phi(n)$ ç©ºé—´ä¸‹ e çš„é€†å…ƒ d ä½¿å¾—ï¼š$ed \\equiv 1 (mod , \\phi(n))$ å…¬é’¥ (n, e)ï¼Œç§é’¥ (n, d)ã€‚çŸ¥é“äº† e ä½†æ˜¯ä¸çŸ¥é“ p å’Œ q æ²¡æ³•æ¨å‡ºé€†å…ƒ Note RSA åŠ å¯†ç³»ç»Ÿçš„å®‰å…¨æ€§ä¸»è¦æ¥æºäºå¯¹å¤§æ•´æ•°è¿›è¡Œå› å¼åˆ†è§£çš„å›°éš¾æ€§ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#rsaç®—æ³•"},{"categories":null,"content":" ç´ æ•°ç®—æ³• ç®€å•ç´ æ•°æµ‹è¯•åˆ¤æ–­ n æ˜¯ä¸æ˜¯ç´ æ•°ï¼Œåªè¦ç”¨ $2,â€¦,\\sqrt{n}$ å’Œå®ƒè¿›è¡Œé™¤æ³•å°±çŸ¥é“äº†ã€‚ ä¼ªç´ æ•°æµ‹è¯•æ ¹æ® Fermat å°å®šç†ï¼šè‹¥ p æ˜¯ç´ æ•°ï¼Œåˆ™å¯¹ä»»æ„æ•´æ•° a æ»¡è¶³ p ä¸æ•´é™¤ aï¼Œæœ‰ $a^{pâˆ’1} â‰¡ 1 (mod , p)$ã€‚æ‰€ä»¥æˆ‘ä»¬å°±æƒ³åˆ°å®ƒçš„é€†å¦å‘½é¢˜ï¼Œå¯¹ä»»æ„æ•´æ•° aï¼Œä¸” p æ•´é™¤ aï¼Œå‡å¦‚ $a^{pâˆ’1} \\not\\equiv 1 (mod , p)$ï¼Œé‚£ä¹ˆ p ä¸æ˜¯ç´ æ•°ã€‚å¦‚æœç­‰å¼æˆç«‹ï¼Œé‚£ä¹ˆåˆ™ç§° p æ˜¯ä¸€ä¸ªåŸºä¸º a çš„ä¼ªç´ æ•°ã€‚ æ•´é™¤çš„æ¦‚å¿µæ˜¯ï¼šå¦‚æœå­˜åœ¨æ•´æ•° kï¼Œä½¿å¾— $a = b \\cdot k$ï¼Œé‚£ä¹ˆç§° b æ•´é™¤ aã€‚ é‚£ä¹ˆç§° bbb æ•´é™¤ aaaï¼Œè®°ä½œï¼š python def pseudo_prime(n): return math.pow(2, n-1) % n == 1 é”™åˆ¤åˆæ•°ä¸ºç´ æ•°ï¼šCarmichael æ•°ï¼ˆ561ã€1105ã€1729â€¦â€¦ï¼‰ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:5","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç´ æ•°ç®—æ³•"},{"categories":null,"content":" ç´ æ•°ç®—æ³• ç®€å•ç´ æ•°æµ‹è¯•åˆ¤æ–­ n æ˜¯ä¸æ˜¯ç´ æ•°ï¼Œåªè¦ç”¨ $2,â€¦,\\sqrt{n}$ å’Œå®ƒè¿›è¡Œé™¤æ³•å°±çŸ¥é“äº†ã€‚ ä¼ªç´ æ•°æµ‹è¯•æ ¹æ® Fermat å°å®šç†ï¼šè‹¥ p æ˜¯ç´ æ•°ï¼Œåˆ™å¯¹ä»»æ„æ•´æ•° a æ»¡è¶³ p ä¸æ•´é™¤ aï¼Œæœ‰ $a^{pâˆ’1} â‰¡ 1 (mod , p)$ã€‚æ‰€ä»¥æˆ‘ä»¬å°±æƒ³åˆ°å®ƒçš„é€†å¦å‘½é¢˜ï¼Œå¯¹ä»»æ„æ•´æ•° aï¼Œä¸” p æ•´é™¤ aï¼Œå‡å¦‚ $a^{pâˆ’1} \\not\\equiv 1 (mod , p)$ï¼Œé‚£ä¹ˆ p ä¸æ˜¯ç´ æ•°ã€‚å¦‚æœç­‰å¼æˆç«‹ï¼Œé‚£ä¹ˆåˆ™ç§° p æ˜¯ä¸€ä¸ªåŸºä¸º a çš„ä¼ªç´ æ•°ã€‚ æ•´é™¤çš„æ¦‚å¿µæ˜¯ï¼šå¦‚æœå­˜åœ¨æ•´æ•° kï¼Œä½¿å¾— $a = b \\cdot k$ï¼Œé‚£ä¹ˆç§° b æ•´é™¤ aã€‚ é‚£ä¹ˆç§° bbb æ•´é™¤ aaaï¼Œè®°ä½œï¼š python def pseudo_prime(n): return math.pow(2, n-1) % n == 1 é”™åˆ¤åˆæ•°ä¸ºç´ æ•°ï¼šCarmichael æ•°ï¼ˆ561ã€1105ã€1729â€¦â€¦ï¼‰ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:5","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç®€å•ç´ æ•°æµ‹è¯•"},{"categories":null,"content":" ç´ æ•°ç®—æ³• ç®€å•ç´ æ•°æµ‹è¯•åˆ¤æ–­ n æ˜¯ä¸æ˜¯ç´ æ•°ï¼Œåªè¦ç”¨ $2,â€¦,\\sqrt{n}$ å’Œå®ƒè¿›è¡Œé™¤æ³•å°±çŸ¥é“äº†ã€‚ ä¼ªç´ æ•°æµ‹è¯•æ ¹æ® Fermat å°å®šç†ï¼šè‹¥ p æ˜¯ç´ æ•°ï¼Œåˆ™å¯¹ä»»æ„æ•´æ•° a æ»¡è¶³ p ä¸æ•´é™¤ aï¼Œæœ‰ $a^{pâˆ’1} â‰¡ 1 (mod , p)$ã€‚æ‰€ä»¥æˆ‘ä»¬å°±æƒ³åˆ°å®ƒçš„é€†å¦å‘½é¢˜ï¼Œå¯¹ä»»æ„æ•´æ•° aï¼Œä¸” p æ•´é™¤ aï¼Œå‡å¦‚ $a^{pâˆ’1} \\not\\equiv 1 (mod , p)$ï¼Œé‚£ä¹ˆ p ä¸æ˜¯ç´ æ•°ã€‚å¦‚æœç­‰å¼æˆç«‹ï¼Œé‚£ä¹ˆåˆ™ç§° p æ˜¯ä¸€ä¸ªåŸºä¸º a çš„ä¼ªç´ æ•°ã€‚ æ•´é™¤çš„æ¦‚å¿µæ˜¯ï¼šå¦‚æœå­˜åœ¨æ•´æ•° kï¼Œä½¿å¾— $a = b \\cdot k$ï¼Œé‚£ä¹ˆç§° b æ•´é™¤ aã€‚ é‚£ä¹ˆç§° bbb æ•´é™¤ aaaï¼Œè®°ä½œï¼š python def pseudo_prime(n): return math.pow(2, n-1) % n == 1 é”™åˆ¤åˆæ•°ä¸ºç´ æ•°ï¼šCarmichael æ•°ï¼ˆ561ã€1105ã€1729â€¦â€¦ï¼‰ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:5","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ä¼ªç´ æ•°æµ‹è¯•"},{"categories":null,"content":" MRç®—æ³•Fermat æµ‹è¯•çš„é—®é¢˜åœ¨äºï¼šå­˜åœ¨ Carmichael æ•°ï¼Œä½¿æ‰€æœ‰ a éƒ½é€šè¿‡æµ‹è¯•ã€‚MR çš„æ”¹è¿›åœ¨äºï¼šå¯¹ä»»æ„åˆæ•° nï¼Œä¸ä¼šå¯¹æ‰€æœ‰ a éƒ½â€œä¼ªè£…æˆåŠŸâ€ã€‚è‹¥ n æ˜¯åˆæ•°ï¼Œåˆ™è‡³å°‘ 3/4 çš„ a èƒ½åœ¨ MR æµ‹è¯•ä¸­æš´éœ² n æ˜¯åˆæ•°ã€‚å› æ­¤ MR ç»™å‡ºäº†ä¸€ä¸ªç»Ÿä¸€çš„é”™è¯¯æ¦‚ç‡ä¸Šç•Œï¼Œè€Œ Fermat æµ‹è¯•æ²¡æœ‰ã€‚ æ ¹æ®æ•´æ•°åˆ†è§£å®šç†ï¼Œä»»æ„æ•´æ•°éƒ½å¯ä»¥å”¯ä¸€çš„åˆ†è§£ä¸º 2 çš„è‹¥å¹²æ¬¡å¹‚ Ã— ä¸€ä¸ªå¥‡æ•°ï¼Œæ‰€ä»¥ä»¤ $n-1 = 2^s \\times d$ æ£€æŸ¥ ${a^d, a^{2d}, a^{4d}, â€¦, a^{2^{sâˆ’1}d}}$ï¼Œå¦‚æœ å‡ºç° âˆ’1ï¼ˆmod nï¼‰ï¼Œå°±ç¬¦åˆç´ æ•°åº”æœ‰çš„è¡Œä¸ºï¼› ä½†æ˜¯ ä»ç„¶ä¼šå‡ºç°é”™åˆ¤ç´ æ•°ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(T \\times \\lg{N})$ï¼ŒT æ˜¯æ£€æµ‹è½®æ¬¡ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:17:6","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#mrç®—æ³•"},{"categories":null,"content":" ç¬¬ä¸‰åäºŒç«  ä¸²åŒ¹é… ä»€ä¹ˆæ˜¯ä¸²åŒ¹é…é—®é¢˜ ç»™å®šä¸€ä¸ªæ–‡æœ¬ä¸² $T = t_1t_2 \\dots t_n$ ï¼Œé•¿åº¦ä¸º nï¼› ç»™å®šä¸€ä¸ªæ¨¡å¼ä¸² $P = p_1p_2 \\dots p_m$ï¼Œé•¿åº¦ä¸º mï¼› è¦æ±‚æ‰¾å‡ºæ‰€æœ‰æ»¡è¶³ $T[s+1 â€¦ s+m] = P[1 â€¦ m]$ çš„ä½ç½® sã€‚ ç®—æ³• é¢„å¤„ç† åŒ¹é…(æœ€åæƒ…å†µ) æš´åŠ› 0 $O(nm)$ Rabin-Karp $O(m)$ æ¨¡å¼ä¸²ç®—å“ˆå¸Œ $O(nm)$ æœ‰é™è‡ªåŠ¨æœº $O(m\\vert \\sum \\vert)$ $O(n)$ KMP $O(m)$ $O(n)$ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:18:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬ä¸‰åäºŒç« -ä¸²åŒ¹é…"},{"categories":null,"content":" æœ´ç´  python for i in range(n): for j in range(m): if T[i+j] != P[j]: break æœ€åæƒ…å†µä¸‹æ—¶é—´å¤æ‚åº¦ $O(nm)$ æœ€åæƒ…å†µä¸‹æ—¶é—´å¤æ‚åº¦ $O(n)$ï¼Œæ¯æ¬¡ç¬¬ä¸€ä¸ªå­—ç¬¦å°±å¤±é… Note æœ€åæƒ…å†µæ—¶é—´å¤æ‚åº¦ä¸æ˜¯ $O(m)$ï¼Œå› ä¸ºå‡å¦‚ç¬¬ä¸€æ¬¡å°±åŒ¹é…æˆåŠŸï¼Œåé¢è¿˜éœ€è¦åŒ¹é…ï¼Œä¸²åŒ¹é…é—®é¢˜è¦æ±‚æ‰¾åˆ°æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ä½ç½®ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:18:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æœ´ç´ "},{"categories":null,"content":" Rabin-KarpRabin-Karp ç®—æ³•å…ˆæ˜¯æ¯”è¾ƒæ¨¡å¼ä¸² P ä¸æ–‡æœ¬å­ä¸² T[s+1 â€¦ s+m] çš„å“ˆå¸Œå€¼ï¼Œåªæœ‰å½“å“ˆå¸Œå€¼ç›¸ç­‰æ—¶ï¼Œæ‰è¿›è¡Œä¸€æ¬¡é€å­—ç¬¦éªŒè¯ï¼Œè¿™æ˜¯ä¸€ç§â€œå…ˆç²—ç­›ã€å†ç²¾æŸ¥â€çš„æ€æƒ³ã€‚å“ˆå¸Œå‡½æ•°ä¸ºï¼š Hash(T)=(T[0]âˆ—pnâˆ’1+T[1]âˆ—pnâˆ’2+â‹¯+T[nâˆ’2]âˆ—p+T[nâˆ’1])%q Hash(T) = (T[0]*p^{n-1}+T[1]*p^{n-2}+ \\dots + T[n-2]*p + T[n-1]) \\% q Hash(T)=(T[0]âˆ—pnâˆ’1+T[1]âˆ—pnâˆ’2+â‹¯+T[nâˆ’2]âˆ—p+T[nâˆ’1])%q q æ˜¯ä¸€ä¸ªå¤§ç´ æ•°ç”¨äºå–æ¨¡ d è¦æ±‚å¤§äºå­—æ¯è¡¨å¤§å°ï¼Œå¦‚ ASCII å¯ä»¥å– 256 python for i in range(n): if not hash(T[i;i+m], P): continue for j in range(m): if T[i+j] != P[j]: break æœ€åæƒ…å†µæ—¶é—´å¤æ‚åº¦ $O(nm)$ï¼Œæ¯ä¸ªå“ˆå¸Œå€¼éƒ½ç¬¦åˆ æœ€å¥½æƒ…å†µæ—¶é—´å¤æ‚åº¦ $O(n+m)$ï¼Œå“ˆå¸Œæ—¶é—´+åŒ¹é…æ—¶é—´ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:18:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#rabin-karp"},{"categories":null,"content":" æœ‰é™è‡ªåŠ¨æœºå°†æ¨¡å¼ä¸² P æ„é€ æˆä¸€ä¸ªç¡®å®šæœ‰é™è‡ªåŠ¨æœºï¼ˆDFAï¼‰ï¼Œåœ¨æ‰«ææ–‡æœ¬æ—¶ï¼š â€¢æ¯è¯»å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œåªè¿›è¡Œä¸€æ¬¡çŠ¶æ€è½¬ç§»ï¼Œä¸å›é€€æ–‡æœ¬æŒ‡é’ˆã€‚ å…·ä½“ä¾‹å­ï¼šæ¨¡å¼ä¸² P = â€œaabâ€ å­—æ¯è¡¨ Î£ = {a, b} å½“å‰çŠ¶æ€ q è¾“å…¥ a è¾“å…¥ b 0 \" â€œ(ç©º) + a = â€œaâ€ â†’ æœ€é•¿å…¬å…±å‰åç¼€ â€œaâ€ â†’ 1 \" \" + b = â€œbâ€ â†’ æ—  â†’ 0 1 â€œaâ€(P[0:0]) + a = â€œaaâ€ â†’ æœ€é•¿å…¬å…±å‰åç¼€ â€œaaâ€ â†’ 2 â€œaâ€ + b = â€œabâ€ â†’ æ—  â†’ 0 2 â€œaaâ€(P[0:1]) + a = â€œaaaâ€ â†’ æœ€é•¿å…¬å…±å‰åç¼€ â€œaaâ€ æ˜¯å‰ç¼€ â†’ 2 â€œaaâ€ + b = â€œaabâ€ â†’ æœ€é•¿åç¼€ â€œaabâ€ æ˜¯å‰ç¼€ â†’ 3 3 â€œaabâ€(P[0:2]) + a = â€œaabaâ€ â†’ æœ€é•¿å…¬å…±å‰åç¼€ â€œaâ€ æ˜¯å‰ç¼€ â†’ 1 â€œaabâ€ + b = â€œaabbâ€ â†’ æ—  â†’ 0 è¿™é‡Œæœ€é•¿å…¬å…±å‰åç¼€æŒ‡çš„æ˜¯ï¼Œâ€œaabaâ€ çš„åç¼€å’Œæ¨¡å¼ä¸² â€œaabâ€ çš„å‰ç¼€æœ€é•¿åŒ¹é… æœ€ç»ˆè½¬ç§»è¡¨ï¼š çŠ¶æ€ è¾“å…¥ a b 0 1 0 1 2 0 2 2 3 3 1 0 åŒ¹é…ç¤ºä¾‹ï¼š æ–‡æœ¬ T = â€œaabaabâ€ï¼ˆé•¿åº¦ 6ï¼‰ ä½ç½® i è¯»å…¥å­—ç¬¦ å½“å‰çŠ¶æ€ æ–°çŠ¶æ€ æ˜¯å¦åŒ¹é… 0 a 0 1 1 a 1 2 2 b 2 3 æ˜¯ï¼ˆä½ç½® 0-2: â€œaabâ€ï¼‰ 3 a 3 1 4 a 1 2 5 b 2 3 æ˜¯ï¼ˆä½ç½® 3-5: â€œaabâ€ï¼‰ å¦‚ä½•ç”»å›¾ï¼š é¢„å¤„ç†æ—¶é—´ï¼š$O(m\\vert \\sum \\vert)$ å¤„ç†æ—¶é—´ï¼š$O(n)$ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:18:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#æœ‰é™è‡ªåŠ¨æœº"},{"categories":null,"content":" KMPKMP çš„æœ¬è´¨æ˜¯ï¼šåœ¨å‘ç”Ÿå¤±é…æ—¶ï¼Œä¸å›é€€æ–‡æœ¬æŒ‡é’ˆï¼Œ è€Œæ˜¯æ ¹æ®å·²ç»åŒ¹é…çš„ä¿¡æ¯ï¼Œå†³å®šæ¨¡å¼ä¸²åº”å½“ç§»åŠ¨åˆ°å“ªé‡Œã€‚ é¦–å…ˆæ¥çœ‹ next æ•°ç»„çš„ä½œç”¨ï¼šå®ƒå‘Šè¯‰æˆ‘ä»¬å½“ä¸»ä¸²å’Œæ¨¡å¼ä¸²å¤±é…æ—¶å€™ï¼Œä¸»ä¸²åº”è¯¥é€€å›åˆ°ä»€ä¹ˆé—®é¢˜ å¦‚å›¾ï¼Œå½“ä¸»ä¸²å’Œå­ä¸²åœ¨ i=4 å¤±é…æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹å‰ä¸€ä½çš„ nextæ•°ç»„ next[3]=2 å°±çŸ¥é“ï¼Œå®ƒæ ‡å¿—ç€æˆ‘ä»¬åº”è¯¥è·³è¿‡å‡ ä¸ªå…ƒç´ ï¼Œä¾‹å¦‚è¿™é‡Œå‘Šè¯‰æˆ‘ä»¬è·³è¿‡ä¸¤ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥æ¨¡å¼ä¸²å›åˆ°ç¬¬ä¸‰ä½ T[2]ï¼Œä¸»ä¸²å’Œæ¨¡å¼ä¸²çš„å‰ 2 ä½éƒ½ç›¸åŒç›´æ¥è·³è¿‡ã€‚ python def kmp(string, pattern, next): i, j = 0, 0 n, m = len(string), len(pattern) while i \u003c n: if string[i] == pattern[j]: i += 1 j += 1 elif j \u003e 0: j = next[j-1] else: i += 1 if j == len(pattern): return i - j é‚£ next æ•°ç»„æ€ä¹ˆå¾—åˆ°å‘¢ï¼Ÿ æˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆå¯ä»¥ç”¨ next æ•°ç»„åœ¨å¤±é…æ—¶å›é€€å‘¢ï¼Ÿå› ä¸ºåœ¨ i=4 å¤±é…æ—¶å€™ï¼Œæ¨¡å¼ä¸²å¤±é…å¤„ C å‰ä¸¤ä½ï¼ˆä¹Ÿå°±æ˜¯ä¸»ä¸²å¤±é…å¤„ A çš„å‰ä¸¤ä½ï¼‰AB å’Œæ¨¡å¼ä¸²å‰ä¸¤ä½ AB ç›¸åŒã€‚æ¢å¥è¯è¯´ï¼Œå‡å¦‚æ¨¡å¼ä¸²çš„æŸä¸ªä½ç½®å¤±é…çš„æ—¶å€™ï¼Œå¤±é…å¤„å‰ i ä½ï¼ˆä¹Ÿå°±æ˜¯ä¸»ä¸²å¤±é…å¤„å‰ i ä½ï¼‰å¦‚æœå’Œæ¨¡å¼ä¸²å‰ i ä½ä¸€æ ·å°±èƒ½è·³è¿‡äº†ã€‚é‚£æˆ‘ä»¬åªéœ€è¦çœ‹æ¨¡å¼ä¸²çš„æœ€é•¿å…¬å…±å‰åç¼€å°±å¥½äº†ã€‚ å¯¹äº next æ•°ç»„ï¼Œæˆ‘ä»¬å›ºå®šç¬¬ä¸€ä½æ˜¯ 0ï¼š ä»ç¬¬äºŒä½ B å¼€å§‹ï¼Œç”±äº Aã€B æ²¡æœ‰å…¬å…±å‰åç¼€ï¼Œæ‰€ä»¥æ˜¯ 0 ç¬¬ä¸‰ä½ Aï¼ŒAã€Bã€A çš„æœ€é•¿å…¬å…±å‰åç¼€æ˜¯ Aï¼Œæ‰€ä»¥å¯ä»¥è·³è¿‡ 1 ä¸ª â€¦ é‚£ä»£ç åº”è¯¥æ€ä¹ˆå†™å‘¢ï¼Ÿä¸å¯èƒ½æš´åŠ›æ±‚å…¬å…±å‰åç¼€å§ï¼Ÿ å¦‚å›¾å½“æˆ‘ä»¬éœ€è¦æ±‚ next[6] æ—¶å€™ï¼Œå·²ç»çŸ¥é“å‰ 6 ä½çš„æœ€é•¿å…¬å…±å‰åç¼€æ˜¯ 2 äº†ï¼Œæ‰€ä»¥å¦‚æœ pattern[6] å’Œ pattern[2] ç›¸åŒï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ç»§ç»­å‘åèµ°äº†ã€‚é‚£å¦‚æœä¸ç›¸åŒå‘¢ï¼Ÿ è¿™é‡Œå¯ä»¥çœ‹åˆ° pattern[3] å’Œ pattern[7] ä¸åŒï¼Œæ—¢ç„¶ ABA æ²¡åŠæ³•å’Œä¸‹ä¸€ä¸ªå­—ç¬¦ç»„æˆæœ€é•¿å…¬å…±å‰åç¼€ï¼Œé‚£æˆ‘ä»¬çœ‹çœ‹æœ‰æ²¡æœ‰æ›´çŸ­çš„ï¼Œæ¯”å¦‚å‰ç¼€ AB å’Œåç¼€ AB ç›¸åŒã€‚è¿™æ—¶å€™æˆ‘ä»¬åˆä¸å¾—ä¸æš´åŠ›æœç´¢äº†å—ï¼Ÿ è¿™é‡Œæˆ‘ä»¬è¿˜çŸ¥é“ä¸€ä¸ªä¿¡æ¯ï¼Œå°±æ˜¯å‰é¢æœ€é•¿å…¬å…±å‰åç¼€æ˜¯ 3ã€‚æ—¢ç„¶æˆ‘ä»¬åªèƒ½æ‰¾æ¯” 3 æ›´çŸ­çš„å…¬å…±å‰åç¼€ï¼Œæˆ–è€…è¯´åœ¨ ABA é‡Œé¢æ‰¾ pattern[7]=B çš„æœ€é•¿åˆšåˆšå‰åç¼€ï¼Œé‚£ä¹ˆæŠŠ B æ”¾åœ¨ C çš„ä½ç½®ä¸Šæ¥çœ‹å°±è¡Œäº†ã€‚è¿™æ—¶å€™æˆ‘ä»¬çœ‹åˆ° C å‰é¢ A çš„ next å€¼ä¸º 1ï¼Œä¹Ÿå°±æ˜¯ ABA çš„æœ€é•¿å…¬å…±å‰åç¼€æ˜¯ 1ï¼Œè¿™æ—¶å€™åŠ ä¸Š Bï¼Œpattern[1] ä¹Ÿæ˜¯ B æ‰€ä»¥åŒ¹é…äº†ã€‚ python def get_next(pattern): next = [0] prefix_len = 0 i = 1 while i \u003c len(pattern): if pattern[i] == pattern[prefix_len]: prefix_len += 1 i += 1 next.append(prefix_len) else: if prefix_len == 0: next.append(prefix_len) i += 1 else: prefix_len = next[prefix_len - 1] # åªéœ€è¦æ”¹ä¸€ä¸‹prefix_lenå°±å¯ä»¥åˆ°Cçš„ä½ç½® return next ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:18:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#kmp"},{"categories":null,"content":" ç¬¬ä¸‰åå››ç«  æ¨¡å‹å’ŒNPC","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:19:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬ä¸‰åå››ç« -æ¨¡å‹å’Œnpc"},{"categories":null,"content":" å›¾çµæœºæ¨¡å‹å›¾çµæœºæ˜¯ä¸€ç§æŠ½è±¡çš„è®¡ç®—æ¨¡å‹ï¼Œå®ƒå°±åƒä¸€å°æœ€ç®€å•çš„â€œç”µè„‘åŸå‹â€ï¼Œç”¨æ¥æè¿°â€œä»€ä¹ˆé—®é¢˜æ˜¯å¯ä»¥ç”¨ç®—æ³•è§£å†³çš„â€ã€‚æœºå™¨å¯åŠ¨åï¼Œå°±æŒ‰ç…§æŒ‡ä»¤è¡¨ä¸€æ­¥æ­¥æ‰§è¡Œï¼š è¯» â†’ å†™ â†’ ç§»åŠ¨ â†’ æ¢çŠ¶æ€ â†’ é‡å¤â€¦â€¦ ç›´åˆ°è¿›å…¥â€œåœæœºçŠ¶æ€â€ï¼Œå°±åœä¸‹æ¥ï¼Œçº¸å¸¦ä¸Šå‰©ä¸‹çš„å†…å®¹å°±æ˜¯è¾“å‡ºç»“æœã€‚ ç¡®å®šæ€§å›¾çµæœºï¼ˆDTMï¼‰ï¼šæ¯ä¸€æ­¥éƒ½åªæœ‰å”¯ä¸€çš„é€‰æ‹©ï¼Œåƒæ™®é€šç¨‹åºï¼Œæ­»æ¿ä½†å¯é ã€‚ éç¡®å®šæ€§å›¾çµæœºï¼ˆNDTMï¼‰ï¼šæ¯ä¸€æ­¥å¯ä»¥æœ‰å¤šä¸ªé€‰æ‹©ï¼Œå®ƒä¼šâ€œåŒæ—¶å°è¯•æ‰€æœ‰å¯èƒ½â€ï¼ˆåƒå¹³è¡Œå®‡å®™ï¼‰ï¼Œåªè¦æœ‰ä¸€æ¡è·¯æˆåŠŸå°±ç®—æˆåŠŸã€‚å®é™…ç”µè„‘è¦æ¨¡æ‹Ÿå®ƒä¼šæ…¢å¾ˆå¤šã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:19:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å›¾çµæœºæ¨¡å‹"},{"categories":null,"content":" è¯­è¨€è¯†åˆ«èƒ½åŠ›åœ¨è®¡ç®—ç†è®ºé‡Œï¼Œæˆ‘ä»¬å¸¸æŠŠé—®é¢˜è½¬åŒ–ä¸ºâ€œè¯†åˆ«ä¸€ç§è¯­è¨€â€çš„é—®é¢˜ã€‚è¿™é‡Œçš„â€œè¯­è¨€â€ä¸æ˜¯ä¸­æ–‡è‹±è¯­ï¼Œè€Œæ˜¯ä¸€å †å­—ç¬¦ä¸²çš„é›†åˆã€‚ æ¯”å¦‚ï¼šâ€œæ‰€æœ‰ç”±ç­‰æ•°é‡çš„aå’Œbç»„æˆçš„å­—ç¬¦ä¸²â€ï¼Œåƒï¼šabbaã€aabbã€ababbbab ç­‰ï¼Œè¿™å°±æ˜¯ä¸€ç§â€œè¯­è¨€â€ã€‚ é—®é¢˜å°±æ˜¯ï¼šç»™ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæœºå™¨èƒ½ä¸èƒ½åˆ¤æ–­å®ƒæ˜¯å¦å±äºè¿™ä¸ªè¯­è¨€ï¼Ÿï¼ˆæ˜¯â†’æ¥å—ï¼Œå¦â†’æ‹’ç»ï¼‰ æœ‰é™è‡ªåŠ¨æœº åªèƒ½è¯†åˆ«å¾ˆç®€å•ã€æ²¡æœ‰åµŒå¥—çš„æ¨¡å¼ã€‚ ä¾‹å­ï¼šæ‰€æœ‰ä»¥â€œabcâ€å¼€å¤´çš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…â€œå…¨æ˜¯0å’Œ1ï¼Œä¸”ä»¥1ç»“å°¾â€çš„äºŒè¿›åˆ¶æ•°ã€‚ ä¸èƒ½å¤„ç†æ‹¬å·åŒ¹é…é‚£ç§éœ€è¦â€œè®°å¿†â€çš„ä¸œè¥¿ã€‚ ä¸‹æ¨è‡ªåŠ¨æœºï¼ˆåŠ äº†ä¸ªæ ˆå†…å­˜ï¼‰ èƒ½å¤„ç†æ‹¬å·åµŒå¥—ã€å›æ–‡ä¸²è¿™ç±»ã€‚ ç»å…¸ä¾‹å­ï¼š{ a^n b^n } â†’ aaabbb è¿™ç§â€œå‰åŠaå’ŒååŠbæ•°é‡ç›¸ç­‰â€ã€‚ èƒ½æ£€æŸ¥ä»£ç é‡Œçš„æ‹¬å·æ˜¯å¦åŒ¹é…ã€‚ çº¿æ€§æœ‰ç•Œè‡ªåŠ¨æœº æ›´å¼ºï¼Œèƒ½å¤„ç† a^n b^n c^n è¿™ç§â€œä¸‰éƒ¨åˆ†æ•°é‡ç›¸ç­‰â€çš„ã€‚ å›¾çµæœº å‡ ä¹ä»€ä¹ˆéƒ½èƒ½è¯†åˆ«ï¼ŒåŒ…æ‹¬ä¸Šé¢æ‰€æœ‰ï¼Œè¿˜èƒ½å¤„ç†æ›´å¤æ‚çš„ï¼ˆç”šè‡³èƒ½æ¨¡æ‹Ÿå…¶ä»–æ‰€æœ‰æœºå™¨ï¼‰ã€‚ ä½†æœ‰äº›é—®é¢˜è¿å›¾çµæœºéƒ½åˆ¤æ–­ä¸äº†ï¼ˆæ¯”å¦‚è‘—åçš„â€œåœæœºé—®é¢˜â€ï¼šç»™ä¸€æ®µç¨‹åºå’Œè¾“å…¥ï¼Œèƒ½ä¸èƒ½é¢„æµ‹å®ƒä¼šä¸ä¼šæ­»å¾ªç¯ï¼Ÿï¼‰ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:19:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#è¯­è¨€è¯†åˆ«èƒ½åŠ›"},{"categories":null,"content":" Pã€NPã€NP å®Œå…¨ P é—®é¢˜ï¼šå›¾çµæœºå¯ä»¥åœ¨å¤šé¡¹å¼æ—¶é—´å†…è§£å†³çš„é—®é¢˜ NP é—®é¢˜ï¼šå›¾çµæœºå¯ä»¥åœ¨å¤šé¡¹å¼æ—¶é—´å†…éªŒè¯çš„é—®é¢˜ å¾ˆæ˜¾ç„¶ï¼Œæ‰€æœ‰çš„ P ç±»é—®é¢˜éƒ½æ˜¯ NP é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œèƒ½å¤šé¡¹å¼åœ°è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œå¿…ç„¶èƒ½å¤šé¡¹å¼åœ°éªŒè¯ä¸€ä¸ªé—®é¢˜çš„è§£â€”â€”æ—¢ç„¶æ­£è§£éƒ½å‡ºæ¥äº†ï¼ŒéªŒè¯ä»»æ„ç»™å®šçš„è§£ä¹Ÿåªéœ€è¦æ¯”è¾ƒä¸€ä¸‹å°±å¯ä»¥äº†ã€‚å…³é”®æ˜¯ï¼Œäººä»¬æƒ³çŸ¥é“ï¼Œæ˜¯å¦æ‰€æœ‰çš„ NP é—®é¢˜éƒ½æ˜¯ P ç±»é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥å†ç”¨é›†åˆçš„è§‚ç‚¹æ¥è¯´æ˜ã€‚å¦‚æœæŠŠæ‰€æœ‰ P ç±»é—®é¢˜å½’ä¸ºä¸€ä¸ªé›†åˆ P ä¸­ï¼ŒæŠŠæ‰€æœ‰ NP é—®é¢˜åˆ’è¿›å¦ä¸€ä¸ªé›†åˆ NP ä¸­ï¼Œé‚£ä¹ˆï¼Œæ˜¾ç„¶æœ‰ P å±äº NPã€‚ç°åœ¨ï¼Œæ‰€æœ‰å¯¹ NP é—®é¢˜çš„ç ”ç©¶éƒ½é›†ä¸­åœ¨ä¸€ä¸ªé—®é¢˜ä¸Šï¼Œå³ç©¶ç«Ÿæ˜¯å¦æœ‰ P=NPï¼Ÿé€šå¸¸æ‰€è°“çš„â€œNPé—®é¢˜â€ï¼Œå…¶å®å°±ä¸€å¥è¯ï¼šè¯æ˜æˆ–æ¨ç¿» P=NPã€‚ ä¸ºäº†è¯´æ˜NPCé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆå¼•å…¥ä¸€ä¸ªæ¦‚å¿µâ€”â€”çº¦åŒ–(Reducibilityï¼Œæœ‰çš„èµ„æ–™ä¸Šå«â€œå½’çº¦â€)ã€‚ç®€å•åœ°è¯´ï¼Œä¸€ä¸ªé—®é¢˜Aå¯ä»¥çº¦åŒ–ä¸ºé—®é¢˜Bçš„å«ä¹‰å³æ˜¯ï¼Œå¯ä»¥ç”¨é—®é¢˜Bçš„è§£æ³•è§£å†³é—®é¢˜Aï¼Œæˆ–è€…è¯´ï¼Œé—®é¢˜Aå¯ä»¥â€œå˜æˆâ€é—®é¢˜Bã€‚ä¾‹å¦‚ï¼šæ±‚è§£ä¸€ä¸ªä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹å¯ä»¥çº¦åŒ–ä¸ºæ±‚è§£ä¸€ä¸ªä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹ï¼Œå› ä¸ºåªè¦æŠŠäºŒæ¬¡å‹ç³»æ•°å›ºå®šä¸º 0 å°±å¯ä»¥äº†ã€‚ä»çº¦åŒ–çš„å®šä¹‰ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸€ä¸ªé—®é¢˜çº¦åŒ–ä¸ºå¦ä¸€ä¸ªé—®é¢˜ï¼Œæ—¶é—´å¤æ‚åº¦å¢åŠ äº†ï¼Œé—®é¢˜çš„åº”ç”¨èŒƒå›´ä¹Ÿå¢å¤§äº†ã€‚é€šè¿‡å¯¹æŸäº›é—®é¢˜çš„ä¸æ–­çº¦åŒ–ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä¸æ–­å¯»æ‰¾å¤æ‚åº¦æ›´é«˜ï¼Œä½†åº”ç”¨èŒƒå›´æ›´å¹¿çš„ç®—æ³•æ¥ä»£æ›¿å¤æ‚åº¦è™½ç„¶ä½ï¼Œä½†åªèƒ½ç”¨äºå¾ˆå°çš„ä¸€ç±»é—®é¢˜çš„ç®—æ³•ã€‚è‡ªç„¶åœ°ï¼Œæˆ‘ä»¬ä¼šæƒ³é—®ï¼Œå¦‚æœä¸æ–­åœ°çº¦åŒ–ä¸Šå»ï¼Œä¸æ–­æ‰¾åˆ°èƒ½â€œé€šåƒâ€è‹¥å¹²å°NPé—®é¢˜çš„ä¸€ä¸ªç¨å¤æ‚çš„å¤§NPé—®é¢˜ï¼Œé‚£ä¹ˆæœ€åæ˜¯å¦æœ‰å¯èƒ½æ‰¾åˆ°ä¸€ä¸ªæ—¶é—´å¤æ‚åº¦æœ€é«˜ï¼Œå¹¶ä¸”èƒ½â€œé€šåƒâ€æ‰€æœ‰çš„ NPé—®é¢˜çš„è¿™æ ·ä¸€ä¸ªè¶…çº§NPé—®é¢˜ï¼Ÿç­”æ¡ˆå±…ç„¶æ˜¯è‚¯å®šçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå­˜åœ¨è¿™æ ·ä¸€ä¸ªNPé—®é¢˜ï¼Œæ‰€æœ‰çš„NPé—®é¢˜éƒ½å¯ä»¥çº¦åŒ–æˆå®ƒã€‚æ¢å¥è¯è¯´ï¼Œåªè¦è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„NPé—®é¢˜éƒ½è§£å†³äº†ã€‚è¿™ç§é—®é¢˜çš„å­˜åœ¨éš¾ä»¥ç½®ä¿¡ï¼Œå¹¶ä¸”æ›´åŠ ä¸å¯æ€è®®çš„æ˜¯ï¼Œè¿™ç§é—®é¢˜ä¸åªä¸€ä¸ªï¼Œå®ƒæœ‰å¾ˆå¤šä¸ªï¼Œå®ƒæ˜¯ä¸€ç±»é—®é¢˜ã€‚è¿™ä¸€ç±»é—®é¢˜å°±æ˜¯ä¼ è¯´ä¸­çš„NPC é—®é¢˜ã€‚ æ‰€ä»¥ NPC é—®é¢˜çš„æ¡ä»¶å¦‚ä¸‹ï¼š æ˜¯ NP é—®é¢˜ æ‰€æœ‰ NP é—®é¢˜éƒ½å¯ä»¥çº¦åŒ–ä¸ºè¿™ä¸ªé—®é¢˜ æœ€å NP-Hard é—®é¢˜æŒ‡çš„æ˜¯ï¼Œä¸ä¸€å®šæ˜¯ NP é—®é¢˜çš„ NPCé—®é¢˜ï¼Œä¾‹å¦‚ â€åœæœºé—®é¢˜â€œ è¿™ç§æ²¡åŠæ³•éªŒè¯çš„é—®é¢˜ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:19:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#pnpnp-å®Œå…¨"},{"categories":null,"content":" SAT é—®é¢˜SATï¼ˆå¸ƒå°”å¯æ»¡è¶³æ€§é—®é¢˜ï¼‰ï¼šç»™å®šä¸€ä¸ªå¸ƒå°”å…¬å¼ï¼Œé—®ï¼šæ˜¯å¦å­˜åœ¨ä¸€ç§å˜é‡èµ‹å€¼ï¼Œä½¿æ•´ä¸ªå…¬å¼ä¸ºçœŸï¼Ÿä¾‹å¦‚ï¼š (x1âˆ¨Â¬x3âˆ¨x5)Â âˆ§Â (Â¬x2âˆ¨x4) (x_1 \\lor \\lnot x_3 \\lor x_5)\\ \\land\\ (\\lnot x_2 \\lor x_4) (x1â€‹âˆ¨Â¬x3â€‹âˆ¨x5â€‹)Â âˆ§Â (Â¬x2â€‹âˆ¨x4â€‹)2-SAT æŒ‡çš„æ˜¯æ¯ä¸€ä¸ªå­å¥ä¸­ï¼Œæœ€å¤šåªæœ‰ 2 ä¸ªæ–‡å­— çš„ SAT é—®é¢˜ï¼Œä¾‹å¦‚ï¼š$(x_1 \\lor x_2)\\land(\\lnot x_2 \\lor x_3)\\land(\\lnot x_1 \\lor \\lnot x_3)$ã€‚2-SAT å¯ä»¥ç”¨å¼ºè”é€šåˆ†é‡åœ¨çº¿æ€§æ—¶é—´è§£å†³ï¼Œæ‰€ä»¥æ˜¯ P é—®é¢˜ï¼Œä¸å±äº NP æˆ–è€… NPC é—®é¢˜ã€‚ Note NP å®Œå…¨é—®é¢˜æ„å‘³ç€ L âˆˆ NP å¹¶ä¸”æ‰€æœ‰ NP é—®é¢˜éƒ½èƒ½å¤šé¡¹å¼æ—¶é—´å½’çº¦åˆ° Lï¼Œå‡å¦‚ L æœ¬èº«èƒ½å¤šé¡¹å¼æ—¶é—´è§£å†³ï¼Œé‚£ä¹ˆ L âˆˆ Pï¼Œä¸ P â‰  NP çŸ›ç›¾äº†ã€‚ è€Œ 3-SAT æ— æ³•åœ¨å¤šé¡¹å¼æ—¶é—´å†…è§£å†³ï¼Œå±äº NP å’Œ NPC é—®é¢˜ã€‚ CIRCUIT-SAT ä¹Ÿæ˜¯ NP/NPC é—®é¢˜ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:19:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#sat-é—®é¢˜"},{"categories":null,"content":" ç¬¬ä¸‰åäº”ç«  è¿‘ä¼¼é—®é¢˜","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:20:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#ç¬¬ä¸‰åäº”ç« -è¿‘ä¼¼é—®é¢˜"},{"categories":null,"content":" å¤šé¡¹å¼æ—¶é—´è¿‘ä¼¼æ¨¡å¼å¾ˆå¤šä¼˜åŒ–é—®é¢˜ï¼šä¸æ˜¯ P é—®é¢˜ ï¼Œç”šè‡³æ˜¯ NP-hard ï¼Œä½†â€œç¨å¾®å·®ä¸€ç‚¹çš„è§£â€åœ¨å·¥ç¨‹ä¸Šæ˜¯å¯ä»¥æ¥å—çš„ã€‚PTAS çš„ç›®çš„å°±æ˜¯åœ¨å¤šé¡¹å¼æ—¶é—´å†…ï¼Œä¿è¯è§£â€œç¦»æœ€ä¼˜è§£ä¸å¤ªè¿œâ€ã€‚ å¯ä»¥è‡ªå·±æŒ‡å®šä¸€ä¸ªè¯¯å·®å‚æ•° Îµ \u003e 0ï¼ˆæ¯”å¦‚ Îµ = 0.01 è¡¨ç¤º 1% è¯¯å·®ï¼‰ã€‚ ç®—æ³•ä¿è¯ç»™å‡ºçš„è§£å’Œæœ€ä¼˜è§£çš„å·®è·ä¸è¶…è¿‡ Îµï¼š å¯¹äºæœ€å¤§åŒ–é—®é¢˜ï¼ˆå¦‚æœ€å¤§æ”¶ç›Šï¼‰ï¼šè§£ â‰¥ (1 - Îµ) Ã— æœ€ä¼˜å€¼ å¯¹äºæœ€å°åŒ–é—®é¢˜ï¼ˆå¦‚æœ€å°æˆæœ¬ï¼‰ï¼šè§£ â‰¤ (1 + Îµ) Ã— æœ€ä¼˜å€¼ å¯¹ä»»æ„å›ºå®šçš„ Îµï¼Œç®—æ³•è¿è¡Œæ—¶é—´æ˜¯è¾“å…¥è§„æ¨¡ n çš„å¤šé¡¹å¼ï¼ˆæ¯”å¦‚ O(nÂ³) æˆ– O(n^{1/Îµ}) ä¹‹ç±»çš„ï¼‰ã€‚ Note æ—¶é—´å¯ä»¥éšç€ 1/Îµ å¢é•¿å¾—å¾ˆå¿«ï¼ˆç”šè‡³æ˜¯æŒ‡æ•°çº§çš„ï¼Œæ¯”å¦‚ 2^{1/Îµ} Ã— nÂ²ï¼‰ï¼Œä½†åªè¦ Îµ å›ºå®šä¸‹æ¥ï¼Œæ—¶é—´å°±æ˜¯ n çš„å¤šé¡¹å¼ï¼Œä¸ä¼šå¤±æ§ã€‚ FPTAS å’Œ PTAS çš„åŒºåˆ«æ˜¯ï¼šFPTAS è¦æ±‚å¯¹ 1/Îµ éƒ½æ˜¯å¤šé¡¹å¼ï¼Œä¸èƒ½åƒä»€ä¹ˆä¸€æ ·æ˜¯æŒ‡æ•°ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:20:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#å¤šé¡¹å¼æ—¶é—´è¿‘ä¼¼æ¨¡å¼"},{"categories":null,"content":" çœŸé¢˜","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:21:0","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#çœŸé¢˜"},{"categories":null,"content":" 2018 æœŸä¸­è€ƒçœŸé¢˜PDF åŠ¨æ€è§„åˆ’çš„ä¼˜åŠ¿åœ¨äºå®ƒå¯ä»¥è‡ªåº•å‘ä¸Šçš„è§£å†³é‡å å­é—®é¢˜ï¼Œä¸ç”¨å‘ DFS ä¸€æ ·éœ€è¦è®¡ç®—å¤šæ¬¡ã€‚ 1 ä¸Šç•Œæ˜¯ $O(nlg^2{n})$ï¼Œå¯ä»¥ç”¨é€’å½’æ ‘æ±‚è§£ï¼šæ¯ä¸€å±‚æ˜¯ nlgnï¼Œä¸€å…± lgn å±‚ã€‚ æ ¹æ®ä¸»å®šç†ï¼Œè¿™ä¸ªé€’å½’å¼çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(n^{log^a_4})$ï¼Œè€Œ Strassen å®šç†çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(n^{log_2^7})$ï¼Œæ‰€ä»¥è¦æ±‚ $log_4^a \\lt log_2^7$ï¼Œæ ¹æ®æ¢åº•å…¬å¼æˆ‘ä»¬å¯ä»¥å¾—åˆ° $log_2^a \\lt 2log_2^7$ï¼Œæ‰€ä»¥ $a \\lt 49$ ã€‚ 1 2 3 4 5 6 7 8 0 0 1 1 1 1 1 1 0 1 1 1 1 2 2 2 0 1 1 1 1 2 2 3 0 1 1 2 2 2 2 3 1 1 1 2 3 3 3 3 0 1 2 2 3 3 4 4 $O(n\\lg n + m) \\ge O(mn)$ å¾—åˆ° $m \\ge \\frac{n}{n-1}\\lg n$ æ­¤æ—¶æ€§èƒ½ä¼˜äº m æ¬¡çº¿æ€§æ—¶é—´çš„ä»£ä»·ã€‚å¦‚æœå…ƒç´ ç»å¸¸å˜åŠ¨ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªé¡ºåºæŸ¥æ‰¾æ ‘ï¼Œå®ƒæ˜¯åœ¨çº¢é»‘æ ‘åŸºç¡€ä¸Šæ¯ä¸ªèŠ‚ç‚¹åŠ äº†ä¸€ä¸ª sizeï¼Œè¡¨ç¤ºä»¥è‡ªå·±ä¸ºæ ¹çš„å­æ ‘ä¸ªæ•°ã€‚è¿™æ ·å­æŸ¥è¯¢å’Œæ’å…¥çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(\\lg n)$ã€‚ ç”¨ä¸¤æ¬¡äºŒåˆ†æŸ¥æ‰¾ï¼š python lower_bound(A, n, x): l = 1, r = n + 1 while l \u003c r: mid = (l + r) // 2 if A[mid] \u003c x: l = mid + 1 else: r = mid return l upper_bound(A, n, x): l = 1, r = n + 1 while l \u003c r: mid = (l + r) // 2 if A[mid] \u003c= x: l = mid + 1 else: r = mid return l L = lower_bound(A, n, x) R = upper_bound(A, n, x) if L \u003e n or A[L] != x: return \"x ä¸å­˜åœ¨\" else: return A[L:R-1] é€’æ¨å¼ä¸º $dp[i][j]=dp[i][j-1]+dp[i-1][j-1]$ï¼Œä¼˜åŒ–æ–¹å¼åŒ LCSã€‚ text def combinator(m, n): dp[m+1][n+1] = 0 for i in range(m+1): dp[i][0] = 1 for i in range(1, m+1): for j in range(1, n+1): if i == j: dp[i][j] = 1 else: dp[i][j] = dp[i][j-1] + dp[i-1][j-1] return dp è¿™ä¸ªé—®é¢˜å¯ä»¥ç»“åˆ æœ€é•¿å…¬å…±å­åºåˆ— å’Œ æœ€é•¿è¿ç»­å­ä¸² ä¸¤ä¸ªé—®é¢˜ã€‚ä»¤ dp[i][j] ä¸º ä»¥ X[i] å’Œ Y[j] ç»“å°¾çš„æœ€é•¿å…¬å…±å­ä¸²é•¿åº¦ï¼Œè‹¥å­—ç¬¦ç›¸ç­‰ï¼šdp[i][j] = dp[iâˆ’1][jâˆ’1] + 1 ï¼Œè‹¥å­—ç¬¦ä¸ç­‰ï¼šdp[i][j] = 0ã€‚ä¼˜åŒ–æ€è·¯åŒ LCSï¼Œdp[i][j] åªä¾èµ–å·¦ä¸Šè§’ dp[iâˆ’1][jâˆ’1] ï¼Œå› æ­¤ï¼Œä¸éœ€è¦ä¿å­˜å®Œæ•´äºŒç»´è¡¨ï¼Œåªéœ€ä¿å­˜ä¸Šä¸€è¡Œçš„ç»“æœã€‚ text LongestCommonSubstring(X, Y): n = length(X) m = length(Y) create array dp[0..n][0..m] maxLen = 0 endPos = 0 for i = 0 to n: dp[i][0] = 0 for j = 0 to m: dp[0][j] = 0 for i = 1 to n: for j = 1 to m: if X[i] == Y[j]: dp[i][j] = dp[i-1][j-1] + 1 if dp[i][j] \u003e maxLen: maxLen = dp[i][j] endPos = i else: dp[i][j] = 0 return maxLen ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:21:1","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#2018-æœŸä¸­è€ƒ"},{"categories":null,"content":" 2018 æœŸæœ«è€ƒçœŸé¢˜ PDF å¿«æ’æœ€åæ—¶é—´å¤æ‚åº¦æ˜¯ $O(n^2)$ï¼Œå½’å¹¶æ˜¯ $O(n\\lg n)$ã€‚å› ä¸ºï¼ˆ1ï¼‰ç©ºé—´å¼€é”€æ˜¾è‘—æ›´å°ï¼šå½’å¹¶æ’åºåœ¨æ•°ç»„å®ç°ä¸‹éœ€è¦é¢å¤–çš„ O(n) è¾…åŠ©ç©ºé—´ï¼Œè€Œå¿«æ’æ˜¯åŸåœ°æ’åºï¼›ï¼ˆ2ï¼‰å¸¸æ•°å› å­æ›´å°ï¼Œå®é™…è¿è¡Œæ›´å¿«ï¼šå½’å¹¶æ’åºåœ¨â€œåˆå¹¶â€é˜¶æ®µéœ€è¦é¢‘ç¹åœ°è¿›è¡Œæ•°ç»„æ‹·è´ä¸å†™å…¥è¾…åŠ©æ•°ç»„ï¼Œå¸¸æ•°å¼€é”€æ˜æ˜¾æ›´å¤§ï¼›ï¼ˆ3ï¼‰ç¼“å­˜å±€éƒ¨æ€§æ›´å¥½ï¼šå¿«é€Ÿæ’åºåœ¨åˆ’åˆ†è¿‡ç¨‹ä¸­ï¼Œä¸»è¦åœ¨å½“å‰å­æ•°ç»„ä¸Šè¿›è¡Œé¡ºåºè®¿é—®å’Œå±€éƒ¨äº¤æ¢ï¼Œå…·æœ‰è‰¯å¥½çš„ç©ºé—´å±€éƒ¨æ€§ï¼Œèƒ½å……åˆ†åˆ©ç”¨ CPU cacheã€‚å½’å¹¶æ’åºåœ¨åˆå¹¶é˜¶æ®µéœ€è¦åœ¨å¤šä¸ªæ•°ç»„ä¹‹é—´æ¥å›è¯»å†™ï¼Œç¼“å­˜å‘½ä¸­ç‡è¾ƒä½ã€‚ äºŒå‰å † Minimum æ“ä½œæ›´å¿« $O(1)$ï¼ŒäºŒå‰å †æ˜¯ $O(\\lg n)$ï¼›åˆå¹¶æ“ä½œäºŒé¡¹å †å¿« $O(\\lg n)$ï¼ŒäºŒå‰å †æ˜¯ $O(n\\lg n)$ åŠ¨æ€è§„åˆ’æ­¥éª¤æ˜¯ï¼šå†™å‡ºé€’æ¨å¼ï¼Œç¡®å®šéå†é¡ºåºï¼Œç¡®å®šåˆå§‹æ¡ä»¶ MRç®—æ³•çš„æ”¹è¿›åŒ…æ‹¬ï¼šé€šè¿‡æ•´æ•°åˆ†è§£å®šç†ï¼Œå°† p-1 åˆ†è§£ä¸º $2^s\\times d$ ï¼Œç„¶åå¯¹ ${a^d, a^{2d}, a^{4d}, â€¦, a^{2^{sâˆ’1}d}}$ éƒ½è¿›è¡Œæ£€æŸ¥ï¼›é™¤äº†æ£€æŸ¥ä½™æ•°æ˜¯å¦ä¸º 1ï¼Œè¿˜æ£€æŸ¥æ˜¯å¦ä¸º -1ã€‚ $T(n)= T( \\frac{2}{3} n ) + 1= T( (\\frac{2}{3})Â² n ) + 1 + 1 = T( (\\frac{2}{3})Â³ n ) + 1 + 1 + 1$ ï¼Œ$(\\frac{2}{3})^k Â· n = 1$ å¾—åˆ°é€’æ¨æ·±åº¦ä¸º $Î˜(log n)$ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ $Î˜(log n)$ã€‚ å°±æ˜¯ DAG æœ€çŸ­è·¯å¾„é—®é¢˜ï¼š dp dp[1] 0 dp[2] 9 dp[3] 3 dp[4] 7 dp[5] 2 dp[6] min(dp[2]+4,dp[3]+2)=5 dp[7] min(dp[2]+2,dp[3]+7,dp[5]+11)=10 dp[8] min(dp[2]+1,dp[4]+11,dp[5]+8)=10 dp[9] min(dp[6]+6,dp[7]+4)=11 dp[10] min(dp[7]+3,dp[8]+5)=13 dp[11] min(dp[6]+5,dp[8]+6)=10 dp[12] 15 ç®—æ³•æ€è·¯ï¼šæŒ‰ç…§é‡é‡æ’åºï¼Œæ¯æ¬¡é€‰é‡é‡æœ€å°çš„ è®¾ $S^$ æ˜¯ä»»æ„ä¸€ä¸ªæœ€ä¼˜è§£ï¼Œ$S^$ é€‰æ‹©çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸‹æ ‡æ˜¯ i å‡è®¾æŒ‰ç…§è´ªå¿ƒç®—æ³•é€‰æ‹©çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸‹æ ‡ä¸º 0 å‡å¦‚ i==0ï¼Œé‚£ä¹ˆæœ€ä¼˜è§£ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯è´ªå¿ƒ å‡å¦‚ i != 0ï¼Œé‚£ä¹ˆæœ€ä¼˜è§£çš„ç¬¬ä¸€ä¸ªå…ƒç´ è‚¯å®šæ¯” 0 é‡ä»·å€¼ä½ï¼Œé‚£ä¹ˆæ›¿æ¢ä¸º 0 å°±å¯ä»¥å¾—åˆ°æ›´ä¼˜è§£ã€‚ è´ªå¿ƒç­–ç•¥æ˜¯ä¸æ–­é€‰æ‹©æƒé‡æœ€å°çš„ä¸¤æ¡è¾¹ï¼Œåœ¨ä¿è¯ä¸å½¢æˆç¯çš„æƒ…å†µä¸‹åˆå¹¶ã€‚ç”¨å¹¶æŸ¥é›†æ¥å®ç°ã€‚ ä»£ç ç®€å•ï¼Œå¤æ‚åº¦ $O(\\lg n)$ æœ‰åºçš„æƒ…å†µï¼ŒäºŒåˆ†æŸ¥æ‰¾ã€‚åœ¨æ²¡æœ‰ç¼ºå¤±çš„ç†æƒ³æƒ…å†µä¸‹ï¼Œåº”æœ‰ A[i] = iã€‚ç¼ºå¤±ä¸€ä¸ªæ•°åï¼Œåœ¨ç¼ºå¤±ç‚¹å³ä¾§ä¼šå‡ºç° A[i] \u003e i ã€‚A[i] = iï¼Œè¯´æ˜ç¼ºå¤±çš„æ•°åœ¨å³åŠåŒºï¼Œè‹¥ A[i] \u003e iï¼Œè¯´æ˜ç¼ºå¤±çš„æ•°åœ¨å·¦åŠåŒºï¼›æ— åºçš„æƒ…å†µï¼Œéå†ä¸€éæ•°ç»„æŠŠå…¨éƒ¨å…ƒç´ åŠ èµ·æ¥ï¼Œç„¶åç”¨ 1 åˆ° n+1 çš„å’Œå‡å»æ•°ç»„å…ƒç´ å’Œï¼Œå°±æ˜¯ç¼ºå°‘çš„æ•°ã€‚ KMP å’Œ æœ‰é™è‡ªåŠ¨æœºã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:21:2","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#2018-æœŸæœ«è€ƒ"},{"categories":null,"content":" 2021 æœŸä¸­è€ƒ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:21:3","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#2021-æœŸä¸­è€ƒ"},{"categories":null,"content":" 2021 æœŸæœ«è€ƒçœŸé¢˜ PDF æ­£ç¡®ï¼Œç›´æ¥ä¸»å®šç† æ­£ç¡®ï¼Œç”¨ Order Statistic ç®—æ³•åœ¨çº¿æ€§æ—¶é—´å¾—åˆ°ç¬¬ k1 ä¸ªå…ƒç´ å’Œç¬¬ k2 ä¸ªå…ƒç´ ï¼Œç„¶åéå†ä¸€éæ‰¾åˆ°ä¹‹é—´çš„å€¼æ±‚å’Œ æ­£ç¡®ï¼Œç”¨æ–æ³¢é‚£å¥‘å †+Johnson ç®—æ³• é”™è¯¯ï¼Œ2-SAT æ˜¯ P é—®é¢˜ï¼Œä¸å±äº NP æˆ–è€… NPC é—®é¢˜ã€‚3-PAT å‰©ä½™ NPCé—®é¢˜ã€‚ æ­£ç¡®ï¼ŒPTAS å°±æ˜¯å¯ä»¥åœ¨æ¥å— ep è¯¯å·®çš„æƒ…å†µä¸‹ï¼Œå¾—åˆ°å…³äº n å¤šé¡¹å¼æ—¶é—´å¤æ‚çš„çš„ç®—æ³•ã€‚FPTAS æ˜¯æ›´è¿›ä¸€æ­¥ï¼Œå¾—åˆ°é«˜äº ep å’Œ n çš„å¤šé¡¹å¼æ—¶é—´å¤æ‚åº¦çš„ç®—æ³•ã€‚ åˆ†æ²»é—®é¢˜å°±æ˜¯ä¸æ–­æŠŠå¤§é—®é¢˜åˆ†è§£ä¸ºå°çš„å­é—®é¢˜ï¼Œç„¶åè§£å†³å­é—®é¢˜å¹¶ä¸”åˆå¹¶æ¥è§£å†³åŸé—®é¢˜ã€‚æ–¹æ³•åŒ…æ‹¬ï¼šé€’å½’æ ‘ï¼Œä»£å…¥æ³•ï¼Œä¸»å®šç† dp[i][j] è¡¨ç¤ºå¯¹äºå‰ i ä¸ªç‰©å“å’Œ j é‡é‡ï¼Œæœ€é«˜ä»·å€¼æ˜¯å¤šå°‘ã€‚é€’æ¨å¼æ˜¯ dp[i][j]=max(dp[i-1][j], dp[i-1][j-w]+v)ã€‚ç§°ä¸ºä¼ªå¤šé¡¹å¼æ—¶é—´å¤æ‚åº¦ï¼Œå› ä¸ºæ—¶é—´å¤æ‚åº¦æ˜¯ $O(n Â· W)$ï¼Œåœ¨å¤šé¡¹å¼ç†è®ºä¸­è¾“å…¥è§„æ¨¡æ˜¯è¾“å…¥ä½æ•°ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯ $O(n \\cdot 2^{logW})$ ï¼Œå¯¹äº W æ˜¯æŒ‡æ•°çº§ã€‚ Ï€ å°±æ˜¯çœ‹æœ€é•¿å…¬å…±å‰åç¼€ï¼Œç¬¬ä¸€ä½å›ºå®š 0ã€‚ å’ŒçŸ©é˜µé“¾ä¹˜æ³•ä¸€æ ·ï¼Œéœ€è¦ä¸‰æ¬¡å¾ªç¯ï¼Œfor åŒºé—´é•¿åº¦ for å·¦ç«¯ç‚¹ for åˆ†å‰²ä½ç½®ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ $O(n^3)$ã€‚ ç”¨å“ˆå¤«æ›¼æ ‘çš„æ–¹æ³•ï¼Œæ’åºä¹‹åä¸æ–­é€‰æ‹©æœ€å°ä¸¤ä¸ªåˆå¹¶ï¼Œ$O(n\\lg n)$ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:21:4","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#2021-æœŸæœ«è€ƒ"},{"categories":null,"content":" 2024 æœŸä¸­è€ƒ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:21:5","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#2024-æœŸä¸­è€ƒ"},{"categories":null,"content":" 2025 æœŸä¸­è€ƒå·²çŸ¥ï¼š$T(n) = T(n/2) + T(\\sqrt n) + nï¼Œâ€ƒT(1) = 1$ æ±‚æ¸è¿›ä¸Šç•Œã€‚ æˆ‘ä»¬è€ƒå¯Ÿæ¯ä¸€å±‚é€’å½’çš„æ€»ä»£ä»·ã€‚ ç¬¬ 0 å±‚ä»£ä»· = n ç¬¬ 1 å±‚æœ¬å±‚æ€»ä»£ä»·ï¼š n/2 + âˆšn â‰¤ n/2 + n/2 = nï¼ˆå¯¹ n â‰¥ 1 æ’æˆç«‹ï¼‰ ç¬¬ 2 å±‚ï¼š æ‰€æœ‰éé€’å½’é¡¹ä¹‹å’Œä»ç„¶ å°äº nã€‚ æ‰€ä»¥å¯çŸ¥ï¼šæ¯ä¸€å±‚é€’å½’çš„æ€»ä»£ä»· â‰¤ nã€‚è§‚å¯Ÿæœ€é•¿é€’å½’è·¯å¾„ n â†’ n/2 â†’ n/4 â†’ â€¦ â†’ 1 ï¼Œæ·±åº¦æ˜¯ O(log n)ã€‚ è€Œ âˆšn åˆ†æ”¯ä¸‹é™æ›´å¿«ï¼Œä¸ä¼šå¢åŠ å±‚æ•°ã€‚æ¯å±‚ä»£ä»·$O(n)$ï¼Œå±‚æ•° $O(log n)$ï¼Œå› æ­¤ï¼š$T(n) = O(n \\lg n)$ã€‚ ","date":"2026-01-08","objectID":"/posts/ustc-alg-review/:21:6","series":["æœŸæœ«å¤ä¹ "],"tags":["ç®—æ³•","å¤ä¹ "],"title":"ç®—æ³•åˆ†æä¸è®¾è®¡å¤ä¹ ","uri":"/posts/ustc-alg-review/#2025-æœŸä¸­è€ƒ"},{"categories":["life"],"content":" é»„å±± 2025-12-25æœ¬æ¥è®¡åˆ’ 12 æœˆå»é’å²›å¨æµ·ç©ï¼Œè¿äº‘æ¸¯ä¹Ÿåœ¨æ¸…å•é‡Œæ”¾äº†å¾ˆä¹…äº†ä¸€ç›´æƒ³å»ï¼Œä½†æ˜¯å°çº¢ä¹¦è¶Šåˆ·å°±è¶ŠçŠ¹è±«ã€‚ä¸€ä¼šçº ç»“ 12 æœˆé’å²›å¨æµ·ä¼šä¸ä¼šä¸‹é›ªï¼Œä¸€ä¼šçº ç»“å¥½ç©çš„ä¸œè¥¿å¤šä¸å¤šï¼Œä¸€ä¼šåˆåœ¨çº ç»“é’±ä¼šä¸ä¼šèŠ±å¤ªå¤šäº†ï¼Œæ‰€ä»¥å°±ä¸€æ‹–å†æ‹–ã€‚åé¢è€ƒè™‘å»å¤ªç™½å±±ç­‰ç­‰ï¼Œæœ€ç»ˆçœ‹åˆ° 25 å·é»„å±±ä¸‹é›ªå°±å†³å®šæ˜¯ä½ äº†ã€‚ å› ä¸ºæœ‹å‹è¦å¼€ç»„ä¼šï¼Œæ‰€ä»¥å¾ˆå¥‡è‘©çš„å®šåœ¨ 24 å·æ™šä¸Š 10 ç‚¹é»„å±±åŒ—é›†åˆã€‚æˆ‘ä»¬æ±‡åˆä¹‹åæ‰“äº†ç½‘çº¦è½¦ç›´æ¥å»äº†é…’åº—ç¡è§‰ï¼Œè¿™ä¸ªä½ç½®å®šçš„æ˜¯çœŸçš„éš¾ç»·ï¼Œé»„å±±é£æ™¯åŒºåœ¨é»„å±±åŒ—ç«™åŒ—è¾¹ï¼Œé…’åº—å®šåœ¨é»„å±±åŒ—ç«™å—è¾¹ï¼Œå¯¼è‡´æ‰“è½¦åˆè¿œåˆè´µã€‚åˆ°äº†é…’åº—åƒäº†ä¸ªéº¦å½“åŠ³å°±ç¾ç¾ç¡è§‰äº†ã€‚ 25 å·æ—©ä¸Šå®šäº†5ç‚¹çš„é—¹é’Ÿï¼Œä¸€å¤§æ—©èµ·åºŠæ´—äº†ä¸ªæ¾¡å°±å‡ºå‘äº†ã€‚ç½‘çº¦è½¦å·®ä¸å¤š 40 åˆ†é’Ÿåˆ°äº†é£æ™¯åŒºï¼Œå’Œ 23 å¹´å»é»„å±±æ—¶å€™å¤§å˜æ ·äº†ï¼Œåœ¨æ™¯åŒºé—¨å£åƒäº†ä¸ªæ—©é¤æ’é˜Ÿå°±è¿›å»äº†ã€‚ PSï¼šåªæœ‰æˆ‘ä¸€ä¸ªäººè§‰å¾—è¿™ä¸ªé›ªå¾ˆå¥½ç©å—^^ã€‚ è™½ç„¶é£æ™¯å¾ˆç¾ï¼Œä½†æ˜¯å†ä¹Ÿä¸å¯èƒ½å»çˆ¬é»„å±±äº†ï¼Œçˆ¬ä¸€æ¬¡æ‰åŠæ¡å‘½ç´¯å¾—è¦æ­»ã€‚ ","date":"2026-01-01","objectID":"/posts/huangshan-trip/:1:0","series":["æ¸¸è®°"],"tags":["æ—…è¡Œ","ç”Ÿæ´»"],"title":"å†¬æ¸¸é»„å±±","uri":"/posts/huangshan-trip/#é»„å±±-2025-12-25"},{"categories":null,"content":" BPE Train","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:1:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#bpe-train"},{"categories":null,"content":" Problems1. Understanding Unicode (a) What Unicode character does chr(0) return?ä¸€ä¸ªç©ºå­—ç¬¦ã€‚ (b) How does this characterâ€™s string representation (repr()) differ from its printed representa- tion? repr() è¾“å‡ºçš„æ˜¯å®ƒçš„å­—èŠ‚è¡¨ç¤ºï¼Œprint è¾“å‡ºçš„æ˜¯ç©ºå­—ç¬¦ã€‚ (c) What happens when this character occurs in text? It may be helpful to play around with the following in your Python interpreter and see if it matches your expectations: python \u003e\u003e\u003e chr(0) \u003e\u003e\u003e print(chr(0)) \u003e\u003e\u003e \"this is a test\" + chr(0) + \"string\" \u003e\u003e\u003e print(\"this is a test\" + chr(0) + \"string\") è¾“å‡ºä¸ºç©ºã€‚ 2. Unicode Encodings (a) What are some reasons to prefer training our tokenizer on UTF-8 encoded bytes, rather than UTF-16 or UTF-32? It may be helpful to compare the output of these encodings for various input strings? UTF-8 åºåˆ—é•¿åº¦æ›´çŸ­ï¼Œå‹ç¼©æ¯”æ›´é«˜ï¼Œè€Œä¸”å†—ä½™å­—ç¬¦å°‘ (b) Consider the following (incorrect) function, which is intended to decode a UTF-8 byte string into a Unicode string. Why is this function incorrect? Provide an example of an input byte string that yields incorrect results. python def decode_utf8_bytes_to_str_wrong(bytestring: bytes): return \"\".join([bytes([b]).decode(\"utf-8\") for b in bytestring]) è‹±æ–‡åœ¨ UTF-8 ä¸­æ˜¯ä¸€å­—èŠ‚ç¼–ç ï¼ŒèŒƒå›´åœ¨ 0â€“127ï¼Œæ˜¯å¯ä»¥ç›´æ¥è§£ç çš„ã€‚ ä¾‹å¦‚ä¸­æ–‡åœ¨ UTF-8 ä¸­æ˜¯ä¸‰å­—èŠ‚ç¼–ç  0xE4 å¼€å¤´ï¼Œå¿…é¡»è¦åˆæ³•çš„ 3 å­—èŠ‚åºåˆ—æ‰èƒ½è§£ç  (c) Give a two byte sequence that does not decode to any Unicode character(s). \\xbd\\xa0ï¼Œé€‰æ‹©ä¸­æ–‡ä¸‰å­—èŠ‚ç¼–ç çš„åä¸¤ä¸ªå­—èŠ‚ï¼Œå°±æ— æ³•è§£ç ã€‚ ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:1:1","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#problems"},{"categories":null,"content":" CodesBPE çš„è®­ç»ƒè¿‡ç¨‹å¦‚ä¸‹ï¼š åˆå§‹åŒ–è¯æ±‡è¡¨ vocab å°†æ•´å‹ 0-255 æ˜ å°„åˆ°å¯¹åº”çš„ byte å°† Special Token åŠ å…¥ vocabï¼Œè¿™æ ·å®ƒå°±æ˜¯ä¸å¯åˆ†å‰²çš„ å°†æ–‡æœ¬åˆ†ä¸ºä¸€ä¸ªä¸ª subword å¦‚æœä¸å­˜åœ¨ Special Tokenï¼Œç›´æ¥ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†ã€‚ å¦‚æœå­˜åœ¨ Special Tokenï¼Œå°±å…ˆæ ¹æ® tok åˆ†ä¸ºä¸€ä¸ªä¸ª partï¼Œç„¶ååœ¨ part ä¸­å†åˆ†ã€‚ æ¥ä¸‹æ¥å°±éœ€è¦ç»Ÿè®¡å‡ºç°é¢‘ç‡æœ€é«˜çš„ Pair Countï¼Œç„¶åç”¨è¿™ä¸ª Pair æ›¿æ¢ python def train_bpe(input_path: str, vocab_size: int, special_tokens: list[str]): PAT = r\"\"\"'(?:[sdmt]|ll|ve|re)| ?\\p{L}+| ?\\p{N}+| ?[^\\s\\p{L}\\p{N}]+|\\s+(?!\\S)|\\s+\"\"\" vocab = {} merges = [] # 1. init vocab for i in range(256): bt = bytes([i]) vocab[i] = bt for tok in special_tokens: # special_token ä¸å¯åˆ†å‰² vocab[len(vocab)] = tok.encode(\"utf-8\") # 2. read train data with open(input_path, \"r\", encoding=\"utf-8\") as f: text = f.read() subwords = [] # 3. split text into subwords if special_tokens: toks = sorted(special_tokens, key=len, reverse=True) union = \"|\".join(re.escape(t) for t in toks) parts = re.split(f\"({union})\", text) st = set(special_tokens) for part in parts: if not part or part in st: continue subwords.extend(re.findall(PAT, part)) else: subwords = re.findall(PAT, text) # 4. count up pairs unicodes = [subword.encode(\"utf-8\") for subword in subwords] while len(vocab) \u003c vocab_size: # find pair with max count to_merge = (None, 0) pair_counts = defaultdict(int) for unicode in unicodes: for idx in range(len(unicode) - 1): pair = (bytes([unicode[idx]]), bytes([unicode[idx+1]])) pair_counts[pair] += 1 if (to_merge[0] is None) or \\ (pair_counts[pair] \u003e to_merge[1]) or \\ (pair_counts[pair] == to_merge[1] and pair \u003e to_merge[0]): to_merge = (pair, pair_counts[pair]) if to_merge[0] is None: raise # record new_unicodes = [] new_token = to_merge[0][0] + to_merge[0][1] vocab[len(vocab)] = new_token merges.append(to_merge[0]) # replace pair for idx, unicode in enumerate(unicodes): to_replace = [i for i in range(len(unicode)-1) if unicode[i:i+2] == to_merge[0]] if not to_replace: continue i = 0 new_unicode = [] while i \u003c len(unicode): if i in to_replace: new_unicode.append(new_token) i += 2 else: new_unicode.append(unicode[i]) i += 1 new_unicodes.append(new_unicode) unicodes = new_unicodes return vocab, merges åœ¨é€‰æ‹©é¢‘ç‡æœ€é«˜çš„ Pair æ—¶å€™ï¼Œå¦‚æœå‡ºç°ä¸¤ä¸ªé¢‘ç‡ä¸€æ ·çš„ï¼Œå°±éœ€è¦æŒ‰ç…§å­—å…¸åºé€‰æ‹©ä¸€ä¸ªæœ€å¤§çš„ã€‚ä½†æ˜¯è¿™ä¸ªå­—å…¸åºè¯¥æ€ä¹ˆæ¯”å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çš„ Pair æ˜¯ Byte Pairï¼Œä¹Ÿå°±æ˜¯è¯´æ¯”è¾ƒçš„æ˜¯ Byte çš„å­—å…¸åºï¼Œé‚£éœ€è¦å˜æˆå­—ç¬¦å†æ¯”è¾ƒå—ï¼Ÿå…¶å®ä¸€ä¸ª Byte Pair éƒ½ä¸ä¸€å®šèƒ½è½¬ä¸º Characterï¼ˆProblem 2 é‡Œé¢æè¿‡ï¼‰ï¼Œæ‰€ä»¥ç›´æ¥æ¯”è¾ƒ Byte å­—å…¸åºå°±å¥½ã€‚ æœ´ç´ åŠæ³•æ•´ä½“æ—¶é—´å¤æ‚åº¦ä¸º $O(V*T)$ï¼Œå®ƒçš„å¼€é”€ä¸»è¦åœ¨äºï¼š æ¯æ¬¡å¾ªç¯éƒ½è¦éå†ä¸€æ¬¡æ–‡æœ¬ï¼Œæ¥å¾—åˆ°æœ€æ–°çš„ Pair Counts å¾—åˆ°éœ€è¦ Merge çš„ Pair ä¹‹åï¼Œåˆéœ€è¦éå†ä¸€æ¬¡æ–‡æœ¬ï¼Œæ¥æ›¿æ¢ Pair é¦–å…ˆå¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æƒ³è¦è·å¾—é¢‘ç‡æœ€é«˜çš„ Pair å¯ä»¥é€šè¿‡å †è¿™ä¸ªæ•°æ®ç»“æ„æ¥å®ç°ï¼Œå®ƒè·å–å †é¡¶å…ƒç´ å¹¶ä¸”æ›´æ–°å †çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(logn)$ã€‚ä½†æ˜¯æˆ‘ä»¬æ¯æ¬¡ Merge ä¹‹åéœ€è¦æ›´æ–° Pair çš„ä¸Šä¸‹æ–‡ï¼Œé‚£å°±éœ€è¦å¯¹å †é‡Œé¢çš„æ¯ä¸€ä¸ªå…ƒç´ è¿›è¡Œä¿®æ”¹å—ï¼Ÿå…¶å®å¯ä»¥é€šè¿‡æ‡’æ›´æ–°çš„åŠæ³•ï¼Œå‡å¦‚éœ€è¦ pair_counts\\[pair]++ï¼Œé‚£æˆ‘ä»¬å¯ä»¥æŠŠæ›´æ–°åçš„ Pair ç›´æ¥ Push åˆ°å †é‡Œé¢ï¼Œç„¶ååœ¨å–å †é¡¶çš„æ—¶å€™åˆ¤æ–­å…ƒç´ çš„åˆæ³•æ€§ã€‚ ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæ¯æ¬¡ä¿®æ”¹ Pair ä¹Ÿéœ€è¦éå†ä¸€æ¬¡æ–‡æœ¬æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢ï¼Ÿå¦‚æœé‡‡ç”¨ list å­˜å‚¨æ–‡æœ¬ï¼Œæ¯æ¬¡ delete çš„å¼€é”€éƒ½æ˜¯ $O(n)$ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŒå‘é“¾è¡¨æ¥å­˜å‚¨ï¼Œè¿™æ ·åœ¨å·²çŸ¥èŠ‚ç‚¹ä½ç½®çš„æƒ…å†µä¸‹ï¼Œåˆ é™¤æ’å…¥çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯ $O(1)$ äº†ã€‚é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆçŸ¥é“èŠ‚ç‚¹ä½ç½®å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªåå‘ç´¢å¼•å­—å…¸ï¼Œè®°å½•æ¯ä¸€ä¸ª token åœ¨æ–‡æœ¬ä¸­å“ªäº›ä½ç½®ï¼štoken_id â†’ set[Node]ã€‚ ä¹‹å‰æˆ‘ä»¬åŒºåˆ† Subword æ˜¯é€šè¿‡äºŒç»´æ•°ç»„è¿›è¡Œï¼Œç°åœ¨ä½¿ç”¨åŒå‘é“¾è¡¨å°±éœ€è¦åœ¨é‡Œé¢æ’å…¥ç‰¹æ®ŠèŠ‚ç‚¹æ¥åŒºåˆ†ä¸åŒ Subwordã€‚ ä»å †é¡¶å–å‡ºçš„åˆæ³•çš„ Pair(a, b)ï¼Œå‡è®¾æœ‰ x â†’ a â†’ b â†’ yï¼Œæˆ‘ä»¬è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š pair_counts æŠŠ (a, b) è¿™ä¸€é¡¹ç›´æ¥å»æ‰ åœ¨åå‘é“¾æ¥ä¸­ key=a å’Œ key=b çš„é¡¹ removeæ‰ ç¬¦åˆ a -\u003e bçš„ èŠ‚ç‚¹ å¦‚æœ x å­˜åœ¨ï¼ŒæŠŠ (x, a)â€“ï¼Œå¹¶ä¸” (x, c) ++, ç›´æ¥æŠŠ(x, c)åŠ å…¥å † å¦‚æœ y å­˜åœ¨ï¼Œé‚£ä¹ˆ (b, y)â€“ (c, y)++ (c, y) åŠ å…¥å †ä¸­ï¼ˆä¸éœ€è¦ç®¡åé¢ä¼šä¸ä¼šæ›´æ–°ï¼Œå› ä¸ºpopæ—¶å€™ä¼šæ£€æŸ¥ï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦ä½ï¼‰ å°†åŒå‘é“¾è¡¨ä¸­ x -\u003e a -\u003e b -\u003e y å˜æˆ x -\u003e c -\u003e y åœ¨åå‘é“¾æ¥ä¸­åŠ å…¥ key=cï¼Œè®°å½•ä½ç½® python heap: list[HeapItem] = [] linkedlist = LinkedList[int]() pair_counts: dict[tuple[int, int], int] = defaultdict(int) back_link: dict[int, set[LinkNode[int]]] = defaultdict(set) subwords = [list(subword.encode(\"utf-8\")) for subword in subwords] for subword in subwords: for idx in range(len(subword) - 1): cnt, nxt = subword[idx], subword[idx+1] node = linkedlist.push_back(cnt) back_link[cnt].add(node) pair_counts[(cnt, nxt)] += 1 linkedlist.push_back(subword[-1]) linkedlist.push_back(-1) # æ’å…¥ä¸€ä¸ªåˆ†å‰²ç¬¦ï¼Œæ¥åŒºåˆ†ä¸åŒçš„ subword for (a, b), cnt in pair_counts.items(): item = HeapItem(cnt, a, b, vocab) heapq.heappush(heap, item) while heap and len(vocab) \u003c vocab_size: heapitem = heapq.heappop(heap) pair = heapitem.get_pair() # é‡‡ç”¨æ‡’åˆ é™¤ï¼Œæ‰€ä»¥æ¯æ¬¡åˆ¤æ–­æ˜¯ä¸æ˜¯å­˜åœ¨çš„pair if pair not in pair_counts or pair_counts[pair] != heapitem.count: continue merges.append((vocab[pair[0]], vocab[pair[1]])) new_token = len","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:1:2","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#codes"},{"categories":null,"content":" BPE TokenizerTokenizer çš„åŠŸèƒ½å°±æ˜¯æ¥å—è®­ç»ƒå¾—åˆ°çš„ vocab å’Œ mergesï¼Œç„¶åæŠŠè¾“å…¥æ–‡æœ¬è½¬ä¸ºå¯¹åº”çš„ç´¢å¼• idï¼Œæˆ–è€…æŠŠç´¢å¼• id è½¬å›æ–‡æœ¬ï¼Œæˆ‘ä»¬éœ€è¦ implement çš„å‡½æ•°åŒ…æ‹¬ encodeï¼Œdecode ç­‰ç­‰ã€‚ä½†æ˜¯ç¬¬äºŒéƒ¨åˆ†ä½œä¸šå‘éå¸¸å¤šï¼Œåé¢ä¼šå…·ä½“è¯´ã€‚ æ ¹æ®ä¹‹å‰ BPE Train çš„ä¼˜åŒ–æ€è·¯ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½æƒ³åˆ°å¦‚ä½•è¿›è¡Œ Encodeï¼š ç”¨åŒå‘é“¾è¡¨è¡¨ç¤º Subwordï¼Œç”¨åå‘ç´¢å¼•å®šä½ bytes â†’ Node èŠ‚ç‚¹ æ¯æ¬¡ Merge é€šè¿‡åå‘ç´¢å¼•æ‰¾åˆ°ç¬¦åˆçš„ Pairï¼Œç„¶ååœ¨åŒå‘é“¾è¡¨ä¸­æŠŠ a â†’ b å˜æˆ cï¼ŒåŒæ—¶æ›´æ–°åå‘ç´¢å¼• æœ€åéå†åŒå‘é“¾è¡¨å°±èƒ½å¾—åˆ° Merge ä¹‹åçš„æ–‡æœ¬äº† äºæ˜¯å°±æœ‰äº†æœ€åˆçš„ä»£ç ï¼š python class BPE_Tokenizer: def __init__( self, vocab: dict[int, bytes], merges: list[tuple[bytes, bytes]], special_tokens: list[str] | None = None, ): self.vocab = vocab.copy() self.special_tokens = sorted(special_tokens, key=len, reverse=True) self.merges = merges self.rev_vocab = {v:k for k,v in vocab.items()} self.PAT = r\"\"\"'(?:[sdmt]|ll|ve|re)| ?\\p{L}+| ?\\p{N}+| ?[^\\s\\p{L}\\p{N}]+|\\s+(?!\\S)|\\s+\"\"\" self.sp_union = \"|\".join(re.escape(t) for t in self.special_tokens) @classmethod def from_files( cls, vocab_filepath: str, merges_filepath: str, special_tokens: list[str] | None = None ): # Load and normalize vocab: keys -\u003e int, values -\u003e bytes with open(vocab_filepath, \"r\", encoding=\"utf-8\") as vf: raw_vocab = json.load(vf) norm_vocab = {v:k.encode(\"utf-8\") for k, v in raw_vocab.items()} norm_merges = [] # Load and normalize merges: ensure tuples of bytes for line in open(merges_filepath, \"rb\"): a, b = line.split() norm_merges.append( ( a.encode(\"utf-8\") if isinstance(a, str) else a, b.encode(\"utf-8\") if isinstance(b, str) else b ) ) return cls(norm_vocab, norm_merges, special_tokens) def encode(self, text: str) -\u003e list[int]: subwords = [] if self.special_tokens: subwords = re.split(f\"({self.sp_union})\", text) else: subwords = re.findall(self.PAT, text) ids = [] for subword in subwords: ids.extend(self.merge_bytes([self.rev_vocab[bytes([byte_id])] for byte_id in subword.encode(\"utf-8\")])) return ids def merge_bytes(self, raw_vocab_ids: list[int]) -\u003e list[int]: merged_vocab_ids = [] # æ„å»ºåŒå‘é“¾è¡¨ linkedlist = LinkedList[int]() # æ„å»ºä¸€ä¸ªåå‘é“¾æ¥ back_link = defaultdict(list) for raw_vocab_id in raw_vocab_ids: node = linkedlist.push_back(raw_vocab_id) back_link[raw_vocab_id].append(node) # éå†merges for merge in self.merges: new_token = merge[0] + merge[1] for node in list(back_link[self.rev_vocab[merge[0]]]): # å‡è®¾æœ‰ a â†’ b a, b = node, node.nxt if b is None or self.vocab[b.value] != merge[1]: continue # a â†’ b å˜æˆ c a.value = self.rev_vocab[new_token] linkedlist.delete_node(b) # æ›´æ–°backlink back_link[self.rev_vocab[merge[0]]].remove(a) back_link[self.rev_vocab[merge[1]]].remove(b) back_link[self.rev_vocab[new_token]].append(a) head = linkedlist.head while head is not None: merged_vocab_ids.append(head.value) head = head.nxt return merged_vocab_ids def encode_iterable(self, iterable: Iterable[str]) -\u003e Iterator[int]: for chunk in iterable: yield from self.encode(chunk) def decode(self, ids: list[int]) -\u003e str: return (b''.join([self.vocab[_id] for _id in ids])).decode(\"utf-8\", errors=\"replace\") handout é‡Œé¢è¦æ±‚æˆ‘ä»¬ implement from_file è¿™ä¸ªæ–¹æ³•ï¼Œä½†å®é™…ä¸Šåœ¨ pytest ä¸­æ²¡æœ‰è¿›è¡Œæµ‹è¯•ã€‚ è¿è¡Œ uv run pytest tests/test_tokenizer.py ç›´æ¥æŠ¥é”™äº†ï¼Œæç¤ºæ²¡æœ‰ resource è¿™ä¸ªåº“ã€‚æˆ‘é‡æ–°å®‰è£…äº†ä¸€éè¿˜æ˜¯æŠ¥è¿™ä¸ªé”™ï¼ŒæŸ¥äº†ç™¾åº¦æ‰çŸ¥é“è¿™ä¸ªåº“åœ¨ linux ä¸Šé¢æ‰èƒ½ç”¨ï¼Œwindows ä¸æ”¯æŒã€‚æ‰€ä»¥æˆ‘åœ¨ test_tokenizer.py é‡Œé¢æŠŠéœ€è¦ç”¨åˆ° resource åº“çš„åœ°æ–¹éƒ½æ³¨é‡Šäº†ï¼Œå®ƒä¸»è¦ç”¨æ¥ç›‘æ§å†…å­˜å ç”¨ï¼Œç”¨å¤„ä¸å¤§ã€‚ ä¿®æ”¹ä¹‹å pytest è¿˜æ˜¯æŠ¥é”™äº†ï¼Œæˆ‘å†™äº†ä¸ª test è¿›è¡Œæµ‹è¯•ï¼Œå‘ç° Tokenizer é‡Œé¢çš„ vocab å±…ç„¶æ²¡æœ‰ b\" \" è¿™ä¸€é¡¹ï¼Œé‚£è‚¯å®šæ˜¯ from_file å†™é”™äº†ã€‚ç»è¿‡ç ”ç©¶æˆ‘æ‰å‘ç°ï¼š==ç”±äº json æ–‡ä»¶ä¸èƒ½å­˜å‚¨ bytesï¼Œæ‰€ä»¥ vocab å’Œ merges ä¸¤ä¸ªæ–‡ä»¶é‡Œé¢çš„ bytes éƒ½æ˜¯ä»¥ unicode æ ¼å¼å­˜å‚¨çš„==ï¼Œæ‰€ä»¥æˆ‘ä»¬è¯»å– token ä¹‹åéœ€è¦è¿›è¡Œ unicode å’Œ bytes çš„è½¬æ¢ã€‚ python def gpt2_bytes_to_unicode() -\u003e dict[int, str]: bs = list(range(ord(\"!\"), ord(\"~\") + 1)) + list(range(ord(\"Â¡\"), ord(\"Â¬\") + 1)) + list(range(ord(\"Â®\"), ord(\"Ã¿\") + 1)) cs = bs[:] n = 0 for b in range(2**8): if b not in bs: bs.append(b) cs.append(2**8 + n) n += 1 characters = [chr(n) for n in cs] d = dict(zip(bs, characters)) return d class BPE_Tokenizer: @classmethod def from_files( cls, vocab_filepath: str, merges_filepath: str, special_tokens: list[str] | None = None ): gpt2_byte_decoder = {v: k for k, v in gpt2_bytes_to_unicode().items()} with open(vocab_filepath, encoding=\"utf-8\") as vocab_f: gpt2_vocab = json.load(vocab_f) gpt2_bpe_merges = [] with open(merges_filepath, encoding=\"utf-8\") as","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:2:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#bpe-tokenizer"},{"categories":null,"content":" Torch Infra","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:3:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#torch-infra"},{"categories":null,"content":" Linear python class Linear(nn.Module): def __init__( self, in_features: int, out_features: int, device: Optional[torch.device]=None, dtype: Optional[torch.dtype]=None ): \"\"\" è®¡ç®—æ—¶å€™æ˜¯ y=xW^T,å­˜å‚¨çš„æ˜¯ W è€Œä¸æ˜¯ W^T,æ‰€ä»¥è¦åè¿‡æ¥ \"\"\" super(Linear, self).__init__() factory_kwargs = {\"device\": device, \"dtype\": dtype} self.in_features = in_features self.out_features = out_features self.weight = nn.Parameter(torch.rand((out_features, in_features), **factory_kwargs)) self.init_parameter() def init_parameter(self): std = math.sqrt(2 / (self.in_features + self.out_features)) nn.init.trunc_normal_(self.weight, mean=0, std=std, a=-3*std, b=3*std) def forward(self, x: torch.Tensor) -\u003e torch.Tensor: \"\"\" x è¿™é‡Œæ˜¯è¡Œå‘é‡ï¼Œæ‰€ä»¥è¿›è¡Œçš„å˜åŒ–æ˜¯ y=xW^T \"\"\" return torch.matmul(x, self.weight.T) adapter ä¸­éœ€è¦æ³¨æ„ï¼šæ›´æ–° module å‚æ•°æ—¶å€™ä¸èƒ½ç›´æ¥ linear.weight = weightã€‚ python def run_linear( d_in: int, d_out: int, weights: Float[Tensor, \" d_out d_in\"], in_features: Float[Tensor, \" ... d_in\"], ) -\u003e Float[Tensor, \" ... d_out\"]: from infra.linear import Linear device, dtype = in_features.device, in_features.dtype linear = Linear(d_in, d_out, device, dtype) linear.load_state_dict({'weight': weights}) return linear.forward(x=in_features) ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:3:1","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#linear"},{"categories":null,"content":" Embedding python class Embedding(nn.Module): def __init__( self, num_embeddings: int, embedding_dim: int, device: Optional[torch.device]=None, dtype: Optional[torch.dtype]=None ) -\u003e None: super(Embedding, self).__init__() factory_kwargs = {\"device\": device, \"dtype\": dtype} self.num_embeddings = num_embeddings self.embedding_dim = embedding_dim self.embed = nn.Parameter(torch.rand((num_embeddings, embedding_dim), **factory_kwargs)) self.init_parameter() def init_parameter(self): nn.init.trunc_normal_(self.embed, mean=0, std=1, a=-3, b=3) def forward(self, x: torch.Tensor): return self.embed[x] python def run_embedding( vocab_size: int, d_model: int, weights: Float[Tensor, \" vocab_size d_model\"], token_ids: Int[Tensor, \" ...\"], ) -\u003e Float[Tensor, \" ... d_model\"]: from infra.embedding import Embedding device, dtype = weights.device, weights.dtype embedding = Embedding(vocab_size, d_model, device, dtype) embedding.load_state_dict({\"embed\": weights}) return embedding.forward(token_ids) ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:3:2","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#embedding"},{"categories":null,"content":" RMSNormRMSNorm(x)=x1Hâˆ‘i=1Hxi2+Ïµâˆ—W \\text{RMSNorm}(x) = \\frac{x}{\\sqrt{\\frac{1}{H} \\sum_{i=1}^{H} x_i^2 + \\epsilon}} * W RMSNorm(x)=H1â€‹âˆ‘i=1Hâ€‹xi2â€‹+Ïµâ€‹xâ€‹âˆ—W python class RMSNorm(nn.Module): def __init__( self, d_model: int, eps: float=1e-5, device: Optional[torch.device]=None, dtype: Optional[torch.dtype]=None ): super(RMSNorm, self).__init__() factory_kwargs = {\"device\": device, \"dtype\": dtype} self.eps = eps self.weight = nn.Parameter(torch.ones((d_model), **factory_kwargs)) def forward(self, x: torch.Tensor): in_type = x.dtype x = x.to(torch.float32) mean = torch.mean(x**2, dim=-1, keepdim=True) norm = x / torch.sqrt(mean + self.eps) * self.weight return norm.to(in_type) torch.mean éœ€è¦è®¾ç½® keepdimï¼Œå¦åˆ™å½¢çŠ¶ä¸º [batch_size, seq_len]ï¼Œæ²¡åŠæ³•å¹¿æ’­å’Œ x ç›¸é™¤ã€‚ python def run_rmsnorm( d_model: int, eps: float, weights: Float[Tensor, \" d_model\"], in_features: Float[Tensor, \" ... d_model\"], ) -\u003e Float[Tensor, \" ... d_model\"]: from infra.rms_norm import RMSNorm device, dtype = weights.device, weights.dtype rms_norm = RMSNorm(d_model, eps, device, dtype) rms_norm.load_state_dict({\"weight\": weights}) return rms_norm.forward(in_features) ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:3:3","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#rmsnorm"},{"categories":null,"content":" SwiGLUFFN(x)=SwiGLU(x,W1,W2,W3)=W2(SiLU(W1)âŠ™W3x) FFN(x) = SwiGLU(x, W_1, W_2, W_3) = W_2(SiLU(W_1) \\odot W_3x) FFN(x)=SwiGLU(x,W1â€‹,W2â€‹,W3â€‹)=W2â€‹(SiLU(W1â€‹)âŠ™W3â€‹x) python class SwiGLU_FFN(nn.Module): def __init__( self, d_model: int, d_ff: int, device: Optional[torch.device]=None, dtype: Optional[torch.dtype]=None ): super(SwiGLU_FFN, self).__init__() factory_kwargs = {\"device\": device, \"dtype\": dtype} self.d_ff = d_ff self.d_model = d_model self.w1 = nn.Parameter(torch.rand((d_ff, d_model), **factory_kwargs)) self.w2 = nn.Parameter(torch.rand((d_model, d_ff), **factory_kwargs)) self.w3 = nn.Parameter(torch.rand((d_ff, d_model), **factory_kwargs)) self.init_parameter() def init_parameter(self): nn.init.normal_(self.w1, mean=0, std=math.sqrt(2/self.d_ff)) nn.init.normal_(self.w2, mean=0, std=math.sqrt(2/self.d_model)) nn.init.normal_(self.w3, mean=0, std=math.sqrt(2/self.d_ff)) def SiLU(self, x: torch.Tensor): return x * torch.sigmoid(x) def forward(self, x: torch.Tensor): return (self.SiLU(x @ self.w1.T) * (x @ self.w3.T)) @ self.w2.T python def run_swiglu( d_model: int, d_ff: int, w1_weight: Float[Tensor, \" d_ff d_model\"], w2_weight: Float[Tensor, \" d_model d_ff\"], w3_weight: Float[Tensor, \" d_ff d_model\"], in_features: Float[Tensor, \" ... d_model\"], ) -\u003e Float[Tensor, \" ... d_model\"]: from infra.swiglu import SwiGLU_FFN device, dtype = w1_weight.device, w1_weight.dtype swiglu = SwiGLU_FFN(d_model, d_ff, device, dtype) swiglu.load_state_dict({ \"w1\": w1_weight, \"w2\": w2_weight, \"w3\": w3_weight }) return swiglu.forward(in_features) ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:3:4","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#swiglu"},{"categories":null,"content":" RoPE python class RoPE(nn.Module): def __init__( self, theta: float, d_k: int, max_seq_len: int, device: Optional[torch.device]=None ): super(RoPE, self).__init__() position = torch.arange(max_seq_len, device=device, dtype=torch.float32) # [max_len] freq = 1.0 / (theta ** (torch.arange(0, d_k, 2, device=device, dtype=torch.float32) / d_k)) sinusoid = torch.outer(position, freq) rot = torch.exp(1j * sinusoid) # [max_seq_len, dim//2] self.register_buffer(\"rot_cache\", rot) def forward(self, qk: torch.Tensor, token_positions: torch.Tensor): *_, dim = qk.shape assert dim % 2 == 0, \"dim must be even\" qk_complex = qk.view(*qk.shape[:-1], dim//2, 2) # [bsize, nheads, seq_len, dim//2, 2] qk_complex = torch.view_as_complex(qk_complex) # [bsize, nheads, seq_len, dim//2] rotated_qk_complex = qk_complex * self.rot_cache[token_positions] rotated_qk = torch.view_as_real(rotated_qk_complex) # [bsize, nheads, seq_len, dim//2, 2] rotated_qk = rotated_qk.view_as(qk) return rotated_qk ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:3:5","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#rope"},{"categories":null,"content":" Softmaxsoftmax(xi)=exiâˆ‘jdimexj softmax(x_i)=\\frac{e^{x_i}}{\\sum_j^{dim}{e^{x_j}}} softmax(xiâ€‹)=âˆ‘jdimâ€‹exjâ€‹exiâ€‹â€‹ python def softmax(in_features: torch.Tensor, dim: int): max_features = in_features.max(dim=dim, keepdim=True).values exp = torch.exp(in_features - max_features) return exp / exp.sum(dim=dim, keepdim=True) softmax ä¸­æœ‰æŒ‡æ•°è¿ç®—ï¼Œå¦‚æœ $x_i$ çš„å€¼éå¸¸å¤§å¯èƒ½å¯¼è‡´æŒ‡æ•°çˆ†ç‚¸ï¼Œinf/inf å°±ä¼šå¯¼è‡´ nan é”™è¯¯ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å‡å»æœ€å¤§å€¼ï¼Œå˜æˆéƒ½æ˜¯å°ç­‰äº 0 çš„æ•°å­—ã€‚ ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:3:6","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#softmax"},{"categories":null,"content":" Scaled Dot Attention python def scaled_dot_production_attention( q: torch.Tensor, k: torch.Tensor, v: torch.Tensor, mask: Optional[torch.Tensor]=None ): *_, d_k = q.shape scores = q @ k.transpose(-1, -2) / np.sqrt(d_k) if mask is not None: scores = scores.masked_fill(mask==False, float(\"-inf\")) attn = softmax(scores, dim=-1) attn = attn @ v return attn è¿™é‡Œæœ‰å‡ ä¸ªå°å‘ï¼š scores.masked_fill_ æ˜¯åŸåœ°æ“ä½œï¼Œscores.masked_fill éœ€è¦èµ‹å€¼ ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›ä¸éœ€è¦å¤„ç†æ³¨æ„åŠ›å¤´çš„é—®é¢˜ ç”±äºæˆ‘ä»¬ç”Ÿæˆ mask æ—¶å€™ç”¨çš„æ˜¯ max_seq_lenï¼Œæ‰€ä»¥è¿›è¡Œæ©ç æ—¶å€™è¦è¿›è¡Œæˆªé•¿ã€‚ python *_, t_q, d_k = q.shape *_, t_k, d_k = k.shape scores = q @ k.transpose(-1, -2) / np.sqrt(d_k) if mask is not None: scores = scores.masked_fill(mask[:t_q, :t_k]==False, float(\"-inf\")) ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:3:7","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#scaled-dot-attention"},{"categories":null,"content":" MultiHead Attention python class Multihead_Self_Attention(nn.Module): def __init__( self, d_model: int, num_heads: int, use_rope: bool = False, device: Optional[torch.device] = None, **rope_config ): super(Multihead_Self_Attention, self).__init__() assert d_model % num_heads == 0 self.d_model = d_model self.num_heads = num_heads self.d_k = d_model // num_heads self.use_rope = use_rope if use_rope: self.rope = RoPE(**rope_config, device=device) self.q_weight = nn.Parameter(torch.rand((d_model, d_model), device=device)) self.k_weight = nn.Parameter(torch.rand((d_model, d_model), device=device)) self.v_weight = nn.Parameter(torch.rand((d_model, d_model), device=device)) self.o_weight = nn.Parameter(torch.rand((d_model, d_model), device=device)) def forward( self, x: torch.Tensor, mask: Optional[torch.Tensor], token_positions: Optional[torch.Tensor] = None, ): q = x @ self.q_weight.T k = x @ self.k_weight.T v = x @ self.v_weight.T q = q.view(*x.shape[:-1], self.num_heads, self.d_k).transpose(1, 2) k = k.view(*x.shape[:-1], self.num_heads, self.d_k).transpose(1, 2) v = v.view(*x.shape[:-1], self.num_heads, self.d_k).transpose(1, 2) if self.use_rope: q = self.rope(q, token_positions) k = self.rope(k, token_positions) attn = scaled_dot_production_attention(q, k, v, mask) attn = attn.transpose(1, 2).contiguous().view_as(x) return attn @ self.o_weight.T ä¸ºäº†åŠ é€Ÿè®¡ç®—ï¼Œå¯ä»¥æŠŠ q,k,v,o å››ä¸ªçŸ©é˜µæ”¾åœ¨ä¸€èµ·è®¡ç®—ï¼Œç”¨ä¸€ä¸ª (d_model, 4*d_model)ã€‚ ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:3:8","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#multihead-attention"},{"categories":null,"content":" Transformer","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:4:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#transformer"},{"categories":null,"content":" Transformer Block python class TransformerBlock(nn.Module): def __init__( self, d_model: int, d_ff: int, num_heads: int, use_rope: bool, device: Optional[torch.device], dtype: Optional[torch.dtype], eps: float = 1e-5, **rope_config ): super(TransformerBlock, self).__init__() self.attn = Multihead_Self_Attention(d_model, num_heads, use_rope, device, **rope_config) self.ffn = SwiGLU_FFN(d_model, d_ff, device, dtype) self.ln1 = RMSNorm(d_model, eps, device, dtype) self.ln2 = RMSNorm(d_model, eps, device, dtype) def forward(self, x: torch.Tensor, mask: Optional[torch.Tensor], token_positions: Optional[torch.Tensor]): attn_out = self.attn(self.ln1(x), mask, token_positions) residual = x + attn_out ffn_out = self.ffn(self.ln2(residual)) return residual + ffn_out å†™ adapter.py æ—¶å€™æŠŠä¹‹å‰çš„ä»£ç æ”¹äº†ä¸€ä¸‹ï¼Œä¸€å¼€å§‹æˆ‘ä»¬å®ç°äº† nn.Linear ä½†æ˜¯åé¢ç”¨çš„è¿˜æ˜¯ nn.Parameterï¼Œå¹¶ä¸”æˆ‘æŠŠå˜é‡åæ”¹æˆè¦æ±‚çš„æ ¼å¼ã€‚ python def run_transformer_block( d_model: int, num_heads: int, d_ff: int, max_seq_len: int, theta: float, weights: dict[str, Tensor], in_features: Float[Tensor, \" batch sequence_length d_model\"], ) -\u003e Float[Tensor, \" batch sequence_length d_model\"]: from infra.transformer import TransformerBlock assert d_model % num_heads == 0 device, dtype = in_features.device, in_features.dtype d_k = d_model // num_heads block = TransformerBlock( d_model, d_ff, num_heads, use_rope=True, device=device, dtype=dtype, theta=theta, max_seq_len=max_seq_len, d_k=d_k, ) weights[\"attn.o_proj.weight\"] = weights[\"attn.output_proj.weight\"] block.load_state_dict(weights, strict=False) mask = torch.tril(torch.ones((max_seq_len, max_seq_len), device=device)) B, S, _ = in_features.shape token_positions = torch.arange(S, device=device).expand(B, -1) return block(in_features, mask, token_positions) ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:4:1","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#transformer-block"},{"categories":null,"content":" Transformer LMæœ€åä¸€æ­¥å°±æ˜¯ç»„è£…æ¯ä¸€ä¸ªç»„ä»¶ï¼Œæ³¨æ„ Ttransformer æœ€åè¿”å›çš„æ˜¯æœª softmax çš„åˆ†å¸ƒï¼š python class Transformer(nn.Module): def __init__( self, vocab_size: int, context_length: int, d_model: int, d_ff: int, num_layers: int, num_heads: int, device: Optional[torch.device], dtype: Optional[torch.dtype], theta: float, d_k: int, eps: float = 1e-5, use_rope: bool = True, ): super(Transformer, self).__init__() self.device = device self.context_length = context_length self.token_embeddings = Embedding(vocab_size, d_model, device, dtype) self.layers = nn.ModuleList([ TransformerBlock(d_model, d_ff, num_heads, use_rope, device, dtype, theta, d_k, context_length, eps) for _ in range(num_layers)]) self.ln_final = RMSNorm(d_model, eps, device, dtype) self.lm_head = Linear(d_model, vocab_size) def forward(self, x: torch.Tensor): B, L = x.shape positions = torch.arange(L, device=self.device).unsqueeze(0).expand(B, L) embed = self.token_embeddings(x) attn = embed for layer in self.layers: attn = layer(attn, positions) norm = self.ln_final(attn) proj = self.lm_head(norm) # return Softmax(proj, dim=-1) return proj ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:4:2","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#transformer-lm"},{"categories":null,"content":" Training","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:5:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#training"},{"categories":null,"content":" Cross Entropy Lossäº¤å‰ç†µæŸå¤± CrossEntropyLoss å…¬å¼ä¸ºï¼š l(Î¸;D)=1âˆ£Dâˆ£mâˆ‘xâˆˆDâˆ‘i=1mâˆ’logpÎ¸(xi+1âˆ£x1:i) l(\\theta; D) = \\frac{1}{|D|m} \\sum_{x \\in D} \\sum_{i=1}^{m}-\\mathrm{log} p_{\\theta}(x_{i+1}|x_{1:i}) l(Î¸;D)=âˆ£Dâˆ£m1â€‹xâˆˆDâˆ‘â€‹i=1âˆ‘mâ€‹âˆ’logpÎ¸â€‹(xi+1â€‹âˆ£x1:iâ€‹)å…·ä½“åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š æ±‚ logits çš„å¯¹æ•°æ¦‚ç‡åˆ†å¸ƒ log_softmax æ±‚è´Ÿå¯¹æ•°ä¼¼ç„¶ ä¼¼ç„¶æ˜¯ä»€ä¹ˆï¼Ÿ å‡è®¾ç¡¬å¸æ­£é¢æœä¸Šçš„æ¦‚ç‡æ˜¯Â $\\theta$ï¼ˆæ¨¡å‹å‚æ•°ï¼‰ï¼ŒæŠ› 10 æ¬¡ç¡¬å¸ï¼Œå‡ºç° â€œæ­£æ­£åæ­£â€ è¿™æ ·çš„ç»“æœï¼ˆæ•°æ® Dï¼‰çš„æ¦‚ç‡æ˜¯ï¼š P(Dâˆ£Î¸)=Î¸Ã—Î¸Ã—(1âˆ’Î¸)Ã—Î¸=Î¸3(1âˆ’Î¸)1 P(D|\\theta) = \\theta \\times \\theta \\times (1-\\theta) \\times \\theta = \\theta^3(1-\\theta)^1 P(Dâˆ£Î¸)=Î¸Ã—Î¸Ã—(1âˆ’Î¸)Ã—Î¸=Î¸3(1âˆ’Î¸)1æ¦‚ç‡å›ç­”çš„æ˜¯ï¼šå·²çŸ¥å‚æ•° Î¸ï¼Œç»“æœ D å‘ç”Ÿçš„å¯èƒ½æ€§æœ‰å¤šå¤§ï¼Ÿ ç°åœ¨åè¿‡æ¥ï¼šæˆ‘ä»¬å·²ç»æŠ›äº† 10 æ¬¡ç¡¬å¸ï¼Œå¾—åˆ°äº† â€œæ­£æ­£åæ­£â€ è¿™ä¸ªç»“æœï¼ˆæ•°æ® Dï¼‰ï¼Œæƒ³åæ¨å‚æ•° Î¸ï¼ˆæ­£é¢æ¦‚ç‡ï¼‰åº”è¯¥å–å¤šå°‘ï¼Œæ‰èƒ½è®©è¿™ä¸ªç»“æœ â€œæœ€åˆç†â€ã€‚ä¼¼ç„¶å‡½æ•°å°±æ˜¯æŠŠæ¦‚ç‡çš„è‡ªå˜é‡åè¿‡æ¥ï¼š L(Î¸âˆ£D)=P(Dâˆ£Î¸) L(\\theta|D) = P(D|\\theta) L(Î¸âˆ£D)=P(Dâˆ£Î¸)ä¼¼ç„¶å›ç­”çš„æ˜¯ï¼šå·²çŸ¥ç»“æœ Dï¼Œå‚æ•° Î¸ å–æŸä¸ªå€¼æ—¶ï¼Œèƒ½è®©è¿™ä¸ªç»“æœå‘ç”Ÿçš„å¯èƒ½æ€§æœ‰å¤šå¤§ï¼Ÿæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰¾åˆ°è®©Â ($L(\\theta|D)$)Â æœ€å¤§çš„ Î¸ï¼ˆæœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼‰ã€‚ ä¸ºäº†ç®€åŒ–è®¡ç®—å’Œæ–¹ä¾¿åå‘ä¼ æ’­ï¼Œæˆ‘ä»¬ç±»ä¼¼ softmax çš„åšæ³•åœ¨ä¼¼ç„¶å‡½æ•°å‰é¢åŠ ä¸Š -logï¼š âˆ’logâ¡L(Î¸âˆ£D)=âˆ’logâ¡P(Dâˆ£Î¸) -\\log{L(Î¸âˆ£D)}=-\\log{P(Dâˆ£Î¸)} âˆ’logL(Î¸âˆ£D)=âˆ’logP(Dâˆ£Î¸)å¯¹äº Transformer è¿™æ ·çš„è¯­è¨€æ¨¡å‹ï¼Œæˆ‘ä»¬è®­ç»ƒç”¨ Teacher-Forcingï¼Œä¹Ÿå°±æ˜¯è¯´å¾—åˆ°çš„ç»“æœå°±å·²ç»æ˜¯ $P(\\theta_{i+1}|\\theta_{1:i})$ ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠ logits å–å¯¹æ•°æ¦‚ç‡ï¼Œç„¶åç”¨ targets å½“ç´¢å¼•å°±èƒ½å¾—åˆ°ã€‚ä¸æ­¤åŒæ—¶è€ƒè™‘åˆ° logits ç¬¬ä¸€ä¸ª dim æ˜¯ Batchï¼Œæ‰€ä»¥åº”è¯¥åº”è¯¥æ˜¯å¯¹æ¯ä¸€ä¸ª batch çš„æ¯ä¸€ä¸ª token æ±‚è´Ÿå¯¹æ•°ä¼¼ç„¶ã€‚ python def cross_entropy_with_logits( logits: torch.Tensor, targets: torch.Tensor, ignore_index: Optional[int] = None ): assert logits.dim() in (2, 3), \"dim not match\" assert targets.dim() in (1, 2), \"dim not match\" # log_prob: [batch_size, seq_len, vocab_size] log_prob = LogSoftmax(logits, dim=-1) _, vocab_size = log_prob.shape # log_prob_flat: [batch_size * seq_len, vocab_size] log_prob_flat = log_prob.reshape(-1, vocab_size) # targets_flat: [batch_size * seq_len] targets_flat = targets.reshape(-1) # tgt_log_prob: [batch_size * seq_len] tgt_log_prob = torch.gather( input=log_prob_flat, dim=1, index=targets_flat.unsqueeze(-1) ).squeeze(1) if ignore_index is not None: mask = (targets_flat != ignore_index) tgt_log_prob = tgt_log_prob[mask] return (-tgt_log_prob.sum() / mask.float().sum()) if ignore_index else -tgt_log_prob.mean() ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:5:1","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#cross-entropy-loss"},{"categories":null,"content":" OptimizeråŠ¨é‡ mt=Î²1mtâˆ’1+(1âˆ’Î²1)gtvt=Î²2vtâˆ’1+(1âˆ’Î²2)gt2 \\begin{align} m_t \u0026= \\beta_1 m_{t-1} + (1-\\beta_1) g_t \\\\ v_t \u0026= \\beta_2 v_{t-1} + (1-\\beta_2) g_t^2 \\\\ \\end{align} mtâ€‹vtâ€‹â€‹=Î²1â€‹mtâˆ’1â€‹+(1âˆ’Î²1â€‹)gtâ€‹=Î²2â€‹vtâˆ’1â€‹+(1âˆ’Î²2â€‹)gt2â€‹â€‹â€‹åå·®ä¿®æ­£ m^t=mt1âˆ’Î²1tv^t=vt1âˆ’Î²2t \\begin{align} \\hat m_t \u0026= \\frac{m_t}{1-\\beta_1^t} \\\\ \\hat v_t \u0026= \\frac{v_t}{1-\\beta_2^t} \\end{align} m^tâ€‹v^tâ€‹â€‹=1âˆ’Î²1tâ€‹mtâ€‹â€‹=1âˆ’Î²2tâ€‹vtâ€‹â€‹â€‹â€‹å‚æ•°æ›´æ–° Î¸t=Î¸tâˆ’1âˆ’Î±m^tv^t+Ïµ \\theta_t = \\theta_{t-1} - \\alpha\\frac{\\hat m_t}{\\sqrt{\\hat v_t} + \\epsilon} Î¸tâ€‹=Î¸tâˆ’1â€‹âˆ’Î±v^tâ€‹â€‹+Ïµm^tâ€‹â€‹AdamW ç›¸å¯¹ Adam åœ¨å‚æ•°æ›´æ–°é˜¶æ®µè¿›è¡Œè¡°å‡ Î¸t=Î¸tâˆ’1âˆ’Î±m^tv^t+Ïµâˆ’Î±Î»Î¸tâˆ’1 \\theta_t=\\theta_{t-1}-\\alpha\\frac{\\hat m_t}{\\sqrt{\\hat v_t}+\\epsilon}-\\alpha \\lambda \\theta_{t-1} Î¸tâ€‹=Î¸tâˆ’1â€‹âˆ’Î±v^tâ€‹â€‹+Ïµm^tâ€‹â€‹âˆ’Î±Î»Î¸tâˆ’1â€‹ python class AdamW(torch.optim.Optimizer): def __init__( self, params: Iterable[torch.nn.parameter.Parameter], lr: float = 1e-3, betas: tuple[float, float] = (0.9, 0.999), eps: float = 1e-8, weight_decay: float = 0.0, correct_bias: bool = True, ): if lr \u003c 0.0: raise ValueError(\"Invalid learning rate: {} - should be \u003e= 0.0\".format(lr)) if not 0.0 \u003c= betas[0] \u003c 1.0: raise ValueError(\"Invalid beta parameter: {} - should be in [0.0, 1.0[\".format(betas[0])) if not 0.0 \u003c= betas[1] \u003c 1.0: raise ValueError(\"Invalid beta parameter: {} - should be in [0.0, 1.0[\".format(betas[1])) if not 0.0 \u003c= eps: raise ValueError(\"Invalid epsilon value: {} - should be \u003e= 0.0\".format(eps)) defaults = dict(lr=lr, betas=betas, eps=eps, weight_decay=weight_decay, correct_bias=correct_bias) super().__init__(params, defaults) def step(self, closure: Optional[callable] = None): loss = None if closure is not None: loss = closure() for group in self.param_groups: beta1, beta2 = group[\"betas\"] eps = group[\"eps\"] wd = group[\"weight_decay\"] alpha = group[\"lr\"] for p in group[\"params\"]: if p.grad is None: continue grad = p.grad.data if grad.is_sparse: raise RuntimeError(\"Adam does not support sparse gradients, please consider SparseAdam instead\") state = self.state[p] if not state: state[\"m\"] = torch.zeros_like(p) state[\"v\"] = torch.zeros_like(p) state[\"step\"] = 0 state[\"step\"] += 1 state[\"m\"].mul_(beta1).add_(grad, alpha=1-beta1) state[\"v\"].mul_(beta2).addcmul_(grad, grad, value=1-beta2) if group[\"correct_bias\"]: step_size = alpha * math.sqrt(1 - beta2 ** state[\"step\"]) / (1 - beta1 ** state[\"step\"]) else: step_size = alpha denom = state[\"v\"].sqrt().add_(eps) p.data.addcdiv_(state[\"m\"], denom, value=-step_size) if wd != 0: p.data.add_(p.data, alpha=-alpha * wd) return loss ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:5:2","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#optimizer"},{"categories":null,"content":" å­¦ä¹ ç‡è¡°å‡ä½™å¼¦é€€ç«ç®—æ³•è¿›è¡Œå­¦ä¹ ç‡è¡°å‡ï¼š Î±t={tTwÎ±max,t\u003cTWÎ±min+12(1+cosâ¡(tâˆ’TwTcâˆ’TwÏ€))(Î±maxâˆ’Î±min),x\u003c0Î±min,t\u003eTc \\alpha_t= \\begin{cases} \\frac{t}{T_w}\\alpha_{max}, \u0026 t \u003c T_W \\\\ \\alpha_{min} + \\frac{1}{2}(1 + \\cos(\\frac{t-T_w}{T_c-T_w}\\pi))(\\alpha_{max}-\\alpha_{min}), \u0026 x \u003c 0 \\\\ \\alpha_{min} , \u0026t \u003eT_c \\end{cases} Î±tâ€‹=â©â¨â§â€‹Twâ€‹tâ€‹Î±maxâ€‹,Î±minâ€‹+21â€‹(1+cos(Tcâ€‹âˆ’Twâ€‹tâˆ’Twâ€‹â€‹Ï€))(Î±maxâ€‹âˆ’Î±minâ€‹),Î±minâ€‹,â€‹t\u003cTWâ€‹x\u003c0t\u003eTcâ€‹â€‹ python def lr_cosine_schedule( t: int, max_lr: float, min_lr: float, warmup_iters: int, cosine_iters: int ): if t \u003c warmup_iters: return t / warmup_iters * max_lr elif t \u003c= cosine_iters: return min_lr + 0.5 * (1 + math.cos((t - warmup_iters) / (cosine_iters - warmup_iters) * math.pi)) * (max_lr - min_lr) else: return min_lr ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:5:3","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#å­¦ä¹ ç‡è¡°å‡"},{"categories":null,"content":" æ¢¯åº¦è£å‰ª python def gradient_clipping( params: Iterable[torch.nn.Parameter], max_l2_norm: float, eps: float = 1e-6 ): grads = [] params_with_grad = [] numels = [] for param in params: if param.grad is not None: grads.append(param.grad.view(-1)) params_with_grad.append(param) numels.append(param.numel()) if not grads: return grads = torch.cat(grads) l2_norm = torch.norm(grads, p=2) if l2_norm \u003e max_l2_norm: grads *= max_l2_norm / (l2_norm + eps) pointer = 0 for param, numel in zip(params_with_grad, numels): grad_chunk = grads[pointer: pointer + numel].view_as(param) param.grad.copy_(grad_chunk) pointer += numel ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:5:4","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#æ¢¯åº¦è£å‰ª"},{"categories":null,"content":" Training Loopè¿™ä¸ªéƒ¨åˆ†å°±è¦æ±‚æˆ‘ä»¬å°†æ‰€æœ‰ç»„ä»¶æ‹¼åœ¨ä¸€èµ·ï¼Œå†™ä¸€ä¸ªè®­ç»ƒè„šæœ¬è®­ç»ƒ Transformeräº†ï¼Œå…ˆçœ‹ä»£ç ï¼š python from infra import ( Transformer, AdamW, cross_entropy_with_logits, get_batch, gradient_clipping, lr_cosine_schedule, save_checkpoint, ) from bpe import train_bpe, BPE_Tokenizer from pathlib import Path import numpy as np import argparse import torch import random import pickle def seed_everything(seed=11711): random.seed(seed) np.random.seed(seed) torch.manual_seed(seed) torch.cuda.manual_seed(seed) torch.cuda.manual_seed_all(seed) torch.backends.cudnn.benchmark = False torch.backends.cudnn.deterministic = True def get_dataset_memmap(path, dtype=np.uint16): if not os.path.exists(path): raise FileNotFoundError(f\"Data file not found: {path}\") dataset = np.memmap(path, dtype=dtype, mode='r') return dataset def train(args, train_data, val_data): assert args.dmodel % args.num_heads == 0 device = torch.device(args.device) model = Transformer( vocab_size=args.vocab_size, context_length=args.context_length, dmodel=args.dmodel, d_ff=args.dff, num_layers=args.num_layers, num_heads=args.num_heads, device=device, dtype=torch.float32, theta=args.theta, d_k=args.dmodel // args.num_heads, eps=args.eps, use_rope=args.use_rope ).to(device) optim = AdamW(model.parameters(), args.lr) best_losses = float(\"inf\") for epoch in range(args.epochs): train_losses = [] model.train() for iter_num in range(args.train_steps): lr = lr_cosine_schedule( iter_num, args.max_lr, args.min_lr, args.warm_up_it, args.cosine_it ) for param_group in optim.param_groups: param_group['lr'] = lr x, y = get_batch(train_data, args.batch_size, args.context_length, device) optim.zero_grad() logits = model(x) loss = cross_entropy_with_logits(logits, y) loss.backward() gradient_clipping(model.parameters(), args.max_l2_norm) optim.step() train_losses.append(loss.item()) print(f\"epoch-{epoch} train loss: {train_losses[-1]:.4f}\") if epoch % args.val_interval == 0: model.eval() val_losses = [] with torch.no_grad(): for _ in range(args.val_batches): x, y = get_batch(val_data, args.batch_size, args.context_length, device) logits = model(x) loss = cross_entropy_with_logits(logits, y) val_losses.append(loss.item()) print(f\"epoch-{epoch} validate loss: {val_losses[-1]:.4f}\") if val_losses[-1] \u003c best_losses: best_losses = val_losses[-1] filepath = Path(args.save_fp) / \"checkpoint.pt\" save_checkpoint(model, optim, iter_num, filepath) print(\"checkpoint saved\") def get_args(): parser = argparse.ArgumentParser() # --- basic config --- parser.add_argument(\"--seed\", type=int, default=11711) parser.add_argument(\"--epochs\", type=int, default=20) parser.add_argument(\"--train_steps\", type=int, default=100) parser.add_argument(\"--batch_size\", type=int, default=20) parser.add_argument(\"--val_interval\", type=int, default=5) parser.add_argument(\"--val_batches\", type=int, default=100) # --- bpe --- parser.add_argument(\"--bpe_fp\", type=str) parser.add_argument(\"--vocab_size\", type=int, default=10000) # --- optim config --- parser.add_argument(\"--lr\", type=float, default=1e-5) parser.add_argument(\"--max_lr\", type=float, default=1e-3) parser.add_argument(\"--min_lr\", type=float, default=1e-4) parser.add_argument(\"--warm_up_it\", type=int, default=500) parser.add_argument(\"--cosine_it\", type=int, default=10000) parser.add_argument(\"--max_l2_norm\", type=float, default=1.0) # --- transformer config --- parser.add_argument(\"--context_length\", type=int, default=256) parser.add_argument(\"--dmodel\", type=int, default=512) parser.add_argument(\"--dff\", type=int, default=2048) parser.add_argument(\"--num_layers\", type=int, default=12) parser.add_argument(\"--num_heads\", type=int, default=8) parser.add_argument(\"--theta\", type=float, default=10000) parser.add_argument(\"--eps\", type=float, default=1e-5) parser.add_argument(\"--use_rope\", type=bool, default=True) # --- filepath --- parser.add_argument(\"--train_dataset_fp\", type=str) parser.add_argument(\"--validate_dataset_fp\", type=str) parser.add_argument(\"--save_fp\", type=str) return parser.parse_args() ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:6:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#training-loop"},{"categories":null,"content":" ä¼˜åŒ– train_bpeç„¶åç¬¬ä¸€ä¸ªé—®é¢˜å°±å‡ºç°é—®é¢˜äº†ï¼Œè™½ç„¶æˆ‘çš„ train_bpe é€šè¿‡äº† pytestï¼Œä½†æ˜¯åœ¨ TinyStoriesValid æ•°æ®é›†ä¸Šè¿›è¡Œè®­ç»ƒæ—¶å€™é¢„ä¼°è¦è¿›è¡Œåå‡ ä¸ªå°æ—¶ï¼Œæ‰€ä»¥æˆ‘éœ€è¦å¯¹ train_bpe è¿›è¡Œä¿®æ”¹==ã€‚ æˆ‘åœ¨ TinyStoriesValid æ•°æ®é›†ä¸Šè®­ç»ƒï¼Œå°† vocab_size è®¾ä¸º 300 æ€»è€—æ—¶ 5 åˆ†é’Ÿï¼Œé€šè¿‡ scalene å¯¹æ€§èƒ½è¿›è¡Œåˆ†æå¾—åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š å¯¹æ—¶é—´è¿›è¡Œé™åºï¼Œå¯ä»¥çœ‹åˆ°é“¾è¡¨çš„æ“ä½œè€—æ—¶æ˜¯æœ€é•¿çš„ï¼š==Python ä¸­æŒ‡é’ˆæ“ä½œæ˜¯éå¸¸è€—æ—¶çš„ï¼Œå®ƒä¸ C/C++ ä¸åŒï¼Œå±æ€§æŸ¥æ‰¾ã€æŒ‡é’ˆè§£å¼•ç”¨ç­‰ç­‰æ“ä½œå¼€é”€éå¸¸å¤§==ï¼Œæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ç¬¬ä¸€ä¸ªä¼˜åŒ–æ–¹å‘æ˜¯å°†é“¾è¡¨å˜æˆç®€å•çš„ list[list[int]]ã€‚ äºæ˜¯æˆ‘åˆ é™¤äº† back_link å’Œ linklistï¼Œç”¨ pair_to_indice: dict[tuple[int,int], tuple[int, int]] æ¥å­˜å‚¨ã€‚ python pair_counts: dict[tuple[int, int], int] = defaultdict(int) pair_to_indice: dict[tuple[int, int], set[tuple[int, int]]] = defaultdict(set) ids = [list(subword.encode(\"utf-8\")) for subword in ids] for i, token_ids in enumerate(ids): for j in range(len(token_ids)-1): pair = (token_ids[j], token_ids[j+1]) pair_counts[pair] += 1 pair_to_indice[pair].add((i, j)) merges ç»´æŠ¤é˜¶æ®µçš„æ€è·¯ä¹Ÿå‚è€ƒä¹‹å‰çš„æ€è·¯ï¼Œå¯¹äº [p, a, b, q] â†’ [p, X, q]ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´æ–° (p, a), (a, b), (b, q), (p, X), (X, q) çš„ pair_counts å’Œ pair_to_indiceã€‚ python related_indices = pair_to_indice[pair].copy() for i, j in related_indices: if ids[i][j] != pair[0] or len(ids[i]) \u003c= j+1 or ids[i][j+1] != pair[1]: continue # === 1 === if j \u003e 0: old_prev_pair = (ids[i][j-1], ids[i][j]) new_prev_pair = (ids[i][j-1], new_token_id) pair_counts[old_prev_pair] -= 1 pair_counts[new_prev_pair] += 1 pair_to_indice[old_prev_pair].discard((i, j-1)) pair_to_indice[new_prev_pair].add((i, j-1)) heapq.heappush(heap, HeapItem(pair_counts[old_prev_pair], *old_prev_pair, vocab)) heapq.heappush(heap, HeapItem(pair_counts[new_prev_pair], *new_prev_pair, vocab)) # === 2 === if j + 2 \u003e len(ids[i]): old_next_pair = (ids[i][j+1], ids[i][j+2]) new_next_pair = (new_token_id, ids[i][j+2]) pair_counts[old_next_pair] -= 1 pair_counts[new_next_pair] += 1 pair_to_indice[old_next_pair].discard(i, j+1) pair_to_indice[new_next_pair].add((i, j)) heapq.heappush(heap, HeapItem(pair_counts[old_next_pair], *old_next_pair, vocab)) heapq.heappush(heap, HeapItem(pair_counts[new_next_pair], *new_next_pair, vocab)) # === 3 === to_merge_token_ids = ids[i] new_token_ids = [] i = 0 while i \u003c len(to_merge_token_ids): if i \u003c len(to_merge_token_ids) - 1 and (to_merge_token_ids[i], to_merge_token_ids[i+1] == pair): new_token_ids.append(new_token_id) i += 2 else: new_token_ids.append(to_merge_token_ids[i]) i += 1 ids[i] = to_merge_token_ids del pair_counts[pair] del pair_to_indice[pair] ä½†æ˜¯è¿™æ ·çš„æ€è·¯ä»ç„¶å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå½“æˆ‘ä»¬ä¿®æ”¹ ids ä¹‹åï¼Œpair_to_indice é‡Œé¢çš„ç´¢å¼•å…¨éƒ¨åç§»äº†ï¼ˆä¹‹å‰æˆ‘ä»¬ç”¨çš„æ˜¯èŠ‚ç‚¹æ‰€ä»¥æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼‰ã€‚æœ€ç®€å•çš„è§£å†³æ€è·¯æ˜¯ï¼Œé‚£æˆ‘ä»¬æŠŠå­˜å‚¨çš„ (i, j) å˜æˆå­˜ iï¼Œç„¶åå» ids[i] é‡Œé¢æœç´¢è¡Œä¸è¡Œï¼Ÿè¿™æ ·å­æ¯æ¬¡æœç´¢å°±éœ€è¦éå† ids[i]ï¼Œä¸å¦‚ç›´æ¥æŠŠ ids[i] å…¨éƒ¨æ›´æ–°ä¸€éã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æŠŠ ids[i] é‡Œé¢æ¯ä¸€ä¸ª pair éƒ½å»æ‰ counts å’Œ pair_to_indiceï¼Œç„¶åæŠŠ merge ä¹‹åæ–°çš„ ids[i] é‡Œé¢æ¯ä¸ª pair å†æ›´æ–° counts å’Œ pair_to_indiceã€‚ python def train_bpe(input_path: str, vocab_size: int, special_tokens: list[str]): PAT = r\"\"\"'(?:[sdmt]|ll|ve|re)| ?\\p{L}+| ?\\p{N}+| ?[^\\s\\p{L}\\p{N}]+|\\s+(?!\\S)|\\s+\"\"\" vocab = {} merges = [] for i in range(256): bt = bytes([i]) vocab[i] = bt for tok in special_tokens: # special_token ä¸å¯åˆ†å‰² vocab[len(vocab)] = tok.encode(\"utf-8\") with open(input_path, \"r\", encoding=\"utf-8\") as f: text = f.read() ids = [] if special_tokens: toks = sorted(special_tokens, key=len, reverse=True) union = \"|\".join(re.escape(t) for t in toks) parts = re.split(f\"({union})\", text) st = set(special_tokens) for part in parts: if not part or part in st: continue ids.extend(re.findall(PAT, part)) else: ids = re.findall(PAT, text) pair_counts: dict[tuple[int, int], int] = defaultdict(int) # pair_to_indice å­˜å‚¨çš„æ˜¯ pair ä½äº subwordsçš„[i] ,set[i] pair_to_indice: dict[tuple[int, int], set[tuple[int, int]]] = defaultdict(set) ids = [list(subword.encode(\"utf-8\")) for subword in ids] for i, token_ids in enumerate(ids): for j in range(len(token_ids)-1): pair = (token_ids[j], token_ids[j+1]) pair_counts[pair] += 1 pair_to_indice[pair].add(i) while len(vocab) \u003c vocab_size: if not pair_counts: break best_pair = max(pair_counts.items(), key=lambda x:(x[1], (vocab[x[0][0]], vocab[x[0][1]])))[0] merges.append((vocab[best_pair[0]], vocab[best_pair[1]])) new_token_id = len(vocab) vocab[new_token_id] = vocab[best_pair[0]] + vocab[best_pair[1]] r","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:6:1","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#ä¼˜åŒ–-train_bpe"},{"categories":null,"content":" ä¼˜åŒ– tokenizer encodeå…¶æ¬¡ï¼Œåœ¨ç”¨ BPE å¯¹æ•°æ®é›†è¿›è¡Œ Encode çš„è¿‡ç¨‹ä¸­å‡ºç°äº† Out of Memory çš„é”™è¯¯ï¼Œäºæ˜¯å¾—æ‰¾ä¸€ä¸ªæ–°çš„åŠæ³•ï¼š==é¦–å…ˆæˆ‘ä»¬ä¸åº”è¯¥ä»æ–‡ä»¶ä¸­ç›´æ¥è¯»å‡ºå…¨éƒ¨æ–‡æœ¬ï¼Œä¸€è¡Œä¸€è¡Œè¯»å¹¶ä¸” Encode å¯ä»¥èŠ‚çœå†…å­˜ï¼›å…¶æ¬¡å† buffer ä¸­å·²ç»å­˜äº†ä¸€å®š encode_ids å°±å¯ä»¥æŠŠä»–ç›´æ¥è½ç›˜== python from bpe import BPE_Tokenizer from pathlib import Path import numpy as np import pickle def encode_from_file( tokenizer: BPE_Tokenizer, in_filepath: str, out_filepath: str, chunk_size: int = 1024 * 1024 ): in_path = Path(in_filepath) out_path = Path(out_filepath) assert in_path.exists() if not out_path.exists(): with open(out_path, \"wb\"): pass buffer = [] with open(in_path, \"r\", encoding=\"utf-8\") as fin, open(out_path, \"ab\") as fout: for i, line in enumerate(fin): ids = tokenizer.encode(line) buffer.extend(ids) if len(buffer) \u003e= chunk_size: np.asarray(buffer, dtype=np.uint16).tofile(fout) buffer.clear() if i % 100_000 == 0: print(\"processed\", i) if buffer: np.array(buffer, dtype=np.uint16).tofile(fout) é™¤æ­¤ä¹‹å¤–ï¼ŒEncode é‡Œé¢ä¹Ÿç”¨äº†é“¾è¡¨æ—¶é—´å¼€é”€éå¸¸å¤§ï¼š python def encode_non_special(self, subword: str) -\u003e list[int]: tokens = [bytes([byte_id]) for byte_id in subword.encode(\"utf-8\")] if len(tokens) == 1: return [self.rev_vocab[tokens[0]]] while len(tokens) \u003e= 2: pairs = list(zip(tokens[:-1], tokens[1:])) pair = min(pairs, key=lambda p:self.merges_rank.get(p, INF)) if pair not in self.merges_rank: break new_token = pair[0] + pair[1] i=0 new_tokens = [] while i \u003c len(tokens): if i \u003c len(tokens) - 1 and (tokens[i], tokens[i+1]) == pair: new_tokens.append(new_token) i += 2 else: new_tokens.append(tokens[i]) i += 1 tokens = new_tokens return [self.rev_vocab[token] for token in tokens] TinyStories_sample_5M æ•°æ®é›†ä¸Š Encode è€—æ—¶ç¼©çŸ­äº†ä¸€åŠã€‚ ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:6:2","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#ä¼˜åŒ–-tokenizer-encode"},{"categories":null,"content":" è®­ç»ƒ Transformerç°åœ¨æˆ‘ä»¬å¯ä»¥æ­£å¼å¼€å§‹è®­ç»ƒäº†ã€‚ ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:6:3","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#è®­ç»ƒ-transformer"},{"categories":null,"content":" Generate Textç”Ÿæˆé˜¶æ®µæ²¡æœ‰å¤ªå¤šè¯´çš„ï¼Œgenerate æ—¶å€™å°† token_ids è¾“å…¥åˆ°æ¨¡å‹ï¼Œæœ€åä¸€ä¸ªå­—ç¬¦å¯¹åº”çš„ logits å°±æ˜¯é¢„æµ‹çš„ä¸‹ä¸€ä¸ª tokenã€‚æ‰€ä»¥æŠŠå®ƒç»è¿‡ softmax å¾—åˆ°æ¦‚ç‡åˆ†å¸ƒï¼Œå–å‡ºæœ€å¤§æ¦‚ç‡æ‰€åœ¨çš„ç´¢å¼•ï¼Œå°±èƒ½å¾—åˆ°é¢„æµ‹çš„ tokenã€‚ç„¶åæŠŠé¢„æµ‹çš„ token åŠ å…¥ token_ids ä¸æ–­é‡å¤çš„é¢„æµ‹ï¼Œå°±èƒ½å¾—åˆ°ç”Ÿæˆçš„æ–‡æœ¬ã€‚æœ€åå½“é¢„æµ‹çš„å­—ç¬¦ä¸º EOS æˆ–è€…ç”Ÿæˆæ–‡æœ¬é•¿åº¦è¾¾åˆ°ä¸Šé™å°±ç»“æŸã€‚ python def generate_text( prompt: str, max_tokens: int, temperature: float, model: Transformer, tokenizer: BPE_Tokenizer, eos_token: Optional[str] = None ): token_ids = tokenizer.encode(prompt) for _ in range(max_tokens): inp = torch.tensor(token_ids).unsqueeze(0) logits = model(inp).squeeze(0) probs = Softmax(logits, -1, temperature) # [seq_len, vocab_size] indices = probs.argmax(dim=-1) # [seq_len] next_token_id = indices[-1] if eos_token is not None and tokenizer.decode([next_token_id]).strip() == eos_token: break token_ids.append(next_token_id) return tokenizer.decode(token_ids) ç”¨å°å‹æ¨¡å‹è¿›è¡Œå®éªŒæœ‰æ—¶ä¼šç”Ÿæˆè´¨é‡å¾ˆä½çš„æ–‡æœ¬ã€‚ä¸¤ç§ç®€å•çš„è§£ç å™¨æŠ€å·§å¯ä»¥å¸®åŠ©è§£å†³è¿™äº›é—®é¢˜ã€‚é¦–å…ˆï¼Œåœ¨æ¸©åº¦ç¼©æ”¾ä¸­ï¼Œæˆ‘ä»¬ç”¨æ¸©åº¦å‚æ•°Ï„ä¿®æ”¹æˆ‘ä»¬çš„softmaxï¼Œå…¶ä¸­æ–°çš„softmaxæ˜¯è§£ç å™¨æŠ€å·§ æˆ‘ä»¬å°†ç”¨å°å‹æ¨¡å‹è¿›è¡Œå®éªŒï¼Œè€Œå°å‹æ¨¡å‹æœ‰æ—¶ä¼šç”Ÿæˆè´¨é‡å¾ˆä½çš„æ–‡æœ¬ã€‚ä¸¤ç§ç®€å•çš„è§£ç å™¨æŠ€å·§å¯ä»¥å¸®åŠ©è§£å†³è¿™äº›é—®é¢˜ã€‚ åœ¨æ¸©åº¦ç¼©æ”¾ä¸­ï¼Œæˆ‘ä»¬ç”¨æ¸©åº¦å‚æ•° Ï„ ä¿®æ”¹ softmaxã€‚ softmax(v,Ï„)i=exp(vi/Ï„)âˆ‘j=1âˆ£vocab_sizeâˆ£exp(vj/Ï„)softmax(v, \\tau)_{i}=\\frac {exp \\left(v_{i} / \\tau \\right) }{\\sum _{j=1}^{ | vocab \\_size |} exp \\left( v_{j} / \\tau \\right) }softmax(v,Ï„)iâ€‹=âˆ‘j=1âˆ£vocab_sizeâˆ£â€‹exp(vjâ€‹/Ï„)exp(viâ€‹/Ï„)â€‹ å¦ä¸€ä¸ªæŠ€å·§æ˜¯ top-p é‡‡æ · P(xt+1=iâˆ£q)={qiâˆ‘jâˆˆV(p)qjifiâˆˆV(p)0otherwise P\\left(x_{t+1}=i | q\\right)= \\begin{cases}\\frac{q_{i}}{\\sum_{j \\in V(p)} q_{j}} \u0026 if i \\in V(p) \\\\ 0 \u0026 otherwise \\end{cases} P(xt+1â€‹=iâˆ£q)={âˆ‘jâˆˆV(p)â€‹qjâ€‹qiâ€‹â€‹0â€‹ifiâˆˆV(p)otherwiseâ€‹ python def top_p_sampling(probs: torch.Tensor, p: float): sorted_probs, indices = torch.sort(probs, descending=True) accum_probs = torch.cumsum(sorted_probs, dim=-1) mask = accum_probs \u003c= p # ä¿è¯è‡³å°‘æœ‰ä¸€ä¸ª mask[..., 0] = True filitered_probs = sorted_probs * mask filitered_probs = filitered_probs / filitered_probs.sum() return indices[torch.multinomial(filitered_probs, num_samples=1).item()] def generate_text( prompt: str, max_tokens: int, temperature: float, top_p: float, model: Transformer, tokenizer: BPE_Tokenizer, eos_token: Optional[str] = None ): token_ids = tokenizer.encode(prompt) model.eval() with torch.no_grad(): for _ in range(max_tokens): inp = torch.tensor(token_ids).unsqueeze(0) logits = model(inp)[0, -1, :] scaled_logits = logits / temperature probs = Softmax(scaled_logits, dim=-1) next_token_id = top_p_sampling(probs, top_p) if eos_token is not None and tokenizer.decode([next_token_id]).strip() == eos_token: break token_ids.append(next_token_id) return tokenizer.decode(token_ids) æœ€å experiment éƒ¨åˆ†ç”±äºæ²¡æœ‰ç®—åŠ›(æ‡’å¾—æ)ï¼Œå°±ä¸åšäº†ã€‚ ","date":"2025-12-31","objectID":"/posts/cs336_assignment1/:7:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Assignment 1: Tokenizer \u0026 Transformer","uri":"/posts/cs336_assignment1/#generate-text"},{"categories":null,"content":" MSELossMSE=1Nâˆ‘i=1N(y^iâˆ’yi)2 \\text{MSE} = \\frac{1}{N} \\sum_{i=1}^{N}(\\hat y_i - y_i)^2 MSE=N1â€‹i=1âˆ‘Nâ€‹(y^â€‹iâ€‹âˆ’yiâ€‹)2 å‡æ–¹å·®æŸå¤±ä»»åŠ¡é€‚åˆç”¨äº==å›å½’ä»»åŠ¡==ã€‚ ","date":"2025-12-27","objectID":"/posts/loss/:1:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ ","Loss"],"title":"Loss Function","uri":"/posts/loss/#mseloss"},{"categories":null,"content":" CrossEntropyLossloss=âˆ’âˆ‘iCyilogâ¡pi loss = -\\sum_i^Cy_i\\log{p_i} loss=âˆ’iâˆ‘Câ€‹yiâ€‹logpiâ€‹ $C$ï¼šç±»åˆ«æ•° $y_i$ï¼šå¯¹äºæ ‡ç­¾çš„ one-hot ç¼–ç ï¼ŒçœŸå®æ ‡ç­¾ä¸º 1 $p_i$ï¼šæ¦‚ç‡åˆ†å¸ƒ æ³¨æ„ $p_i$ æ˜¯æ¦‚ç‡åˆ†å¸ƒè€Œä¸æ˜¯ logitsã€‚ ==äº¤å‰ç†µæŸå¤±å†…éƒ¨åšçš„æ˜¯ log_softmax + nll== æ¨¡å‹é€šå¸¸è¾“å‡ºçš„æ˜¯æ²¡æœ‰å½’ä¸€åŒ–çš„ logitsï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œ softmax å°†å…¶å˜æˆæ¦‚ç‡ï¼Œç„¶åæ±‚è´Ÿå¯¹æ•°ä¼¼ç„¶æŸå¤±ï¼ŒNLLLoss æœ¬è´¨å°±æ˜¯æ‹¿ log æ¦‚ç‡ï¼Œå–å‡ºçœŸå®ç±»åˆ«é‚£ä¸€é¡¹ï¼Œå–è´Ÿæ•°ï¼š \\[ nll=âˆ’\\log(p_{\\text{çœŸå®ç±»åˆ«}}â€‹) \\]å› ä¸ºå¯¹äºé”™è¯¯é¡¹ $y_i=0$ï¼Œæ‰€ä»¥å…¬å¼å¯ä»¥ç›´æ¥åŒ–ç®€ä¸ºï¼š loss=âˆ’logâ¡pi loss=-\\log{p_i} loss=âˆ’logpiâ€‹å› æ­¤ CrossEntropyLoss å‡½æ•°ä¹Ÿåªéœ€è¦ä¼ å…¥æ­£ç¡®æ ‡ç­¾ï¼Œä¸éœ€è¦ä¼ å…¥ one-hot ç¼–ç ã€‚ python import torch import torch.nn.functional as F from torch.nn import CrossEntropyLoss # å‡è®¾ï¼š # logits: [N, C] # targets: [N] N, C = 8, 10 logits = torch.randn(N, C) # shape (N, C) targets = torch.randint(0, C, (N,)) # shape (N,) # loss: criterion = CrossEntropyLoss(reduction='mean') loss = criterion(logits, targets) # shapes: # - CrossEntropyLoss expects logits: (N, C) # - targets: (N,) # - If reduction='none', output shape would be (N,) (per-sample loss) print(logits.shape, targets.shape, loss.shape) # (8,10) (8,) torch.Size([]) ==æ³¨æ„ï¼== CrossEntropyLoss å¯¹ logits å’Œ labels çš„å½¢çŠ¶æœ‰è¦æ±‚ï¼š logits: [N, C] labels: [N] æ‰€ä»¥åœ¨ NLP é—®é¢˜ä¸­é€šå¸¸è¾“å‡ºçš„ logits æ˜¯ [batch_size, seq_len, vocal_size] éœ€è¦å˜å½¢åˆ° [batch_size * seq_len, vocal_size]ï¼Œå¹¶ä¸” labels éœ€è¦å˜å½¢ä¸º [batch_size * seq_len] ","date":"2025-12-27","objectID":"/posts/loss/:2:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ ","Loss"],"title":"Loss Function","uri":"/posts/loss/#crossentropyloss"},{"categories":null,"content":" å¯¹æ•°æ¦‚ç‡é¦–å…ˆæˆ‘ä»¬ç»è¿‡æ¨¡å‹è¾“å‡ºå¾—åˆ°çš„æ˜¯ logtisï¼Œä½†æ˜¯ä»–æ˜¯ä¸€ä¸ªåˆ†å¸ƒæˆ‘ä»¬éœ€è¦é€šè¿‡ softmax æŠŠå®ƒå˜æˆä¸€ä¸ªæ¦‚ç‡ï¼š softmax(xi)=exiâˆ‘jdimexj softmax(x_i)=\\frac{e^{x_i}}{\\sum_j^{dim}{e^{x_j}}} softmax(xiâ€‹)=âˆ‘jdimâ€‹exjâ€‹exiâ€‹â€‹æˆ‘ä»¬å¯ä»¥é€šè¿‡å‡å»æœ€å¤§å€¼ç­‰æ–¹æ³•è®©å®ƒå˜å¾—æ›´ç¨³å®šã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºè®¡ç®—æŒ‡æ•°çš„å¼€é”€å¾ˆå¤§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹æ•°åŒ– prob æ¥å‡å°‘è®¡ç®—çš„æ¬¡æ•°ï¼š log_softmax=xiâˆ’logâ¡(âˆ‘jdimexj) log\\_softmax = x_i - \\log({\\sum_j^{dim}{e^{x_j}}}) log_softmax=xiâ€‹âˆ’log(jâˆ‘dimâ€‹exjâ€‹)","date":"2025-12-27","objectID":"/posts/loss/:2:1","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ ","Loss"],"title":"Loss Function","uri":"/posts/loss/#å¯¹æ•°æ¦‚ç‡"},{"categories":null,"content":" è´Ÿå¯¹æ•°ä¼¼ç„¶1. æ¦‚ç‡ï¼ˆProbabilityï¼‰ï¼šå·²çŸ¥æ¨¡å‹ï¼Œé¢„æµ‹ç»“æœ å‡è®¾ç¡¬å¸æ­£é¢æœä¸Šçš„æ¦‚ç‡æ˜¯Â $\\theta$ï¼ˆæ¨¡å‹å‚æ•°ï¼‰ï¼ŒæŠ› 10 æ¬¡ç¡¬å¸ï¼Œå‡ºç° â€œæ­£æ­£åæ­£â€ è¿™æ ·çš„ç»“æœï¼ˆæ•°æ® Dï¼‰çš„æ¦‚ç‡æ˜¯ï¼š($P(D|\\theta) = \\theta \\times \\theta \\times (1-\\theta) \\times \\theta = \\theta^3(1-\\theta)^1$) æ¦‚ç‡å›ç­”çš„æ˜¯ï¼šå·²çŸ¥å‚æ•° Î¸ï¼Œç»“æœ D å‘ç”Ÿçš„å¯èƒ½æ€§æœ‰å¤šå¤§ï¼Ÿ 2. ä¼¼ç„¶ï¼ˆLikelihoodï¼‰ï¼šå·²çŸ¥ç»“æœï¼Œåæ¨æ¨¡å‹ ç°åœ¨åè¿‡æ¥ï¼šæˆ‘ä»¬å·²ç»æŠ›äº† 10 æ¬¡ç¡¬å¸ï¼Œå¾—åˆ°äº† â€œæ­£æ­£åæ­£â€ è¿™ä¸ªç»“æœï¼ˆæ•°æ® Dï¼‰ï¼Œæƒ³åæ¨å‚æ•° Î¸ï¼ˆæ­£é¢æ¦‚ç‡ï¼‰åº”è¯¥å–å¤šå°‘ï¼Œæ‰èƒ½è®©è¿™ä¸ªç»“æœ â€œæœ€åˆç†â€ã€‚ ä¼¼ç„¶å‡½æ•°å°±æ˜¯æŠŠæ¦‚ç‡çš„è‡ªå˜é‡åè¿‡æ¥ï¼š$L(\\theta|D) = P(D|\\theta)$ ä¼¼ç„¶å›ç­”çš„æ˜¯ï¼šå·²çŸ¥ç»“æœ Dï¼Œå‚æ•° Î¸ å–æŸä¸ªå€¼æ—¶ï¼Œèƒ½è®©è¿™ä¸ªç»“æœå‘ç”Ÿçš„å¯èƒ½æ€§æœ‰å¤šå¤§ï¼Ÿæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰¾åˆ°è®©Â ($L(\\theta|D)$)Â æœ€å¤§çš„ Î¸ï¼ˆæœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼‰ã€‚ ä¸ºäº†ç®€åŒ–è®¡ç®—ï¼Œæ‰€ä»¥ç±»ä¼¼ softmax åœ¨ä¼¼ç„¶å‡½æ•°å‰é¢åŠ ä¸Š logï¼š$logL(Î¸âˆ£D)=logP(Dâˆ£Î¸)=âˆ‘logP(å•ä¸ªç»“æœâˆ£Î¸)$ ","date":"2025-12-27","objectID":"/posts/loss/:2:2","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ ","Loss"],"title":"Loss Function","uri":"/posts/loss/#è´Ÿå¯¹æ•°ä¼¼ç„¶"},{"categories":null,"content":" BCEWithLogitsLossäºŒå…ƒäº¤å‰ç†µæŸå¤±ç”¨äºäºŒåˆ†ç±»é—®é¢˜ï¼š python # logits: [N] or [N, 1] # targets: [N] (0/1 floats or ints) import torch from torch.nn import BCEWithLogitsLoss N = 12 logits = torch.randn(N) # shape (N,) targets = torch.randint(0, 2, (N,)).float() # shape (N,) criterion = BCEWithLogitsLoss(reduction='mean') loss = criterion(logits, targets) # scalar # shapes: # - if logits shape is (N,), targets must be (N,) # - you can also use logits (N,1) and targets (N,1) print(logits.shape, targets.shape, loss.shape) æ³¨æ„ BCEWithLogitsLoss è¦æ±‚ logits å’Œ targets çš„å½¢çŠ¶ç›¸åŒ äºŒåˆ†ç±»é—®é¢˜é™¤äº†ç”¨äºŒå…ƒäº¤å‰ç†µè¿˜å¯ä»¥é€šè¿‡äº¤å‰ç†µæŸå¤±æ¥è®¡ç®—ï¼Œå°† logits æŠ•å½±åˆ° [N, 2] å°±å¯ä»¥äº†ã€‚ äºŒå…ƒäº¤å‰ç†µæŸå¤±ä¹Ÿå¯ä»¥ç”¨äºå¤šæ ‡ç­¾é—®é¢˜ python # B æŒ‡çš„æ˜¯ batch_size # C æŒ‡çš„æ˜¯æ ‡ç­¾ä¸ªæ•° label_size import torch from torch.nn import BCEWithLogitsLoss B, C = 4, 6 logits = torch.randn(B, C) # (B, C) targets = torch.randint(0, 2, (B, C)).float() # (B, C) criterion = BCEWithLogitsLoss(reduction='mean') loss = criterion(logits, targets) # scalar # shapes: # - logits: (B, C) # - targets: (B, C) # - if reduction='none', output shape would be (B, C) -- per-label loss print(logits.shape, targets.shape, loss.shape) ","date":"2025-12-27","objectID":"/posts/loss/:3:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ ","Loss"],"title":"Loss Function","uri":"/posts/loss/#bcewithlogitsloss"},{"categories":null,"content":" LSTM åŸºç¡€æ¦‚å¿µLSTM åœ¨ RNN çš„åŸºç¡€ä¸Šå¾ˆå¥½çš„è§£å†³äº†é•¿è·ç¦»è¯¦ç»†ä¼ é€’çš„é—®é¢˜ï¼Œå®ƒå¼•å…¥äº† Cell State å’Œä¸‰ä¸ªé—¨ Forget Gate, Input Gate å’Œ Output Gate æ¥ä¼ è¾“è®°å¿†å’Œå†³å®šå“ªäº›è®°å¿†æ˜¯éœ€è¦çš„ï¼Œå“ªäº›ä¸éœ€è¦ã€‚ é—å¿˜é—¨ï¼šæ ¹æ®$h^{t-1}$å’Œ$x^t$åˆ¤æ–­ Cell State å“ªä¸€äº›éœ€è¦é—å¿˜ è¾“å…¥é—¨ï¼šæ ¹æ®$h^{t-1}$å’Œ$x^t$åˆ¤æ–­éœ€è¦å‘ Cell State ä¼ å…¥å“ªäº›å½“å‰ä¿¡æ¯ è¾“å‡ºé—¨ï¼šæ ¹æ®$h^{t-1}$å’Œ$x^t$åˆ¤æ–­éœ€è¦ä» Cell State ä¸­è¾“å‡ºå“ªäº›ä¿¡æ¯ \\[ f^t = \\sigma(h^{t-1} @ W_{hf} + x_t @ W_{xf} + b_f) \\\\ i^t = \\sigma(h^{t-1} @ W_{hi} + x_t @ W_{xi} + b_i) \\\\ o^t = \\sigma(h^{t-1} @ W_{ho} + x_t @ W_{xo} + b_o) \\\\ c^{\\~t} = \\tanh(h^{t-1} @ W_{hc} + x_t @ W_{xc} + b_c) \\\\ c^t = f^t * c^{t-1} + i^t * c^{\\~t} \\\\ h^t = o^t * \\tanh(c^t) \\]sigmoid æ¿€æ´»å‡½æ•°ä¼šå°†è®¡ç®—ç»“æœéšå°„åˆ° 0-1 çš„åŒºé—´ï¼Œç„¶åä¸ $c^{t-1}$ç›¸ä¹˜ã€‚å€¼è¶Šæ¥è¿‘äº 1ï¼Œå†å²è®°å¿†å°±ä¿ç•™ï¼›ç›¸åå€¼è¶‹äº 0ï¼Œå†å²è®°å¿†å°±é—å¿˜ã€‚ ä¸ºä»€ä¹ˆ LSTM ç›¸å¯¹äº RNN èƒ½å¤Ÿè®°å¿†æ›´é•¿çš„è®°å¿†ï¼Ÿ æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ RNN çš„å…¬å¼ï¼š ht=tanh(Wxâ‹…xt+Whâ‹…htâˆ’1+bh) h_t=tanh(Wx \\cdot x_t + W_h \\cdot h_{t-1} + b_h) htâ€‹=tanh(Wxâ‹…xtâ€‹+Whâ€‹â‹…htâˆ’1â€‹+bhâ€‹)ç”±äºå‚æ•°çŸ©é˜µæ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥è¿›è¡Œåå‘ä¼ æ’­æ—¶å€™ï¼Œæ¢¯åº¦è¦ä¹ˆä¼šéå¸¸å¤§è¦ä¹ˆä¼šéå¸¸å°ã€‚ ä½†æ˜¯å¯¹äº LSTMï¼Œå®ƒçš„ä¸‰ä¸ªé—¨æ§æœºåˆ¶å¯ä»¥é€‰æ‹©æ¯æ¬¡ä¿ç•™ or é—å¿˜è®°å¿†ï¼Œä½¿å¾—å†å²è®°å¿†å¯ä»¥é•¿æœŸä¿å­˜ã€‚ä¸¾ä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼Œé—å¿˜é—¨æ€»æ˜¯ä¸º 1ï¼Œè¾“å…¥é—¨æ€»æ˜¯ä¸º 0ï¼Œé‚£ä¹ˆå†å²è®°å¿†å°±èƒ½ä¸€ç›´åœ¨ Cell State ä¸Šæµé€šã€‚ å®é™…ä¸Šï¼ŒLSTM ä¸å…‰æ˜¯è§£å†³äº†é•¿è·ç¦»ä¾èµ–çš„é—®é¢˜ï¼Œå®ƒçš„å„ç§é—¨ï¼Œä½¿å¾—æ¨¡å‹çš„å­¦ä¹ æ½œåŠ›å¤§å¤§æå‡ï¼Œå„ç§é—¨çš„å¼€é—­çš„ç»„åˆï¼Œè®©æ¨¡å‹å¯ä»¥å­¦ä¹ å‡ºè‡ªç„¶è¯­è¨€ä¸­å„ç§å¤æ‚çš„å…³ç³»ã€‚æ¯”å¦‚é—å¿˜é—¨çš„ä½¿ç”¨ï¼Œå¯ä»¥è®©æ¨¡å‹å­¦ä¹ å‡ºä»€ä¹ˆæ—¶å€™è¯¥æŠŠå†å²çš„ä¿¡æ¯ç»™å¿˜æ‰ï¼Œè¿™æ ·å°±å¯ä»¥è®©æ¨¡å‹åœ¨ç‰¹ç‚¹çš„æ—¶å€™æ’é™¤å¹²æ‰°ã€‚ ","date":"2025-12-19","objectID":"/posts/lstm/:1:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#lstm-åŸºç¡€æ¦‚å¿µ"},{"categories":null,"content":" åŸºäº LSTM çš„ IMDB æ–‡æœ¬æƒ…æ„Ÿåˆ†ç±»é¡¹ç›®","date":"2025-12-19","objectID":"/posts/lstm/:2:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#åŸºäº-lstm-çš„-imdb-æ–‡æœ¬æƒ…æ„Ÿåˆ†ç±»é¡¹ç›®"},{"categories":null,"content":" è¯åµŒå…¥æ•°æ®é›†ä¸­åŸºäºäº† pos å’Œ neg çš„è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼Œæ¯ä¸ª txt æ–‡ä»¶åŒ…å« 2w è¡Œçš„ç”µå½±è¯„è®ºã€‚æˆ‘çš„æƒ³æ³•æ˜¯å°†è¯„è®ºçš„å¥å­é€šè¿‡ç©ºæ ¼è¿›è¡Œåˆ†å‰²ï¼Œå¾—åˆ°ä¸€ä¸ªä¸ª tokenï¼Œä¹‹åå¯ä»¥é€šè¿‡ token2id çš„æ˜ å°„å°† list[str] å˜æˆ list[int]ï¼Œè¿™å°±æ˜¯è¾“å…¥å‘é‡ x äº†ã€‚ token2id æˆ‘é€šè¿‡ç»§æ‰¿ dict å®ç°äº†ä¸€ä¸ª Vocal ç±»ï¼Œæ›´æ–¹ä¾¿æˆ‘åŠ å…¥å¡«å…… token\u003cPAD\u003e å’ŒæœªçŸ¥å­—ç¬¦\u003cUNK\u003eï¼š python class Vocal(dict): def __init__( self, train_texts: list, test_texts: list, unk_token: str = \"\u003cUNK\u003e\", pad_token: str = \"\u0026lt;PAD\u0026gt;\" ): super().__init__() self.unk_token = unk_token self.pad_token = pad_token self[self.unk_token] = 0 self[self.pad_token] = 1 for sentense in train_texts: for token in sentense: if token not in self: self[token] = len(self) for sentense in test_texts: for token in sentense: if token not in self: self[token] = len(self) def __getitem__(self, key: str) -\u003e int: if key not in self: key = self.unk_token return dict.__getitem__(self, key) x è¾“å…¥åˆ°æ¨¡å‹ä¹‹åé€šè¿‡ lookup å°†ä¸€ä¸ªä¸ªåºå·å˜æˆ token å¯¹åº”çš„è¯å‘é‡ï¼š python class Embedding: def __init__( self, device: Literal[\"cuda\", \"cpu\"], embed_filepath: str, embed_size: int, token2id: dict ) -\u003e None: self.token2id = token2id token2vec = {} if not isinstance(embed_filepath, Path): self.embed_fp = Path(embed_filepath) assert self.embed_fp.exists(), \"embed file not found\" for line in open(self.embed_fp, \"r\").readlines(): sp = line.strip().split() token2vec[sp[0]] = torch.tensor([float(x) for x in sp[1:]], dtype=torch.float32) assert len(sp[1:]) == embed_size, f\"é¢„è®­ç»ƒå‘é‡ç»´åº¦ä¸{embed_size}ä¸ç¬¦\" self.embeddings = torch.normal( mean=0.0, std=0.9, size=(len(self.token2id), embed_size), dtype=torch.float32 ).to(device) for token, idx in self.token2id.items(): if token in token2vec: self.embeddings[idx] = token2vec[token].to(device) elif token.lower() in token2vec: self.embeddings[idx] = token2vec[token.lower()].to(device) def lookup(self, w: np.array) -\u003e np.array: # w=[batch_size, seq_len] o=[batch_size, seq_len, embed_size] return self.embeddings[w] è¯å‘é‡æˆ‘ç”¨çš„æ˜¯ CS224N Assignment2 é‡Œé¢æä¾›çš„è¯å‘é‡å­—å…¸ï¼Œä¸ºäº†é˜²æ­¢è¯å‘é‡ä¸èƒ½å®Œå…¨è¦†ç›– imdb æ•°æ®é›†çš„å…¨éƒ¨ tokenï¼Œæˆ‘åˆå§‹åŒ–äº†ä¸€ä¸ª len(token) å¤§å°çš„è¯å‘é‡çŸ©é˜µï¼Œå¯¹äºè¯å‘é‡å­—å…¸æœ‰çš„ tokenï¼Œæˆ‘å°±ç›´æ¥æ›¿æ¢ï¼Œå¯¹äºæ²¡å‡ºç°è¿‡çš„ token çš„è¯å‘é‡ï¼Œå°±ç›´æ¥è®­ç»ƒã€‚ä¼ å…¥ x ä¹‹ååº”è¯¥ä¼šè¾“å‡ºä¸€ä¸ª [batch_size, seq_len, embed_size] çš„å¼ é‡ã€‚ ","date":"2025-12-19","objectID":"/posts/lstm/:2:1","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#è¯åµŒå…¥"},{"categories":null,"content":" æ•°æ®é›†å¤„ç†æ•°æ®é›†æˆ‘ä½¿ç”¨ torch è‡ªå¸¦çš„ DataSet å’Œ DataLoaderï¼Œå®ƒæä¾›äº† batch å’Œ shuffle ç­‰åŠŸèƒ½ï¼Œæˆ‘åªéœ€è¦é‡å†™__len__å’Œ__getitem__ä¸¤ä¸ªæ–¹æ³•ï¼š python class RemarkDataSet(Dataset): def __init__( self, texts: list[list[str]], labels: list[int], token2id: dict ) -\u003e None: self.texts = torch.tensor([[token2id[token] for token in text] for text in texts]) self.labels = torch.tensor(labels).float() def __getitem__(self, index: int) -\u003e tuple[str, torch.Tensor]: return self.texts[index], self.labels[index] def __len__(self): return len(self.texts) ","date":"2025-12-19","objectID":"/posts/lstm/:2:2","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#æ•°æ®é›†å¤„ç†"},{"categories":null,"content":" LSTM æ¨¡å‹æ¨¡å‹çš„è§†çº¿éš¾åº¦ä¸å¤§ï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–äº†ä¸‰ä¸ªé—¨æ§ç›¸å…³çš„å‚æ•°ï¼Œç„¶åå®ç°äº†å‰å‘ä¼ æ’­çš„è®¡ç®—ï¼š python class LSTM(nn.Module): def __init__( self, hidden_size: int, seq_len: int, embed_size: int, output_size: int, device: Literal[\"cuda\", \"cpu\"], embeddings: Embedding ) -\u003e None: super().__init__() self.hidden_size = hidden_size self.seq_len = seq_len self.embed_size = embed_size self.device = device self.embeddings = embeddings # ===== Forget Gate ===== self.Wxf = nn.Parameter(torch.empty(self.embed_size, self.hidden_size, device=self.device)) nn.init.xavier_uniform_(self.Wxf) self.Whf = nn.Parameter(torch.empty(self.hidden_size, self.hidden_size, device=self.device)) nn.init.xavier_uniform_(self.Whf) self.bf = nn.Parameter(torch.empty(self.hidden_size, device=self.device)) nn.init.uniform_(self.bf) # ===== Input Gate ===== self.Wxi = nn.Parameter(torch.empty(self.embed_size, self.hidden_size, device=self.device)) nn.init.xavier_uniform_(self.Wxi) self.Whi = nn.Parameter(torch.empty(self.hidden_size, self.hidden_size, device=self.device)) nn.init.xavier_uniform_(self.Whi) self.bi = nn.Parameter(torch.empty(self.hidden_size, device=self.device)) nn.init.uniform_(self.bi) # ===== Output Gate ===== self.Wxo = nn.Parameter(torch.empty(self.embed_size, self.hidden_size, device=self.device)) nn.init.xavier_uniform_(self.Wxo) self.Who = nn.Parameter(torch.empty(self.hidden_size, self.hidden_size, device=self.device)) nn.init.xavier_uniform_(self.Who) self.bo = nn.Parameter(torch.empty(self.hidden_size, device=self.device)) nn.init.uniform_(self.bo) # ===== Candidate Memory Cell ===== self.Wxc = nn.Parameter(torch.empty(self.embed_size, self.hidden_size, device=self.device)) nn.init.xavier_uniform_(self.Wxc) self.Whc = nn.Parameter(torch.empty(self.hidden_size, self.hidden_size, device=self.device)) nn.init.xavier_uniform_(self.Whc) self.bc = nn.Parameter(torch.empty(self.hidden_size, device=self.device)) nn.init.uniform_(self.bc) self.fc = nn.Parameter(torch.empty(self.hidden_size, output_size, device=self.device)) nn.init.xavier_uniform_(self.fc) self.sigmoid = nn.Sigmoid() self.hidden_dropout = nn.Dropout(p=0.3) def forward(self, x): # x = [batch_size, seq_len, embed_size] x = self.embeddings.lookup(x) batch_size, seq_len, _ = x.shape ht = torch.zeros(batch_size, self.hidden_size, device=self.device) ct = torch.zeros(batch_size, self.hidden_size, device=self.device) for i in range(seq_len): # batch_x = [batch_size, embed_size] xt = x[:, i, :] ht_drop = self.hidden_dropout(ht) ft = torch.sigmoid(torch.matmul(ht_drop, self.Whf) + torch.matmul(xt, self.Wxf) + self.bf) it = torch.sigmoid(torch.matmul(ht_drop, self.Whi) + torch.matmul(xt, self.Wxi) + self.bi) ot = torch.sigmoid(torch.matmul(ht_drop, self.Who) + torch.matmul(xt, self.Wxo) + self.bo) c_t = torch.tanh(torch.matmul(ht_drop, self.Whc) + torch.matmul(xt, self.Wxc) + self.bc) ct = ft * ct + it * c_t ht = ot * torch.tanh(ct) return torch.matmul(ht, self.fc).squeeze(1) ","date":"2025-12-19","objectID":"/posts/lstm/:2:3","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#lstm-æ¨¡å‹"},{"categories":null,"content":" è®­ç»ƒ\u0026æµ‹è¯•IMDB æƒ…æ„Ÿåˆ†ææ—¶ä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ï¼Œæ‰€ä»¥æŸå¤±å‡½æ•°ç”¨çš„æ˜¯ BCEWithLogitsLoss è€Œä¸æ˜¯äº¤å‰æŸå¤±ã€‚ python class Classifier: def __init__( self, device: Literal[\"cuda\", \"cpu\"], epochs: int, learning_rate: int, train_dataset: Dataset, test_dataset: Dataset, save_filepath: str | Path, embeddings: Embedding ) -\u003e None: self.device = device self.epochs = epochs self.lr = learning_rate self.train_dataset = train_dataset self.test_dataset = test_dataset self.save_filepath = save_filepath self.embeddings = embeddings def train(self): model = LSTM( hidden_size=128, seq_len=250, embed_size=50, output_size=1, device=self.device, embeddings=self.embeddings ).to(self.device) criterion = torch.nn.BCEWithLogitsLoss() optimizer = torch.optim.AdamW(model.parameters(), lr=self.lr) train_loader = DataLoader(self.train_dataset, batch_size=32, shuffle=True) best_loss = float(\"inf\") model.train() for epoch in tqdm(range(self.epochs)): epoch_loss = 0.0 epoch_acc = 0.0 for batch_x, batch_y in tqdm(train_loader, desc=f\"Epoch {epoch + 1}\", leave=False): x, y = batch_x.to(self.device), batch_y.to(self.device) optimizer.zero_grad() prediction = model(x) loss = criterion(prediction, y) loss.backward() optimizer.step() epoch_loss += loss.cpu().item() pred_label = (torch.sigmoid(prediction) \u003e 0.5).long() epoch_acc += (pred_label == y).sum().item() epoch_loss /= len(train_loader) epoch_acc /= len(train_loader.dataset) if epoch_loss \u003c best_loss: best_loss = epoch_loss torch.save(model.state_dict(), self.save_filepath) print(f\"ç¬¬{epoch+1}/{self.epochs}è½®è®­ç»ƒï¼Œacc={epoch_acc:.4f}, loss={epoch_loss:.4f}\") def test(self): model = LSTM( hidden_size=128, seq_len=250, embed_size=50, output_size=1, device=self.device, embeddings=self.embeddings ).to(self.device) model.load_state_dict(torch.load(self.save_filepath)) model.eval() test_loader = DataLoader(self.test_dataset, batch_size=16, shuffle=True) total_acc = 0.0 with torch.no_grad(): for batch_x, batch_y in tqdm(test_loader): x, y = batch_x.to(self.device), batch_y.to(self.device) pred = model(x) pred_label = (torch.sigmoid(pred) \u003e 0.5).long() total_acc += (pred_label == y.long()).sum().item() print(f\"æµ‹è¯•å‡†ç¡®ç‡ï¼š{total_acc / len(test_loader.dataset):.4f}\") ","date":"2025-12-19","objectID":"/posts/lstm/:2:4","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#è®­ç»ƒæµ‹è¯•"},{"categories":null,"content":" è¯•éªŒæ”¶è· numpy å’Œ torch åˆ«æ··ç”¨è®­ç»ƒæ¨¡å‹ç»§æ‰¿çš„æ˜¯ torch.nn.Moduleï¼Œå‰é¦ˆè®¡ç®—æ—¶å€™åŸºæœ¬ç”¨çš„éƒ½æ˜¯ PyTorch çš„å¼ é‡ï¼Œæ‰€ä»¥æœ€å¥½å£°æ˜çš„çŸ©é˜µå•¥çš„å…¨ç”¨ tensorï¼Œé¿å…åé¢æŠ¥é”™ã€‚ äºŒåˆ†ç±»é—®é¢˜çš„æŸå¤±å‡½æ•°ä¹‹å‰ CS224N çš„ Assignment2 å’Œ RNN å®éªŒé¢„æµ‹å­—æ¯éƒ½æ˜¯ä¸€ä¸ªå¤šåˆ†ç±»é—®é¢˜ï¼Œç”¨çš„æ˜¯ CrossEntropy è¿™ä¸ªæŸå¤±å‡½æ•°ã€‚è¿™æ¬¡æƒ…æ„Ÿåˆ¤æ–­æ˜¯ä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ï¼ŒGPT å‘Šè¯‰æˆ‘éœ€è¦ç”¨ BCEWithLogitsLoss è¿™ä¸ªæŸå¤±å‡½æ•°ã€‚ æœ€åˆæˆ‘çš„ä»£ç  output_size æ˜¯ 2ï¼Œæˆ‘çš„æƒ³æ³•ä¸å¤šåˆ†ç±»é—®é¢˜ç›¸åŒï¼Œmodel è¾“å‡ºçš„ y å½¢çŠ¶ä¸º [batch_size, 2]ï¼Œå“ªä¸€è¾¹æ¦‚ç‡å¤§é¢„æµ‹çš„å°±æ˜¯å“ªä¸€ä¸ªï¼Œä½†æ˜¯è¾“å…¥åˆ°æŸå¤±å‡½æ•°ä¸­æŠ¥é”™äº†ï¼Œæç¤ºæˆ‘ BCEWithLogitsLoss çš„è¾“å…¥åº”è¯¥æ˜¯ä¸€ç»´çš„å¼ é‡ã€‚BCEWithLogitsLoss å‡½æ•°ä¼šæŠŠè¾“å…¥çš„å‘é‡è¿›è¡Œä¸€ä¸ª sigmoid æ¿€æ´»ï¼Œæ˜ å°„åˆ° 0-1 ä¹‹é—´ï¼Œæ‰€ä»¥è¾“å…¥å¼ é‡çš„å½¢çŠ¶åº”è¯¥æ˜¯ [batch_size]ï¼Œè¿™æ„å‘³ç€æˆ‘è®¾ç½® output_size=1 åï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€æ­¥ squeezeï¼Œå› ä¸º [batch_size, 1] å’Œ [batch] å½¢çŠ¶ä¸åŒã€‚ python def forward(self, x): // ... return torch.matmul(ht, self.fc).squeeze(1) å¦‚æœåœ¨åˆ†ç±»å±‚è¾“å‡º [batch_size,2] ç„¶åç»è¿‡ softmax æ¿€æ´»é€å…¥ CrossEntropy è™½ç„¶æœ‰ä¸€æ ·æ•ˆæœä½†æ˜¯ä¸å®Œå…¨ç­‰ä»·ï¼ŒäºŒåˆ†ç±»é—®é¢˜è¿˜æ˜¯å»ºè®® output_size=1+äºŒå…ƒäº¤å‰ç†µã€‚ è¿‡æ‹Ÿåˆç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ä»£ç è®­ç»ƒåå‡ºç° train ä¸Š 100%å‡†ç¡®ç‡ï¼Œtest ä¸Š 50%æ­£ç¡®ç‡ï¼Œæ˜æ˜¾æ˜¯è¿‡æ‹Ÿåˆäº†ã€‚æˆ‘è¿›è¡Œäº†ä»¥ä¸‹è°ƒæ•´ï¼š batch_size ä» 16 â†’ 32ï¼Œbatch_size è¶Šå¤§è®­ç»ƒè¶Šç¨³å®šï¼Œä½†æ˜¯ç›¸å¯¹è®­ç»ƒé€Ÿåº¦ä¼šä¸‹é™ã€‚ hidden_size ä» 520 â†’ 250ï¼Œæ¨¡å‹å®¹é‡å¤ªå¤§ä¹Ÿæœ‰å¯èƒ½å¯¼è‡´æ¨¡å‹å­¦ä¹ åˆ°è¿‡å¤šçš„è®­ç»ƒé›†ç‰¹å¾ï¼Œå¯¼è‡´è¿‡æ‹Ÿåˆã€‚ dropout å¯ä»¥åœ¨è®­ç»ƒæœŸé—´éšæœºä¸¢å¼ƒä¸€äº›å‚æ•°ï¼Œå¢å¼ºæ¨¡å‹çš„å­¦ä¹ èƒ½åŠ›ï¼Œé¿å…è¿‡æ‹Ÿåˆã€‚ ä¼˜åŒ–å™¨ä» Adam å˜æˆ AdamWï¼Œä¸ºäº†æé«˜è®­ç»ƒé€Ÿåº¦ï¼Œæˆ‘æ²¡æœ‰ç”¨ IMDB å…¨éƒ¨çš„è®­ç»ƒé›†ï¼ŒAdam åœ¨å°æ•°æ®é›†ä¸Šå®¹æ˜“è¿‡æ‹Ÿåˆã€‚ æ•°æ®é›†ä» 5000 æé«˜åˆ°äº† 20000 ","date":"2025-12-19","objectID":"/posts/lstm/:2:5","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#è¯•éªŒæ”¶è·"},{"categories":null,"content":" è¯•éªŒæ”¶è· numpy å’Œ torch åˆ«æ··ç”¨è®­ç»ƒæ¨¡å‹ç»§æ‰¿çš„æ˜¯ torch.nn.Moduleï¼Œå‰é¦ˆè®¡ç®—æ—¶å€™åŸºæœ¬ç”¨çš„éƒ½æ˜¯ PyTorch çš„å¼ é‡ï¼Œæ‰€ä»¥æœ€å¥½å£°æ˜çš„çŸ©é˜µå•¥çš„å…¨ç”¨ tensorï¼Œé¿å…åé¢æŠ¥é”™ã€‚ äºŒåˆ†ç±»é—®é¢˜çš„æŸå¤±å‡½æ•°ä¹‹å‰ CS224N çš„ Assignment2 å’Œ RNN å®éªŒé¢„æµ‹å­—æ¯éƒ½æ˜¯ä¸€ä¸ªå¤šåˆ†ç±»é—®é¢˜ï¼Œç”¨çš„æ˜¯ CrossEntropy è¿™ä¸ªæŸå¤±å‡½æ•°ã€‚è¿™æ¬¡æƒ…æ„Ÿåˆ¤æ–­æ˜¯ä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ï¼ŒGPT å‘Šè¯‰æˆ‘éœ€è¦ç”¨ BCEWithLogitsLoss è¿™ä¸ªæŸå¤±å‡½æ•°ã€‚ æœ€åˆæˆ‘çš„ä»£ç  output_size æ˜¯ 2ï¼Œæˆ‘çš„æƒ³æ³•ä¸å¤šåˆ†ç±»é—®é¢˜ç›¸åŒï¼Œmodel è¾“å‡ºçš„ y å½¢çŠ¶ä¸º [batch_size, 2]ï¼Œå“ªä¸€è¾¹æ¦‚ç‡å¤§é¢„æµ‹çš„å°±æ˜¯å“ªä¸€ä¸ªï¼Œä½†æ˜¯è¾“å…¥åˆ°æŸå¤±å‡½æ•°ä¸­æŠ¥é”™äº†ï¼Œæç¤ºæˆ‘ BCEWithLogitsLoss çš„è¾“å…¥åº”è¯¥æ˜¯ä¸€ç»´çš„å¼ é‡ã€‚BCEWithLogitsLoss å‡½æ•°ä¼šæŠŠè¾“å…¥çš„å‘é‡è¿›è¡Œä¸€ä¸ª sigmoid æ¿€æ´»ï¼Œæ˜ å°„åˆ° 0-1 ä¹‹é—´ï¼Œæ‰€ä»¥è¾“å…¥å¼ é‡çš„å½¢çŠ¶åº”è¯¥æ˜¯ [batch_size]ï¼Œè¿™æ„å‘³ç€æˆ‘è®¾ç½® output_size=1 åï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€æ­¥ squeezeï¼Œå› ä¸º [batch_size, 1] å’Œ [batch] å½¢çŠ¶ä¸åŒã€‚ python def forward(self, x): // ... return torch.matmul(ht, self.fc).squeeze(1) å¦‚æœåœ¨åˆ†ç±»å±‚è¾“å‡º [batch_size,2] ç„¶åç»è¿‡ softmax æ¿€æ´»é€å…¥ CrossEntropy è™½ç„¶æœ‰ä¸€æ ·æ•ˆæœä½†æ˜¯ä¸å®Œå…¨ç­‰ä»·ï¼ŒäºŒåˆ†ç±»é—®é¢˜è¿˜æ˜¯å»ºè®® output_size=1+äºŒå…ƒäº¤å‰ç†µã€‚ è¿‡æ‹Ÿåˆç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ä»£ç è®­ç»ƒåå‡ºç° train ä¸Š 100%å‡†ç¡®ç‡ï¼Œtest ä¸Š 50%æ­£ç¡®ç‡ï¼Œæ˜æ˜¾æ˜¯è¿‡æ‹Ÿåˆäº†ã€‚æˆ‘è¿›è¡Œäº†ä»¥ä¸‹è°ƒæ•´ï¼š batch_size ä» 16 â†’ 32ï¼Œbatch_size è¶Šå¤§è®­ç»ƒè¶Šç¨³å®šï¼Œä½†æ˜¯ç›¸å¯¹è®­ç»ƒé€Ÿåº¦ä¼šä¸‹é™ã€‚ hidden_size ä» 520 â†’ 250ï¼Œæ¨¡å‹å®¹é‡å¤ªå¤§ä¹Ÿæœ‰å¯èƒ½å¯¼è‡´æ¨¡å‹å­¦ä¹ åˆ°è¿‡å¤šçš„è®­ç»ƒé›†ç‰¹å¾ï¼Œå¯¼è‡´è¿‡æ‹Ÿåˆã€‚ dropout å¯ä»¥åœ¨è®­ç»ƒæœŸé—´éšæœºä¸¢å¼ƒä¸€äº›å‚æ•°ï¼Œå¢å¼ºæ¨¡å‹çš„å­¦ä¹ èƒ½åŠ›ï¼Œé¿å…è¿‡æ‹Ÿåˆã€‚ ä¼˜åŒ–å™¨ä» Adam å˜æˆ AdamWï¼Œä¸ºäº†æé«˜è®­ç»ƒé€Ÿåº¦ï¼Œæˆ‘æ²¡æœ‰ç”¨ IMDB å…¨éƒ¨çš„è®­ç»ƒé›†ï¼ŒAdam åœ¨å°æ•°æ®é›†ä¸Šå®¹æ˜“è¿‡æ‹Ÿåˆã€‚ æ•°æ®é›†ä» 5000 æé«˜åˆ°äº† 20000 ","date":"2025-12-19","objectID":"/posts/lstm/:2:5","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#numpy-å’Œ-torch-åˆ«æ··ç”¨"},{"categories":null,"content":" è¯•éªŒæ”¶è· numpy å’Œ torch åˆ«æ··ç”¨è®­ç»ƒæ¨¡å‹ç»§æ‰¿çš„æ˜¯ torch.nn.Moduleï¼Œå‰é¦ˆè®¡ç®—æ—¶å€™åŸºæœ¬ç”¨çš„éƒ½æ˜¯ PyTorch çš„å¼ é‡ï¼Œæ‰€ä»¥æœ€å¥½å£°æ˜çš„çŸ©é˜µå•¥çš„å…¨ç”¨ tensorï¼Œé¿å…åé¢æŠ¥é”™ã€‚ äºŒåˆ†ç±»é—®é¢˜çš„æŸå¤±å‡½æ•°ä¹‹å‰ CS224N çš„ Assignment2 å’Œ RNN å®éªŒé¢„æµ‹å­—æ¯éƒ½æ˜¯ä¸€ä¸ªå¤šåˆ†ç±»é—®é¢˜ï¼Œç”¨çš„æ˜¯ CrossEntropy è¿™ä¸ªæŸå¤±å‡½æ•°ã€‚è¿™æ¬¡æƒ…æ„Ÿåˆ¤æ–­æ˜¯ä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ï¼ŒGPT å‘Šè¯‰æˆ‘éœ€è¦ç”¨ BCEWithLogitsLoss è¿™ä¸ªæŸå¤±å‡½æ•°ã€‚ æœ€åˆæˆ‘çš„ä»£ç  output_size æ˜¯ 2ï¼Œæˆ‘çš„æƒ³æ³•ä¸å¤šåˆ†ç±»é—®é¢˜ç›¸åŒï¼Œmodel è¾“å‡ºçš„ y å½¢çŠ¶ä¸º [batch_size, 2]ï¼Œå“ªä¸€è¾¹æ¦‚ç‡å¤§é¢„æµ‹çš„å°±æ˜¯å“ªä¸€ä¸ªï¼Œä½†æ˜¯è¾“å…¥åˆ°æŸå¤±å‡½æ•°ä¸­æŠ¥é”™äº†ï¼Œæç¤ºæˆ‘ BCEWithLogitsLoss çš„è¾“å…¥åº”è¯¥æ˜¯ä¸€ç»´çš„å¼ é‡ã€‚BCEWithLogitsLoss å‡½æ•°ä¼šæŠŠè¾“å…¥çš„å‘é‡è¿›è¡Œä¸€ä¸ª sigmoid æ¿€æ´»ï¼Œæ˜ å°„åˆ° 0-1 ä¹‹é—´ï¼Œæ‰€ä»¥è¾“å…¥å¼ é‡çš„å½¢çŠ¶åº”è¯¥æ˜¯ [batch_size]ï¼Œè¿™æ„å‘³ç€æˆ‘è®¾ç½® output_size=1 åï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€æ­¥ squeezeï¼Œå› ä¸º [batch_size, 1] å’Œ [batch] å½¢çŠ¶ä¸åŒã€‚ python def forward(self, x): // ... return torch.matmul(ht, self.fc).squeeze(1) å¦‚æœåœ¨åˆ†ç±»å±‚è¾“å‡º [batch_size,2] ç„¶åç»è¿‡ softmax æ¿€æ´»é€å…¥ CrossEntropy è™½ç„¶æœ‰ä¸€æ ·æ•ˆæœä½†æ˜¯ä¸å®Œå…¨ç­‰ä»·ï¼ŒäºŒåˆ†ç±»é—®é¢˜è¿˜æ˜¯å»ºè®® output_size=1+äºŒå…ƒäº¤å‰ç†µã€‚ è¿‡æ‹Ÿåˆç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ä»£ç è®­ç»ƒåå‡ºç° train ä¸Š 100%å‡†ç¡®ç‡ï¼Œtest ä¸Š 50%æ­£ç¡®ç‡ï¼Œæ˜æ˜¾æ˜¯è¿‡æ‹Ÿåˆäº†ã€‚æˆ‘è¿›è¡Œäº†ä»¥ä¸‹è°ƒæ•´ï¼š batch_size ä» 16 â†’ 32ï¼Œbatch_size è¶Šå¤§è®­ç»ƒè¶Šç¨³å®šï¼Œä½†æ˜¯ç›¸å¯¹è®­ç»ƒé€Ÿåº¦ä¼šä¸‹é™ã€‚ hidden_size ä» 520 â†’ 250ï¼Œæ¨¡å‹å®¹é‡å¤ªå¤§ä¹Ÿæœ‰å¯èƒ½å¯¼è‡´æ¨¡å‹å­¦ä¹ åˆ°è¿‡å¤šçš„è®­ç»ƒé›†ç‰¹å¾ï¼Œå¯¼è‡´è¿‡æ‹Ÿåˆã€‚ dropout å¯ä»¥åœ¨è®­ç»ƒæœŸé—´éšæœºä¸¢å¼ƒä¸€äº›å‚æ•°ï¼Œå¢å¼ºæ¨¡å‹çš„å­¦ä¹ èƒ½åŠ›ï¼Œé¿å…è¿‡æ‹Ÿåˆã€‚ ä¼˜åŒ–å™¨ä» Adam å˜æˆ AdamWï¼Œä¸ºäº†æé«˜è®­ç»ƒé€Ÿåº¦ï¼Œæˆ‘æ²¡æœ‰ç”¨ IMDB å…¨éƒ¨çš„è®­ç»ƒé›†ï¼ŒAdam åœ¨å°æ•°æ®é›†ä¸Šå®¹æ˜“è¿‡æ‹Ÿåˆã€‚ æ•°æ®é›†ä» 5000 æé«˜åˆ°äº† 20000 ","date":"2025-12-19","objectID":"/posts/lstm/:2:5","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#äºŒåˆ†ç±»é—®é¢˜çš„æŸå¤±å‡½æ•°"},{"categories":null,"content":" è¯•éªŒæ”¶è· numpy å’Œ torch åˆ«æ··ç”¨è®­ç»ƒæ¨¡å‹ç»§æ‰¿çš„æ˜¯ torch.nn.Moduleï¼Œå‰é¦ˆè®¡ç®—æ—¶å€™åŸºæœ¬ç”¨çš„éƒ½æ˜¯ PyTorch çš„å¼ é‡ï¼Œæ‰€ä»¥æœ€å¥½å£°æ˜çš„çŸ©é˜µå•¥çš„å…¨ç”¨ tensorï¼Œé¿å…åé¢æŠ¥é”™ã€‚ äºŒåˆ†ç±»é—®é¢˜çš„æŸå¤±å‡½æ•°ä¹‹å‰ CS224N çš„ Assignment2 å’Œ RNN å®éªŒé¢„æµ‹å­—æ¯éƒ½æ˜¯ä¸€ä¸ªå¤šåˆ†ç±»é—®é¢˜ï¼Œç”¨çš„æ˜¯ CrossEntropy è¿™ä¸ªæŸå¤±å‡½æ•°ã€‚è¿™æ¬¡æƒ…æ„Ÿåˆ¤æ–­æ˜¯ä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ï¼ŒGPT å‘Šè¯‰æˆ‘éœ€è¦ç”¨ BCEWithLogitsLoss è¿™ä¸ªæŸå¤±å‡½æ•°ã€‚ æœ€åˆæˆ‘çš„ä»£ç  output_size æ˜¯ 2ï¼Œæˆ‘çš„æƒ³æ³•ä¸å¤šåˆ†ç±»é—®é¢˜ç›¸åŒï¼Œmodel è¾“å‡ºçš„ y å½¢çŠ¶ä¸º [batch_size, 2]ï¼Œå“ªä¸€è¾¹æ¦‚ç‡å¤§é¢„æµ‹çš„å°±æ˜¯å“ªä¸€ä¸ªï¼Œä½†æ˜¯è¾“å…¥åˆ°æŸå¤±å‡½æ•°ä¸­æŠ¥é”™äº†ï¼Œæç¤ºæˆ‘ BCEWithLogitsLoss çš„è¾“å…¥åº”è¯¥æ˜¯ä¸€ç»´çš„å¼ é‡ã€‚BCEWithLogitsLoss å‡½æ•°ä¼šæŠŠè¾“å…¥çš„å‘é‡è¿›è¡Œä¸€ä¸ª sigmoid æ¿€æ´»ï¼Œæ˜ å°„åˆ° 0-1 ä¹‹é—´ï¼Œæ‰€ä»¥è¾“å…¥å¼ é‡çš„å½¢çŠ¶åº”è¯¥æ˜¯ [batch_size]ï¼Œè¿™æ„å‘³ç€æˆ‘è®¾ç½® output_size=1 åï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€æ­¥ squeezeï¼Œå› ä¸º [batch_size, 1] å’Œ [batch] å½¢çŠ¶ä¸åŒã€‚ python def forward(self, x): // ... return torch.matmul(ht, self.fc).squeeze(1) å¦‚æœåœ¨åˆ†ç±»å±‚è¾“å‡º [batch_size,2] ç„¶åç»è¿‡ softmax æ¿€æ´»é€å…¥ CrossEntropy è™½ç„¶æœ‰ä¸€æ ·æ•ˆæœä½†æ˜¯ä¸å®Œå…¨ç­‰ä»·ï¼ŒäºŒåˆ†ç±»é—®é¢˜è¿˜æ˜¯å»ºè®® output_size=1+äºŒå…ƒäº¤å‰ç†µã€‚ è¿‡æ‹Ÿåˆç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ä»£ç è®­ç»ƒåå‡ºç° train ä¸Š 100%å‡†ç¡®ç‡ï¼Œtest ä¸Š 50%æ­£ç¡®ç‡ï¼Œæ˜æ˜¾æ˜¯è¿‡æ‹Ÿåˆäº†ã€‚æˆ‘è¿›è¡Œäº†ä»¥ä¸‹è°ƒæ•´ï¼š batch_size ä» 16 â†’ 32ï¼Œbatch_size è¶Šå¤§è®­ç»ƒè¶Šç¨³å®šï¼Œä½†æ˜¯ç›¸å¯¹è®­ç»ƒé€Ÿåº¦ä¼šä¸‹é™ã€‚ hidden_size ä» 520 â†’ 250ï¼Œæ¨¡å‹å®¹é‡å¤ªå¤§ä¹Ÿæœ‰å¯èƒ½å¯¼è‡´æ¨¡å‹å­¦ä¹ åˆ°è¿‡å¤šçš„è®­ç»ƒé›†ç‰¹å¾ï¼Œå¯¼è‡´è¿‡æ‹Ÿåˆã€‚ dropout å¯ä»¥åœ¨è®­ç»ƒæœŸé—´éšæœºä¸¢å¼ƒä¸€äº›å‚æ•°ï¼Œå¢å¼ºæ¨¡å‹çš„å­¦ä¹ èƒ½åŠ›ï¼Œé¿å…è¿‡æ‹Ÿåˆã€‚ ä¼˜åŒ–å™¨ä» Adam å˜æˆ AdamWï¼Œä¸ºäº†æé«˜è®­ç»ƒé€Ÿåº¦ï¼Œæˆ‘æ²¡æœ‰ç”¨ IMDB å…¨éƒ¨çš„è®­ç»ƒé›†ï¼ŒAdam åœ¨å°æ•°æ®é›†ä¸Šå®¹æ˜“è¿‡æ‹Ÿåˆã€‚ æ•°æ®é›†ä» 5000 æé«˜åˆ°äº† 20000 ","date":"2025-12-19","objectID":"/posts/lstm/:2:5","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#è¿‡æ‹Ÿåˆ"},{"categories":null,"content":" åæ€ \u003cPAD\u003e çš„è¯å‘é‡æ·±åº¦å­¦ä¹ çš„æ¨¡å‹è¦æ±‚è¾“å…¥çš„å‘é‡æœ‰ç»Ÿä¸€çš„ç»´åº¦ï¼Œä½†æ˜¯ IMDB è¯„è®ºçš„é•¿åº¦ä¸å›ºå®šï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è¿›è¡Œæˆªé•¿æˆ–è€…è¡¥çŸ­ã€‚åœ¨ä»£ç ä¸­æˆ‘è®¾å®š SEQ_LEN=250ï¼Œå¦‚æœå¥å­çš„ token ä¸è¶³ SEQ_LENï¼Œä¼šè¡¥å……\u003cPAD\u003eï¼ŒåŒæ—¶æˆ‘åœ¨ embeddings ä¸­ä¹Ÿä¸º\u003cPAD\u003e åˆå§‹åŒ–äº†ä¸€ä¸ªå¯è®­ç»ƒçš„å¼ é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ \u003cPAD\u003e ä¼šå¯¹è®­ç»ƒäº§ç”Ÿå½±å“ ã€‚ è§£å†³æ–¹æ³•ï¼š 1. torch.nn.Embedding ç›®å‰æˆ‘ä»¬çš„ embedding æ˜¯ä¸€ä¸ªå¼ é‡è€Œä¸æ˜¯ nn.Parameterï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸èƒ½è®­ç»ƒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PyTorch è‡ªå¸¦çš„ Embeddingï¼Œä»–é™¤äº†èƒ½è‡ªè®­ç»ƒè¯å‘é‡ï¼Œè¿˜å¯ä»¥è®¾ç½®\u003cPAD\u003e å¯¹åº”è¯å‘é‡ä¸å‚ä¸è®­ç»ƒã€‚ python class Embedding: def __init__( self, device: Literal[\"cuda\", \"cpu\"], embed_filepath: str, embed_size: int, token2id: dict ) -\u003e None: self.token2id = token2id token2vec = {} if not isinstance(embed_filepath, Path): self.embed_fp = Path(embed_filepath) assert self.embed_fp.exists(), \"embed file not found\" for line in open(self.embed_fp, \"r\").readlines(): sp = line.strip().split() token2vec[sp[0]] = torch.tensor([float(x) for x in sp[1:]], dtype=torch.float32) assert len(sp[1:]) == embed_size, f\"é¢„è®­ç»ƒå‘é‡ç»´åº¦ä¸{embed_size}ä¸ç¬¦\" weight = torch.normal( mean=0.0, std=0.9, size=(len(self.token2id), embed_size), dtype=torch.float32 ).to(device) for token, idx in self.token2id.items(): if token in token2vec: weight[idx] = token2vec[token].to(device) elif token.lower() in token2vec: weight[idx] = token2vec[token.lower()].to(device) weight[pad_id].zero_() self.embedding = nn.Embedding(len(token2id), embed_size, padding_idx=pad_id) self.embedding.weight.data.copy_(weight) nn.Embedding å¯ä»¥è®¾ç½® padding_idxï¼Œè¿™æ · \u003cPAD\u003e å¯¹åº”çš„è¯å‘é‡å°±ä¼šä¸å‚ä¸è®¡ç®—å’Œè®­ç»ƒã€‚ 2. pack_padded_sequence å®ƒè®© LSTM åœ¨è®¡ç®—æ—¶ è·³è¿‡ å¥å­ä¸­ \u003cPAD\u003e ä½ç½®ï¼Œä¸åšæ— æ„ä¹‰çš„æ—¶é—´æ­¥è®¡ç®—ã€‚ python class Model(nn.Module): def __init__(...): super().__init__() self.embedding = ... self.lstm = nn.LSTM(embed_size, hidden_size, batch_first=True) self.fc = nn.Linear(hidden_size, output_size) def forward(self, x, lengths): x = self.embedding(x) packed = pack_padded_sequence(x, lengths, batch_first=True, enforce_sorted=False) packed_out, (h, c) = self.lstm(packed) h = h[-1] return self.fc(h) åˆ†è¯å™¨åœ¨è°ƒè¯•çš„è¿‡ç¨‹æˆ‘å‘ç°ï¼Œå•å•é€šè¿‡ç©ºæ ¼ä¹Ÿå°±æ˜¯ split æ¥å¯¹å¥å­è¿›è¡Œåˆ†è¯æ˜¯ä¸è¶³çš„ï¼Œä¼šå‡ºç° me.ï¼Œok! è¿™æ ·å¥‡æ€ªçš„ tokenï¼Œç”šè‡³æœ‰äº›é™„å¸¦äº†æ¢è¡Œç¬¦ã€‚ ä¼˜åŒ–æ–¹å‘åŒ…æ‹¬ï¼š å»æ‰ HTML æ¢è¡Œæ ‡ç­¾ç­‰ ç»Ÿä¸€å¼•å·ï¼ˆé¿å…å¥‡æ€ªçš„ Unicode å¼•å·ï¼‰ é€šè¿‡ torchtext åº“æ¥è¿›è¡Œ tokenizer python from torchtext.data.utils import get_tokenizer tok = get_tokenizer(\"basic_english\") tok(\"I don't like this movie!!! it's bad\") # -\u003e ['i', \"don't\", 'like', 'this', 'movie', '!', '!', '!', \"it's\", 'bad'] æ­£åˆ™åŒ–ä¸è¶³ç°åœ¨ä»…å¯¹ $h_t$ åšäº† dropoutï¼Œä½†æ›´é€šç”¨çš„æ˜¯å¯¹è¾“å…¥åµŒå…¥å’Œ LSTM å±‚é—´åš dropoutï¼Œå»ºè®®åœ¨ $xt$ æˆ– $c_t$ ä¸Šåš dropoutï¼Œè€Œä¸æ˜¯åªåœ¨ $h_t$ ä¸Šã€‚ model å…¶ä»– æ•°æ®æ³„éœ²é—®é¢˜ï¼šEmbedding åº”è¯¥ä»…ç”¨è®­ç»ƒé›†æ„å»ºè¯æ±‡è¡¨ï¼Œæµ‹è¯•é›†çš„æœªçŸ¥è¯ç»Ÿä¸€ç”¨ \u003cUNK\u003e è¡¨ç¤º æµ‹è¯•é›† DataLoader è®¾ä¸º shuffle=Trueï¼Œæµ‹è¯•æ—¶æ— éœ€æ‰“ä¹±æ•°æ®ï¼Œåè€Œå¢åŠ è®¡ç®—å¼€é”€ ","date":"2025-12-19","objectID":"/posts/lstm/:2:6","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#åæ€"},{"categories":null,"content":" åæ€ çš„è¯å‘é‡æ·±åº¦å­¦ä¹ çš„æ¨¡å‹è¦æ±‚è¾“å…¥çš„å‘é‡æœ‰ç»Ÿä¸€çš„ç»´åº¦ï¼Œä½†æ˜¯ IMDB è¯„è®ºçš„é•¿åº¦ä¸å›ºå®šï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è¿›è¡Œæˆªé•¿æˆ–è€…è¡¥çŸ­ã€‚åœ¨ä»£ç ä¸­æˆ‘è®¾å®š SEQ_LEN=250ï¼Œå¦‚æœå¥å­çš„ token ä¸è¶³ SEQ_LENï¼Œä¼šè¡¥å……ï¼ŒåŒæ—¶æˆ‘åœ¨ embeddings ä¸­ä¹Ÿä¸º åˆå§‹åŒ–äº†ä¸€ä¸ªå¯è®­ç»ƒçš„å¼ é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ ä¼šå¯¹è®­ç»ƒäº§ç”Ÿå½±å“ ã€‚ è§£å†³æ–¹æ³•ï¼š 1. torch.nn.Embedding ç›®å‰æˆ‘ä»¬çš„ embedding æ˜¯ä¸€ä¸ªå¼ é‡è€Œä¸æ˜¯ nn.Parameterï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸èƒ½è®­ç»ƒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PyTorch è‡ªå¸¦çš„ Embeddingï¼Œä»–é™¤äº†èƒ½è‡ªè®­ç»ƒè¯å‘é‡ï¼Œè¿˜å¯ä»¥è®¾ç½® å¯¹åº”è¯å‘é‡ä¸å‚ä¸è®­ç»ƒã€‚ python class Embedding: def __init__( self, device: Literal[\"cuda\", \"cpu\"], embed_filepath: str, embed_size: int, token2id: dict ) -\u003e None: self.token2id = token2id token2vec = {} if not isinstance(embed_filepath, Path): self.embed_fp = Path(embed_filepath) assert self.embed_fp.exists(), \"embed file not found\" for line in open(self.embed_fp, \"r\").readlines(): sp = line.strip().split() token2vec[sp[0]] = torch.tensor([float(x) for x in sp[1:]], dtype=torch.float32) assert len(sp[1:]) == embed_size, f\"é¢„è®­ç»ƒå‘é‡ç»´åº¦ä¸{embed_size}ä¸ç¬¦\" weight = torch.normal( mean=0.0, std=0.9, size=(len(self.token2id), embed_size), dtype=torch.float32 ).to(device) for token, idx in self.token2id.items(): if token in token2vec: weight[idx] = token2vec[token].to(device) elif token.lower() in token2vec: weight[idx] = token2vec[token.lower()].to(device) weight[pad_id].zero_() self.embedding = nn.Embedding(len(token2id), embed_size, padding_idx=pad_id) self.embedding.weight.data.copy_(weight) nn.Embedding å¯ä»¥è®¾ç½® padding_idxï¼Œè¿™æ · å¯¹åº”çš„è¯å‘é‡å°±ä¼šä¸å‚ä¸è®¡ç®—å’Œè®­ç»ƒã€‚ 2. pack_padded_sequence å®ƒè®© LSTM åœ¨è®¡ç®—æ—¶ è·³è¿‡ å¥å­ä¸­ ä½ç½®ï¼Œä¸åšæ— æ„ä¹‰çš„æ—¶é—´æ­¥è®¡ç®—ã€‚ python class Model(nn.Module): def __init__(...): super().__init__() self.embedding = ... self.lstm = nn.LSTM(embed_size, hidden_size, batch_first=True) self.fc = nn.Linear(hidden_size, output_size) def forward(self, x, lengths): x = self.embedding(x) packed = pack_padded_sequence(x, lengths, batch_first=True, enforce_sorted=False) packed_out, (h, c) = self.lstm(packed) h = h[-1] return self.fc(h) åˆ†è¯å™¨åœ¨è°ƒè¯•çš„è¿‡ç¨‹æˆ‘å‘ç°ï¼Œå•å•é€šè¿‡ç©ºæ ¼ä¹Ÿå°±æ˜¯ split æ¥å¯¹å¥å­è¿›è¡Œåˆ†è¯æ˜¯ä¸è¶³çš„ï¼Œä¼šå‡ºç° me.ï¼Œok! è¿™æ ·å¥‡æ€ªçš„ tokenï¼Œç”šè‡³æœ‰äº›é™„å¸¦äº†æ¢è¡Œç¬¦ã€‚ ä¼˜åŒ–æ–¹å‘åŒ…æ‹¬ï¼š å»æ‰ HTML æ¢è¡Œæ ‡ç­¾ç­‰ ç»Ÿä¸€å¼•å·ï¼ˆé¿å…å¥‡æ€ªçš„ Unicode å¼•å·ï¼‰ é€šè¿‡ torchtext åº“æ¥è¿›è¡Œ tokenizer python from torchtext.data.utils import get_tokenizer tok = get_tokenizer(\"basic_english\") tok(\"I don't like this movie!!! it's bad\") # -\u003e ['i', \"don't\", 'like', 'this', 'movie', '!', '!', '!', \"it's\", 'bad'] æ­£åˆ™åŒ–ä¸è¶³ç°åœ¨ä»…å¯¹ $h_t$ åšäº† dropoutï¼Œä½†æ›´é€šç”¨çš„æ˜¯å¯¹è¾“å…¥åµŒå…¥å’Œ LSTM å±‚é—´åš dropoutï¼Œå»ºè®®åœ¨ $xt$ æˆ– $c_t$ ä¸Šåš dropoutï¼Œè€Œä¸æ˜¯åªåœ¨ $h_t$ ä¸Šã€‚ model å…¶ä»– æ•°æ®æ³„éœ²é—®é¢˜ï¼šEmbedding åº”è¯¥ä»…ç”¨è®­ç»ƒé›†æ„å»ºè¯æ±‡è¡¨ï¼Œæµ‹è¯•é›†çš„æœªçŸ¥è¯ç»Ÿä¸€ç”¨ è¡¨ç¤º æµ‹è¯•é›† DataLoader è®¾ä¸º shuffle=Trueï¼Œæµ‹è¯•æ—¶æ— éœ€æ‰“ä¹±æ•°æ®ï¼Œåè€Œå¢åŠ è®¡ç®—å¼€é”€ ","date":"2025-12-19","objectID":"/posts/lstm/:2:6","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#pad-çš„è¯å‘é‡"},{"categories":null,"content":" åæ€ çš„è¯å‘é‡æ·±åº¦å­¦ä¹ çš„æ¨¡å‹è¦æ±‚è¾“å…¥çš„å‘é‡æœ‰ç»Ÿä¸€çš„ç»´åº¦ï¼Œä½†æ˜¯ IMDB è¯„è®ºçš„é•¿åº¦ä¸å›ºå®šï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è¿›è¡Œæˆªé•¿æˆ–è€…è¡¥çŸ­ã€‚åœ¨ä»£ç ä¸­æˆ‘è®¾å®š SEQ_LEN=250ï¼Œå¦‚æœå¥å­çš„ token ä¸è¶³ SEQ_LENï¼Œä¼šè¡¥å……ï¼ŒåŒæ—¶æˆ‘åœ¨ embeddings ä¸­ä¹Ÿä¸º åˆå§‹åŒ–äº†ä¸€ä¸ªå¯è®­ç»ƒçš„å¼ é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ ä¼šå¯¹è®­ç»ƒäº§ç”Ÿå½±å“ ã€‚ è§£å†³æ–¹æ³•ï¼š 1. torch.nn.Embedding ç›®å‰æˆ‘ä»¬çš„ embedding æ˜¯ä¸€ä¸ªå¼ é‡è€Œä¸æ˜¯ nn.Parameterï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸èƒ½è®­ç»ƒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PyTorch è‡ªå¸¦çš„ Embeddingï¼Œä»–é™¤äº†èƒ½è‡ªè®­ç»ƒè¯å‘é‡ï¼Œè¿˜å¯ä»¥è®¾ç½® å¯¹åº”è¯å‘é‡ä¸å‚ä¸è®­ç»ƒã€‚ python class Embedding: def __init__( self, device: Literal[\"cuda\", \"cpu\"], embed_filepath: str, embed_size: int, token2id: dict ) -\u003e None: self.token2id = token2id token2vec = {} if not isinstance(embed_filepath, Path): self.embed_fp = Path(embed_filepath) assert self.embed_fp.exists(), \"embed file not found\" for line in open(self.embed_fp, \"r\").readlines(): sp = line.strip().split() token2vec[sp[0]] = torch.tensor([float(x) for x in sp[1:]], dtype=torch.float32) assert len(sp[1:]) == embed_size, f\"é¢„è®­ç»ƒå‘é‡ç»´åº¦ä¸{embed_size}ä¸ç¬¦\" weight = torch.normal( mean=0.0, std=0.9, size=(len(self.token2id), embed_size), dtype=torch.float32 ).to(device) for token, idx in self.token2id.items(): if token in token2vec: weight[idx] = token2vec[token].to(device) elif token.lower() in token2vec: weight[idx] = token2vec[token.lower()].to(device) weight[pad_id].zero_() self.embedding = nn.Embedding(len(token2id), embed_size, padding_idx=pad_id) self.embedding.weight.data.copy_(weight) nn.Embedding å¯ä»¥è®¾ç½® padding_idxï¼Œè¿™æ · å¯¹åº”çš„è¯å‘é‡å°±ä¼šä¸å‚ä¸è®¡ç®—å’Œè®­ç»ƒã€‚ 2. pack_padded_sequence å®ƒè®© LSTM åœ¨è®¡ç®—æ—¶ è·³è¿‡ å¥å­ä¸­ ä½ç½®ï¼Œä¸åšæ— æ„ä¹‰çš„æ—¶é—´æ­¥è®¡ç®—ã€‚ python class Model(nn.Module): def __init__(...): super().__init__() self.embedding = ... self.lstm = nn.LSTM(embed_size, hidden_size, batch_first=True) self.fc = nn.Linear(hidden_size, output_size) def forward(self, x, lengths): x = self.embedding(x) packed = pack_padded_sequence(x, lengths, batch_first=True, enforce_sorted=False) packed_out, (h, c) = self.lstm(packed) h = h[-1] return self.fc(h) åˆ†è¯å™¨åœ¨è°ƒè¯•çš„è¿‡ç¨‹æˆ‘å‘ç°ï¼Œå•å•é€šè¿‡ç©ºæ ¼ä¹Ÿå°±æ˜¯ split æ¥å¯¹å¥å­è¿›è¡Œåˆ†è¯æ˜¯ä¸è¶³çš„ï¼Œä¼šå‡ºç° me.ï¼Œok! è¿™æ ·å¥‡æ€ªçš„ tokenï¼Œç”šè‡³æœ‰äº›é™„å¸¦äº†æ¢è¡Œç¬¦ã€‚ ä¼˜åŒ–æ–¹å‘åŒ…æ‹¬ï¼š å»æ‰ HTML æ¢è¡Œæ ‡ç­¾ç­‰ ç»Ÿä¸€å¼•å·ï¼ˆé¿å…å¥‡æ€ªçš„ Unicode å¼•å·ï¼‰ é€šè¿‡ torchtext åº“æ¥è¿›è¡Œ tokenizer python from torchtext.data.utils import get_tokenizer tok = get_tokenizer(\"basic_english\") tok(\"I don't like this movie!!! it's bad\") # -\u003e ['i', \"don't\", 'like', 'this', 'movie', '!', '!', '!', \"it's\", 'bad'] æ­£åˆ™åŒ–ä¸è¶³ç°åœ¨ä»…å¯¹ $h_t$ åšäº† dropoutï¼Œä½†æ›´é€šç”¨çš„æ˜¯å¯¹è¾“å…¥åµŒå…¥å’Œ LSTM å±‚é—´åš dropoutï¼Œå»ºè®®åœ¨ $xt$ æˆ– $c_t$ ä¸Šåš dropoutï¼Œè€Œä¸æ˜¯åªåœ¨ $h_t$ ä¸Šã€‚ model å…¶ä»– æ•°æ®æ³„éœ²é—®é¢˜ï¼šEmbedding åº”è¯¥ä»…ç”¨è®­ç»ƒé›†æ„å»ºè¯æ±‡è¡¨ï¼Œæµ‹è¯•é›†çš„æœªçŸ¥è¯ç»Ÿä¸€ç”¨ è¡¨ç¤º æµ‹è¯•é›† DataLoader è®¾ä¸º shuffle=Trueï¼Œæµ‹è¯•æ—¶æ— éœ€æ‰“ä¹±æ•°æ®ï¼Œåè€Œå¢åŠ è®¡ç®—å¼€é”€ ","date":"2025-12-19","objectID":"/posts/lstm/:2:6","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#åˆ†è¯å™¨"},{"categories":null,"content":" åæ€ çš„è¯å‘é‡æ·±åº¦å­¦ä¹ çš„æ¨¡å‹è¦æ±‚è¾“å…¥çš„å‘é‡æœ‰ç»Ÿä¸€çš„ç»´åº¦ï¼Œä½†æ˜¯ IMDB è¯„è®ºçš„é•¿åº¦ä¸å›ºå®šï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è¿›è¡Œæˆªé•¿æˆ–è€…è¡¥çŸ­ã€‚åœ¨ä»£ç ä¸­æˆ‘è®¾å®š SEQ_LEN=250ï¼Œå¦‚æœå¥å­çš„ token ä¸è¶³ SEQ_LENï¼Œä¼šè¡¥å……ï¼ŒåŒæ—¶æˆ‘åœ¨ embeddings ä¸­ä¹Ÿä¸º åˆå§‹åŒ–äº†ä¸€ä¸ªå¯è®­ç»ƒçš„å¼ é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ ä¼šå¯¹è®­ç»ƒäº§ç”Ÿå½±å“ ã€‚ è§£å†³æ–¹æ³•ï¼š 1. torch.nn.Embedding ç›®å‰æˆ‘ä»¬çš„ embedding æ˜¯ä¸€ä¸ªå¼ é‡è€Œä¸æ˜¯ nn.Parameterï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸èƒ½è®­ç»ƒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PyTorch è‡ªå¸¦çš„ Embeddingï¼Œä»–é™¤äº†èƒ½è‡ªè®­ç»ƒè¯å‘é‡ï¼Œè¿˜å¯ä»¥è®¾ç½® å¯¹åº”è¯å‘é‡ä¸å‚ä¸è®­ç»ƒã€‚ python class Embedding: def __init__( self, device: Literal[\"cuda\", \"cpu\"], embed_filepath: str, embed_size: int, token2id: dict ) -\u003e None: self.token2id = token2id token2vec = {} if not isinstance(embed_filepath, Path): self.embed_fp = Path(embed_filepath) assert self.embed_fp.exists(), \"embed file not found\" for line in open(self.embed_fp, \"r\").readlines(): sp = line.strip().split() token2vec[sp[0]] = torch.tensor([float(x) for x in sp[1:]], dtype=torch.float32) assert len(sp[1:]) == embed_size, f\"é¢„è®­ç»ƒå‘é‡ç»´åº¦ä¸{embed_size}ä¸ç¬¦\" weight = torch.normal( mean=0.0, std=0.9, size=(len(self.token2id), embed_size), dtype=torch.float32 ).to(device) for token, idx in self.token2id.items(): if token in token2vec: weight[idx] = token2vec[token].to(device) elif token.lower() in token2vec: weight[idx] = token2vec[token.lower()].to(device) weight[pad_id].zero_() self.embedding = nn.Embedding(len(token2id), embed_size, padding_idx=pad_id) self.embedding.weight.data.copy_(weight) nn.Embedding å¯ä»¥è®¾ç½® padding_idxï¼Œè¿™æ · å¯¹åº”çš„è¯å‘é‡å°±ä¼šä¸å‚ä¸è®¡ç®—å’Œè®­ç»ƒã€‚ 2. pack_padded_sequence å®ƒè®© LSTM åœ¨è®¡ç®—æ—¶ è·³è¿‡ å¥å­ä¸­ ä½ç½®ï¼Œä¸åšæ— æ„ä¹‰çš„æ—¶é—´æ­¥è®¡ç®—ã€‚ python class Model(nn.Module): def __init__(...): super().__init__() self.embedding = ... self.lstm = nn.LSTM(embed_size, hidden_size, batch_first=True) self.fc = nn.Linear(hidden_size, output_size) def forward(self, x, lengths): x = self.embedding(x) packed = pack_padded_sequence(x, lengths, batch_first=True, enforce_sorted=False) packed_out, (h, c) = self.lstm(packed) h = h[-1] return self.fc(h) åˆ†è¯å™¨åœ¨è°ƒè¯•çš„è¿‡ç¨‹æˆ‘å‘ç°ï¼Œå•å•é€šè¿‡ç©ºæ ¼ä¹Ÿå°±æ˜¯ split æ¥å¯¹å¥å­è¿›è¡Œåˆ†è¯æ˜¯ä¸è¶³çš„ï¼Œä¼šå‡ºç° me.ï¼Œok! è¿™æ ·å¥‡æ€ªçš„ tokenï¼Œç”šè‡³æœ‰äº›é™„å¸¦äº†æ¢è¡Œç¬¦ã€‚ ä¼˜åŒ–æ–¹å‘åŒ…æ‹¬ï¼š å»æ‰ HTML æ¢è¡Œæ ‡ç­¾ç­‰ ç»Ÿä¸€å¼•å·ï¼ˆé¿å…å¥‡æ€ªçš„ Unicode å¼•å·ï¼‰ é€šè¿‡ torchtext åº“æ¥è¿›è¡Œ tokenizer python from torchtext.data.utils import get_tokenizer tok = get_tokenizer(\"basic_english\") tok(\"I don't like this movie!!! it's bad\") # -\u003e ['i', \"don't\", 'like', 'this', 'movie', '!', '!', '!', \"it's\", 'bad'] æ­£åˆ™åŒ–ä¸è¶³ç°åœ¨ä»…å¯¹ $h_t$ åšäº† dropoutï¼Œä½†æ›´é€šç”¨çš„æ˜¯å¯¹è¾“å…¥åµŒå…¥å’Œ LSTM å±‚é—´åš dropoutï¼Œå»ºè®®åœ¨ $xt$ æˆ– $c_t$ ä¸Šåš dropoutï¼Œè€Œä¸æ˜¯åªåœ¨ $h_t$ ä¸Šã€‚ model å…¶ä»– æ•°æ®æ³„éœ²é—®é¢˜ï¼šEmbedding åº”è¯¥ä»…ç”¨è®­ç»ƒé›†æ„å»ºè¯æ±‡è¡¨ï¼Œæµ‹è¯•é›†çš„æœªçŸ¥è¯ç»Ÿä¸€ç”¨ è¡¨ç¤º æµ‹è¯•é›† DataLoader è®¾ä¸º shuffle=Trueï¼Œæµ‹è¯•æ—¶æ— éœ€æ‰“ä¹±æ•°æ®ï¼Œåè€Œå¢åŠ è®¡ç®—å¼€é”€ ","date":"2025-12-19","objectID":"/posts/lstm/:2:6","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#æ­£åˆ™åŒ–ä¸è¶³"},{"categories":null,"content":" åæ€ çš„è¯å‘é‡æ·±åº¦å­¦ä¹ çš„æ¨¡å‹è¦æ±‚è¾“å…¥çš„å‘é‡æœ‰ç»Ÿä¸€çš„ç»´åº¦ï¼Œä½†æ˜¯ IMDB è¯„è®ºçš„é•¿åº¦ä¸å›ºå®šï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è¿›è¡Œæˆªé•¿æˆ–è€…è¡¥çŸ­ã€‚åœ¨ä»£ç ä¸­æˆ‘è®¾å®š SEQ_LEN=250ï¼Œå¦‚æœå¥å­çš„ token ä¸è¶³ SEQ_LENï¼Œä¼šè¡¥å……ï¼ŒåŒæ—¶æˆ‘åœ¨ embeddings ä¸­ä¹Ÿä¸º åˆå§‹åŒ–äº†ä¸€ä¸ªå¯è®­ç»ƒçš„å¼ é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ ä¼šå¯¹è®­ç»ƒäº§ç”Ÿå½±å“ ã€‚ è§£å†³æ–¹æ³•ï¼š 1. torch.nn.Embedding ç›®å‰æˆ‘ä»¬çš„ embedding æ˜¯ä¸€ä¸ªå¼ é‡è€Œä¸æ˜¯ nn.Parameterï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸èƒ½è®­ç»ƒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PyTorch è‡ªå¸¦çš„ Embeddingï¼Œä»–é™¤äº†èƒ½è‡ªè®­ç»ƒè¯å‘é‡ï¼Œè¿˜å¯ä»¥è®¾ç½® å¯¹åº”è¯å‘é‡ä¸å‚ä¸è®­ç»ƒã€‚ python class Embedding: def __init__( self, device: Literal[\"cuda\", \"cpu\"], embed_filepath: str, embed_size: int, token2id: dict ) -\u003e None: self.token2id = token2id token2vec = {} if not isinstance(embed_filepath, Path): self.embed_fp = Path(embed_filepath) assert self.embed_fp.exists(), \"embed file not found\" for line in open(self.embed_fp, \"r\").readlines(): sp = line.strip().split() token2vec[sp[0]] = torch.tensor([float(x) for x in sp[1:]], dtype=torch.float32) assert len(sp[1:]) == embed_size, f\"é¢„è®­ç»ƒå‘é‡ç»´åº¦ä¸{embed_size}ä¸ç¬¦\" weight = torch.normal( mean=0.0, std=0.9, size=(len(self.token2id), embed_size), dtype=torch.float32 ).to(device) for token, idx in self.token2id.items(): if token in token2vec: weight[idx] = token2vec[token].to(device) elif token.lower() in token2vec: weight[idx] = token2vec[token.lower()].to(device) weight[pad_id].zero_() self.embedding = nn.Embedding(len(token2id), embed_size, padding_idx=pad_id) self.embedding.weight.data.copy_(weight) nn.Embedding å¯ä»¥è®¾ç½® padding_idxï¼Œè¿™æ · å¯¹åº”çš„è¯å‘é‡å°±ä¼šä¸å‚ä¸è®¡ç®—å’Œè®­ç»ƒã€‚ 2. pack_padded_sequence å®ƒè®© LSTM åœ¨è®¡ç®—æ—¶ è·³è¿‡ å¥å­ä¸­ ä½ç½®ï¼Œä¸åšæ— æ„ä¹‰çš„æ—¶é—´æ­¥è®¡ç®—ã€‚ python class Model(nn.Module): def __init__(...): super().__init__() self.embedding = ... self.lstm = nn.LSTM(embed_size, hidden_size, batch_first=True) self.fc = nn.Linear(hidden_size, output_size) def forward(self, x, lengths): x = self.embedding(x) packed = pack_padded_sequence(x, lengths, batch_first=True, enforce_sorted=False) packed_out, (h, c) = self.lstm(packed) h = h[-1] return self.fc(h) åˆ†è¯å™¨åœ¨è°ƒè¯•çš„è¿‡ç¨‹æˆ‘å‘ç°ï¼Œå•å•é€šè¿‡ç©ºæ ¼ä¹Ÿå°±æ˜¯ split æ¥å¯¹å¥å­è¿›è¡Œåˆ†è¯æ˜¯ä¸è¶³çš„ï¼Œä¼šå‡ºç° me.ï¼Œok! è¿™æ ·å¥‡æ€ªçš„ tokenï¼Œç”šè‡³æœ‰äº›é™„å¸¦äº†æ¢è¡Œç¬¦ã€‚ ä¼˜åŒ–æ–¹å‘åŒ…æ‹¬ï¼š å»æ‰ HTML æ¢è¡Œæ ‡ç­¾ç­‰ ç»Ÿä¸€å¼•å·ï¼ˆé¿å…å¥‡æ€ªçš„ Unicode å¼•å·ï¼‰ é€šè¿‡ torchtext åº“æ¥è¿›è¡Œ tokenizer python from torchtext.data.utils import get_tokenizer tok = get_tokenizer(\"basic_english\") tok(\"I don't like this movie!!! it's bad\") # -\u003e ['i', \"don't\", 'like', 'this', 'movie', '!', '!', '!', \"it's\", 'bad'] æ­£åˆ™åŒ–ä¸è¶³ç°åœ¨ä»…å¯¹ $h_t$ åšäº† dropoutï¼Œä½†æ›´é€šç”¨çš„æ˜¯å¯¹è¾“å…¥åµŒå…¥å’Œ LSTM å±‚é—´åš dropoutï¼Œå»ºè®®åœ¨ $xt$ æˆ– $c_t$ ä¸Šåš dropoutï¼Œè€Œä¸æ˜¯åªåœ¨ $h_t$ ä¸Šã€‚ model å…¶ä»– æ•°æ®æ³„éœ²é—®é¢˜ï¼šEmbedding åº”è¯¥ä»…ç”¨è®­ç»ƒé›†æ„å»ºè¯æ±‡è¡¨ï¼Œæµ‹è¯•é›†çš„æœªçŸ¥è¯ç»Ÿä¸€ç”¨ è¡¨ç¤º æµ‹è¯•é›† DataLoader è®¾ä¸º shuffle=Trueï¼Œæµ‹è¯•æ—¶æ— éœ€æ‰“ä¹±æ•°æ®ï¼Œåè€Œå¢åŠ è®¡ç®—å¼€é”€ ","date":"2025-12-19","objectID":"/posts/lstm/:2:6","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"LSTM","uri":"/posts/lstm/#å…¶ä»–"},{"categories":null,"content":" Architectures Normorlization Pre - Post Layer Norm - RMS Norm Activations ReLU, GeLU, GLU HyperParameters $d_{ff}$,$d_{model}$ num_heads vocabulary dropout \u0026 regularization Stability Tricks Other MHA ","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:1:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#architectures"},{"categories":null,"content":" Norm","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:2:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#norm"},{"categories":null,"content":" PreNorm ç°ä»£çš„ Transformer æ¶æ„ä¸­ï¼ŒTransformer Block éƒ½é‡‡ç”¨ PreNorm è€Œä¸æ˜¯ PostNormï¼Œå…·ä½“æ¥è¯´å°±æ˜¯æŠŠ Norm æ”¾åœ¨æ³¨æ„åŠ›æœºåˆ¶å’Œ FFN å‰é¦ˆç½‘ç»œå±‚å‰é¢ï¼Œè€Œä¸æ˜¯è¿›è¡Œæ®‹å·®è¿æ¥ä¹‹åå† Normã€‚ä¼˜ç‚¹åœ¨äº==è®­ç»ƒæ›´ç¨³å®šï¼Œå¯ä»¥é‡‡ç”¨æ›´å¤§çš„å­¦ä¹ ç‡==ã€‚ ","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:2:1","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#prenorm"},{"categories":null,"content":" RMSNormy=xâˆ£âˆ£xâˆ£âˆ£22+Ïµâˆ—Î³ y=\\frac{x}{\\sqrt{||x||_2^2+\\epsilon}}*\\gamma y=âˆ£âˆ£xâˆ£âˆ£22â€‹+Ïµâ€‹xâ€‹âˆ—Î³å’Œ LayerNorm å¯¹æ¯”æ€§èƒ½ç›¸å½“ï¼Œå¹¶ä¸”æ›´å¿«ï¼ˆä¸éœ€è¦å‡å‡å€¼ï¼Œè®¡ç®—é‡å°ï¼‰ã€‚ ","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:2:2","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#rmsnorm"},{"categories":null,"content":" Drop BiasFFN å‰é¦ˆç½‘ç»œå±‚å»æ‰ Bias ä¼˜åŒ–æ›´ç¨³å®šï¼Œå¹¶ä¸”å†…å­˜å ç”¨æ›´å°‘ã€‚ ","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:2:3","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#drop-bias"},{"categories":null,"content":" Activations","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:3:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#activations"},{"categories":null,"content":" GLUGLU å…¨ç¨‹æ˜¯ Gated Linear Unitï¼Œæ˜¯ç”± â€œé—¨æ§â€ï¼ˆgatingï¼‰æœºåˆ¶å’Œ çº¿æ€§æ¿€æ´»ï¼ˆlinear activationï¼‰ç»“åˆè€Œæˆçš„ï¼Œå…¶å·¥ä½œåŸç†å—åˆ°äº† LSTMï¼ˆé•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼‰ä¸­é—¨æ§ç»“æ„çš„å¯å‘ã€‚ GLU(x)=Ïƒ(xW+b)âŠ—(xV+c) GLU(x)=Ïƒ(xW+b)âŠ—(xV+c) GLU(x)=Ïƒ(xW+b)âŠ—(xV+c) $\\sigma$ æ˜¯ sigmoid å‡½æ•° $\\odot$ æ˜¯é€å…ƒç´ ç‚¹ä¹˜ æ€è·¯å°±æ˜¯å¯¹ x åšä¸¤æ¬¡è®¡ç®—ï¼Œä¸€æ¬¡çº¿æ€§è®¡ç®—ä¸°å¯Œ x çš„ä¿¡æ¯ï¼Œä¸€æ¬¡ sigmoid å°†å…¶æ˜ å°„åˆ° 0-1 åŒºé—´ï¼Œ==å†³å®šé‚£äº›ä¿¡æ¯ä¿å­˜ï¼Œå“ªä¸€äº›å»é™¤==ã€‚ GLU çš„å˜ä½“åŒ…æ‹¬ï¼š ReGLUï¼š$ReGLU(x) = max(0, xW) \\odot xV$ GeGLUï¼š$ReGLU(x) = GeLU(xW) \\odot xV$ SwiGLUï¼š$ReGLU(x) = Swish(xW) \\odot xV$ â€¦ !!! Attention ç›¸è¾ƒäºæ™®é€šæ¿€æ´»å‡½æ•°çš„ FNNï¼Œ $FFN(x) = h(xW_1)*W_2$ï¼ŒGLU çš„å‚æ•°é‡ä¸ºå…¶ 3/2ï¼Œå› ä¸ºå¤šäº†ä¸€ä¸ªé—¨æ§çš„çŸ©é˜µã€‚æ‰€ä»¥ä¸ºäº†ä¿è¯å‚æ•°é‡ä¸€è‡´ï¼Œå¸¦ GLU çš„ FFN ä¸€èˆ¬ $d_{ff}$ éƒ½è®¾ä¸ºæ™®é€š FFN çš„ 2/3ã€‚ ","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:3:1","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#glu"},{"categories":null,"content":" HyperParameters FFNï¼š$d_{ff}=4d_{model}$ å¦‚æœæ˜¯ GLU åˆ™æ˜¯ $d_{ff}=2.66d_{model}$ Head Dimï¼š$num_heads * d_{k} = d_{model}$ Aspect Ratioï¼šæ¨¡å‹çš„å®½é«˜æ¯”ï¼Œå¢åŠ  num_layers ä¼šå¯¼è‡´æ— æ³•å¹¶è¡Œï¼Œå¢åŠ  d_model å¯ä»¥æ‹†åˆ†çŸ©é˜µå¹¶è¡Œè®¡ç®— Vocabulary Sizeï¼šå•è¯­è¨€ 35-50Kï¼Œå¤šè¯­è¨€ 100-250K Dropout \u0026 Weight Decayï¼šåœ¨é¢„è®­ç»ƒæ—¶å€™ Weight Decay ä½œç”¨ä¸æ˜¯é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œè€Œæ˜¯èƒ½åœ¨åæœŸè®­ç»ƒæ›´å¿«æ›´å¹³æ»‘ã€‚ ","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:4:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#hyperparameters"},{"categories":null,"content":" Stability Tricks","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:5:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#stability-tricks"},{"categories":null,"content":" Z-losssoftmax=eiâˆ‘jej=eiZ(x) softmax=\\frac{e^i}{\\sum_j{e^j}}=\\frac{e^i}{Z(x)} softmax=âˆ‘jâ€‹ejeiâ€‹=Z(x)eiâ€‹Transformer ä¸­æœ‰ä¸¤ä¸ª Softmax,åˆ†åˆ«åœ¨ attention ä¸­å’Œæœ€åè¾“å‡ºçš„åœ°æ–¹ã€‚Softmaxçš„ä¸ç¨³å®šæ€§ä¸»è¦æ¥è‡ªäºåˆ†æ¯çš„è®¡ç®—ï¼Œå®¹æ˜“ overflow å¯¼è‡´æ•´ä¸ªè®¡ç®—ç»“æœæ— æ•ˆï¼Œä½¿æ¢¯åº¦è®¡ç®—å´©æºƒã€‚Z-loss ç›®çš„å¼•å…¥ä¸€ä¸ªè¾…åŠ©æŸå¤±é¡¹ï¼Œä½¿å¾— Z(x) è¶‹è¿‘äº 1ã€‚z-losså°±åƒä¸€ä¸ªæ­£åˆ™åŒ–é¡¹ï¼Œä¸“é—¨ä½œç”¨äº logits çš„å¤§å°ã€‚ ","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:5:1","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#z-loss"},{"categories":null,"content":" QK NormæŠŠæ¯ä¸ª query å‘é‡å’Œ key å‘é‡éƒ½å•ç‹¬åš L2 å½’ä¸€åŒ–ï¼Œç„¶åå†ç®— attention score,é€å…¥ softmaxã€‚è¿™èƒ½å›ºå®šscoreçš„èŒƒå›´ï¼Œä½¿ softmax æ›´å¹³æ»‘ï¼Œè®­ç»ƒæ›´ç¨³å®šã€‚ ","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:5:2","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#qk-norm"},{"categories":null,"content":" Other MHA","date":"2025-12-19","objectID":"/posts/cs336-lecture3/:6:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 3: Architectures \u0026 Hyperparameters","uri":"/posts/cs336-lecture3/#other-mha"},{"categories":null,"content":"!!! abstract æœ¬èŠ‚ä¸»è¦è®²è§£å†…å­˜è®¡ç®—é—®é¢˜ï¼Œé¦–å…ˆä»‹ç»äº†float32, float 16 ç­‰æ•°æ®ç±»å‹ã€‚éšåä»‹ç» PyTorch ä¸­çš„ tensor è¿™ä¸€é‡è¦çš„æ•°æ®ç±»å‹ã€‚æœ€åä¸¾ä¾‹ä»‹ç»äº†åœ¨æ¨¡å‹è®­ç»ƒä¸­å„ä¸ªéƒ¨åˆ†æ‰€éœ€è¦çš„è®¡ç®—é‡ï¼Œå¹¶ä»‹ç»äº†æµ®ç‚¹è¿ç®—åˆ©ç”¨ç‡è¿™ä¸€æŒ‡æ ‡ä»¥è¡¡é‡ç¡¬ä»¶è®¡ç®—æ•ˆç‡ã€‚é‡ç‚¹å¦‚ä¸‹ï¼š 1. åœ¨PyTorch ä¸­ tensor æ˜¯å¯¹å·²åˆ†é…å†…å­˜çš„æŒ‡é’ˆï¼Œå¾ˆå¤šæ“ä½œæ— éœ€æ–°å ç”¨å†…å­˜ 2. å¤§å‹çŸ©é˜µä¹˜æ³•åœ¨æ·±åº¦å­¦ä¹ æ‰€éœ€è®¡ç®—é‡æœ€å¤§ 3. æµ®ç‚¹è¿ç®—åˆ©ç”¨ç‡ $MFU=\\frac{actualFLOP/s}{promised FLOP/s}$ 4. å‰å‘ä¼ æ’­æ‰€éœ€è®¡ç®—é‡ï¼š2Ã—(#tokens)Ã—(#parameters) 5. åå‘ä¼ æ’­æ‰€éœ€è®¡ç®—é‡ï¼š4Ã—(#tokens)Ã—(#parameters) ","date":"2025-12-19","objectID":"/posts/cs336-lecture2/:0:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 2: Computing","uri":"/posts/cs336-lecture2/#"},{"categories":null,"content":" Memory Accountingä»‹ç»äº† FP32ã€FP16 ä»¥åŠ BP16 å’Œ FP8 å››ç§ç²¾åº¦ï¼Œåœ¨ CS224 ä»‹ç»è¿‡ï¼Œå°±ä¸å¤šè¯´äº†ã€‚ ","date":"2025-12-19","objectID":"/posts/cs336-lecture2/:1:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 2: Computing","uri":"/posts/cs336-lecture2/#memory-accounting"},{"categories":null,"content":" Compute Accountingåœ¨ Ptorch ä¸­ï¼Œå¼ é‡å­˜å‚¨äº†æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆï¼Œåˆæ¬¡ä¹‹å¤–è¿˜æœ‰ä¸€äº› Metadataï¼Œä¾‹å¦‚ stridesã€‚ stride æŒ‡çš„æ˜¯ï¼šæ²¿ç€è¿™ä¸ªæ–¹å‘åˆ°è¾¾ä¸‹ä¸€è¡Œéœ€è¦ç»è¿‡å‡ ä¸ªå…ƒç´  åœ¨ç´¢å¼• Tensor ä¸­å…ƒç´ (x,y)æ—¶ï¼Œåªéœ€è¦åœ¨å¦‚å›¾æ‰€ç¤ºçš„é•¿æ•°ç»„ä¸­æ‰¾åˆ°ç¬¬ N ä¸ªå…ƒç´ å³å¯ï¼Œç´¢å¼•è®¡ç®—æ–¹å¼ä¸ºï¼š N=xÃ—stride[1]+yÃ—stride[0] N = x \\times \\text{stride}[1] + y \\times \\text{stride}[0] N=xÃ—stride[1]+yÃ—stride[0]åœ¨PyTorch ä¸­ï¼Œå¾ˆå¤šå¯¹äº tensor çš„æ“ä½œå®é™…ä¸Šåªæ˜¯åœ¨åˆ›å»ºæ–°çš„è§†å›¾(view)ï¼Œè€Œæ— éœ€é‡æ–°åˆ†é…å†…å­˜ã€‚ä¾‹å¦‚å¯¹äº Slice æ“ä½œæ¥è¯´ï¼Œå‡å¦‚æˆ‘æœ‰å˜é‡ x = torch.arrange(10)ï¼Œå°±ä¼šå°† [0, 1, 2, 3, 4, â€¦, 9] å­˜åœ¨å†…å­˜ä¸­ã€‚å½“æˆ‘å¯¹ä»–è¿›è¡Œåˆ‡ç‰‡æ“ä½œ y = x[2:9:2] æ—¶ï¼Œå¼ é‡ y çš„ Pointer è¿˜æ˜¯æŒ‡å‘ x çš„åŒä¸€å—åŒºåŸŸï¼Œä½†æ˜¯ y çš„ Metadata å°±è¯¥æ”¹å˜äº†ï¼š assert y.data_prt() == x.data_prt() assert y.stride() == 2 assert y.storage_offset() == 2 Pytorch ä¸­å¤§éƒ¨åˆ†å¯¹ tensor çš„æ“ä½œé»˜è®¤è¦æ±‚å…¶æ˜¯ contiguousï¼Œè¿ç»­çš„å®šä¹‰æ˜¯==é€»è¾‘ä¸Šç›¸é‚»çš„å…ƒç´ åœ¨å†…å­˜ä¸­ä¹Ÿç›¸é‚»==ï¼Œå…·ä½“æ¥è¯´ï¼š stride[n-1] == 1 stride[i] == stride[i+1] * size[i+1] è¿›è¡Œåˆ‡ç‰‡æ“ä½œ [::2] æˆ–è€…è½¬ç½®(strides[-1]å’Œstrides[-2]äº’æ¢)æ—¶ï¼Œtensor å°±æ˜¯ non-contiguous çš„äº†ã€‚ .contiguous() ä¼šè¿”å›ä¸€ä¸ªåœ¨å†…å­˜å¸ƒå±€ä¸Šæ˜¯ contiguous çš„ tensorï¼Œå¹¶ä¸”åœ¨æ•°å€¼ä¸Šä¸åŸ tensor ç­‰ä»·ã€‚ ","date":"2025-12-19","objectID":"/posts/cs336-lecture2/:2:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 2: Computing","uri":"/posts/cs336-lecture2/#compute-accounting"},{"categories":null,"content":" Compute Costä¸€æ¬¡æµ®ç‚¹æ•°è¿ç®—æ˜¯æŒ‡ä¸€æ¬¡åŸºæœ¬è®¡ç®—ï¼ŒåŒ…æ‹¬åŠ æ³•(â€+â€)å’Œ ä¹˜æ³•(â€Ã—â€)ã€‚æ³¨æ„åŒºåˆ†å¦‚ä¸‹ä¸¤ä¸ªç®€å†™ï¼š FLOPsï¼šæµ®ç‚¹è®¡ç®—æ¬¡æ•°ï¼Œç”¨ä»¥è¡¡é‡è®¡ç®—é‡ FLOP/sï¼šæ¯ç§’æµ®ç‚¹è®¡ç®—æ•°é‡ï¼Œä¹Ÿå« FLOPSï¼Œç”¨ä»¥è¡¡é‡ç¡¬ä»¶è®¡ç®—é€Ÿåº¦ å¯¹äº Linear è®¡ç®—ï¼š python x = torch.ones(B, D) w = torch.randn(D, K) y = x @ w æ€»æµ®ç‚¹è®¡ç®—é‡ä¸ºï¼š$flops=2BD*K$ã€‚ä¹˜ä»¥ 2 çš„åŸå› æ˜¯ï¼Œ$y[i][k]=\\sum_{j=0}^{D-1}{x[i][j] * w[j][k]}$ï¼Œæ‰€ä»¥éœ€è¦ä¹˜æ³•+åŠ æ³•ä¸¤æ¬¡ï¼ˆåŠ æ³•å’Œä¹˜æ³•çœ‹åšæ˜¯ç­‰ä»·çš„ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒè¿›ä¸€æ­¥åˆ†è§£ä¸ºï¼š python for i in range(B): for k in range(K): for j in range(D): y[i][k] += x[i][j] + w[j][k] å¯¹äºåå‘ä¼ æ’­ï¼š python h1 = x[B,D] * w1[D,D] h2 = h1[B,D] * w2[D,K] loss = loss(h2[B,K]) $\\frac{\\partial{loss}}{\\partial{h_1}}=\\frac{\\partial{loss}}{\\partial{h_2}}[B,K] @ w_2^T[K,D]$ ï¼šè®¡ç®—é‡ä¸º $2BD*K$ $\\frac{\\partial{loss}}{\\partial{w_1}}=\\frac{\\partial{loss}}{\\partial{h_1}}[B,D] @ x^T[D,B]$ ï¼šè®¡ç®—é‡ä¸º $2BD*D$ åŒæ—¶ $\\frac{\\partial{loss}}{\\partial{x}}$ å’Œ $\\frac{\\partial{loss}}{\\partial{h_2}}$ ä¸€æ · ","date":"2025-12-19","objectID":"/posts/cs336-lecture2/:3:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 2: Computing","uri":"/posts/cs336-lecture2/#compute-cost"},{"categories":null,"content":"!!! abstract æœ¬èŠ‚ä¸»è¦è®²è§£å¸¸è§çš„å‡ ç§ Tokenizer ä»¥åŠå®ƒä»¬çš„ä¼˜åŠ£ï¼Œæœ€åä»‹ç»äº† BPE çš„å®ç°æ€è·¯ã€‚ ","date":"2025-12-17","objectID":"/posts/cs336-lecture1/:0:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 1: Tokenization","uri":"/posts/cs336-lecture1/#"},{"categories":null,"content":" Tokenizer ä¸»è¦ç±»å‹","date":"2025-12-17","objectID":"/posts/cs336-lecture1/:1:0","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 1: Tokenization","uri":"/posts/cs336-lecture1/#tokenizer-ä¸»è¦ç±»å‹"},{"categories":null,"content":" 1. Character-based ä¼˜ç‚¹ï¼šä¸ä¼šå‡ºç° Out of vocabulary çš„æƒ…å†µ ç¼ºç‚¹ï¼šè¯è¡¨å¤§å°çˆ†ç‚¸ï¼Œéœ€è¦æ¶µç›–æ¯ä¸€ç§è¯­è¨€çš„æ¯ä¸€ä¸ªå­—ç¬¦ ","date":"2025-12-17","objectID":"/posts/cs336-lecture1/:1:1","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 1: Tokenization","uri":"/posts/cs336-lecture1/#1-character-based"},{"categories":null,"content":" 2. Byte-basedå°†å­—ç¬¦ä¸²è½¬ç ä¸º UTF-8 bytesï¼Œä¾‹å¦‚ï¼šâ€˜ä½ â€™ â†’ â€˜E4 BD A0â€™ï¼Œæ¯ä¸ª byte èƒ½è¡¨ç¤º 0-255 å°±æ˜¯ä¸€ä¸ª tokenã€‚ ä¼˜ç‚¹ï¼šä¸ä¼šå‡ºç° OOVã€æ”¯æŒæ‰€æœ‰è¯­è¨€ã€ç®€å• ç¼ºç‚¹ï¼š å‹ç¼©æ¯”ä½ï¼šä¸€ä¸ªä¸­æ–‡å­—ç¬¦éœ€è¦ 3 ä¸ª token è¡¨ç¤º åºåˆ—é•¿åº¦éå¸¸é•¿ï¼šTransformer æ—¶é—´å¤æ‚åº¦æ˜¯ O(nÂ²) ","date":"2025-12-17","objectID":"/posts/cs336-lecture1/:1:2","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 1: Tokenization","uri":"/posts/cs336-lecture1/#2-byte-based"},{"categories":null,"content":" 3. Word-based ç¼ºç‚¹ï¼šè¯è¡¨å¤§å°çˆ†ç‚¸ï¼Œå®¹æ˜“å‡ºç° [UNK] ","date":"2025-12-17","objectID":"/posts/cs336-lecture1/:1:3","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 1: Tokenization","uri":"/posts/cs336-lecture1/#3-word-based"},{"categories":null,"content":" 4. BPEByte Pair Encoding ç»§æ‰¿äº† Byted-base çš„æ€è·¯ é¦–å…ˆè¿˜æ˜¯ç”¨ UTF-8 ç¼–ç å°†å­—ç¬¦è½¬ä¸º bytes ç»Ÿè®¡æ‰€æœ‰ token pair å‡ºç°çš„æ¬¡æ•° å¯¹å‡ºç°æœ€å¤šæ¬¡çš„ token è¿›è¡Œåˆå¹¶ï¼Œç›´åˆ°è¯è¡¨è¾¾åˆ°ç›®æ ‡å¤§å° ç®€å•å®ç°ï¼š python string = \"Hello World\" num_merges = 3 indices = [116, 104, 101, 32, 99, 97, 116, 32, 105, 110, ...] pair_counts = { [116, 104]: 2, [104, 110]: 2, ... } # merge [116, 104] into 256 new_indices = [256, 101, 32, 99, 97, 116, 32, 105, 110, ...] # do again è¿™ä¸ªå®ç°çš„é—®é¢˜åœ¨äºï¼š BPE å¯èƒ½å­¦ä¹ å‡ºå¾ˆå¤šå¥‡æ€ªçš„ç»„åˆï¼Œä¾‹å¦‚ â€™lrâ€™ï¼Œâ€˜ok!â€™ï¼Œâ€˜ok.â€™ è¿™ç§ç»„åˆï¼Œæœ‰äº›æ„æ€ç›¸ä»…ï¼Œæœ‰äº›å®Œå…¨æ²¡æœ‰è¯­ä¹‰ ","date":"2025-12-17","objectID":"/posts/cs336-lecture1/:1:4","series":["CS336"],"tags":["å¤§æ¨¡å‹"],"title":"CS336 Lecture 1: Tokenization","uri":"/posts/cs336-lecture1/#4-bpe"},{"categories":null,"content":" Self-Attention","date":"2025-12-11","objectID":"/posts/final-project-minbert/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#self-attention"},{"categories":null,"content":" BertModel.embed python def embed(self, input_ids): # input_ids: [bs, seq_len] input_shape = input_ids.size() seq_length = input_shape[1] # Get word embedding from self.word_embedding into input_embeds. inputs_embeds = None ### TODO # [bs, seq_len, hidden_size] inputs_embeds = self.word_embedding(input_ids) # Get position index and position embedding from self.pos_embedding into pos_embeds. pos_ids = self.position_ids[:, :seq_length] pos_embeds = None ### TODO pos_embeds = self.pos_embedding(pos_ids) # Get token type ids, since we are not consider token type, just a placeholder. tk_type_ids = torch.zeros(input_shape, dtype=torch.long, device=input_ids.device) tk_type_embeds = self.tk_type_embedding(tk_type_ids) # Add three embeddings together; then apply embed_layer_norm and dropout and return. ### TODO embed = inputs_embeds + pos_embeds + tk_type_embeds embed = self.embed_layer_norm(embed) return self.embed_dropout(embed) pos_ids æ˜¯ä¸€ä¸ªå½¢å¦‚ [[1, 2, 3, â€¦, n], [1, 2, 3, â€¦, n]] çš„åˆ—è¡¨ï¼Œå½¢çŠ¶å’Œ input_ids ç›¸åŒï¼Œç”¨äºè·å–ä½ç½®åµŒå…¥ï¼Œè¿™é‡Œçš„ Position Embedding ç”¨çš„æ˜¯==å¯å­¦ä¹ ä½ç½®ç¼–ç ==ã€‚ tk_type_ids æ˜¯ç”¨äºåŒºåˆ†å¥å­çš„ï¼Œä½†æ˜¯è¿™é‡Œæ²¡æœ‰ç”¨åˆ°ï¼Œæ‰€ä»¥ç”¨çš„æ˜¯ torch.zeros ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:1:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#bertmodelembed"},{"categories":null,"content":" BertLayer python def add_norm(self, input, output, dense_layer, dropout, ln_layer): ### TODO output = dense_layer(output) output = dropout(output) context = input + output return ln_layer(context) def forward(self, hidden_states, attention_mask): ### TODO # multi-head attention attn_value = self.self_attention(hidden_states, attention_mask) # add-norm normed_attn = self.add_norm(hidden_states, attn_value, self.attention_dense, self.attention_dropout, self.attention_layer_norm) # feedforward ff = self.interm_dense(normed_attn) ff = self.interm_af(ff) # add-norm normed_ff = self.add_norm(normed_attn, ff, self.out_dense, self.out_dropout, self.out_layer_norm) return normed_ff BertLayer å°±æ˜¯==è‡ªæ³¨æ„åŠ›+æ®‹å·®å½’ä¸€+å‰é¦ˆç½‘ç»œ+æ®‹å·®å½’ä¸€==çš„ç»„åˆï¼Œæ²¡æœ‰ç‰¹åˆ«éœ€è¦æ³¨æ„çš„ã€‚ ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:1:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#bertlayer"},{"categories":null,"content":" BertSelfAttention python def attention(self, key: torch.Tensor, query: torch.Tensor, value: torch.Tensor, attention_mask: torch.Tensor): \"\"\" softmax(QK^T/sqrt(d_k))V q, k, v æ˜¯ [bs, seq_len, hidden_state] ç»è¿‡ transform() å˜æˆ [bs, n_heads, seq_len, head_size] \"\"\" bs, _, seq_len, _ = key.shape scores = torch.matmul(query, key.transpose(-1, -2)) / math.sqrt(self.attention_head_size) if attention_mask is not None: scores += attention_mask attn = torch.softmax(scores, dim=-1) attn = self.dropout(attn) attn = torch.matmul(attn, value) # currently shape [bs, n_heads, seq_len, head_size] output = attn.transpose(1, 2).contiguous().view(bs, seq_len, self.all_head_size) return output è‡ªæ³¨æ„åŠ›çš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œä¸è¿‡éœ€è¦æ³¨æ„ï¼šè¿™é‡Œ attention_mask ä¸æ˜¯ 0 å’Œ 1è€Œæ˜¯ -10000 å’Œ 0ï¼Œæ‰€ä»¥ç›´æ¥åŠ ä¸Šå»å°±å¥½ï¼Œä¸éœ€è¦ç”¨ scores.masked_fill ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:1:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#bertselfattention"},{"categories":null,"content":" OptimizeråŸºç¡€æ¦‚å¿µå‚è§ï¼š[[optimizer]] python def step(self, closure: Callable = None): loss = None if closure is not None: loss = closure() for group in self.param_groups: for p in group[\"params\"]: if p.grad is None: continue grad = p.grad.data if grad.is_sparse: raise RuntimeError(\"Adam does not support sparse gradients, please consider SparseAdam instead\") # State should be stored in this dictionary state = self.state[p] # Access hyperparameters from the `group` dictionary alpha = group[\"lr\"] ### TODO if not state: state[\"m\"] = torch.zeros_like(p) state[\"v\"] = torch.zeros_like(p) state[\"step\"] = 0 state[\"step\"] += 1 state[\"m\"] = group[\"betas\"][0] * state[\"m\"] + (1 - group[\"betas\"][0]) * grad state[\"v\"] = group[\"betas\"][1] * state[\"v\"] + (1 - group[\"betas\"][1]) * grad ** 2 if group[\"correct_bias\"]: m = state[\"m\"] / (1 - group[\"betas\"][0] ** state[\"step\"]) v = state[\"v\"] / (1 - group[\"betas\"][1] ** state[\"step\"]) else: m, v = state[\"m\"], state[\"v\"] p.data -= alpha * group[\"weight_decay\"] * p.data p.data -= alpha * m / (torch.sqrt(v) + group[\"eps\"]) return loss PyTorch çš„ Optimizer åŸºç±»ä¸­ï¼Œè¶…å‚æ•°å’Œ params éƒ½å­˜åœ¨ group ä¹‹ä¸­ï¼Œmã€v ä¿å­˜åœ¨ state ä¸­ï¼Œä¸€å¼€å§‹æˆ‘çš„æ€è·¯å¦‚ä¸Šï¼Œä½†æ˜¯è¿™ä¸ªä»£ç å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š Bias Correction è®¡ç®—æ²¡æœ‰é‡‡ç”¨ Efficient Versionï¼Œè®¡ç®—æ•ˆç‡ä½ æˆ‘çš„è®¡ç®—æ¯æ¬¡éƒ½è¦åˆ›å»ºæ–° Tensorï¼Œå¼€é”€å¾ˆå¤§ Efficient Bias Correction çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šç®€åŒ–å…¬å¼ä¼˜åŒ–æ‰ $\\hat{m}$ å’Œ $\\hat{n}$ é¿å…åˆ›å»º Tensor çš„å¼€é”€ Î±m^tv^t+Îµ=Î±1âˆ’Î²1tâ‹…mv/(1âˆ’Î²2t)=Î±â‹…1âˆ’Î²2t1âˆ’Î²1tâ‹…mv \\begin{align} \\alpha\\frac{\\hat m_t}{\\sqrt{\\hat v_t} + \\varepsilon} \u0026= \\frac{\\alpha}{1-\\beta_1^t}\\cdot\\frac{m}{\\sqrt{v/(1-\\beta_2^t)}} \\\\ \u0026=\\alpha \\cdot\\frac{\\sqrt{1-\\beta_2^t}}{1-\\beta_1^t}\\cdot\\frac{m}{\\sqrt{v}} \\end{align} Î±v^tâ€‹â€‹+Îµm^tâ€‹â€‹â€‹=1âˆ’Î²1tâ€‹Î±â€‹â‹…v/(1âˆ’Î²2tâ€‹)â€‹mâ€‹=Î±â‹…1âˆ’Î²1tâ€‹1âˆ’Î²2tâ€‹â€‹â€‹â‹…vâ€‹mâ€‹â€‹â€‹ è°ƒç”¨ PyTorch è‡ªå¸¦çš„åŸåœ°ç®—å­å¯ä»¥é¿å…åˆ›å»ºæ–° Tensor çš„å¼€é”€ã€‚ python def step(self, closure: Callable = None): loss = None if closure is not None: loss = closure() for group in self.param_groups: beta1, beta2 = group[\"betas\"] eps = group[\"eps\"] wd = group[\"weight_decay\"] alpha = group[\"lr\"] for p in group[\"params\"]: if p.grad is None: continue grad = p.grad.data if grad.is_sparse: raise RuntimeError(\"Adam does not support sparse gradients, please consider SparseAdam instead\") state = self.state[p] ### TODO if not state: state[\"m\"] = torch.zeros_like(p) state[\"v\"] = torch.zeros_like(p) state[\"step\"] = 0 state[\"step\"] += 1 # state[\"m\"] = group[\"betas\"][0] * state[\"m\"] + (1 - group[\"betas\"][0]) * grad # state[\"v\"] = group[\"betas\"][1] * state[\"v\"] + (1 - group[\"betas\"][1]) * grad ** 2 state[\"m\"].mul_(beta1).add_(grad, alpha=1-beta1) state[\"v\"].mul_(beta2).addcmul_(grad, grad, value=1-beta2) if group[\"correct_bias\"]: # m = state[\"m\"] / (1 - group[\"betas\"][0] ** state[\"step\"]) # v = state[\"v\"] / (1 - group[\"betas\"][1] ** state[\"step\"]) step_size = alpha * .sqrt(1 - beta2 ** state[\"step\"]) / (1 - beta1 ** state[\"step\"]) else: # m, v = state[\"m\"], state[\"v\"] step_size = alpha denom = state[\"v\"].sqrt().add_(eps) p.data.addcdiv_(state[\"m\"], denom, value=-step_size) if wd != 0: p.data.add_(p.data, alpha=-alpha * wd) return loss ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#optimizer"},{"categories":null,"content":" Classifierclassifier.py è¿™ä¸ªä»»åŠ¡ä¸»è¦æ˜¯ä¸€ä¸ªæƒ…æ„Ÿåˆ†ç±»å™¨ï¼Œå®ƒåŸºäºä¹‹å‰å†™å¥½çš„é¢„è®­ç»ƒçš„ Bertã€‚ä»»åŠ¡åˆ†ä¸ºä¸¤ä¸ªï¼š å†»ç»“ Bert å‚æ•°å¯¹åˆ†ç±»å¤´è¿›è¡Œå¾®è°ƒ è§£å†»å‚æ•°ï¼Œå¯¹å…¨æ¨¡å‹è¿›å¾®è°ƒ ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#classifier"},{"categories":null,"content":" BertSentimentClassifier python class BertSentimentClassifier(torch.nn.Module): def __init__(self, config): super(BertSentimentClassifier, self).__init__() self.num_labels = config.num_labels self.bert = BertModel.from_pretrained('bert-base-uncased') # Pretrain mode does not require updating bert paramters. for param in self.bert.parameters(): if config.option == 'pretrain': param.requires_grad = False elif config.option == 'finetune': param.requires_grad = True ### TODO self.dropout = torch.nn.Dropout(p=config.hidden_dropout_prob) self.dense = torch.nn.Linear(in_features=config.hidden_size, out_features=128) self.classifier = torch.nn.Linear(in_features=128, out_features=config.num_labels) self.relu = torch.nn.ReLU() def forward(self, input_ids, attention_mask): bert_output = self.bert(input_ids, attention_mask) # shape [bs, hidden_size] hidden_state = bert_output[\"pooler_output\"] output = self.dense(hidden_state) output = self.dropout(output) output = self.relu(output) return self.classifier(output) ç¬¬ä¸€æ¬¡è®¾è®¡æ—¶å€™åªæœ‰ä¸€ä¸ªçº¿æ€§å±‚ï¼Œæˆ‘æŠŠ hidden_size ç›´æ¥æŠ•å½±åˆ° num_labelsï¼Œä½†æ˜¯å‡†ç¡®ç‡æ²¡æœ‰è¾¾åˆ° handout çš„è¦æ±‚ã€‚ ç¬¬äºŒæ¬¡è®¾è®¡æˆ‘ç”¨ä¸¤ä¸ªçº¿æ€§å±‚ï¼Œé¦–å…ˆæŠŠ hidden_size æŠ•å½±åˆ° 128 ç»´ï¼Œç„¶åå†æŠ•å½±åˆ° num_labelsï¼Œç»“æœå‡ºç°äº†è®­ç»ƒé›†å‡†ç¡®ç‡å˜é«˜ï¼Œæµ‹è¯•é›†æ­£ç¡®ç‡å˜ä½ï¼Œæ˜æ˜¾æ˜¯è¿‡æ‹Ÿåˆäº†ã€‚ ç¬¬ä¸‰æ¬¡æˆ‘å…ˆæŠŠ hidden_size æŠ•å½±åˆ° 64 ç»´ç„¶åå†æŠ•å½±åˆ° num_labelsï¼Œè¿‡æ‹Ÿåˆé—®é¢˜è§£å†³æ‰äº†ï¼Œä½†æ˜¯ 10 è½®ä¸‹æ¥æ­£ç¡®ç‡è¿˜æ˜¯æ²¡è¾¾åˆ°è¦æ±‚ ç¬¬å››æ¬¡æˆ‘ä»”ç»†æ£€æŸ¥äº†ä»£ç ï¼Œå‘ç°é»˜è®¤æƒ…å†µä¸‹è®­ç»ƒçš„ lr æ˜¯ 1e-5 ä¹Ÿå¤ªä½äº†ï¼Œæˆ‘æ”¹æˆ 1e-3 å°±è¿‡äº†ã€‚ ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:3:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#bertsentimentclassifier"},{"categories":null,"content":" MultiTaskClassifierbaseline ç‰ˆæœ¬æˆ‘æ²¡æœ‰å¯¹ä»£ç è¿›è¡Œè¿‡å¤šä¿®æ”¹ï¼Œæˆ‘è¡¥å…¨äº† MultitaskBERT çš„ä»£ç ï¼Œåœ¨å†»ç»“äº†çš„ minbert åŸºç¡€ä¸Šå¾®è°ƒä¸‰ä¸ªåˆ†ç±»å¤´ã€‚è€ƒè™‘åˆ°ä»»åŠ¡ä¹‹é—´çš„å…³ç³»ï¼ŒåµŒå…¥è¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨ä¸€äº›å…±äº«æƒé‡æˆ–ç»“æ„ï¼Œå› æ­¤å°† minBERT æ¨¡å‹ä¸ä»»åŠ¡å¤´ä¸€èµ·è¿›è¡Œ full-model å¾®è°ƒå¯èƒ½ä¼šå…¨é¢æå‡æ€§èƒ½ã€‚åœ¨å®éªŒä¸­ï¼Œæ¯ä¸ª epoch æœŸé—´å¤„ç†è¿™äº›ä»»åŠ¡çš„é¡ºåºæœ‰æ‰€ä¸åŒï¼Œä»è€Œäº§ç”Ÿäº†6ç§ä¸åŒçš„ Sequential Learningã€‚æœ€åè€ƒè™‘åˆ°æŒ‰é¡ºåºå¯¹ä»»åŠ¡è¿›è¡Œè®­ç»ƒå¯èƒ½å¯¼è‡´åè®­ç»ƒä»»åŠ¡çš„æ¢¯åº¦å½±å“å·²è®­ç»ƒçš„ä»»åŠ¡ï¼Œæ‰€ä»¥é‡‡ç”¨äº†æ··åˆè®­ç»ƒã€‚ ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#multitaskclassifier"},{"categories":null,"content":" åŸºå‡† æƒ…æ„Ÿé¢„æµ‹æƒ…æ„Ÿé¢„æµ‹çš„ forward å’Œ train éƒ¨åˆ†ä»£ç å’Œ classifier.py ä¸€è‡´æ²¡æœ‰è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯å‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­ä» epoch 2 å¼€å§‹ loss ä¸å˜äº†ã€‚æ£€æŸ¥ä»£ç ä¹‹åå‘ç°é—®é¢˜å‡ºåœ¨ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.dropout(senti) senti = self.senti_classifier(senti) return self.senti_relu(senti) åŸå› åœ¨äºæˆ‘æŠŠæ¿€æ´»å‡½æ•° ReLU æ”¾åœ¨å‰å‘è®¡ç®—çš„æœ€åä¸€æ­¥äº†ï¼ŒReLU çš„å‡½æ•°è¡¨è¾¾å¼ä¸º $ReLU=max(0,x)$ï¼Œæ‰€ä»¥æ”¾åœ¨æœ€åä¸€æ­¥ä¼šå›ºå®šæŠŠè´Ÿæ•°å˜æˆ 0ï¼Œæ­£ç¡®çš„é¡ºåºåº”è¯¥æ˜¯ ==Linear â†’ ReLU â†’ Dropout â†’ â€¦ â†’ æœ€åä¸€å±‚ Linearâ†’ è¾“å‡º==ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.senti_relu(senti) senti = self.dropout(senti) return self.senti_classifier(senti) è½¬è¿°é¢„æµ‹è¿™ä¸ªä»»åŠ¡æ˜¯ç»™å®šä¸¤ä¸ªå¥å­ï¼Œåˆ¤æ–­æ˜¯å¦å«ä¹‰ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä¼šå¾—åˆ°ä¸¤ä¸ª inputï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å°†å®ƒç»„è£…åˆ°ä¸€èµ·å‘¢ï¼Ÿæˆ‘çš„ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯ç›´æ¥æ‹¼å‡‘ä¸º [batch_size, seq_len, hidden_size * 2]ï¼Œç„¶ååç»­åœ¨æŠŠä»–æŠ•å½±åˆ°ä½ç»´ç©ºé—´ã€‚ python def predict_paraphrase(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): para_1 = self.forward(input_ids_1, attention_mask_1) para_2 = self.forward(input_ids_2, attention_mask_2) para_combined = torch.cat([para_1, para_2], dim=1) para_combined = self.para_dense(para_combined) para_combined = self.dropout(para_combined) para_combined = self.relu(para_combined) return self.para_classifier(para_combined) äºŒåˆ†ç±»é—®é¢˜ï¼Œforward è¾“å‡ºçš„ logits å½¢çŠ¶ä¸º [B, 1], è¿˜éœ€è¦é€šè¿‡ sigmoid è½¬æ¢ä¸ºæ¦‚ç‡ã€‚è®¡ç®— loss æ—¶å€™ BCEWithLogitsLoss è‡ªå¸¦ sigmoid äº†ï¼Œä½†æ˜¯è®¡ç®— acc æ—¶å€™æ˜¯é€šè¿‡ torch.mean(pred\\==labels)ï¼Œæ‰€ä»¥éœ€è¦æå‰åŠ  sigmoidã€‚ ç›¸ä¼¼åº¦é¢„æµ‹ç¬¬ä¸‰ä¸ªä»»åŠ¡æ˜¯å¯¹ä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼åº¦è¿›è¡Œæ‰“åˆ†ï¼Œæ‰“åˆ†åŒºé—´åœ¨ 0-5ã€‚æˆ‘çš„åšæ³•æ˜¯å°†éšè—çŠ¶æ€æŠ•å½±åˆ°ä¸€ç»´ç©ºé—´ ï¼Œç„¶åå¯¹ logits å®ƒè¿›è¡Œ sigmoid å°±èƒ½å¾—åˆ° 0-1 åŒºé—´çš„æ¦‚ç‡ï¼Œå†ä¹˜ä¸Š 5 å°±èƒ½å¾—åˆ° 0-5 çš„ç›¸ä¼¼åˆ†æ•°äº†ã€‚ python def predict_similarity(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): simi_1 = self.forward(input_ids_1, attention_mask_1) simi_2 = self.forward(input_ids_2, attention_mask_2) simi_combined = torch.cat([simi_1, simi_2], dim=1) simi_combined = self.sts_dense(simi_combined) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹æ®æ³¨é‡Š - è¿™ä¸ªå‡½æ•°éœ€è¦è¿”å›çš„æ˜¯ logitsï¼Œè€Œä¸éœ€è¦å¯¹å®ƒè¿›è¡Œå¤„ç†ã€‚è§‚å¯Ÿ evalution.py æ–‡ä»¶ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè®¡ç®— np.corrcoef æ˜¯ç›´æ¥æŠŠ logits æ”¾è¿›å»çš„ã€‚ python for step, batch in enumerate(tqdm(sts_dataloader, desc=f'eval', disable=TQDM_DISABLE)): logits = model.predict_similarity(b_ids1, b_mask1, b_ids2, b_mask2) y_hat = logits.flatten().cpu().numpy() b_labels = b_labels.flatten().cpu().numpy() sts_y_pred.extend(y_hat) sts_y_true.extend(b_labels) sts_sent_ids.extend(b_sent_ids) pearson_mat = np.corrcoef(sts_y_pred,sts_y_true) çš®å°”é€Šç›¸å…³ç³»æ•°åæ˜ çš„æ˜¯ä¸¤ä¸ªå˜é‡çš„çº¿æ€§ç›¸å…³å…³ç³»ï¼Œè·Ÿå€¼çš„ç»å¯¹èŒƒå›´æ²¡å…³ç³»ï¼Œåªè¦ä¸¤ä¸ªå˜é‡æ˜¯ä¸€ç»„ä¸€ç»„å¯¹åº”çš„ï¼Œå¹¶ä¸”æ˜¯è¿ç»­å‹çš„ï¼Œéƒ½å¯ä»¥ç›´æ¥ç®—ï¼Œä¹Ÿå°±æ˜¯è¯´==ä¸éœ€è¦å˜åŒ–åˆ° 0-5 åŒºé—´==ï¼Œsigmoid ä¼šé™ä½åŸå§‹ logit ä¸æ ‡ç­¾ä¹‹é—´çš„çº¿æ€§ç›¸å…³æ€§ã€‚ ç„¶è€Œæˆ‘ä»¬ç”¨å‡æ–¹å·®è®¡ç®— loss æ—¶å€™éœ€è¦ç”¨ sigmoid æŠŠå®ƒå˜åŒ–åˆ° 0-5 åŒºé—´ï¼Œä½¿å…¶è½åœ¨æ ‡ç­¾åˆ†æ•°åŒä¸€æ•°å€¼åŸŸã€‚ å®éªŒç»“æœ bert + final-layer-finetune éªŒè¯é›† æµ‹è¯•é›† Stanford Sentiment Treebank 0.400 0.395 Quora Dataset 0.650 0.644 SemEval STS Benchmark Dataset 0.237 0.212 æ”¹è¿› åœ¨è®­ç»ƒæœŸé—´ä¸ä»…ä»…å¯¹ä¸‰ä¸ªæ•°æ®é›†åˆ†åˆ«è¿›è¡Œè®­ç»ƒï¼Œè€Œæ˜¯è¿›è¡Œå…¨æ¨¡å‹å¾®è°ƒ å¦‚æœå…¨æ¨¡å‹å¾®è°ƒï¼Œä¸å¹³è¡¡æ•°æ®å¦‚ä½•å¤„ç†ï¼Ÿ å¯¹æ¯”å¹³å‡æ± åŒ–å’Œ CLS æ± åŒ–ï¼Œçœ‹çœ‹å“ªä¸ªæ•ˆæœæ›´å¥½ã€‚ æ€ä¹ˆå¤„ç† pair æ‹¼æ¥ï¼Œå•çº¯ concat åˆ°æœ€åä¸€ä¸ªç»´åº¦ï¼Œè¿˜æ˜¯æœ‰æ›´å¥½çš„åŠæ³•ï¼Ÿ cross-encoder åŠ ä¸Š para_type_id STS é€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ï¼Œè€Œä¸æ˜¯çº¿æ€§å˜æ¢æŠ•å½± ç”¨ 3 ä¸ªä»»åŠ¡çš„æ•°æ®é›†è¿›è¡Œ MLM é¢„è®­ç»ƒ autocast(enabled=args.use_amp)å’Œscaler.scale Gradient Surgery - PCGrad ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#åŸºå‡†"},{"categories":null,"content":" åŸºå‡† æƒ…æ„Ÿé¢„æµ‹æƒ…æ„Ÿé¢„æµ‹çš„ forward å’Œ train éƒ¨åˆ†ä»£ç å’Œ classifier.py ä¸€è‡´æ²¡æœ‰è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯å‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­ä» epoch 2 å¼€å§‹ loss ä¸å˜äº†ã€‚æ£€æŸ¥ä»£ç ä¹‹åå‘ç°é—®é¢˜å‡ºåœ¨ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.dropout(senti) senti = self.senti_classifier(senti) return self.senti_relu(senti) åŸå› åœ¨äºæˆ‘æŠŠæ¿€æ´»å‡½æ•° ReLU æ”¾åœ¨å‰å‘è®¡ç®—çš„æœ€åä¸€æ­¥äº†ï¼ŒReLU çš„å‡½æ•°è¡¨è¾¾å¼ä¸º $ReLU=max(0,x)$ï¼Œæ‰€ä»¥æ”¾åœ¨æœ€åä¸€æ­¥ä¼šå›ºå®šæŠŠè´Ÿæ•°å˜æˆ 0ï¼Œæ­£ç¡®çš„é¡ºåºåº”è¯¥æ˜¯ ==Linear â†’ ReLU â†’ Dropout â†’ â€¦ â†’ æœ€åä¸€å±‚ Linearâ†’ è¾“å‡º==ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.senti_relu(senti) senti = self.dropout(senti) return self.senti_classifier(senti) è½¬è¿°é¢„æµ‹è¿™ä¸ªä»»åŠ¡æ˜¯ç»™å®šä¸¤ä¸ªå¥å­ï¼Œåˆ¤æ–­æ˜¯å¦å«ä¹‰ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä¼šå¾—åˆ°ä¸¤ä¸ª inputï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å°†å®ƒç»„è£…åˆ°ä¸€èµ·å‘¢ï¼Ÿæˆ‘çš„ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯ç›´æ¥æ‹¼å‡‘ä¸º [batch_size, seq_len, hidden_size * 2]ï¼Œç„¶ååç»­åœ¨æŠŠä»–æŠ•å½±åˆ°ä½ç»´ç©ºé—´ã€‚ python def predict_paraphrase(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): para_1 = self.forward(input_ids_1, attention_mask_1) para_2 = self.forward(input_ids_2, attention_mask_2) para_combined = torch.cat([para_1, para_2], dim=1) para_combined = self.para_dense(para_combined) para_combined = self.dropout(para_combined) para_combined = self.relu(para_combined) return self.para_classifier(para_combined) äºŒåˆ†ç±»é—®é¢˜ï¼Œforward è¾“å‡ºçš„ logits å½¢çŠ¶ä¸º [B, 1], è¿˜éœ€è¦é€šè¿‡ sigmoid è½¬æ¢ä¸ºæ¦‚ç‡ã€‚è®¡ç®— loss æ—¶å€™ BCEWithLogitsLoss è‡ªå¸¦ sigmoid äº†ï¼Œä½†æ˜¯è®¡ç®— acc æ—¶å€™æ˜¯é€šè¿‡ torch.mean(pred\\==labels)ï¼Œæ‰€ä»¥éœ€è¦æå‰åŠ  sigmoidã€‚ ç›¸ä¼¼åº¦é¢„æµ‹ç¬¬ä¸‰ä¸ªä»»åŠ¡æ˜¯å¯¹ä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼åº¦è¿›è¡Œæ‰“åˆ†ï¼Œæ‰“åˆ†åŒºé—´åœ¨ 0-5ã€‚æˆ‘çš„åšæ³•æ˜¯å°†éšè—çŠ¶æ€æŠ•å½±åˆ°ä¸€ç»´ç©ºé—´ ï¼Œç„¶åå¯¹ logits å®ƒè¿›è¡Œ sigmoid å°±èƒ½å¾—åˆ° 0-1 åŒºé—´çš„æ¦‚ç‡ï¼Œå†ä¹˜ä¸Š 5 å°±èƒ½å¾—åˆ° 0-5 çš„ç›¸ä¼¼åˆ†æ•°äº†ã€‚ python def predict_similarity(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): simi_1 = self.forward(input_ids_1, attention_mask_1) simi_2 = self.forward(input_ids_2, attention_mask_2) simi_combined = torch.cat([simi_1, simi_2], dim=1) simi_combined = self.sts_dense(simi_combined) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹æ®æ³¨é‡Š - è¿™ä¸ªå‡½æ•°éœ€è¦è¿”å›çš„æ˜¯ logitsï¼Œè€Œä¸éœ€è¦å¯¹å®ƒè¿›è¡Œå¤„ç†ã€‚è§‚å¯Ÿ evalution.py æ–‡ä»¶ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè®¡ç®— np.corrcoef æ˜¯ç›´æ¥æŠŠ logits æ”¾è¿›å»çš„ã€‚ python for step, batch in enumerate(tqdm(sts_dataloader, desc=f'eval', disable=TQDM_DISABLE)): logits = model.predict_similarity(b_ids1, b_mask1, b_ids2, b_mask2) y_hat = logits.flatten().cpu().numpy() b_labels = b_labels.flatten().cpu().numpy() sts_y_pred.extend(y_hat) sts_y_true.extend(b_labels) sts_sent_ids.extend(b_sent_ids) pearson_mat = np.corrcoef(sts_y_pred,sts_y_true) çš®å°”é€Šç›¸å…³ç³»æ•°åæ˜ çš„æ˜¯ä¸¤ä¸ªå˜é‡çš„çº¿æ€§ç›¸å…³å…³ç³»ï¼Œè·Ÿå€¼çš„ç»å¯¹èŒƒå›´æ²¡å…³ç³»ï¼Œåªè¦ä¸¤ä¸ªå˜é‡æ˜¯ä¸€ç»„ä¸€ç»„å¯¹åº”çš„ï¼Œå¹¶ä¸”æ˜¯è¿ç»­å‹çš„ï¼Œéƒ½å¯ä»¥ç›´æ¥ç®—ï¼Œä¹Ÿå°±æ˜¯è¯´==ä¸éœ€è¦å˜åŒ–åˆ° 0-5 åŒºé—´==ï¼Œsigmoid ä¼šé™ä½åŸå§‹ logit ä¸æ ‡ç­¾ä¹‹é—´çš„çº¿æ€§ç›¸å…³æ€§ã€‚ ç„¶è€Œæˆ‘ä»¬ç”¨å‡æ–¹å·®è®¡ç®— loss æ—¶å€™éœ€è¦ç”¨ sigmoid æŠŠå®ƒå˜åŒ–åˆ° 0-5 åŒºé—´ï¼Œä½¿å…¶è½åœ¨æ ‡ç­¾åˆ†æ•°åŒä¸€æ•°å€¼åŸŸã€‚ å®éªŒç»“æœ bert + final-layer-finetune éªŒè¯é›† æµ‹è¯•é›† Stanford Sentiment Treebank 0.400 0.395 Quora Dataset 0.650 0.644 SemEval STS Benchmark Dataset 0.237 0.212 æ”¹è¿› åœ¨è®­ç»ƒæœŸé—´ä¸ä»…ä»…å¯¹ä¸‰ä¸ªæ•°æ®é›†åˆ†åˆ«è¿›è¡Œè®­ç»ƒï¼Œè€Œæ˜¯è¿›è¡Œå…¨æ¨¡å‹å¾®è°ƒ å¦‚æœå…¨æ¨¡å‹å¾®è°ƒï¼Œä¸å¹³è¡¡æ•°æ®å¦‚ä½•å¤„ç†ï¼Ÿ å¯¹æ¯”å¹³å‡æ± åŒ–å’Œ CLS æ± åŒ–ï¼Œçœ‹çœ‹å“ªä¸ªæ•ˆæœæ›´å¥½ã€‚ æ€ä¹ˆå¤„ç† pair æ‹¼æ¥ï¼Œå•çº¯ concat åˆ°æœ€åä¸€ä¸ªç»´åº¦ï¼Œè¿˜æ˜¯æœ‰æ›´å¥½çš„åŠæ³•ï¼Ÿ cross-encoder åŠ ä¸Š para_type_id STS é€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ï¼Œè€Œä¸æ˜¯çº¿æ€§å˜æ¢æŠ•å½± ç”¨ 3 ä¸ªä»»åŠ¡çš„æ•°æ®é›†è¿›è¡Œ MLM é¢„è®­ç»ƒ autocast(enabled=args.use_amp)å’Œscaler.scale Gradient Surgery - PCGrad ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#æƒ…æ„Ÿé¢„æµ‹"},{"categories":null,"content":" åŸºå‡† æƒ…æ„Ÿé¢„æµ‹æƒ…æ„Ÿé¢„æµ‹çš„ forward å’Œ train éƒ¨åˆ†ä»£ç å’Œ classifier.py ä¸€è‡´æ²¡æœ‰è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯å‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­ä» epoch 2 å¼€å§‹ loss ä¸å˜äº†ã€‚æ£€æŸ¥ä»£ç ä¹‹åå‘ç°é—®é¢˜å‡ºåœ¨ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.dropout(senti) senti = self.senti_classifier(senti) return self.senti_relu(senti) åŸå› åœ¨äºæˆ‘æŠŠæ¿€æ´»å‡½æ•° ReLU æ”¾åœ¨å‰å‘è®¡ç®—çš„æœ€åä¸€æ­¥äº†ï¼ŒReLU çš„å‡½æ•°è¡¨è¾¾å¼ä¸º $ReLU=max(0,x)$ï¼Œæ‰€ä»¥æ”¾åœ¨æœ€åä¸€æ­¥ä¼šå›ºå®šæŠŠè´Ÿæ•°å˜æˆ 0ï¼Œæ­£ç¡®çš„é¡ºåºåº”è¯¥æ˜¯ ==Linear â†’ ReLU â†’ Dropout â†’ â€¦ â†’ æœ€åä¸€å±‚ Linearâ†’ è¾“å‡º==ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.senti_relu(senti) senti = self.dropout(senti) return self.senti_classifier(senti) è½¬è¿°é¢„æµ‹è¿™ä¸ªä»»åŠ¡æ˜¯ç»™å®šä¸¤ä¸ªå¥å­ï¼Œåˆ¤æ–­æ˜¯å¦å«ä¹‰ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä¼šå¾—åˆ°ä¸¤ä¸ª inputï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å°†å®ƒç»„è£…åˆ°ä¸€èµ·å‘¢ï¼Ÿæˆ‘çš„ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯ç›´æ¥æ‹¼å‡‘ä¸º [batch_size, seq_len, hidden_size * 2]ï¼Œç„¶ååç»­åœ¨æŠŠä»–æŠ•å½±åˆ°ä½ç»´ç©ºé—´ã€‚ python def predict_paraphrase(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): para_1 = self.forward(input_ids_1, attention_mask_1) para_2 = self.forward(input_ids_2, attention_mask_2) para_combined = torch.cat([para_1, para_2], dim=1) para_combined = self.para_dense(para_combined) para_combined = self.dropout(para_combined) para_combined = self.relu(para_combined) return self.para_classifier(para_combined) äºŒåˆ†ç±»é—®é¢˜ï¼Œforward è¾“å‡ºçš„ logits å½¢çŠ¶ä¸º [B, 1], è¿˜éœ€è¦é€šè¿‡ sigmoid è½¬æ¢ä¸ºæ¦‚ç‡ã€‚è®¡ç®— loss æ—¶å€™ BCEWithLogitsLoss è‡ªå¸¦ sigmoid äº†ï¼Œä½†æ˜¯è®¡ç®— acc æ—¶å€™æ˜¯é€šè¿‡ torch.mean(pred\\==labels)ï¼Œæ‰€ä»¥éœ€è¦æå‰åŠ  sigmoidã€‚ ç›¸ä¼¼åº¦é¢„æµ‹ç¬¬ä¸‰ä¸ªä»»åŠ¡æ˜¯å¯¹ä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼åº¦è¿›è¡Œæ‰“åˆ†ï¼Œæ‰“åˆ†åŒºé—´åœ¨ 0-5ã€‚æˆ‘çš„åšæ³•æ˜¯å°†éšè—çŠ¶æ€æŠ•å½±åˆ°ä¸€ç»´ç©ºé—´ ï¼Œç„¶åå¯¹ logits å®ƒè¿›è¡Œ sigmoid å°±èƒ½å¾—åˆ° 0-1 åŒºé—´çš„æ¦‚ç‡ï¼Œå†ä¹˜ä¸Š 5 å°±èƒ½å¾—åˆ° 0-5 çš„ç›¸ä¼¼åˆ†æ•°äº†ã€‚ python def predict_similarity(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): simi_1 = self.forward(input_ids_1, attention_mask_1) simi_2 = self.forward(input_ids_2, attention_mask_2) simi_combined = torch.cat([simi_1, simi_2], dim=1) simi_combined = self.sts_dense(simi_combined) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹æ®æ³¨é‡Š - è¿™ä¸ªå‡½æ•°éœ€è¦è¿”å›çš„æ˜¯ logitsï¼Œè€Œä¸éœ€è¦å¯¹å®ƒè¿›è¡Œå¤„ç†ã€‚è§‚å¯Ÿ evalution.py æ–‡ä»¶ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè®¡ç®— np.corrcoef æ˜¯ç›´æ¥æŠŠ logits æ”¾è¿›å»çš„ã€‚ python for step, batch in enumerate(tqdm(sts_dataloader, desc=f'eval', disable=TQDM_DISABLE)): logits = model.predict_similarity(b_ids1, b_mask1, b_ids2, b_mask2) y_hat = logits.flatten().cpu().numpy() b_labels = b_labels.flatten().cpu().numpy() sts_y_pred.extend(y_hat) sts_y_true.extend(b_labels) sts_sent_ids.extend(b_sent_ids) pearson_mat = np.corrcoef(sts_y_pred,sts_y_true) çš®å°”é€Šç›¸å…³ç³»æ•°åæ˜ çš„æ˜¯ä¸¤ä¸ªå˜é‡çš„çº¿æ€§ç›¸å…³å…³ç³»ï¼Œè·Ÿå€¼çš„ç»å¯¹èŒƒå›´æ²¡å…³ç³»ï¼Œåªè¦ä¸¤ä¸ªå˜é‡æ˜¯ä¸€ç»„ä¸€ç»„å¯¹åº”çš„ï¼Œå¹¶ä¸”æ˜¯è¿ç»­å‹çš„ï¼Œéƒ½å¯ä»¥ç›´æ¥ç®—ï¼Œä¹Ÿå°±æ˜¯è¯´==ä¸éœ€è¦å˜åŒ–åˆ° 0-5 åŒºé—´==ï¼Œsigmoid ä¼šé™ä½åŸå§‹ logit ä¸æ ‡ç­¾ä¹‹é—´çš„çº¿æ€§ç›¸å…³æ€§ã€‚ ç„¶è€Œæˆ‘ä»¬ç”¨å‡æ–¹å·®è®¡ç®— loss æ—¶å€™éœ€è¦ç”¨ sigmoid æŠŠå®ƒå˜åŒ–åˆ° 0-5 åŒºé—´ï¼Œä½¿å…¶è½åœ¨æ ‡ç­¾åˆ†æ•°åŒä¸€æ•°å€¼åŸŸã€‚ å®éªŒç»“æœ bert + final-layer-finetune éªŒè¯é›† æµ‹è¯•é›† Stanford Sentiment Treebank 0.400 0.395 Quora Dataset 0.650 0.644 SemEval STS Benchmark Dataset 0.237 0.212 æ”¹è¿› åœ¨è®­ç»ƒæœŸé—´ä¸ä»…ä»…å¯¹ä¸‰ä¸ªæ•°æ®é›†åˆ†åˆ«è¿›è¡Œè®­ç»ƒï¼Œè€Œæ˜¯è¿›è¡Œå…¨æ¨¡å‹å¾®è°ƒ å¦‚æœå…¨æ¨¡å‹å¾®è°ƒï¼Œä¸å¹³è¡¡æ•°æ®å¦‚ä½•å¤„ç†ï¼Ÿ å¯¹æ¯”å¹³å‡æ± åŒ–å’Œ CLS æ± åŒ–ï¼Œçœ‹çœ‹å“ªä¸ªæ•ˆæœæ›´å¥½ã€‚ æ€ä¹ˆå¤„ç† pair æ‹¼æ¥ï¼Œå•çº¯ concat åˆ°æœ€åä¸€ä¸ªç»´åº¦ï¼Œè¿˜æ˜¯æœ‰æ›´å¥½çš„åŠæ³•ï¼Ÿ cross-encoder åŠ ä¸Š para_type_id STS é€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ï¼Œè€Œä¸æ˜¯çº¿æ€§å˜æ¢æŠ•å½± ç”¨ 3 ä¸ªä»»åŠ¡çš„æ•°æ®é›†è¿›è¡Œ MLM é¢„è®­ç»ƒ autocast(enabled=args.use_amp)å’Œscaler.scale Gradient Surgery - PCGrad ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#è½¬è¿°é¢„æµ‹"},{"categories":null,"content":" åŸºå‡† æƒ…æ„Ÿé¢„æµ‹æƒ…æ„Ÿé¢„æµ‹çš„ forward å’Œ train éƒ¨åˆ†ä»£ç å’Œ classifier.py ä¸€è‡´æ²¡æœ‰è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯å‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­ä» epoch 2 å¼€å§‹ loss ä¸å˜äº†ã€‚æ£€æŸ¥ä»£ç ä¹‹åå‘ç°é—®é¢˜å‡ºåœ¨ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.dropout(senti) senti = self.senti_classifier(senti) return self.senti_relu(senti) åŸå› åœ¨äºæˆ‘æŠŠæ¿€æ´»å‡½æ•° ReLU æ”¾åœ¨å‰å‘è®¡ç®—çš„æœ€åä¸€æ­¥äº†ï¼ŒReLU çš„å‡½æ•°è¡¨è¾¾å¼ä¸º $ReLU=max(0,x)$ï¼Œæ‰€ä»¥æ”¾åœ¨æœ€åä¸€æ­¥ä¼šå›ºå®šæŠŠè´Ÿæ•°å˜æˆ 0ï¼Œæ­£ç¡®çš„é¡ºåºåº”è¯¥æ˜¯ ==Linear â†’ ReLU â†’ Dropout â†’ â€¦ â†’ æœ€åä¸€å±‚ Linearâ†’ è¾“å‡º==ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.senti_relu(senti) senti = self.dropout(senti) return self.senti_classifier(senti) è½¬è¿°é¢„æµ‹è¿™ä¸ªä»»åŠ¡æ˜¯ç»™å®šä¸¤ä¸ªå¥å­ï¼Œåˆ¤æ–­æ˜¯å¦å«ä¹‰ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä¼šå¾—åˆ°ä¸¤ä¸ª inputï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å°†å®ƒç»„è£…åˆ°ä¸€èµ·å‘¢ï¼Ÿæˆ‘çš„ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯ç›´æ¥æ‹¼å‡‘ä¸º [batch_size, seq_len, hidden_size * 2]ï¼Œç„¶ååç»­åœ¨æŠŠä»–æŠ•å½±åˆ°ä½ç»´ç©ºé—´ã€‚ python def predict_paraphrase(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): para_1 = self.forward(input_ids_1, attention_mask_1) para_2 = self.forward(input_ids_2, attention_mask_2) para_combined = torch.cat([para_1, para_2], dim=1) para_combined = self.para_dense(para_combined) para_combined = self.dropout(para_combined) para_combined = self.relu(para_combined) return self.para_classifier(para_combined) äºŒåˆ†ç±»é—®é¢˜ï¼Œforward è¾“å‡ºçš„ logits å½¢çŠ¶ä¸º [B, 1], è¿˜éœ€è¦é€šè¿‡ sigmoid è½¬æ¢ä¸ºæ¦‚ç‡ã€‚è®¡ç®— loss æ—¶å€™ BCEWithLogitsLoss è‡ªå¸¦ sigmoid äº†ï¼Œä½†æ˜¯è®¡ç®— acc æ—¶å€™æ˜¯é€šè¿‡ torch.mean(pred\\==labels)ï¼Œæ‰€ä»¥éœ€è¦æå‰åŠ  sigmoidã€‚ ç›¸ä¼¼åº¦é¢„æµ‹ç¬¬ä¸‰ä¸ªä»»åŠ¡æ˜¯å¯¹ä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼åº¦è¿›è¡Œæ‰“åˆ†ï¼Œæ‰“åˆ†åŒºé—´åœ¨ 0-5ã€‚æˆ‘çš„åšæ³•æ˜¯å°†éšè—çŠ¶æ€æŠ•å½±åˆ°ä¸€ç»´ç©ºé—´ ï¼Œç„¶åå¯¹ logits å®ƒè¿›è¡Œ sigmoid å°±èƒ½å¾—åˆ° 0-1 åŒºé—´çš„æ¦‚ç‡ï¼Œå†ä¹˜ä¸Š 5 å°±èƒ½å¾—åˆ° 0-5 çš„ç›¸ä¼¼åˆ†æ•°äº†ã€‚ python def predict_similarity(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): simi_1 = self.forward(input_ids_1, attention_mask_1) simi_2 = self.forward(input_ids_2, attention_mask_2) simi_combined = torch.cat([simi_1, simi_2], dim=1) simi_combined = self.sts_dense(simi_combined) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹æ®æ³¨é‡Š - è¿™ä¸ªå‡½æ•°éœ€è¦è¿”å›çš„æ˜¯ logitsï¼Œè€Œä¸éœ€è¦å¯¹å®ƒè¿›è¡Œå¤„ç†ã€‚è§‚å¯Ÿ evalution.py æ–‡ä»¶ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè®¡ç®— np.corrcoef æ˜¯ç›´æ¥æŠŠ logits æ”¾è¿›å»çš„ã€‚ python for step, batch in enumerate(tqdm(sts_dataloader, desc=f'eval', disable=TQDM_DISABLE)): logits = model.predict_similarity(b_ids1, b_mask1, b_ids2, b_mask2) y_hat = logits.flatten().cpu().numpy() b_labels = b_labels.flatten().cpu().numpy() sts_y_pred.extend(y_hat) sts_y_true.extend(b_labels) sts_sent_ids.extend(b_sent_ids) pearson_mat = np.corrcoef(sts_y_pred,sts_y_true) çš®å°”é€Šç›¸å…³ç³»æ•°åæ˜ çš„æ˜¯ä¸¤ä¸ªå˜é‡çš„çº¿æ€§ç›¸å…³å…³ç³»ï¼Œè·Ÿå€¼çš„ç»å¯¹èŒƒå›´æ²¡å…³ç³»ï¼Œåªè¦ä¸¤ä¸ªå˜é‡æ˜¯ä¸€ç»„ä¸€ç»„å¯¹åº”çš„ï¼Œå¹¶ä¸”æ˜¯è¿ç»­å‹çš„ï¼Œéƒ½å¯ä»¥ç›´æ¥ç®—ï¼Œä¹Ÿå°±æ˜¯è¯´==ä¸éœ€è¦å˜åŒ–åˆ° 0-5 åŒºé—´==ï¼Œsigmoid ä¼šé™ä½åŸå§‹ logit ä¸æ ‡ç­¾ä¹‹é—´çš„çº¿æ€§ç›¸å…³æ€§ã€‚ ç„¶è€Œæˆ‘ä»¬ç”¨å‡æ–¹å·®è®¡ç®— loss æ—¶å€™éœ€è¦ç”¨ sigmoid æŠŠå®ƒå˜åŒ–åˆ° 0-5 åŒºé—´ï¼Œä½¿å…¶è½åœ¨æ ‡ç­¾åˆ†æ•°åŒä¸€æ•°å€¼åŸŸã€‚ å®éªŒç»“æœ bert + final-layer-finetune éªŒè¯é›† æµ‹è¯•é›† Stanford Sentiment Treebank 0.400 0.395 Quora Dataset 0.650 0.644 SemEval STS Benchmark Dataset 0.237 0.212 æ”¹è¿› åœ¨è®­ç»ƒæœŸé—´ä¸ä»…ä»…å¯¹ä¸‰ä¸ªæ•°æ®é›†åˆ†åˆ«è¿›è¡Œè®­ç»ƒï¼Œè€Œæ˜¯è¿›è¡Œå…¨æ¨¡å‹å¾®è°ƒ å¦‚æœå…¨æ¨¡å‹å¾®è°ƒï¼Œä¸å¹³è¡¡æ•°æ®å¦‚ä½•å¤„ç†ï¼Ÿ å¯¹æ¯”å¹³å‡æ± åŒ–å’Œ CLS æ± åŒ–ï¼Œçœ‹çœ‹å“ªä¸ªæ•ˆæœæ›´å¥½ã€‚ æ€ä¹ˆå¤„ç† pair æ‹¼æ¥ï¼Œå•çº¯ concat åˆ°æœ€åä¸€ä¸ªç»´åº¦ï¼Œè¿˜æ˜¯æœ‰æ›´å¥½çš„åŠæ³•ï¼Ÿ cross-encoder åŠ ä¸Š para_type_id STS é€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ï¼Œè€Œä¸æ˜¯çº¿æ€§å˜æ¢æŠ•å½± ç”¨ 3 ä¸ªä»»åŠ¡çš„æ•°æ®é›†è¿›è¡Œ MLM é¢„è®­ç»ƒ autocast(enabled=args.use_amp)å’Œscaler.scale Gradient Surgery - PCGrad ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#ç›¸ä¼¼åº¦é¢„æµ‹"},{"categories":null,"content":" åŸºå‡† æƒ…æ„Ÿé¢„æµ‹æƒ…æ„Ÿé¢„æµ‹çš„ forward å’Œ train éƒ¨åˆ†ä»£ç å’Œ classifier.py ä¸€è‡´æ²¡æœ‰è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯å‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­ä» epoch 2 å¼€å§‹ loss ä¸å˜äº†ã€‚æ£€æŸ¥ä»£ç ä¹‹åå‘ç°é—®é¢˜å‡ºåœ¨ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.dropout(senti) senti = self.senti_classifier(senti) return self.senti_relu(senti) åŸå› åœ¨äºæˆ‘æŠŠæ¿€æ´»å‡½æ•° ReLU æ”¾åœ¨å‰å‘è®¡ç®—çš„æœ€åä¸€æ­¥äº†ï¼ŒReLU çš„å‡½æ•°è¡¨è¾¾å¼ä¸º $ReLU=max(0,x)$ï¼Œæ‰€ä»¥æ”¾åœ¨æœ€åä¸€æ­¥ä¼šå›ºå®šæŠŠè´Ÿæ•°å˜æˆ 0ï¼Œæ­£ç¡®çš„é¡ºåºåº”è¯¥æ˜¯ ==Linear â†’ ReLU â†’ Dropout â†’ â€¦ â†’ æœ€åä¸€å±‚ Linearâ†’ è¾“å‡º==ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.senti_relu(senti) senti = self.dropout(senti) return self.senti_classifier(senti) è½¬è¿°é¢„æµ‹è¿™ä¸ªä»»åŠ¡æ˜¯ç»™å®šä¸¤ä¸ªå¥å­ï¼Œåˆ¤æ–­æ˜¯å¦å«ä¹‰ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä¼šå¾—åˆ°ä¸¤ä¸ª inputï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å°†å®ƒç»„è£…åˆ°ä¸€èµ·å‘¢ï¼Ÿæˆ‘çš„ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯ç›´æ¥æ‹¼å‡‘ä¸º [batch_size, seq_len, hidden_size * 2]ï¼Œç„¶ååç»­åœ¨æŠŠä»–æŠ•å½±åˆ°ä½ç»´ç©ºé—´ã€‚ python def predict_paraphrase(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): para_1 = self.forward(input_ids_1, attention_mask_1) para_2 = self.forward(input_ids_2, attention_mask_2) para_combined = torch.cat([para_1, para_2], dim=1) para_combined = self.para_dense(para_combined) para_combined = self.dropout(para_combined) para_combined = self.relu(para_combined) return self.para_classifier(para_combined) äºŒåˆ†ç±»é—®é¢˜ï¼Œforward è¾“å‡ºçš„ logits å½¢çŠ¶ä¸º [B, 1], è¿˜éœ€è¦é€šè¿‡ sigmoid è½¬æ¢ä¸ºæ¦‚ç‡ã€‚è®¡ç®— loss æ—¶å€™ BCEWithLogitsLoss è‡ªå¸¦ sigmoid äº†ï¼Œä½†æ˜¯è®¡ç®— acc æ—¶å€™æ˜¯é€šè¿‡ torch.mean(pred\\==labels)ï¼Œæ‰€ä»¥éœ€è¦æå‰åŠ  sigmoidã€‚ ç›¸ä¼¼åº¦é¢„æµ‹ç¬¬ä¸‰ä¸ªä»»åŠ¡æ˜¯å¯¹ä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼åº¦è¿›è¡Œæ‰“åˆ†ï¼Œæ‰“åˆ†åŒºé—´åœ¨ 0-5ã€‚æˆ‘çš„åšæ³•æ˜¯å°†éšè—çŠ¶æ€æŠ•å½±åˆ°ä¸€ç»´ç©ºé—´ ï¼Œç„¶åå¯¹ logits å®ƒè¿›è¡Œ sigmoid å°±èƒ½å¾—åˆ° 0-1 åŒºé—´çš„æ¦‚ç‡ï¼Œå†ä¹˜ä¸Š 5 å°±èƒ½å¾—åˆ° 0-5 çš„ç›¸ä¼¼åˆ†æ•°äº†ã€‚ python def predict_similarity(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): simi_1 = self.forward(input_ids_1, attention_mask_1) simi_2 = self.forward(input_ids_2, attention_mask_2) simi_combined = torch.cat([simi_1, simi_2], dim=1) simi_combined = self.sts_dense(simi_combined) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹æ®æ³¨é‡Š - è¿™ä¸ªå‡½æ•°éœ€è¦è¿”å›çš„æ˜¯ logitsï¼Œè€Œä¸éœ€è¦å¯¹å®ƒè¿›è¡Œå¤„ç†ã€‚è§‚å¯Ÿ evalution.py æ–‡ä»¶ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè®¡ç®— np.corrcoef æ˜¯ç›´æ¥æŠŠ logits æ”¾è¿›å»çš„ã€‚ python for step, batch in enumerate(tqdm(sts_dataloader, desc=f'eval', disable=TQDM_DISABLE)): logits = model.predict_similarity(b_ids1, b_mask1, b_ids2, b_mask2) y_hat = logits.flatten().cpu().numpy() b_labels = b_labels.flatten().cpu().numpy() sts_y_pred.extend(y_hat) sts_y_true.extend(b_labels) sts_sent_ids.extend(b_sent_ids) pearson_mat = np.corrcoef(sts_y_pred,sts_y_true) çš®å°”é€Šç›¸å…³ç³»æ•°åæ˜ çš„æ˜¯ä¸¤ä¸ªå˜é‡çš„çº¿æ€§ç›¸å…³å…³ç³»ï¼Œè·Ÿå€¼çš„ç»å¯¹èŒƒå›´æ²¡å…³ç³»ï¼Œåªè¦ä¸¤ä¸ªå˜é‡æ˜¯ä¸€ç»„ä¸€ç»„å¯¹åº”çš„ï¼Œå¹¶ä¸”æ˜¯è¿ç»­å‹çš„ï¼Œéƒ½å¯ä»¥ç›´æ¥ç®—ï¼Œä¹Ÿå°±æ˜¯è¯´==ä¸éœ€è¦å˜åŒ–åˆ° 0-5 åŒºé—´==ï¼Œsigmoid ä¼šé™ä½åŸå§‹ logit ä¸æ ‡ç­¾ä¹‹é—´çš„çº¿æ€§ç›¸å…³æ€§ã€‚ ç„¶è€Œæˆ‘ä»¬ç”¨å‡æ–¹å·®è®¡ç®— loss æ—¶å€™éœ€è¦ç”¨ sigmoid æŠŠå®ƒå˜åŒ–åˆ° 0-5 åŒºé—´ï¼Œä½¿å…¶è½åœ¨æ ‡ç­¾åˆ†æ•°åŒä¸€æ•°å€¼åŸŸã€‚ å®éªŒç»“æœ bert + final-layer-finetune éªŒè¯é›† æµ‹è¯•é›† Stanford Sentiment Treebank 0.400 0.395 Quora Dataset 0.650 0.644 SemEval STS Benchmark Dataset 0.237 0.212 æ”¹è¿› åœ¨è®­ç»ƒæœŸé—´ä¸ä»…ä»…å¯¹ä¸‰ä¸ªæ•°æ®é›†åˆ†åˆ«è¿›è¡Œè®­ç»ƒï¼Œè€Œæ˜¯è¿›è¡Œå…¨æ¨¡å‹å¾®è°ƒ å¦‚æœå…¨æ¨¡å‹å¾®è°ƒï¼Œä¸å¹³è¡¡æ•°æ®å¦‚ä½•å¤„ç†ï¼Ÿ å¯¹æ¯”å¹³å‡æ± åŒ–å’Œ CLS æ± åŒ–ï¼Œçœ‹çœ‹å“ªä¸ªæ•ˆæœæ›´å¥½ã€‚ æ€ä¹ˆå¤„ç† pair æ‹¼æ¥ï¼Œå•çº¯ concat åˆ°æœ€åä¸€ä¸ªç»´åº¦ï¼Œè¿˜æ˜¯æœ‰æ›´å¥½çš„åŠæ³•ï¼Ÿ cross-encoder åŠ ä¸Š para_type_id STS é€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ï¼Œè€Œä¸æ˜¯çº¿æ€§å˜æ¢æŠ•å½± ç”¨ 3 ä¸ªä»»åŠ¡çš„æ•°æ®é›†è¿›è¡Œ MLM é¢„è®­ç»ƒ autocast(enabled=args.use_amp)å’Œscaler.scale Gradient Surgery - PCGrad ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#å®éªŒç»“æœ"},{"categories":null,"content":" åŸºå‡† æƒ…æ„Ÿé¢„æµ‹æƒ…æ„Ÿé¢„æµ‹çš„ forward å’Œ train éƒ¨åˆ†ä»£ç å’Œ classifier.py ä¸€è‡´æ²¡æœ‰è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯å‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­ä» epoch 2 å¼€å§‹ loss ä¸å˜äº†ã€‚æ£€æŸ¥ä»£ç ä¹‹åå‘ç°é—®é¢˜å‡ºåœ¨ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.dropout(senti) senti = self.senti_classifier(senti) return self.senti_relu(senti) åŸå› åœ¨äºæˆ‘æŠŠæ¿€æ´»å‡½æ•° ReLU æ”¾åœ¨å‰å‘è®¡ç®—çš„æœ€åä¸€æ­¥äº†ï¼ŒReLU çš„å‡½æ•°è¡¨è¾¾å¼ä¸º $ReLU=max(0,x)$ï¼Œæ‰€ä»¥æ”¾åœ¨æœ€åä¸€æ­¥ä¼šå›ºå®šæŠŠè´Ÿæ•°å˜æˆ 0ï¼Œæ­£ç¡®çš„é¡ºåºåº”è¯¥æ˜¯ ==Linear â†’ ReLU â†’ Dropout â†’ â€¦ â†’ æœ€åä¸€å±‚ Linearâ†’ è¾“å‡º==ï¼š python def predict_sentiment(self, input_ids, attention_mask): bert_hidden_state = self.forward(input_ids, attention_mask) senti = self.senti_dense(bert_hidden_state) senti = self.senti_relu(senti) senti = self.dropout(senti) return self.senti_classifier(senti) è½¬è¿°é¢„æµ‹è¿™ä¸ªä»»åŠ¡æ˜¯ç»™å®šä¸¤ä¸ªå¥å­ï¼Œåˆ¤æ–­æ˜¯å¦å«ä¹‰ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä¼šå¾—åˆ°ä¸¤ä¸ª inputï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å°†å®ƒç»„è£…åˆ°ä¸€èµ·å‘¢ï¼Ÿæˆ‘çš„ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯ç›´æ¥æ‹¼å‡‘ä¸º [batch_size, seq_len, hidden_size * 2]ï¼Œç„¶ååç»­åœ¨æŠŠä»–æŠ•å½±åˆ°ä½ç»´ç©ºé—´ã€‚ python def predict_paraphrase(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): para_1 = self.forward(input_ids_1, attention_mask_1) para_2 = self.forward(input_ids_2, attention_mask_2) para_combined = torch.cat([para_1, para_2], dim=1) para_combined = self.para_dense(para_combined) para_combined = self.dropout(para_combined) para_combined = self.relu(para_combined) return self.para_classifier(para_combined) äºŒåˆ†ç±»é—®é¢˜ï¼Œforward è¾“å‡ºçš„ logits å½¢çŠ¶ä¸º [B, 1], è¿˜éœ€è¦é€šè¿‡ sigmoid è½¬æ¢ä¸ºæ¦‚ç‡ã€‚è®¡ç®— loss æ—¶å€™ BCEWithLogitsLoss è‡ªå¸¦ sigmoid äº†ï¼Œä½†æ˜¯è®¡ç®— acc æ—¶å€™æ˜¯é€šè¿‡ torch.mean(pred\\==labels)ï¼Œæ‰€ä»¥éœ€è¦æå‰åŠ  sigmoidã€‚ ç›¸ä¼¼åº¦é¢„æµ‹ç¬¬ä¸‰ä¸ªä»»åŠ¡æ˜¯å¯¹ä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼åº¦è¿›è¡Œæ‰“åˆ†ï¼Œæ‰“åˆ†åŒºé—´åœ¨ 0-5ã€‚æˆ‘çš„åšæ³•æ˜¯å°†éšè—çŠ¶æ€æŠ•å½±åˆ°ä¸€ç»´ç©ºé—´ ï¼Œç„¶åå¯¹ logits å®ƒè¿›è¡Œ sigmoid å°±èƒ½å¾—åˆ° 0-1 åŒºé—´çš„æ¦‚ç‡ï¼Œå†ä¹˜ä¸Š 5 å°±èƒ½å¾—åˆ° 0-5 çš„ç›¸ä¼¼åˆ†æ•°äº†ã€‚ python def predict_similarity(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): simi_1 = self.forward(input_ids_1, attention_mask_1) simi_2 = self.forward(input_ids_2, attention_mask_2) simi_combined = torch.cat([simi_1, simi_2], dim=1) simi_combined = self.sts_dense(simi_combined) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹æ®æ³¨é‡Š - è¿™ä¸ªå‡½æ•°éœ€è¦è¿”å›çš„æ˜¯ logitsï¼Œè€Œä¸éœ€è¦å¯¹å®ƒè¿›è¡Œå¤„ç†ã€‚è§‚å¯Ÿ evalution.py æ–‡ä»¶ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè®¡ç®— np.corrcoef æ˜¯ç›´æ¥æŠŠ logits æ”¾è¿›å»çš„ã€‚ python for step, batch in enumerate(tqdm(sts_dataloader, desc=f'eval', disable=TQDM_DISABLE)): logits = model.predict_similarity(b_ids1, b_mask1, b_ids2, b_mask2) y_hat = logits.flatten().cpu().numpy() b_labels = b_labels.flatten().cpu().numpy() sts_y_pred.extend(y_hat) sts_y_true.extend(b_labels) sts_sent_ids.extend(b_sent_ids) pearson_mat = np.corrcoef(sts_y_pred,sts_y_true) çš®å°”é€Šç›¸å…³ç³»æ•°åæ˜ çš„æ˜¯ä¸¤ä¸ªå˜é‡çš„çº¿æ€§ç›¸å…³å…³ç³»ï¼Œè·Ÿå€¼çš„ç»å¯¹èŒƒå›´æ²¡å…³ç³»ï¼Œåªè¦ä¸¤ä¸ªå˜é‡æ˜¯ä¸€ç»„ä¸€ç»„å¯¹åº”çš„ï¼Œå¹¶ä¸”æ˜¯è¿ç»­å‹çš„ï¼Œéƒ½å¯ä»¥ç›´æ¥ç®—ï¼Œä¹Ÿå°±æ˜¯è¯´==ä¸éœ€è¦å˜åŒ–åˆ° 0-5 åŒºé—´==ï¼Œsigmoid ä¼šé™ä½åŸå§‹ logit ä¸æ ‡ç­¾ä¹‹é—´çš„çº¿æ€§ç›¸å…³æ€§ã€‚ ç„¶è€Œæˆ‘ä»¬ç”¨å‡æ–¹å·®è®¡ç®— loss æ—¶å€™éœ€è¦ç”¨ sigmoid æŠŠå®ƒå˜åŒ–åˆ° 0-5 åŒºé—´ï¼Œä½¿å…¶è½åœ¨æ ‡ç­¾åˆ†æ•°åŒä¸€æ•°å€¼åŸŸã€‚ å®éªŒç»“æœ bert + final-layer-finetune éªŒè¯é›† æµ‹è¯•é›† Stanford Sentiment Treebank 0.400 0.395 Quora Dataset 0.650 0.644 SemEval STS Benchmark Dataset 0.237 0.212 æ”¹è¿› åœ¨è®­ç»ƒæœŸé—´ä¸ä»…ä»…å¯¹ä¸‰ä¸ªæ•°æ®é›†åˆ†åˆ«è¿›è¡Œè®­ç»ƒï¼Œè€Œæ˜¯è¿›è¡Œå…¨æ¨¡å‹å¾®è°ƒ å¦‚æœå…¨æ¨¡å‹å¾®è°ƒï¼Œä¸å¹³è¡¡æ•°æ®å¦‚ä½•å¤„ç†ï¼Ÿ å¯¹æ¯”å¹³å‡æ± åŒ–å’Œ CLS æ± åŒ–ï¼Œçœ‹çœ‹å“ªä¸ªæ•ˆæœæ›´å¥½ã€‚ æ€ä¹ˆå¤„ç† pair æ‹¼æ¥ï¼Œå•çº¯ concat åˆ°æœ€åä¸€ä¸ªç»´åº¦ï¼Œè¿˜æ˜¯æœ‰æ›´å¥½çš„åŠæ³•ï¼Ÿ cross-encoder åŠ ä¸Š para_type_id STS é€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ï¼Œè€Œä¸æ˜¯çº¿æ€§å˜æ¢æŠ•å½± ç”¨ 3 ä¸ªä»»åŠ¡çš„æ•°æ®é›†è¿›è¡Œ MLM é¢„è®­ç»ƒ autocast(enabled=args.use_amp)å’Œscaler.scale Gradient Surgery - PCGrad ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#æ”¹è¿›"},{"categories":null,"content":" å¹³å‡æ± åŒ– python def forward(self, input_ids, attention_mask): output = self.bert(input_ids, attention_mask) token_embeddings = output[\"last_hidden_state\"] expand_mask = attention_mask.unsqueeze(-1).expand(token_embeddings.size()).float() return torch.sum(token_embeddings * expand_mask, dim=1) / torch.clamp(expand_mask.sum(1), 1e-9) éœ€è¦æ³¨æ„ï¼šåœ¨è¿›è¡Œå¹³å‡æ± åŒ–æ—¶å€™éœ€è¦è€ƒè™‘åˆ°è¾“å…¥æ–‡æœ¬é•¿åº¦ä¸å‡ï¼Œæ‰€ä»¥è¦ç”¨æ©ç å»é™¤æ— ç”¨çš„ embeddingã€‚æˆ‘çš„åŠæ³•æ˜¯æŠŠ 0/1 çš„æ©ç çŸ©é˜µæ‰©å¼ åˆ° [batch_size, seq_len, hidden_size] ç„¶åç›¸ä¹˜ï¼Œè¿™æ · 0 ä½ç½®çš„ token å°±ä¸ä¼šå‚ä¸è®¡ç®—ï¼Œå®éªŒç»“æœå¦‚ä¸‹ï¼š æ•°æ®é›† SST æµ‹è¯•é›† Quora æµ‹è¯•é›† STS æµ‹è¯•é›† baseline 0.395 0.644 0.212 baseline + mean-pooling 0.437 0.424 ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#å¹³å‡æ± åŒ–"},{"categories":null,"content":" Pair Sentence æ‹¼æ¥ DifProdå‚è€ƒ Sentence-BERT çš„åšæ³•ï¼Œå°†å¹³å‡æ± åŒ–åå¾—åˆ°çš„ u,v æ‹¼æ¥ä¸º (u, v, |u - v|, u*v)ï¼Œç„¶åæ¥çº¿æ€§å±‚åˆ†ç±»ã€‚ python def predict_similarity(self,input_ids_1, attention_mask_1,input_ids_2, attention_mask_2): simi_1 = self.forward(input_ids_1, attention_mask_1) simi_2 = self.forward(input_ids_2, attention_mask_2) simi_combined = torch.cat([simi_1, simi_2, torch.abs(simi_1 - simi_2), simi_1 * simi_2], dim=1) simi_combined = self.sts_dense(simi_combined) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) Cross-EncoderCross-Encoder çš„æ€è·¯æ˜¯å°†å¥å­ A å’Œ B çš„ embedding æ‹¼æ¥ä¸º [CLS] A [SEP] B [SEP]ï¼Œç„¶åæŠŠè¿™ä¸ªé•¿åºåˆ—é€å…¥æ¨¡å‹ã€‚ python def predict_similarity(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): input_ids = torch.cat([input_ids_1, input_ids_2[:, 1:]], dim=1) attention_mask = torch.cat([attention_mask_1, attention_mask_2[:, 1:]], dim=1) token_emb = self.forward(input_ids, attention_mask) simi_combined = self.sts_dense(token_emb) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) ç”±äº Quora æ•°æ®é›†å¤ªå¤§ï¼Œè¿™æ¬¡ä»…ç”¨ STS æ•°æ®é›†è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹ï¼š æ¨¡å‹ STS éªŒè¯é›† STS æµ‹è¯•é›† baseline 0.237 0.212 mean-pooling 0.437 0.424 mean-pooling + difprod(u, v, |u - v|, u * v) 0.744 0.728 mean-pooling + difprod(|u - v|, u * v) 0.746 0.724 mean-pooling + cross-encoder 0.774 0.758 ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#pair-sentence-æ‹¼æ¥"},{"categories":null,"content":" Pair Sentence æ‹¼æ¥ DifProdå‚è€ƒ Sentence-BERT çš„åšæ³•ï¼Œå°†å¹³å‡æ± åŒ–åå¾—åˆ°çš„ u,v æ‹¼æ¥ä¸º (u, v, |u - v|, u*v)ï¼Œç„¶åæ¥çº¿æ€§å±‚åˆ†ç±»ã€‚ python def predict_similarity(self,input_ids_1, attention_mask_1,input_ids_2, attention_mask_2): simi_1 = self.forward(input_ids_1, attention_mask_1) simi_2 = self.forward(input_ids_2, attention_mask_2) simi_combined = torch.cat([simi_1, simi_2, torch.abs(simi_1 - simi_2), simi_1 * simi_2], dim=1) simi_combined = self.sts_dense(simi_combined) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) Cross-EncoderCross-Encoder çš„æ€è·¯æ˜¯å°†å¥å­ A å’Œ B çš„ embedding æ‹¼æ¥ä¸º [CLS] A [SEP] B [SEP]ï¼Œç„¶åæŠŠè¿™ä¸ªé•¿åºåˆ—é€å…¥æ¨¡å‹ã€‚ python def predict_similarity(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): input_ids = torch.cat([input_ids_1, input_ids_2[:, 1:]], dim=1) attention_mask = torch.cat([attention_mask_1, attention_mask_2[:, 1:]], dim=1) token_emb = self.forward(input_ids, attention_mask) simi_combined = self.sts_dense(token_emb) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) ç”±äº Quora æ•°æ®é›†å¤ªå¤§ï¼Œè¿™æ¬¡ä»…ç”¨ STS æ•°æ®é›†è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹ï¼š æ¨¡å‹ STS éªŒè¯é›† STS æµ‹è¯•é›† baseline 0.237 0.212 mean-pooling 0.437 0.424 mean-pooling + difprod(u, v, |u - v|, u * v) 0.744 0.728 mean-pooling + difprod(|u - v|, u * v) 0.746 0.724 mean-pooling + cross-encoder 0.774 0.758 ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#difprod"},{"categories":null,"content":" Pair Sentence æ‹¼æ¥ DifProdå‚è€ƒ Sentence-BERT çš„åšæ³•ï¼Œå°†å¹³å‡æ± åŒ–åå¾—åˆ°çš„ u,v æ‹¼æ¥ä¸º (u, v, |u - v|, u*v)ï¼Œç„¶åæ¥çº¿æ€§å±‚åˆ†ç±»ã€‚ python def predict_similarity(self,input_ids_1, attention_mask_1,input_ids_2, attention_mask_2): simi_1 = self.forward(input_ids_1, attention_mask_1) simi_2 = self.forward(input_ids_2, attention_mask_2) simi_combined = torch.cat([simi_1, simi_2, torch.abs(simi_1 - simi_2), simi_1 * simi_2], dim=1) simi_combined = self.sts_dense(simi_combined) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) Cross-EncoderCross-Encoder çš„æ€è·¯æ˜¯å°†å¥å­ A å’Œ B çš„ embedding æ‹¼æ¥ä¸º [CLS] A [SEP] B [SEP]ï¼Œç„¶åæŠŠè¿™ä¸ªé•¿åºåˆ—é€å…¥æ¨¡å‹ã€‚ python def predict_similarity(self, input_ids_1, attention_mask_1, input_ids_2, attention_mask_2): input_ids = torch.cat([input_ids_1, input_ids_2[:, 1:]], dim=1) attention_mask = torch.cat([attention_mask_1, attention_mask_2[:, 1:]], dim=1) token_emb = self.forward(input_ids, attention_mask) simi_combined = self.sts_dense(token_emb) simi_combined = self.dropout(simi_combined) simi_combined = self.relu(simi_combined) return self.sts_classifier(simi_combined) ç”±äº Quora æ•°æ®é›†å¤ªå¤§ï¼Œè¿™æ¬¡ä»…ç”¨ STS æ•°æ®é›†è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹ï¼š æ¨¡å‹ STS éªŒè¯é›† STS æµ‹è¯•é›† baseline 0.237 0.212 mean-pooling 0.437 0.424 mean-pooling + difprod(u, v, |u - v|, u * v) 0.744 0.728 mean-pooling + difprod(|u - v|, u * v) 0.746 0.724 mean-pooling + cross-encoder 0.774 0.758 ","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#cross-encoder"},{"categories":null,"content":" å…¨æ¨¡å‹å¾®è°ƒå…¨æ¨¡å‹å¾®è°ƒå’Œä»…ä»…å¾®è°ƒåˆ†ç±»å¤´ä¸åŒï¼Œéœ€è¦è§£å†» bert æ¨¡å‹çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šå‡å¦‚å…ˆå¯¹ SST æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œå†å¯¹ Quora æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œé‚£ä¹ˆåè®­ç»ƒçš„æ•°æ®é›†å¯èƒ½ä¼šå¯¹ SST è®­ç»ƒç»“æœäº§ç”Ÿå½±å“ã€‚æˆ‘æœ‰ä¸‰ç§æƒ³æ³•è¿›è¡Œè®­ç»ƒï¼š Sequential Fintuneï¼šæŒ‰ç…§ä¸åŒçš„é¡ºåºåœ¨æ¯ä¸ª epoch å¯¹ä¸‰ä¸ªä»»åŠ¡è½®æµè¿›è¡Œè®­ç»ƒ Min-Anneal Sampling Finetuneï¼šæ ¹æ® min-anneal æ¦‚ç‡é‡‡æ ·ä»»åŠ¡ï¼Œæ¯ä¸ªè½®æ¬¡ä»…è®­ç»ƒä¸€ä¸ªä»»åŠ¡ Mixed Finetuneï¼šæ¯ä¸ª epoch å¯¹ä¸‰ä¸ªä»»åŠ¡ä¸€èµ·è®­ç»ƒ Sequential Finetuneè€ƒè™‘åˆ° Quora æ•°æ®é›†çš„å¤§å°æ¯”å…¶ä»–ä¸¤ä¸ªæ•°æ®é›†å¤§äº†ä¸¤ä¸ªæ•°æ®é›†ï¼Œä¼šå¯¹æ¨¡å‹äº§ç”Ÿè¾ƒå¤§å½±å“ï¼Œæ‰€ä»¥å…ˆå¯¹å®ƒè¿›è¡Œè®­ç»ƒï¼Œé¡ºåºä¸º Quora â†’ SST â†’ STSã€‚ python labels = [\"sst\", \"para\", \"sts\"] best_score = 0 model.train() for epoch in range(args.epochs): train_loss = {label: 0 for label in labels} num_batches = {label: 0 for label in labels} # para for batch in tqdm(para_train_dataloader, desc=f'para-train-{epoch}', disable=TQDM_DISABLE): b_ids_1, b_mask_1 = batch[\"token_ids_1\"].to(device), batch['attention_mask_1'].to(device) b_ids_2, b_mask_2 = batch[\"token_ids_2\"].to(device), batch['attention_mask_2'].to(device) b_labels = batch[\"labels\"].to(device) optimizer.zero_grad() logits = model.predict_paraphrase(b_ids_1, b_mask_1, b_ids_2, b_mask_2) loss = F.binary_cross_entropy_with_logits(logits.view(-1), b_labels.view(-1).float(), reduction='mean') loss.backward() optimizer.step() train_loss[\"para\"] += loss.item() num_batches[\"para\"] += 1 train_loss[\"para\"] /= num_batches[\"para\"] # sst for batch in tqdm(sst_train_dataloader, desc=f'sst-train-{epoch}', disable=TQDM_DISABLE): b_ids, b_mask, b_labels = batch['token_ids'].to(device), batch['attention_mask'].to(device), batch['labels'].to(device) optimizer.zero_grad() logits = model.predict_sentiment(b_ids, b_mask) loss = F.cross_entropy(logits, b_labels.view(-1), reduction='mean') loss.backward() optimizer.step() train_loss[\"sst\"] += loss.item() num_batches['sst'] += 1 train_loss[\"sst\"] /= num_batches[\"sst\"] # sts for batch in tqdm(sts_train_dataloader, desc=f'sts-train-{epoch}', disable=TQDM_DISABLE): b_ids_1, b_mask_1 = batch[\"token_ids_1\"].to(device), batch['attention_mask_1'].to(device) b_ids_2, b_mask_2 = batch[\"token_ids_2\"].to(device), batch['attention_mask_2'].to(device) b_labels = batch[\"labels\"].to(device) optimizer.zero_grad() logits = model.predict_similarity(b_ids_1, b_mask_1, b_ids_2, b_mask_2) prob = F.sigmoid(logits) * 5 loss = F.mse_loss(prob.view(-1), b_labels.float(), reduction=\"sum\") / args.batch_size loss.backward() optimizer.step() train_loss[\"sts\"] += loss.item() num_batches['sts'] += 1 train_loss[\"sts\"] /= num_batches[\"sts\"] (para_train_acc, _, _, sst_train_acc,_, _, sts_train_corr, _, _) = model_eval_multitask(sst_train_dataloader, para_train_dataloader, sts_train_dataloader, model, device) (para_dev_acc, _, _, sst_dev_acc,_, _, sts_dev_corr, _, _) = model_eval_multitask(sst_dev_dataloader, para_dev_dataloader, sts_dev_dataloader, model, device) dev_score = (sst_dev_acc + para_dev_acc + sts_dev_corr) / 3.0 if dev_score \u003e best_score: best_score = dev_score save_model(model, optimizer, args, config, args.filepath) print(f\"Epoch {epoch}: para losses {train_loss['para']}, sst losses {train_loss['sst']}, sts losses {train_loss['sts']}\") print(f\"Epoch {epoch}: sst train acc {sst_train_acc:.4f}, para train acc {para_train_acc:.4f}, sts train corr {sts_train_corr:.4f}\") print(f\"Epoch {epoch}: sst dev acc {sst_dev_acc:.4f}, para dev acc {para_dev_acc:.4f}, sts dev corr {sts_dev_corr:.4f}\") Min-Anneal Sampling Finetuneé€€ç«é‡‡æ ·çš„æ€è·¯åœ¨äºï¼š å¦‚æœæŒ‰æ•°æ®é›†å¤§å°æ¯”ä¾‹é‡‡æ ·ï¼Œå°ä»»åŠ¡æ°¸è¿œå¾—ä¸åˆ°å……åˆ†è®­ç»ƒï¼Œä¼šè¢«å¤§ä»»åŠ¡æ·¹æ²¡ã€‚ å¦‚æœç®€å•åœ°å‡åŒ€é‡‡æ ·ä»»åŠ¡ï¼ˆ1/3 æœºä¼šé‡‡æ · A, B, Cï¼‰ï¼Œå°ä»»åŠ¡ä¼šè¢«è¿‡åº¦è®­ç»ƒï¼Œè€Œå¤§ä»»åŠ¡çš„è¡¨ç¤ºå­¦ä¹ ä¸è¶³ã€‚ å› æ­¤éœ€è¦ä¸€ä¸ªæŠ˜ä¸­æ–¹æ³•ï¼šè®­ç»ƒæ—©æœŸè¦æ›´å¹³è¡¡ï¼ˆå‡åŒ€ï¼‰åœ°é€‰ä»»åŠ¡ï¼ŒåæœŸé€æ¸è®©é‡‡æ ·æ¦‚ç‡é€€ç«åˆ°æŒ‰æ•°æ®é›†å¤§å°åˆ†å¸ƒã€‚ å‡è®¾ä½ æœ‰ n ä¸ªä»»åŠ¡ï¼Œæ•°æ®é›†å¤§å°åˆ†åˆ«ä¸ºï¼š âˆ£D1âˆ£,âˆ£D2âˆ£,...,âˆ£Dnâˆ£ |D_1|, |D_2|, ..., |D_n| âˆ£D1â€‹âˆ£,âˆ£D2â€‹âˆ£,...,âˆ£Dnâ€‹âˆ£å…ˆè®¡ç®—æŒ‰å¤§å°çš„é‡‡æ ·åˆ†å¸ƒï¼š pisize=âˆ£Diâˆ£âˆ‘jâˆ£Djâˆ£ p_i^{size} = \\frac{|D_i|}{\\sum_j |D_j|} pisizeâ€‹=âˆ‘jâ€‹âˆ£Djâ€‹âˆ£âˆ£Diâ€‹âˆ£â€‹å†è®¡ç®—å‡åŒ€åˆ†å¸ƒï¼š piuniform=1n p_i^{uniform} = \\frac{1}{n} piuniformâ€‹=n1â€‹Min-Anneal Sampling æ„å»ºä¸€ä¸ªéšè®­ç»ƒè¿›å±•é€€ç«çš„é‡‡æ ·æ¦‚ç‡ï¼š pi(t)=minâ¡(1,â€…tTanneal)â‹…pisizeâ€…+â€…(1âˆ’minâ¡(1,tTanneal))â‹…piuniform p_i(t) = \\min\\left(1,\\; \\frac{t}{T_{anneal}}\\right) \\cdot p_i^{size} \\;+\\; \\left(1 - \\min\\left(1,\\frac{t}{T_{anneal}}\\right)\\right) \\cdot p_i^{uniform} piâ€‹(t)=min(1,Tannealâ€‹tâ€‹)â‹…pisizeâ€‹+(1âˆ’min(1,Tannealâ€‹tâ€‹))â‹…piuniformâ€‹ä»£ç å¦‚ä¸‹ï¼š python def min_anneal_prob(dataset_sizes, epoch, T","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:4","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#å…¨æ¨¡å‹å¾®è°ƒ"},{"categories":null,"content":" å…¨æ¨¡å‹å¾®è°ƒå…¨æ¨¡å‹å¾®è°ƒå’Œä»…ä»…å¾®è°ƒåˆ†ç±»å¤´ä¸åŒï¼Œéœ€è¦è§£å†» bert æ¨¡å‹çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šå‡å¦‚å…ˆå¯¹ SST æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œå†å¯¹ Quora æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œé‚£ä¹ˆåè®­ç»ƒçš„æ•°æ®é›†å¯èƒ½ä¼šå¯¹ SST è®­ç»ƒç»“æœäº§ç”Ÿå½±å“ã€‚æˆ‘æœ‰ä¸‰ç§æƒ³æ³•è¿›è¡Œè®­ç»ƒï¼š Sequential Fintuneï¼šæŒ‰ç…§ä¸åŒçš„é¡ºåºåœ¨æ¯ä¸ª epoch å¯¹ä¸‰ä¸ªä»»åŠ¡è½®æµè¿›è¡Œè®­ç»ƒ Min-Anneal Sampling Finetuneï¼šæ ¹æ® min-anneal æ¦‚ç‡é‡‡æ ·ä»»åŠ¡ï¼Œæ¯ä¸ªè½®æ¬¡ä»…è®­ç»ƒä¸€ä¸ªä»»åŠ¡ Mixed Finetuneï¼šæ¯ä¸ª epoch å¯¹ä¸‰ä¸ªä»»åŠ¡ä¸€èµ·è®­ç»ƒ Sequential Finetuneè€ƒè™‘åˆ° Quora æ•°æ®é›†çš„å¤§å°æ¯”å…¶ä»–ä¸¤ä¸ªæ•°æ®é›†å¤§äº†ä¸¤ä¸ªæ•°æ®é›†ï¼Œä¼šå¯¹æ¨¡å‹äº§ç”Ÿè¾ƒå¤§å½±å“ï¼Œæ‰€ä»¥å…ˆå¯¹å®ƒè¿›è¡Œè®­ç»ƒï¼Œé¡ºåºä¸º Quora â†’ SST â†’ STSã€‚ python labels = [\"sst\", \"para\", \"sts\"] best_score = 0 model.train() for epoch in range(args.epochs): train_loss = {label: 0 for label in labels} num_batches = {label: 0 for label in labels} # para for batch in tqdm(para_train_dataloader, desc=f'para-train-{epoch}', disable=TQDM_DISABLE): b_ids_1, b_mask_1 = batch[\"token_ids_1\"].to(device), batch['attention_mask_1'].to(device) b_ids_2, b_mask_2 = batch[\"token_ids_2\"].to(device), batch['attention_mask_2'].to(device) b_labels = batch[\"labels\"].to(device) optimizer.zero_grad() logits = model.predict_paraphrase(b_ids_1, b_mask_1, b_ids_2, b_mask_2) loss = F.binary_cross_entropy_with_logits(logits.view(-1), b_labels.view(-1).float(), reduction='mean') loss.backward() optimizer.step() train_loss[\"para\"] += loss.item() num_batches[\"para\"] += 1 train_loss[\"para\"] /= num_batches[\"para\"] # sst for batch in tqdm(sst_train_dataloader, desc=f'sst-train-{epoch}', disable=TQDM_DISABLE): b_ids, b_mask, b_labels = batch['token_ids'].to(device), batch['attention_mask'].to(device), batch['labels'].to(device) optimizer.zero_grad() logits = model.predict_sentiment(b_ids, b_mask) loss = F.cross_entropy(logits, b_labels.view(-1), reduction='mean') loss.backward() optimizer.step() train_loss[\"sst\"] += loss.item() num_batches['sst'] += 1 train_loss[\"sst\"] /= num_batches[\"sst\"] # sts for batch in tqdm(sts_train_dataloader, desc=f'sts-train-{epoch}', disable=TQDM_DISABLE): b_ids_1, b_mask_1 = batch[\"token_ids_1\"].to(device), batch['attention_mask_1'].to(device) b_ids_2, b_mask_2 = batch[\"token_ids_2\"].to(device), batch['attention_mask_2'].to(device) b_labels = batch[\"labels\"].to(device) optimizer.zero_grad() logits = model.predict_similarity(b_ids_1, b_mask_1, b_ids_2, b_mask_2) prob = F.sigmoid(logits) * 5 loss = F.mse_loss(prob.view(-1), b_labels.float(), reduction=\"sum\") / args.batch_size loss.backward() optimizer.step() train_loss[\"sts\"] += loss.item() num_batches['sts'] += 1 train_loss[\"sts\"] /= num_batches[\"sts\"] (para_train_acc, _, _, sst_train_acc,_, _, sts_train_corr, _, _) = model_eval_multitask(sst_train_dataloader, para_train_dataloader, sts_train_dataloader, model, device) (para_dev_acc, _, _, sst_dev_acc,_, _, sts_dev_corr, _, _) = model_eval_multitask(sst_dev_dataloader, para_dev_dataloader, sts_dev_dataloader, model, device) dev_score = (sst_dev_acc + para_dev_acc + sts_dev_corr) / 3.0 if dev_score \u003e best_score: best_score = dev_score save_model(model, optimizer, args, config, args.filepath) print(f\"Epoch {epoch}: para losses {train_loss['para']}, sst losses {train_loss['sst']}, sts losses {train_loss['sts']}\") print(f\"Epoch {epoch}: sst train acc {sst_train_acc:.4f}, para train acc {para_train_acc:.4f}, sts train corr {sts_train_corr:.4f}\") print(f\"Epoch {epoch}: sst dev acc {sst_dev_acc:.4f}, para dev acc {para_dev_acc:.4f}, sts dev corr {sts_dev_corr:.4f}\") Min-Anneal Sampling Finetuneé€€ç«é‡‡æ ·çš„æ€è·¯åœ¨äºï¼š å¦‚æœæŒ‰æ•°æ®é›†å¤§å°æ¯”ä¾‹é‡‡æ ·ï¼Œå°ä»»åŠ¡æ°¸è¿œå¾—ä¸åˆ°å……åˆ†è®­ç»ƒï¼Œä¼šè¢«å¤§ä»»åŠ¡æ·¹æ²¡ã€‚ å¦‚æœç®€å•åœ°å‡åŒ€é‡‡æ ·ä»»åŠ¡ï¼ˆ1/3 æœºä¼šé‡‡æ · A, B, Cï¼‰ï¼Œå°ä»»åŠ¡ä¼šè¢«è¿‡åº¦è®­ç»ƒï¼Œè€Œå¤§ä»»åŠ¡çš„è¡¨ç¤ºå­¦ä¹ ä¸è¶³ã€‚ å› æ­¤éœ€è¦ä¸€ä¸ªæŠ˜ä¸­æ–¹æ³•ï¼šè®­ç»ƒæ—©æœŸè¦æ›´å¹³è¡¡ï¼ˆå‡åŒ€ï¼‰åœ°é€‰ä»»åŠ¡ï¼ŒåæœŸé€æ¸è®©é‡‡æ ·æ¦‚ç‡é€€ç«åˆ°æŒ‰æ•°æ®é›†å¤§å°åˆ†å¸ƒã€‚ å‡è®¾ä½ æœ‰ n ä¸ªä»»åŠ¡ï¼Œæ•°æ®é›†å¤§å°åˆ†åˆ«ä¸ºï¼š âˆ£D1âˆ£,âˆ£D2âˆ£,...,âˆ£Dnâˆ£ |D_1|, |D_2|, ..., |D_n| âˆ£D1â€‹âˆ£,âˆ£D2â€‹âˆ£,...,âˆ£Dnâ€‹âˆ£å…ˆè®¡ç®—æŒ‰å¤§å°çš„é‡‡æ ·åˆ†å¸ƒï¼š pisize=âˆ£Diâˆ£âˆ‘jâˆ£Djâˆ£ p_i^{size} = \\frac{|D_i|}{\\sum_j |D_j|} pisizeâ€‹=âˆ‘jâ€‹âˆ£Djâ€‹âˆ£âˆ£Diâ€‹âˆ£â€‹å†è®¡ç®—å‡åŒ€åˆ†å¸ƒï¼š piuniform=1n p_i^{uniform} = \\frac{1}{n} piuniformâ€‹=n1â€‹Min-Anneal Sampling æ„å»ºä¸€ä¸ªéšè®­ç»ƒè¿›å±•é€€ç«çš„é‡‡æ ·æ¦‚ç‡ï¼š pi(t)=minâ¡(1,â€…tTanneal)â‹…pisizeâ€…+â€…(1âˆ’minâ¡(1,tTanneal))â‹…piuniform p_i(t) = \\min\\left(1,\\; \\frac{t}{T_{anneal}}\\right) \\cdot p_i^{size} \\;+\\; \\left(1 - \\min\\left(1,\\frac{t}{T_{anneal}}\\right)\\right) \\cdot p_i^{uniform} piâ€‹(t)=min(1,Tannealâ€‹tâ€‹)â‹…pisizeâ€‹+(1âˆ’min(1,Tannealâ€‹tâ€‹))â‹…piuniformâ€‹ä»£ç å¦‚ä¸‹ï¼š python def min_anneal_prob(dataset_sizes, epoch, T","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:4","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#sequential-finetune"},{"categories":null,"content":" å…¨æ¨¡å‹å¾®è°ƒå…¨æ¨¡å‹å¾®è°ƒå’Œä»…ä»…å¾®è°ƒåˆ†ç±»å¤´ä¸åŒï¼Œéœ€è¦è§£å†» bert æ¨¡å‹çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šå‡å¦‚å…ˆå¯¹ SST æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œå†å¯¹ Quora æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œé‚£ä¹ˆåè®­ç»ƒçš„æ•°æ®é›†å¯èƒ½ä¼šå¯¹ SST è®­ç»ƒç»“æœäº§ç”Ÿå½±å“ã€‚æˆ‘æœ‰ä¸‰ç§æƒ³æ³•è¿›è¡Œè®­ç»ƒï¼š Sequential Fintuneï¼šæŒ‰ç…§ä¸åŒçš„é¡ºåºåœ¨æ¯ä¸ª epoch å¯¹ä¸‰ä¸ªä»»åŠ¡è½®æµè¿›è¡Œè®­ç»ƒ Min-Anneal Sampling Finetuneï¼šæ ¹æ® min-anneal æ¦‚ç‡é‡‡æ ·ä»»åŠ¡ï¼Œæ¯ä¸ªè½®æ¬¡ä»…è®­ç»ƒä¸€ä¸ªä»»åŠ¡ Mixed Finetuneï¼šæ¯ä¸ª epoch å¯¹ä¸‰ä¸ªä»»åŠ¡ä¸€èµ·è®­ç»ƒ Sequential Finetuneè€ƒè™‘åˆ° Quora æ•°æ®é›†çš„å¤§å°æ¯”å…¶ä»–ä¸¤ä¸ªæ•°æ®é›†å¤§äº†ä¸¤ä¸ªæ•°æ®é›†ï¼Œä¼šå¯¹æ¨¡å‹äº§ç”Ÿè¾ƒå¤§å½±å“ï¼Œæ‰€ä»¥å…ˆå¯¹å®ƒè¿›è¡Œè®­ç»ƒï¼Œé¡ºåºä¸º Quora â†’ SST â†’ STSã€‚ python labels = [\"sst\", \"para\", \"sts\"] best_score = 0 model.train() for epoch in range(args.epochs): train_loss = {label: 0 for label in labels} num_batches = {label: 0 for label in labels} # para for batch in tqdm(para_train_dataloader, desc=f'para-train-{epoch}', disable=TQDM_DISABLE): b_ids_1, b_mask_1 = batch[\"token_ids_1\"].to(device), batch['attention_mask_1'].to(device) b_ids_2, b_mask_2 = batch[\"token_ids_2\"].to(device), batch['attention_mask_2'].to(device) b_labels = batch[\"labels\"].to(device) optimizer.zero_grad() logits = model.predict_paraphrase(b_ids_1, b_mask_1, b_ids_2, b_mask_2) loss = F.binary_cross_entropy_with_logits(logits.view(-1), b_labels.view(-1).float(), reduction='mean') loss.backward() optimizer.step() train_loss[\"para\"] += loss.item() num_batches[\"para\"] += 1 train_loss[\"para\"] /= num_batches[\"para\"] # sst for batch in tqdm(sst_train_dataloader, desc=f'sst-train-{epoch}', disable=TQDM_DISABLE): b_ids, b_mask, b_labels = batch['token_ids'].to(device), batch['attention_mask'].to(device), batch['labels'].to(device) optimizer.zero_grad() logits = model.predict_sentiment(b_ids, b_mask) loss = F.cross_entropy(logits, b_labels.view(-1), reduction='mean') loss.backward() optimizer.step() train_loss[\"sst\"] += loss.item() num_batches['sst'] += 1 train_loss[\"sst\"] /= num_batches[\"sst\"] # sts for batch in tqdm(sts_train_dataloader, desc=f'sts-train-{epoch}', disable=TQDM_DISABLE): b_ids_1, b_mask_1 = batch[\"token_ids_1\"].to(device), batch['attention_mask_1'].to(device) b_ids_2, b_mask_2 = batch[\"token_ids_2\"].to(device), batch['attention_mask_2'].to(device) b_labels = batch[\"labels\"].to(device) optimizer.zero_grad() logits = model.predict_similarity(b_ids_1, b_mask_1, b_ids_2, b_mask_2) prob = F.sigmoid(logits) * 5 loss = F.mse_loss(prob.view(-1), b_labels.float(), reduction=\"sum\") / args.batch_size loss.backward() optimizer.step() train_loss[\"sts\"] += loss.item() num_batches['sts'] += 1 train_loss[\"sts\"] /= num_batches[\"sts\"] (para_train_acc, _, _, sst_train_acc,_, _, sts_train_corr, _, _) = model_eval_multitask(sst_train_dataloader, para_train_dataloader, sts_train_dataloader, model, device) (para_dev_acc, _, _, sst_dev_acc,_, _, sts_dev_corr, _, _) = model_eval_multitask(sst_dev_dataloader, para_dev_dataloader, sts_dev_dataloader, model, device) dev_score = (sst_dev_acc + para_dev_acc + sts_dev_corr) / 3.0 if dev_score \u003e best_score: best_score = dev_score save_model(model, optimizer, args, config, args.filepath) print(f\"Epoch {epoch}: para losses {train_loss['para']}, sst losses {train_loss['sst']}, sts losses {train_loss['sts']}\") print(f\"Epoch {epoch}: sst train acc {sst_train_acc:.4f}, para train acc {para_train_acc:.4f}, sts train corr {sts_train_corr:.4f}\") print(f\"Epoch {epoch}: sst dev acc {sst_dev_acc:.4f}, para dev acc {para_dev_acc:.4f}, sts dev corr {sts_dev_corr:.4f}\") Min-Anneal Sampling Finetuneé€€ç«é‡‡æ ·çš„æ€è·¯åœ¨äºï¼š å¦‚æœæŒ‰æ•°æ®é›†å¤§å°æ¯”ä¾‹é‡‡æ ·ï¼Œå°ä»»åŠ¡æ°¸è¿œå¾—ä¸åˆ°å……åˆ†è®­ç»ƒï¼Œä¼šè¢«å¤§ä»»åŠ¡æ·¹æ²¡ã€‚ å¦‚æœç®€å•åœ°å‡åŒ€é‡‡æ ·ä»»åŠ¡ï¼ˆ1/3 æœºä¼šé‡‡æ · A, B, Cï¼‰ï¼Œå°ä»»åŠ¡ä¼šè¢«è¿‡åº¦è®­ç»ƒï¼Œè€Œå¤§ä»»åŠ¡çš„è¡¨ç¤ºå­¦ä¹ ä¸è¶³ã€‚ å› æ­¤éœ€è¦ä¸€ä¸ªæŠ˜ä¸­æ–¹æ³•ï¼šè®­ç»ƒæ—©æœŸè¦æ›´å¹³è¡¡ï¼ˆå‡åŒ€ï¼‰åœ°é€‰ä»»åŠ¡ï¼ŒåæœŸé€æ¸è®©é‡‡æ ·æ¦‚ç‡é€€ç«åˆ°æŒ‰æ•°æ®é›†å¤§å°åˆ†å¸ƒã€‚ å‡è®¾ä½ æœ‰ n ä¸ªä»»åŠ¡ï¼Œæ•°æ®é›†å¤§å°åˆ†åˆ«ä¸ºï¼š âˆ£D1âˆ£,âˆ£D2âˆ£,...,âˆ£Dnâˆ£ |D_1|, |D_2|, ..., |D_n| âˆ£D1â€‹âˆ£,âˆ£D2â€‹âˆ£,...,âˆ£Dnâ€‹âˆ£å…ˆè®¡ç®—æŒ‰å¤§å°çš„é‡‡æ ·åˆ†å¸ƒï¼š pisize=âˆ£Diâˆ£âˆ‘jâˆ£Djâˆ£ p_i^{size} = \\frac{|D_i|}{\\sum_j |D_j|} pisizeâ€‹=âˆ‘jâ€‹âˆ£Djâ€‹âˆ£âˆ£Diâ€‹âˆ£â€‹å†è®¡ç®—å‡åŒ€åˆ†å¸ƒï¼š piuniform=1n p_i^{uniform} = \\frac{1}{n} piuniformâ€‹=n1â€‹Min-Anneal Sampling æ„å»ºä¸€ä¸ªéšè®­ç»ƒè¿›å±•é€€ç«çš„é‡‡æ ·æ¦‚ç‡ï¼š pi(t)=minâ¡(1,â€…tTanneal)â‹…pisizeâ€…+â€…(1âˆ’minâ¡(1,tTanneal))â‹…piuniform p_i(t) = \\min\\left(1,\\; \\frac{t}{T_{anneal}}\\right) \\cdot p_i^{size} \\;+\\; \\left(1 - \\min\\left(1,\\frac{t}{T_{anneal}}\\right)\\right) \\cdot p_i^{uniform} piâ€‹(t)=min(1,Tannealâ€‹tâ€‹)â‹…pisizeâ€‹+(1âˆ’min(1,Tannealâ€‹tâ€‹))â‹…piuniformâ€‹ä»£ç å¦‚ä¸‹ï¼š python def min_anneal_prob(dataset_sizes, epoch, T","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:4","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#min-anneal-sampling-finetune"},{"categories":null,"content":" å…¨æ¨¡å‹å¾®è°ƒå…¨æ¨¡å‹å¾®è°ƒå’Œä»…ä»…å¾®è°ƒåˆ†ç±»å¤´ä¸åŒï¼Œéœ€è¦è§£å†» bert æ¨¡å‹çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šå‡å¦‚å…ˆå¯¹ SST æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œå†å¯¹ Quora æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œé‚£ä¹ˆåè®­ç»ƒçš„æ•°æ®é›†å¯èƒ½ä¼šå¯¹ SST è®­ç»ƒç»“æœäº§ç”Ÿå½±å“ã€‚æˆ‘æœ‰ä¸‰ç§æƒ³æ³•è¿›è¡Œè®­ç»ƒï¼š Sequential Fintuneï¼šæŒ‰ç…§ä¸åŒçš„é¡ºåºåœ¨æ¯ä¸ª epoch å¯¹ä¸‰ä¸ªä»»åŠ¡è½®æµè¿›è¡Œè®­ç»ƒ Min-Anneal Sampling Finetuneï¼šæ ¹æ® min-anneal æ¦‚ç‡é‡‡æ ·ä»»åŠ¡ï¼Œæ¯ä¸ªè½®æ¬¡ä»…è®­ç»ƒä¸€ä¸ªä»»åŠ¡ Mixed Finetuneï¼šæ¯ä¸ª epoch å¯¹ä¸‰ä¸ªä»»åŠ¡ä¸€èµ·è®­ç»ƒ Sequential Finetuneè€ƒè™‘åˆ° Quora æ•°æ®é›†çš„å¤§å°æ¯”å…¶ä»–ä¸¤ä¸ªæ•°æ®é›†å¤§äº†ä¸¤ä¸ªæ•°æ®é›†ï¼Œä¼šå¯¹æ¨¡å‹äº§ç”Ÿè¾ƒå¤§å½±å“ï¼Œæ‰€ä»¥å…ˆå¯¹å®ƒè¿›è¡Œè®­ç»ƒï¼Œé¡ºåºä¸º Quora â†’ SST â†’ STSã€‚ python labels = [\"sst\", \"para\", \"sts\"] best_score = 0 model.train() for epoch in range(args.epochs): train_loss = {label: 0 for label in labels} num_batches = {label: 0 for label in labels} # para for batch in tqdm(para_train_dataloader, desc=f'para-train-{epoch}', disable=TQDM_DISABLE): b_ids_1, b_mask_1 = batch[\"token_ids_1\"].to(device), batch['attention_mask_1'].to(device) b_ids_2, b_mask_2 = batch[\"token_ids_2\"].to(device), batch['attention_mask_2'].to(device) b_labels = batch[\"labels\"].to(device) optimizer.zero_grad() logits = model.predict_paraphrase(b_ids_1, b_mask_1, b_ids_2, b_mask_2) loss = F.binary_cross_entropy_with_logits(logits.view(-1), b_labels.view(-1).float(), reduction='mean') loss.backward() optimizer.step() train_loss[\"para\"] += loss.item() num_batches[\"para\"] += 1 train_loss[\"para\"] /= num_batches[\"para\"] # sst for batch in tqdm(sst_train_dataloader, desc=f'sst-train-{epoch}', disable=TQDM_DISABLE): b_ids, b_mask, b_labels = batch['token_ids'].to(device), batch['attention_mask'].to(device), batch['labels'].to(device) optimizer.zero_grad() logits = model.predict_sentiment(b_ids, b_mask) loss = F.cross_entropy(logits, b_labels.view(-1), reduction='mean') loss.backward() optimizer.step() train_loss[\"sst\"] += loss.item() num_batches['sst'] += 1 train_loss[\"sst\"] /= num_batches[\"sst\"] # sts for batch in tqdm(sts_train_dataloader, desc=f'sts-train-{epoch}', disable=TQDM_DISABLE): b_ids_1, b_mask_1 = batch[\"token_ids_1\"].to(device), batch['attention_mask_1'].to(device) b_ids_2, b_mask_2 = batch[\"token_ids_2\"].to(device), batch['attention_mask_2'].to(device) b_labels = batch[\"labels\"].to(device) optimizer.zero_grad() logits = model.predict_similarity(b_ids_1, b_mask_1, b_ids_2, b_mask_2) prob = F.sigmoid(logits) * 5 loss = F.mse_loss(prob.view(-1), b_labels.float(), reduction=\"sum\") / args.batch_size loss.backward() optimizer.step() train_loss[\"sts\"] += loss.item() num_batches['sts'] += 1 train_loss[\"sts\"] /= num_batches[\"sts\"] (para_train_acc, _, _, sst_train_acc,_, _, sts_train_corr, _, _) = model_eval_multitask(sst_train_dataloader, para_train_dataloader, sts_train_dataloader, model, device) (para_dev_acc, _, _, sst_dev_acc,_, _, sts_dev_corr, _, _) = model_eval_multitask(sst_dev_dataloader, para_dev_dataloader, sts_dev_dataloader, model, device) dev_score = (sst_dev_acc + para_dev_acc + sts_dev_corr) / 3.0 if dev_score \u003e best_score: best_score = dev_score save_model(model, optimizer, args, config, args.filepath) print(f\"Epoch {epoch}: para losses {train_loss['para']}, sst losses {train_loss['sst']}, sts losses {train_loss['sts']}\") print(f\"Epoch {epoch}: sst train acc {sst_train_acc:.4f}, para train acc {para_train_acc:.4f}, sts train corr {sts_train_corr:.4f}\") print(f\"Epoch {epoch}: sst dev acc {sst_dev_acc:.4f}, para dev acc {para_dev_acc:.4f}, sts dev corr {sts_dev_corr:.4f}\") Min-Anneal Sampling Finetuneé€€ç«é‡‡æ ·çš„æ€è·¯åœ¨äºï¼š å¦‚æœæŒ‰æ•°æ®é›†å¤§å°æ¯”ä¾‹é‡‡æ ·ï¼Œå°ä»»åŠ¡æ°¸è¿œå¾—ä¸åˆ°å……åˆ†è®­ç»ƒï¼Œä¼šè¢«å¤§ä»»åŠ¡æ·¹æ²¡ã€‚ å¦‚æœç®€å•åœ°å‡åŒ€é‡‡æ ·ä»»åŠ¡ï¼ˆ1/3 æœºä¼šé‡‡æ · A, B, Cï¼‰ï¼Œå°ä»»åŠ¡ä¼šè¢«è¿‡åº¦è®­ç»ƒï¼Œè€Œå¤§ä»»åŠ¡çš„è¡¨ç¤ºå­¦ä¹ ä¸è¶³ã€‚ å› æ­¤éœ€è¦ä¸€ä¸ªæŠ˜ä¸­æ–¹æ³•ï¼šè®­ç»ƒæ—©æœŸè¦æ›´å¹³è¡¡ï¼ˆå‡åŒ€ï¼‰åœ°é€‰ä»»åŠ¡ï¼ŒåæœŸé€æ¸è®©é‡‡æ ·æ¦‚ç‡é€€ç«åˆ°æŒ‰æ•°æ®é›†å¤§å°åˆ†å¸ƒã€‚ å‡è®¾ä½ æœ‰ n ä¸ªä»»åŠ¡ï¼Œæ•°æ®é›†å¤§å°åˆ†åˆ«ä¸ºï¼š âˆ£D1âˆ£,âˆ£D2âˆ£,...,âˆ£Dnâˆ£ |D_1|, |D_2|, ..., |D_n| âˆ£D1â€‹âˆ£,âˆ£D2â€‹âˆ£,...,âˆ£Dnâ€‹âˆ£å…ˆè®¡ç®—æŒ‰å¤§å°çš„é‡‡æ ·åˆ†å¸ƒï¼š pisize=âˆ£Diâˆ£âˆ‘jâˆ£Djâˆ£ p_i^{size} = \\frac{|D_i|}{\\sum_j |D_j|} pisizeâ€‹=âˆ‘jâ€‹âˆ£Djâ€‹âˆ£âˆ£Diâ€‹âˆ£â€‹å†è®¡ç®—å‡åŒ€åˆ†å¸ƒï¼š piuniform=1n p_i^{uniform} = \\frac{1}{n} piuniformâ€‹=n1â€‹Min-Anneal Sampling æ„å»ºä¸€ä¸ªéšè®­ç»ƒè¿›å±•é€€ç«çš„é‡‡æ ·æ¦‚ç‡ï¼š pi(t)=minâ¡(1,â€…tTanneal)â‹…pisizeâ€…+â€…(1âˆ’minâ¡(1,tTanneal))â‹…piuniform p_i(t) = \\min\\left(1,\\; \\frac{t}{T_{anneal}}\\right) \\cdot p_i^{size} \\;+\\; \\left(1 - \\min\\left(1,\\frac{t}{T_{anneal}}\\right)\\right) \\cdot p_i^{uniform} piâ€‹(t)=min(1,Tannealâ€‹tâ€‹)â‹…pisizeâ€‹+(1âˆ’min(1,Tannealâ€‹tâ€‹))â‹…piuniformâ€‹ä»£ç å¦‚ä¸‹ï¼š python def min_anneal_prob(dataset_sizes, epoch, T","date":"2025-12-11","objectID":"/posts/final-project-minbert/:4:4","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Final Project-MinBert","uri":"/posts/final-project-minbert/#mixed-finetune"},{"categories":null,"content":" KVCache çš„åº”ç”¨åœºæ™¯ KV Cache çš„ä¸»è¦ç›®çš„æ˜¯ â€œåŠ é€Ÿè‡ªå›å½’ç”Ÿæˆâ€ï¼Œåœ¨ç”Ÿæˆä¸‹ä¸€ä¸ª token æ—¶ï¼Œåªéœ€è¦è®¡ç®—å½“å‰ token çš„ queryã€keyã€valueã€‚ä¹‹å‰çš„ key/value è¢«ç¼“å­˜ï¼Œç›´æ¥æ‹¼æ¥ä½¿ç”¨ï¼Œé¿å…é‡å¤è®¡ç®—æ•´ä¸ªå†å²åºåˆ—çš„ attentionï¼Œè¿™åœ¨æ¨ç†é˜¶æ®µèƒ½æ˜¾è‘—æå‡é€Ÿåº¦ã€‚ä½†æ˜¯åœ¨é¢„è®­ç»ƒé˜¶æ®µï¼Œä¾‹å¦‚ LLaMa æˆ–è€… GPT é‡‡ç”¨çš„éƒ½æ˜¯ Teacher-Forcing è¿™ç§å¹¶è¡Œè®­ç»ƒï¼Œæˆ‘ä»¬æŠŠ logits å’Œ labels é”™ä½ã€‚è¿™ç§è®¡ç®—æ˜¯å¹¶è¡Œçš„ï¼Œä¸éœ€è¦â€œå¢é‡â€ç”Ÿæˆï¼Œæ‰€ä»¥ä½¿ç”¨ KV Cache åè€Œä¼šå¢åŠ ä»£ç å¤æ‚åº¦å’Œå†…å­˜å¼€é”€ï¼Œæ”¶ç›Šå¾ˆå°ç”šè‡³ä¸ºè´Ÿã€‚ ","date":"2025-12-03","objectID":"/posts/kvcache/:0:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","Transformer"],"title":"KVCache","uri":"/posts/kvcache/#"},{"categories":null,"content":" å‰æƒ…æè¦Teacher-Forcing vs è‡ªå›å½’ç”Ÿæˆ Teacher-Forcing åšçš„æ—¶å€™å’Œè‡ªå›å½’ç”Ÿæˆéå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ª token è¿›è¡Œç”Ÿæˆã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼ŒTeacher-Forcing çš„è®¡ç®—æ˜¯å¹¶è¡Œçš„ï¼Œä½†æ˜¯è‡ªå›å½’ç”Ÿæˆçš„ä¸²è¡Œçš„ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ ä¸»è¦æ˜¯å› ä¸º Teacher-Forcing ä½äºè®­ç»ƒé˜¶æ®µï¼Œåœ¨ Decoder ä¸­æˆ‘ä»¬å·²ç»çŸ¥é“äº†éœ€è¦å¾…ç”Ÿæˆçš„ç­”æ¡ˆï¼Œä¸ºäº†å®ç°å¹¶è¡Œè®¡ç®—å¹¶ä¸”ä¸€ä¸ªæ¥ä¸€ä¸ª token ç”Ÿæˆ(é¢„æµ‹)ï¼Œæˆ‘ä»¬é€šè¿‡ä¸Šä¸‰è§’çŸ©é˜µè¿›è¡Œæ©ç æ“ä½œã€‚ è‡ªå›å½’ç”Ÿæˆä½äºæ¨ç†é˜¶æ®µï¼Œè¿™æ—¶å€™è¦ç”Ÿæˆçš„ç­”æ¡ˆæˆ‘ä»¬æ˜¯ä¸çŸ¥é“çš„ï¼Œæ‰€ä»¥åªèƒ½ä¸€æ¬¡æ¬¡é¢„æµ‹ä¸‹ä¸€ä¸ª tokenã€‚å…·ä½“æ“ä½œæ˜¯æŠŠ prompt å’Œå·²ç»é¢„æµ‹çš„ token è¿›è¡Œæ‹¼æ¥æ”¾è¿› Decoder ä¸­ï¼Œç„¶åå»æœ€åä¸€ä¸ªéšè—çŠ¶æ€ï¼Œå¯¹åº”çš„å°±æ˜¯é¢„æµ‹çš„ä¸‹ä¸€ä¸ª tokenï¼Œç„¶åæŠŠè¿™ä¸ª token åŠ å…¥å¥å­ç»§ç»­ä¸‹ä¸€è½®é¢„æµ‹ã€‚ python def generate(model, input_ids, max_new_tokens, temperature=1.0): model.eval() input_ids = input_ids.clone() for _ in range(max_new_tokens): with torch.no_grad(): logits = model(input_ids) logits = logits[:, -1, :] / temperature # åªå–æœ€åä¸€ä¸ªtoken probs = F.softmax(logits, dim=-1) next_token = torch.multinomial(probs, num_samples=1) input_ids = torch.cat([input_ids, next_token], dim=1) return input_ids å› æ­¤è‡ªå›å½’ç”Ÿæˆä¸­ï¼Œè¿™ç§ä¸²è¡Œè®¡ç®—æ¯æ¬¡è®¡ç®— Q/K/V æ˜¯éå¸¸è€—æ—¶çš„ã€‚ ","date":"2025-12-03","objectID":"/posts/kvcache/:1:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","Transformer"],"title":"KVCache","uri":"/posts/kvcache/#å‰æƒ…æè¦"},{"categories":null,"content":" KVCache çš„ä½œç”¨ ä¸Šå›¾ä¸ºä¸åŠ  KVCache æ—¶å€™æ¨ç†çš„è¿‡ç¨‹ï¼š ç¬¬ä¸€æ¬¡å¾ªç¯è®¡ç®— $QK^T$ å¾—åˆ°äº† â€œä¸­-ä¸­â€ çš„æ³¨æ„åŠ›æƒé‡ ç¬¬äºŒæ¬¡å¾ªç¯è®¡ç®— $QK^T$ åˆé‡å¤è®¡ç®—äº†ä¸€æ¬¡ æ‰€ä»¥ $QK^T$ ä¸­å­˜åœ¨é‡å¤è®¡ç®—ï¼Œå…¶æ¬¡æˆ‘ä»¬ç¬¬äºŒæ¬¡å¾ªç¯å®é™…ä¸Šåªæƒ³è¦å¾—åˆ° â€œäººâ€ å¯¹åº”çš„ tokenï¼Œä½†æ˜¯æŠŠ â€œåâ€ å¯¹åº”çš„ token ä¹Ÿé‡å¤è®¡ç®—äº†ä¸€éã€‚ ä»”ç»†åˆ†æå¾ªç¯çš„è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¯¹äºç¬¬ i è¯å¾ªç¯æˆ‘ä»¬è¦ç”Ÿæˆ $token_i$ï¼Œå®ƒåªéœ€è¦ $QK^T$ è¿™ä¸ªä¸‹ä¸‰è§’çŸ©é˜µçš„æœ€åä¸€è¡Œå’Œ $V$ çŸ©é˜µã€‚å†æ‹†ç»†ä¸€ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦ $Q_i$ å’Œ $K$ çŸ©é˜µç›¸ä¹˜å¾—åˆ°ä¸‹ä¸‰è§’çŸ©é˜µæœ€åä¸€è¡Œè¿˜æœ‰ $V$ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç¼“å­˜ $K$ å’Œ $V$ çŸ©é˜µã€‚ æŠŠè¿™ä¸ªå›¾ä¾‹æ‰©å±•åˆ°ä¸‰ç»´ï¼Œä¹Ÿå°±æ˜¯ [batch_size, seq_len, d_model]çš„è¯ï¼Œå°±æ˜¯åœ¨ seq_len ç»´åº¦ä¸Šè¿›è¡Œç¼“å­˜ã€‚ ","date":"2025-12-03","objectID":"/posts/kvcache/:2:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","Transformer"],"title":"KVCache","uri":"/posts/kvcache/#kvcache-çš„ä½œç”¨"},{"categories":null,"content":" ä»£ç  python class Attention(nn.Module): def __init__(self, d_model: int, num_heads: int): super().__init__() self.d_model = d_model self.num_heads = num_heads self.head_dim = self.d_model // self.num_heads self.W_pack = nn.Linear(self.hidden_size, 3 * self.hidden_size, bias=False) self.o_proj = nn.Linear(self.num_heads * self.head_dim, self.hidden_size, bias=False) def forward( self, hidden_states: torch.Tensor, past_key_value: Optional[Tuple[torch.Tensor]] = None, use_cache: bool = False, ) -\u003e Tuple[torch.Tensor, Optional[torch.Tensor], Optional[Tuple[torch.Tensor]]]: batch_size, seq_len, _ = hidden_states.shape proj = self.W_pack(hidden_states) proj = proj.unflatten(-1, (3, self.hidden_size)).unsqueeze(0).transpose(0, -2).squeeze(-2) query_states = proj[0].view(batch_size, seq_len, self.num_heads, self.head_dim).transpose(1, 2) key_states = proj[1].view(batch_size, seq_len, self.num_heads, self.head_dim).transpose(1,2) value_states = proj[2].view(batch_size, seq_len, self.num_heads, self.head_dim).transpose(1, 2) kv_seq_len = key_states.shape[-2] if past_key_value is not None: # æ›´æ–° kv_seq_len kv_seq_len += past_key_value[0].shape[-2] # åˆå¹¶ kv key_states = torch.cat([past_key_value[0], key_states], dim=2) value_states = torch.cat([past_key_value[1], value_states], dim=2) past_key_value = (key_states, value_states) if use_cache else None attn_weights = torch.matmul(query_states, key_states.transpose(2, 3)) / math.sqrt(self.head_dim) # upcast attention to fp32 attn_weights = nn.functional.softmax(attn_weights, dim=-1, dtype=torch.float32).to(query_states.dtype) attn_output = torch.matmul(attn_weights, value_states) attn_output = attn_output.transpose(1, 2) attn_output = attn_output.reshape(batch_size, seq_len, self.hidden_size) attn_output = self.o_proj(attn_output) return attn_output, attn_weights, past_key_value ç¬¬ä¸€æ¬¡çœ‹è¿™ä¸ªä»£ç æ—¶å€™æˆ‘å¾ˆå¥‡æ€ªï¼Œæ¯æ¬¡éƒ½è®¡ç®— Q/K/V ä¸‰ä¸ªçŸ©é˜µé‚£ Cache åœ¨å“ªï¼Ÿå…¶å®æˆ‘è¿˜æ˜¯æŠŠ Teacher-Forcing å’Œ è‡ªå›å½’ç”Ÿæˆææ··äº†ã€‚ å‡è®¾æœ‰è¾“å…¥ inp å’Œè¾“å‡º tgtï¼š Teacher-Forcingï¼š seq2seq(Encoder-Decoder)ï¼šå°† inp è¾“å…¥åˆ° Encoderï¼Œåœ¨ Decoder éƒ¨åˆ†ç”¨ tgt[, 1:] å½“è¾“å…¥ï¼Œtgt[, :-1] å½“è¾“å‡º GPT(Decoder Only)ï¼šå°† inp[, :-1] å’Œ tgt[, 1:] ä¸€èµ·è¾“å…¥åˆ°æ¨¡å‹ è‡ªå›å½’ç”Ÿæˆï¼šå°† prompt è¾“å…¥åˆ°æ¨¡å‹å¾—åˆ° prompt çš„ hidden_stateï¼Œç„¶åä¼ å…¥æ¨¡å‹å¾—åˆ°ä¸‹ä¸€ä¸ªé¢„æµ‹ token çš„æ¦‚ç‡åˆ†å¸ƒ æ‰€ä»¥å¸¦å…¥è¿™ä¸ªä»£ç ï¼Œç¬¬ä¸€æ¬¡æŠŠæ•´ä¸ª prompt ä¼ è¿›å»ï¼Œç”Ÿæˆ len(prompt) çš„ KVCacheï¼Œå› ä¸º past_key_value=None æ‰€ä»¥æ›´æ–° kv é•¿åº¦å’Œåˆå§‹åŒ–ç¼“å­˜çŸ©é˜µã€‚åé¢å¼€å§‹ï¼Œæ¯ä¸€æ¬¡å¾ªç¯ä¼ å…¥ä¸Šä¸€æ¬¡çš„ hidden_state æ¥é¢„æµ‹ä¸‹ä¸€ä¸ª tokenï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ä¼ å…¥çš„çŸ©é˜µå½¢çŠ¶éƒ½æ˜¯ [batch_size, 1, d_model]ï¼Œå¹¶æ²¡æœ‰é‡å¤è®¡ç®—ã€‚ ","date":"2025-12-03","objectID":"/posts/kvcache/:3:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","Transformer"],"title":"KVCache","uri":"/posts/kvcache/#ä»£ç "},{"categories":null,"content":" Mixed Precision Trainingä»‹ç»æ··åˆç²¾åº¦è®­ç»ƒä¹‹å‰å…ˆå›é¡¾è®¡ç®—æœºç»„æˆåŸç†çš„ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š æµ®ç‚¹æ•°åœ¨è®¡ç®—æœºä¸Šé¢æ˜¯ä»¥ â€œsign + exp + digitsâ€ çš„æ ¼å¼å­˜å‚¨çš„ï¼Œexp çš„å¤§å°å†³å®šäº†æµ®ç‚¹æ•°èŒƒå›´ï¼Œdigits çš„å¤§å°å†³å®šäº†æµ®ç‚¹æ•°çš„ç²¾åº¦ã€‚ åœ¨è®­ç»ƒå¤§å‹ DNN çš„æ—¶å€™ï¼Œå¦‚æœé‡‡ç”¨ FP32 å¾ˆå¯èƒ½é‡åˆ° CUDA å†…å­˜æº¢å‡ºçš„é—®é¢˜ï¼Œè¿™æ—¶å€™å¯ä»¥å°è¯•æŠŠå‚æ•°çš„ç²¾åº¦ä» FP32 è°ƒæˆ FP16ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•ä¹Ÿå­˜åœ¨é—®é¢˜ï¼š å‚æ•°ç²¾åº¦ä¸‹é™å¯¼è‡´æ¨¡å‹æ€§èƒ½ä¸‹é™ï¼ˆå®é™…ä¸Šç²¾åº¦æŸå¤±å½±å“å¾ˆå°ï¼‰ å¦‚æœå‚æ•°å°äº FP16 çš„è¡¨ç¤ºèŒƒå›´å°±ä¼šå˜æˆ 0ï¼Œå¤§äºå°±ä¼šå˜æˆ NANã€‚ ç¬¬äºŒä¸ªé—®é¢˜æ˜¯æœ€ä¸¥é‡çš„ï¼ŒNVIDIA åšå®¢ä¸­çš„ä¸€å¹…å›¾è¡¨ç¤ºåœ¨ FP16 ä¸­è¿™äº›æ¢¯åº¦æ¥è¿‘ä¸€åŠéƒ½ä¼šç›´æ¥è®¾ä¸º 0ã€‚ ä¸€ä¸ªæœ´ç´ çš„æƒ³æ³•å°±æ˜¯ï¼š æ‹·è´æ¨¡å‹çš„ FP32 å‚æ•°ä¸º Master Weight ä¿æŒä¸åŠ¨ å°† FP32 çš„å‚æ•°è½¬ä¸º FP16 ç”¨äºå‰å‘è®¡ç®—å’Œæ¢¯åº¦è®¡ç®— å°†æ¢¯åº¦è½¬ä¸º FP32ï¼Œç”¨æ¥æ›´æ–° Master Weight å¾ªç¯ 1-3 æ­¥ è¿™ä¸ªæƒ³æ³•æ²¡æœ‰è§£å†³æ ¹æœ¬é—®é¢˜ï¼ŒForward å’Œ Backward ç¡®å®é‡‡ç”¨ FP16 å‡å°‘å†…å­˜å ç”¨äº†ï¼Œä½†æ˜¯ç²¾åº¦å˜å°è¿˜æ˜¯å¯èƒ½å¯¼è‡´æ¢¯åº¦å˜æˆ 0ã€‚ å‡è®¾æœ‰ï¼š æ¨¡å‹ï¼šå•å‚æ•°Â wï¼ˆç”¨ FP32 å­˜å‚¨ä¸»å‚æ•°ï¼Œé¿å…ç´¯ç§¯è¯¯å·®ï¼‰ï¼Œåˆå§‹å€¼Â w=0.0000001ï¼› è¾“å…¥Â x=1.0ï¼ŒçœŸå®æ ‡ç­¾Â y=0.000000103ï¼ˆæ•…æ„è®©é¢„æµ‹å€¼å’ŒçœŸå®å€¼æ¥è¿‘ï¼Œåˆ¶é€ å¾®å°æ¢¯åº¦ï¼‰ï¼› æŸå¤±å‡½æ•°ï¼šL = 0.5*(w*x - y)^2ï¼ˆMSE åŠ  0.5 æ˜¯ä¸ºäº†å¯¼æ•°ç®€æ´ï¼‰ï¼› çœŸå®æ¢¯åº¦ï¼šg_true = (w*x - y)*xï¼ˆï¼› é‚£ä¹ˆè®¡ç®—æ¢¯åº¦ $g=(wx-y)x=(0.00000011-000000103)*0.0000001=-3e-8$ï¼Œè¶…è¿‡ FP16 çš„è¡¨ç¤ºèŒƒå›´ï¼Œä¼šç›´æ¥è¡¨ç¤ºä¸º 0ï¼Œå°±æ²¡æ³•æ›´æ–°æ¨¡å‹äº†ã€‚ æ‰€ä»¥æ–°çš„æƒ³æ³•å°±æ˜¯ï¼Œåœ¨è®¡ç®—æ¢¯åº¦ä¹‹å‰ç»™ä»–ä¹˜ä¸€ä¸ªç¼©æ”¾å› å­ï¼Œè¿™æ ·è®¡ç®—å‡ºæ¥å°±åœ¨ FP16 çš„è¡¨ç¤ºèŒƒå›´åªèƒ½ï¼Œç„¶åå˜æˆ FP32 ä¹‹åå†é™¤ä»¥ç¼©æ”¾å› å­å˜å›å»ï¼š æ‹·è´æ¨¡å‹çš„ FP32 å‚æ•°ä¸º Master Weight ä¿æŒä¸åŠ¨ å°† FP32 çš„å‚æ•°è½¬ä¸º FP16 ç”¨äºå‰å‘è®¡ç®— ä¹˜ä¸Šç¼©æ”¾å› å­ï¼Œç„¶åè®¡ç®—æ¢¯åº¦ å°†æ¢¯åº¦è½¬ä¸º FP32ï¼Œé™¤ä»¥ç¼©æ”¾å› å­ï¼Œå†ç”¨æ¥æ›´æ–° Master Weight å¾ªç¯ 1-4 æ­¥ python for epoch in epochs: for inp, tgt in data: optimizer.zero_grad() with auto_cast(device=\"cuda\", dtype=torch.float16): out = model(inp) loss = loss_fn(out, tgt) scaler(loss).backward() scaler.step(optimizer) scaler.update() è¿˜æœ‰ä¸€ç§è§£å†³æ–¹æ³•å°±æ˜¯ç”¨ BF16ï¼ŒBF16 ä¹Ÿæ˜¯ä»¥ 2 å­—èŠ‚å­˜å‚¨ï¼Œä½†æ˜¯å®ƒå°† digits çš„é•¿åº¦å‡å°‘è®©ä½ç»™ expï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒç‰ºç‰²äº†ç²¾åº¦æé«˜äº†è¡¨ç¤ºèŒƒå›´ã€‚ ","date":"2025-12-02","objectID":"/posts/cs224n-lecture12/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 12: Neural Network","uri":"/posts/cs224n-lecture12/#mixed-precision-training"},{"categories":null,"content":" PEFTPEFT æ˜¯ Parameters Efficiently Finetuneï¼Œå‚æ•°é«˜æ•ˆå¾®è°ƒï¼ŒæŒ‡çš„æ˜¯åªæ›´æ–°å‚æ•°é›†çš„ä¸€éƒ¨åˆ†ã€‚ ","date":"2025-12-02","objectID":"/posts/cs224n-lecture12/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 12: Neural Network","uri":"/posts/cs224n-lecture12/#peft"},{"categories":null,"content":" LoRALoRA çš„å®ç°æ€è·¯å°±æ˜¯ç”¨ä½ç§©çŸ©é˜µè¡¨ç¤ºå¢é‡çŸ©é˜µï¼Œç±»ä¼¼è‡ªæ³¨æ„åŠ›æœºåˆ¶é‡Œé¢çš„ Qã€Kã€Vã€‚ å‡è®¾å­˜åœ¨çº¿æ€§å±‚ $y=Wx$ å¹¶ä¸” $W \\in R^{m \\times n}$ ï¼Œé‚£ä¹ˆå¯ä»¥å°†å…¶åˆ†è§£ä¸º $B \\in m \\times r$ å’Œ $A \\in r \\times n$ ï¼š W=BA W = BA W=BA å› æ­¤æˆ‘ä»¬å¯ä»¥å†»ç»“åŸæ¨¡å‹å‚æ•°ä¸å˜ï¼Œä»…å¾®è°ƒ(è®­ç»ƒ)ä½ç§©çŸ©é˜µçš„å‚æ•°ï¼š Y=Wx+BAxÃ—alpha Y = Wx + BAx \\times alpha Y=Wx+BAxÃ—alphaalpha çš„å–å€¼ä¸€èˆ¬ä¸º 1ï¼Œå®ƒå–å†³äºæ˜¯å¦éœ€è¦å¤§å¹…åº¦æ”¹å˜æ¨¡å‹ï¼šå¦‚æœéœ€è¦æ–°å­¦ä¹ çš„çŸ¥è¯†åŸæ¨¡å‹æ²¡è§è¿‡å¯ä»¥è®¾ä¸ºå¤§äº 1 çš„å€¼ã€‚ å®éªŒè¯æ˜å°† LoRA åº”ç”¨äº Qã€V çŸ©é˜µæ•ˆæœæœ€å¥½ã€‚ SVD åˆ†è§£ï¼š ä»»æ„çŸ©é˜µ Î”W éƒ½å¯ä»¥å†™æˆï¼š Î”W=UÎ£VT \\Delta W = U\\Sigma V^T Î”W=UÎ£VT $U \\in n \\times n$ $V \\in m \\times n$ $\\Sigma$ å¥‡å¼‚å€¼å¯¹è§’çŸ©é˜µ é€šè¿‡ä½ç§©è¿‘ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š Î”Wâ‰ˆUrÎ£rVrT \\Delta W \\approx U_r \\Sigma_r V_r^T Î”Wâ‰ˆUrâ€‹Î£râ€‹VrTâ€‹å’Œ LoRA å…¬å¼å¯¹æ¯”å°±æœ‰ï¼š BAâŸ·UrÎ£rVrT BA \\longleftrightarrow U_r \\Sigma_r V_r^T BAâŸ·Urâ€‹Î£râ€‹VrTâ€‹æ‰€ä»¥ LoRA çš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼šåˆ©ç”¨ â€œSVD è¯´æ˜ä½ç§©è¿‘ä¼¼å­˜åœ¨â€ è¿™ä¸ªäº‹å®ï¼Œç”¨ SGD ç›´æ¥åœ¨â€œä½ç§©ç©ºé—´â€é‡Œæ‰¾æœ€ä¼˜è§£ã€‚ Qï¼šæ—¢ç„¶å¯ä»¥é€šè¿‡ SVD åˆ†è§£å¾—åˆ°ä½ç§©çŸ©é˜µä¸ºä»€ä¹ˆè¿˜éœ€è¦ç”¨ B å’Œ A å»å­¦ä¹ å‘¢ï¼Ÿ Aï¼šå› ä¸ºè¿˜å¾—é€šè¿‡ Fulltune å¾—åˆ° $\\Delta W$ ç„¶åå†åˆ†è§£ï¼Œè™½ç„¶å‚æ•°å ç”¨å‡å°‘äº†ï¼Œä½†æ˜¯è®¡ç®—é‡è¿˜å¢åŠ äº†ã€‚ python class LoRALinear(nn.Module): def __init__( self, base_layer: nn.Linear, r: int, alpha: float, dropout: float ): self.rank = r self.in_features = base_layer.in_features self.out_features = base_layer.out_features # æ³¨æ„æ•°å­¦å…¬å¼ä¸­ x éƒ½æ˜¯åˆ—å‘é‡ # ä½†æ˜¯è¿™é‡Œ x.shape = (bsize, len, in_features) # æ‰€ä»¥ y=x*(BA)^T BA.shape = (out_feature, in_feature) if r \u003e 0: self.lora_B = nn.Parameter(torch.zeros(self.out_features, r)) self.lora_A = nn.Parameter(torch.zeros(r, self.in_features)) self.scaling = alpha / r # åˆå§‹åŒ– nn.init.kaiming_normal_(self.lora_A, a=0.001) self.dropout = nn.Dropout(dropout) if r \u003e 0 else nn.Identity() # freeze parameters self.base_layer.weight.requires_grad = False self.base_layer.bias.requires_grad = False def forward(self, x): output = self.base_layer(x) if self.rank \u003e 0: output = output + self.scaling * (x @ (self.lora_B @ self.lora_A).T) return self.dropout(output) LoRA çš„åˆå§‹åŒ– ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ° LoRA å¯¹ Aã€B çŸ©é˜µè¿›è¡Œåˆå§‹åŒ–æ—¶ï¼Œå¯¹ A æ‰ç”¨ kaiming åˆå§‹åŒ–ï¼Œå¯¹ B çŸ©é˜µç›´æ¥åˆå§‹åŒ–ä¸º 0ã€‚ è®©LoRAçš„æ›´æ–° $\\Delta W=BA$ æ¥è¿‘äº 0 çŸ©é˜µï¼Œä»è€Œä¸ç ´åé¢„è®­ç»ƒæƒé‡çš„è¡Œä¸ºã€‚å¦‚æœ B åˆå§‹åŒ–ä¸º 0 â†’ $\\Delta W=0 \\times A$ çŸ©é˜µ, è®­ç»ƒä¸€å¼€å§‹ï¼ŒLoRAç›¸å½“äºæ²¡èµ·ä½œç”¨ï¼Œæ¨¡å‹è¡Œä¸ºå’ŒåŸå§‹é¢„è®­ç»ƒæ¨¡å‹å®Œå…¨ä¸€è‡´ï¼Œéå¸¸ç¨³å®šã€‚ä½†æ˜¯å¦‚æœ A ä¹Ÿåˆå§‹åŒ–ä¸º 0 â†’ æ°¸è¿œéƒ½æ˜¯0ï¼Œæ¢¯åº¦æ›´æ–°ä¸äº†ï¼Œæ‰€ä»¥Aå¿…é¡»æœ‰éšæœºåˆå§‹å€¼ï¼Œè®©æ¢¯åº¦èƒ½æ­£å¸¸å›ä¼ åˆ° Bã€‚ åœ¨å‰å‘ä¼ æ’­ä¸­ï¼Œä½ç§©æ›´æ–°å®é™…èµ°çš„è·¯å¾„æ˜¯ï¼šx â†’ A â†’ (scale) â†’ B ä¸¤ç§ LoRA æ–¹å¼ mergeï¼šè®­ç»ƒå®Œï¼ŒæŠŠ $\\Delta W=BA$ ç›´æ¥åŠ åˆ°åŸå§‹æƒé‡ W ä¸Šã€‚ adapterï¼šè®­ç»ƒå®Œåä»ç„¶æŠŠAã€BçŸ©é˜µå•ç‹¬ä¿å­˜ï¼Œæ¨ç†æ—¶å…ˆåŠ è½½å¤§æ¨¡å‹ï¼Œå†åŠ¨æ€æŠŠ LoRA adapter åŠ è½½è¿›æ¥ã€‚ ","date":"2025-12-02","objectID":"/posts/cs224n-lecture12/:2:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 12: Neural Network","uri":"/posts/cs224n-lecture12/#lora"},{"categories":null,"content":" Post-trainingPost-training ä½äºé¢„è®­ç»ƒä¹‹åï¼Œç›®çš„æ˜¯ä¸ºäº†è®©æ¨¡å‹ æ›´æ‡‚ä»»åŠ¡ã€æ›´å¬æŒ‡ä»¤ã€æ›´ç¬¦åˆäººç±»æ„å›¾ã€‚ Post-training åŒ…å«3ä¸ªæ­¥éª¤ï¼š Finetune RLHF DPO å…¶ä¸­ Finetune åˆåŒ…å« Instruction Finetuningã€LoRAã€Task Finetuning ç­‰ã€‚ ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#post-training"},{"categories":null,"content":" Instruction Finetuningè¿‡å»çš„è®­ç»ƒæ–¹å¼æ˜¯ç”¨å¤§é‡æ•°æ®åœ¨é¢„è®­ç»ƒä¸Šï¼Œç”¨å°‘é‡æ•°æ®å¯¹ç‰¹å®šä»»åŠ¡è¿›è¡Œå¾®è°ƒã€‚ä½†æ˜¯åé¢å‘ç°ç”¨å¤§é‡æ•°æ®åœ¨ä¸åŒä»»åŠ¡ä¸Šè¿›è¡Œåè®­ç»ƒï¼Œç„¶åæ•´åˆåˆ°ä¸€ä¸ª UX ä¸­ã€‚è¿™äº›æŒ‡ä»¤åŒ…å«ä¸åŒçš„ä»»åŠ¡ï¼Œä¾‹å¦‚ Q\u0026Aï¼Œç¿»è¯‘ï¼Œç”Ÿæˆï¼Œæ¨ç†ç­‰ã€‚ ä½†æ˜¯æŒ‡ä»¤å¾®è°ƒçš„å±€é™æ€§ä¹Ÿå¾ˆæ˜æ˜¾ï¼š IF å±äº SFT ä¹Ÿå°±æ˜¯ Supervised Finetuningï¼Œå®ƒçš„æ•°æ®æ”¶é›†æˆæœ¬éå¸¸é«˜ã€‚ å¯¹äºå¼€æ”¾æ€§çš„é—®é¢˜ï¼Œæ²¡æœ‰æ­£ç¡®çš„ç­”æ¡ˆï¼šä¾‹å¦‚ç¿»è¯‘ä»»åŠ¡ï¼Œå°† good ç¿»è¯‘ä¸º\"ä¸€èˆ¬\"å’Œ\"å·®\"ä»£ä»·ä¸€æ ·ï¼Œä½†æ˜¯æ˜æ˜¾ç¿»è¯‘ä¸º\"å·®\"é”™çš„æ›´å¤š ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#instruction-finetuning"},{"categories":null,"content":" RLHFRLHF åŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ æ˜¯ post-training çš„ä¸€ç§æ–¹æ³•ï¼Œå®ƒçš„æ€è·¯æ˜¯é€šè¿‡äººç±»çš„åé¦ˆæ¥ä¼˜åŒ–æ¨¡å‹ã€‚ä½†æ˜¯è¿™ä¸ªæƒ³æ³•å­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š äººåŠ›æˆæœ¬å¾ˆæ˜‚è´µï¼šè§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡æœºå™¨å­¦ä¹ çš„æ–¹æ³•è®­ç»ƒä¸€ä¸ªæ¨¡å‹ï¼Œå¯ä»¥é¢„æµ‹äººä»¬æ›´å€¾å‘äºå“ªä¸€ä¸ªç­”æ¡ˆã€‚ åé¦ˆå¾ˆéš¾é‡åŒ–ï¼šä¾‹å¦‚å¯¹äºç”Ÿæˆä»»åŠ¡ï¼Œå¾ˆéš¾å¯¹ç»“æœè¿›è¡Œæ‰“åˆ†ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯ç”Ÿæˆå¤šä¸ªç»“æœï¼Œç„¶åå¯¹å…¶è¿›è¡Œæ’åºï¼Œrank instead of score ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#rlhf"},{"categories":null,"content":" RL åŸºæœ¬æ¦‚å¿µ å¼ºåŒ–å­¦ä¹ çš„åŸºæœ¬æ€è·¯ï¼š Agent æ ¹æ®çŠ¶æ€ State åšå‡ºè¡Œä¸º Action Action è¿›è€Œå¯¹ç¯å¢ƒäº§ç”Ÿå½±å“ï¼ŒçŠ¶æ€æ›´æ–°å¹¶ä¸”åŸºäº Reward Model ç»™äºˆ Agent å¥–åŠ± Reward Agent æ ¹æ®å¥–åŠ±å’Œæ–°çš„çŠ¶æ€åšå‡ºæ–°çš„è¡Œä¸º æˆ‘ä»¬è°ˆåˆ°äº†å¥–åŠ±å€¼ RewardÂ ï¼Œå®ƒè¡¨ç¤ºç¯å¢ƒè¿›å…¥çŠ¶æ€ State ä¸‹çš„å³æ—¶å¥–åŠ±ã€‚ä½†å¦‚æœåªè€ƒè™‘å³æ—¶å¥–åŠ±ï¼Œç›®å…‰ä¼¼ä¹å¤ªçŸ­æµ…äº†ï¼šå½“ä¸‹çš„çŠ¶æ€å’ŒåŠ¨ä½œä¼šå½±å“åˆ°æœªæ¥çš„çŠ¶æ€å’ŒåŠ¨ä½œï¼Œè¿›è€Œå½±å“åˆ°æœªæ¥çš„æ•´ä½“æ”¶ç›Šã€‚æ‰€ä»¥ï¼Œä¸€ç§æ›´å¥½çš„è®¾è®¡æ–¹å¼æ˜¯ï¼št æ—¶åˆ»çŠ¶æ€ s çš„æ€»æ”¶ç›Š = èº«å¤„çŠ¶æ€ s èƒ½å¸¦æ¥çš„å³æ—¶æ”¶ç›ŠÂ + ä»çŠ¶æ€ s å‡ºå‘åèƒ½å¸¦æ¥çš„æœªæ¥æ”¶ç›Šã€‚ å†™æˆè¡¨è¾¾å¼å°±æ˜¯ï¼š Vt=Rt+Î³Vt+1 V_t=R_t+\\gamma V_{t+1} Vtâ€‹=Rtâ€‹+Î³Vt+1â€‹ $V_t$ æŒ‡ t æ—¶åˆ»ä¹‹åçš„å…¨éƒ¨æ”¶ç›Š $R_t$ æŒ‡ t æ—¶åˆ»å³æ—¶æ”¶ç›Š $V_{t+1}$ æŒ‡ t+1 æ—¶å€™ä¹‹åçš„å…¨éƒ¨æ”¶ç›Š $\\gamma$ æ˜¯æŠ˜æ‰£å› å­ï¼Œå®ƒå†³å®šäº†æˆ‘ä»¬åœ¨å¤šå¤§ç¨‹åº¦ä¸Šè€ƒè™‘å°†â€œæœªæ¥æ”¶ç›Šâ€çº³å…¥â€œå½“ä¸‹æ”¶ç›Š ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:3:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#rl-åŸºæœ¬æ¦‚å¿µ"},{"categories":null,"content":" RL in LLM æˆ‘ä»¬å…ˆå–‚ç»™æ¨¡å‹ä¸€ä¸ª promptï¼ŒæœŸæœ›å®ƒèƒ½äº§å‡ºç¬¦åˆäººç±»å–œå¥½çš„ response åœ¨Â tÂ æ—¶åˆ»ï¼Œæ¨¡å‹æ ¹æ®ä¸Šæ–‡ï¼Œäº§å‡ºä¸€ä¸ªtokenï¼Œè¿™ä¸ªtokenå³å¯¹åº”ç€å¼ºåŒ–å­¦ä¹ ä¸­çš„åŠ¨ä½œï¼Œæˆ‘ä»¬è®°ä¸ºÂ $A_t$ã€‚å› æ­¤ä¸éš¾ç†è§£ï¼Œåœ¨NLPè¯­å¢ƒä¸‹ï¼Œå¼ºåŒ–å­¦ä¹ ä»»åŠ¡çš„åŠ¨ä½œç©ºé—´å°±å¯¹åº”ç€è¯è¡¨ã€‚ åœ¨Â tÂ æ—¶åˆ»ï¼Œæ¨¡å‹äº§å‡º token $A_t$ å¯¹åº”ç€çš„å³æ—¶æ”¶ç›Šä¸º $R_t$ï¼Œæ€»æ”¶ç›Šä¸º $V_t$ã€‚æ­¤åˆ»ï¼Œæ¨¡å‹çš„çŠ¶æ€å˜ä¸º $S_{t+1}$ï¼Œä¹Ÿå°±æ˜¯ä»â€œä¸Šæ–‡â€å˜æˆâ€œä¸Šæ–‡ + æ–°äº§å‡ºçš„tokenâ€ åœ¨NLPè¯­å¢ƒä¸‹ï¼Œæ™ºèƒ½ä½“æ˜¯è¯­è¨€æ¨¡å‹æœ¬èº«ï¼Œç¯å¢ƒåˆ™å¯¹åº”ç€å®ƒäº§å‡ºçš„è¯­æ–™ ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:3:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#rl-in-llm"},{"categories":null,"content":" RLHF ä¸­çš„å››ä¸ªæ¨¡å‹ Actor Modelï¼šæ¼”å‘˜æ¨¡å‹ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦è®­ç»ƒçš„ç›®æ ‡è¯­è¨€æ¨¡å‹ Critic Modelï¼šè¯„è®ºå®¶æ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯é¢„ä¼°æ€»æ”¶ç›ŠÂ $V_t$ Reward Modelï¼šå¥–åŠ±æ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®¡ç®—å³æ—¶æ”¶ç›ŠÂ $R_t$ Reference Modelï¼šå‚è€ƒæ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨RLHFé˜¶æ®µç»™è¯­è¨€æ¨¡å‹å¢åŠ ä¸€äº›â€œçº¦æŸâ€ï¼Œé˜²æ­¢è¯­è¨€æ¨¡å‹è®­æ­ª å…¶ä¸­ Actor Model å’Œ Critical Model éœ€è¦åœ¨ RLHF è¿‡ç¨‹ä¸­å‚ä¸è®­ç»ƒï¼ŒReward Model å’Œ Reference Model ä¸¤ä¸ªæ¨¡å‹éœ€è¦å†»ç»“å‚æ•°ã€‚ Actor ModelActor Model ä¸€èˆ¬ç”¨SFTé˜¶æ®µäº§å‡ºçš„SFTæ¨¡å‹æ¥å¯¹å®ƒåšåˆå§‹åŒ–ã€‚ç­–ç•¥æ˜¯ï¼Œå…ˆå–‚ç»™ Actor ä¸€æ¡ prompt ï¼ˆè¿™é‡Œå‡è®¾batch_size = 1ï¼Œæ‰€ä»¥æ˜¯ 1 æ¡ promptï¼‰ï¼Œè®©å®ƒç”Ÿæˆå¯¹åº”çš„ responseã€‚ç„¶åï¼Œæˆ‘ä»¬å†å°†â€œprompt + response\"é€å…¥æˆ‘ä»¬çš„â€œå¥–åŠ±-lossâ€è®¡ç®—ã€‚ Reference ModelRLHF ä¸­å­˜åœ¨ Reward Hacking è¿™ä¸ªæ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯æ¨¡å‹çŸ¥é“äº†è¯„åˆ†æ ‡å‡†è€Œå»ç›´æ¥å­¦ä¹ æŠ•æœºå–å·§çš„æ–¹æ³•è€Œä¸æ˜¯å­¦ä¹ çŸ¥è¯†ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯é€šè¿‡ Reference Model æ¥è¡¡é‡é¢„è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹å’Œ RLHF å¾®è°ƒä¹‹åæ¨¡å‹çš„å·®å¼‚ï¼Œçº¦æŸ policy ä¸è¦ç¦»æ­£å¸¸è¯­è¨€å¤ªè¿œã€‚ å¯¹ Actor æ¨¡å‹ï¼Œæˆ‘ä»¬å–‚ç»™å®ƒä¸€ä¸ª promptï¼Œå®ƒæ­£å¸¸è¾“å‡ºå¯¹åº”çš„ responseã€‚é‚£ä¹ˆ response ä¸­æ¯ä¸€ä¸ª token è‚¯å®šæœ‰å®ƒå¯¹åº”çš„ log_prob æ¦‚ç‡åˆ†å¸ƒå‘€ï¼Œæˆ‘ä»¬æŠŠè¿™æ ·çš„ç»“æœè®°ä¸º log_probsã€‚ å¯¹ Ref æ¨¡å‹ï¼Œæˆ‘ä»¬æŠŠ Actor ç”Ÿæˆçš„\"prompt + response\"å–‚ç»™å®ƒï¼Œé‚£ä¹ˆå®ƒåŒæ ·èƒ½ç»™å‡ºæ¯ä¸ª token çš„ log_prob ç»“æœï¼Œæˆ‘ä»¬è®°å…¶ä¸ºref_log_probs é‚£ä¹ˆè¿™ä¸¤ä¸ªæ¨¡å‹çš„è¾“å‡ºåˆ†å¸ƒç›¸ä¼¼åº¦å°±å¯ä»¥ç”¨ ref_log_probs - log_probs æ¥è¡¡é‡ï¼Œæˆ‘ä»¬åœ¨åŠ å…¥ KL æ•£åº¦ä½œä¸ºæƒ©ç½šé¡¹å°±å¯ä»¥é¿å…åç¦» Ref å¤ªè¿œã€‚ Rewardâ€²=Rewardâˆ’Î²âˆ—KL Reward'=Reward - \\beta * KL Rewardâ€²=Rewardâˆ’Î²âˆ—KL Ref æ¨¡å‹ä¸€èˆ¬æ˜¯å°† SFT æ¨¡å‹ç›´æ¥å¤åˆ¶åå†»ç»“å‚æ•°ã€‚ KL æ•£åº¦åœ¨ RLHF ä¸­å…·ä½“å¦‚ä½•è®¡ç®—ï¼š å°† prompt è¾“å…¥ actor å¾—åˆ° response å°† â€œprompt+responseâ€ è¾“å‡º actor å¾—åˆ°æ¯ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒ act_log_probs å°† â€œprompt+responseâ€ è¾“å‡º ref å¾—åˆ°æ¯ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒ ref_log_probs æœ€å KL æ•£åº¦å°±æ˜¯å¯¹æ¯ä¸ª token æ¦‚ç‡å·®çš„å¯¹æ•°æ±‚å’Œã€‚ KL=1nâˆ‘responselogâ¡(prob_ref(token))âˆ’logâ¡(prob_act(token)) KL = \\frac{1}{n}\\sum_{response}{\\log{(prob\\_ref(token))-\\log{(prob\\_act(token))}}} KL=n1â€‹responseâˆ‘â€‹log(prob_ref(token))âˆ’log(prob_act(token)) KL æ•£åº¦çš„æ ‡å‡†å®šä¹‰åº”è¯¥æ˜¯ï¼Œå¯¹äºå•ä¸ª token çš„ KL æ•£åº¦æ˜¯è¦å¯¹ vocab ä¸Šæ¯ä¸€ä¸ª tokenéƒ½æ±‚æ¦‚ç‡å’ŒåŠ æƒæ±‚å’Œã€‚ä½†æ˜¯åœ¨ RLHF å®é™…å®ç°ä¸­ï¼Œtoken çº§ KL åªé’ˆå¯¹ Actor å®é™…ç”Ÿæˆå‡ºæ¥çš„ response[t] tokenï¼Œè®¡ç®— log p_actor(response[t]) âˆ’ log p_ref(response[t]) ä¸¾ä¸ªä¾‹å­ï¼š prompt=â€œi likeâ€ è¾“å…¥åˆ° actor å¾—åˆ° response â€œyou very muchâ€ å°† â€œi like you very muchâ€ è¾“å…¥ actor æ±‚æ¦‚ç‡åˆ†å¸ƒï¼Œè¿™é‡Œç”¨çš„æ˜¯ Teacher-Forcing å…ˆå‰å‘è®°å½•ç¬¬ä¸€ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒï¼Œå°† input=prompt ç»è¿‡ forward å°±èƒ½å¾—åˆ° response_0 çš„æ¦‚ç‡åˆ†å¸ƒã€‚ input=prompt+r0ï¼Œç»è¿‡å‰å‘è®¡ç®—å¾—åˆ° response_1 çš„æ¦‚ç‡åˆ†å¸ƒ ç±»ä¼¼çš„å°† â€œi like you very muchâ€ è¾“å…¥åˆ° ref å¾—åˆ°æ¦‚ç‡åˆ†å¸ƒ ä½ç½® t è¦é¢„æµ‹çš„ token Reference Model çš„æ¦‚ç‡åˆ†å¸ƒ p_ref(.) Actorï¼ˆå½“å‰ policyï¼‰çš„æ¦‚ç‡åˆ†å¸ƒ p_actor(.) 1 you p_ref(you)=0.40, i=0.25, like=0.10, â€¦ p_actor(you)=0.75, I=0.05, like=0.12, â€¦ 2 very p_ref(very)=0.35, â€¦ p_actor(very)=0.60, â€¦ 3 much p_ref(much)=0.70, â€¦ p_actor(much)=0.85, â€¦ 4 \u003ceos\u003e p_ref(\u003ceos\u003e)=0.90, â€¦ p_actor(\u003ceos\u003e)=0.92, â€¦ å¯¹æ¯ä¸ª response token tï¼Œè®¡ç®—å• token çš„ KL æ•£åº¦ ä½ç½® t è¦é¢„æµ‹çš„ token KL_t 1 you â‰ˆlog(0.75)-log(0.4) 2 very â€¦ 3 much â€¦ 4 \u003ceos\u003e â€¦ Critical Model Qï¼šè®­ç»ƒActoræ¨¡å‹æˆ‘èƒ½ç†è§£ï¼Œä½†æˆ‘è¿˜æ˜¯ä¸æ˜ç™½ï¼Œä¸ºä»€ä¹ˆè¦å•ç‹¬è®­ç»ƒä¸€ä¸ª Critic æ¨¡å‹ç”¨äºé¢„æµ‹æ”¶ç›Šå‘¢ï¼Ÿ Aï¼šè¿™æ˜¯å› ä¸ºï¼Œå½“æˆ‘ä»¬åœ¨å‰æ–‡è®¨è®ºæ€»æ”¶ç›Šï¼ˆå³æ—¶ + æœªæ¥ï¼‰æ—¶ï¼Œæˆ‘ä»¬æ˜¯ç«™åœ¨ä¸Šå¸è§†è§’çš„ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªÂ $V_t$ å°±æ˜¯å®¢è§‚å­˜åœ¨çš„ã€çœŸæ­£çš„æ€»æ”¶ç›Šã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œå°±æ²¡æœ‰è¿™ä¸ªä¸Šå¸è§†è§’åŠ æˆäº†ï¼Œä¹Ÿå°±æ˜¯åœ¨Â tÂ æ—¶åˆ»ï¼Œæˆ‘ä»¬ç»™ä¸å‡ºå®¢è§‚å­˜åœ¨çš„æ€»æ”¶ç›Š $V_t$ï¼Œæˆ‘ä»¬åªèƒ½è®­ç»ƒä¸€ä¸ªæ¨¡å‹å»é¢„æµ‹å®ƒã€‚ ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:3:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#rlhf-ä¸­çš„å››ä¸ªæ¨¡å‹"},{"categories":null,"content":" RLHF ä¸­çš„å››ä¸ªæ¨¡å‹ Actor Modelï¼šæ¼”å‘˜æ¨¡å‹ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦è®­ç»ƒçš„ç›®æ ‡è¯­è¨€æ¨¡å‹ Critic Modelï¼šè¯„è®ºå®¶æ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯é¢„ä¼°æ€»æ”¶ç›ŠÂ $V_t$ Reward Modelï¼šå¥–åŠ±æ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®¡ç®—å³æ—¶æ”¶ç›ŠÂ $R_t$ Reference Modelï¼šå‚è€ƒæ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨RLHFé˜¶æ®µç»™è¯­è¨€æ¨¡å‹å¢åŠ ä¸€äº›â€œçº¦æŸâ€ï¼Œé˜²æ­¢è¯­è¨€æ¨¡å‹è®­æ­ª å…¶ä¸­ Actor Model å’Œ Critical Model éœ€è¦åœ¨ RLHF è¿‡ç¨‹ä¸­å‚ä¸è®­ç»ƒï¼ŒReward Model å’Œ Reference Model ä¸¤ä¸ªæ¨¡å‹éœ€è¦å†»ç»“å‚æ•°ã€‚ Actor ModelActor Model ä¸€èˆ¬ç”¨SFTé˜¶æ®µäº§å‡ºçš„SFTæ¨¡å‹æ¥å¯¹å®ƒåšåˆå§‹åŒ–ã€‚ç­–ç•¥æ˜¯ï¼Œå…ˆå–‚ç»™ Actor ä¸€æ¡ prompt ï¼ˆè¿™é‡Œå‡è®¾batch_size = 1ï¼Œæ‰€ä»¥æ˜¯ 1 æ¡ promptï¼‰ï¼Œè®©å®ƒç”Ÿæˆå¯¹åº”çš„ responseã€‚ç„¶åï¼Œæˆ‘ä»¬å†å°†â€œprompt + response\"é€å…¥æˆ‘ä»¬çš„â€œå¥–åŠ±-lossâ€è®¡ç®—ã€‚ Reference ModelRLHF ä¸­å­˜åœ¨ Reward Hacking è¿™ä¸ªæ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯æ¨¡å‹çŸ¥é“äº†è¯„åˆ†æ ‡å‡†è€Œå»ç›´æ¥å­¦ä¹ æŠ•æœºå–å·§çš„æ–¹æ³•è€Œä¸æ˜¯å­¦ä¹ çŸ¥è¯†ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯é€šè¿‡ Reference Model æ¥è¡¡é‡é¢„è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹å’Œ RLHF å¾®è°ƒä¹‹åæ¨¡å‹çš„å·®å¼‚ï¼Œçº¦æŸ policy ä¸è¦ç¦»æ­£å¸¸è¯­è¨€å¤ªè¿œã€‚ å¯¹ Actor æ¨¡å‹ï¼Œæˆ‘ä»¬å–‚ç»™å®ƒä¸€ä¸ª promptï¼Œå®ƒæ­£å¸¸è¾“å‡ºå¯¹åº”çš„ responseã€‚é‚£ä¹ˆ response ä¸­æ¯ä¸€ä¸ª token è‚¯å®šæœ‰å®ƒå¯¹åº”çš„ log_prob æ¦‚ç‡åˆ†å¸ƒå‘€ï¼Œæˆ‘ä»¬æŠŠè¿™æ ·çš„ç»“æœè®°ä¸º log_probsã€‚ å¯¹ Ref æ¨¡å‹ï¼Œæˆ‘ä»¬æŠŠ Actor ç”Ÿæˆçš„\"prompt + response\"å–‚ç»™å®ƒï¼Œé‚£ä¹ˆå®ƒåŒæ ·èƒ½ç»™å‡ºæ¯ä¸ª token çš„ log_prob ç»“æœï¼Œæˆ‘ä»¬è®°å…¶ä¸ºref_log_probs é‚£ä¹ˆè¿™ä¸¤ä¸ªæ¨¡å‹çš„è¾“å‡ºåˆ†å¸ƒç›¸ä¼¼åº¦å°±å¯ä»¥ç”¨ ref_log_probs - log_probs æ¥è¡¡é‡ï¼Œæˆ‘ä»¬åœ¨åŠ å…¥ KL æ•£åº¦ä½œä¸ºæƒ©ç½šé¡¹å°±å¯ä»¥é¿å…åç¦» Ref å¤ªè¿œã€‚ Rewardâ€²=Rewardâˆ’Î²âˆ—KL Reward'=Reward - \\beta * KL Rewardâ€²=Rewardâˆ’Î²âˆ—KL Ref æ¨¡å‹ä¸€èˆ¬æ˜¯å°† SFT æ¨¡å‹ç›´æ¥å¤åˆ¶åå†»ç»“å‚æ•°ã€‚ KL æ•£åº¦åœ¨ RLHF ä¸­å…·ä½“å¦‚ä½•è®¡ç®—ï¼š å°† prompt è¾“å…¥ actor å¾—åˆ° response å°† â€œprompt+responseâ€ è¾“å‡º actor å¾—åˆ°æ¯ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒ act_log_probs å°† â€œprompt+responseâ€ è¾“å‡º ref å¾—åˆ°æ¯ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒ ref_log_probs æœ€å KL æ•£åº¦å°±æ˜¯å¯¹æ¯ä¸ª token æ¦‚ç‡å·®çš„å¯¹æ•°æ±‚å’Œã€‚ KL=1nâˆ‘responselogâ¡(prob_ref(token))âˆ’logâ¡(prob_act(token)) KL = \\frac{1}{n}\\sum_{response}{\\log{(prob\\_ref(token))-\\log{(prob\\_act(token))}}} KL=n1â€‹responseâˆ‘â€‹log(prob_ref(token))âˆ’log(prob_act(token)) KL æ•£åº¦çš„æ ‡å‡†å®šä¹‰åº”è¯¥æ˜¯ï¼Œå¯¹äºå•ä¸ª token çš„ KL æ•£åº¦æ˜¯è¦å¯¹ vocab ä¸Šæ¯ä¸€ä¸ª tokenéƒ½æ±‚æ¦‚ç‡å’ŒåŠ æƒæ±‚å’Œã€‚ä½†æ˜¯åœ¨ RLHF å®é™…å®ç°ä¸­ï¼Œtoken çº§ KL åªé’ˆå¯¹ Actor å®é™…ç”Ÿæˆå‡ºæ¥çš„ response[t] tokenï¼Œè®¡ç®— log p_actor(response[t]) âˆ’ log p_ref(response[t]) ä¸¾ä¸ªä¾‹å­ï¼š prompt=â€œi likeâ€ è¾“å…¥åˆ° actor å¾—åˆ° response â€œyou very muchâ€ å°† â€œi like you very muchâ€ è¾“å…¥ actor æ±‚æ¦‚ç‡åˆ†å¸ƒï¼Œè¿™é‡Œç”¨çš„æ˜¯ Teacher-Forcing å…ˆå‰å‘è®°å½•ç¬¬ä¸€ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒï¼Œå°† input=prompt ç»è¿‡ forward å°±èƒ½å¾—åˆ° response_0 çš„æ¦‚ç‡åˆ†å¸ƒã€‚ input=prompt+r0ï¼Œç»è¿‡å‰å‘è®¡ç®—å¾—åˆ° response_1 çš„æ¦‚ç‡åˆ†å¸ƒ ç±»ä¼¼çš„å°† â€œi like you very muchâ€ è¾“å…¥åˆ° ref å¾—åˆ°æ¦‚ç‡åˆ†å¸ƒ ä½ç½® t è¦é¢„æµ‹çš„ token Reference Model çš„æ¦‚ç‡åˆ†å¸ƒ p_ref(.) Actorï¼ˆå½“å‰ policyï¼‰çš„æ¦‚ç‡åˆ†å¸ƒ p_actor(.) 1 you p_ref(you)=0.40, i=0.25, like=0.10, â€¦ p_actor(you)=0.75, I=0.05, like=0.12, â€¦ 2 very p_ref(very)=0.35, â€¦ p_actor(very)=0.60, â€¦ 3 much p_ref(much)=0.70, â€¦ p_actor(much)=0.85, â€¦ 4 p_ref()=0.90, â€¦ p_actor()=0.92, â€¦ å¯¹æ¯ä¸ª response token tï¼Œè®¡ç®—å• token çš„ KL æ•£åº¦ ä½ç½® t è¦é¢„æµ‹çš„ token KL_t 1 you â‰ˆlog(0.75)-log(0.4) 2 very â€¦ 3 much â€¦ 4 â€¦ Critical Model Qï¼šè®­ç»ƒActoræ¨¡å‹æˆ‘èƒ½ç†è§£ï¼Œä½†æˆ‘è¿˜æ˜¯ä¸æ˜ç™½ï¼Œä¸ºä»€ä¹ˆè¦å•ç‹¬è®­ç»ƒä¸€ä¸ª Critic æ¨¡å‹ç”¨äºé¢„æµ‹æ”¶ç›Šå‘¢ï¼Ÿ Aï¼šè¿™æ˜¯å› ä¸ºï¼Œå½“æˆ‘ä»¬åœ¨å‰æ–‡è®¨è®ºæ€»æ”¶ç›Šï¼ˆå³æ—¶ + æœªæ¥ï¼‰æ—¶ï¼Œæˆ‘ä»¬æ˜¯ç«™åœ¨ä¸Šå¸è§†è§’çš„ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªÂ $V_t$ å°±æ˜¯å®¢è§‚å­˜åœ¨çš„ã€çœŸæ­£çš„æ€»æ”¶ç›Šã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œå°±æ²¡æœ‰è¿™ä¸ªä¸Šå¸è§†è§’åŠ æˆäº†ï¼Œä¹Ÿå°±æ˜¯åœ¨Â tÂ æ—¶åˆ»ï¼Œæˆ‘ä»¬ç»™ä¸å‡ºå®¢è§‚å­˜åœ¨çš„æ€»æ”¶ç›Š $V_t$ï¼Œæˆ‘ä»¬åªèƒ½è®­ç»ƒä¸€ä¸ªæ¨¡å‹å»é¢„æµ‹å®ƒã€‚ ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:3:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#actor-model"},{"categories":null,"content":" RLHF ä¸­çš„å››ä¸ªæ¨¡å‹ Actor Modelï¼šæ¼”å‘˜æ¨¡å‹ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦è®­ç»ƒçš„ç›®æ ‡è¯­è¨€æ¨¡å‹ Critic Modelï¼šè¯„è®ºå®¶æ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯é¢„ä¼°æ€»æ”¶ç›ŠÂ $V_t$ Reward Modelï¼šå¥–åŠ±æ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®¡ç®—å³æ—¶æ”¶ç›ŠÂ $R_t$ Reference Modelï¼šå‚è€ƒæ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨RLHFé˜¶æ®µç»™è¯­è¨€æ¨¡å‹å¢åŠ ä¸€äº›â€œçº¦æŸâ€ï¼Œé˜²æ­¢è¯­è¨€æ¨¡å‹è®­æ­ª å…¶ä¸­ Actor Model å’Œ Critical Model éœ€è¦åœ¨ RLHF è¿‡ç¨‹ä¸­å‚ä¸è®­ç»ƒï¼ŒReward Model å’Œ Reference Model ä¸¤ä¸ªæ¨¡å‹éœ€è¦å†»ç»“å‚æ•°ã€‚ Actor ModelActor Model ä¸€èˆ¬ç”¨SFTé˜¶æ®µäº§å‡ºçš„SFTæ¨¡å‹æ¥å¯¹å®ƒåšåˆå§‹åŒ–ã€‚ç­–ç•¥æ˜¯ï¼Œå…ˆå–‚ç»™ Actor ä¸€æ¡ prompt ï¼ˆè¿™é‡Œå‡è®¾batch_size = 1ï¼Œæ‰€ä»¥æ˜¯ 1 æ¡ promptï¼‰ï¼Œè®©å®ƒç”Ÿæˆå¯¹åº”çš„ responseã€‚ç„¶åï¼Œæˆ‘ä»¬å†å°†â€œprompt + response\"é€å…¥æˆ‘ä»¬çš„â€œå¥–åŠ±-lossâ€è®¡ç®—ã€‚ Reference ModelRLHF ä¸­å­˜åœ¨ Reward Hacking è¿™ä¸ªæ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯æ¨¡å‹çŸ¥é“äº†è¯„åˆ†æ ‡å‡†è€Œå»ç›´æ¥å­¦ä¹ æŠ•æœºå–å·§çš„æ–¹æ³•è€Œä¸æ˜¯å­¦ä¹ çŸ¥è¯†ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯é€šè¿‡ Reference Model æ¥è¡¡é‡é¢„è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹å’Œ RLHF å¾®è°ƒä¹‹åæ¨¡å‹çš„å·®å¼‚ï¼Œçº¦æŸ policy ä¸è¦ç¦»æ­£å¸¸è¯­è¨€å¤ªè¿œã€‚ å¯¹ Actor æ¨¡å‹ï¼Œæˆ‘ä»¬å–‚ç»™å®ƒä¸€ä¸ª promptï¼Œå®ƒæ­£å¸¸è¾“å‡ºå¯¹åº”çš„ responseã€‚é‚£ä¹ˆ response ä¸­æ¯ä¸€ä¸ª token è‚¯å®šæœ‰å®ƒå¯¹åº”çš„ log_prob æ¦‚ç‡åˆ†å¸ƒå‘€ï¼Œæˆ‘ä»¬æŠŠè¿™æ ·çš„ç»“æœè®°ä¸º log_probsã€‚ å¯¹ Ref æ¨¡å‹ï¼Œæˆ‘ä»¬æŠŠ Actor ç”Ÿæˆçš„\"prompt + response\"å–‚ç»™å®ƒï¼Œé‚£ä¹ˆå®ƒåŒæ ·èƒ½ç»™å‡ºæ¯ä¸ª token çš„ log_prob ç»“æœï¼Œæˆ‘ä»¬è®°å…¶ä¸ºref_log_probs é‚£ä¹ˆè¿™ä¸¤ä¸ªæ¨¡å‹çš„è¾“å‡ºåˆ†å¸ƒç›¸ä¼¼åº¦å°±å¯ä»¥ç”¨ ref_log_probs - log_probs æ¥è¡¡é‡ï¼Œæˆ‘ä»¬åœ¨åŠ å…¥ KL æ•£åº¦ä½œä¸ºæƒ©ç½šé¡¹å°±å¯ä»¥é¿å…åç¦» Ref å¤ªè¿œã€‚ Rewardâ€²=Rewardâˆ’Î²âˆ—KL Reward'=Reward - \\beta * KL Rewardâ€²=Rewardâˆ’Î²âˆ—KL Ref æ¨¡å‹ä¸€èˆ¬æ˜¯å°† SFT æ¨¡å‹ç›´æ¥å¤åˆ¶åå†»ç»“å‚æ•°ã€‚ KL æ•£åº¦åœ¨ RLHF ä¸­å…·ä½“å¦‚ä½•è®¡ç®—ï¼š å°† prompt è¾“å…¥ actor å¾—åˆ° response å°† â€œprompt+responseâ€ è¾“å‡º actor å¾—åˆ°æ¯ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒ act_log_probs å°† â€œprompt+responseâ€ è¾“å‡º ref å¾—åˆ°æ¯ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒ ref_log_probs æœ€å KL æ•£åº¦å°±æ˜¯å¯¹æ¯ä¸ª token æ¦‚ç‡å·®çš„å¯¹æ•°æ±‚å’Œã€‚ KL=1nâˆ‘responselogâ¡(prob_ref(token))âˆ’logâ¡(prob_act(token)) KL = \\frac{1}{n}\\sum_{response}{\\log{(prob\\_ref(token))-\\log{(prob\\_act(token))}}} KL=n1â€‹responseâˆ‘â€‹log(prob_ref(token))âˆ’log(prob_act(token)) KL æ•£åº¦çš„æ ‡å‡†å®šä¹‰åº”è¯¥æ˜¯ï¼Œå¯¹äºå•ä¸ª token çš„ KL æ•£åº¦æ˜¯è¦å¯¹ vocab ä¸Šæ¯ä¸€ä¸ª tokenéƒ½æ±‚æ¦‚ç‡å’ŒåŠ æƒæ±‚å’Œã€‚ä½†æ˜¯åœ¨ RLHF å®é™…å®ç°ä¸­ï¼Œtoken çº§ KL åªé’ˆå¯¹ Actor å®é™…ç”Ÿæˆå‡ºæ¥çš„ response[t] tokenï¼Œè®¡ç®— log p_actor(response[t]) âˆ’ log p_ref(response[t]) ä¸¾ä¸ªä¾‹å­ï¼š prompt=â€œi likeâ€ è¾“å…¥åˆ° actor å¾—åˆ° response â€œyou very muchâ€ å°† â€œi like you very muchâ€ è¾“å…¥ actor æ±‚æ¦‚ç‡åˆ†å¸ƒï¼Œè¿™é‡Œç”¨çš„æ˜¯ Teacher-Forcing å…ˆå‰å‘è®°å½•ç¬¬ä¸€ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒï¼Œå°† input=prompt ç»è¿‡ forward å°±èƒ½å¾—åˆ° response_0 çš„æ¦‚ç‡åˆ†å¸ƒã€‚ input=prompt+r0ï¼Œç»è¿‡å‰å‘è®¡ç®—å¾—åˆ° response_1 çš„æ¦‚ç‡åˆ†å¸ƒ ç±»ä¼¼çš„å°† â€œi like you very muchâ€ è¾“å…¥åˆ° ref å¾—åˆ°æ¦‚ç‡åˆ†å¸ƒ ä½ç½® t è¦é¢„æµ‹çš„ token Reference Model çš„æ¦‚ç‡åˆ†å¸ƒ p_ref(.) Actorï¼ˆå½“å‰ policyï¼‰çš„æ¦‚ç‡åˆ†å¸ƒ p_actor(.) 1 you p_ref(you)=0.40, i=0.25, like=0.10, â€¦ p_actor(you)=0.75, I=0.05, like=0.12, â€¦ 2 very p_ref(very)=0.35, â€¦ p_actor(very)=0.60, â€¦ 3 much p_ref(much)=0.70, â€¦ p_actor(much)=0.85, â€¦ 4 p_ref()=0.90, â€¦ p_actor()=0.92, â€¦ å¯¹æ¯ä¸ª response token tï¼Œè®¡ç®—å• token çš„ KL æ•£åº¦ ä½ç½® t è¦é¢„æµ‹çš„ token KL_t 1 you â‰ˆlog(0.75)-log(0.4) 2 very â€¦ 3 much â€¦ 4 â€¦ Critical Model Qï¼šè®­ç»ƒActoræ¨¡å‹æˆ‘èƒ½ç†è§£ï¼Œä½†æˆ‘è¿˜æ˜¯ä¸æ˜ç™½ï¼Œä¸ºä»€ä¹ˆè¦å•ç‹¬è®­ç»ƒä¸€ä¸ª Critic æ¨¡å‹ç”¨äºé¢„æµ‹æ”¶ç›Šå‘¢ï¼Ÿ Aï¼šè¿™æ˜¯å› ä¸ºï¼Œå½“æˆ‘ä»¬åœ¨å‰æ–‡è®¨è®ºæ€»æ”¶ç›Šï¼ˆå³æ—¶ + æœªæ¥ï¼‰æ—¶ï¼Œæˆ‘ä»¬æ˜¯ç«™åœ¨ä¸Šå¸è§†è§’çš„ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªÂ $V_t$ å°±æ˜¯å®¢è§‚å­˜åœ¨çš„ã€çœŸæ­£çš„æ€»æ”¶ç›Šã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œå°±æ²¡æœ‰è¿™ä¸ªä¸Šå¸è§†è§’åŠ æˆäº†ï¼Œä¹Ÿå°±æ˜¯åœ¨Â tÂ æ—¶åˆ»ï¼Œæˆ‘ä»¬ç»™ä¸å‡ºå®¢è§‚å­˜åœ¨çš„æ€»æ”¶ç›Š $V_t$ï¼Œæˆ‘ä»¬åªèƒ½è®­ç»ƒä¸€ä¸ªæ¨¡å‹å»é¢„æµ‹å®ƒã€‚ ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:3:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#reference-model"},{"categories":null,"content":" RLHF ä¸­çš„å››ä¸ªæ¨¡å‹ Actor Modelï¼šæ¼”å‘˜æ¨¡å‹ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦è®­ç»ƒçš„ç›®æ ‡è¯­è¨€æ¨¡å‹ Critic Modelï¼šè¯„è®ºå®¶æ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯é¢„ä¼°æ€»æ”¶ç›ŠÂ $V_t$ Reward Modelï¼šå¥–åŠ±æ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®¡ç®—å³æ—¶æ”¶ç›ŠÂ $R_t$ Reference Modelï¼šå‚è€ƒæ¨¡å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨RLHFé˜¶æ®µç»™è¯­è¨€æ¨¡å‹å¢åŠ ä¸€äº›â€œçº¦æŸâ€ï¼Œé˜²æ­¢è¯­è¨€æ¨¡å‹è®­æ­ª å…¶ä¸­ Actor Model å’Œ Critical Model éœ€è¦åœ¨ RLHF è¿‡ç¨‹ä¸­å‚ä¸è®­ç»ƒï¼ŒReward Model å’Œ Reference Model ä¸¤ä¸ªæ¨¡å‹éœ€è¦å†»ç»“å‚æ•°ã€‚ Actor ModelActor Model ä¸€èˆ¬ç”¨SFTé˜¶æ®µäº§å‡ºçš„SFTæ¨¡å‹æ¥å¯¹å®ƒåšåˆå§‹åŒ–ã€‚ç­–ç•¥æ˜¯ï¼Œå…ˆå–‚ç»™ Actor ä¸€æ¡ prompt ï¼ˆè¿™é‡Œå‡è®¾batch_size = 1ï¼Œæ‰€ä»¥æ˜¯ 1 æ¡ promptï¼‰ï¼Œè®©å®ƒç”Ÿæˆå¯¹åº”çš„ responseã€‚ç„¶åï¼Œæˆ‘ä»¬å†å°†â€œprompt + response\"é€å…¥æˆ‘ä»¬çš„â€œå¥–åŠ±-lossâ€è®¡ç®—ã€‚ Reference ModelRLHF ä¸­å­˜åœ¨ Reward Hacking è¿™ä¸ªæ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯æ¨¡å‹çŸ¥é“äº†è¯„åˆ†æ ‡å‡†è€Œå»ç›´æ¥å­¦ä¹ æŠ•æœºå–å·§çš„æ–¹æ³•è€Œä¸æ˜¯å­¦ä¹ çŸ¥è¯†ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯é€šè¿‡ Reference Model æ¥è¡¡é‡é¢„è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹å’Œ RLHF å¾®è°ƒä¹‹åæ¨¡å‹çš„å·®å¼‚ï¼Œçº¦æŸ policy ä¸è¦ç¦»æ­£å¸¸è¯­è¨€å¤ªè¿œã€‚ å¯¹ Actor æ¨¡å‹ï¼Œæˆ‘ä»¬å–‚ç»™å®ƒä¸€ä¸ª promptï¼Œå®ƒæ­£å¸¸è¾“å‡ºå¯¹åº”çš„ responseã€‚é‚£ä¹ˆ response ä¸­æ¯ä¸€ä¸ª token è‚¯å®šæœ‰å®ƒå¯¹åº”çš„ log_prob æ¦‚ç‡åˆ†å¸ƒå‘€ï¼Œæˆ‘ä»¬æŠŠè¿™æ ·çš„ç»“æœè®°ä¸º log_probsã€‚ å¯¹ Ref æ¨¡å‹ï¼Œæˆ‘ä»¬æŠŠ Actor ç”Ÿæˆçš„\"prompt + response\"å–‚ç»™å®ƒï¼Œé‚£ä¹ˆå®ƒåŒæ ·èƒ½ç»™å‡ºæ¯ä¸ª token çš„ log_prob ç»“æœï¼Œæˆ‘ä»¬è®°å…¶ä¸ºref_log_probs é‚£ä¹ˆè¿™ä¸¤ä¸ªæ¨¡å‹çš„è¾“å‡ºåˆ†å¸ƒç›¸ä¼¼åº¦å°±å¯ä»¥ç”¨ ref_log_probs - log_probs æ¥è¡¡é‡ï¼Œæˆ‘ä»¬åœ¨åŠ å…¥ KL æ•£åº¦ä½œä¸ºæƒ©ç½šé¡¹å°±å¯ä»¥é¿å…åç¦» Ref å¤ªè¿œã€‚ Rewardâ€²=Rewardâˆ’Î²âˆ—KL Reward'=Reward - \\beta * KL Rewardâ€²=Rewardâˆ’Î²âˆ—KL Ref æ¨¡å‹ä¸€èˆ¬æ˜¯å°† SFT æ¨¡å‹ç›´æ¥å¤åˆ¶åå†»ç»“å‚æ•°ã€‚ KL æ•£åº¦åœ¨ RLHF ä¸­å…·ä½“å¦‚ä½•è®¡ç®—ï¼š å°† prompt è¾“å…¥ actor å¾—åˆ° response å°† â€œprompt+responseâ€ è¾“å‡º actor å¾—åˆ°æ¯ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒ act_log_probs å°† â€œprompt+responseâ€ è¾“å‡º ref å¾—åˆ°æ¯ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒ ref_log_probs æœ€å KL æ•£åº¦å°±æ˜¯å¯¹æ¯ä¸ª token æ¦‚ç‡å·®çš„å¯¹æ•°æ±‚å’Œã€‚ KL=1nâˆ‘responselogâ¡(prob_ref(token))âˆ’logâ¡(prob_act(token)) KL = \\frac{1}{n}\\sum_{response}{\\log{(prob\\_ref(token))-\\log{(prob\\_act(token))}}} KL=n1â€‹responseâˆ‘â€‹log(prob_ref(token))âˆ’log(prob_act(token)) KL æ•£åº¦çš„æ ‡å‡†å®šä¹‰åº”è¯¥æ˜¯ï¼Œå¯¹äºå•ä¸ª token çš„ KL æ•£åº¦æ˜¯è¦å¯¹ vocab ä¸Šæ¯ä¸€ä¸ª tokenéƒ½æ±‚æ¦‚ç‡å’ŒåŠ æƒæ±‚å’Œã€‚ä½†æ˜¯åœ¨ RLHF å®é™…å®ç°ä¸­ï¼Œtoken çº§ KL åªé’ˆå¯¹ Actor å®é™…ç”Ÿæˆå‡ºæ¥çš„ response[t] tokenï¼Œè®¡ç®— log p_actor(response[t]) âˆ’ log p_ref(response[t]) ä¸¾ä¸ªä¾‹å­ï¼š prompt=â€œi likeâ€ è¾“å…¥åˆ° actor å¾—åˆ° response â€œyou very muchâ€ å°† â€œi like you very muchâ€ è¾“å…¥ actor æ±‚æ¦‚ç‡åˆ†å¸ƒï¼Œè¿™é‡Œç”¨çš„æ˜¯ Teacher-Forcing å…ˆå‰å‘è®°å½•ç¬¬ä¸€ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒï¼Œå°† input=prompt ç»è¿‡ forward å°±èƒ½å¾—åˆ° response_0 çš„æ¦‚ç‡åˆ†å¸ƒã€‚ input=prompt+r0ï¼Œç»è¿‡å‰å‘è®¡ç®—å¾—åˆ° response_1 çš„æ¦‚ç‡åˆ†å¸ƒ ç±»ä¼¼çš„å°† â€œi like you very muchâ€ è¾“å…¥åˆ° ref å¾—åˆ°æ¦‚ç‡åˆ†å¸ƒ ä½ç½® t è¦é¢„æµ‹çš„ token Reference Model çš„æ¦‚ç‡åˆ†å¸ƒ p_ref(.) Actorï¼ˆå½“å‰ policyï¼‰çš„æ¦‚ç‡åˆ†å¸ƒ p_actor(.) 1 you p_ref(you)=0.40, i=0.25, like=0.10, â€¦ p_actor(you)=0.75, I=0.05, like=0.12, â€¦ 2 very p_ref(very)=0.35, â€¦ p_actor(very)=0.60, â€¦ 3 much p_ref(much)=0.70, â€¦ p_actor(much)=0.85, â€¦ 4 p_ref()=0.90, â€¦ p_actor()=0.92, â€¦ å¯¹æ¯ä¸ª response token tï¼Œè®¡ç®—å• token çš„ KL æ•£åº¦ ä½ç½® t è¦é¢„æµ‹çš„ token KL_t 1 you â‰ˆlog(0.75)-log(0.4) 2 very â€¦ 3 much â€¦ 4 â€¦ Critical Model Qï¼šè®­ç»ƒActoræ¨¡å‹æˆ‘èƒ½ç†è§£ï¼Œä½†æˆ‘è¿˜æ˜¯ä¸æ˜ç™½ï¼Œä¸ºä»€ä¹ˆè¦å•ç‹¬è®­ç»ƒä¸€ä¸ª Critic æ¨¡å‹ç”¨äºé¢„æµ‹æ”¶ç›Šå‘¢ï¼Ÿ Aï¼šè¿™æ˜¯å› ä¸ºï¼Œå½“æˆ‘ä»¬åœ¨å‰æ–‡è®¨è®ºæ€»æ”¶ç›Šï¼ˆå³æ—¶ + æœªæ¥ï¼‰æ—¶ï¼Œæˆ‘ä»¬æ˜¯ç«™åœ¨ä¸Šå¸è§†è§’çš„ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªÂ $V_t$ å°±æ˜¯å®¢è§‚å­˜åœ¨çš„ã€çœŸæ­£çš„æ€»æ”¶ç›Šã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œå°±æ²¡æœ‰è¿™ä¸ªä¸Šå¸è§†è§’åŠ æˆäº†ï¼Œä¹Ÿå°±æ˜¯åœ¨Â tÂ æ—¶åˆ»ï¼Œæˆ‘ä»¬ç»™ä¸å‡ºå®¢è§‚å­˜åœ¨çš„æ€»æ”¶ç›Š $V_t$ï¼Œæˆ‘ä»¬åªèƒ½è®­ç»ƒä¸€ä¸ªæ¨¡å‹å»é¢„æµ‹å®ƒã€‚ ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:3:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#critical-model"},{"categories":null,"content":" Actor Losså…ˆæ¥çœ‹ä¸€ä¸ªç›´è§‚çš„ loss è®¾è®¡æ–¹å¼ï¼š actor_loss=âˆ’âˆ‘VtlogP(Atâˆ£St) actor\\_loss = -\\sum V_{t}log P(A_{t}|S_{t}) actor_loss=âˆ’âˆ‘Vtâ€‹logP(Atâ€‹âˆ£Stâ€‹) $P(A_{t}|S_{t})$ æ˜¯åœ¨çŠ¶æ€ S çš„æƒ…å†µä¸‹æ‰§è¡Œ $A_{t}$ çš„æ¦‚ç‡ $V_t$ æ˜¯å¯¹åº”çš„é¢„æœŸæœªæ¥æ”¶ç›Š å‡å¦‚ $V_t\u003e0$ é‚£ä¹ˆæŸå¤±å‡½æ•°å°±å€¾å‘äºæé«˜æ‰§è¡Œ $A_{t}$ çš„æ¦‚ç‡ï¼Œåä¹‹å‡å°‘æ¦‚ç‡ã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ³•å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šåªè¦é¢„æœŸæ”¶ç›Šæ˜¯æ­£çš„ï¼Œæ¨¡å‹å°±æ‹¼å‘½æé«˜è¿™ä¸ªå›ç­”å‡ºç°çš„æ¦‚ç‡ï¼Œå› æ­¤å¼•å…¥äº† Advantage è¿™ä¸ªæ¦‚å¿µã€‚ å‡è®¾æ˜¯åœ¨è¿·å®«æ¸¸æˆä¸­ä»¥åˆ°è¾¾å‡ºå£ä¸ºç›®çš„ï¼Œç›´æ¥åˆ°è¾¾ç»ˆç‚¹çš„ $V_t=10$ï¼Œç»•ä¸€åœˆåˆ°è¾¾å‡ºå£ä¹Ÿå¯ä»¥èƒœåˆ©ä½†æ˜¯ $V_t=5$ï¼Œä¸¤è€…çš„é¢„æœŸæ”¶ç›Šéƒ½ä¸ºæ­£æ•°ä¹Ÿå°±æ˜¯è¯´éƒ½ä¼šæé«˜æ‰§è¡Œä»–ä»¬çš„æ¦‚ç‡ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬éœ€è¦æé«˜çš„åªæœ‰ç¬¬ä¸€ä¸ªæ–¹æ³•ã€‚æ¢å¥è¯è¯´\"è¿™ä¼šå¯¼è‡´ç­–ç•¥è¯¯åˆ¤ï¼ŒæŠŠå·®åŠ¨ä½œä¹Ÿå½“æˆå¥½åŠ¨ä½œä¼˜åŒ–\"ã€‚ æ‰€ä»¥æˆ‘ä»¬å®šä¹‰ä¼˜åŠ¿ä¸ºï¼š Advt=Rt+Î³âˆ—Vt+1âˆ’Vt Adv_{t} = R_{t} + \\gamma * V_{t+1} - V_{t} Advtâ€‹=Rtâ€‹+Î³âˆ—Vt+1â€‹âˆ’Vtâ€‹æ–°çš„ Actor Loss ä¸ºï¼š actor_loss=âˆ’âˆ‘AdvtlogP(Atâˆ£St) actor\\_loss = -\\sum Adv_{t}log P(A_{t}|S_{t}) actor_loss=âˆ’âˆ‘Advtâ€‹logP(Atâ€‹âˆ£Stâ€‹) å‰é¢è¿˜è®°å¾—æˆ‘ä»¬æåˆ°äº† Reference Modelï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¸ºäº†çº¦æŸæ¨¡å‹çš„æ›´æ–°ï¼Œå®ƒå…·ä½“ç”¨åœ¨ Reward å¥–åŠ±å‡½æ•°ä¸­ï¼Œéµå¾ªã€Œé¼“åŠ±é«˜äººç±»åå¥½ï¼ˆRM å¥–åŠ±ï¼‰+ æŠ‘åˆ¶ç­–ç•¥åç¦»ï¼ˆKL æƒ©ç½šï¼‰ã€ã€‚ æœ€ç®€å•çš„å®ç°ï¼Œåªéœ€è¦è®¡ç®—ä¸€æ¬¡åºåˆ—çš„ KL æ•£åº¦ï¼š Rt=r(s,a)âˆ’Î³KL R_t=r(s,a)-\\gamma KL Rtâ€‹=r(s,a)âˆ’Î³KLç®€å•ä»£ç å®ç°å¦‚ä¸‹ï¼š python ref_model = actor_model = sft_model def compute_rewards(prompts, responses) with torch.no_grad(): rm_rewards = rm_model(**tokenized).logits.squeeze(-1) # [batch_size] kls = [] for p, r in zip(prompts, responses): input_text = f\"### äººç±»ï¼š{p}\\n### åŠ©æ‰‹ï¼š{r}\" # å¤„ç†ä¸º token actor_logits = actor_model(input_ids=input_ids, attention_mask=attention_mask).logits[:, :-1, :] actor_probs = F.softmax(actor_logits, dim=-1) # è¿™é‡Œ input_ids çš„èµ·å§‹ä½ç½®ç”¨ prompt é•¿åº¦æ›´å¥½ actor_log_probs = torch.log(actor_probs.gather(2, input_ids[:, 1:].unsqueeze(-1)).squeeze(-1)).sum(dim=-1) with torch.no_grad(): ref_logits = ref_model(input_ids=input_ids, attention_mask=attention_mask).logits[:, :-1, :] ref_probs = F.softmax(ref_logits, dim=-1) ref_log_probs = torch.log(ref_probs.gather(2, input_ids[:, 1:].unsqueeze(-1)).squeeze(-1)).sum(dim=-1) # KL æ•£åº¦ï¼ˆå¹³å‡åˆ°æ¯ä¸ª tokenï¼‰ kl = (actor_log_probs - ref_log_probs) / (input_ids.shape[1] - 1) kls.append(kl) beta = 0.1 # KL æƒé‡ï¼ˆå¯æ ¹æ®è®­ç»ƒæƒ…å†µè°ƒæ•´ï¼‰ total_rewards = rm_rewards - beta * kls # æœ€ç»ˆå¥–åŠ± = åŸå§‹å¥–åŠ± - KL æƒ©ç½š return total_rewards, rm_rewards, kls é¦–å…ˆè®¡ç®— RMï¼Œæ³¨æ„éœ€è¦å†»ç»“å‚æ•° ä¹‹åè®¡ç®—æ¯ä¸€ä¸ª Q\u0026A çš„ KL æ•£åº¦ï¼š å…ˆè®¡ç®— Actor Model çš„å¯¹æ•°æ¦‚ç‡ï¼Œå…·ä½“ä¸Š actor_model.logits è¿”å›çš„æ˜¯ä¸€ä¸ª [batch_size, seq_len, vocal_size] çš„çŸ©é˜µï¼Œä»£è¡¨æ¯ä¸ª token é€‰æ‹©çš„æ¦‚ç‡ï¼Œé€šè¿‡ softmax æ±‚æ¦‚ç‡åˆ†å¸ƒä¹‹åé€šè¿‡ gather å‡½æ•°å–å‡ºæ­£çœŸå® token å¯¹åº”çš„æ¦‚ç‡ï¼Œå½¢çŠ¶ä¸º [batch_size, seq_len, 1]ï¼Œsqueeze åˆ° [batch_size, seq_len] å†æ±‚å¯¹æ•°å’Œ, å½¢çŠ¶å°±å˜æˆäº† [batch_size, ]ï¼Œè¿™å°±å¯¹åº”å‰é¢å…¬å¼é‡Œçš„ $\\sum_{response}{\\log{(prob_act(token))}}$ã€‚ Ref Model çš„è®¡ç®—åŒ Actor Modelï¼Œå°±æ˜¯è¦å†»ç»“å‚æ•°ã€‚ ä¸¤ä¸ªå¯¹æ•°æ±‚å·®ä¹‹åæ±‚å¹³å‡å°±æ˜¯è¿™ä¸ª sequence çš„ KL æ•£åº¦äº†ã€‚ logits[:, seq_len-1, :]Â é¢„æµ‹çš„æ˜¯Â ç¬¬ seq_len+1 ä¸ª token â€”â€” ä½†åŸè¾“å…¥åºåˆ—åªæœ‰Â seq_lenÂ ä¸ª tokenï¼Œç¬¬ seq_len+1 ä¸ª token æ˜¯ â€œæœªå­˜åœ¨çš„ã€éœ€è¦ç”Ÿæˆçš„ tokenâ€ï¼Œåœ¨å½“å‰åœºæ™¯ï¼ˆè®¡ç®—å·²ç”Ÿæˆåºåˆ—çš„å¯¹æ•°æ¦‚ç‡ï¼‰ä¸­ï¼Œè¿™ä¸ªä½ç½®çš„é¢„æµ‹æ˜¯Â æ— ç”¨çš„ã€‚ deepspeed-chat çš„ RLHF å®è·µä¸­ï¼Œå¯¹Â $R_t$ åšäº†å¦ä¸€ç§è®¾è®¡: $$\\begin{array}{c} R_t = \\begin{cases} \\text{kl_ctl} \\cdot \\log \\frac{P(A_t|S_t)}{P_\\text{ref}(A_t|S_t)}, \u0026 t \\neq T \\ \\text{kl_ctl} \\cdot \\log \\frac{P(A_t|S_t)}{P_\\text{ref}(A_t|S_t)} + R_t, \u0026 t = T \\end{cases} \\end{array}$$ å½“ $t \\neq T$ æ—¶ï¼Œæˆ‘ä»¬æ›´åŠ å…³å¿ƒ Actor æ˜¯å¦æœ‰åœ¨ Ref çš„çº¦æŸä¸‹ç”Ÿäº§ token å½“ $t=T$ æ—¶ï¼Œæˆ‘ä»¬ä¸ä»…å…³å¿ƒ Actor æ˜¯å¦éµä»äº† Ref çš„çº¦æŸï¼Œä¹Ÿå…³å¿ƒçœŸæ­£çš„å³æ—¶æ”¶ç›Š python def compute_rewards(self, prompts, log_probs, ref_log_probs, reward_score, action_mask): kl_divergence_estimate = -self.kl_ctl * (log_probs - ref_log_probs) rewards = kl_divergence_estimate # --------------------------------------------------------------------------------------------------- # responseå¼€å§‹çš„ä½ç½® # ï¼ˆå› ä¸ºæˆ‘ä»¬å¯¹promptåšè¿‡paddingå¤„ç†ï¼Œå› æ­¤batchä¸­æ¯ä¸ªprompté•¿åº¦ä¸€è‡´ï¼Œä¹Ÿå°±æ„å‘³ç€æ¯ä¸ªresponseå¼€å§‹çš„ä½ç½®ä¸€è‡´ï¼‰ # ï¼ˆæ‰€ä»¥è¿™é‡Œstartæ˜¯ä¸åŠ sçš„ï¼Œåªæ˜¯ä¸€ä¸ªintï¼‰ # --------------------------------------------------------------------------------------------------- start = prompts.shape[1] - 1 # --------------------------------------------------------------------------------------------------- # responseç»“æŸçš„ä½ç½® # ï¼ˆå› ä¸ºä¸€ä¸ªbatchä¸­ï¼Œæ¯ä¸ªresponseçš„é•¿åº¦ä¸ä¸€æ ·ï¼Œæ‰€ä»¥responseçš„ç»“æŸä½ç½®ä¹Ÿä¸ä¸€æ ·ï¼‰ # ï¼ˆæ‰€ä»¥è¿™é‡Œendæ˜¯åŠ sçš„ï¼Œendsçš„å°ºå¯¸æ˜¯(batch_size,) # --------------------------------------------------------------------------------------------------- ends = start + action_mask[:, start:].sum(1) + 1 reward_clip = torch.clamp(reward_score, -self.clip_reward_value, self.clip_reward_value) batch_size = log_probs.shape[0] for j in range(batch_size): rewards[j, ends[j]] += reward_clip[j] return rewards åŒæ ·å¯ä»¥æŠŠæœ€åä¸€ä¸ªæ—¶åˆ»çš„å³æ—¶å¥–åŠ±æ›¿æ¢ä¸ºæ¯ä¸ª token å³æ—¶å¥–åŠ±çš„å‡å€¼ ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å‡†å¤‡ä¸€ä¸ª batch çš„ prompts ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬å°†è¿™ä¸ª batch çš„ prompts å–‚ç»™","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:3:4","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#actor-loss"},{"categories":null,"content":" Critical LossLVF=E[(VÎ¸(st)âˆ’Rttarget)2]Rttarget=âˆ‘k=tTrk \\begin{align} L^{VF} \u0026= \\mathbb{E}\\Big[(V_\\theta(s_t) - R_t^{\\text{target}})^2\\Big] \\\\ R_t^{target}\u0026=\\sum_{k=t}^{T}r_k \\end{align} LVFRttargetâ€‹â€‹=E[(VÎ¸â€‹(stâ€‹)âˆ’Rttargetâ€‹)2]=k=tâˆ‘Tâ€‹rkâ€‹â€‹â€‹Critical Model çš„ç›®çš„æ˜¯é¢„æµ‹æœªæ¥æ”¶ç›Šï¼Œæ‰€ä»¥ Critical Loss çš„è®¾è®¡ä¹Ÿå¾ˆç®€å•äº†ï¼Œå°±æ˜¯æ±‚æœªæ¥é¢„æœŸæ”¶ç›Šå’Œæœªæ¥å®é™…æ”¶ç›Šçš„ MSEã€‚ è¿™é‡Œåˆæœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼šæ—¢ç„¶æˆ‘ä»¬å¯ä»¥å¾—åˆ°æœªæ¥å®é™…æ”¶ç›Šï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦ Crtical Model é¢„æµ‹æœªæ¥æ”¶ç›Šåšä»€ä¹ˆï¼ŸæŸ¥äº†ç™½å¤©è¿˜æ˜¯ä¸æ‡‚ã€‚ã€‚ ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:3:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#critical-loss"},{"categories":null,"content":" DPOä¸ä¼ ç»Ÿ RLHF ç›¸æ¯”ï¼ŒDPO çš„æ ¸å¿ƒåˆ›æ–°åœ¨äºï¼šç›´æ¥åˆ©ç”¨äººç±»æ ‡æ³¨çš„ â€œå“ªä¸ªå›ç­”æ›´å¥½â€ çš„åå¥½æ•°æ®æ¥ä¼˜åŒ–æ¨¡å‹ï¼Œè€Œä¸æ˜¯å…ˆè®­ç»ƒä¸€ä¸ªå¥–åŠ±æ¨¡å‹å†ç”¨å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–ã€‚ DPO éœ€è¦çš„è®­ç»ƒæ•°æ®æ ¼å¼éå¸¸ç®€å•ï¼šä¸‰å…ƒç»„ (prompt, chosen, rejected)ï¼Œå³ï¼š plaintext { \"prompt\": \"è§£é‡Šé‡å­è®¡ç®—\", \"chosen\": \"é‡å­è®¡ç®—åˆ©ç”¨é‡å­æ¯”ç‰¹å¯ä»¥åŒæ—¶å¤„äºå¤šä¸ªçŠ¶æ€çš„ç‰¹æ€§ï¼Œå®ç°ä¿¡æ¯çš„å¹¶è¡Œå¤„ç†ï¼Œä½¿æŸäº›é—®é¢˜çš„è§£å†³é€Ÿåº¦å‘ˆæŒ‡æ•°çº§æå‡\", \"rejected\": \"é‡å­è®¡ç®—æ˜¯ä¸€ç§æ¶‰åŠåŸå­å’Œç²’å­çš„å¤æ‚æŠ€æœ¯\" } å¸¸è§„çš„ SFT è®­ç»ƒéƒ½æ˜¯å¸Œæœ›èƒ½æœ€å¤§åŒ– $\\log(P(y|x))$ ä¹Ÿå°±æ˜¯æœ€å¤§åŒ–é€‰ä¸­ chosen answer çš„æ¦‚ç‡ï¼Œä½†æ˜¯ DPO è®¤ä¸ºè¿˜éœ€è¦æ­£ç¡®ç­”æ¡ˆæ¯”ä½œç‰©ç­”æ¡ˆé€‰æ‹©çš„æ¦‚ç‡å¤§ï¼ŒDPO æœ€å¤§åŒ–çš„æ˜¯ï¼š loss=âˆ’logâ¡Ïƒ(logâ¡(P(ychosenâˆ£x))âˆ’logâ¡(P(yrejectâˆ£x))) loss = -\\log\\sigma(\\log(P(y^{chosen}|x))-\\log(P(y^{reject}|x))) loss=âˆ’logÏƒ(log(P(ychosenâˆ£x))âˆ’log(P(yrejectâˆ£x)))Qï¼šæœ€å¤§åŒ– $\\log(P(y^{correct}|x))-\\log(P(y^{reject}|x))$ å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å¸Œæœ›é€‰æ‹© correct çš„æ¦‚ç‡å¤§ï¼Œé€‰æ‹© reject çš„æ¦‚ç‡å°ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¿˜è¦åœ¨å‰é¢åŠ ä¸€ä¸ª sigmoid å‘¢ï¼Ÿ Aï¼šå› ä¸ºæ¨¡å‹è¦å­¦ä¹ çš„æ˜¯ $P(y^{chosen} \u003e y^{rejected} | x)$ï¼Œæ¦‚ç‡æ¯”â€œåˆ†æ•°å·®â€æ›´å¥½è¡¨è¾¾å­¦ä¹ ç›®æ ‡ã€‚å¦‚æœç›´æ¥ç”¨ä¸¤ä¸ª P ç›¸å‡ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸€ä¸ªæ— ç•Œçš„åˆ†æ•°å·®ï¼Œæ²¡æœ‰ç»Ÿä¸€å°ºåº¦ï¼Œç”¨ sigmoid ä¹‹åå°±å¯ä»¥æŠŠå®ƒæ˜ å°„åˆ° 0-1 çš„åŒºé—´ã€‚ åŒæ—¶å’Œ RLHF ä¸€æ ·ä¸ºäº†ä¸è®©æ¨¡å‹è®­ç»ƒè·‘åï¼Œè¿˜è¦å¼•å…¥ KL æ•£åº¦ï¼š loss=âˆ’logâ¡Ïƒ(Î²logâ¡Ï€Î¸(ychosenâˆ£x)Ï€ref(ychosenâˆ£x)âˆ’Î²logâ¡Ï€Î¸(yrejectâˆ£x)Ï€ref(yrejectâˆ£x)) loss = -\\log\\sigma(\\beta \\log\\frac{\\pi_\\theta(y^{chosen}\\mid x)}{\\pi_{\\text{ref}}(y^{chosen}\\mid x)}-\\beta \\log\\frac{\\pi_\\theta(y^{reject}\\mid x)}{\\pi_{\\text{ref}}(y^{reject}\\mid x)}) loss=âˆ’logÏƒ(Î²logÏ€refâ€‹(ychosenâˆ£x)Ï€Î¸â€‹(ychosenâˆ£x)â€‹âˆ’Î²logÏ€refâ€‹(yrejectâˆ£x)Ï€Î¸â€‹(yrejectâˆ£x)â€‹)è¿™é‡Œçš„ $\\pi_\\theta(y^{chosen}\\mid x)$ å°±æ˜¯ Teacher-Forcing å¯¹ chosen ä¸­çš„æ¯ä¸€ä¸ª token æ±‚è”åˆæ¦‚ç‡å¯†åº¦ $\\prod_{chosen}P(token \\mid prompt)$ã€‚ ","date":"2025-12-01","objectID":"/posts/cs224n-lecture10/:4:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 10: Post-Training","uri":"/posts/cs224n-lecture10/#dpo"},{"categories":null,"content":"æ·±åº¦å­¦ä¹ ä¸€èˆ¬çš„è¿‡ç¨‹ä¸ºï¼šå‰å‘ä¼ æ’­ â†’ è®¡ç®— loss â†’ åå‘ä¼ æ’­ â†’ è®¡ç®—æ¢¯åº¦ â†’ æ›´æ–°å‚æ•°ï¼Œoptimizer çš„ä½œç”¨å°±æ˜¯åˆ©ç”¨æ¢¯åº¦æ¥æ›´æ–°å‚æ•°ã€‚æ¢¯åº¦ä¸‹é™æ˜¯ä¸€ç§æµè¡Œçš„ä¼˜åŒ–ç®—æ³•ï¼Œç®—æ³•è®¡ç®—å‡ºæŸå¤±å‡½æ•°ç›¸å¯¹äºç¥ç»ç½‘ç»œä¸­æ¯ä¸ªå‚æ•°çš„æ¢¯åº¦ï¼Œç„¶ååœ¨è´Ÿæ¢¯åº¦æ–¹å‘ä¸Šæ›´æ–°å‚æ•°ï¼Œè¿™æ ·å°±èƒ½å‡å°‘æŸå¤±å‡½æ•°ã€‚ ","date":"2025-12-01","objectID":"/posts/optimizer/:0:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"Optimizer","uri":"/posts/optimizer/#"},{"categories":null,"content":" SGDç¬¬ä¸€ä»£çš„ä¼˜åŒ–ç®—æ³•å°±æ˜¯ SGDï¼Œéšæœºæ¢¯åº¦ä¸‹é™ï¼š Î¸t+1=Î¸tâˆ’Î·â‹…gt \\theta_{t+1} = \\theta_t - \\eta \\cdot g_t Î¸t+1â€‹=Î¸tâ€‹âˆ’Î·â‹…gtâ€‹åœ¨ç†æƒ³æƒ…å†µä¸‹æˆ‘ä»¬åº”è¯¥ç”¨æ•´ä¸ªæ•°æ®é›†è®­ç»ƒå¾—åˆ°çš„å…¨éƒ¨æ¢¯åº¦è¿›è¡Œä¸€è½®æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯ï¼š gideal=1Nâˆ‘AllÂ DataGradients g_{\\text{ideal}} = \\frac{1}{N}\\sum_{\\text{All Data}}\\text{Gradients} gidealâ€‹=N1â€‹AllÂ Dataâˆ‘â€‹Gradientsä½†å®é™…ä¸Šå—é™äºæ˜¾å­˜å¤§å°ï¼Œæˆ‘ä»¬é‡‡ç”¨æ‰¹æ¬¡è®­ç»ƒ batch_size ä¸ªæ•°æ®è¿›è¡Œä¸€è½®è®­ç»ƒï¼š grealistic=1Bâˆ‘SampleGradients g_{\\text{realistic}}=\\frac{1}{B}\\sum_{\\text{Sample}}\\text{Gradients} grealisticâ€‹=B1â€‹Sampleâˆ‘â€‹Gradientsä½†æ˜¯è¿™ batch_size ä¸ªæ ·æœ¬ä¸èƒ½å®Œå…¨ä»£è¡¨æ•´ä¸ªæ•°æ®é›†ï¼Œä¼šç»™æ¢¯åº¦å¸¦æ¥å™ªå£°ï¼Œå¯¼è‡´è®­ç»ƒå‡ºç°éœ‡è¡ï¼ˆæ¯”å¦‚è¿™æ¬¡å™ªå£°å¯¼è‡´æ¢¯åº¦åå·¦ï¼Œä¸‹ä¸€æ¬¡å¯¼è‡´æ¢¯åº¦åå³ï¼‰ã€‚é‚£å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¼•å…¥åŠ¨é‡è¿™ä¸ªæ¦‚å¿µï¼Œè®¡ç®—å½“å‰å‚æ•°å€¼ä¸èƒ½ä»…ä»…è€ƒè™‘å½“å‰çš„æ¢¯åº¦ï¼Œè¿˜éœ€è¦è€ƒè™‘ä¸Šä¸€æ¬¡çš„å‚æ•°å€¼ã€‚ ","date":"2025-12-01","objectID":"/posts/optimizer/:1:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"Optimizer","uri":"/posts/optimizer/#sgd"},{"categories":null,"content":" æŒ‡æ•°åŠ æƒå¹³å‡è¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å•†åº—å‰ä¸€å‘¨çš„é”€å”®é¢ï¼Œæˆ‘ä»¬æ€ä¹ˆä¼°è®¡å‡ºä»Šå¤©çš„é”€å”®é¢ï¼Ÿä¸€ä¸ªç®€å•çš„æƒ³æ³•æ˜¯ç›´æ¥å¯¹å‰ä¸€å‘¨çš„é”€å”®é¢å–å‡å€¼ $\\text{price}=\\frac{1}{N}\\sum_{\\text{week}}price_i$ ã€‚å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿè¶Šè¿‘çš„æ•°æ®å¯¹ç°åœ¨å½±å“è¶Šå¤§ï¼Œè¶Šæœ‰å‚è€ƒæ„ä¹‰ï¼Œæ‰€ä»¥åº”è¯¥ç»™å®ƒæ›´å¤§çš„æƒé‡ã€‚æŒ‡æ•°åŠ æƒå¹³å‡å°±æ›´åŠ ç®€æ´çš„è¡¨è¾¾äº†è¿™ä¸ªæ€æƒ³ã€‚ Vt=Î²Vtâˆ’1+(1âˆ’Î²)Î¸ V_t=\\beta V_{t-1}+(1-\\beta)\\theta Vtâ€‹=Î²Vtâˆ’1â€‹+(1âˆ’Î²)Î¸å‡è®¾ $V_i$ æ˜¯ç¬¬ $i$ å¤©çš„æŒ‡æ•°åŠ æƒå¹³å‡å€¼ï¼Œ$\\theta_i$ ä¸ºç¬¬ $i$ å¤©çš„é”€å”®é¢ï¼Œ$\\beta=0.7$ æ˜¯åŠ æƒå¹³å‡ç³»æ•°ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š V0=0,Î²=0.7V1=0.7V0+0.3Î²1V2=0.7V1+0.3Î²2V3=0.7V2+0.3Î²3V4=0.7V3+0.3Î²4V5=0.7V4+0.3Î²5V6=0.7V5+0.3Î²6 \\begin{align} V_0=0,\\beta=0.7 \\\\ V_1=0.7V_0+0.3\\beta_1 \\\\ V_2=0.7V_1+0.3\\beta_2 \\\\ V_3=0.7V_2+0.3\\beta_3 \\\\ V_4=0.7V_3+0.3\\beta_4 \\\\ V_5=0.7V_4+0.3\\beta_5 \\\\ V_6=0.7V_5+0.3\\beta_6 \\end{align} V0â€‹=0,Î²=0.7V1â€‹=0.7V0â€‹+0.3Î²1â€‹V2â€‹=0.7V1â€‹+0.3Î²2â€‹V3â€‹=0.7V2â€‹+0.3Î²3â€‹V4â€‹=0.7V3â€‹+0.3Î²4â€‹V5â€‹=0.7V4â€‹+0.3Î²5â€‹V6â€‹=0.7V5â€‹+0.3Î²6â€‹â€‹â€‹æˆ‘ä»¬æŠŠæŒ‡æ•°åŠ æƒå¹³å‡å€¼ $V_6$ å±•å¼€ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæŒ‰ç…§æŒ‡æ•°è¡°å‡èµ‹äºˆäº†æ¯å¤©é”€å”®é¢ä¸åŒçš„æƒé‡ï¼Œå¹¶ä¸”è·ç¦»ç¬¬å…­å¤©è¶Šè¿œæƒé‡è¶Šä½ï¼š V6=0.7(0.7V4+0.3Î²5)+0.3Î²6=0.73V3+0.3âˆ—0.72Î¸4+0.3âˆ—0.7Î²5+0.3Î²6=0.3âˆ—0.75Î²1+...+0.21Î²5+0.3Î²6 \\begin{align} V_6 \u0026= 0.7(0.7V_4+0.3\\beta_5)+0.3\\beta_6 \\\\ \u0026= 0.7^3V_3+0.3*0.7^2\\theta_4+0.3*0.7\\beta_5+0.3\\beta_6 \\\\ \u0026= 0.3*0.7^5\\beta_1 + ...+0.21\\beta_5+0.3\\beta_6 \\end{align} V6â€‹â€‹=0.7(0.7V4â€‹+0.3Î²5â€‹)+0.3Î²6â€‹=0.73V3â€‹+0.3âˆ—0.72Î¸4â€‹+0.3âˆ—0.7Î²5â€‹+0.3Î²6â€‹=0.3âˆ—0.75Î²1â€‹+...+0.21Î²5â€‹+0.3Î²6â€‹â€‹â€‹ é™¤æ­¤ä¹‹å¤–ï¼Œè¿è¡Œè¿‡ç¨‹ä¸­åªéœ€è¦é¢å¤–ä¿å­˜ä¸€ä¸ªå€¼ $V_{t-1}$ å³å¯å¯¹å†å²æ‰€æœ‰å€¼å–å¹³å‡ã€‚ ","date":"2025-12-01","objectID":"/posts/optimizer/:2:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"Optimizer","uri":"/posts/optimizer/#æŒ‡æ•°åŠ æƒå¹³å‡"},{"categories":null,"content":" åå·®ä¿®æ­£ æ—¥æœŸ $\\theta$ $V$ ç¬¬ä¸€å¤© 100 30 ç¬¬äºŒå¤© 114 55.2 ç¬¬ä¸‰å¤© 118 74.04 ç¬¬å››å¤© 117 86.9 ç¬¬äº”å¤© 120 96.83 ç¬¬å…­å¤© 122 104.38 è®¡ç®—ä¹‹åä¼šå‘ç°å‰å‡ å¤©çš„é”€å”®é¢æ˜æ˜¾åå°ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„åˆå§‹å€¼æ˜¯ $V_0=0$ï¼Œéšç€åºåˆ—å˜é•¿ $V_0$ çš„å½±å“ä¼šé€æ¸å‡å°ã€‚æˆ‘ä»¬å¯ä»¥å¯¹ $V$ è¿›è¡Œä¿®æ­£ï¼Œè®©å®ƒä¹˜ä¸€ä¸ªç³»æ•°å°±èƒ½ç¼“è§£ã€‚ Vtcorrect=Vt1âˆ’Î²t V_t^{\\text{correct}}=\\frac{V_t}{1-\\beta^t} Vtcorrectâ€‹=1âˆ’Î²tVtâ€‹â€‹","date":"2025-12-01","objectID":"/posts/optimizer/:2:1","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"Optimizer","uri":"/posts/optimizer/#åå·®ä¿®æ­£"},{"categories":null,"content":" RMSPropRMSProp çš„æ€æƒ³å¾ˆç®€å•ï¼Œåœ¨æ¢¯åº¦æ¯”è¾ƒå°çš„åœ°æ–¹æˆ‘ä»¬åº”è¯¥æ”¾å¤§æ­¥å­ï¼Œæ¢¯åº¦å¤§çš„åœ°æ–¹æˆ‘ä»¬åº”è¯¥ç¼©å°æ­¥å­ï¼Œè¿™æ ·å°±ä¸å®¹æ˜“é™·å…¥å±€éƒ¨æœ€ä¼˜æˆ–è€…å‡ºç°éœ‡è¡ã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯æˆ‘ä»¬åªéœ€è¦å¯¹å­¦ä¹ ç‡åŠ ä¸€ä¸ªç³»æ•°å³å¯ï¼Œæ¢¯åº¦å¤§æˆ‘ä»¬å°±å‡å°å­¦ä¹ ç‡ï¼Œæ¢¯åº¦å°æˆ‘ä»¬å°±å¢åŠ å­¦ä¹ ç‡ã€‚ è®¡ç®—éœ‡è¡å¹…åº¦ï¼š vt=Î²2vtâˆ’1+(1âˆ’Î²2)gt2 v_t = \\beta_2 v_{t-1} + (1-\\beta_2) g_t^2 vtâ€‹=Î²2â€‹vtâˆ’1â€‹+(1âˆ’Î²2â€‹)gt2â€‹è‡ªé€‚åº”æ›´æ–°ï¼š Î¸t=Î¸tâˆ’1âˆ’Î·vt+Ïµâ‹…gt \\theta_t = \\theta_{t-1} - \\frac{\\eta}{\\sqrt{v_t}+\\epsilon} \\cdot g_t Î¸tâ€‹=Î¸tâˆ’1â€‹âˆ’vtâ€‹â€‹+ÏµÎ·â€‹â‹…gtâ€‹å½“æ¢¯åº¦å¤§çš„æ—¶å€™ï¼Œæ¢¯åº¦çš„æŒ‡æ•°åŠ æƒå¹³å‡å€¼å°±å˜å¤§ï¼Œé‚£ä¹ˆå­¦ä¹ ç‡åˆ™å‡å°ï¼Œ$\\epsilon$ æ˜¯ä¸ºäº†é˜²æ­¢åˆ†æ¯ä¸º 0ã€‚ ","date":"2025-12-01","objectID":"/posts/optimizer/:3:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"Optimizer","uri":"/posts/optimizer/#rmsprop"},{"categories":null,"content":" AdamAdam å°±æ˜¯æŠŠå‰é¢çš„æŒ‡æ•°åŠ æƒå¹³å‡ã€åå·®ä¿®æ­£å’Œ RMSProp ç»“åˆçš„äº§ç‰©ã€‚ åŠ¨é‡ mt=Î²1mtâˆ’1+(1âˆ’Î²1)gtvt=Î²2vtâˆ’1+(1âˆ’Î²2)gt2 \\begin{align} m_t \u0026= \\beta_1 m_{t-1} + (1-\\beta_1) g_t \\\\ v_t \u0026= \\beta_2 v_{t-1} + (1-\\beta_2) g_t^2 \\\\ \\end{align} mtâ€‹vtâ€‹â€‹=Î²1â€‹mtâˆ’1â€‹+(1âˆ’Î²1â€‹)gtâ€‹=Î²2â€‹vtâˆ’1â€‹+(1âˆ’Î²2â€‹)gt2â€‹â€‹â€‹åå·®ä¿®æ­£ m^t=mt1âˆ’Î²1tv^t=vt1âˆ’Î²2t \\begin{align} \\hat m_t \u0026= \\frac{m_t}{1-\\beta_1^t} \\\\ \\hat v_t \u0026= \\frac{v_t}{1-\\beta_2^t} \\end{align} m^tâ€‹v^tâ€‹â€‹=1âˆ’Î²1tâ€‹mtâ€‹â€‹=1âˆ’Î²2tâ€‹vtâ€‹â€‹â€‹â€‹å‚æ•°æ›´æ–° Î¸t=Î¸tâˆ’1âˆ’Î±m^tv^t+Ïµ \\theta_t = \\theta_{t-1} - \\alpha\\frac{\\hat m_t}{\\sqrt{\\hat v_t} + \\epsilon} Î¸tâ€‹=Î¸tâˆ’1â€‹âˆ’Î±v^tâ€‹â€‹+Ïµm^tâ€‹â€‹ python class Adam: def __init__( self, params: list[torch.Tensor], lr: float, ep: float, beta: tuple[float, float] ): self.params = params self.lr = lr self.ep = ep self.beta1, self.beta2 = beta self.t = 0 self.m = [np.zeros_like(p) for p in params] self.v = [np.zeros_like(p) for p in params] def step(self, grads: list[torch.Tensor]): self.t += 1 for i, (param, grad) in enumerate(zip(self.params, grads)): # momentum self.m[i] = self.beta1 * self.m[i-1] + (1 - self.beta1) * grad self.v[i] = self.beta2 * self.v[i-1] + (1 - self.beta2) * grad ** 2 # bias correction m = self.m[i] / (1 - self.beta1 ** self.t) v = self.v[i] / (1 - self.beta2 ** self.t) # update parameter param -= self.lr * m / (torch.sqrt(v) + self.ep) PyTorch é£æ ¼çš„ Optimizer ä¼šç”¨ state å­˜å‚¨ mã€vï¼š python class AdamTorch: def __init__( self, params: list[torch.Tensor], lr: float, ep: float, beta: tuple[float, float] ): self.params = params self.lr = lr self.ep = ep self.beta1, self.beta2 = beta self.t = 0 self.state = {p: { \"m\": np.zeros_like(p), \"v\": np.zeros_like(p) } for p in params} def step(self, grads: list[torch.Tensor]): self.t += 1 for param, grad in zip(self.params, grads): s = self.state[param] # momentum s[\"m\"] = self.beta1 * s[\"m\"] + (1 - self.beta1) * grad s[\"v\"] = self.beta2 * s[\"v\"] + (1 - self.beta2) * grad ** 2 # bias correction m = s[\"m\"] / (1 - self.beta1 ** self.t) v = s[\"v\"] / (1 - self.beta2 ** self.t) # update parameter param -= self.lr * m / (torch.sqrt(v) + self.ep) ","date":"2025-12-01","objectID":"/posts/optimizer/:4:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"Optimizer","uri":"/posts/optimizer/#adam"},{"categories":null,"content":" AdamWAdamW ç›¸å¯¹ Adam åœ¨å‚æ•°æ›´æ–°é˜¶æ®µè¿›è¡Œè¡°å‡ï¼š Î¸t=Î¸tâˆ’1âˆ’Î±m^tv^t+Ïµâˆ’Î±Î»Î¸tâˆ’1 \\theta_t=\\theta_{t-1}-\\alpha\\frac{\\hat m_t}{\\sqrt{\\hat v_t}+\\epsilon}-\\alpha \\lambda \\theta_{t-1} Î¸tâ€‹=Î¸tâˆ’1â€‹âˆ’Î±v^tâ€‹â€‹+Ïµm^tâ€‹â€‹âˆ’Î±Î»Î¸tâˆ’1â€‹ python class AdamWTorch: def __init__( self, params: list[torch.Tensor], lr: float, ep: float, weight_decay : float, beta: tuple[float, float] ): self.params = params self.lr = lr self.ep = ep self.weight_decay = weight_decay self.beta1, self.beta2 = beta self.t = 0 self.state = {p: { \"m\": np.zeros_like(p), \"v\": np.zeros_like(p) } for p in params} def step(self, grads: list[torch.Tensor]): self.t += 1 for param, grad in zip(self.params, grads): s = self.state[param] # momentum s[\"m\"] = self.beta1 * s[\"m\"] + (1 - self.beta1) * grad s[\"v\"] = self.beta2 * s[\"v\"] + (1 - self.beta2) * grad ** 2 # bias correction m = s[\"m\"] / (1 - self.beta1 ** self.t) v = s[\"v\"] / (1 - self.beta2 ** self.t) # update parameter param = (1 - self.lr * self.weight_decay) * param - self.lr * m / (torch.sqrt(v) + self.ep) æƒé‡è¡°å‡å’Œ L2 æ­£åˆ™åŒ–æœ‰æ²¡æœ‰å…³ç³»ï¼Ÿ å¦‚æœä½ äº†è§£ L2 æ­£åˆ™åŒ–å¯èƒ½ä¼šå‘ç°ï¼ŒæŸå¤±å‡½æ•°åŠ å…¥ L2 æ­£åˆ™åŒ–ä¹‹åçš„æ¢¯åº¦å…¬å¼å’ŒåŠ å…¥æƒé‡è¡°å‡çš„ä¸€æ¨¡ä¸€æ ·ï¼š losstotal=lossorigin+Î»2Ã—âˆ£âˆ£wâˆ£âˆ£2 \\text{loss}_{\\text{total}} = \\text{loss}_{\\text{origin}} + \\frac{\\lambda}{2} \\times ||w||^2 losstotalâ€‹=lossoriginâ€‹+2Î»â€‹Ã—âˆ£âˆ£wâˆ£âˆ£2æ¢¯åº¦åˆ™å’Œ AdamW ä¸€æ ·ï¼š âˆ‡Ltotal=âˆ‡Loriginal+Î»âˆ—w âˆ‡L_{\\text{total}} = âˆ‡L_{\\text{original}} + Î» * w âˆ‡Ltotalâ€‹=âˆ‡Loriginalâ€‹+Î»âˆ—w ä½†æ˜¯åœ¨ Adam ä¸­æˆ‘ä»¬é‡‡ç”¨äº† Momentum æˆ–è€…è¯´æŒ‡æ•°åŠ æƒå¹³å‡ï¼Œå®ƒä¼šè®¡ç®—ä¸€é˜¶çŸ© $\\hat m_t$ å’ŒäºŒé˜¶çŸ© $\\hat v_t$ï¼Œè¿™æ—¶å€™åŠ å…¥çš„ L2 æ­£åˆ™åŒ–å°±ä¼šæ±¡æŸ“ä»–ä»¬ï¼Œä¸‹é¢å…¬å¼é‡Œé¢ $\\lambda*w$ è¢«çº¿æ€§åŠ å…¥åˆ° $m_t$ é‡Œï¼š mt=Î²1âˆ—mtâˆ’1+(1âˆ’Î²1)âˆ—(âˆ‡Ldata+Î»âˆ—w)=Î²1âˆ—mtâˆ’1+(1âˆ’Î²1)âˆ—âˆ‡Ldata+(1âˆ’Î²1)âˆ—Î²âˆ—w \\begin{align} m_t \u0026= \\beta_1 * m_{t-1} + (1 - \\beta_1) * (âˆ‡L_{data} + \\lambda * w) \\\\ \u0026= \\beta_1 * m_{t-1} + (1 - \\beta_1) * âˆ‡L_{data} + (1 - \\beta_1) * \\beta * w \\end{align} mtâ€‹â€‹=Î²1â€‹âˆ—mtâˆ’1â€‹+(1âˆ’Î²1â€‹)âˆ—(âˆ‡Ldataâ€‹+Î»âˆ—w)=Î²1â€‹âˆ—mtâˆ’1â€‹+(1âˆ’Î²1â€‹)âˆ—âˆ‡Ldataâ€‹+(1âˆ’Î²1â€‹)âˆ—Î²âˆ—wâ€‹â€‹ è€Œ AdamW é‡‡ç”¨çš„æƒé‡è¡°å‡ç›´æ¥æ”¾åœ¨å‚æ•°æ›´æ–°é˜¶æ®µï¼Œä¸ä¼šæ±¡æŸ“æ¢¯åº¦è¿›è€Œå½±å“ä¸€é˜¶çŸ©å’ŒäºŒé˜¶çŸ©ã€‚ ","date":"2025-12-01","objectID":"/posts/optimizer/:5:0","series":["DeepLearning"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"Optimizer","uri":"/posts/optimizer/#adamw"},{"categories":null,"content":" æ•´ä½“æµç¨‹ æ•°æ®é¢„å¤„ç†ï¼šä¼šå¾—åˆ°ä¸‰ä¸ªæ•°æ®é›†ä»¥åŠä¸€ä¸ª Parserï¼Œåœ¨ä¾å­˜åˆ†æå®éªŒä¸­ Parser ç»Ÿç­¹ç®¡ç†è½¬ç§»ç³»ç»Ÿä¸­çš„å…¨éƒ¨èµ„æºï¼ŒåŒ…æ‹¬ Stack, Buffer, Arcs è¿˜æœ‰ä¸€ä¸ªæ·±åº¦å­¦ä¹ çš„ modelã€‚ è®­ç»ƒè¿‡ç¨‹ï¼štrain å‡½æ•°ä¼šè¿›è¡Œ n ä¸ª batch çš„è®­ç»ƒï¼Œä¿å­˜ UAS æœ€å¤§çš„ä¸€ä¸ªæ¨¡å‹ã€‚ ä½¿ç”¨åˆšåˆšä¿å­˜çš„æœ€å¥½æ¨¡å‹å¯¹ test æ•°æ®é›†è¿›è¡Œå¤„ç† python if __name__ == \"__main__\": debug = args.debug assert (torch.__version__.split(\".\") \u003e= [\"1\", \"0\", \"0\"]), \"Please install torch version \u003e= 1.0.0\" print(80 * \"=\") print(\"INITIALIZING\") print(80 * \"=\") parser, embeddings, train_data, dev_data, test_data = load_and_preprocess_data(debug) start = time.time() model = ParserModel(embeddings) parser.model = model print(\"took {:.2f} seconds\\n\".format(time.time() - start)) print(80 * \"=\") print(\"TRAINING\") print(80 * \"=\") output_dir = \"results/{:%Y%m%d_%H%M%S}/\".format(datetime.now()) output_path = output_dir + \"model.weights\" if not os.path.exists(output_dir): os.makedirs(output_dir) train(parser, train_data, dev_data, output_path, batch_size=1024, n_epochs=10, lr=0.0005) if not debug: print(80 * \"=\") print(\"TESTING\") print(80 * \"=\") print(\"Restoring the best model weights found on the dev set\") parser.model.load_state_dict(torch.load(output_path)) print(\"Final evaluation on test set\",) parser.model.eval() UAS, dependencies = parser.parse(test_data) print(\"- test UAS: {:.2f}\".format(UAS * 100.0)) print(\"Done!\") ","date":"2025-11-30","objectID":"/posts/cs224n-assignment2/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 2","uri":"/posts/cs224n-assignment2/#æ•´ä½“æµç¨‹"},{"categories":null,"content":" æ•°æ®é¢„å¤„ç†è®­ç»ƒæ•°æ®é›† be like: conll 1 In _ ADP IN _ 5 case _ _ 2 an _ DET DT _ 5 det _ _ 3 Oct. _ PROPN NNP _ 5 compound _ _ 4 19 _ NUM CD _ 5 nummod _ _ 5 review _ NOUN NN _ 45 nmod _ _ 6 of _ ADP IN _ 9 case _ _ 7 `` _ PUNCT `` _ 9 punct _ _ 8 The _ DET DT _ 9 det _ _ è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ª CoNLL-Uï¼ˆæˆ–ç±»ä¼¼ CoNLL æ ¼å¼ï¼‰ çš„ä¾å­˜å¥æ³•åˆ†ææ ‡æ³¨æ–‡ä»¶ï¼Œæ¯ä¸€æ®µå¯¹åº”ä¸€ä¸ªå¥å­ï¼Œâ€œIn an Oct. 19 review of â€˜The Misanthropeâ€™ at Chicagoâ€™s Goodman Theatre â€¦â€ read_conll å‡½æ•°ä¼šè´Ÿè´£è¯»å–è¿™äº›æ–‡ä»¶ï¼Œå¹¶ä¸”è¿”å›list[{'word': [], 'pos': [], 'head': [], 'label': []}]æ ¼å¼çš„æ•°æ®ï¼Œæ¯ä¸ªå­—å…¸å¯¹åº”ä¸€å¥è¯ æ„å»º Parser æ ¸å¿ƒç±»ï¼Œé‡Œé¢å°è£…äº†ä¾å­˜åˆ†æçš„æ•´ä¸ªç³»ç»Ÿã€‚ è¯»å–é¢„è®­ç»ƒçš„è¯å‘é‡ æ„å»ºåˆå§‹åŒ– [token_num, 50] å¤§å°çš„è¯å‘é‡çŸ©é˜µ å°†æ•°æ®é›†ä¸­çš„å‘é‡å˜æˆ one-hot ç¼–ç  create_instances() ä»è¯­æ–™ä¸­ç”Ÿæˆâ€œå½“å‰çŠ¶æ€ â†’ æ­£ç¡®åŠ¨ä½œâ€çš„è®­ç»ƒæ ·æœ¬ å·²ç»æœ‰é¢„è®­ç»ƒçš„è¯å‘é‡ï¼Œä¸ºä»€ä¹ˆè¿˜è¦éšæœºç”Ÿæˆï¼Ÿ å› ä¸ºé¢„è®­ç»ƒçš„è¯å‘é‡åº“ä¸ä¸€å®šèƒ½å›Šæ‹¬å…¨éƒ¨çš„è¯æ±‡ï¼Œæ‰€ä»¥éœ€è¦åˆå§‹åŒ–ä¸€ä¸ªè¯å‘é‡çŸ©é˜µï¼Œç„¶åç”¨é¢„è®­ç»ƒçš„æ›¿æ¢ å·²ç»æœ‰è¯å‘é‡äº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦æŠŠ word å’Œ pos ç­‰è½¬ä¸º one-hot ç¼–ç å‘¢ï¼Ÿè¿™æ ·ä¸æ˜¯ä¸¢å¤±äº†ä¿¡æ¯å—ï¼Ÿ TODO ","date":"2025-11-30","objectID":"/posts/cs224n-assignment2/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 2","uri":"/posts/cs224n-assignment2/#æ•°æ®é¢„å¤„ç†"},{"categories":null,"content":" ç¥ç»ç½‘ç»œPyTorch æ¡†æ¶ä¸‹ï¼Œè¦å®ç°è‡ªå·±çš„ç¥ç»ç½‘ç»œå¯ä»¥ç»§æ‰¿ torch.nn.Module ç±»ï¼Œå®ƒè€ƒç ”è‡ªåŠ¨æŠŠ nn.Parameter å’Œå­æ¨¡å—ä¸­çš„å‚æ•°æ”¶é›†èµ·æ¥ï¼Œä¾¿äºä¼˜åŒ–å™¨è®¿é—® model.parameters()ã€‚ python class CustomizedNet(nn.Module): def __init__(self, in_dim, hidden_dim, out_dim): super().__init__() def forward(self, x): return x embedding_lookup å‰é¢æåˆ°åœ¨æ•°æ®é¢„å¤„ç†çš„æ—¶å€™ï¼Œè®­ç»ƒé›†çš„æ•°æ®ä¸­ word,pos ç­‰å‘é‡ä¼šè½¬ä¸º one-hot ç¼–ç ï¼Œæ‰€ä»¥åœ¨è¿›å…¥ç¥ç»ç½‘ç»œè¿›è¡Œè®­ç»ƒæ—¶å€™ï¼Œéœ€è¦æ ¹æ® idx å¾—åˆ°å¯¹åº”çš„å‘é‡è¡¨ç¤ºã€‚ åœ¨ä¾å­˜å¥æ³•åˆ†æï¼ˆDependency Parsingï¼‰ä¸­ï¼Œæ¯ä¸€æ­¥çš„è¾“å…¥çŠ¶æ€å¯ä»¥ç”¨ä¸€äº›â€œç‰¹å¾å•è¯â€æ¥è¡¨ç¤ºï¼Œæ¯”å¦‚ï¼š æ ˆé¡¶çš„è¯ï¼ˆstack topï¼‰ ç¼“å†²åŒºå‰å‡ ä¸ªè¯ï¼ˆbuffer frontï¼‰ å®ƒä»¬çš„å­èŠ‚ç‚¹ï¼ˆleft/right childrenï¼‰ è¿™äº›å•è¯çš„ç´¢å¼•è¢«æ‹¼æˆä¸€ä¸ªå›ºå®šé•¿åº¦çš„åˆ—è¡¨ï¼Œæ¯”å¦‚ï¼šw = [23, 14, 7, 65, 99, ..., 8], æ¨¡å‹è¾“å…¥çš„ train_set ç»´åº¦ä¸º [batch_size, n_features]ã€‚ python def embedding_lookup(self, w): x = self.embeddings[w] x = x.view(x.size(0), -1) return x è¿™é‡Œç”¨åˆ°äº† PyTorch ä¸­å¼ é‡ç´¢å¼•çš„æŠ€å·§ï¼Œå¦‚æœç”¨ä¸€ä¸ªå¼ é‡ a å½“å¦ä¸€ä¸ªå¼ é‡ b çš„ç´¢å¼•ï¼Œé‚£ä¹ˆ a ä¸­çš„æ¯ä¸ªå…ƒç´  i ä¼šè¢«æ›¿æ¢ä¸º b ä¸­ç¬¬ä¸€ä¸ªç»´åº¦çš„ç¬¬ i ä¸ªå…ƒç´ ï¼Œä¾‹å¦‚ï¼š python self.embeddings = torch.tensor([ [1, 1, 1], # è¯ 0 [2, 2, 2], # è¯ 1 [3, 3, 3], # è¯ 2 [4, 4, 4], # è¯ 3 ]) w = torch.tensor([[0, 2], [1, 3]]) =\u003e self.embeddings[w] = [ [[1, 1, 1], [3, 3, 3]], [[2, 2, 2], [4, 4, 4]] ] å¯ä»¥è®¡ç®—å¾—åˆ°ï¼Œç»è¿‡ lookup æŸ¥è¡¨æ“ä½œä¹‹åï¼Œtrain_set çš„ç»´åº¦ä» [batch_size, n_features] å˜æˆ [batch_size, n_features, embed_size]ã€‚ ç”±äºç¥ç»ç½‘ç»œçš„è¾“å…¥å¿…é¡»æ˜¯ä¸€ç»´çš„ feature å‘é‡ï¼Œæ‰€ä»¥éœ€è¦å¯¹ train_set è¿›è¡Œå±•å¹³æ“ä½œï¼Œä» [batch_size, n_features, embed_size] é™ç»´åˆ° [batch_size, n_features * embed_size] init python def __init__(self, embeddings, n_features=36, hidden_size=200, n_classes=3, dropout_prob=0.5): super(ParserModel, self).__init__() self.n_features = n_features self.n_classes = n_classes self.dropout_prob = dropout_prob self.embed_size = embeddings.shape[1] self.hidden_size = hidden_size self.embeddings = nn.Parameter(torch.tensor(embeddings)) # declare self.embed_to_hidden_weight = nn.Parameter(torch.empty(self.embed_size * self.n_features)) self.embed_to_hidden_bias = nn.Parameter(torch.empty(hidden_size)) # initialize nn.init.xavier_uniform_(self.embed_to_hidden_weight) nn.init.uniform_(self.embed_to_hidden_bias) # dropout layer self.dropout = nn.Dropout(p=self.dropout_prob) # declare self.hidden_to_logits_weight = nn.Parameter(torch.empty(self.hidden_size, self.n_classes)) self.hidden_to_logits_bias = nn.Parameter(torch.empty(self.n_classes)) å‰é¦ˆå±‚æ˜¯çº¿æ€§è®¡ç®—ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å®šä¹‰çš„ Weight å’Œ Bias ä¸ nn.Linear æœ‰ç€ç›¸åŒä½œç”¨ï¼š y=Wx+b y=Wx+b y=Wx+bè¾“å…¥ x çš„ç»´åº¦ä¸º [batch_size, self.embed_size * self.n_features], æ‰€ä»¥ W ç»´åº¦ä¸º [self.embed_size * self.n_features, hidden_size], ä¹˜ç§¯çš„ç»´åº¦ä¸º [self.batch_size, hidden_size]ï¼Œ æ‰€ä»¥ b çš„ç»´åº¦æ˜¯ [hidden_size,]ï¼Œåç»­è®¡ç®—åŒç†ã€‚ ä¸ºä»€ä¹ˆ b çš„ç»´åº¦æ˜¯ [hidden_size] æˆ–è€…è¯´ [1, hidden_size] é¦–å…ˆæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹$y=xW$å¾—åˆ°çš„çŸ©é˜µï¼Œä»–çš„å½¢çŠ¶æ˜¯ [batch_size, hidden_size]ï¼Œè¿™ä»£è¡¨æœ‰ batch_size è¡Œï¼Œæ¯ä¸€è¡Œå®½åº¦æ˜¯ hidden_sizeã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³ç»™å‡½æ•°åŠ ä¸€ä¸ªåç½®é¡¹ï¼Œåº”è¯¥æ˜¯ç»™æ¯ä¸€è¡ŒåŠ ä¸Šå»ï¼Œåç½®å‘é‡çš„å½¢çŠ¶åº”è¯¥æ˜¯ [1, hidden_size]ã€‚ä½†æ˜¯çŸ©é˜µå’Œå‘é‡æ˜¯å¦‚ä½•ç›¸åŠ çš„å‘¢ï¼ŸPyTorchï¼ˆæˆ– NumPyï¼‰çš„å¹¿æ’­è§„åˆ™æ˜¯ï¼šåªè¦ä¸¤ä¸ªå¼ é‡åœ¨æœ«å°¾ç»´åº¦ä¸Šèƒ½åŒ¹é…ï¼Œå°±å¯ä»¥è‡ªåŠ¨æ‰©å±•å‰é¢çš„ç»´åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šå¹¿æ’­æ—¶ï¼Œb ä¼šè¢«è‡ªåŠ¨æ‰©å±•ä¸º [1, hidden_size] â†’ [batch_size, hidden_size]ã€‚æ‰€ä»¥åœ¨è¿™ä¸ªè¯­å¢ƒä¸‹ï¼Œå®ƒè¡Œä¸ºä¸Šæ›´åƒæ˜¯ä¸€ä¸ªâ€œè¡Œå‘é‡â€ã€‚ forward python def forward(self, w): logits = None x = self.embedding_lookup(w) logits = nn.ReLU(torch.matmul(x, self.embed_to_hidden_weight) + self.embed_to_hidden_bias) logits = self.dropout(logits) logits = nn.ReLU(torch.matmul(logits, self.hidden_to_logits_weight) + self.hidden_to_logits_bias) return logits ä¸ºä»€ä¹ˆåœ¨ forward å‰é¦ˆè®¡ç®—ä¸­æ˜¯ x ä¹˜ä»¥ W å‘¢ï¼Ÿ è¿™ä¸»è¦æ˜¯æºäº PyTorch å’Œæ•°å­¦è®¡ç®—çš„å·®å¼‚ï¼šåœ¨æ•°å­¦ä¸­æˆ‘ä»¬é€šå¸¸è§„å®š x æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º n çš„åˆ—å‘é‡ï¼Œä½†æ˜¯åœ¨ PyTorch ä¸­è¾“å…¥ x å‡ ä¹æ€»æ˜¯ä¸€æ‰¹è¡Œå‘é‡ã€‚æ‰€ä»¥åœ¨ PyTorch ä»£ç ä¸­ï¼Œä¸€èˆ¬æ˜¯$y=xW$æˆ–è€…$y=xW^T$ã€‚ dropout ä¸€å®šè¦æ”¾åœ¨ä¸¤ä¸ªçº¿æ€§å˜æ¢ä¹‹é—´å—ï¼Ÿéšè—å±‚çš„è¾“å‡ºæ˜¯æ¨¡å‹å­¦ä¹ åˆ°çš„ç‰¹å¾è¡¨å¾ã€‚å¯¹è¿™äº›è¡¨å¾åš dropoutï¼Œè¿«ä½¿ä¸‹ä¸€å±‚çš„æƒé‡ä¾èµ–æ›´åŠ å¹¿æ³›ã€é²æ£’çš„ç‰¹å¾ç»„åˆï¼Œä»è€Œé™ä½è¿‡æ‹Ÿåˆã€‚ ","date":"2025-11-30","objectID":"/posts/cs224n-assignment2/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 2","uri":"/posts/cs224n-assignment2/#ç¥ç»ç½‘ç»œ"},{"categories":null,"content":" è®­ç»ƒ Adam Optimizer éœ€è¦æ¨¡å‹å…¨éƒ¨ç¥ç»å…ƒå½“å‚æ•° æŸå¤±å‡½æ•°é‡‡ç”¨äº¤å‰ç†µæŸå¤± è®­ç»ƒ n_epochs ä¸ªè½®æ¬¡ï¼Œç„¶åå–æœ€é«˜åˆ†ä¿å­˜æ¨¡å‹ã€‚ python def train(parser, train_data, dev_data, output_path, batch_size=1024, n_epochs=10, lr=0.0005): best_dev_uas = 0 params = parser.model.parameters() optimizer = optim.Adam(params, lr=0.0001) loss_func = nn.CrossEntropyLoss() for epoch in range(n_epochs): print(f\"Epoch {epoch} out of {n_epochs}\") dev_uas = epoch_train(parser, train_data, lr) print(f\"Epoch {epoch} scored {dev_uas} UAS\") if dev_uas \u003e best_dev_uas: torch.save(parser.model.state_dict(), output_path) print(f\"train completed with best dev uas of {best_dev_uas}\") åœ¨è®­ç»ƒä¹‹å‰è°ƒç”¨model.train()ï¼Œdropout å±è”½ä¸€éƒ¨åˆ†ç¥ç»å…ƒ æ¯æ¬¡å– batch_size ä¸ªæ•°æ®è®­ç»ƒ æ¯æ¬¡è®­ç»ƒçš„å¥—è·¯éƒ½æ˜¯æ¯”è¾ƒå›ºå®šäº†ï¼Œæ¢¯åº¦æ¸…é›¶-é¢„æµ‹-è®¡ç®— loss-æ¢¯åº¦å›ä¼ -æ›´æ–°æ¢¯åº¦ python def train_for_epoch(parser, train_data, dev_data, optimizer, loss_func, batch_size): parser.model.train() n_minibatches = math.ceil(len(train_data) / batch_size) total_loss = 0 with tqdm(total=(n_minibatches)) as prog: for i, (train_x, train_y) in enumerate(minibatches(train_data, batch_size)): # ---------- ä¸€å¥—è¿æ‹› ----------- optimizer.zero_grad() logits = parser.model(train_x) loss = loss_func(logits, train_y) loss.backward() optimizer.step() total_loss += loss.item() prog.update(1) print(f\"Average Train Loss: {total_loss / n_minibatchs}\") parser.model.eval() dev_uas, _ = parser.parse(dev_data) print(\"- dev UAS: {:.2f}\".format(dev_UAS * 100.0)) return dev_UAS ä¸Šé¢ä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ†å°±æ˜¯åˆ©ç”¨ batch data è¿›è¡Œè®­ç»ƒçš„éƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ã€‚ é¦–å…ˆä¸ºä»€ä¹ˆéœ€è¦model.train() å¯ç”¨è®­ç»ƒæ¨¡å¼ä¹‹åï¼Œç¥ç»ç½‘ç»œä¼šé‡‡ç”¨ Dropout ä»¥ä¸€å®šæ¦‚ç‡ï¼ˆä¾‹å¦‚ p=0.5ï¼‰éšæœºâ€œå±è”½â€ä¸€éƒ¨åˆ†ç¥ç»å…ƒè¾“å‡ºï¼Œè¿™ä¹ˆåšæ˜¯ä¸ºäº†è®©æ¨¡å‹ä¸è¦å¤ªä¾èµ–æŸäº›ç‰¹å¾ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚ yi={0xi1âˆ’p y_i= \\begin{cases} 0\\\\ \\frac{x_i}{1-p} \\end{cases} yiâ€‹={01âˆ’pxiâ€‹â€‹â€‹ ä¸ºä»€ä¹ˆéœ€è¦optimizer.zero_grad()æ‰‹åŠ¨æ¸…ç©ºæ¢¯åº¦ï¼Ÿ PyTorch ä¸­è¿›è¡Œåå‘ä¼ æ’­ä¹‹åè®¡ç®—æ¢¯åº¦å¹¶ä¸æ˜¯ç®€å•çš„èµ‹å€¼ (=) è€Œæ˜¯é€‰æ‹©äº†æ¢¯åº¦ç´¯ç§¯ (+=)ï¼Œè¿™é‡Œç”¨ä¸€ä¸ªä»£ç ä¸¾ä¾‹ï¼š python \"\"\" å‡è®¾ y=w*x, å¹¶ä¸”éœ€è¦è®­ç»ƒçš„ w ä¸º 2 \"\"\" w = torch.tensor([1.0], requires_grad=True) optimizer = torch.optim.SGD([w], lr=0.1) def loss_func(pred_y, train_y): \"\"\" æŸå¤±å‡½æ•°ä¸º loss = (y1 - y) ^ 2 = (w * x - y) ^ 2 æ±‚å¯¼åä¸º âˆ‚loss/âˆ‚w = 2(w * x - y) * x \"\"\" return (pred_y - train_y) ** 2 train_x1, train_x2 = torch.tensor([1.0]), torch.tensor([2.0]) train_y1, train_y2 = torch.tensor([2.0]), torch.tensor([4.0]) pred_y1 = w * train_x1 loss1 = loss_func(pred_y1, train_y1) loss1.backward() \"\"\" w=1, train_x1=1, pred_y1=1 âˆ‚loss/âˆ‚w=2*(1-2)*1=-2 æ‰€ä»¥ w çš„æ¢¯åº¦ä¸º-2 \"\"\" print(f\"ç¬¬ä¸€æ¬¡æ¨å¯¼ä¹‹å w çš„æ¢¯åº¦ä¸º{w.grad}\") pred_y2 = w * train_x2 loss2 = loss_func(pred_y2, train_y2) loss2.backward() \"\"\" w=1, train_x2=2, pred_y1=4 âˆ‚loss/âˆ‚w=2*(2-4)*2=-8 æ‰€ä»¥ w çš„æ¢¯åº¦ä¸º-8 \"\"\" print(f\"ç¬¬äºŒæ¬¡æ¨å¯¼ä¹‹å w çš„æ¢¯åº¦ä¸º{w.grad}\") ä»£ç è¿è¡Œåä¼šå¾—åˆ° w çš„æ¢¯åº¦æ˜¯-10 è€Œä¸æ˜¯-8ï¼Œå› ä¸ºé‡‡ç”¨äº†æ¢¯åº¦ç´¯ç§¯$(-2) + (-8) = -10$ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆéœ€è¦åœ¨æ¯ä¸€æ¬¡åå‘ä¼ æ’­ä¹‹å‰å°†æ¢¯åº¦æ¸…é›¶ã€‚ ä¸ºä»€ä¹ˆ PyTorch é‡‡ç”¨æ¢¯åº¦ç´¯ç§¯å‘¢ï¼Ÿ è§£å†³æ˜¾å­˜ä¸è¶³ï¼šæ¢¯åº¦ç´¯ç§¯è®­ç»ƒï¼ˆGradient Accumulationï¼‰ å½“æ¨¡å‹æˆ–æ‰¹æ¬¡è¾ƒå¤§ï¼ˆå¦‚å¤§æ¨¡å‹ã€é«˜åˆ†è¾¨ç‡å›¾åƒï¼‰æ—¶ï¼Œæ˜¾å­˜å¯èƒ½æ— æ³•å®¹çº³ä¸€ä¸ªå®Œæ•´çš„å¤§æ‰¹æ¬¡æ•°æ®ï¼ˆä¾‹å¦‚æƒ³ä½¿ç”¨ atch_size=32ï¼Œä½†æ˜¾å­˜åªæ”¯æŒ batch_size=8ï¼‰ã€‚æ­¤æ—¶å¯ä»¥ï¼š å°†å¤§æ‰¹æ¬¡æ‹†åˆ†ä¸ºå¤šä¸ªå°æ‰¹æ¬¡ï¼ˆå¦‚ 4 ä¸ª batch_size=8ï¼‰ï¼› æ¯ä¸ªå°æ‰¹æ¬¡è®¡ç®—æ¢¯åº¦åä¸æ›´æ–°å‚æ•°ï¼Œè€Œæ˜¯ç´¯ç§¯æ¢¯åº¦ï¼ˆbackward() è‡ªåŠ¨+=ï¼‰ï¼› ç´¯ç§¯ 4 æ¬¡åï¼Œç”¨æ€»æ¢¯åº¦ï¼ˆç­‰ä»·äº batch_size=32 çš„æ¢¯åº¦ï¼‰æ›´æ–°ä¸€æ¬¡å‚æ•°ã€‚ è¿™æ ·æ—¢é¿å…äº†æ˜¾å­˜æº¢å‡ºï¼Œåˆç­‰ä»·äºä½¿ç”¨å¤§æ‰¹æ¬¡è®­ç»ƒï¼ˆä¿æŒæ¢¯åº¦ç»Ÿè®¡ç‰¹æ€§ä¸€è‡´ï¼‰ã€‚ å¤šæŸå¤±å‡½æ•°åœºæ™¯ï¼šåˆå¹¶ä¸åŒæŸå¤±çš„æ¢¯åº¦ python # å¤šä»»åŠ¡æŸå¤± loss_cls = cross_entropy(pred_cls, label_cls) # åˆ†ç±»æŸå¤± loss_reg = mse_loss(pred_reg, label_reg) # å›å½’æŸå¤± # åˆ†åˆ«åå‘ä¼ æ’­ï¼Œæ¢¯åº¦è‡ªåŠ¨ç´¯ç§¯ï¼ˆ+=ï¼‰ loss_cls.backward(retain_graph=True) # retain_graph ä¿ç•™è®¡ç®—å›¾ï¼Œä¾›ä¸‹ä¸€æ¬¡ backward loss_reg.backward() # ç”¨æ€»æ¢¯åº¦ï¼ˆcls æ¢¯åº¦ + reg æ¢¯åº¦ï¼‰æ›´æ–°å‚æ•° optimizer.step() optimizer.zero_grad() å¦‚æœ backward() æ˜¯ â€œèµ‹å€¼â€ï¼Œåˆ™ç¬¬äºŒä¸ªæŸå¤±çš„æ¢¯åº¦ä¼šè¦†ç›–ç¬¬ä¸€ä¸ªï¼Œå¯¼è‡´åªèƒ½ç”¨å•ä¸€æŸå¤±çš„æ¢¯åº¦æ›´æ–°ï¼Œæ— æ³•å®ç°å¤šæŸå¤±çš„è”åˆä¼˜åŒ–ã€‚ ","date":"2025-11-30","objectID":"/posts/cs224n-assignment2/:4:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 2","uri":"/posts/cs224n-assignment2/#è®­ç»ƒ"},{"categories":null,"content":" (a) MinGPTä»»åŠ¡(a) è¦æ±‚é˜…è¯» mingpt-demo/play_char.ipynb ä»£ç  ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#a-mingpt"},{"categories":null,"content":" 1. ä½ç½®ç¼–ç GPT ç”¨çš„ä½ç½®ç¼–ç ä¸æ˜¯æ­£ä½™å¼¦å‡½æ•°ï¼Œè€Œæ˜¯è‡ªè®­ç»ƒçš„å‚æ•°çŸ©é˜µï¼š python def __init__(self, ...): self.pos_emb = nn.Parameter(torch.zeros(1, config.block_size, config.n_embd)) def forward(self, idx, targets): position_embeddings = self.pos_emb[:, :t, :] x = self.drop(token_embeddings + position_embeddings) ä¹‹å‰æåˆ°è¿‡è¿™ä¸ªçš„å¥½å¤„æ˜¯è¡¨è¾¾èƒ½åŠ›æ¯”å•çº¯çš„æ­£ä½™å¼¦æ›´å¼ºã€‚ æ¯ä¸€ä¸ªæ–‡æœ¬è¾“å…¥éƒ½æ˜¯ç”¨åŒä¸€ä¸ª Position Embeddingï¼Œæ‰€ä»¥çŸ©é˜µçš„ size(0)=1ï¼Œç„¶åé€šè¿‡å¼ é‡å¹¿æ’­å°±å¥½äº†ã€‚ ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:1:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#1-ä½ç½®ç¼–ç "},{"categories":null,"content":" 2. å‚æ•°åˆå§‹åŒ–ä¹‹å‰æˆ‘ä»¬é€šè¿‡ nn.Linear æˆ–è€… nn.Embedding å®šä¹‰çš„æ¨¡å—ï¼ŒPyTorch ä¼šå¯¹ä»–ä»¬çš„å‚æ•°è¿›è¡Œé»˜è®¤ Kaiming åˆå§‹åŒ–ã€‚è¿™é‡Œ GPT æ‰‹åŠ¨å¯¹å‚æ•°è¿›è¡Œäº†åˆå§‹åŒ–å¦‚ä¸‹ï¼š python model.apply(init_function) apply æ–¹æ³•è¦æ±‚ä¼ å…¥ä¸€ä¸ªå½¢å‚ä¸º module çš„å‡½æ•°ï¼Œå®ƒä¼šéå†æ¨¡å‹çš„æ‰€æœ‰å­æ¨¡å—ï¼Œç„¶åç”¨ init_function æ–¹æ³•å¯¹å®ƒè¿›è¡Œå¤„ç†ã€‚ python def _init_weights(self, module): if isinstance(module, (nn.Linear, nn.Embedding)): module.weight.data.normal_(mean=0.0, std=0.02) if isinstance(module, nn.Linear) and module.bias is not None: module.bias.data.zero_() elif isinstance(module, nn.LayerNorm): module.bias.data.zero_() module.weight.data.fill_(1.0) å¯¹äº nn.Linear å’Œ nn.Embeddingï¼ŒGPT å°†å‚æ•°åˆå§‹åŒ–ä¸ºå‡å€¼ 0ï¼Œæ ‡å‡†å·® 0.02 çš„æ­£æ€åˆ†å¸ƒï¼Œçº¿æ€§å±‚çš„åç½®åˆå§‹åŒ–ä¸º 0ï¼ŒLayerNorm çš„ç¼©æ”¾å› å­è®¾ä¸º 1ã€‚ ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:1:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#2-å‚æ•°åˆå§‹åŒ–"},{"categories":null,"content":" 3. ä¼˜åŒ–å™¨GPT çš„ä¼˜åŒ–å™¨ç”¨çš„æ˜¯ AdamWï¼Œå®ƒé‡‡ç”¨äº† Weight Decay æ¥é˜²æ­¢æ¨¡å‹è¿‡æ‹Ÿåˆï¼Œè¿™å…¶å®ä¹Ÿå°±æ˜¯ L2 æ­£åˆ™åŒ–ã€‚ losstotal=loss+Î»âˆ¥Wâˆ¥2 \\text{loss}_{total} = \\text{loss} + \\lambda \\|W\\|^2 losstotalâ€‹=loss+Î»âˆ¥Wâˆ¥2 $\\lambda$ æ˜¯è¶…å‚æ•°ï¼ŒWeight Decay çš„ç³»æ•° $|W|^2$ æ˜¯å…¨éƒ¨å‚æ•°çš„å¹³æ–¹å’Œ åœ¨æŸå¤±å‡½æ•°ä¸­åŠ å…¥å‚æ•°çš„å¹³æ–¹å’Œï¼Œå°±å¯ä»¥åœ¨åå‘ä¼ æ’­çš„æ—¶å€™è®©æ¨¡å‹è¶‹å‘äºå‡å°å‚æ•°ï¼Œä»è€Œé™ä½æ¨¡å‹å¤æ‚åº¦ï¼Œå¢å¼ºæ³›åŒ–èƒ½åŠ›ã€‚ å‚æ•°ç±»å‹ ä¸ºä»€ä¹ˆä¸åŠ  / è¦åŠ  weight decay å®é™…å½±å“ Linear weight å‚æ•°é‡å·¨å¤§ï¼Œæ˜¯æ¨¡å‹è¡¨è¾¾èƒ½åŠ›çš„ä¸»è¦æ¥æºï¼Œå®¹æ˜“è¿‡æ‹Ÿåˆ â†’ å¿…é¡»åŠ  weight decay æ­£åˆ™åŒ– å¼ºçƒˆæ¨èåŠ  bias åªæœ‰ä¸€ç»´ï¼ˆæ¯ä¸ªç¥ç»å…ƒä¸€ä¸ªï¼‰ï¼Œå‚æ•°é‡æå°‘ï¼Œè¿‡æ‹Ÿåˆé£é™©å‡ ä¹ä¸º 0ï¼›åŠ äº†åè€Œä¼šå¹²æ‰°æ¢¯åº¦ä¿¡å·ï¼ˆbias åªéœ€è¦å¹³ç§»ï¼‰ åšå†³ä¸åŠ  LayerNorm Î³, Î² LayerNorm å‚æ•°æœ¬èº«å°±æ˜¯åšå½’ä¸€åŒ–çš„ï¼Œå¼ºåˆ¶è®©å®ƒä»¬å˜å°ä¼šç ´åå½’ä¸€åŒ–æ•ˆæœï¼ˆå°¤å…¶æ˜¯ Î³ æ˜¯ scale å‚æ•°ï¼ŒåŠ  decay ä¼šè®©æ¨¡å‹å€¾å‘äºè¾“å‡ºæ›´å°çš„æ–¹å·®ï¼Œæ•ˆæœå˜å·®ï¼‰ åšå†³ä¸åŠ  Embedding äº‰è®®æœ€å¤§ã€‚æ—©æœŸ GPT-2 ä¸åŠ ï¼Œåæ¥ LLaMA1/2ã€Qwenã€DeepSeek ç­‰å¾ˆå¤šæ¨¡å‹ä¹Ÿç»™ Embedding åŠ äº†å°çš„ weight decayï¼ˆ0.01~0.1ï¼‰ï¼Œå‘ç°èƒ½ç¨å¾®æå‡æ³›åŒ–ã€‚ç›®å‰ä¸¤ç§åšæ³•éƒ½æœ‰ å¯åŠ å¯ä¸åŠ  python optim_groups = [ {\"params\": [param_dict[pn] for pn in sorted(list(decay))], \"weight_decay\": train_config.weight_decay}, {\"params\": [param_dict[pn] for pn in sorted(list(no_decay))], \"weight_decay\": 0.0}, ] optimizer = torch.optim.AdamW(optim_groups, lr=train_config.learning_rate, betas=train_config.betas) ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:1:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#3-ä¼˜åŒ–å™¨"},{"categories":null,"content":" 4. å¤šå±‚æ„ŸçŸ¥æœºå¯ä»¥ç”¨ nn.Sequential ç›´æ¥ç»„åˆå¤šä¸ªæ¨¡å—ï¼Œä¸ç”¨è‡ªå·±å†ç»§æ‰¿ nn.Module ç„¶åå†™ forward ã€‚ python self.mlp = nn.Sequential( nn.Linear(config.n_embd, 4 * config.n_embd), nn.GELU(), nn.Linear(4 * config.n_embd, config.n_embd), nn.Dropout(config.resid_pdrop), ) ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:1:4","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#4-å¤šå±‚æ„ŸçŸ¥æœº"},{"categories":null,"content":" (b) é˜…è¯» src/dataset.pyAssignment 4 çš„æœ€ç»ˆç›®çš„æ˜¯å®Œæˆä¸€ä¸ªæ¨¡å‹ï¼Œå¯ä»¥è¯»å–ä¸€ç³»åˆ—çš„ Q\u0026A(æŸäººçš„å‡ºç”Ÿåœ°ç‚¹) ç„¶åå›ç­”é—®é¢˜ï¼Œä¾‹å¦‚ï¼š input: Where was Bryan Dubreuiel born? output: Atlanta æ¨¡å‹çš„è®­ç»ƒæ–¹å¼å¾ˆæœ‰æ„æ€ï¼Œå®ƒå¹¶éæ˜¯å°† Question è¾“å…¥ç„¶åè¾“å‡º Birthplaceï¼Œè€Œæ˜¯å°†æ•´ä¸ª Q\u0026A è¾“å‡ºè¿›å»ï¼Œç„¶åè¾“å‡ºç­”æ¡ˆçš„å®šä½ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªä»»åŠ¡ä¸æ˜¯ç”Ÿæˆç­”æ¡ˆï¼Œè€Œæ˜¯ â€œå®šä½ç­”æ¡ˆâ€ã€‚ text x: Where was Khatchig Mouradian born?â‡Lebanonâ‡â–¡â–¡â–¡â–¡ y: â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â‡Lebanonâ‡â–¡â–¡â–¡â–¡â–¡ å¦‚æœ y ä¸åŠ  PADï¼Œè€Œå˜æˆ Lebanon ï¼Œé‚£æ¨¡å‹ä¼šè¢«è®­ç»ƒæˆç”Ÿæˆé—®é¢˜åç›´æ¥ç”Ÿæˆç­”æ¡ˆï¼Œæ¨¡å‹å°±ä¼šå­¦åˆ°ï¼š â€œWhere wasâ€¦ born?â€ â†’ Lebanon å®ƒå°±æˆäº†æ–‡æœ¬ç”Ÿæˆæ¨¡å‹ï¼Œè€Œä¸æ˜¯æŠ½å–æ¨¡å‹ã€‚ä½†è¿™ä¸ªä»»åŠ¡æ˜¯æŠ½å–å¼ QAï¼Œå¸Œæœ›æ¨¡å‹å­¦ä¼šï¼šåœ¨ x çš„ä¸Šä¸‹æ–‡é‡Œå®šä½ç­”æ¡ˆçš„ä½ç½®ã€ä¸æ˜¯ç”Ÿæˆç­”æ¡ˆï¼Œå› æ­¤ y å‰é¢çš„ä½ç½®å…¨éƒ¨ç”¨ PADã€‚ ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#b-é˜…è¯»-srcdatasetpy"},{"categories":null,"content":" (c) Finetune without pretraining python if args.variant == 'vanilla': # TODO: [part c] Make some model here from models import GPT model = GPT(mconf).to(device) elif args.function == 'finetune': assert args.writing_params_path is not None assert args.finetune_corpus_path is not None # [part c] ### YOUR CODE HERE ### from trainer import Trainer, TrainerConfig tconf = TrainerConfig( max_epochs=75, batch_size=256, learning_rate=args.finetune_lr, lr_decay=True, warmup_tokens=512*20, final_tokens=200*len(pretrain_dataset)*block_size, num_workers=4, writer=writer ) text = open(args.finetune_corpus_path, 'r').read() train_dataset = dataset.NameDataset(pretrain_dataset, text) trainer = Trainer(model, train_dataset, None, tconf) trainer.train() torch.save(model.state_dict(), args.writing_params_path) ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#c-finetune-without-pretraining"},{"categories":null,"content":" (d) é¢„æµ‹è¿è¡Œ scripts/run_vanilla_no_pretraining.bat å°±èƒ½çœ‹åˆ°åˆšåˆšå¾®è°ƒä½†æ²¡æœ‰é¢„è®­ç»ƒçš„æ¨¡å‹ï¼Œåœ¨æ•°æ®é›†ä¸Šé¢çš„è¡¨ç°äº†ã€‚æœ€ç»ˆçš„ç»“æœæ˜¯æ­£ç¡®ç‡ 1.8%ã€‚ å®éªŒè¿˜è®©æˆ‘ä»¬æ¯ä¸ªé—®é¢˜éƒ½é¢„æµ‹ London å°†ç»“æœå’Œä¹‹å‰çš„å¯¹æ¯”ï¼š python def main(): accuracy = 0.0 # Compute accuracy in the range [0.0, 100.0] predictions = [\"London\" for _ in range(2000)] total, correct = utils.evaluate_places(r\"/root/cs224n/birth_places_train.tsv\", predictions) accuracy = correct / total return accuracy è¾“å‡ºçš„å‡†ç¡®ç‡æ˜¯ 4.55 %ã€‚ ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:4:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#d-é¢„æµ‹"},{"categories":null,"content":" (e) Span CorruptionSpan Corrutpion è·¨åº¦ç ´åï¼Œæ˜¯ä¸€ç§é¢„è®­ç»ƒçš„æ–¹æ³•ï¼Œä¹‹å‰åœ¨ Lecture 9 ä»‹ç»è¿‡ã€‚ä½†æ˜¯ä¹‹å‰ä»‹ç»çš„ Span Corruption æ˜¯ Encoder-Decoder æ¶æ„çš„ï¼Œå¹¶ä¸”æ¨¡å‹å‚æ•°/è®­ç»ƒæ•°æ®é‡å¤§ï¼Œæ‰€ä»¥è¿™æ¬¡çš„ Span Corruption æœ‰æ‰€ä¸åŒã€‚ ç®€å•æ¥è¯´ï¼Œä»¥ â€œI want to be an engineerâ€ è¿™ä¸ªå¥å­ä¸ºä¾‹ï¼š æˆªå– document å‰é¢ä¸€ä¸ªéƒ¨åˆ†ï¼Œå¹³å‡é•¿åº¦ä¸º block_size çš„ 7/8ï¼Œæœ€çŸ­ä¸º 4ã€‚ å°† document åˆ†ä¸º prefix + masked + suffix ä¸‰éƒ¨åˆ†ï¼Œprefix å’Œ masked ä¸¤éƒ¨åˆ†å¹³å‡é•¿åº¦ä¸º document çš„ 1/4ã€‚ å°† document é‡æ–°ç»„è£…ä¸º prefix + mask_char + suffix + mask_char + masked + pad_charï¼Œé•¿åº¦ä¸º block_size + 1ã€‚ æœ€åå¾—åˆ°å½¢å¦‚ â€œI want??an engineer?? to be â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â€ çš„å¥å­ã€‚ç”±äº GPT æ˜¯ä¸€ä¸ª Decoder Only çš„ç»“æ„ï¼Œæ‰€ä»¥æ˜¯è‡ªå›å½’è®­ç»ƒï¼Œè¿˜éœ€è¦è°ƒæ•´ä¸º x, y = document[:-1], document[1:] æˆ‘åœ¨çœ‹ CharCorruption çš„æ—¶å€™å¾ˆå¥‡æ€ªï¼Œä¸ºä»€ä¹ˆå¤„ç†æ–‡æœ¬å¤„ç†çš„è¿™ä¹ˆå¥‡æ€ªã€‚æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ T5 Span Corruption æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼š å‡è®¾æœ‰æ–‡æœ¬ â€œWhat are you doing Jennie?\"ï¼Œä¼šéšæœºé€‰æ‹©å‡ ä¸ª span è¿›è¡Œ maskï¼Œå¾—åˆ° input: What â€œmaskedâ€ doing â€œmaskedâ€ output: â€œmaskedâ€ are you â€œmaskedâ€ Jennie? æ€è€ƒä¹‹åæˆ‘æ‰å‘ç°è¿™æ˜¯å› ä¸º Decoder-Only æ¶æ„çš„å±€é™æ€§ï¼Œå®ƒæ²¡æ³•åƒ Encoder-Decoder ç»“æ„ä¸€æ ·å¯ä»¥æŠŠ Mask é‡Œé¢çš„ä¿¡æ¯åœ¨ Encoder ä¸­å‘Šè¯‰æ¨¡å‹ï¼Œåªèƒ½æŠŠ Mask çš„éƒ¨åˆ†æ‹¼æ¥åœ¨åé¢ã€‚T5ï¼ˆencoder-decoderï¼‰å¯ä»¥è‚†æ— å¿Œæƒ®åœ°æŠŠä¸€æ®µæ–‡å­—ç›´æ¥åˆ æ‰ï¼Œæ›¿æ¢æˆ Mask ï¼Œå› ä¸º Encoder å·²ç»æŠŠåŸæ–‡å…¨çœ‹è¿‡äº†ï¼Œä¸Šä¸‹æ–‡ä¿¡æ¯å·²ç»ç¼–ç è¿›éšè—çŠ¶æ€äº†ï¼ŒDecoder åªç®¡ä» sentinel token å¼€å§‹ç”Ÿæˆè¢«åˆ æ‰çš„å†…å®¹å°±è¡Œã€‚ä½† GPT(decoder-only) æ¨¡å‹æ˜¯å› æœè‡ªå›å½’ï¼Œå®ƒæ¯ä¸€æ­¥åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ tokenã€‚å¦‚æœä½ åœ¨ä¸­é—´ç›´æ¥æŠŠä¸€æ®µåˆ æ‰æ¢æˆ â‡ï¼Œæ¨¡å‹åœ¨é¢„æµ‹æ—¶æ ¹æœ¬ä¸çŸ¥é“è¢«åˆ æ‰çš„å†…å®¹é•¿ä»€ä¹ˆæ ·ï¼Œç­‰åˆ°åé¢æƒ³è®©å®ƒå¤åŸæ—¶ï¼Œä¿¡æ¯å·²ç»å½»åº•ä¸¢å¤±äº†ã€‚ python def __getitem__(self, idx): # TODO [part e]: see spec above document = self.data[idx] document = document[:(tsize := random.randint(4, int(self.block_size*7/8)))] prefix = document[:(psize := random.randint(1, int(tsize/4)))] masked_document = document[psize:psize+(msize := random.randint(1, int(tsize/4)))] suffix = document[psize + msize:] output = prefix + self.MASK_CHAR + suffix + self.MASK_CHAR + masked_document output += self.PAD_CHAR * (self.block_size + 1 - len(output)) x, y = output[:-1], output[1:] return torch.tensor([self.stoi[c] for c in x], dtype=torch.long), torch.tensor([self.stoi[c] for c in y], dtype=torch.long) ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:5:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#e-span-corruption"},{"categories":null,"content":" (f) Finetune with pretrainingä¹‹å‰çš„å®éªŒå¯ä»¥çœ‹åˆ°ï¼Œæ¨¡å‹ä¸è¿›è¡Œé¢„è®­ç»ƒç›´æ¥å¾®è°ƒåçš„ç»“æœéå¸¸ç³Ÿç³•ï¼Œæ‰€ä»¥ (f) ä»»åŠ¡å°±è¦æ±‚å…ˆè¿›è¡Œé¢„è®­ç»ƒã€‚ åœ¨è¿™é‡Œå†æ˜ç¡®ä¸€ä¸‹: é¢„è®­ç»ƒå’Œå¾®è°ƒéƒ½æ˜¯ trainï¼Œåªæ˜¯æ•°æ®ã€ä»»åŠ¡ç›®æ ‡ã€è®­ç»ƒæ–¹å¼ä¸åŒã€‚ é¢„è®­ç»ƒï¼šé¢„è®­ç»ƒä»»åŠ¡æ˜¯ CharCorruptionï¼Œè®­ç»ƒæ–¹æ³•æ˜¯è‡ªå›å½’ å¾®è°ƒï¼šé¢„è®­ç»ƒä»»åŠ¡æ˜¯ç»™å‡ºå®Œæ•´ Q\u0026A ç„¶åå®šä½åˆ°ç­”æ¡ˆï¼Œè®­ç»ƒæ–¹æ³•ä¹Ÿæ˜¯è‡ªå›å½’ æ‰€ä»¥é¢„è®­ç»ƒçš„ä»£ç å°±å¾ˆç®€å•äº†ï¼š python if args.function == 'pretrain': assert args.writing_params_path is not None # TODO [part f]: from trainer import Trainer, TrainerConfig tconf = TrainerConfig( max_epochs=650, batch_size=128, learning_rate=args.pretrain_lr, lr_decay=True, warmup_tokens=512*20, final_tokens=650*len(pretrain_dataset)*block_size, num_workers=4, writer=writer, ) trainer = Trainer(model, train_dataset, test_dataset) trainer.train() torch.save(model.state_dict(), args.writing_params_path) å®éªŒç»“æŸåœ¨æµ‹è¯•é›†ä¸Šæ­£ç¡®ç‡æ˜¯ 5%ï¼Œæ²¡æœ‰è¾¾åˆ°ä½œä¸šè¦æ±‚ã€‚æŠŠ CharCorruption é‡Œé¢ prefix å’Œ mask é•¿åº¦æ”¹ä¸ºå¥å­çš„ 1/2 ä¹‹åæ­£ç¡®ç‡è¾¾åˆ° 15% äº†ã€‚ ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:6:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#f-finetune-with-pretraining"},{"categories":null,"content":" (g) RoPERoPE çš„å…·ä½“å®ç°å‚è€ƒæ–‡ç«  RoPE python def precompute_rotary_emb(dim, max_positions): rope_cache = None # TODO: [part g] # theta.shape = [dim/2, ] theta = 1.0 / (10000 ** (torch.arange(0, dim, 2, dtype=torch.float32) / dim)) positions = torch.arange(max_positions) freqs = torch.outer(positions, theta) cos, sin = torch.cos(freqs), torch.sin(freqs) rope_cache = torch.stack([cos, sin], dim=-1) return rope_cache python def apply_rotary_emb(x, rope_cache): \"\"\"Apply the RoPE to the input tensor x.\"\"\" rotated_x = None ### YOUR CODE HERE ### _, _, seq_len, dim = x.shape rot = torch.view_as_complex(rope_cache[:seq_len, ...]) rotated_x = x.view(*x.shape[:-1], dim // 2, 2) rotated_x = torch.view_as_complex(rotated_x) rotated_x = rotated_x * rot rotated_x = torch.view_as_real(rotated_x).reshape_as(x) ### END YOUR CODE ### return rotated_x æœ€å MHA é‡Œé¢æŠŠ Query å’Œ Key è¿›è¡Œæ—‹è½¬å°±å¥½ python def forward(self, x): B, T, C = x.size() # calculate query, key, values for all heads in batch and move head forward to be the batch dim k = self.key(x).view(B, T, self.n_head, C // self.n_head).transpose(1, 2) # (B, nh, T, hs) q = self.query(x).view(B, T, self.n_head, C // self.n_head).transpose(1, 2) # (B, nh, T, hs) v = self.value(x).view(B, T, self.n_head, C // self.n_head).transpose(1, 2) # (B, nh, T, hs) if self.rope: q = apply_rotary_emb(q, self.rope_cache) k = apply_rotary_emb(k, self.rope_cache) # ...Â ","date":"2025-11-30","objectID":"/posts/cs224n-assignment4/:7:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 4","uri":"/posts/cs224n-assignment4/#g-rope"},{"categories":null,"content":" ä½œç”¨RoPE ç›¸å¯¹äºæ­£ä½™å¼¦ä½ç½®ç¼–ç å’Œå¯å­¦ä¹ ä½ç½®ç¼–ç ï¼Œæ›´èƒ½å¤Ÿè¡¨è¾¾ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼Œä¾¿äºæ¨¡å‹æ•æ‰åºåˆ—ä¸­å…ƒç´ ä¹‹é—´çš„å…³ç³»ï¼Œè¿˜ä¾¿äºæ¨¡å‹æ³›åŒ–åˆ°æ›´é•¿çš„åºåˆ—ï¼Œæ”¯æŒè¶…é•¿æ–‡æœ¬æ¨ç†ã€‚ RoPE çš„æ€è·¯ï¼šå¯¹ Q,K çŸ©é˜µè¿›è¡Œæ—‹è½¬ï¼Œä½¿è®¡ç®—å¾—åˆ°çš„æ³¨æ„åŠ›æƒé‡å¤©ç„¶å¸¦æœ‰ä¸¤ä¸ª token ä¹‹é—´çš„ç›¸å¯¹è·ç¦»ã€‚ ","date":"2025-11-28","objectID":"/posts/rope/:1:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","Transformer"],"title":"RoPE","uri":"/posts/rope/#ä½œç”¨"},{"categories":null,"content":" å…¬å¼æ¨å¯¼å¯¹è¾“å…¥åºåˆ— ${x_0, x_1, \\dots}$ï¼Œå‡è®¾æˆ‘ä»¬å–ä¸¤ä¸ª tokenï¼šç¬¬ m ä¸ªå’Œç¬¬ n ä¸ª xm,Â xnâˆˆRdmodel x_m,\\ x_n \\in \\mathbb{R}^{d_{\\text{model}}} xmâ€‹,Â xnâ€‹âˆˆRdmodelâ€‹æ–¹ä¾¿æ¨å¯¼ï¼Œå…ˆå‡è®¾ $d_{\\text{model}} = 2$ã€‚ä»¤å®ƒä»¬çš„ Queryã€Key ä¸ºï¼š qm=Wqxm,kn=Wkxn q_m = W_q x_m,\\quad k_n = W_k x_n qmâ€‹=Wqâ€‹xmâ€‹,knâ€‹=Wkâ€‹xnâ€‹æ³¨æ„åŠ›çš„æ ¸å¿ƒæ˜¯å†…ç§¯ï¼š âŸ¨qm,Â knâŸ©=qmâŠ¤kn \\langle q_m,\\ k_n\\rangle = q_m^\\top k_n âŸ¨qmâ€‹,Â knâ€‹âŸ©=qmâŠ¤â€‹knâ€‹RoPE çš„æƒ³æ³•æ˜¯ç”¨â€œæ—‹è½¬â€åçš„ Q/K æ¥è®¡ç®—å†…ç§¯ï¼š âŸ¨qmrope,Â knropeâŸ© \\langle q_m^{rope},\\ k_n^{rope}\\rangle âŸ¨qmropeâ€‹,Â knropeâ€‹âŸ©å…¶ä¸­ qmrope=qmeimÎ¸,knrope=kneinÎ¸ q_m^{rope} = q_m e^{i m\\theta},\\qquad k_n^{rope} = k_n e^{i n\\theta} qmropeâ€‹=qmâ€‹eimÎ¸,knropeâ€‹=knâ€‹einÎ¸ è¿™é‡Œè¡¥å……ä¸€ä¸‹å‘é‡æ—‹è½¬çš„çŸ¥è¯†ç‚¹ï¼š å¤æ•°çš„å½¢å¼æ˜¯ï¼š z=a+bi z = a + bi z=a+biå…¶ä¸­ a æ˜¯å®éƒ¨ï¼Œb æ˜¯è™šéƒ¨ï¼Œi æ˜¯è™šæ•°å•ä½ã€‚å¦‚æœä½ æŠŠå¤å¹³é¢ç”»å‡ºæ¥ï¼Œä¼šå‘ç°å®ƒå’Œæ™®é€šçš„ 2D åæ ‡ç³»å®Œå…¨ä¸€æ ·ï¼š æ¨ªè½´ = å®è½´ï¼ˆreal axisï¼‰ çºµè½´ = è™šè½´ï¼ˆimag axisï¼‰ ä¸€ä¸ªç‚¹ $(x, y)$ å°±æ˜¯å¤æ•° $x + yi$ æ‰€ä»¥äºŒç»´å‘é‡ $(x, y)$ å¯ä»¥ç­‰ä»·åœ°å†™æˆå¤æ•° $z = x + yi$ï¼Œå¯¹äºä¸Šæ–‡çš„äºŒç»´å‘é‡ $x_m$ æœ‰ï¼š qm=[qm1qm2]=qm1+qm2i q_m = \\begin{bmatrix} q_m^1 \\\\ q_m^2 \\end{bmatrix} = q_m^1 + q_m^2i qmâ€‹=[qm1â€‹qm2â€‹â€‹]=qm1â€‹+qm2â€‹iå› ä¸ºå¤æ•°çš„ä¹˜æ³•ï¼Œå¤©ç„¶åŒ…å«äº†â€œæ—‹è½¬ + ç¼©æ”¾â€çš„æ“ä½œï¼Œå¯¹ä¸€ä¸ªå¤æ•° $z = x + yi$ï¼Œä¹˜ä¸Šä¸€ä¸ªå•ä½æ¨¡çš„å¤æ•°ï¼š eiÎ¸=cosâ¡Î¸+isinâ¡Î¸ e^{i\\theta} = \\cos\\theta + i\\sin\\theta eiÎ¸=cosÎ¸+isinÎ¸å°±ä¼šè®©å®ƒç»•åŸç‚¹æ—‹è½¬è§’åº¦ $\\theta$ï¼Œå› æ­¤ $q_m^{rope} = q_m e^{i m\\theta}$ è¡¨ç¤ºæŠŠ $q_m$â€‹ æ—‹è½¬ $m\\theta$ã€‚ å¯¹ä»»æ„äºŒç»´å‘é‡åº”ç”¨äºŒç»´æ—‹è½¬çŸ©é˜µä¹Ÿå¯ä»¥é€†æ—¶é’ˆæ—‹è½¬ï¼š R(Î¸)=[cosâ¡Î¸âˆ’sinâ¡Î¸sinâ¡Î¸cosâ¡Î¸] \\begin{array}{c} R(\\theta) = \\begin{bmatrix} \\cos\\theta \u0026 -\\sin\\theta \\\\ \\sin\\theta \u0026 \\cos\\theta \\end{bmatrix} \\end{array} R(Î¸)=[cosÎ¸sinÎ¸â€‹âˆ’sinÎ¸cosÎ¸â€‹]â€‹æ—‹è½¬çŸ©é˜µçš„æ•ˆæœä¸ $e^{i m\\theta}$ ç›¸åŒï¼Œ è¯æ˜å¦‚ä¸‹ï¼š qmrope=qmeimÎ¸=[qm1qm2]eimÎ¸=(qmi+qm2i)(cosâ¡(mÎ¸)+isinâ¡(mÎ¸))=(qm1cosâ¡(mÎ¸)âˆ’qm2sinâ¡(mÎ¸))+i(qm2cosâ¡(mÎ¸)+qm1sinâ¡(mÎ¸))=[qm1cosâ¡(mÎ¸)âˆ’qm2sinâ¡(mÎ¸)qm2cosâ¡(mÎ¸)+qm1sinâ¡(mÎ¸)]=[cosâ¡(mÎ¸)âˆ’sinâ¡(mÎ¸)sinâ¡(mÎ¸)cosâ¡(mÎ¸)][qm1qm2]=R(mÎ¸)[qm1qm2] \\begin{align} q_m^{rope}\u0026=q_me^{im\\theta}\\\\ \u0026=\\begin{bmatrix}q_m^1\\\\q_m^2\\end{bmatrix}e^{im\\theta}\\\\ \u0026=(q_m^i+q_m^2i)(\\cos(m\\theta) + i\\sin(m\\theta))\\\\ \u0026=(q_m^1\\cos(m\\theta)-q_m^2\\sin(m\\theta)) + i(q_m^2\\cos(m\\theta) + q_m^1\\sin(m\\theta))\\\\ \u0026=\\begin{bmatrix}q_m^1\\cos(m\\theta)-q_m^2\\sin(m\\theta)\\\\q_m^2\\cos(m\\theta) + q_m^1\\sin(m\\theta)\\end{bmatrix}\\\\ \u0026=\\begin{bmatrix}\\cos(m\\theta) \u0026 -\\sin(m\\theta) \\\\\\sin(m\\theta) \u0026 \\cos(m\\theta)\\end{bmatrix}\\begin{bmatrix}q_m^1\\\\q_m^2\\end{bmatrix} \\\\ \u0026=R(m\\theta)\\begin{bmatrix}q_m^1\\\\q_m^2\\end{bmatrix} \\end{align} qmropeâ€‹â€‹=qmâ€‹eimÎ¸=[qm1â€‹qm2â€‹â€‹]eimÎ¸=(qmiâ€‹+qm2â€‹i)(cos(mÎ¸)+isin(mÎ¸))=(qm1â€‹cos(mÎ¸)âˆ’qm2â€‹sin(mÎ¸))+i(qm2â€‹cos(mÎ¸)+qm1â€‹sin(mÎ¸))=[qm1â€‹cos(mÎ¸)âˆ’qm2â€‹sin(mÎ¸)qm2â€‹cos(mÎ¸)+qm1â€‹sin(mÎ¸)â€‹]=[cos(mÎ¸)sin(mÎ¸)â€‹âˆ’sin(mÎ¸)cos(mÎ¸)â€‹][qm1â€‹qm2â€‹â€‹]=R(mÎ¸)[qm1â€‹qm2â€‹â€‹]â€‹â€‹ åŸºäºå‰é¢çš„å‘é‡æ—‹è½¬çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬è¿›è€Œå¾—åˆ°ï¼š \u003cqmrope,knrope\u003e=\u003cR(mÎ¸)qm,R(nÎ¸)kn\u003e=qmTRT(mÎ¸)R(nÎ¸)kn=qmTR(âˆ’mÎ¸)R(nÎ¸)kn=qmTR((nâˆ’m)Î¸)kn \\begin{align} \u003cq_m^{rope}, k_n^{rope}\u003e\u0026=\u003cR(m\\theta)q_m, R(n\\theta)k_n\u003e\\\\ \u0026=q_m^TR^T(m\\theta)R(n\\theta)k_n\\\\ \u0026=q_m^TR(-m\\theta)R(n\\theta)k_n\\tag{è¯æ˜1.1}\\\\ \u0026=q_m^TR((n-m)\\theta)k_n\\tag{è¯æ˜1.2} \\end{align} \u003cqmropeâ€‹,knropeâ€‹\u003eâ€‹=\u003cR(mÎ¸)qmâ€‹,R(nÎ¸)knâ€‹\u003e=qmTâ€‹RT(mÎ¸)R(nÎ¸)knâ€‹=qmTâ€‹R(âˆ’mÎ¸)R(nÎ¸)knâ€‹=qmTâ€‹R((nâˆ’m)Î¸)knâ€‹â€‹(è¯æ˜1.1)(è¯æ˜1.2)â€‹è‡³æ­¤å°±å¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨ RoPE å¯¹å‘é‡è¿›è¡Œæ—‹è½¬åï¼Œæ³¨æ„åŠ›æƒé‡å°±ä¸ä¸¤ä¸ª token ä¹‹é—´è·ç¦»ç›¸å…³äº†ã€‚ä¸¤ä¸ª token è·ç¦»è¶Šè¿œï¼Œn-m è¶Šå¤§ï¼Œæ—‹è½¬è§’åº¦è¶Šå¤§ï¼Œæ³¨æ„åŠ›æƒé‡è¶Šå°ã€‚ è¯æ˜-1.1ï¼š RT(Î¸)=[cosâ¡Î¸sinâ¡Î¸âˆ’sinâ¡Î¸cosâ¡Î¸]=[cosâ¡(âˆ’Î¸)âˆ’sinâ¡(âˆ’Î¸)sinâ¡(âˆ’Î¸)cosâ¡(âˆ’Î¸)]=R(âˆ’Î¸) \\begin{array}{c} R^T(\\theta) = \\begin{bmatrix} \\cos\\theta \u0026 \\sin\\theta \\\\ -\\sin\\theta \u0026 \\cos\\theta \\end{bmatrix} =\\begin{bmatrix} \\cos(-\\theta) \u0026 -\\sin(-\\theta) \\\\ \\sin(-\\theta) \u0026 \\cos(-\\theta) \\end{bmatrix} = R(-\\theta) \\end{array} RT(Î¸)=[cosÎ¸âˆ’sinÎ¸â€‹sinÎ¸cosÎ¸â€‹]=[cos(âˆ’Î¸)sin(âˆ’Î¸)â€‹âˆ’sin(âˆ’Î¸)cos(âˆ’Î¸)â€‹]=R(âˆ’Î¸)â€‹è¯æ˜-1.2ï¼š R(âˆ’mÎ¸)R(nÎ¸)Â âŸ·Â eâˆ’imÎ¸einÎ¸=ei(nâˆ’m)Î¸=R((nâˆ’m)Î¸) R(-m\\theta)R(n\\theta)\\ \\longleftrightarrow\\ e^{-im\\theta}e^{in\\theta}=e^{i(n-m)\\theta}=R((n-m)\\theta) R(âˆ’mÎ¸)R(nÎ¸)Â âŸ·Â eâˆ’imÎ¸einÎ¸=ei(nâˆ’m)Î¸=R((nâˆ’m)Î¸) æ‰©å±•åˆ°é«˜ç»´å°±æœ‰ï¼š å¯ä»¥çœ‹åˆ°çŸ©é˜µè®¡ç®—æ—¶å€™æœ‰éå¸¸å¤šçš„ 0ï¼Œå¢å¤§äº†è®¡ç®—é‡ï¼Œç®€ä¾¿æ–¹æ³•å°±æ˜¯ï¼š å¹¶ä¸”æœ‰ï¼š Î¸i=10000âˆ’2i/d \\theta_i=10000^{-2i/d} Î¸iâ€‹=10000âˆ’2i/d","date":"2025-11-28","objectID":"/posts/rope/:2:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","Transformer"],"title":"RoPE","uri":"/posts/rope/#å…¬å¼æ¨å¯¼"},{"categories":null,"content":" ä»£ç ","date":"2025-11-28","objectID":"/posts/rope/:3:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","Transformer"],"title":"RoPE","uri":"/posts/rope/#ä»£ç "},{"categories":null,"content":" çº¿æ€§ç»„åˆ python def linear_RoPE(qk: torch.Tensor): # x = [bs, len, dmodel] _, seq_len, d_model = qk.size() assert d_model % 2 == 0 position = torch.arange(seq_len, dtype=torch.float) # [max_len] freq = 1.0 / (10000 ** (torch.arange(0, dim, 2, dtype=torch.float32) / dim)) sinusoid = torch.outer(position, freq) cos, sin = torch.cos(sinusoid), torch.sin(sinusoid) even, odd = qk[..., 0::2], qk[..., 1::2] rotated_even = even * cos - odd * sin rotated_odd = odd * cos + even * sin return torch.stack([rotated_even, rotated_odd], dim=-1).reshape_as(qk) ä»£ç çš„æœ´ç´ å®ç°å°±æ˜¯ä¸€æ¯”ä¸€å‚è€ƒä¸Šå›¾ã€‚ é¦–å…ˆè®¡ç®—é¢‘ç‡ï¼Œä¹Ÿå°±æ˜¯ä¸Šå›¾çš„ $m\\theta$ï¼Œéœ€è¦æ³¨æ„å›¾ç‰‡é‡Œé¢æ˜¯ä¸€ç»´å‘é‡ï¼Œä½†å®é™…ä¸Šåº”è¯¥æ˜¯ä¸‰ç»´çš„ [batch_size, seq_len, d_model//2]ã€‚æˆ‘ä»¬å¯ä»¥æ„é€ å‡º 0-seq_len-1 çš„å‘é‡å’Œ $\\theta_0$-$\\theta_{d/2-1}$ å‘é‡ï¼Œç„¶åæ±‚å¤–ç§¯(ps: torch.outer ç­‰åŒäº unsqueeze(1) ä¹‹åé€ç‚¹ç›¸ä¹˜)å°±èƒ½å¾—åˆ° [seq_len, d_model//2]ã€‚ ç„¶åå°†è¾“å…¥çŸ©é˜µçš„ d_model ä¸ºæŒ‰ç…§å¥‡å¶åˆ†å¼€ã€‚ æœ€åå¶æ•°åˆ—å°±æ˜¯ â€œå¶æ•°åˆ—*cos-å¥‡æ•°åˆ—*sinâ€ï¼Œå¥‡æ•°åˆ—å°±æ˜¯ â€œå¥‡æ•°åˆ—*cos+å¶æ•°åˆ—*sinâ€ é€šè¿‡ torch.stack å åŠ åœ¨ç¬¬å››ç»´ï¼Œç„¶åå† reshape äº¤é”™æ‹¼æ¥åœ¨ç¬¬ä¸‰ç»´ã€‚ ","date":"2025-11-28","objectID":"/posts/rope/:3:1","series":["LLM"],"tags":["å¤§æ¨¡å‹","Transformer"],"title":"RoPE","uri":"/posts/rope/#çº¿æ€§ç»„åˆ"},{"categories":null,"content":" LLaMA python def llama_RoPE(qk: torch.Tensor): _, _, seq_len, dim = qk.shape assert dim % 2 == 0, \"dim must be even\" qk_complex = qk.view(*qk.shape[:-1], dim//2, 2) # [bsize, nheads, seq_len, dim//2, 2] qk_complex = torch.view_as_complex(qk_complex) # [bsize, nheads, seq_len, dim//2] position = torch.arange(seq_len, dtype=torch.float) # [max_len] freq = 1.0 / (10000 ** (torch.arange(0, dim, 2, dtype=torch.float32) / dim)) sinusoid = torch.outer(position, freq) rot = torch.exp(1j * sinusoid) # [seq_len, dim//2] # rot = torch.polar(torch.ones_like(sinusoid), sinusoid) rotated_qk_complex = qk_complex * rot rotated_qk = torch.view_as_real(rotated_qk_complex) # [bsize, nheads, seq_len, dim//2, 2] rotated_qk = rotated_qk.view_as(qk) return rotated_qk LLaMA çš„å®ç°æ–¹å¼æ›´æ¥è¿‘ RoPE æœ€æœ´ç´ çš„æƒ³æ³•ï¼šå¯¹ Q/K è¿›è¡Œæ—‹è½¬ï¼Œå®ƒç­‰ä»·äºå¯¹ Q/K çš„æ¯å¯¹ç»´åº¦è¿›è¡Œä¸€ä¸ªäºŒç»´æ—‹è½¬ï¼š ","date":"2025-11-28","objectID":"/posts/rope/:3:2","series":["LLM"],"tags":["å¤§æ¨¡å‹","Transformer"],"title":"RoPE","uri":"/posts/rope/#llama"},{"categories":null,"content":" $$ \\begin{pmatrix} xâ€™{2i}\\ xâ€™{2i+1} \\end{pmatrix}\\begin{pmatrix} \\cos\\theta \u0026 -\\sin\\theta\\ \\sin\\theta \u0026 \\cos\\theta \\end{pmatrix} \\begin{pmatrix} x_{2i}\\ x_{2i+1} \\end{pmatrix} $$ LLaMA çš„æƒ³æ³•æ˜¯ æŠŠäºŒç»´å‘é‡çœ‹æˆå¤æ•°ï¼ŒäºŒç»´æ—‹è½¬çŸ©é˜µå®é™…ä¸Šç­‰ä»·äºä¹˜ä¸Šå¤æ•°ï¼š$e^{j\\theta} = \\cos\\theta + j\\sin\\theta$ ã€‚qk_complex å°±æ˜¯å°† qk æœ€åä¸€ä¸ªç»´åº¦ä¸¤ä¸¤æ‹†å¼€ç»„æˆå¤æ•°ï¼Œç„¶åå’Œå•ä½æ¨¡å¤æ•°ç›¸ä¹˜å°†å…¶æ—‹è½¬ï¼Œæœ€åå†è¿˜åŸä¸ºäºŒç»´å‘é‡ã€‚ ","date":"2025-11-28","objectID":"/posts/rope/:0:0","series":["LLM"],"tags":["å¤§æ¨¡å‹","Transformer"],"title":"RoPE","uri":"/posts/rope/#endpmatrix"},{"categories":null,"content":" åŒå‘ LSTMæœ‰äº›æ—¶å€™é¢„æµ‹å¯èƒ½éœ€è¦ç”±å‰é¢è‹¥å¹²è¾“å…¥å’Œåé¢è‹¥å¹²è¾“å…¥å…±åŒå†³å®šï¼Œè¿™æ ·ä¼šæ›´åŠ å‡†ç¡®ã€‚å› æ­¤æå‡ºäº†åŒå‘å¾ªç¯ç¥ç»ç½‘ç»œï¼Œç½‘ç»œç»“æ„å¦‚ä¸‹å›¾ã€‚å¯ä»¥çœ‹åˆ° Forward å±‚å’Œ Backward å±‚å…±åŒè¿æ¥ç€è¾“å‡ºå±‚ï¼Œå…¶ä¸­åŒ…å«äº† 6 ä¸ªå…±äº«æƒå€¼ w1-w6ã€‚ ","date":"2025-11-27","objectID":"/posts/bilstm/:1:0","series":["DeepLearning"],"tags":["Module","æ·±åº¦å­¦ä¹ "],"title":"Bilateral LSTM","uri":"/posts/bilstm/#åŒå‘-lstm"},{"categories":null,"content":" ä»£ç å®ç°åœ¨ GPT è¿‡ç¨‹ä¸­å‘ç°äº†ä¸€ç§è®¡ç®—æ•ˆç‡æ›´é«˜çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹: python class LSTM(nn.Module): def __init__(self): self.Wih = nn.Parameter(torch.empty(4*H, B)) self.Whh = nn.Parameter(torch.empty(4*H, B)) self.Bih = nn.Parameter(torch.empty(4*H)) self.Bhh = nn.Parameter(torch.empty(4*H)) self.setup_parameter() def forward(self, x): h_prev = x.new_zeros(2, B, H) c_prev = x.new_zeros(2, B, H) h, c = [], [] seq_len, batch_size, embed_size = x.shape for i in range(seq_len): x_t = x[i] # x[i] = x[i, :, :] gates = F.linear(x_t, self.Wih, self.Bih) + F.linear(h_prev, self.Whh, self.Bhh) f, i, o, g = gates.chunk(4, dim=1) f, i, o, g = torch.sigmoid(f), torch.sigmoid(i), torch.tanh(g), torch.sigmoid(o) c_prev = f * c_prev + i * g h_prev = o * torch.tanh(c_prev) h.append(h_prev) c.append(c_prev) h = torch.stack(h, dim=0) åœ¨åˆå§‹åŒ–å‚æ•°æ—¶ï¼Œå°†åŸå…ˆçš„ 2*4 ä¸ª Weight ç›´æ¥åˆå¹¶åˆ°ä¸€ä¸ªçŸ©é˜µä¸­ï¼Œä¹Ÿå°±æ˜¯å½¢çŠ¶ä» [Batch_size, Hidden_size] å˜æˆ [Batch_size, Hidden_size * 4]ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ä¸€æ¬¡çŸ©é˜µä¹˜æ³•ä»£æ›¿ä¹‹å‰å››æ¬¡çŸ©é˜µä¹˜æ³•ã€‚ä¹‹å chunk(4, dim=0) æŠŠè¿™æ¡ [B, 4H] çš„å¼ é‡æ²¿ç€ç»´åº¦ 1 å‡åˆ†æˆ 4 ä»½ï¼Œæ¯ä»½å½¢çŠ¶éƒ½æ˜¯ [B, H]ï¼Œå¹¶æŒ‰åºèµ‹å€¼ç»™ i, f, g, oã€‚ F.linear(x, w, b) ç­‰ä»·äº y = x * W^T + bï¼Œæ‰€ä»¥åœ¨å®šä¹‰å‚æ•°æ—¶å€™éœ€è¦å®šä¹‰ä¸º [H, B] çš„å½¢çŠ¶ã€‚ è¿™ç§å†™æ³•çš„å¥½å¤„åœ¨äºï¼šæˆ‘ä¹‹å‰çš„åšæ³•æ¯ä¸ªé—¨å„è‡ªä¸€å¥—æƒé‡ï¼ˆWhf/Wxfã€Whi/Wxiã€Who/Wxoã€Whc/Wxcï¼‰ï¼Œæ¯æ­¥è¦åš 8 æ¬¡ matmulï¼ˆ4 ä¸ªé—¨ Ã— 2 æ¡æ”¯è·¯ï¼šè¾“å…¥ä¸éšçŠ¶æ€ï¼‰å†é€é—¨ç›¸åŠ ï¼›åç½®ä¹Ÿåˆ†é—¨å•ç‹¬åŠ ã€‚æ–°çš„æ–¹æ³•æŠŠå››ä¸ªé—¨æ‹¼æˆä¸€ä¸ªå¤§çŸ©é˜µï¼Œç”¨ä¸¤æ¬¡ F.linear å°±æ‹¿åˆ°å…¨éƒ¨é—¨å€¼ï¼Œå†ç”¨ chunk(4) æ‹†æˆ i,f,g,oã€‚è¿™æ ·æ¯æ­¥åªéœ€ 2 æ¬¡ GEMMï¼Œæ˜¾è‘—æ›´é«˜æ•ˆï¼Œä¹Ÿæ›´æ¥è¿‘ nn.LSTM çš„å®ç°ã€‚ python import math from typing import Optional, Tuple import torch import torch.nn as nn import torch.nn.functional as F class BiLSTMManual(nn.Module): def __init__(self, input_size: int, hidden_size: int, batch_first: bool = True): super().__init__() self.input_size = input_size self.hidden_size = hidden_size self.batch_first = batch_first H, D = hidden_size, input_size # Forward direction parameters self.W_ih_f = nn.Parameter(torch.empty(4 * H, D)) self.W_hh_f = nn.Parameter(torch.empty(4 * H, H)) self.b_ih_f = nn.Parameter(torch.empty(4 * H)) self.b_hh_f = nn.Parameter(torch.empty(4 * H)) # Backward direction parameters self.W_ih_b = nn.Parameter(torch.empty(4 * H, D)) self.W_hh_b = nn.Parameter(torch.empty(4 * H, H)) self.b_ih_b = nn.Parameter(torch.empty(4 * H)) self.b_hh_b = nn.Parameter(torch.empty(4 * H)) self.reset_parameters() def reset_parameters(self): # Xavier for input weights, orthogonal for recurrent; forget gate bias to 1 for W in (self.W_ih_f, self.W_ih_b): nn.init.xavier_uniform_(W) for W in (self.W_hh_f, self.W_hh_b): nn.init.orthogonal_(W) for b in (self.b_ih_f, self.b_hh_f, self.b_ih_b, self.b_hh_b): nn.init.zeros_(b) # Set forget gate bias (second quarter) to 1 for b in (self.b_ih_f, self.b_hh_f, self.b_ih_b, self.b_hh_b): H4 = b.numel() // 4 b.data[H4 : 2 * H4].fill_(1.0) @staticmethod def _step(x_t, h_prev, c_prev, W_ih, W_hh, b_ih, b_hh): \"\"\"One LSTM step. x_t: [B, D]; h_prev, c_prev: [B, H] returns h_t, c_t \"\"\" gates = F.linear(x_t, W_ih, b_ih) + F.linear(h_prev, W_hh, b_hh) i, f, g, o = gates.chunk(4, dim=1) i = torch.sigmoid(i) f = torch.sigmoid(f) g = torch.tanh(g) o = torch.sigmoid(o) c_t = f * c_prev + i * g h_t = o * torch.tanh(c_t) return h_t, c_t def forward( self, x: torch.Tensor, hx: Optional[Tuple[torch.Tensor, torch.Tensor]] = None, ) -\u003e Tuple[torch.Tensor, Tuple[torch.Tensor, torch.Tensor]]: if self.batch_first: # [B, T, D] -\u003e [T, B, D] x = x.transpose(0, 1) T, B, D = x.shape H = self.hidden_size if hx is None: h0 = x.new_zeros(2, B, H) c0 = x.new_zeros(2, B, H) else: h0, c0 = hx assert h0.shape == (2, B, H) and c0.shape == (2, B, H) # Forward pass (left -\u003e right) h_f = [] h_prev_f = h0[0] c_prev_f = c0[0] for t in range(T): h_prev_f, c_prev_f = self._step( x[t], h_prev_f, c_prev_f, self.W_ih_f, self.W_hh_f, self.b_ih_f, self.b_hh_f ) h_f.append(h_prev_f) h_f = torch.stack(h_f, dim=0) # [T, B, H] # Backward pass (right -\u003e left) h_b_rev = [] h_prev_b = h0[1] c_prev_b = c0[1] for t in reversed(range(T)): h_prev_b, c_prev_b = self._step( x[t], h_prev_b, c_prev_b, self.W_ih_b, self.W_hh_b, self.b_ih_b, self.b_hh_b ) h_b_rev.append(h_prev_b) h_b_rev = torch.stack(h_b_rev, dim=0) # [T, B, H] in reversed time h_b = torch.flip(h_b_rev, dims=[0","date":"2025-11-27","objectID":"/posts/bilstm/:1:1","series":["DeepLearning"],"tags":["Module","æ·±åº¦å­¦ä¹ "],"title":"Bilateral LSTM","uri":"/posts/bilstm/#ä»£ç å®ç°"},{"categories":null,"content":" Subword Modelingåœ¨è¿‡å»çš„å®è·µä¸­ï¼Œæˆ‘ä»¬å¤„ç†æ–‡æœ¬ä¼šå…ˆè¿›è¡Œåˆ†è¯ï¼Œç„¶åæŠŠä¸€ä¸ªä¸ª token è½¬æ¢ä¸ºå…¶å¯¹åº”çš„ idx ç´¢å¼•ï¼Œåœ¨ç”¨å®ƒå»è¿›è¡Œè¯åµŒå…¥ã€‚ä½†è¿™æ ·çš„åšæ³•æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨æµ‹è¯•é›†ä¸­æˆ‘ä»¬é‡åˆ°æ²¡è§è¿‡çš„è¯è¯­å°±æŠŠä»–ç”¨ \u003cUNK\u003e æ¥æ›¿æ¢ï¼Œè¿™æ ·ä¼šä¸¢å¤±å¤§é‡çš„ä¿¡æ¯ã€‚ ç°ä»£ NLP æ¨¡å‹ä¸ä¼šç›´æ¥æŠŠå®Œæ•´å•è¯å½“ä½œåŸºæœ¬å•ä½ï¼Œè€Œæ˜¯æŠŠå•è¯æ‹†æˆè‹¥å¹² subwordsï¼ˆå­è¯ï¼‰æ¥è¡¨ç¤ºã€‚ å‡ºç°éå¸¸é¢‘ç¹çš„è¯ï¼ˆå¦‚ hatã€learnï¼‰ä¼šè¢«å½“ä½œ å®Œæ•´çš„è¯ æ”¾è¿›è¯è¡¨ï¼Œå°‘è§è¯ã€å¥‡æ€ªè¯ã€æ–°é€ è¯ä¼šè¢«æ‹†æˆå¤šä¸ªå­è¯ã€‚ å¦‚æœæ˜¯ç‰¹åˆ«å¥‡æ€ªçš„è¯ã€æ ¹æœ¬æ²¡è§è¿‡ã€å­—æ¯ç»„åˆå¾ˆæ€ªï¼Œæ¨¡å‹å¯èƒ½æŠŠæ¯ä¸ªå­—ç¬¦éƒ½æ‹†å¼€ã€‚ å¸¸ç”¨è¯ï¼šä¾‹å¦‚ hat, learn ç­‰è¯è¯­ï¼ŒEmbedding ä¼šå®Œæ•´å­¦ä¹ ä¸æ‹†åˆ†ã€‚ å˜ä½“ï¼šä¾‹å¦‚ taaaaastï¼Œä¼šæŠŠè¯è¯­æ‹†ä¸ºå¸¸è§çš„ Subword å’Œå¸¸ç”¨è¯çš„ç»„åˆ taa##aaa##styã€‚ æ‹¼å†™é”™è¯¯ï¼šlaernï¼Œæ¨¡å‹æ²¡è§è¿‡äºæ˜¯æ‹†åˆ†ä¸º la##ernï¼Œæ¨¡å‹æ²¡è§è¿‡è¿™ä¸ªé”™è¯ï¼Œæ‰€ä»¥åˆ†æˆå¤šä¸ªå­è¯ã€‚ æ–°è¯ / è‡ªåˆ›è¯ï¼šTransformerify æ‹†ä¸º Transformer## ifyã€‚ è¿™äº›æ‹†åˆ†åçš„ Subword ä¼šå¾—åˆ°å¤šä¸ª Embeddingï¼Œæˆ‘ä»¬å¯ä»¥å–æœ€åä¸€ä¸ª Embeddingï¼Œå¯¹ Embedding è¿›è¡Œå¹³å‡ï¼Œæˆ–è€…ç”¨ RNN ç­‰æ¨¡å‹å¯¹å…¶è¿›è¡Œå­¦ä¹ ã€‚ ","date":"2025-11-27","objectID":"/posts/cs224n-lecture9/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 9: Pretraining","uri":"/posts/cs224n-lecture9/#subword-modeling"},{"categories":null,"content":" Pretraining","date":"2025-11-27","objectID":"/posts/cs224n-lecture9/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 9: Pretraining","uri":"/posts/cs224n-lecture9/#pretraining"},{"categories":null,"content":" ä¸‰ç§é¢„è®­ç»ƒæ¶æ„ Pretraining å¹²çš„äº‹æƒ…å°±æ˜¯ç»™æ¨¡å‹å®‰æ’ä¸€ä¸ªéå¸¸å›°éš¾çš„ä»»åŠ¡ï¼Œè¿«ä½¿å®ƒåœ¨æ•°æ®ä¸­å°½å¯èƒ½çš„å­¦ä¹ ã€‚ Encoder Onlyï¼šå‡ ä¹åªèƒ½ç”¨ MLM / æ›¿æ¢ token æ£€æµ‹ç­‰ï¼Œå› ä¸ºå®ƒæ²¡æœ‰ç”Ÿæˆèƒ½åŠ›ã€‚ Decoder Onlyï¼šå‡ ä¹åªèƒ½ç”¨ next-token predictionï¼ˆå› ä¸ºå®ƒçœ‹ä¸åˆ°æœªæ¥ï¼‰ï¼Œæˆ–è€…è¯´ TeachForcingã€‚ Encoder-Decoderï¼šä¼ ç»Ÿçš„å¸¦å¯¹é½çš„ç¿»è¯‘ï¼ˆsupervisedï¼‰ï¼ŒNext-token predictionï¼ˆçº¯è‡ªå›å½’ï¼‰ï¼ŒSpan corruptionï¼ˆT5 å¼ï¼‰ Bert å°±æ˜¯ Encoder Only Pretaining çš„å…¸å‹ä»£è¡¨ï¼Œå®ƒçš„è®­ç»ƒæ–¹å¼åŒ…æ‹¬ï¼š éšæœºé®æ‰ 15% çš„ Subword éšæœºæ›¿æ¢ 15% çš„ Subword éšæœºé€‰æ‹© 15% çš„ Subword ä¸æ›¿æ¢ï¼Œä½†è¿˜æ˜¯è®©å®ƒé¢„æµ‹ åˆ¤æ–­ä¸¤ä¸ªå¥å­æ˜¯å¦ç›¸é‚» å¯¹äºä¸åŒçš„ä»»åŠ¡ä¼šé€‰æ‹©ä¸åŒçš„é¢„è®­ç»ƒæ–¹æ³•ï¼šä¾‹å¦‚ Bert æ›´é€‚åˆä¸ºæ–‡æ¡£é€‰æ‹©ä¸€ä¸ª Tagï¼Œå®ƒä¸é€‚åˆè¿›è¡Œæ–‡æœ¬ç”Ÿæˆçš„ä»»åŠ¡ã€‚ ä¸€ä¸ª Misunderstanding ç»å…¸çš„ Transformerï¼ˆVaswani et al., 2017 é‚£ç¯‡ â€œAttention is All You Needâ€ï¼‰æœ¬èº«ä¸æ˜¯ä¸€ç§ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œç§¯æœ¨ç›’å­â€ã€‚ å®ƒåŒæ—¶æä¾›äº†ä¸‰ç§å¯æ‹¼è£…çš„éƒ¨ä»¶ï¼š Transformer Encoder å—ï¼ˆåŒå‘æ³¨æ„åŠ›ï¼Œå…è®¸çœ‹æœªæ¥ï¼‰ Transformer Decoder å—ï¼ˆå¸¦ masked self-attentionï¼Œåªèƒ½çœ‹è¿‡å»ï¼‰ Cross-attentionï¼ˆDecoder çœ‹ Encoder çš„è¾“å‡ºï¼‰ æ ¹æ®ä½ æ€ä¹ˆæ‹¼è¿™ä¸‰ä¸ªç§¯æœ¨ï¼Œå°±è‡ªç„¶å¾—åˆ°äº†åˆšæ‰ PPT é‡Œçš„ä¸‰ç§é¢„è®­ç»ƒæ¶æ„ï¼š ä½ æ‹¿ Transformer çš„å“ªäº›éƒ¨åˆ† æ‹¼å‡ºæ¥çš„æ˜¯å“ªç§æ¶æ„ ç»å…¸ä»£è¡¨æ¨¡å‹ é¢„è®­ç»ƒæ–¹å¼ åªç”¨ Encoder å—å † 6/12 å±‚ â†’ çº¯ Encoder BERTã€RoBERTaã€DeBERTa MLMï¼ˆé®è¯å¡«ç©ºï¼‰ Encoder + Decoder éƒ½ç”¨ â†’ Encoder-Decoder T5ã€BARTã€Flan-T5ã€UL2 Span Corruption ç­‰ åªç”¨ Decoder å—å †å¾ˆå¤šå±‚ â†’ çº¯ Decoderï¼ˆGPTå¼ï¼‰ GPT-1/2/3/4ã€LLaMAã€Grokã€PaLMã€Gemmaã€Qwenã€Mistralã€DeepSeek Next-token predictionï¼ˆä¸‹ä¸€è¯é¢„æµ‹ï¼‰ ","date":"2025-11-27","objectID":"/posts/cs224n-lecture9/:2:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 9: Pretraining","uri":"/posts/cs224n-lecture9/#ä¸‰ç§é¢„è®­ç»ƒæ¶æ„"},{"categories":null,"content":" Prefix-TunningPrefix TuningÂ æ˜¯ä¸€ç§å‚æ•°é«˜æ•ˆå¾®è°ƒ (PEFT) æŠ€æœ¯ã€‚å®ƒä¿æŒé¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼ˆå¦‚ GPT, BERTï¼‰çš„å‚æ•°å®Œå…¨å†»ç»“ï¼Œåªåœ¨Transformerçš„æ¯ä¸€å±‚è¾“å…¥å‰æ·»åŠ ä¸€å°æ®µå¯è®­ç»ƒçš„è¿ç»­å‘é‡ï¼ˆå³ Prefixï¼‰ã€‚ ä»¥ Decoder Only çš„æ¨¡å‹è¿›è¡Œå‚æ•°å¾®è°ƒä¸ºä¾‹ï¼Œæˆ‘ä»¬ä¼šåˆå§‹åŒ–ä¸€éƒ¨åˆ†å¯è®­ç»ƒå‚æ•° prefix_k å’Œ prefix_vã€‚å‡å¦‚ Decoder æ¯ä¸€å±‚çš„ Q, K, V å½¢çŠ¶ä¸º [batch_size, seq_len, d_model]ï¼Œé‚£ä¹ˆ prefix_k å’Œ prefix_v çš„å½¢çŠ¶å°±æ˜¯ [batch_size, prefix_len, d_model]ã€‚æˆ‘ä»¬å°† prefix_k å’Œ K çŸ©é˜µåœ¨ç¬¬ 2 ä¸ªç»´åº¦è¿›è¡Œæ‹¼æ¥ï¼Œå¾—åˆ°æ–°çš„ K å’Œ Vï¼Œå½¢çŠ¶ä¸º [batch_size, prefix_len+seq_len, d_model]ã€‚ python # åœ¨ modeling_llama.py é‡Œï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼çš„ä»£ç ï¼ˆä¼ªä»£ç ï¼‰ def forward(...): # æ­£å¸¸è®¡ç®— key = self.k_proj(hidden_states) # W_K * x value = self.v_proj(hidden_states) # W_V * x # â†“â†“â†“ å…³é”®ï¼šPrefix-Tuning çš„æ³¨å…¥ç‚¹ â†“â†“â†“ if self.config.peft_type == \"PREFIX_TUNING\": past_key_value = self.get_prompt(batch_size) # å°±æ˜¯ P_K^l, P_V^l key = torch.cat([past_key_value[0], key], dim=2) # cat åœ¨ seq_len ç»´åº¦ value = torch.cat([past_key_value[1], value], dim=2) # åé¢çš„ attention è®¡ç®—å®Œå…¨ä¸å˜ attn_weights = torch.matmul(query, key.transpose(-1, -2)) / sqrt(...) ä¸ºä»€ä¹ˆè¾“å…¥å½¢çŠ¶ä¸å˜ï¼ŒK å’Œ V å½¢çŠ¶å˜äº†ä¸å½±å“å‘¢ï¼Ÿ shape(softmax(QKTdk)V)=[batch_size,prefix_len,d_model]Ã—[batch_size,d_model,prefix_len+seq_len]Ã—[batch_size,prefix_len+seq_len,d_model]=[batch_size,prefix_len,d_model] \\begin{align} shape(softmax(\\frac{QK^T}{\\sqrt{d_k}})V) \u0026= [batch\\_size, prefix\\_len, d\\_model] \\times [batch\\_size, d\\_model, prefix\\_len+seq\\_len] \\times [batch\\_size, prefix\\_len+seq\\_len, d\\_model]\\\\ \u0026= [batch\\_size, prefix\\_len, d\\_model] \\end{align} shape(softmax(dkâ€‹â€‹QKTâ€‹)V)â€‹=[batch_size,prefix_len,d_model]Ã—[batch_size,d_model,prefix_len+seq_len]Ã—[batch_size,prefix_len+seq_len,d_model]=[batch_size,prefix_len,d_model]â€‹â€‹","date":"2025-11-27","objectID":"/posts/cs224n-lecture9/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 9: Pretraining","uri":"/posts/cs224n-lecture9/#prefix-tunning"},{"categories":null,"content":" Span CorruptionSpan Corruption çš„æ–¹æ³•æ˜¯éšæœºæŠŠåŸæ–‡é‡Œè¿ç»­çš„å‡ æ®µæ–‡å­—ï¼ˆspanï¼‰æ•´æ®µæŠ æ‰ï¼Œæ¢æˆä¸€ä¸ªç‰¹æ®Šçš„ mask tokenï¼Œç„¶åè®©æ¨¡å‹æŠŠè¿™äº›è¢«æŠ æ‰çš„åŸæ–‡åŸå°ä¸åŠ¨åœ°ç”Ÿæˆå›æ¥ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸€æ®µæ–‡æœ¬ï¼šæˆ‘æ˜ŸæœŸå¤©è¦å»å‚åŠ æ¯”èµ›ï¼Œç„¶åä¼šå¯¹ä»–éšæœºæ‰£æ‰ä¸€æ®µ spanï¼š Span Corruption åè¾“å…¥ï¼šæˆ‘ \u003cextra_id_0\u003e è¦å»å‚åŠ  \u003cextra_id_1\u003e ç›®æ ‡è¾“å‡ºï¼š\u003cextra_id_0\u003e æ˜ŸæœŸå¤© \u003cextra_id_1\u003e æ¯”èµ› ä¹‹åæŸå¤±å‡½æ•°å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„è‡ªå›å½’è®­ç»ƒï¼šåœ¨ Encoder è¾“å…¥ Span Corruption åæ–‡æœ¬ï¼Œåœ¨ Decoder ä¸­æ¯ä¸€æ­©éƒ½æŠŠçœŸå®çš„ä¸Šä¸€ä¸ª token å–‚ç»™æ¨¡å‹ï¼Œå°†é¢„æµ‹çš„ logtis å’Œç›®æ ‡è¾“å‡ºæ±‚äº¤å‰ç†µæŸå¤±ã€‚ æˆ‘ä»¬ç”¨ä¸€ä¸ªæå°çš„è¯è¡¨ï¼š text 0: \u003cpad\u003e 1: æˆ‘ 2: æ˜ŸæœŸå¤© (æŠŠâ€œæ˜ŸæœŸå¤©â€å½“ 1 token) 3: è¦ 4: å» 5: å‚åŠ  6: æ¯”èµ› 7: ã€‚ 8: \u003cextra_id_0\u003e 9: \u003cextra_id_1\u003e 10: \u003cextra_id_2\u003e 11: \u003cs\u003e (decoder start) 12: \u003c/s\u003e (decoder end) äºæ˜¯å°±æœ‰ï¼š python raw_input_ids = [1, 2, 3, 4, 5, 6, 7] encoder_input_ids = [1, 8, 3, 4, 5, 9, 7] # å¯¹åº”ï¼š æˆ‘ \u003cextra_id_0\u003e è¦ å» å‚åŠ  \u003cextra_id_1\u003e ã€‚ decoder_input_ids = [11, 8, 2, 9, 6, 10] # [\u003cs\u003e, \u003cextra_id_0\u003e, æ˜ŸæœŸå¤©, \u003cextra_id_1\u003e, æ¯”èµ›, \u003cextra_id_2\u003e] decoder_target_ids = [8, 2, 9, 6, 10, 12] # é¢„æµ‹ç›®æ ‡ï¼ˆè¦ä¸ logits å¯¹é½ï¼‰ å®ƒçš„å¥½å¤„ä¸ MLM å’Œ Next-token Prediction ç›¸æ¯”åœ¨äºï¼š å®ƒæ—¢é€¼æ¨¡å‹ç†è§£ä¸Šä¸‹æ–‡ï¼ˆåƒ BERTï¼‰ åˆé€¼æ¨¡å‹å­¦ä¼šç”Ÿæˆé•¿åºåˆ—ï¼ˆåƒ GPTï¼‰ ","date":"2025-11-27","objectID":"/posts/cs224n-lecture9/:3:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 9: Pretraining","uri":"/posts/cs224n-lecture9/#span-corruption"},{"categories":null,"content":" Self-Attention","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#self-attention"},{"categories":null,"content":" Key, Query, Value ä»å•æ¡æ–‡æœ¬æ¥çœ‹ï¼ŒçŸ©é˜µ $x=Ew_t$ å½¢çŠ¶ä¸º [SeqLen, EmbeddingSize]ã€‚ 1. ç”¨æƒé‡çŸ©é˜µ Q,K,V è½¬æ¢è¯å‘é‡ qi=Qxiki=Kxivi=Vxi \\begin{align} q_i \u0026= Qx_i \\\\ k_i \u0026= Kx_i \\\\ v_i \u0026= Vx_i \\end{align} qiâ€‹kiâ€‹viâ€‹â€‹=Qxiâ€‹=Kxiâ€‹=Vxiâ€‹â€‹â€‹ ä¸ºäº†æé«˜è®¡ç®—æ•ˆç‡ï¼Œå¯ä»¥æŠŠ Q,K,V åˆå¹¶ä¸ºä¸€ä¸ªå¤§çŸ©é˜µå’Œ x ç›¸ä¹˜ï¼Œç„¶åå†æŠŠå„ä¸ªéƒ¨åˆ†å–å‡ºæ¥ï¼Œç±»ä¼¼ BiLSTM ä¸­å››ä¸ªé—¨æ§è®¡ç®—åˆå¹¶åˆ°ä¸€ä¸ª [4*H, B] çš„å¤§çŸ©é˜µï¼Œç„¶åå†é€šè¿‡ .chunk åˆ†å¼€ã€‚ 2. ç”¨è¾“å…¥ x å»æŸ¥è¯¢å…¶ä»– token çš„ Key eij=qiTkjÎ±ij=expâ¡(eij)âˆ‘jâ€²expâ¡(eijâ€²) \\begin{align} e_{ij} \u0026= q_i^Tk_j \\\\ \\alpha_{ij} \u0026= \\frac{\\exp(e_{ij})}{\\sum_{j'}{\\exp(e_{ij'})}} \\end{align} eijâ€‹Î±ijâ€‹â€‹=qiTâ€‹kjâ€‹=âˆ‘jâ€²â€‹exp(eijâ€²â€‹)exp(eijâ€‹)â€‹â€‹â€‹ç”¨è¯å‘é‡çš„ Query å»æŸ¥è¯¢å…¶ä»–è¯å‘é‡çš„ Key å¾—åˆ°å®ƒä»¬çš„ç›¸ä¼¼åº¦ï¼Œå…·ä½“æ•°å­¦è¿ç®—å°±æ˜¯å‘é‡çš„ç‚¹ç§¯ï¼Œæœ€åå¯¹æ¯ä¸ª token çš„ç›¸ä¼¼åº¦åšz softmax å°±èƒ½å¾—åˆ°ç›¸ä¼¼æƒé‡ã€‚ æˆ‘ä»¬æŠŠ $e_{ij}$ æ‹†å¼€æ¥çœ‹: eij=qiTkj=xiTQTKxi e_{ij} = q_i^Tk_j = x_i^TQ^TKx_i eijâ€‹=qiTâ€‹kjâ€‹=xiTâ€‹QTKxiâ€‹ Qï¼šä¸ºä»€ä¹ˆä¸æŠŠ $Q^TK$ ç›´æ¥ç”¨ä¸€ä¸ªçŸ©é˜µè¡¨ç¤ºå‘¢ï¼Œè¿˜æœ‰ä¹˜ä¸¤æ¬¡è¿™ä¹ˆéº»çƒ¦ï¼Ÿ Aï¼šå› ä¸ºæå‰æŠŠå®ƒä»¬åˆå¹¶æˆä¸€ä¸ªçŸ©é˜µï¼Œé‚£ä¹ˆè¿™ä¸ªçŸ©é˜µçš„å¤§å°ä¹Ÿä¼šå˜æˆ [SeqLen, SeqLen] æ„å‘³ç€çŸ©é˜µå¤§å°ä¾èµ–äºè¾“å…¥åºåˆ—çš„é•¿åº¦ï¼Œå‚æ•°çŸ©é˜µå¯èƒ½ä¼šå˜å¾—éå¸¸å¤§ã€‚ Qï¼šä¸ºä»€ä¹ˆé‡‡ç”¨ç‚¹ç§¯è®¡ç®—ä¸¤ä¸ªå‘é‡çš„ç›¸ä¼¼åº¦ï¼Ÿä¸é‡‡ç”¨ä½™å¼¦ç›¸ä¼¼åº¦å…¶ä»–çš„ï¼Ÿ Qï¼šè¿™ç§æ‹†è§£çŸ©é˜µçš„ä½ç§©è¡¨ç¤ºä¼šä¸ä¼šå¯¹æœ€ç»ˆç»“æœæœ‰å½±å“ï¼Ÿ Aï¼šå®éªŒè¯æ˜æ¨¡å‹å¹¶ä¸éœ€è¦é«˜ç§©çš„æ³¨æ„åŠ›çŸ©é˜µï¼Œä½ç§©åè€Œæ˜¯å½’çº³åç½®ï¼Œæœ‰åŠ©äºæ³›åŒ–ã€‚ 3. è®¡ç®— x çš„è¾“å‡º å°†æ¯ä¸ª token çš„æƒé‡ä¹˜ä¸Šå®ƒå¯¹åº”çš„ Value å¾—åˆ°åŠ æƒå’Œå°±æ˜¯æœ€å x çš„è¾“å‡ºï¼Œè¿™ä¸ªè¾“å‡ºå€¼ä»£è¡¨ x åœ¨å¥å­ä¸­çš„ä¸Šä¸‹æ–‡å«ä¹‰ï¼š oi=âˆ‘iÎ±ijvj o_i = \\sum_i{\\alpha_{ij}v_j} oiâ€‹=iâˆ‘â€‹Î±ijâ€‹vjâ€‹","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:1:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#key-query-value"},{"categories":null,"content":" è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„é—®é¢˜å’Œè§£å†³æ–¹æ³• 1. ä¸çŸ¥é“æ–‡æœ¬é¡ºåºè‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œ RNN æˆ–è€… LSTM ä¸åŒï¼ŒRNN æ˜¯ä»å·¦åˆ°å³æˆ–è€…å³åˆ°å·¦æ¥æ›´æ–°éšè—çŠ¶æ€çŸ©é˜µçš„ï¼Œè€Œè‡ªæ³¨æ„åŠ›æœºåˆ¶å„ä¸ª token ä¹‹é—´ä¸ç›¸äº’ä¾èµ–ï¼Œå¯ä»¥è¿›è¡Œå¹¶è¡Œæ“ä½œï¼Œä½†å¸¦æ¥çš„ç¼ºç‚¹å°±æ˜¯ æ¨¡å‹ä¸çŸ¥é“ token ä¹‹é—´çš„å…ˆåå…³ç³»ï¼Œä¾‹å¦‚: I love you å’Œ You love me åœ¨å®ƒçœ‹æ¥æ˜¯ä¸€æ ·çš„ã€‚ è§£å†³æ–¹æ¡ˆæ˜¯ï¼š æ­£ä½™å¼¦ä½ç½®ç¼–ç  PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹ ä¼˜ç‚¹: ä¸éœ€è¦å­¦ä¹ ï¼Œå¯ä»¥æ³›åŒ–åˆ°æ›´é•¿çš„åºåˆ—,ä¾‹å¦‚æ¨¡å‹åªè®­ç»ƒåˆ° 512 é•¿åº¦ï¼Œæ¨ç†æ—¶ç»™ 4096 â†’ ä»å¯ç”¨ ç¼ºç‚¹ï¼šè¡¨è¾¾èƒ½åŠ›æœ‰é™ å¯å­¦ä¹ ä½ç½®ç¼–ç  å®šä¹‰ä¸€ä¸ªå’Œ x å¤§å°ç›¸åŒçš„å¯è®­ç»ƒçŸ©é˜µï¼Œç±»ä¼¼: python self.position_embedding = nn.Embedding(seqlen, embedding_size) ç›´æ¥æŠŠ x å’Œ position_embedding å åŠ ï¼Œè®©æ¨¡å‹è®­ç»ƒå­¦ä¹ ä½ç½®ä¿¡æ¯ã€‚ç¼ºç‚¹åœ¨äºæ— æ³•extrapolationï¼Œè®­ç»ƒ max_len=512ï¼Œæ¨ç†æ—¶æ¥ä¸ª 2048 æ²¡ embedding åªèƒ½æŠ¥é”™ã€‚ 2. æ²¡æœ‰éçº¿æ€§å› ç´ å¯ä»¥åœ¨ self-attention å±‚è®¡ç®—å„ä¸ª token æ³¨æ„åŠ›åˆ†æ•°ä¹‹åé€šè¿‡ä¸€ä¸ªå‰é¦ˆç½‘ç»œ MLP: mi=MLP(outputi)=W2âˆ—ReLU(W1outputi+b1)+b2 \\begin{align} m_i \u0026= MLP(output_i) \\\\ \u0026= W_2 * ReLU(W_1 output_i + b_1) + b_2 \\end{align} miâ€‹â€‹=MLP(outputiâ€‹)=W2â€‹âˆ—ReLU(W1â€‹outputiâ€‹+b1â€‹)+b2â€‹â€‹â€‹ 3. ä¸èƒ½çª¥è§†åç»­æ–‡æœ¬ä»¥ â€œI love youâ€ ç”Ÿæˆ â€œæˆ‘çˆ±ä½ â€ ä¸ºä¾‹ï¼Œ åœ¨ Encoder ä¸Šç”Ÿæˆ â€œçˆ±â€ çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ â€œ\u003csta\u003e\"ï¼›åœ¨ç”Ÿæˆ â€œçˆ±â€ çš„æ—¶å€™åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ â€œ\u003csta\u003eæˆ‘â€ï¼Œä¹‹åçš„ token å¯¹å½“å‰ token æ¥è¯´åº”è¯¥æ˜¯ invisible çš„ã€‚ä½†æ˜¯ä¹‹å‰çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼Œæˆ‘ä»¬ç›´æ¥æ•´ä¸ªçŸ©é˜µç›¸ä¹˜äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»æ„ token éƒ½èƒ½çª¥è§†ä¹‹åçš„ä¿¡æ¯ï¼Œè§£å†³åŠæ³•å°±æ˜¯åˆ©ç”¨æ©ç ï¼š eij={qiTkj,j\u003c=iâˆ’âˆ,j\u003ei e_{ij}= \\begin{cases} q_i^Tk_j, \u0026 j \u003c= i \\\\ -\\infty, \u0026 j \u003e i \\end{cases} eijâ€‹={qiTâ€‹kjâ€‹,âˆ’âˆ,â€‹j\u003c=ij\u003eiâ€‹è¿™æ ·ç»è¿‡ softmax ä¹‹åï¼Œæ©ç ä½ç½®éƒ½ä¼šå˜æˆ 0ï¼Œå’Œ Value ç›¸ä¹˜å°±ä¸ä¼šå½±å“æ¨¡å‹ã€‚ ","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:1:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„é—®é¢˜å’Œè§£å†³æ–¹æ³•"},{"categories":null,"content":" è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„é—®é¢˜å’Œè§£å†³æ–¹æ³• 1. ä¸çŸ¥é“æ–‡æœ¬é¡ºåºè‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œ RNN æˆ–è€… LSTM ä¸åŒï¼ŒRNN æ˜¯ä»å·¦åˆ°å³æˆ–è€…å³åˆ°å·¦æ¥æ›´æ–°éšè—çŠ¶æ€çŸ©é˜µçš„ï¼Œè€Œè‡ªæ³¨æ„åŠ›æœºåˆ¶å„ä¸ª token ä¹‹é—´ä¸ç›¸äº’ä¾èµ–ï¼Œå¯ä»¥è¿›è¡Œå¹¶è¡Œæ“ä½œï¼Œä½†å¸¦æ¥çš„ç¼ºç‚¹å°±æ˜¯ æ¨¡å‹ä¸çŸ¥é“ token ä¹‹é—´çš„å…ˆåå…³ç³»ï¼Œä¾‹å¦‚: I love you å’Œ You love me åœ¨å®ƒçœ‹æ¥æ˜¯ä¸€æ ·çš„ã€‚ è§£å†³æ–¹æ¡ˆæ˜¯ï¼š æ­£ä½™å¼¦ä½ç½®ç¼–ç  PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹ ä¼˜ç‚¹: ä¸éœ€è¦å­¦ä¹ ï¼Œå¯ä»¥æ³›åŒ–åˆ°æ›´é•¿çš„åºåˆ—,ä¾‹å¦‚æ¨¡å‹åªè®­ç»ƒåˆ° 512 é•¿åº¦ï¼Œæ¨ç†æ—¶ç»™ 4096 â†’ ä»å¯ç”¨ ç¼ºç‚¹ï¼šè¡¨è¾¾èƒ½åŠ›æœ‰é™ å¯å­¦ä¹ ä½ç½®ç¼–ç  å®šä¹‰ä¸€ä¸ªå’Œ x å¤§å°ç›¸åŒçš„å¯è®­ç»ƒçŸ©é˜µï¼Œç±»ä¼¼: python self.position_embedding = nn.Embedding(seqlen, embedding_size) ç›´æ¥æŠŠ x å’Œ position_embedding å åŠ ï¼Œè®©æ¨¡å‹è®­ç»ƒå­¦ä¹ ä½ç½®ä¿¡æ¯ã€‚ç¼ºç‚¹åœ¨äºæ— æ³•extrapolationï¼Œè®­ç»ƒ max_len=512ï¼Œæ¨ç†æ—¶æ¥ä¸ª 2048 æ²¡ embedding åªèƒ½æŠ¥é”™ã€‚ 2. æ²¡æœ‰éçº¿æ€§å› ç´ å¯ä»¥åœ¨ self-attention å±‚è®¡ç®—å„ä¸ª token æ³¨æ„åŠ›åˆ†æ•°ä¹‹åé€šè¿‡ä¸€ä¸ªå‰é¦ˆç½‘ç»œ MLP: mi=MLP(outputi)=W2âˆ—ReLU(W1outputi+b1)+b2 \\begin{align} m_i \u0026= MLP(output_i) \\\\ \u0026= W_2 * ReLU(W_1 output_i + b_1) + b_2 \\end{align} miâ€‹â€‹=MLP(outputiâ€‹)=W2â€‹âˆ—ReLU(W1â€‹outputiâ€‹+b1â€‹)+b2â€‹â€‹â€‹ 3. ä¸èƒ½çª¥è§†åç»­æ–‡æœ¬ä»¥ â€œI love youâ€ ç”Ÿæˆ â€œæˆ‘çˆ±ä½ â€ ä¸ºä¾‹ï¼Œ åœ¨ Encoder ä¸Šç”Ÿæˆ â€œçˆ±â€ çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ â€œ\"ï¼›åœ¨ç”Ÿæˆ â€œçˆ±â€ çš„æ—¶å€™åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ â€œæˆ‘â€ï¼Œä¹‹åçš„ token å¯¹å½“å‰ token æ¥è¯´åº”è¯¥æ˜¯ invisible çš„ã€‚ä½†æ˜¯ä¹‹å‰çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼Œæˆ‘ä»¬ç›´æ¥æ•´ä¸ªçŸ©é˜µç›¸ä¹˜äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»æ„ token éƒ½èƒ½çª¥è§†ä¹‹åçš„ä¿¡æ¯ï¼Œè§£å†³åŠæ³•å°±æ˜¯åˆ©ç”¨æ©ç ï¼š eij={qiTkj,j\u003c=iâˆ’âˆ,j\u003ei e_{ij}= \\begin{cases} q_i^Tk_j, \u0026 j \u003c= i \\\\ -\\infty, \u0026 j \u003e i \\end{cases} eijâ€‹={qiTâ€‹kjâ€‹,âˆ’âˆ,â€‹j\u003c=ij\u003eiâ€‹è¿™æ ·ç»è¿‡ softmax ä¹‹åï¼Œæ©ç ä½ç½®éƒ½ä¼šå˜æˆ 0ï¼Œå’Œ Value ç›¸ä¹˜å°±ä¸ä¼šå½±å“æ¨¡å‹ã€‚ ","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:1:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#1-ä¸çŸ¥é“æ–‡æœ¬é¡ºåº"},{"categories":null,"content":" è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„é—®é¢˜å’Œè§£å†³æ–¹æ³• 1. ä¸çŸ¥é“æ–‡æœ¬é¡ºåºè‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œ RNN æˆ–è€… LSTM ä¸åŒï¼ŒRNN æ˜¯ä»å·¦åˆ°å³æˆ–è€…å³åˆ°å·¦æ¥æ›´æ–°éšè—çŠ¶æ€çŸ©é˜µçš„ï¼Œè€Œè‡ªæ³¨æ„åŠ›æœºåˆ¶å„ä¸ª token ä¹‹é—´ä¸ç›¸äº’ä¾èµ–ï¼Œå¯ä»¥è¿›è¡Œå¹¶è¡Œæ“ä½œï¼Œä½†å¸¦æ¥çš„ç¼ºç‚¹å°±æ˜¯ æ¨¡å‹ä¸çŸ¥é“ token ä¹‹é—´çš„å…ˆåå…³ç³»ï¼Œä¾‹å¦‚: I love you å’Œ You love me åœ¨å®ƒçœ‹æ¥æ˜¯ä¸€æ ·çš„ã€‚ è§£å†³æ–¹æ¡ˆæ˜¯ï¼š æ­£ä½™å¼¦ä½ç½®ç¼–ç  PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹ ä¼˜ç‚¹: ä¸éœ€è¦å­¦ä¹ ï¼Œå¯ä»¥æ³›åŒ–åˆ°æ›´é•¿çš„åºåˆ—,ä¾‹å¦‚æ¨¡å‹åªè®­ç»ƒåˆ° 512 é•¿åº¦ï¼Œæ¨ç†æ—¶ç»™ 4096 â†’ ä»å¯ç”¨ ç¼ºç‚¹ï¼šè¡¨è¾¾èƒ½åŠ›æœ‰é™ å¯å­¦ä¹ ä½ç½®ç¼–ç  å®šä¹‰ä¸€ä¸ªå’Œ x å¤§å°ç›¸åŒçš„å¯è®­ç»ƒçŸ©é˜µï¼Œç±»ä¼¼: python self.position_embedding = nn.Embedding(seqlen, embedding_size) ç›´æ¥æŠŠ x å’Œ position_embedding å åŠ ï¼Œè®©æ¨¡å‹è®­ç»ƒå­¦ä¹ ä½ç½®ä¿¡æ¯ã€‚ç¼ºç‚¹åœ¨äºæ— æ³•extrapolationï¼Œè®­ç»ƒ max_len=512ï¼Œæ¨ç†æ—¶æ¥ä¸ª 2048 æ²¡ embedding åªèƒ½æŠ¥é”™ã€‚ 2. æ²¡æœ‰éçº¿æ€§å› ç´ å¯ä»¥åœ¨ self-attention å±‚è®¡ç®—å„ä¸ª token æ³¨æ„åŠ›åˆ†æ•°ä¹‹åé€šè¿‡ä¸€ä¸ªå‰é¦ˆç½‘ç»œ MLP: mi=MLP(outputi)=W2âˆ—ReLU(W1outputi+b1)+b2 \\begin{align} m_i \u0026= MLP(output_i) \\\\ \u0026= W_2 * ReLU(W_1 output_i + b_1) + b_2 \\end{align} miâ€‹â€‹=MLP(outputiâ€‹)=W2â€‹âˆ—ReLU(W1â€‹outputiâ€‹+b1â€‹)+b2â€‹â€‹â€‹ 3. ä¸èƒ½çª¥è§†åç»­æ–‡æœ¬ä»¥ â€œI love youâ€ ç”Ÿæˆ â€œæˆ‘çˆ±ä½ â€ ä¸ºä¾‹ï¼Œ åœ¨ Encoder ä¸Šç”Ÿæˆ â€œçˆ±â€ çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ â€œ\"ï¼›åœ¨ç”Ÿæˆ â€œçˆ±â€ çš„æ—¶å€™åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ â€œæˆ‘â€ï¼Œä¹‹åçš„ token å¯¹å½“å‰ token æ¥è¯´åº”è¯¥æ˜¯ invisible çš„ã€‚ä½†æ˜¯ä¹‹å‰çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼Œæˆ‘ä»¬ç›´æ¥æ•´ä¸ªçŸ©é˜µç›¸ä¹˜äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»æ„ token éƒ½èƒ½çª¥è§†ä¹‹åçš„ä¿¡æ¯ï¼Œè§£å†³åŠæ³•å°±æ˜¯åˆ©ç”¨æ©ç ï¼š eij={qiTkj,j\u003c=iâˆ’âˆ,j\u003ei e_{ij}= \\begin{cases} q_i^Tk_j, \u0026 j \u003c= i \\\\ -\\infty, \u0026 j \u003e i \\end{cases} eijâ€‹={qiTâ€‹kjâ€‹,âˆ’âˆ,â€‹j\u003c=ij\u003eiâ€‹è¿™æ ·ç»è¿‡ softmax ä¹‹åï¼Œæ©ç ä½ç½®éƒ½ä¼šå˜æˆ 0ï¼Œå’Œ Value ç›¸ä¹˜å°±ä¸ä¼šå½±å“æ¨¡å‹ã€‚ ","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:1:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#2-æ²¡æœ‰éçº¿æ€§å› ç´ "},{"categories":null,"content":" è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„é—®é¢˜å’Œè§£å†³æ–¹æ³• 1. ä¸çŸ¥é“æ–‡æœ¬é¡ºåºè‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œ RNN æˆ–è€… LSTM ä¸åŒï¼ŒRNN æ˜¯ä»å·¦åˆ°å³æˆ–è€…å³åˆ°å·¦æ¥æ›´æ–°éšè—çŠ¶æ€çŸ©é˜µçš„ï¼Œè€Œè‡ªæ³¨æ„åŠ›æœºåˆ¶å„ä¸ª token ä¹‹é—´ä¸ç›¸äº’ä¾èµ–ï¼Œå¯ä»¥è¿›è¡Œå¹¶è¡Œæ“ä½œï¼Œä½†å¸¦æ¥çš„ç¼ºç‚¹å°±æ˜¯ æ¨¡å‹ä¸çŸ¥é“ token ä¹‹é—´çš„å…ˆåå…³ç³»ï¼Œä¾‹å¦‚: I love you å’Œ You love me åœ¨å®ƒçœ‹æ¥æ˜¯ä¸€æ ·çš„ã€‚ è§£å†³æ–¹æ¡ˆæ˜¯ï¼š æ­£ä½™å¼¦ä½ç½®ç¼–ç  PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹ ä¼˜ç‚¹: ä¸éœ€è¦å­¦ä¹ ï¼Œå¯ä»¥æ³›åŒ–åˆ°æ›´é•¿çš„åºåˆ—,ä¾‹å¦‚æ¨¡å‹åªè®­ç»ƒåˆ° 512 é•¿åº¦ï¼Œæ¨ç†æ—¶ç»™ 4096 â†’ ä»å¯ç”¨ ç¼ºç‚¹ï¼šè¡¨è¾¾èƒ½åŠ›æœ‰é™ å¯å­¦ä¹ ä½ç½®ç¼–ç  å®šä¹‰ä¸€ä¸ªå’Œ x å¤§å°ç›¸åŒçš„å¯è®­ç»ƒçŸ©é˜µï¼Œç±»ä¼¼: python self.position_embedding = nn.Embedding(seqlen, embedding_size) ç›´æ¥æŠŠ x å’Œ position_embedding å åŠ ï¼Œè®©æ¨¡å‹è®­ç»ƒå­¦ä¹ ä½ç½®ä¿¡æ¯ã€‚ç¼ºç‚¹åœ¨äºæ— æ³•extrapolationï¼Œè®­ç»ƒ max_len=512ï¼Œæ¨ç†æ—¶æ¥ä¸ª 2048 æ²¡ embedding åªèƒ½æŠ¥é”™ã€‚ 2. æ²¡æœ‰éçº¿æ€§å› ç´ å¯ä»¥åœ¨ self-attention å±‚è®¡ç®—å„ä¸ª token æ³¨æ„åŠ›åˆ†æ•°ä¹‹åé€šè¿‡ä¸€ä¸ªå‰é¦ˆç½‘ç»œ MLP: mi=MLP(outputi)=W2âˆ—ReLU(W1outputi+b1)+b2 \\begin{align} m_i \u0026= MLP(output_i) \\\\ \u0026= W_2 * ReLU(W_1 output_i + b_1) + b_2 \\end{align} miâ€‹â€‹=MLP(outputiâ€‹)=W2â€‹âˆ—ReLU(W1â€‹outputiâ€‹+b1â€‹)+b2â€‹â€‹â€‹ 3. ä¸èƒ½çª¥è§†åç»­æ–‡æœ¬ä»¥ â€œI love youâ€ ç”Ÿæˆ â€œæˆ‘çˆ±ä½ â€ ä¸ºä¾‹ï¼Œ åœ¨ Encoder ä¸Šç”Ÿæˆ â€œçˆ±â€ çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ â€œ\"ï¼›åœ¨ç”Ÿæˆ â€œçˆ±â€ çš„æ—¶å€™åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ â€œæˆ‘â€ï¼Œä¹‹åçš„ token å¯¹å½“å‰ token æ¥è¯´åº”è¯¥æ˜¯ invisible çš„ã€‚ä½†æ˜¯ä¹‹å‰çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼Œæˆ‘ä»¬ç›´æ¥æ•´ä¸ªçŸ©é˜µç›¸ä¹˜äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»æ„ token éƒ½èƒ½çª¥è§†ä¹‹åçš„ä¿¡æ¯ï¼Œè§£å†³åŠæ³•å°±æ˜¯åˆ©ç”¨æ©ç ï¼š eij={qiTkj,j\u003c=iâˆ’âˆ,j\u003ei e_{ij}= \\begin{cases} q_i^Tk_j, \u0026 j \u003c= i \\\\ -\\infty, \u0026 j \u003e i \\end{cases} eijâ€‹={qiTâ€‹kjâ€‹,âˆ’âˆ,â€‹j\u003c=ij\u003eiâ€‹è¿™æ ·ç»è¿‡ softmax ä¹‹åï¼Œæ©ç ä½ç½®éƒ½ä¼šå˜æˆ 0ï¼Œå’Œ Value ç›¸ä¹˜å°±ä¸ä¼šå½±å“æ¨¡å‹ã€‚ ","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:1:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#3-ä¸èƒ½çª¥è§†åç»­æ–‡æœ¬"},{"categories":null,"content":" Transformer","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#transformer"},{"categories":null,"content":" å¤šå¤´æ³¨æ„åŠ›å¤šå¤´æ³¨æ„åŠ›çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å•å¤´æ³¨æ„åŠ›æœºåˆ¶çš„è¡¨è¾¾èƒ½åŠ›ç“¶é¢ˆã€‚ äººå¤„ç†è¯­è¨€æ—¶ä¼šåŒæ—¶ä»å¤šä¸ªè§’åº¦å»çœ‹çš„ï¼š ä¸€ä¸ªè§’åº¦çœ‹è¯­æ³•ç»“æ„ï¼ˆä¸»è¯­-è°“è¯­å…³ç³»ï¼‰ ä¸€ä¸ªè§’åº¦çœ‹è¯­ä¹‰ç›¸ä¼¼åº¦ ä¸€ä¸ªè§’åº¦çœ‹æŒ‡ä»£æ¶ˆè§£ ä¸€ä¸ªè§’åº¦çœ‹ä¸–ç•Œå¸¸è¯† å•å¤´å¿…é¡»æŠŠè¿™æ‰€æœ‰çº¿ç´¢å‹ç¼©åˆ°ä¸€ä¸ª $d_k$ ç»´çš„ç©ºé—´é‡Œå»å­¦å¤ªå‹‰å¼ºäº†ï¼Œå®¹æ˜“å­¦åæˆ–è€…å­¦æ¨¡ç³Šã€‚ å¤šå¤´æ³¨æ„åŠ›å°±æ˜¯æŠŠ $d_k$ï¼ˆæ¯”å¦‚ 512ï¼‰ç»´åˆ†æˆ h=8 ä»½ï¼Œæ¯ä»½ 64 ç»´ï¼Œè®© 8 ä¸ªç©ºé—´å„è‡ªä¸“å¿ƒå­¦ä¸€ç§å…³æ³¨æ¨¡å¼ï¼Œä¾‹å¦‚ï¼š Head 1ï¼šä¸“é—¨å­¦è¯­æ³•ç»“æ„ï¼ˆæ¯”å¦‚ä¸»è¯­æ›´å…³æ³¨è°“è¯­ï¼‰ Head 2ï¼šä¸“é—¨å­¦çŸ­è·ç¦»ä¾èµ–ï¼ˆç›¸é‚»è¯å…³æ³¨å¤šä¸€äº›ï¼‰ Head 3ï¼šä¸“é—¨å­¦é•¿è·ç¦»ä¾èµ–ï¼ˆå¥é¦–å’Œå¥å°¾å…³æ³¨ï¼‰ Head 4ï¼šä¸“é—¨å­¦æŒ‡ä»£å…³ç³» Head 5ï¼šä¸“é—¨å­¦æƒ…æ„Ÿææ€§ æ¯ä¸ª head éƒ½åœ¨ä¸€ä¸ªä½ç»´å­ç©ºé—´ï¼ˆ64ç»´ï¼‰é‡Œç‹¬ç«‹å­¦ä¹ ä¸€ç§â€œå…³æ³¨ç­–ç•¥â€ï¼Œäº’ä¸å¹²æ‰°ã€‚æœ€åå†æŠŠ 8 ä¸ª head çš„ç»“æœæ‹¼æ¥èµ·æ¥ï¼Œç»è¿‡ä¸€ä¸ªçº¿æ€§å±‚èåˆï¼Œå°±ç›¸å½“äºæ¨¡å‹åŒæ—¶ä» 8 ä¸ªä¸åŒè§’åº¦ç†è§£äº†è¿™ä¸ªå¥å­ã€‚ ","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#å¤šå¤´æ³¨æ„åŠ›"},{"categories":null,"content":" ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æ³¨æ„åŠ›æœºåˆ¶å­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼šå½“æ¨¡å‹è§„æ¨¡å˜å¤§ä¹‹åï¼Œå‘é‡çš„ç‚¹ç§¯ä¹Ÿä¼šéšä¹‹å˜å¾—å¾ˆå¤§ æ•°å­¦è¯æ˜ï¼š é¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡® Softmax æ˜¯ä¸€ä¸ª n â†’ n çš„å‡½æ•°ï¼Œæ‰€ä»¥å®ƒçš„æ¢¯åº¦ä¸æ˜¯ä¸€ä¸ªæ•°è€Œæ˜¯ä¸€ä¸ªé›…å¯æ¯”çŸ©é˜µï¼š Jij=âˆ‚yiâˆ‚xj J_{ij}=\\frac{\\partial{y_i}}{\\partial{x_j}} Jijâ€‹=âˆ‚xjâ€‹âˆ‚yiâ€‹â€‹æ ¹æ®é“¾å¼æ³•åˆ™æœ‰: âˆ‚Lâˆ‚xj=âˆ‘i=1nâˆ‚Lâˆ‚yiâˆ‚yiâˆ‚xj \\frac{\\partial{L}}{\\partial{x_j}}=\\sum_{i=1}^n{\\frac{\\partial{L}}{\\partial{y_i}}\\frac{\\partial{y_i}}{\\partial{x_j}}} âˆ‚xjâ€‹âˆ‚Lâ€‹=i=1âˆ‘nâ€‹âˆ‚yiâ€‹âˆ‚Lâ€‹âˆ‚xjâ€‹âˆ‚yiâ€‹â€‹ç»™å®šè¾“å…¥å‘é‡: x=(x1,x2,x3,â€¦â€‰) \\mathbf{x} = (x_1,x_2,x_3,\\dots) x=(x1â€‹,x2â€‹,x3â€‹,â€¦)softmax ä¹‹åå¾—åˆ°è¾“å‡ºçš„ç¬¬ i ä¸ªåˆ†é‡ä¸º: yi=softmax(xi)=exiâˆ‘k=1nexk=exiS \\begin{align} \\mathbf{y_i}\u0026=softmax({\\mathbf{x}}_i)=\\frac{e^{x_i}}{\\sum_{k=1}^n{e^{x_k}}} \\\\ \u0026=\\frac{e^{x_i}}{S} \\end{align} yiâ€‹â€‹=softmax(xiâ€‹)=âˆ‘k=1nâ€‹exkâ€‹exiâ€‹â€‹=Sexiâ€‹â€‹â€‹â€‹æ±‚åå¯¼å¾—åˆ°: âˆ‚yiâˆ‚xi=exiSâˆ’exiexiS2=exiS(1âˆ’exiS)=yi(1âˆ’yi)âˆ‚yiâˆ‚xj=âˆ’exiexjS2=âˆ’yiyj \\begin{align} \\frac{\\partial{\\mathbf{y_i}}}{\\partial{\\mathbf{x_i}}}\u0026=\\frac{e^{x_i}S-e^{x_i}e^{x_i}}{S^2}\\\\ \u0026=\\frac{e^{x_i}}{S}(1-\\frac{e^{x_i}}{S})\\\\ \u0026=y_i(1-y_i) \\\\ \\frac{\\partial{\\mathbf{y_i}}}{\\partial{\\mathbf{x_j}}}\u0026=-\\frac{e^{x_i}e^{x_j}}{S^2} \\\\ \u0026=-y_iy_j \\end{align} âˆ‚xiâ€‹âˆ‚yiâ€‹â€‹âˆ‚xjâ€‹âˆ‚yiâ€‹â€‹â€‹=S2exiâ€‹Sâˆ’exiâ€‹exiâ€‹â€‹=Sexiâ€‹â€‹(1âˆ’Sexiâ€‹â€‹)=yiâ€‹(1âˆ’yiâ€‹)=âˆ’S2exiâ€‹exjâ€‹â€‹=âˆ’yiâ€‹yjâ€‹â€‹â€‹å½“ softmax çš„è¾“å…¥æŸä¸ª $x_i$ ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œç»è¿‡ softmax å°±ä¼šå˜å¾—æ¥è¿‘ one-hot ç¼–ç ï¼Œè¿™æ—¶å€™æœ€å¤§é¡¹çš„æ¢¯åº¦ $p_i(1-p_i)=0$ ï¼Œå…¶ä»–é¡¹æ¢¯åº¦ $p_ip_j=0$ï¼Œæœ€åç´¯åŠ èµ·æ¥å°±æ˜¯ 0 äº†ã€‚ è§£å†³åŠæ³•ï¼šç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ› Attention(Q,K,V)=softmax(QKTdk)V Attention(\\mathbf{Q},\\mathbf{K},\\mathbf{V})=softmax(\\frac{\\mathbf{QK}^T}{\\sqrt{d_k}})V Attention(Q,K,V)=softmax(dkâ€‹â€‹QKTâ€‹)VæŠŠ $QK^T$ é™¤ä»¥ $\\sqrt{d_k}$ï¼Œèƒ½æŠŠå®ƒçš„æ–¹å·®é‡æ–°æ‹‰å›åˆ°ä¸€ä¸ªåˆç†çš„èŒƒå›´ï¼ˆå¤§çº¦æ¥è¿‘ 1ï¼‰ã€‚ ","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›"},{"categories":null,"content":" æ®‹å·®è¿æ¥ æ¢¯åº¦å›ä¼ æ—¶å€™ï¼Œé“¾å¼è®¡ç®—å¯èƒ½ä¼šä¹˜éå¸¸å¤šçš„åå¯¼ã€‚å¦‚æœä¹‹é—´çš„åå¯¼éƒ½æ˜¯å°äº 1 çš„æ•°ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´æœ€åæ¢¯åº¦æ¥è¿‘äº 0ï¼›åä¹‹æ¢¯åº¦æœ‰å¯èƒ½éå¸¸å¤§ã€‚æ¢¯åº¦çˆ†ç‚¸æ¯”è¾ƒå¥½è§£å†³ï¼Œè¶…è¿‡ä¸€å®šå€¼çš„æ—¶å€™å°±æŠŠå®ƒè£å‰ªæ‰ã€‚ResNet çš„æ®‹å·®è¿æ¥å’Œ $1*1$ å·ç§¯ï¼Œå¯ä»¥è§£å†³æ¢¯åº¦æ¶ˆå¤±è¿™ä¸ªé—®é¢˜ã€‚ Out(x)=f(x)+x Out(x)=f(x)+x Out(x)=f(x)+xæ®‹å·®è¿æ¥è§£å†³çš„æ˜¯é€€åŒ–é—®é¢˜: ä»æ•°å­¦ä¸Šçœ‹ï¼Œå‡è®¾ä¸€ä¸ªæµ…å±‚ç½‘ç»œï¼ˆæ¯”å¦‚ 10 å±‚ï¼‰å·²ç»èƒ½å¾ˆå¥½åœ°æ‹Ÿåˆä¸€ä¸ªå‡½æ•° H(x)ï¼Œæˆ‘ä»¬å¸Œæœ›å†æŠŠç½‘ç»œåŠ æ·± 40 å±‚å¾—åˆ°æ›´å¥½çš„æ€§èƒ½ã€‚å‡å¦‚æˆ‘ä»¬è®©åŠ æ·± 40 å±‚åçš„ç½‘ç»œæ€§èƒ½ä¿æŒä¸å˜ï¼Œé‚£ä¹ˆè¿™æœ€å°‘ 40 è¯çš„éçº¿æ€§åµŒå¥—åšçš„äº‹å°±æ˜¯å­¦ä¼šä¸€ä¸ªæ’ç­‰æ˜ å°„ï¼Œè¿™æ ·å‡†ç¡®ç‡æ‰ä¸ä¼šä¸‹é™ã€‚ä½†æ˜¯ä½œä¸ºä¸€ä¸ªæ·±å±‚ç»“æ„å‚æ•°é—´é«˜åº¦è€¦åˆçš„ç½‘ç»œï¼Œå®ƒå¾ˆéš¾å­¦ä¼šæ’ç­‰æ˜ å°„ H(x)=x H(x) = x H(x)=xå› ä¸ºä½ è¦è®©å‡ åå±‚å‚æ•°å…¨éƒ¨ç²¾ç¡®åœ°æŠµæ¶ˆæˆâ€œä»€ä¹ˆéƒ½ä¸å¹²â€å¤ªéš¾äº†ï¼Œä¼˜åŒ–å™¨å‡ ä¹åšä¸åˆ°ã€‚æ‰€ä»¥æˆ‘ä»¬é€€è€Œæ±‚å…¶æ¬¡ï¼Œå¸Œæœ›èƒ½å­¦ä¼šè¿™æ ·ä¸€ä¸ªå‡½æ•°: F(x)=H(x)âˆ’x F(x) = H(x) - x F(x)=H(x)âˆ’xè¿™æ ·è®©æ¨¡å‹å­¦ä¼šæŠŠè¾“å‡ºå˜æˆå…¨ 0ï¼Œæ¯”å­¦ä¼šæŠŠè¾“å‡ºç²¾ç¡®ç­‰äºè¾“å…¥ x å®¹æ˜“å¾ˆå¤šã€‚ ","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#æ®‹å·®è¿æ¥"},{"categories":null,"content":" å±‚å½’ä¸€åŒ–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼ŒLay Normalization æ˜¯åœ¨æœ€åä¸€ä¸ªç»´åº¦è¿›è¡Œå½’ä¸€åŒ–ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨ Transformer ä¸­ Lay Norm æ˜¯å¯¹æ¯ä¸ª token å¯¹åº”çš„éšè—çŠ¶æ€å‘é‡ $h_i$ è¿›è¡Œå½’ä¸€åŒ–ï¼Œå®ƒæ˜¯ä¸ä¾èµ–äº Batch Size æˆ–è€… Sequence Size çš„ã€‚ Î¼i=xi1+xi22Ïƒi2=(xi1âˆ’Î¼i)2+(xi2âˆ’Î¼i)22x^ij=xijâˆ’Î¼iÏƒi2+Ïµ \\begin{align} \\mu_i \u0026= \\frac{x_{i1} + x_{i2}}{2} \\\\ \\sigma_i^2 \u0026= \\frac{(x_{i1}-\\mu_i)^2 + (x_{i2}-\\mu_i)^2}{2} \\\\ \\hat{x}_{ij} \u0026= \\frac{x_{ij}-\\mu_i}{\\sqrt{\\sigma_i^2 + \\epsilon}} \\end{align} Î¼iâ€‹Ïƒi2â€‹x^ijâ€‹â€‹=2xi1â€‹+xi2â€‹â€‹=2(xi1â€‹âˆ’Î¼iâ€‹)2+(xi2â€‹âˆ’Î¼iâ€‹)2â€‹=Ïƒi2â€‹+Ïµâ€‹xijâ€‹âˆ’Î¼iâ€‹â€‹â€‹â€‹ Attention æœºåˆ¶åœ¨å½’ä¸€åŒ–é˜¶æ®µå¸Œæœ›â€œå…ˆè®©æ¯ä¸ª token è‡ªå·±å†…éƒ¨æ•´æ´â€ï¼Œå†å»äº¤æµã€‚ Qï¼šä¸ºä»€ä¹ˆéœ€è¦å¯¹ feature ç»´åº¦è¿›è¡Œå½’ä¸€åŒ– Aï¼šfeature æ•°å€¼å·®å¤ªå¤§ â†’ åœ¨çº¿æ€§å±‚ä¸­è¢«æ”¾å¤§æˆ–å‹ç¼© å‡è®¾ä½ æœ‰è¾“å…¥ç‰¹å¾å‘é‡ï¼š$x = [1000,; 0.1]$ï¼Œç»è¿‡ä¸€ä¸ªçº¿æ€§å±‚ï¼š$y = Wx$ã€‚å…¶ä¸­ W=[w1w2w3w4] \\begin{array}{c} W = \\begin{bmatrix} w_1 \u0026 w_2 \\\\ w_3 \u0026 w_4\\end{bmatrix} \\end{array} W=[w1â€‹w3â€‹â€‹w2â€‹w4â€‹â€‹]â€‹ è®¡ç®—ï¼š y1=w1â‹…1000+w2â‹…0.1 y_1 = w_1\\cdot1000 + w_2\\cdot0.1 y1â€‹=w1â€‹â‹…1000+w2â€‹â‹…0.1ä¸ç®¡æƒé‡ $w_2$ å¤šåŠªåŠ›ï¼Œæœ€ç»ˆè´¡çŒ®éƒ½ä¼šè¢« $1000 * w_1$ ç›–æ‰ã€‚ ","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:4","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#å±‚å½’ä¸€åŒ–"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#æºç è§£æ"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#ä¸€transformer"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#äºŒencoder"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#1-word-embedding"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#2-position-embedding"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#3-encoderlayer"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#4-multiheadattention"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#5-feedforwardnet"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#ä¸‰decoder"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#1-mask"},{"categories":null,"content":" æºç è§£æ ä¸€ã€Transformer python class Transformer(nn.Module): def __init__(self): super(Transformer, self).__init__() self.encoder = Encoder().cuda() self.decoder = Decoder().cuda() self.projection = nn.Linear(d_model, tgt_vocab_size, bias=False).cuda() def forward(self, enc_inputs, dec_inputs): ''' enc_inputs: [batch_size, src_len] dec_inputs: [batch_size, tgt_len] ''' enc_outputs, enc_self_attns = self.encoder(enc_inputs) dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs) dec_logits = self.projection(dec_outputs) # dec_logits: [batch_size, tgt_len, tgt_vocab_size] return dec_logits.view(-1, dec_logits.size(-1)), enc_self_attns, dec_self_attns, dec_enc_attns æ•´ä½“æ¥è¯´ Transformer åŒ…å« Encoderã€Decoder å’ŒæŠ•å½±ä¸‰éƒ¨åˆ†ï¼ŒEncoder è´Ÿè´£å­¦ä¹ è¾“å…¥ï¼ŒDeocder è´Ÿè´£ç”Ÿæˆè¾“å‡ºï¼Œæœ€åæŠŠè¾“å‡ºå‘é‡æŠ•å½±åˆ°æœŸæœ›çš„ç©ºé—´ã€‚ æ³¨æ„ï¼ï¼ï¼ å› ä¸º PyTorch çš„äº¤å‰ç†µæŸå¤±è¦æ±‚è¾“å…¥å½¢çŠ¶å¦‚ä¸‹ï¼š math input: [N, C] target: [N] å…¶ä¸­ï¼š N = æ ·æœ¬æ•°é‡ C = ç±»åˆ«æ•°é‡ = vocab_size è€Œ Transformer è§£ç å™¨è¾“å‡ºçš„ logits æ˜¯ï¼š[B, T, V]ï¼Œæ‰€ä»¥éœ€è¦å±•å¹³åˆ°äºŒç»´ã€‚ äºŒã€Encoder python class Encoder(nn.Module): \"\"\" - Word Embedding - Position Embedding - MultiEncoderLayer \"\"\" def __init__(self, vocal_size: int, d_model: int, layer_nums: int, max_len: int, hidden_size: int, n_heads: int = 8, p: float = 0.1): super(Encoder, self).__init__() self.word_embedding = nn.Embedding(vocal_size, d_model) self.pos_embedding = PositionEmbedding(max_len, d_model, p) self.layers = nn.ModuleList([EncoderLayer(d_model, n_heads, hidden_size, p) for _ in range(n_layers)]) def forward(self, x): attns = [] enc_masks = padding_mask(x, x) enc_embed = self.word_embedding(x) enc_embed = self.pos_embedding(enc_embed) enc_output = enc_embed for layer in self.layers: enc_output, enc_attn = layer(enc_output, enc_masks) attns.append(enc_attn) return enc_output, attns Encoder åŒ…å« Word Embeddingã€Position Embedding å’Œå¤šå¤´æ³¨æ„åŠ›å±‚ï¼ŒçŸ©é˜µå½¢çŠ¶å˜åŒ–å¦‚ä¸‹: è¾“å…¥ä¸º batch_size è¡Œæ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦å›ºå®šä¸º seq_lenï¼š[batch_size, seq_len] é€šè¿‡è¯åµŒå…¥ä¹‹åå¾—åˆ°: [batch_size, seq_len, d_model] Position Embedding å¤§å°å’Œè¾“å…¥ç›¸åŒç›´æ¥å åŠ : [batch_size, seq_len, d_model] å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸æ”¹å˜çŸ©é˜µå½¢çŠ¶ï¼Œæœ€åè¿˜æ˜¯ [batch_size, seq_len, d_model] ä¸¥æ ¼æ¥è¯´ Encoder å’Œ Decoder è¿”å›æ³¨æ„åŠ›æƒé‡ attn æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä¸è¿‡å®ƒå¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ¨¡å‹åœ¨ç¿»è¯‘æ—¶å…³æ³¨äº†æºå¥å­çš„å“ªäº›è¯ã€‚ 1. Word Embeddingè¯åµŒå…¥å°±æ˜¯ç®€å•çš„ä½¿ç”¨äº† torch.nn.Embedding è¿™ä¸ªè‡ªå­¦ä¹ çŸ©é˜µï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ [src_vocal_size, d_modal]ï¼Œæ ¹æ®è¾“å…¥æ–‡æœ¬ token çš„ç´¢å¼•å°±èƒ½ä»ä¸­å–å‡ºå¯¹åº”çš„è¯å‘é‡ã€‚ 2. Position Embedding python class PositionalEncoding(nn.Module): def __init__(self, d_model, dropout=0.1, max_len=5000): super(PositionalEncoding, self).__init__() self.dropout = nn.Dropout(p=dropout) pe = torch.zeros(max_len, d_model) position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1) div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)) pe[:, 0::2] = torch.sin(position * div_term) pe[:, 1::2] = torch.cos(position * div_term) pe = pe.unsqueeze(0).transpose(0, 1) self.register_buffer('pe', pe) def forward(self, x): x = x + self.pe[:x.size(0), :] return self.dropout(x) æ­£ä½™å¼¦ç¼–ç çš„å…¬å¼æ˜¯ï¼š PE(pos,2i)=sinâ¡(pos100002i/dmodel)PE(pos,2i+1)=cosâ¡(pos100002i/dmodel) \\begin{align} PE(pos, 2i) \u0026= \\sin(\\frac{pos}{10000^{2i/d_{model}}}) \\\\ PE(pos, 2i+1) \u0026= \\cos(\\frac{pos}{10000^{2i/d_{model}}}) \\end{align} PE(pos,2i)PE(pos,2i+1)â€‹=sin(100002i/dmodelâ€‹posâ€‹)=cos(100002i/dmodelâ€‹posâ€‹)â€‹â€‹é€šè¿‡æ•°å­¦æ€§è´¨ï¼š \\[ \\exp(a) = e^aï¼Œ\\text{è€Œ}a^b = \\exp(b \\ln a) \\]æ‰€ä»¥æœ‰ï¼š pos100002i/dmodel=posÃ—expâ¡âˆ’2idmodellnâ¡10000 \\frac{pos}{10000^{2i/d_{model}}}=pos \\times \\exp{-\\frac{2i}{d_{model}}\\ln{10000}} 100002i/dmodelâ€‹posâ€‹=posÃ—expâˆ’dmodelâ€‹2iâ€‹ln10000 ä¸ºä»€ä¹ˆè¦æŠŠ position ä» [max_len] æ‰©å±•åˆ° [max_len, 1]? ä»å…¬å¼æ¥çœ‹ï¼Œæˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯æŠŠæ¯æ¡å¥å­çš„å¥‡æ•°å’Œå¶æ•°ä½ç½®çš„å€¼æ›¿æ¢æ‰ï¼Œé€šè¿‡ pytorch çš„åˆ‡ç‰‡æ“ä½œ tensor[:, 0::2] å°±å¯ä»¥ç”¨ä¸€ä¸ª [seq_len, d_model/2] å½¢çŠ¶çš„çŸ©é˜µæ›¿æ¢æ‰å¶æ•°ä½ç½®çš„å€¼ã€‚åŒæ—¶åˆ©ç”¨ pytorch çš„å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠ position æ‰©å±•åˆ° [seq_len, 1] å’Œ div_term [d_model/2] ç›¸ä¹˜å°±èƒ½å¾—åˆ° [seq_len, d_model/2] çš„æ–°çŸ©é˜µã€‚ PS: æˆ‘æ„Ÿè§‰è¿™ä¸ªè®¡ç®—æ–¹æ³•çœŸçš„å¾ˆè¯¡å¼‚ï¼Œdiv_term çš„ç»´åº¦æ˜¯ [d_model/2, ]ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé•¿ä¸º d_model/2 çš„è¡Œå‘é‡ã€‚ç„¶åå’Œ position ä¸»å…ƒç´ ç›¸ä¹˜ä¹‹åï¼Œå¹¿æ’­åˆ° [seq_len, d_model/2] ï¼Œè¿™æ—¶å€™å¯ä»¥çœ‹åš d_model/2 çš„è¡Œå‘é‡è¿›è¡Œäº†ä¸€ä¸ªè½¬ç½®å˜é•¿ d_model/2 çš„åˆ—å‘é‡ï¼Œç„¶åæ°´å¹³æ–¹å‘æ‰©å±•ä¸º [seq_len, d_model/2] çš„çŸ©é˜µã€‚ ç”¨ä¸€ä¸ªå®é™…æ•°å­—ä¾‹å­çœ‹å¹¿æ’­è®¡ç®— å‡è®¾ positionï¼ˆ5Ã—1ï¼‰: text [[0], [1], [2], [3], [4]] div_termï¼ˆè§†ä¸º 1Ã—3ï¼‰ï¼š text [ a b c ] è®¡ç®— position * div_termï¼š text [[0*a, 0*b, 0*c], [1*a, 1*b, 1*c], [2*a, 2*b, 2*c], [3*a, 3","date":"2025-11-24","objectID":"/posts/cs224n-lecture8/:2:5","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 8: Self-Attention and Transformers","uri":"/posts/cs224n-lecture8/#2-decoderlayer"},{"categories":null,"content":" BLEU è¯„ä¼°æŒ‡æ ‡BLEU æ˜¯æœºå™¨ç¿»è¯‘ä¸­æœ€ç»å…¸çš„è‡ªåŠ¨è¯„ä»·æŒ‡æ ‡ä¹‹ä¸€ï¼Œç”¨æ¥è¡¡é‡æ¨¡å‹ç”Ÿæˆçš„è¯‘æ–‡ï¼ˆcandidateï¼‰å’Œ äººå·¥å‚è€ƒè¯‘æ–‡ï¼ˆreferenceï¼‰ä¹‹é—´çš„ç›¸ä¼¼åº¦ã€‚ BLEU çš„æ ¸å¿ƒæ€æƒ³: N-gramï¼ˆè¯åºåˆ—ï¼‰æœ‰å¤šå°‘å’Œå‚è€ƒè¯‘æ–‡åŒ¹é…ã€‚åŒ¹é…è¶Šå¤šï¼Œå¾—åˆ†è¶Šé«˜ã€‚ BLEU=BPÃ—expâ¡(âˆ‘n=1..Nwnâˆ—logâ¡pn) BLEU = BP \\times \\exp(\\sum_{n=1..N}{w_n * \\log{p_n}}) BLEU=BPÃ—exp(n=1..Nâˆ‘â€‹wnâ€‹âˆ—logpnâ€‹) ç¬¦å· å«ä¹‰ $p_n$ n-gram ç²¾ç¡®ç‡ precision $w_n$ æƒé‡ï¼Œä¸€èˆ¬ BLEU-4 æ—¶ä¸º 1/4 BP é•¿åº¦æƒ©ç½š è®¡ç®—è¿‡ç¨‹ text candidate: the cat the cat on the mat reference: the cat is on the mat 1. Step 1: unigram precision word cand ref clipped the 4 2 2 cat 2 1 1 on 1 1 1 mat 1 1 1 total clipped = 5 total candidate unigram = 8 unigram precision = 5/8 Step 2ï¼šbigram precision word cand ref clipped the cat 2 1 1 cat the 1 0 0 cat on 1 0 0 on the 1 1 1 the mat 1 1 1 total clipped = 3 total candidate bigram = 6 bigram precision = 3/6 åŒç†è®¡ç®— p3 å’Œ p4ã€‚ Step 3ï¼šé•¿åº¦æƒ©ç½š len(candidate) \u003e len(reference) æ‰€ä»¥æ²¡æœ‰æƒ©ç½šï¼ŒBP=1 Step 4ï¼šç»¼åˆ BLEU BLEU=1Ã—expâ¡((logâ¡p1+logâ¡p2+logâ¡p3+logâ¡p4)/4) BLEU = 1 \\times \\exp((\\log{p_1} + \\log{p_2} + \\log{p_3} + \\log{p_4})/4) BLEU=1Ã—exp((logp1â€‹+logp2â€‹+logp3â€‹+logp4â€‹)/4) åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡å¦‚ç¿»è¯‘çš„å¥å­ candidate=theï¼Œé‚£ä¹ˆå®ƒåœ¨ 1-gram ä¸­å°±èƒ½å¾—åˆ°å¾ˆé«˜çš„åˆ†æ•°ï¼Œé¿å…é¢„æµ‹è¿‡çŸ­çš„å¥å­å°±ä¼šé‡‡ç”¨æƒ©ç½šæœºåˆ¶ï¼šå½“é¢„æµ‹é•¿åº¦\u003eå‚è€ƒé•¿åº¦åˆ™ä¸æƒ©ç½šï¼ŒBP=1ï¼›å½“é¢„æµ‹é•¿åº¦\u003cå‚è€ƒé•¿åº¦ï¼ŒBP=exp(1 - r/c) æœºå™¨ç¿»è¯‘å¾ˆæ€•é«˜é˜¶ n-gram å…¨ä¸åŒ¹é… ä¸¾ä¸ªä¾‹å­ï¼š text candidate: the the the the the the reference: the cat is on the table å¯¹äº 2-gram æœ‰: text candidate bigram: \"the the\", \"the the\", ... reference bigram: \"the cat\", \"cat is\", ... æ€» clipped=0, æ€» can bigram=5, å¾—åˆ° p(2)=0ã€‚ è®¡ç®— BLEU åˆ†æ•°æ—¶ï¼š$geo_mean = exp(\\frac{1}{4}( \\log(p_1) + \\log(p_2) + \\log(p_3) + \\log(p_4)))$ ç”±äº log(0) ç­‰äºè´Ÿæ— ç©·ï¼Œæ‰€ä»¥å–å¯¹æ•°ä¹‹å BLEU åˆ†æ•°ä¸º 0ã€‚ ","date":"2025-11-23","objectID":"/posts/cs224n-lecture7/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 7: Attention, Final Project and LLM intro","uri":"/posts/cs224n-lecture7/#bleu-è¯„ä¼°æŒ‡æ ‡"},{"categories":null,"content":" æ³¨æ„åŠ›æœºåˆ¶","date":"2025-11-23","objectID":"/posts/cs224n-lecture7/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 7: Attention, Final Project and LLM intro","uri":"/posts/cs224n-lecture7/#æ³¨æ„åŠ›æœºåˆ¶"},{"categories":null,"content":" ç»å…¸ç‚¹ç§¯æ³¨æ„åŠ› $S^T$ æ˜¯ Decoder åœ¨å½“å‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ dec_hidden $h_i$ æ˜¯ Encoder çš„ç¬¬ i ä¸ª token å¯¹åº”çš„éšè—çŠ¶æ€ enc_hidden_i $s^Th_i$ å°±èƒ½å¾—åˆ° Decoder å½“å‰ token å’Œ Encoder ç¬¬ i ä¸ª token çš„æ³¨æ„åŠ›åˆ†æ•°ï¼Œå¯¹ Encoder çš„æ¯ä¸€ä¸ªæ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œ softmax å°±èƒ½å¾—åˆ°æ³¨æ„åŠ›æƒé‡ è¿™ä¸ªå°±æ˜¯æœ€æ—©æå‡ºçš„ Bahdanau æ³¨æ„åŠ›ï¼Œä½†æ˜¯è¿™ä¸ªç®—æ³•çš„é—®é¢˜åœ¨äºï¼š$h_i$ è¿™ä¸ªå‘é‡åŒ…å«äº†å®Œæ•´ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤ªå¤šä¸éœ€è¦çš„ä¿¡æ¯äº†ã€‚ ","date":"2025-11-23","objectID":"/posts/cs224n-lecture7/:2:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 7: Attention, Final Project and LLM intro","uri":"/posts/cs224n-lecture7/#ç»å…¸ç‚¹ç§¯æ³¨æ„åŠ›"},{"categories":null,"content":" ä¹˜æ³•æ³¨æ„åŠ› ä¹˜æ³•æ³¨æ„åŠ›çš„è§£å†³æ–¹æ³•å°±æ˜¯ï¼šåœ¨ä¸¤ä¸ªå‘é‡ä¹‹é—´ä¹˜ä¸€ä¸ªçŸ©é˜µï¼Œè¿™ä¸ªçŸ©é˜µå¯ä»¥å­¦ä¹ éšè—çŠ¶æ€å“ªä¸€éƒ¨åˆ†æ˜¯æœ‰ç”¨çš„ ","date":"2025-11-23","objectID":"/posts/cs224n-lecture7/:2:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 7: Attention, Final Project and LLM intro","uri":"/posts/cs224n-lecture7/#ä¹˜æ³•æ³¨æ„åŠ›"},{"categories":null,"content":" ä½ç§©ä¹˜æ³•æ³¨æ„åŠ› ä¹˜æ³•æ³¨æ„åŠ›çš„é—®é¢˜åœ¨äºï¼Œå½“éšè—çŠ¶æ€é•¿åº¦å¾ˆå¤§æ—¶ï¼Œä¸­é—´çŸ©é˜µçš„å‚æ•°é‡å°±ä¼šéå¸¸å¤§ã€‚è§£å†³åŠæ³•æ˜¯æŠŠå¤§æ–¹é˜µæ‹†ä¸ºä¸¤ä¸ªä½ç§©çš„çŸ©é˜µï¼Œå®ƒä»¬æœ‰ä¸€æ ·çš„æ•ˆæœã€‚ ","date":"2025-11-23","objectID":"/posts/cs224n-lecture7/:2:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 7: Attention, Final Project and LLM intro","uri":"/posts/cs224n-lecture7/#ä½ç§©ä¹˜æ³•æ³¨æ„åŠ›"},{"categories":null,"content":" è¯­è¨€æ¨¡å‹ LMå¯ä»¥é€šè¿‡ä¸€å¥è¯çš„å‰nä¸ªè¯ï¼Œè®¡ç®—å‡ºä¸‹ä¸€ä¸ªè¯æ˜¯æŸä¸ªè¯çš„æ¦‚ç‡ã€‚ P(xt+1âˆ£xt,...,x1) P(x^{t+1}|x^{t},...,x^1) P(xt+1âˆ£xt,...,x1) LMå¯ä»¥è®¡ç®—å‡ºæŸå¥è¯å‡ºç°çš„æ¦‚ç‡ P(x1,...,xt)=P(x1)â‹…P(x2âˆ£x1)â‹…... P(x^1,...,x^{t})=P(x^1) \\cdot P(x^2|x^1) \\cdot ... P(x1,...,xt)=P(x1)â‹…P(x2âˆ£x1)â‹…...","date":"2025-11-22","objectID":"/posts/cs224n-lecture5/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 5: Recurrent Neural Networks","uri":"/posts/cs224n-lecture5/#è¯­è¨€æ¨¡å‹"},{"categories":null,"content":" N-gramN-gram æŒ‡çš„æ˜¯ä¸€å †è¿ç»­çš„è¯ï¼Œè€Œ N æŒ‡çš„æ˜¯è¿™ä¸€å †è¯çš„ä¸ªæ•°ã€‚ä¸€ä¸ª N-gram çš„ LM å°±å¯ä»¥æ ¹æ®å‰ N-1 ä¸ªè¯ï¼Œé¢„æµ‹å‡ºç¬¬ N ä¸ªè¯çš„æ¦‚ç‡ã€‚ å¯¹äºä¸€ä¸ªN-gramçš„LMï¼Œæˆ‘ä»¬éœ€è¦åšä¸€ä¸ªå‡è®¾ï¼šæŸä¸ªè¯å‡ºç°çš„æ¦‚ç‡åªç”±å…¶å‰N-1ä¸ªè¯å†³å®šã€‚ å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª 3-gram çš„ LMï¼Œè¦æ ¹æ®â€œä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·â€æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªè¯ï¼Œé‚£ä¹ˆåªèƒ½ä½¿ç”¨â€œæ€ä¹ˆæ ·â€æ¥é¢„æµ‹ï¼Œè€Œä¸çœ‹ä¹‹å‰çš„å­—ã€‚ P(xtâˆ£xtâˆ’1,...,t1)=P(xtâˆ£xtâˆ’1,...,xxâˆ’N+1)=xt,xtâˆ’1,...,ttâˆ’N+1P(xtâˆ’1,...,xtâˆ’N+1) P(x^t|x^{t-1},...,t^1) \\\\ =P(x^t|x^{t-1},...,x^{x-N+1}) \\\\ =\\frac{x^t,x^{t-1},...,t^{t-N+1}}{P(x^{t-1},...,x^{t-N+1})} P(xtâˆ£xtâˆ’1,...,t1)=P(xtâˆ£xtâˆ’1,...,xxâˆ’N+1)=P(xtâˆ’1,...,xtâˆ’N+1)xt,xtâˆ’1,...,ttâˆ’N+1â€‹ ç­‰å¼1å°±æ˜¯æ ¹æ®ä¹‹å‰çš„å‡è®¾å¾—åˆ°çš„ ç­‰å¼2æ˜¯é€šè¿‡æ¡ä»¶æ¦‚ç‡è®¡ç®—å¾—åˆ°çš„ æ¦‚ç‡ç”¨è¯­æ–™åº“ä¸­å‡ºç°çš„é¢‘ç‡æ¥ä¼°è®¡ ç¨€ç–æ€§é—®é¢˜ å½“åˆ†å­åœ¨è¯­æ–™ä¸­ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨ä¸€ä¸ªå¾ˆå°çš„æ•°è¡¥ä¸Šï¼Œä¾‹å¦‚0.25 å½“åˆ†æ¯åœ¨è¯­æ–™ä¸­ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ backoff çš„ç­–ç•¥ï¼Œç»Ÿè®¡(N-2)-gramçš„ä¸ªæ•°ã€‚ å­˜å‚¨é—®é¢˜ è™½ç„¶è¿™ç§åŸºäºè®¡æ•°çš„LMçš„å¾ˆç®€å•ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»ç©·ä¸¾å‡ºé¢„æ–™ä¸­æ‰€æœ‰å¯èƒ½çš„N-gramï¼Œå¹¶é€ä¸€å»è®¡æ•°ã€ä¿å­˜ï¼ŒNä¸€æ—¦å¤§èµ·æ¥çš„è¯ï¼Œæ¨¡å‹çš„å¤§å°å°±ä¼šé™¡å¢ã€‚ å¯¹äºæ–‡æœ¬ç”Ÿæˆæ¥è¯´ï¼Œè¿™ç§åŸºäºè®¡æ•°çš„LMåˆ™æœ‰å¾ˆå¤§é—®é¢˜äº†ã€‚è¿™é‡Œæ‹¿CS224Nçš„PPTä¸Šçš„ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š ","date":"2025-11-22","objectID":"/posts/cs224n-lecture5/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 5: Recurrent Neural Networks","uri":"/posts/cs224n-lecture5/#n-gram"},{"categories":null,"content":" å¾ªç¯ç¥ç»ç½‘ç»œ RNN RNN çš„è®¾è®¡æ€è·¯å¦‚ä¸‹ï¼š ht=tanh(Wxâ‹…xt+Whâ‹…htâˆ’1+bh) h_t=tanh(Wx \\cdot x_t + W_h \\cdot h_{t-1} + b_h) htâ€‹=tanh(Wxâ‹…xtâ€‹+Whâ€‹â‹…htâˆ’1â€‹+bhâ€‹) ä¼ å…¥æ–‡æœ¬çš„ one-hot ç¼–ç  åœ¨åµŒå…¥å±‚ä¸­å–å‡ºæ¯ä¸ªè¯å¯¹åº”çš„ embedding å¼€å§‹å¾ªç¯å¤„ç†ï¼šé¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªçŸ©é˜µ $w_0$ï¼Œæ¯æ¬¡å¾ªç¯ç”¨ä¸€ä¸ªçŸ©é˜µ$w_i$å’Œè¯å‘é‡ç›¸ä¹˜ï¼Œå†ä¸ä¸Šä¸€ä¸ªçŸ©é˜µç›¸åŠ å¾—åˆ°æ–°çŸ©é˜µï¼Œå¾ªç¯å¾€å¤ã€‚ æœ€åè¿›è¡Œ softmax ä½†æ˜¯ RNN çš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼š å¾ªç¯çš„æ¬¡æ•°å’Œæ–‡æœ¬é•¿åº¦æœ‰å…³ï¼Œæ•ˆç‡ä½ é•¿æ–‡æœ¬éš¾ä»¥æ•æ‰ç›¸äº’å…³ç³» è®­ç»ƒè¿‡ç¨‹ æˆ‘ä»¬æŠŠåºåˆ—ä½œä¸ºè¾“å…¥ï¼Œè¾“å…¥åˆ°RNNç½‘ç»œä¸­ï¼Œæ¯ä¸€æ­¥éƒ½å¯ä»¥å¾—åˆ°ä¸€ä¸ªè¾“å‡ºï¼Œè¿™ä¸ªè¾“å‡ºå³ä¸ºå½“å‰æ­¥çš„ä¸‹ä¸€ä¸ªè¯çš„æ¦‚ç‡åˆ†å¸ƒã€‚æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ¦‚ç‡åˆ†å¸ƒå¯ä»¥å’ŒçœŸå®çš„æ¦‚ç‡åˆ†å¸ƒè®¡ç®—ä¸€ä¸ªæŸå¤±ã€‚æ˜ç¡®äº†æŸå¤±å‡½æ•°ï¼Œæˆ‘ä»¬å°±å¾ˆå®¹æ˜“å»è®­ç»ƒäº†ã€‚ ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œé¦–å…ˆè¾“å…¥theï¼Œå¾—åˆ°ä¸‹ä¸€ä¸ªè¯çš„æ¦‚ç‡åˆ†å¸ƒï¼Œä¸studentsè®¡ç®—æŸå¤±ã€‚ä¹‹åè¾“å…¥ç¬¬äºŒå­—è¯studentsä¸æ­£ç¡®çš„openedè®¡ç®—æŸå¤±ã€‚æœ€åå°†æŸå¤±ç›¸åŠ è®¡ç®—å¹³å‡æŸå¤±ã€‚ åœ¨å¤§è®­ç»ƒæ–‡æœ¬ä¸Šé€šå¸¸ä¼šå›ºå®šå¤§å°åˆ‡å‰²ä¸€æ¬¡ï¼Œä¸ä¼šè€ƒè™‘è¯­è¨€ç»†èŠ‚ã€‚å¹¶ä¸”è¿™ä¸ªå¥½å¤„åœ¨äºå¯ä»¥ç»„åˆæˆä¸ºçŸ©é˜µæ–¹ä¾¿è¾“å…¥ã€‚ ","date":"2025-11-22","objectID":"/posts/cs224n-lecture5/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 5: Recurrent Neural Networks","uri":"/posts/cs224n-lecture5/#å¾ªç¯ç¥ç»ç½‘ç»œ-rnn"},{"categories":null,"content":" æ¢¯åº¦æ¶ˆå¤±\u0026æ¢¯åº¦çˆ†ç‚¸RNN åœ¨è¿›è¡Œåå‘ä¼ æ’­ï¼Œè®¡ç®—ç¬¬ j æ­¥çš„æŸå¤±å¯¹å‰é¢çš„ä¸€æ­¥æ¢¯åº¦çš„æ—¶å€™ï¼Œéœ€è¦è¿ç”¨é“¾å¼æ³•åˆ™ï¼š âˆ‚Jjâˆ‚hi=âˆ‚Jjâˆ‚hjâ‹…âˆ‚hjâˆ‚hi=âˆ‚Jjâˆ‚hjâ‹…âˆ‚hjâˆ‚hjâˆ’1â‹…â€¦â‹…âˆ‚hi+1âˆ‚hi=âˆ‚Jjâˆ‚hjâ‹…âˆi\u003ctâ‰¤jâˆ‚htâˆ‚htâˆ’1 \\begin{aligned} \\frac{\\partial J^j}{\\partial h^i} \u0026= \\frac{\\partial J^j}{\\partial h^j} \\cdot \\frac{\\partial h^j}{\\partial h^i} \\\\ \u0026= \\frac{\\partial J^j}{\\partial h^j} \\cdot \\frac{\\partial h^j}{\\partial h^{j-1}} \\cdot \\ldots \\cdot \\frac{\\partial h^{i+1}}{\\partial h^i} \\\\ \u0026= \\frac{\\partial J^j}{\\partial h^j} \\cdot \\prod_{i\u003ct\\le j} \\frac{\\partial h^t}{\\partial h^{t-1}} \\end{aligned} âˆ‚hiâˆ‚Jjâ€‹â€‹=âˆ‚hjâˆ‚Jjâ€‹â‹…âˆ‚hiâˆ‚hjâ€‹=âˆ‚hjâˆ‚Jjâ€‹â‹…âˆ‚hjâˆ’1âˆ‚hjâ€‹â‹…â€¦â‹…âˆ‚hiâˆ‚hi+1â€‹=âˆ‚hjâˆ‚Jjâ€‹â‹…i\u003ctâ‰¤jâˆâ€‹âˆ‚htâˆ’1âˆ‚htâ€‹â€‹æ ¹æ® RNN çš„å…¬å¼$h_t=tanh(Wx \\cdot x_t + W_h \\cdot h_{t-1} + b_h)$ï¼Œå°†æ¿€æ´»å‡½æ•°å¿½ç•¥å¯ä»¥å¾—åˆ°ï¼Œ$h_t$å¯¹$h_{t-1}$çš„åå¯¼å°±æ˜¯ Wï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿‘ä¼¼å¾—åˆ°ï¼š âˆ‚Jjâˆ‚hi=âˆ‚Jjâˆ‚hjâ‹…Wjâˆ’i \\frac{\\partial{J^j}}{\\partial{h^i}} = \\frac{\\partial{J^j}}{\\partial{h^j}} \\cdot W^{j-i} âˆ‚hiâˆ‚Jjâ€‹=âˆ‚hjâˆ‚Jjâ€‹â‹…Wjâˆ’iå¯ä»¥çœ‹å‡ºï¼Œå½“ W å¾ˆå°æˆ–è€…å¾ˆå¤§ï¼ŒåŒæ—¶ i å’Œ j ç›¸å·®å¾ˆè¿œçš„æ—¶å€™ï¼Œç”±äºå…¬å¼é‡Œæœ‰ä¸€ä¸ªæŒ‡æ•°è¿ç®—ï¼Œè¿™ä¸ªæ¢¯åº¦å°±ä¼šå‡ºç°å¼‚å¸¸ï¼Œå˜å¾—è¶…å¤§æˆ–è€…è¶…å°ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œæ¢¯åº¦æ¶ˆå¤±/æ¢¯åº¦çˆ†ç‚¸â€é—®é¢˜ã€‚ æ¢¯åº¦çˆ†ç‚¸çš„è§£å†³åŠæ³•å¾ˆæš´åŠ›å¾ˆç®€å•ï¼Œå°±æ˜¯å½“æ¢¯åº¦è¶…è¿‡ä¸€ä¸ªé˜ˆå€¼æ—¶å€™ï¼Œå°†å®ƒè£å‰ªæˆé˜ˆå€¼å¤§å°ï¼š ","date":"2025-11-22","objectID":"/posts/cs224n-lecture6/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 6: Sequence to Sequence Models","uri":"/posts/cs224n-lecture6/#æ¢¯åº¦æ¶ˆå¤±æ¢¯åº¦çˆ†ç‚¸"},{"categories":null,"content":" LSTMLSTM åœ¨ RNN çš„åŸºç¡€ä¸Šå¾ˆå¥½çš„è§£å†³äº†é•¿è·ç¦»è¯¦ç»†ä¼ é€’çš„é—®é¢˜ï¼Œå®ƒå¼•å…¥äº† Cell State å’Œä¸‰ä¸ªé—¨ Forget Gate, Input Gate å’Œ Output Gate æ¥ä¼ è¾“è®°å¿†å’Œå†³å®šå“ªäº›è®°å¿†æ˜¯éœ€è¦çš„ï¼Œå“ªäº›ä¸éœ€è¦ã€‚ é—å¿˜é—¨ï¼šæ ¹æ®$h^{t-1}$å’Œ$x^t$åˆ¤æ–­ Cell State å“ªä¸€äº›éœ€è¦é—å¿˜ è¾“å…¥é—¨ï¼šæ ¹æ®$h^{t-1}$å’Œ$x^t$åˆ¤æ–­éœ€è¦å‘ Cell State ä¼ å…¥å“ªäº›å½“å‰ä¿¡æ¯ è¾“å‡ºé—¨ï¼šæ ¹æ®$h^{t-1}$å’Œ$x^t$åˆ¤æ–­éœ€è¦ä» Cell State ä¸­è¾“å‡ºå“ªäº›ä¿¡æ¯ ä»¥ Forget Gate ä¸¾ä¾‹ï¼š ft=Ïƒ(wfhtâˆ’1+Ufxt+bf) f^t=\\sigma(w_fh^{t-1}+U_fx^t+b_f) ft=Ïƒ(wfâ€‹htâˆ’1+Ufâ€‹xt+bfâ€‹)sigmoid æ¿€æ´»å‡½æ•°ä¼šå°†è®¡ç®—ç»“æœéšå°„åˆ° 0-1 çš„åŒºé—´ï¼Œç„¶åä¸ $c^{t-1}$ç›¸ä¹˜ã€‚å€¼è¶Šæ¥è¿‘äº 1ï¼Œå†å²è®°å¿†å°±ä¿ç•™ï¼›ç›¸åå€¼è¶‹äº 0ï¼Œå†å²è®°å¿†å°±é—å¿˜ã€‚ ä¸ºä»€ä¹ˆ LSTM ç›¸å¯¹äº RNN èƒ½å¤Ÿè®°å¿†æ›´é•¿çš„è®°å¿†ï¼Ÿ æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ RNN çš„å…¬å¼ï¼š ht=tanh(Wxâ‹…xt+Whâ‹…htâˆ’1+bh) h_t=tanh(Wx \\cdot x_t + W_h \\cdot h_{t-1} + b_h) htâ€‹=tanh(Wxâ‹…xtâ€‹+Whâ€‹â‹…htâˆ’1â€‹+bhâ€‹)ç”±äºå‚æ•°çŸ©é˜µæ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥è¿›è¡Œåå‘ä¼ æ’­æ—¶å€™ï¼Œæ¢¯åº¦è¦ä¹ˆä¼šéå¸¸å¤§è¦ä¹ˆä¼šéå¸¸å°ã€‚ ä½†æ˜¯å¯¹äº LSTMï¼Œå®ƒçš„ä¸‰ä¸ªé—¨æ§æœºåˆ¶å¯ä»¥é€‰æ‹©æ¯æ¬¡ä¿ç•™ or é—å¿˜è®°å¿†ï¼Œä½¿å¾—å†å²è®°å¿†å¯ä»¥é•¿æœŸä¿å­˜ã€‚ä¸¾ä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼Œé—å¿˜é—¨æ€»æ˜¯ä¸º 1ï¼Œè¾“å…¥é—¨æ€»æ˜¯ä¸º 0ï¼Œé‚£ä¹ˆå†å²è®°å¿†å°±èƒ½ä¸€ç›´åœ¨ Cell State ä¸Šæµé€šã€‚ å®é™…ä¸Šï¼ŒLSTM ä¸å…‰æ˜¯è§£å†³äº†é•¿è·ç¦»ä¾èµ–çš„é—®é¢˜ï¼Œå®ƒçš„å„ç§é—¨ï¼Œä½¿å¾—æ¨¡å‹çš„å­¦ä¹ æ½œåŠ›å¤§å¤§æå‡ï¼Œå„ç§é—¨çš„å¼€é—­çš„ç»„åˆï¼Œè®©æ¨¡å‹å¯ä»¥å­¦ä¹ å‡ºè‡ªç„¶è¯­è¨€ä¸­å„ç§å¤æ‚çš„å…³ç³»ã€‚æ¯”å¦‚é—å¿˜é—¨çš„ä½¿ç”¨ï¼Œå¯ä»¥è®©æ¨¡å‹å­¦ä¹ å‡ºä»€ä¹ˆæ—¶å€™è¯¥æŠŠå†å²çš„ä¿¡æ¯ç»™å¿˜æ‰ï¼Œè¿™æ ·å°±å¯ä»¥è®©æ¨¡å‹åœ¨ç‰¹ç‚¹çš„æ—¶å€™æ’é™¤å¹²æ‰°ã€‚ ","date":"2025-11-22","objectID":"/posts/cs224n-lecture6/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 6: Sequence to Sequence Models","uri":"/posts/cs224n-lecture6/#lstm"},{"categories":null,"content":" Part 1","date":"2025-11-21","objectID":"/posts/cs224n-assignment1/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 1","uri":"/posts/cs224n-assignment1/#part-1"},{"categories":null,"content":" Question 1.1: Implement distinct_words [code] (2 points)Write a method to work out the distinct words (word types) that occur in the corpus. You can use for loops to process the input corpus (a list of list of strings), but try using Python list comprehensions (which are generally faster). In particular, this may be useful to flatten a list of lists. If youâ€™re not familiar with Python list comprehensions in general, hereâ€™s more information. Your returned corpus_words should be sorted. You can use pythonâ€™s sorted function for this. You may find it useful to use Python sets to remove duplicate words. python def distinct_words(corpus): \"\"\" Determine a list of distinct words for the corpus. Params: corpus (list of list of strings): corpus of documents Return: corpus_words (list of strings): sorted list of distinct words across the corpus n_corpus_words (integer): number of distinct words across the corpus \"\"\" corpus_words = [] n_corpus_words = -1 # ------------------ # Write your implementation here. corpus_words = [item for sublist in corpus for item in sublist] corpus_words = sorted(list(set(corpus_words))) n_corpus_words = len(corpus_words) # ------------------ return corpus_words, n_corpus_words ","date":"2025-11-21","objectID":"/posts/cs224n-assignment1/:1:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 1","uri":"/posts/cs224n-assignment1/#question-11-implement-distinct_words-code-2-points"},{"categories":null,"content":" Question 1.2: Implement compute_co_occurrence_matrix [code] (3 points)Write a method that constructs a co-occurrence matrix for a certain window-size $n$ (with a default of 4), considering words $n$ before and $n$ after the word in the center of the window. Here, we start to use numpy (np) to represent vectors, matrices, and tensors. If youâ€™re not familiar with NumPy, thereâ€™s a NumPy tutorial in the second half of this cs231n Python NumPy tutorial. python def compute_co_occurrence_matrix(corpus, window_size=4): \"\"\" Compute co-occurrence matrix for the given corpus and window_size (default of 4). Note: Each word in a document should be at the center of a window. Words near edges will have a smaller number of co-occurring words. For example, if we take the document \"\u003cSTART\u003e All that glitters is not gold \u003cEND\u003e\" with window size of 4, \"All\" will co-occur with \"\u003cSTART\u003e\", \"that\", \"glitters\", \"is\", and \"not\". Params: corpus (list of list of strings): corpus of documents window_size (int): size of context window Return: M (a symmetric numpy matrix of shape (number of unique words in the corpus , number of unique words in the corpus)): Co-occurence matrix of word counts. The ordering of the words in the rows/columns should be the same as the ordering of the words given by the distinct_words function. word2ind (dict): dictionary that maps word to index (i.e. row/column number) for matrix M. \"\"\" words, n_words = distinct_words(corpus) M = None word2ind = {} # ------------------ # Write your implementation here. M = np.zeros((n_words, n_words)) for index, word in enumerate(words): word2ind[word] = index for sentence in corpus: for sta, word in enumerate(sentence): for i in range(-window_size, window_size + 1): idx = min(max(sta+i, 0), len(sentence) - 1) if idx == sta: continue M[word2ind[word], word2ind[sentence[idx]]] += 1 # ------------------ return M, word2ind ","date":"2025-11-21","objectID":"/posts/cs224n-assignment1/:1:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 1","uri":"/posts/cs224n-assignment1/#question-12-implement-compute_co_occurrence_matrix-code-3-points"},{"categories":null,"content":" Question 1.3: Implement reduce_to_k_dim [code] (1 point)Construct a method that performs dimensionality reduction on the matrix to produce k-dimensional embeddings. Use SVD to take the top k components and produce a new matrix of k-dimensional embeddings. Note: All of numpy, scipy, and scikit-learn (sklearn) provide some implementation of SVD, but only scipy and sklearn provide an implementation of Truncated SVD, and only sklearn provides an efficient randomized algorithm for calculating large-scale Truncated SVD. So please use sklearn.decomposition.TruncatedSVD. sklearn-svdä½¿ç”¨æ–¹æ³• python from sklearn.decomposition import TruncatedSVD import numpy as np # ä¸€ä¸ªç¤ºä¾‹çŸ©é˜µï¼ˆæ¯”å¦‚å…±ç°çŸ©é˜µï¼‰ A = np.array([ [1, 1, 0], [0, 1, 1], [1, 0, 1] ]) # ä¿ç•™ 2 ä¸ªå¥‡å¼‚å€¼ svd = TruncatedSVD(n_components=2) A_reduced = svd.fit_transform(A) print(\"UÎ£ï¼ˆé™ç»´ç»“æœï¼‰:\") print(A_reduced) print(\"\\nå¥‡å¼‚å€¼ Î£:\") print(svd.singular_values_) print(\"\\nå³å¥‡å¼‚å‘é‡ V^T:\") print(svd.components_) ","date":"2025-11-21","objectID":"/posts/cs224n-assignment1/:1:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 1","uri":"/posts/cs224n-assignment1/#question-13-implement-reduce_to_k_dim-code-1-point"},{"categories":null,"content":" Question 1.4: Implement plot_embeddings [code] (1 point)Here you will write a function to plot a set of 2D vectors in 2D space. For graphs, we will use Matplotlib (plt). For this example, you may find it useful to adapt this code. In the future, a good way to make a plot is to look at the Matplotlib gallery, find a plot that looks somewhat like what you want, and adapt the code they give. python def plot_embeddings(M_reduced, word2ind, words): \"\"\" Plot in a scatterplot the embeddings of the words specified in the list \"words\". NOTE: do not plot all the words listed in M_reduced / word2ind. Include a label next to each point. Params: M_reduced (numpy matrix of shape (number of unique words in the corpus , 2)): matrix of 2-dimensioal word embeddings word2ind (dict): dictionary that maps word to indices for matrix M words (list of strings): words whose embeddings we want to visualize \"\"\" # -------- primary ---------- for word in words: idx = word2ind[word] x = M_reduced[idx][0] y = M_reduced[idx][1] plt.scatter(x, y, marker='x', color='red') plt.text(x, y, word, fontsize=9) plt.show() # -------- better ---------- x_coords = M_reduced[:, 0] y_coords = M_reduced[:, 1] for word in words: x = x_coords[word2ind[word]] y = y_coords[word2ind[word]] plt.scatter(x, y, marker='x', color='red') plt.text(x, y, word, fontsize=9) plt.show() ","date":"2025-11-21","objectID":"/posts/cs224n-assignment1/:1:4","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 1","uri":"/posts/cs224n-assignment1/#question-14-implement-plot_embeddings-code-1-point"},{"categories":null,"content":" Part 2","date":"2025-11-21","objectID":"/posts/cs224n-assignment1/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 1","uri":"/posts/cs224n-assignment1/#part-2"},{"categories":null,"content":" Question 2.1: GloVe Plot Analysis [written] (3 points)Run the cell below to plot the 2D GloVe embeddings for ['movie', 'book', 'mysterious', 'story', 'fascinating', 'good', 'interesting', 'large', 'massive', 'huge']. ","date":"2025-11-21","objectID":"/posts/cs224n-assignment1/:2:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 1","uri":"/posts/cs224n-assignment1/#question-21-glove-plot-analysis-written-3-points"},{"categories":null,"content":" Cosine SimilarityNow that we have word vectors, we need a way to quantify the similarity between individual words, according to these vectors. One such metric is cosine-similarity. We will be using this to find words that are â€œcloseâ€ and â€œfarâ€ from one another. We can think of n-dimensional vectors as points in n-dimensional space. If we take this perspective L1 and L2 Distances help quantify the amount of space â€œwe must travelâ€ to get between these two points. Another approach is to examine the angle between two vectors. From trigonometry we know that: Instead of computing the actual angle, we can leave the similarity in terms of $similarity = cos(\\Theta)$. Formally the Cosine Similarity $s$ between two vectors $p$ and $q$ is defined as: s=pâ‹…qâˆ£âˆ£pâˆ£âˆ£âˆ£âˆ£qâˆ£âˆ£,Â whereÂ sâˆˆ[âˆ’1,1] s = \\frac{p \\cdot q}{||p|| ||q||}, \\textrm{ where } s \\in [-1, 1] s=âˆ£âˆ£pâˆ£âˆ£âˆ£âˆ£qâˆ£âˆ£pâ‹…qâ€‹,Â whereÂ sâˆˆ[âˆ’1,1]ç”¨pythonå®ç°ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—å¦‚ä¸‹ï¼š python similarity = np.dot(p, q) / (np.linalg.norm(p) * np.linalg.norm(q)) ","date":"2025-11-21","objectID":"/posts/cs224n-assignment1/:2:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 1","uri":"/posts/cs224n-assignment1/#cosine-similarity"},{"categories":null,"content":" Question 2.3: Synonyms \u0026 Antonyms (2 points) [code + written]When considering Cosine Similarity, itâ€™s often more convenient to think of Cosine Distance, which is simply 1 - Cosine Similarity. Find three words $(w_1,w_2,w_3)$ where $w_1$ and $w_2$ are synonyms and $w_1$ and $w_3$ are antonyms, but Cosine Distance $(w_1,w_3) \u003c$ Cosine Distance $(w_1,w_2)$. As an example, $w_1$=â€œhappyâ€ is closer to $w_3$=â€œsadâ€ than to $w_2$=â€œcheerfulâ€. Please find a different example that satisfies the above. Once you have found your example, please give a possible explanation for why this counter-intuitive result may have happened. You should use the the wv_from_bin.distance(w1, w2) function here in order to compute the cosine distance between two words. Please see the GenSim documentation for further assistance. å¯¼è‡´åŒä¹‰è¯æ¯”åä¹‰è¯çš„ä½™å¼¦è·ç¦»æ›´å¤§çš„åŸå› å¯èƒ½ä¸ºï¼Œåœ¨æŸä¸ªè¯­æ–™åº“ä¸‹ï¼Œä¸¤ä¸ªåä¹‰è¯ä¸€èµ·å‡ºç°çš„é¢‘ç‡å¾ˆé«˜ã€‚ ","date":"2025-11-21","objectID":"/posts/cs224n-assignment1/:2:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 1","uri":"/posts/cs224n-assignment1/#question-23-synonyms--antonyms-2-points-code--written"},{"categories":null,"content":" ä¾å­˜è¯­æ³•ä¼ ç»Ÿçš„ä¼ ç»Ÿå¥æ³•ï¼ˆå¦‚çŸ­è¯­ç»“æ„è¯­æ³•ï¼‰è®¤ä¸ºå¥å­æ˜¯ç”±çŸ­è¯­ç»„æˆçš„å±‚çº§ç»“æ„ã€‚ä»¥I saw a cat under the tableä¸ºä¾‹å­ tableæ˜¯åè¯ the table ç»„æˆåè¯çŸ­è¯­ under æ˜¯ä»‹è¯ under the table ç»„æˆä»‹è¯çŸ­è¯­ a cat under the table åˆç»„æˆä¸€ä¸ªåè¯çŸ­è¯­â€¦.. è€Œä¾å­˜è¯­æ³•çš„å‡ºå‘ç‚¹ä¸åŒï¼Œå®ƒæå‡ºäº†ä¸€ä¸ªéå¸¸é‡è¦çš„å‡è®¾ï¼š å¥å­çš„ç»“æ„ç”±è¯ä¸è¯ä¹‹é—´çš„ä¾å­˜å…³ç³»ï¼ˆdependencyï¼‰å†³å®šã€‚ ä»¥ â€œI like youâ€ ä¸¾ä¾‹: text like -\u003e I (nsubj) like -\u003e you (obj) ä¸€èˆ¬åŠ¨è¯éƒ½æ˜¯ä¸€ä¸ªå¥å­çš„æ ¸å¿ƒ I ä¾èµ–äº likeï¼Œä¾èµ–å…³ç³»æ˜¯ä¸»è¯­(nsubj) you ä¾èµ–äº likeï¼Œ ä¾èµ–å…³ç³»æ˜¯å®¾è¯­(obj) ","date":"2025-11-21","objectID":"/posts/cs224n-lecture4/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 4: Dependency Parsing","uri":"/posts/cs224n-lecture4/#ä¾å­˜è¯­æ³•"},{"categories":null,"content":" ä¾å­˜å¥æ³•åˆ†æ Dependency Parsing = ç»™å¥å­ä¸­çš„æ¯ä¸ªè¯ï¼Œç¡®å®šå®ƒä¾èµ–äºå“ªä¸ªè¯ï¼Œä¹Ÿå°±æ˜¯é¢„æµ‹è¯ä¹‹é—´çš„ä¾å­˜å…³ç³»ã€‚ å½“æˆ‘ä»¬é¢„æµ‹å¥å­ä¸­è¯ä¸è¯çš„ä¾å­˜å…³ç³»æ—¶ï¼Œæ¨¡å‹åº”è¯¥è€ƒè™‘å“ªäº›ä¿¡æ¯æ¥æº? Bilexical affinities: ä¸¤ä¸ªå…·ä½“è¯ä¹‹é—´çš„äº²å’Œåº¦ Dependency distance: ä¾å­˜å…³ç³»ä¹‹é—´çš„è·ç¦» Intervening material: ä¾å­˜å…³ç³»é€šå¸¸ä¸ä¼šè·¨è¶ŠåŠ¨è¯æˆ–æ ‡ç‚¹ç­‰å¼ºç»“æ„è¾¹ç•Œ Valency of heads: ä¸€ä¸ªä¸­å¿ƒè¯ä¸€èˆ¬æœ‰è§„å®šæ•°é‡å’Œæ–¹å‘çš„ä¾å­˜è¯ï¼Œä¾‹å¦‚happyé€šå¸¸åªä¿®é¥°ä¸€ä¸ªåè¯ ä¸ºäº†ä¿è¯ç»“æœåˆæ³•ï¼Œä¾å­˜åˆ†æé€šå¸¸è¦æ»¡è¶³ä¸€äº›çº¦æŸï¼š Only one word is dependent of ROOT æ•´ä¸ªå¥å­åªæœ‰ä¸€ä¸ªæ ¸å¿ƒåŠ¨è¯ï¼ˆä¸€ä¸ª rootï¼‰ No cycles (Aâ†’B, Bâ†’A) ä¸å…è®¸å½¢æˆç¯ï¼Œå¦åˆ™ä¾å­˜æ ‘ä¸æˆç«‹ Dependencies form a tree æ‰€æœ‰ä¾å­˜è¾¹è¿é€šã€æ— ç¯ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå…¥è¾¹ ç®­å¤´æ˜¯å¦å¯ä»¥äº¤å‰ï¼Ÿ Projective treeï¼ˆæŠ•å°„å¥æ³•ï¼‰ï¼šæ‰€æœ‰ä¾å­˜è¾¹éƒ½ä¸äº¤å‰ â†’ å…¸å‹çš„è‹±è¯­å¥å­ç»“æ„ Non-projective treeï¼ˆéæŠ•å°„å¥æ³•ï¼‰ï¼šæœ‰äº¤å‰ä¾å­˜ â†’ å¸¸è§äºè‡ªç”±è¯­åºè¯­è¨€ï¼ˆå¦‚å¾·è¯­ã€ä¿„è¯­ã€ä¸­æ–‡ï¼‰ ","date":"2025-11-21","objectID":"/posts/cs224n-lecture4/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 4: Dependency Parsing","uri":"/posts/cs224n-lecture4/#ä¾å­˜å¥æ³•åˆ†æ"},{"categories":null,"content":" ä¾å­˜åˆ†ææ–¹æ³• åŠ¨æ€è§„åˆ’ å›¾ç®—æ³• çº¦æŸæ»¡è¶³æ³• è½¬ç§»ç³»ç»Ÿï¼šç»´æŠ¤ä¸€ä¸ª Stack + Bufferã€‚ç”±äºå˜æˆä¸€ä¸ªçº¿æ€§çš„è®¡ç®—è¿‡ç¨‹ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¹Ÿæ˜¯çº¿æ€§çš„ï¼Œç›¸è¾ƒäºå…¶ä»–ä¸¤ç§æ–¹æ³•ä½å¾ˆå¤šã€‚ ","date":"2025-11-21","objectID":"/posts/cs224n-lecture4/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 4: Dependency Parsing","uri":"/posts/cs224n-lecture4/#ä¾å­˜åˆ†ææ–¹æ³•"},{"categories":null,"content":" ä¾å­˜å…³ç³»å’Œæ·±åº¦å­¦ä¹ è½¬ç§»ç³»ç»Ÿï¼ˆTransition-based Dependency Parsingï¼‰ æ˜¯ä¾å­˜å¥æ³•åˆ†æä¸­æœ€ç›´è§‚ã€å·¥ç¨‹ä¸Šæœ€å¸¸ç”¨çš„ä¸€ç±»ç®—æ³•ã€‚å®ƒç»´æŠ¤äº†ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼šStackå’ŒBufferï¼Œå¹¶ä¸”åªè¿›è¡Œä¸‰ä¸ªæ“ä½œï¼šShiftï¼ŒLeft-Arcï¼ŒRight-Arcã€‚ ä»¥å¥å­\"I eat apples\"ä¸ºä¾‹ï¼š text 1.Initial Stack = [ROOT] Buffer = [I, eat, apples] Arcs = [] 2.Shift Stack = [ROOT, I] Buffer = [eat, apples] Arcs = [] 3.Shift Stack = [ROOT, I, eat] Buffer = [apples] Arcs = [] 4.Left-Arc Stack = [ROOT, eat] Buffer = [apples] Arcs = [(eat, I)] 5.Shift Stack = [ROOT, eat, apples] Buffer = [] Arcs = [(eat, I)] 6.Right-Arc Stack = [ROOT, eat] Buffer = [] Arcs = [(eat, I), (eat, apples)] 7.Right-Arc Stack = [] Buffer = [] Arcs = [(eat, I), (eat, apples), (ROOT, eat)] text ä¾å­˜æ ‘: ROOT â””â”€â”€ eat â”œâ”€â”€ I â””â”€â”€ apples ä»ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºæ·±åº¦å­¦ä¹ æ¨¡å‹å®ƒéœ€è¦åšçš„å°±æ˜¯åˆ¤æ–­æ¯æ¬¡éœ€è¦è¿›è¡Œå“ªä¸ªæ“ä½œï¼Œä¸‰é€‰ä¸€ã€‚ ","date":"2025-11-21","objectID":"/posts/cs224n-lecture4/:4:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 4: Dependency Parsing","uri":"/posts/cs224n-lecture4/#ä¾å­˜å…³ç³»å’Œæ·±åº¦å­¦ä¹ "},{"categories":null,"content":" è¯„ä»·æŒ‡æ ‡åœ¨æ·±åº¦å­¦ä¹ ä¸­è®­ç»ƒæ¨¡å‹éœ€è¦æœ‰ä¸€ä¸ªæŸå¤±å‡½æ•°ï¼Œæ ¹æ®æ¢¯åº¦è¿›è¡Œä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæŒ‡æ ‡æ¥è¯„ä»·é¢„æµ‹çš„ä¾å­˜å…³ç³»çš„å¥½ä¸åã€‚ text Gold: Parsed: 1 2 She nsubj 1 2 She nsubj 2 0 saw root 2 0 saw root 3 5 the det 3 4 the det 4 5 video nn 4 5 video nsubj 5 2 lecture obj 5 2 lecture ccomp UAS \\( UAS=\\frac{æ­£ç¡®é¢„æµ‹çš„headè¯æ•°}{æ€»è¯æ•°}=\\frac{4}{5}=80\\% \\) LAS \\( LAS=\\frac{headå’Œlabeléƒ½é¢„æµ‹æ­£å¼çš„è¯æ•°}{æ€»è¯æ•°}=\\frac{2}{5}=40\\% \\) ","date":"2025-11-21","objectID":"/posts/cs224n-lecture4/:5:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 4: Dependency Parsing","uri":"/posts/cs224n-lecture4/#è¯„ä»·æŒ‡æ ‡"},{"categories":null,"content":" ç¥ç»ç½‘ç»œä¾å­˜åˆ†æ åœ¨ç”¨ç¥ç»ç½‘ç»œå¯¹ä¾å­˜åˆ†æçš„æ¯ä¸€æ­¥æ“ä½œè¿›è¡Œé¢„æµ‹çš„æ—¶å€™ï¼Œéœ€è¦å½“å‰çŠ¶æ€çš„ä¸€ä¸ªè¾“å…¥å€¼ï¼Œè¿™ä¸ªè¾“å…¥çš„å‘é‡åº”è¯¥æ€ä¹ˆå¾—åˆ°å‘¢ï¼Ÿ å¾ˆæ˜¾ç„¶æˆ‘ä»¬ç›®å‰æœ‰Stackå’ŒBufferè¿˜æœ‰Arcsä¸‰ä¸ªçŠ¶æ€ï¼Œä½†æ˜¯å¦‚æœæŠŠå…¨éƒ¨çš„ä¿¡æ¯ä¸€è‚¡è„‘çš„è¾“å…¥ç»™ç¥ç»ç½‘ç»œå°±å†—ä½™äº†ï¼Œå®ƒåªéœ€è¦å…¶ä¸­çš„å‡ ä¸ªå…³é”®ä¿¡æ¯ï¼š Stackæ ˆé¡¶å’Œæ¬¡æ ˆé¡¶çš„å…ƒç´ : s1, s2 Bufferæœ€å‰é¢é©¬ä¸Šè¦è¢«å¤„ç†çš„è¯: b1 åœ¨Arcsä¸­s1, s2, b1çš„å·¦å³å­©å­ éœ€è¦Arcsä¸­å…ƒç´ å¯¹çš„åŸå› æ˜¯ï¼šå‡å¦‚ä¸€ä¸ªè¯å·²ç»æ‹¥æœ‰äº†ä¸»è¯­å°±ä¸å¯èƒ½å†æœ‰ä¸€ä¸ªä¸»è¯­äº† çŸ¥é“äº†æ¨¡å‹è¾“å…¥éœ€è¦çš„å…¨éƒ¨ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥å°±è¦è€ƒè™‘æ€ä¹ˆæŠŠå®ƒä¼ è¾“ç»™æ¨¡å‹ã€‚ å¯¹äºæ¯ä¸ªè¢«é€‰ä¸­çš„è¯ï¼ˆå¦‚ s1ã€s2ã€b1 åŠå…¶å­èŠ‚ç‚¹ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å–å®ƒçš„è¯å‘é‡ï¼ˆword embeddingï¼‰ï¼ŒåŒæ—¶æ‹¼æ¥å…¶ä»–ç‰¹å¾çš„å‘é‡ï¼Œå¦‚ï¼š è¯æ€§ï¼ˆPOSï¼‰åµŒå…¥ ä¾å­˜å…³ç³»æ ‡ç­¾åµŒå…¥ï¼ˆå¯¹å·²å»ºç«‹çš„å¼§ï¼‰ æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹ã€æ˜¯å¦å·²æœ‰çˆ¶èŠ‚ç‚¹ç­‰å¸ƒå°”ç‰¹å¾ æœ€ç»ˆï¼Œè¿™äº›å‘é‡ä¼šè¢«æ‹¼æ¥æˆä¸€ä¸ªå¤§çš„çŠ¶æ€è¡¨ç¤ºå‘é‡ï¼š \\[ x=[emb(s1â€‹),emb(s2â€‹),emb(b1â€‹),emb(children of s1â€‹),...] \\]","date":"2025-11-21","objectID":"/posts/cs224n-lecture4/:6:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 4: Dependency Parsing","uri":"/posts/cs224n-lecture4/#ç¥ç»ç½‘ç»œä¾å­˜åˆ†æ"},{"categories":null,"content":" å‰ç½®çŸ¥è¯†","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#å‰ç½®çŸ¥è¯†"},{"categories":null,"content":" ä¸€ã€Bahdanau æ³¨æ„åŠ›æœºåˆ¶Bahdanau æ³¨æ„åŠ›æœºåˆ¶çš„æ€æƒ³å°±æ˜¯åœ¨ Decoder çš„æ¯ä¸€ä¸ªæ—¶åˆ»ï¼Œç”¨å½“å‰ token å’Œ Encoder çš„æ¯ä¸€ä¸ª token è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼Œåˆ¤æ–­ Encoder çš„å“ªä¸€ä¸ª token å’Œå½“å‰ token å…³ç³»æœ€å¤§ã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:1:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#ä¸€bahdanau-æ³¨æ„åŠ›æœºåˆ¶"},{"categories":null,"content":" äºŒã€Teacher-forcingåœ¨æ—©æœŸçš„ seq2seq ç»“æ„ä¸­åªåŒ…å«æœ€ç®€å•çš„ Encoder å’Œ Decoder ä¸¤éƒ¨åˆ†ã€‚è®­ç»ƒæ—¶å¦‚æœè®© Decoder å®Œå…¨é è‡ªå·±å‰ä¸€æ­¥çš„é¢„æµ‹è¾“å‡ºå½“ä¸‹ä¸€æ­¥è¾“å…¥ï¼Œå®¹æ˜“å‡ºé”™ â†’ é”™è¯¯ä¸æ–­ç´¯ç§¯ï¼Œè®­ç»ƒéå¸¸éš¾æ”¶æ•›ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒTeacher-forcing çš„è§£å†³åŠæ³•æ˜¯ç›´æ¥æŠŠç­”æ¡ˆå‘Šè¯‰æ¨¡å‹ã€‚ å‡è®¾æ­£åœ¨ç¿»è¯‘ â€œI love youâ€ -\u003e â€œæˆ‘çˆ±ä½ â€: t=0ï¼Œè¾“å…¥å¥é¦– tokenï¼Œå°†é¢„æµ‹çš„ç¬¬ä¸€ä¸ª token å’Œç­”æ¡ˆæ±‚æŸå¤± t=1ï¼Œè¾“å…¥ â€œæˆ‘â€ï¼Œå°†é¢„æµ‹çš„ç¬¬äºŒä¸ª token æ±‚æŸå¤± t=2ï¼Œè¾“å…¥ â€œæˆ‘çˆ±â€, å°†é¢„æµ‹çš„ç¬¬ä¸‰ä¸ª token æ±‚æŸå¤± è¿™ä¸ªæ–¹æ³•çš„å¥½å¤„åœ¨äºå¯ä»¥é¿å…ä¸€æ­¥é”™æ­¥æ­¥é”™çš„ç°è±¡ï¼Œä½†æ˜¯åå¤„å°±æ˜¯è¿™ä¸ªæ–¹æ³•åœ¨è®­ç»ƒé›†æœ‰å¾ˆå¥½çš„è¡¨ç°ï¼Œä½†æ˜¯åœ¨æµ‹è¯•é›†å’ŒéªŒè¯é›†ä¸Šä»ç„¶å¯èƒ½çœ‹åˆ°ä¹‹å‰é”™è¯¯çš„é¢„æµ‹ã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:1:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#äºŒteacher-forcing"},{"categories":null,"content":" NMT åˆ†æ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#nmt-åˆ†æ"},{"categories":null,"content":" ä¸€ã€æ¨¡å‹æ ¸å¿ƒæ¡†æ¶æ€»è§ˆNMT æ¨¡å‹åšçš„äº‹æƒ…å°±æ˜¯å®ç° seq2seqï¼Œå®ƒæœ‰ä¸€ä¸ª Encoder ï¼ˆåŒå‘ LSTMï¼‰+ä¸€ä¸ª Decoder ï¼ˆå•å‘ LSTM å’Œæ³¨æ„åŠ›æœºåˆ¶ï¼‰å®ç°ã€‚å¾…ç¿»è¯‘çš„æ–‡æœ¬é¦–å…ˆä¼šé€šè¿‡ CNN å·ç§¯å±‚ï¼Œæœ‰åŠ©äºæå–ä¸Šä¸‹æ–‡ Token ä¹‹é—´çš„ä¿¡æ¯ã€‚ç„¶åè¿›å…¥åŒå‘ LSTMï¼Œè¾“å‡ºæ¯æ—¶åˆ»çš„éšè—çŠ¶æ€ï¼ŒLast_hidden å’Œ Last_cell ï¼ˆåé¢ä¼šæˆä¸º Decoder çš„åˆå§‹å‘é‡ï¼‰ã€‚Decoder é˜¶æ®µçš„è¾“å…¥æ˜¯çœŸå®çš„ç¿»è¯‘æ–‡æœ¬ä¹Ÿå°±æ˜¯ç­”æ¡ˆï¼‰, Decoder æ ¹æ®ç­”æ¡ˆ+éšè—çŠ¶æ€+æ³¨æ„åŠ›æœºåˆ¶é¢„æµ‹ä¸‹ä¸€ä¸ª token æ˜¯ä»€ä¹ˆï¼Œæœ€åæŸå¤±åˆ™ä¸ºæ¯ä¸€æŸå¤±çš„å¹³å‡å€¼ã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:2:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#ä¸€æ¨¡å‹æ ¸å¿ƒæ¡†æ¶æ€»è§ˆ"},{"categories":null,"content":" äºŒã€Encodeç¼–ç å™¨çš„ä½œç”¨æ˜¯é€šè¿‡åŒå‘ LSTM è§£æåŸæ–‡æœ¬ï¼Œæ ¹æ®åŸæ–‡æœ¬çš„è¯­ä¹‰ä¿¡æ¯ç”Ÿæˆå‘é‡æä¾›ç»™è§£ç å™¨ç”Ÿæˆç›®æ ‡æ–‡æœ¬ã€‚ 1. å¡«å……æ–‡æœ¬ è¾“å…¥åˆ° NMT æ¨¡å‹çš„æ–‡æœ¬å½¢çŠ¶ä¸º [B, L]ï¼Œè¿™é‡Œçš„ L æŒ‡çš„æ˜¯è®­ç»ƒé›†æ¯æ¡è¯„è®ºä¸åŒçš„é•¿åº¦ã€‚ ç»è¿‡å¤„ç†ï¼Œè¿™äº›å¼ é‡ä¼šç»Ÿä¸€åˆ°ç›¸åŒçš„é•¿åº¦å¾—åˆ°åŸæ–‡æœ¬å¼ é‡ [SL, B]ï¼Œè¿™é‡Œçš„ SLæŒ‡çš„æ˜¯åŸæ–‡æœ¬æœ€å¤§é•¿åº¦ã€‚ Q:ä¸ºä»€ä¹ˆè¾“å…¥å¼ é‡çš„å½¢çŠ¶æ˜¯ [SL, B]ï¼Œé€šå¸¸ä¸éƒ½æ˜¯ [B, SL] å—ï¼Ÿ A:å› ä¸º PyTorch ä¸­ï¼ŒLSTM æ¨¡å‹é»˜è®¤ batch_first=Falseï¼Œä¹Ÿå°±æ˜¯è¦æ±‚è¾“å…¥æ ¼å¼ä¸º [L, B, embedding_dim]ï¼Œè€Œè®­ç»ƒæ•°æ®é€šå¸¸æ˜¯ [B, L]ï¼Œæ‰€ä»¥å¿…é¡»è½¬æˆ [L, B]ã€‚å‡å¦‚è®¾ç½®äº† batch_first=Trueé‚£ä¹ˆå°±å¯ä»¥æ²¿ç”¨ä¹‹å‰çš„å½¢çŠ¶ [B, L]ã€‚ 2. è¯åµŒå…¥ NMT å†…éƒ¨ç»´æŠ¤ç€ä¸¤ä¸ªå¯è®­ç»ƒçš„ Embeddingï¼Œåˆ†åˆ«å¯¹åº”åŸæ–‡æœ¬å’Œç›®æ ‡æ–‡æœ¬ã€‚ å¯¹è¾“å…¥å¼ é‡è¿›è¡Œè¯åµŒå…¥ä¹‹åï¼Œå½¢çŠ¶ä» [SL, B] å˜æˆ [SL, B, E] ç”±äºè¦å¯¹å¼ é‡è¿›è¡Œå·ç§¯æ“ä½œï¼Œéœ€è¦å…ˆå˜å½¢ä¸º [B, E, SL] å†å˜å› [SL, B, E] ä¸ºäº†é¿å…å¸¦ padding çš„è¾“å…¥å½±å“æ¨¡å‹è®­ç»ƒæ•ˆæœï¼Œé€šè¿‡ pack_padded_sequence å¾—åˆ°å¤„ç†è¿‡çš„å¼ é‡æ”¾è¿› LSTM æ¨¡å‹ï¼Œä»–å¯ä»¥åªå¤„ç†æœ‰æ•ˆæ•°æ®ï¼ŒèŠ‚çœè®¡ç®—ï¼Œå¹¶ä¸”è®© RNN å±‚åªçœ‹çœŸå®éƒ¨åˆ†ï¼Œè‡ªåŠ¨å¿½ç•¥ paddingã€‚ åŒå‘ LSTM æ¨¡å‹ä¼šè¿”å›ä¸‰ä¸ªå¼ é‡enc_hiddens, (last_hidden, last_cell) enc_hiddens æ˜¯åŒå‘ LSTM æ¯ä¸ªæ—¶åˆ»ä¸¤ä¸ªæ–¹å‘çš„éšè—çŠ¶æ€ï¼Œéœ€è¦é€šè¿‡ pad_packed_sequence è½¬ä¸º Tensorï¼Œå½¢çŠ¶ä¸º [SL, B, 2H]ï¼Œæœ€åè½¬ä¸º [B, SL, 2H] last_hidden å’Œ last_cell æ˜¯åŒå‘ LSTM æœ€åè¾“å‡ºçš„ä¸¤ä¸ªçŠ¶æ€å¼ é‡ï¼Œå½¢çŠ¶ä¸º [2, B, H] ç”±äº Encoder æ˜¯åŒå‘ LSTMï¼Œforward LSTM å’Œ backward LSTM ä¼šåˆ†åˆ«è¿”å›ä¸€ä¸ªéšè—çŠ¶æ€å‘é‡å’Œç»†èƒå‘é‡ï¼Œæ‰€ä»¥å½¢çŠ¶æ˜¯ [2, B, H]ã€‚ä½†æ˜¯ Decoder æ˜¯ä¸€ä¸ªå•å‘ LSTMï¼Œæ‰€ä»¥å®ƒçš„éšè—çŠ¶æ€å‘é‡å’Œç»†èƒå‘é‡å½¢çŠ¶ä¸º [B, H]ã€‚è§£å†³åŠæ³•å°±æ˜¯æŠŠ2ä¸ªå‘é‡åœ¨ç¬¬äºŒä¸ªç»´åº¦æ‹¼æ¥ä¸º [B, 2*H]ã€‚ Q:ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·ç§¯ï¼Ÿ A:å› ä¸ºè¯å‘é‡æ˜¯é€è¯çš„ï¼Œæ¯ä¸ª token å¯¹åº”çš„ embedding åªåŒ…å«å®ƒè‡ªå·±çš„ä¿¡æ¯ï¼Œä¸åŒ token ç»„åˆèµ·æ¥æœ‰ä¸åŒçš„å«ä¹‰ã€‚å†è¯åµŒå…¥å’Œ LSTM ä¹‹é—´åŠ å…¥å·ç§¯å±‚ï¼Œå¯ä»¥è®©æ¨¡å‹æ›´å¥½çš„å­¦ä¹ è¾“å…¥æ–‡æœ¬çš„è¯­ä¹‰ä¿¡æ¯ã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:2:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#äºŒencode"},{"categories":null,"content":" äºŒã€Encodeç¼–ç å™¨çš„ä½œç”¨æ˜¯é€šè¿‡åŒå‘ LSTM è§£æåŸæ–‡æœ¬ï¼Œæ ¹æ®åŸæ–‡æœ¬çš„è¯­ä¹‰ä¿¡æ¯ç”Ÿæˆå‘é‡æä¾›ç»™è§£ç å™¨ç”Ÿæˆç›®æ ‡æ–‡æœ¬ã€‚ 1. å¡«å……æ–‡æœ¬ è¾“å…¥åˆ° NMT æ¨¡å‹çš„æ–‡æœ¬å½¢çŠ¶ä¸º [B, L]ï¼Œè¿™é‡Œçš„ L æŒ‡çš„æ˜¯è®­ç»ƒé›†æ¯æ¡è¯„è®ºä¸åŒçš„é•¿åº¦ã€‚ ç»è¿‡å¤„ç†ï¼Œè¿™äº›å¼ é‡ä¼šç»Ÿä¸€åˆ°ç›¸åŒçš„é•¿åº¦å¾—åˆ°åŸæ–‡æœ¬å¼ é‡ [SL, B]ï¼Œè¿™é‡Œçš„ SLæŒ‡çš„æ˜¯åŸæ–‡æœ¬æœ€å¤§é•¿åº¦ã€‚ Q:ä¸ºä»€ä¹ˆè¾“å…¥å¼ é‡çš„å½¢çŠ¶æ˜¯ [SL, B]ï¼Œé€šå¸¸ä¸éƒ½æ˜¯ [B, SL] å—ï¼Ÿ A:å› ä¸º PyTorch ä¸­ï¼ŒLSTM æ¨¡å‹é»˜è®¤ batch_first=Falseï¼Œä¹Ÿå°±æ˜¯è¦æ±‚è¾“å…¥æ ¼å¼ä¸º [L, B, embedding_dim]ï¼Œè€Œè®­ç»ƒæ•°æ®é€šå¸¸æ˜¯ [B, L]ï¼Œæ‰€ä»¥å¿…é¡»è½¬æˆ [L, B]ã€‚å‡å¦‚è®¾ç½®äº† batch_first=Trueé‚£ä¹ˆå°±å¯ä»¥æ²¿ç”¨ä¹‹å‰çš„å½¢çŠ¶ [B, L]ã€‚ 2. è¯åµŒå…¥ NMT å†…éƒ¨ç»´æŠ¤ç€ä¸¤ä¸ªå¯è®­ç»ƒçš„ Embeddingï¼Œåˆ†åˆ«å¯¹åº”åŸæ–‡æœ¬å’Œç›®æ ‡æ–‡æœ¬ã€‚ å¯¹è¾“å…¥å¼ é‡è¿›è¡Œè¯åµŒå…¥ä¹‹åï¼Œå½¢çŠ¶ä» [SL, B] å˜æˆ [SL, B, E] ç”±äºè¦å¯¹å¼ é‡è¿›è¡Œå·ç§¯æ“ä½œï¼Œéœ€è¦å…ˆå˜å½¢ä¸º [B, E, SL] å†å˜å› [SL, B, E] ä¸ºäº†é¿å…å¸¦ padding çš„è¾“å…¥å½±å“æ¨¡å‹è®­ç»ƒæ•ˆæœï¼Œé€šè¿‡ pack_padded_sequence å¾—åˆ°å¤„ç†è¿‡çš„å¼ é‡æ”¾è¿› LSTM æ¨¡å‹ï¼Œä»–å¯ä»¥åªå¤„ç†æœ‰æ•ˆæ•°æ®ï¼ŒèŠ‚çœè®¡ç®—ï¼Œå¹¶ä¸”è®© RNN å±‚åªçœ‹çœŸå®éƒ¨åˆ†ï¼Œè‡ªåŠ¨å¿½ç•¥ paddingã€‚ åŒå‘ LSTM æ¨¡å‹ä¼šè¿”å›ä¸‰ä¸ªå¼ é‡enc_hiddens, (last_hidden, last_cell) enc_hiddens æ˜¯åŒå‘ LSTM æ¯ä¸ªæ—¶åˆ»ä¸¤ä¸ªæ–¹å‘çš„éšè—çŠ¶æ€ï¼Œéœ€è¦é€šè¿‡ pad_packed_sequence è½¬ä¸º Tensorï¼Œå½¢çŠ¶ä¸º [SL, B, 2H]ï¼Œæœ€åè½¬ä¸º [B, SL, 2H] last_hidden å’Œ last_cell æ˜¯åŒå‘ LSTM æœ€åè¾“å‡ºçš„ä¸¤ä¸ªçŠ¶æ€å¼ é‡ï¼Œå½¢çŠ¶ä¸º [2, B, H] ç”±äº Encoder æ˜¯åŒå‘ LSTMï¼Œforward LSTM å’Œ backward LSTM ä¼šåˆ†åˆ«è¿”å›ä¸€ä¸ªéšè—çŠ¶æ€å‘é‡å’Œç»†èƒå‘é‡ï¼Œæ‰€ä»¥å½¢çŠ¶æ˜¯ [2, B, H]ã€‚ä½†æ˜¯ Decoder æ˜¯ä¸€ä¸ªå•å‘ LSTMï¼Œæ‰€ä»¥å®ƒçš„éšè—çŠ¶æ€å‘é‡å’Œç»†èƒå‘é‡å½¢çŠ¶ä¸º [B, H]ã€‚è§£å†³åŠæ³•å°±æ˜¯æŠŠ2ä¸ªå‘é‡åœ¨ç¬¬äºŒä¸ªç»´åº¦æ‹¼æ¥ä¸º [B, 2*H]ã€‚ Q:ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·ç§¯ï¼Ÿ A:å› ä¸ºè¯å‘é‡æ˜¯é€è¯çš„ï¼Œæ¯ä¸ª token å¯¹åº”çš„ embedding åªåŒ…å«å®ƒè‡ªå·±çš„ä¿¡æ¯ï¼Œä¸åŒ token ç»„åˆèµ·æ¥æœ‰ä¸åŒçš„å«ä¹‰ã€‚å†è¯åµŒå…¥å’Œ LSTM ä¹‹é—´åŠ å…¥å·ç§¯å±‚ï¼Œå¯ä»¥è®©æ¨¡å‹æ›´å¥½çš„å­¦ä¹ è¾“å…¥æ–‡æœ¬çš„è¯­ä¹‰ä¿¡æ¯ã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:2:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#1-å¡«å……æ–‡æœ¬"},{"categories":null,"content":" äºŒã€Encodeç¼–ç å™¨çš„ä½œç”¨æ˜¯é€šè¿‡åŒå‘ LSTM è§£æåŸæ–‡æœ¬ï¼Œæ ¹æ®åŸæ–‡æœ¬çš„è¯­ä¹‰ä¿¡æ¯ç”Ÿæˆå‘é‡æä¾›ç»™è§£ç å™¨ç”Ÿæˆç›®æ ‡æ–‡æœ¬ã€‚ 1. å¡«å……æ–‡æœ¬ è¾“å…¥åˆ° NMT æ¨¡å‹çš„æ–‡æœ¬å½¢çŠ¶ä¸º [B, L]ï¼Œè¿™é‡Œçš„ L æŒ‡çš„æ˜¯è®­ç»ƒé›†æ¯æ¡è¯„è®ºä¸åŒçš„é•¿åº¦ã€‚ ç»è¿‡å¤„ç†ï¼Œè¿™äº›å¼ é‡ä¼šç»Ÿä¸€åˆ°ç›¸åŒçš„é•¿åº¦å¾—åˆ°åŸæ–‡æœ¬å¼ é‡ [SL, B]ï¼Œè¿™é‡Œçš„ SLæŒ‡çš„æ˜¯åŸæ–‡æœ¬æœ€å¤§é•¿åº¦ã€‚ Q:ä¸ºä»€ä¹ˆè¾“å…¥å¼ é‡çš„å½¢çŠ¶æ˜¯ [SL, B]ï¼Œé€šå¸¸ä¸éƒ½æ˜¯ [B, SL] å—ï¼Ÿ A:å› ä¸º PyTorch ä¸­ï¼ŒLSTM æ¨¡å‹é»˜è®¤ batch_first=Falseï¼Œä¹Ÿå°±æ˜¯è¦æ±‚è¾“å…¥æ ¼å¼ä¸º [L, B, embedding_dim]ï¼Œè€Œè®­ç»ƒæ•°æ®é€šå¸¸æ˜¯ [B, L]ï¼Œæ‰€ä»¥å¿…é¡»è½¬æˆ [L, B]ã€‚å‡å¦‚è®¾ç½®äº† batch_first=Trueé‚£ä¹ˆå°±å¯ä»¥æ²¿ç”¨ä¹‹å‰çš„å½¢çŠ¶ [B, L]ã€‚ 2. è¯åµŒå…¥ NMT å†…éƒ¨ç»´æŠ¤ç€ä¸¤ä¸ªå¯è®­ç»ƒçš„ Embeddingï¼Œåˆ†åˆ«å¯¹åº”åŸæ–‡æœ¬å’Œç›®æ ‡æ–‡æœ¬ã€‚ å¯¹è¾“å…¥å¼ é‡è¿›è¡Œè¯åµŒå…¥ä¹‹åï¼Œå½¢çŠ¶ä» [SL, B] å˜æˆ [SL, B, E] ç”±äºè¦å¯¹å¼ é‡è¿›è¡Œå·ç§¯æ“ä½œï¼Œéœ€è¦å…ˆå˜å½¢ä¸º [B, E, SL] å†å˜å› [SL, B, E] ä¸ºäº†é¿å…å¸¦ padding çš„è¾“å…¥å½±å“æ¨¡å‹è®­ç»ƒæ•ˆæœï¼Œé€šè¿‡ pack_padded_sequence å¾—åˆ°å¤„ç†è¿‡çš„å¼ é‡æ”¾è¿› LSTM æ¨¡å‹ï¼Œä»–å¯ä»¥åªå¤„ç†æœ‰æ•ˆæ•°æ®ï¼ŒèŠ‚çœè®¡ç®—ï¼Œå¹¶ä¸”è®© RNN å±‚åªçœ‹çœŸå®éƒ¨åˆ†ï¼Œè‡ªåŠ¨å¿½ç•¥ paddingã€‚ åŒå‘ LSTM æ¨¡å‹ä¼šè¿”å›ä¸‰ä¸ªå¼ é‡enc_hiddens, (last_hidden, last_cell) enc_hiddens æ˜¯åŒå‘ LSTM æ¯ä¸ªæ—¶åˆ»ä¸¤ä¸ªæ–¹å‘çš„éšè—çŠ¶æ€ï¼Œéœ€è¦é€šè¿‡ pad_packed_sequence è½¬ä¸º Tensorï¼Œå½¢çŠ¶ä¸º [SL, B, 2H]ï¼Œæœ€åè½¬ä¸º [B, SL, 2H] last_hidden å’Œ last_cell æ˜¯åŒå‘ LSTM æœ€åè¾“å‡ºçš„ä¸¤ä¸ªçŠ¶æ€å¼ é‡ï¼Œå½¢çŠ¶ä¸º [2, B, H] ç”±äº Encoder æ˜¯åŒå‘ LSTMï¼Œforward LSTM å’Œ backward LSTM ä¼šåˆ†åˆ«è¿”å›ä¸€ä¸ªéšè—çŠ¶æ€å‘é‡å’Œç»†èƒå‘é‡ï¼Œæ‰€ä»¥å½¢çŠ¶æ˜¯ [2, B, H]ã€‚ä½†æ˜¯ Decoder æ˜¯ä¸€ä¸ªå•å‘ LSTMï¼Œæ‰€ä»¥å®ƒçš„éšè—çŠ¶æ€å‘é‡å’Œç»†èƒå‘é‡å½¢çŠ¶ä¸º [B, H]ã€‚è§£å†³åŠæ³•å°±æ˜¯æŠŠ2ä¸ªå‘é‡åœ¨ç¬¬äºŒä¸ªç»´åº¦æ‹¼æ¥ä¸º [B, 2*H]ã€‚ Q:ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·ç§¯ï¼Ÿ A:å› ä¸ºè¯å‘é‡æ˜¯é€è¯çš„ï¼Œæ¯ä¸ª token å¯¹åº”çš„ embedding åªåŒ…å«å®ƒè‡ªå·±çš„ä¿¡æ¯ï¼Œä¸åŒ token ç»„åˆèµ·æ¥æœ‰ä¸åŒçš„å«ä¹‰ã€‚å†è¯åµŒå…¥å’Œ LSTM ä¹‹é—´åŠ å…¥å·ç§¯å±‚ï¼Œå¯ä»¥è®©æ¨¡å‹æ›´å¥½çš„å­¦ä¹ è¾“å…¥æ–‡æœ¬çš„è¯­ä¹‰ä¿¡æ¯ã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:2:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#2-è¯åµŒå…¥"},{"categories":null,"content":" ä¸‰ã€Decodeè§£ç å™¨ä¹Ÿé‡‡ç”¨äº† LSTM æ¨¡å‹ï¼Œä½†ç›®çš„ä¸åƒ Encode éƒ¨åˆ†ä¸€æ ·æ˜¯ä¸ºäº†å¾—åˆ°éšè—çŠ¶æ€å‘é‡ï¼Œæ‰€ä»¥æ²¡æœ‰ç”¨ nn.LSTM è€Œç”¨äº† nn.LSTMCellï¼Œé€šè¿‡æ‰‹åŠ¨ for å¾ªç¯ä¸€æ­¥æ­¥è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ã€‚ ç”±äº enc_hiddens çš„å½¢çŠ¶æ˜¯ [B, SL, 2*H]ï¼Œæ‰€ä»¥éœ€è¦å¯¹å®ƒåšä¸€æ¬¡çº¿æ€§å˜æ¢å˜æˆ [B, SL, H] å¯¹ç›®æ ‡æ–‡æœ¬è¿›è¡Œè¯åµŒå…¥ä¹‹åå¾—åˆ° Yï¼Œå½¢çŠ¶ä¹Ÿæ˜¯ [TL, B, E]ã€‚ æ²¿ç€ Y çš„ç¬¬ä¸€ç»´éå† Yï¼Œèƒ½å¾—åˆ°æ¯ä¸ªæ—¶åˆ»å‘é‡ y_tï¼Œå½¢çŠ¶ä¸º[B, E]ã€‚ o_prev æ˜¯ Encoder ä¸Šä¸€ä¸ªæ—¶é—´æ­¥çš„éšè—çŠ¶æ€ï¼Œæˆ–è€…å¯ä»¥è¯´æ˜¯ç»¼åˆè€ƒé‡æ³¨æ„åŠ›åˆ†æ•°å’Œæ­£ç¡®ç­”æ¡ˆå¾—åˆ°çš„éšè—çŠ¶æ€ï¼Œå½¢çŠ¶ä¹Ÿæ˜¯ [B, H] æ¯ä¸€ä¸ªæ—¶é—´æ­¥ Decode åšçš„äº‹æƒ…åŒ…æ‹¬ï¼š å°† y_t å’Œ o_prev è£å‰ªä¸º [B, E+H] è¾“å…¥åˆ° Decode çš„å•å‘ LSTMï¼Œå¾—åˆ° dec_hidden, dec_cell, å½¢çŠ¶ä¸º [B, H] é€šè¿‡çŸ©é˜µä¹˜æ³•ï¼Œå°† enc_hiddens_proj [B, SL, H] å’Œ dec_hidden.unsequeeze(2) [B, H, 1] ç›¸ä¹˜ï¼Œå¾—åˆ°æ³¨æ„åŠ›åˆ†æ•° [B, SL, 1] å†å˜å½¢ä¸º [B, SL]ï¼Œå…¶ä¸­ç¬¬äºŒç»´æ¯ä¸€ä¸ªå…ƒç´ å°±ä»£è¡¨æ¯ä¸ª token å’Œå½“å‰çš„åŒ¹é…åº¦ã€‚ ç”±äºé€šè¿‡ padding å°†æ–‡æœ¬é•¿åº¦è¡¥é½åˆ° SLï¼Œæ‰€ä»¥éœ€è¦æŠŠ padding éƒ¨åˆ†çš„ score é™åˆ°è´Ÿæ— ç©·ï¼Œä¸ä¼šå½±å“ä¸Šä¸‹æ–‡ã€‚ Softmax å¾—åˆ°æ³¨æ„åŠ›æƒé‡ alpha_tï¼Œè¡¨ç¤ºåœ¨ç”Ÿæˆå½“å‰ç›®æ ‡è¯æ—¶ï¼Œæºå¥ token å¯¹ç»“æœçš„é‡è¦æ€§ã€‚ çŸ©é˜µä¹˜æ³•ï¼Œå°† alpha_t.unsqueeze(1) [B, 1, SL] å’Œ enc_hiddens [B, SL, 2H] ç›¸ä¹˜ï¼Œå¾—åˆ°æ³¨æ„åŠ›åˆ†æ•° [B, 1, 2H] å†å˜å½¢ä¸º [B, 2H]ã€‚ æœ€åå°† decoder çš„éšè—çŠ¶æ€å¼ é‡å’Œ ä¸Šä¸‹æ–‡å‘é‡ a_t æ‹¼æ¥å¾—åˆ° U_t [B, 3H]ï¼Œç»è¿‡çº¿æ€§å˜æ¢æœ€åå¾—åˆ° [B, H] çš„å¼ é‡ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥çš„ o_prev ä¸Šä¸€æ­¥å¾—åˆ°æ³¨æ„åŠ›åˆ†æ•°åªæ˜¯å‘Šè¯‰æ¨¡å‹â€œåœ¨æºå¥çš„æ¯ä¸ªä½ç½®ä¸Šï¼Œæˆ‘è¯¥å…³æ³¨å¤šå°‘ï¼Ÿâ€ã€‚å®ƒåªæ˜¯æƒé‡ï¼Œä¸èƒ½ç›´æ¥ç”¨äºç”Ÿæˆè¯æˆ–æ›´æ–° decoderã€‚è€Œ a_t å®ƒæ˜¯ä¸€ä¸ªçœŸæ­£çš„å‘é‡è¡¨ç¤ºï¼ŒåŒ…å«ä½ â€œå…³æ³¨çš„ä½ç½®åˆæˆå‡ºæ¥çš„è¯­ä¹‰ä¸ä¸Šä¸‹æ–‡ä¿¡æ¯â€ã€‚decoder éœ€è¦ è¿™ä¸ªè¯­ä¹‰å‘é‡ æ¥å†³å®šä¸‹ä¸€æ­¥è¦è¾“å‡ºä»€ä¹ˆè¯ã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:2:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#ä¸‰decode"},{"categories":null,"content":" å››ã€æœ€åå¤„ç†æœ€å decoder ä¼šè¿”å›ä¸€ä¸ª [SL, B, H] çš„å¼ é‡ï¼Œç¿»è¯‘æˆ–è€…è¯´å•è¯é¢„æµ‹ä¹Ÿæ˜¯ä¸€ä¸ªå¤šåˆ†ç±»é—®é¢˜ï¼Œæ‰€ä»¥è¿˜éœ€è¦é€šè¿‡çº¿æ€§å˜æ¢å°† [SL, B, H] å˜ä¸º [SL, B, E] å†åš softmaxï¼Œå…¶ä¸­ [a, b, c] ä»£è¡¨ç¬¬ b ä¸ªå¥å­ä¸­ç¬¬ a ä¸ª token æ˜¯ vocal[c] çš„å¯èƒ½æ€§ã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:2:4","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#å››æœ€åå¤„ç†"},{"categories":null,"content":" è®­ç»ƒè¿‡ç¨‹","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#è®­ç»ƒè¿‡ç¨‹"},{"categories":null,"content":" ä¸€ã€æŸå¤±è®¡ç®— 1. è´Ÿå¯¹æ•°ä¼¼ç„¶æœºå™¨ç¿»è¯‘çš„æœ¬è´¨ç»™å®šæºå¥å­â€œæˆ‘çˆ±ä½ â€ï¼Œè®©æ¨¡å‹å­¦ä¼šè¾“å‡ºç›®æ ‡å¥å­â€œI love youâ€ã€‚æˆ–è€…è¯´æˆ‘ä»¬å¸Œæœ›æ¨¡å‹å­¦ä¼šæ¡ä»¶æ¦‚ç‡åˆ†å¸ƒï¼š$p(y | x) = p(I love you | æˆ‘çˆ±ä½ )$ï¼Œæ¦‚ç‡è¶Šå¤§è¶Šå¥½ã€‚å‡è®¾æˆ‘ä»¬æœ‰ N ä¸ªå¹³è¡Œå¥å¯¹è®­ç»ƒæ ·æœ¬ï¼Œé‚£ä¹ˆå¸Œæœ›æ‰¾åˆ°ä¸€ç»„è¶…å‚æ•° Î¸ï¼Œè®©æ‰€æœ‰è®­ç»ƒæ ·æœ¬å‡ºç°çš„è”åˆæ¦‚ç‡æœ€å¤§ï¼š Î¸âˆ—=argmaxÎ¸âˆi=1Np(yiâˆ£xi;Î¸) \\theta^{*} = argmax_{\\theta}\\prod_{i=1}^{N}p(y^{i}|x^{i};\\theta) Î¸âˆ—=argmaxÎ¸â€‹i=1âˆNâ€‹p(yiâˆ£xi;Î¸)ä¸ºäº†æ–¹ä¾¿è®¡ç®—å¯¹å…¶å–å¯¹æ•°ï¼š Î¸âˆ—=argmaxÎ¸âˆ‘i=1Nlogâ¡p(yiâˆ£xi;Î¸) \\theta^{*} = argmax_{\\theta}\\sum_{i=1}^{N}\\log{p(y^{i}|x^{i};\\theta)} Î¸âˆ—=argmaxÎ¸â€‹i=1âˆ‘Nâ€‹logp(yiâˆ£xi;Î¸)å› ä¸ºæ±‚æœ€å°å€¼æ¯”æ±‚æœ€å¤§å€¼å®¹æ˜“ï¼Œæ‰€ä»¥å–è´Ÿæ•°ï¼š Î¸âˆ—=argminÎ¸âˆ‘i=1Nâˆ’logâ¡p(yiâˆ£xi;Î¸) \\theta^{*} = argmin_{\\theta}\\sum_{i=1}^{N}-\\log{p(y^{i}|x^{i};\\theta)} Î¸âˆ—=argminÎ¸â€‹i=1âˆ‘Nâ€‹âˆ’logp(yiâˆ£xi;Î¸) å¯¹äºå•ä¸ªå¥å­è€Œè¨€æ˜¯å¦‚ä½•è®¡ç®—æ¦‚ç‡çš„å‘¢ï¼Ÿ æ ¹æ®æ¦‚ç‡å…¬å¼ï¼š p(yâˆ£x)=p(y1âˆ£\u003cs\u003e,x)Ã—p(y2âˆ£\u003cs\u003e,y1,x)Ã—â‹¯=âˆ‘t=1Tlogâ¡p(ytâˆ£y\u003ct,x) p(y|x)=p(y_1|\u003cs\u003e,x) \\times p(y_2|\u003cs\u003e,y_1,x) \\times \\dots = \\sum_{t=1}^{T}\\log{p(y_t|y_{\u003ct},x)} p(yâˆ£x)=p(y1â€‹âˆ£\u003cs\u003e,x)Ã—p(y2â€‹âˆ£\u003cs\u003e,y1â€‹,x)Ã—â‹¯=t=1âˆ‘Tâ€‹logp(ytâ€‹âˆ£y\u003ctâ€‹,x)NMT æ˜¯ä¸€ä¸ªå¤šåˆ†ç±»é—®é¢˜ï¼Œé‡‡ç”¨ softmax å¾—åˆ°æ¦‚ç‡åˆ†å¸ƒï¼š p(yt=kâˆ£y\u003ck,x)=exp(logitk)âˆ‘kâ€²exp(logiykâ€²) p(y_t=k|y_{\u003ck},x)=\\frac{exp(logit_k)}{\\sum_{k'}{exp(logiy_{k'})}} p(ytâ€‹=kâˆ£y\u003ckâ€‹,x)=âˆ‘kâ€²â€‹exp(logiykâ€²â€‹)exp(logitkâ€‹)â€‹ 2. å›°æƒ‘åº¦ Perpelxityå›°æƒ‘åº¦å°±æ˜¯å¯¹å¹³å‡è´Ÿå¯¹æ•°æŸå¤±åšæŒ‡æ•°ï¼š ppl=elosslen(token)=eâˆ’1Nâˆ‘i=1Nlogâ¡P(yi) ppl=e^{\\frac{loss}{len(token)}}=e^{-\\frac{1}{N}\\sum_{i=1}^{N}\\log{P(y_i)}} ppl=elen(token)lossâ€‹=eâˆ’N1â€‹âˆ‘i=1Nâ€‹logP(yiâ€‹)","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:3:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#ä¸€æŸå¤±è®¡ç®—"},{"categories":null,"content":" ä¸€ã€æŸå¤±è®¡ç®— 1. è´Ÿå¯¹æ•°ä¼¼ç„¶æœºå™¨ç¿»è¯‘çš„æœ¬è´¨ç»™å®šæºå¥å­â€œæˆ‘çˆ±ä½ â€ï¼Œè®©æ¨¡å‹å­¦ä¼šè¾“å‡ºç›®æ ‡å¥å­â€œI love youâ€ã€‚æˆ–è€…è¯´æˆ‘ä»¬å¸Œæœ›æ¨¡å‹å­¦ä¼šæ¡ä»¶æ¦‚ç‡åˆ†å¸ƒï¼š$p(y | x) = p(I love you | æˆ‘çˆ±ä½ )$ï¼Œæ¦‚ç‡è¶Šå¤§è¶Šå¥½ã€‚å‡è®¾æˆ‘ä»¬æœ‰ N ä¸ªå¹³è¡Œå¥å¯¹è®­ç»ƒæ ·æœ¬ï¼Œé‚£ä¹ˆå¸Œæœ›æ‰¾åˆ°ä¸€ç»„è¶…å‚æ•° Î¸ï¼Œè®©æ‰€æœ‰è®­ç»ƒæ ·æœ¬å‡ºç°çš„è”åˆæ¦‚ç‡æœ€å¤§ï¼š Î¸âˆ—=argmaxÎ¸âˆi=1Np(yiâˆ£xi;Î¸) \\theta^{*} = argmax_{\\theta}\\prod_{i=1}^{N}p(y^{i}|x^{i};\\theta) Î¸âˆ—=argmaxÎ¸â€‹i=1âˆNâ€‹p(yiâˆ£xi;Î¸)ä¸ºäº†æ–¹ä¾¿è®¡ç®—å¯¹å…¶å–å¯¹æ•°ï¼š Î¸âˆ—=argmaxÎ¸âˆ‘i=1Nlogâ¡p(yiâˆ£xi;Î¸) \\theta^{*} = argmax_{\\theta}\\sum_{i=1}^{N}\\log{p(y^{i}|x^{i};\\theta)} Î¸âˆ—=argmaxÎ¸â€‹i=1âˆ‘Nâ€‹logp(yiâˆ£xi;Î¸)å› ä¸ºæ±‚æœ€å°å€¼æ¯”æ±‚æœ€å¤§å€¼å®¹æ˜“ï¼Œæ‰€ä»¥å–è´Ÿæ•°ï¼š Î¸âˆ—=argminÎ¸âˆ‘i=1Nâˆ’logâ¡p(yiâˆ£xi;Î¸) \\theta^{*} = argmin_{\\theta}\\sum_{i=1}^{N}-\\log{p(y^{i}|x^{i};\\theta)} Î¸âˆ—=argminÎ¸â€‹i=1âˆ‘Nâ€‹âˆ’logp(yiâˆ£xi;Î¸) å¯¹äºå•ä¸ªå¥å­è€Œè¨€æ˜¯å¦‚ä½•è®¡ç®—æ¦‚ç‡çš„å‘¢ï¼Ÿ æ ¹æ®æ¦‚ç‡å…¬å¼ï¼š p(yâˆ£x)=p(y1âˆ£,x)Ã—p(y2âˆ£,y1,x)Ã—â‹¯=âˆ‘t=1Tlogâ¡p(ytâˆ£y,x) \\times p(y_2|,y_1,x) \\times \\dots = \\sum_{t=1}^{T}\\log{p(y_t|y_{,x)Ã—p(y2â€‹âˆ£,y1â€‹,x)Ã—â‹¯=t=1âˆ‘Tâ€‹logp(ytâ€‹âˆ£y","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:3:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#1-è´Ÿå¯¹æ•°ä¼¼ç„¶"},{"categories":null,"content":" ä¸€ã€æŸå¤±è®¡ç®— 1. è´Ÿå¯¹æ•°ä¼¼ç„¶æœºå™¨ç¿»è¯‘çš„æœ¬è´¨ç»™å®šæºå¥å­â€œæˆ‘çˆ±ä½ â€ï¼Œè®©æ¨¡å‹å­¦ä¼šè¾“å‡ºç›®æ ‡å¥å­â€œI love youâ€ã€‚æˆ–è€…è¯´æˆ‘ä»¬å¸Œæœ›æ¨¡å‹å­¦ä¼šæ¡ä»¶æ¦‚ç‡åˆ†å¸ƒï¼š$p(y | x) = p(I love you | æˆ‘çˆ±ä½ )$ï¼Œæ¦‚ç‡è¶Šå¤§è¶Šå¥½ã€‚å‡è®¾æˆ‘ä»¬æœ‰ N ä¸ªå¹³è¡Œå¥å¯¹è®­ç»ƒæ ·æœ¬ï¼Œé‚£ä¹ˆå¸Œæœ›æ‰¾åˆ°ä¸€ç»„è¶…å‚æ•° Î¸ï¼Œè®©æ‰€æœ‰è®­ç»ƒæ ·æœ¬å‡ºç°çš„è”åˆæ¦‚ç‡æœ€å¤§ï¼š Î¸âˆ—=argmaxÎ¸âˆi=1Np(yiâˆ£xi;Î¸) \\theta^{*} = argmax_{\\theta}\\prod_{i=1}^{N}p(y^{i}|x^{i};\\theta) Î¸âˆ—=argmaxÎ¸â€‹i=1âˆNâ€‹p(yiâˆ£xi;Î¸)ä¸ºäº†æ–¹ä¾¿è®¡ç®—å¯¹å…¶å–å¯¹æ•°ï¼š Î¸âˆ—=argmaxÎ¸âˆ‘i=1Nlogâ¡p(yiâˆ£xi;Î¸) \\theta^{*} = argmax_{\\theta}\\sum_{i=1}^{N}\\log{p(y^{i}|x^{i};\\theta)} Î¸âˆ—=argmaxÎ¸â€‹i=1âˆ‘Nâ€‹logp(yiâˆ£xi;Î¸)å› ä¸ºæ±‚æœ€å°å€¼æ¯”æ±‚æœ€å¤§å€¼å®¹æ˜“ï¼Œæ‰€ä»¥å–è´Ÿæ•°ï¼š Î¸âˆ—=argminÎ¸âˆ‘i=1Nâˆ’logâ¡p(yiâˆ£xi;Î¸) \\theta^{*} = argmin_{\\theta}\\sum_{i=1}^{N}-\\log{p(y^{i}|x^{i};\\theta)} Î¸âˆ—=argminÎ¸â€‹i=1âˆ‘Nâ€‹âˆ’logp(yiâˆ£xi;Î¸) å¯¹äºå•ä¸ªå¥å­è€Œè¨€æ˜¯å¦‚ä½•è®¡ç®—æ¦‚ç‡çš„å‘¢ï¼Ÿ æ ¹æ®æ¦‚ç‡å…¬å¼ï¼š p(yâˆ£x)=p(y1âˆ£,x)Ã—p(y2âˆ£,y1,x)Ã—â‹¯=âˆ‘t=1Tlogâ¡p(ytâˆ£y,x) \\times p(y_2|,y_1,x) \\times \\dots = \\sum_{t=1}^{T}\\log{p(y_t|y_{,x)Ã—p(y2â€‹âˆ£,y1â€‹,x)Ã—â‹¯=t=1âˆ‘Tâ€‹logp(ytâ€‹âˆ£y","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:3:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#2-å›°æƒ‘åº¦-perpelxity"},{"categories":null,"content":" äºŒã€æ—©åœæœºåˆ¶æ—©åœæœºåˆ¶å¯ä»¥æœ‰æ•ˆçš„é¿å…æ¨¡å‹è¿›è¡Œæ— æ•ˆè®­ç»ƒæˆ–è€…é™·å…¥è¿‡æ‹Ÿåˆï¼š å¦‚æœå½“å‰å›°æƒ‘åº¦æœ€ä½ï¼Œé‚£ä¹ˆ patience æ¸…é›¶å¹¶ä¸”ä¿å­˜æ¨¡å‹ å¦åˆ™ patience++ å¦‚æœ patience è¾¾åˆ°ä¸Šé™åˆ™è§¦å‘ trialï¼Œå­¦ä¹ ç‡ä¸‹é™å¹¶ä¸”ä»ä¸Šä¸€ä¸ª checkpoint é‡æ–°åŠ è½½æ¨¡å‹å’Œä¼˜åŒ–å™¨ï¼Œå½“trial åˆ°è¾¾ä¸Šé™åˆ™æ—©åœé€€å‡ºã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:3:2","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#äºŒæ—©åœæœºåˆ¶"},{"categories":null,"content":" ä¸‰ã€BLEU åˆ†æ•°BLEU æ˜¯å¸¸ç”¨çš„â€œè‡ªåŠ¨è¯„ç¿»è¯‘å¥½ä¸å¥½â€çš„æŒ‡æ ‡ï¼Œæ­¥éª¤æ˜¯ï¼š ç®—â€œn-gram ç²¾åº¦â€ï¼ˆæ¯”å¦‚ 1-gram æ˜¯å•ä¸ªè¯çš„åŒ¹é…åº¦ï¼Œ2-gram æ˜¯ä¸¤ä¸ªè¯è¿èµ·æ¥çš„åŒ¹é…åº¦ï¼Œæ¯”å¦‚â€œadequate resourcesâ€åœ¨å‚è€ƒç¿»è¯‘é‡Œæœ‰æ²¡æœ‰ï¼‰ï¼› ç®—â€œ brevity penaltyï¼ˆç®€çŸ­æƒ©ç½šï¼‰â€ï¼šå¦‚æœæ¨¡å‹ç¿»è¯‘å¤ªçŸ­ï¼ˆæ¯”å¦‚å‚è€ƒå¥ 10 ä¸ªè¯ï¼Œæ¨¡å‹åªç¿» 5 ä¸ªï¼‰ï¼Œä¼šæ‰£åˆ†é¡¹ï¼› æŠŠç²¾åº¦ã€æƒ©ç½šç»“åˆèµ·æ¥ï¼Œç®—æœ€ç»ˆ BLEU åˆ†ï¼ˆ0-1 ä¹‹é—´ï¼Œè¶Šé«˜è¶Šå¥½ï¼‰ã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:3:3","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#ä¸‰bleu-åˆ†æ•°"},{"categories":null,"content":" å››ã€åˆ†æ beam searchbeam search æ˜¯â€œè®©æ¨¡å‹ç”Ÿæˆæ›´å¥½ç¿»è¯‘â€çš„æ–¹æ³•ï¼Œè®­ç»ƒæ—¶ä¼šè®°å½•ä¸åŒè¿­ä»£æ¬¡æ•°çš„ç¿»è¯‘ç»“æœï¼ˆæ¯”å¦‚ç¬¬ 200 æ¬¡ã€ç¬¬ 3000 æ¬¡è¿­ä»£ï¼‰ï¼Œè¦åšä¸¤ä»¶äº‹ï¼š çœ‹ç¿»è¯‘è´¨é‡æœ‰æ²¡æœ‰éšè¿­ä»£æå‡ï¼ˆæ¯”å¦‚ç¬¬ 200 æ¬¡ç¿»å¾—ä¸é€šé¡ºï¼Œç¬¬ 3000 æ¬¡æ¥è¿‘å‚è€ƒç¿»è¯‘ï¼‰ï¼› åˆ†æåŒä¸€è¿­ä»£ä¸‹ï¼Œbeam search ç”Ÿæˆçš„å¤šä¸ªå€™é€‰ç¿»è¯‘ï¼ˆæ¯”å¦‚ 10 ä¸ªå€™é€‰ï¼‰æœ‰ä»€ä¹ˆå·®åˆ«ï¼ˆæ¯”å¦‚æœ‰çš„å€™é€‰å¤šäº†ä¸ªâ€œtheâ€ï¼Œæœ‰çš„å°‘äº†ä¸ªâ€œandâ€ï¼‰ã€‚ ","date":"2025-11-20","objectID":"/posts/cs224n-assignment3/:3:4","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Assignment 3","uri":"/posts/cs224n-assignment3/#å››åˆ†æ-beam-search"},{"categories":null,"content":" åœ¨ CS224N çš„è¯¾ç¨‹ä¸­å­¦ä¹ äº† RNN çš„åŸºæœ¬çŸ¥è¯†ï¼Œä¸ºäº†æ·±å…¥äº†è§£èƒŒåçš„æœºåˆ¶å’Œä»£ç å®ç°ï¼Œæˆ‘è®© GPT è®¾è®¡äº†ä¸€ä¸ª RNN ç›¸å…³çš„æ·±åº¦å­¦ä¹ ä»»åŠ¡ï¼Œé€šè¿‡ PyTorch æ‰‹æ“ä¸€ä¸ª RNN ç½‘ç»œã€‚ ","date":"2025-11-19","objectID":"/posts/rnn/:0:0","series":["DeepLearning"],"tags":["Module","æ·±åº¦å­¦ä¹ "],"title":"RNN","uri":"/posts/rnn/#"},{"categories":null,"content":" å®éªŒé¢˜ç›®ä½¿ç”¨ RNN å®ç°è‹±æ–‡å­—æ¯åºåˆ—é¢„æµ‹ä»»åŠ¡ï¼ˆCharacter-Level Sequence Predictionï¼‰ ","date":"2025-11-19","objectID":"/posts/rnn/:1:0","series":["DeepLearning"],"tags":["Module","æ·±åº¦å­¦ä¹ "],"title":"RNN","uri":"/posts/rnn/#å®éªŒé¢˜ç›®"},{"categories":null,"content":" å®éªŒç›®æ ‡ ç†è§£ RNN çš„ç»“æ„å’Œå‰å‘ä¼ æ’­æœºåˆ¶ã€‚ æŒæ¡ç”¨ PyTorch æ„å»ºå’Œè®­ç»ƒå¾ªç¯ç¥ç»ç½‘ç»œçš„è¿‡ç¨‹ã€‚ å­¦ä¼šå°†åºåˆ—æ•°æ®è½¬åŒ–ä¸ºæ¨¡å‹å¯ä»¥å¤„ç†çš„å¼ é‡å½¢å¼ã€‚ è§‚å¯Ÿ RNN åœ¨å­¦ä¹ åºåˆ—æ¨¡å¼ï¼ˆå¦‚å­—æ¯é¡ºåºï¼‰æ—¶çš„è¡¨ç°ã€‚ ","date":"2025-11-19","objectID":"/posts/rnn/:2:0","series":["DeepLearning"],"tags":["Module","æ·±åº¦å­¦ä¹ "],"title":"RNN","uri":"/posts/rnn/#å®éªŒç›®æ ‡"},{"categories":null,"content":" å®éªŒå†…å®¹è®©æ¨¡å‹å­¦ä¹ è‹±æ–‡å­—æ¯åºåˆ—ï¼ˆå¦‚ â€œabcdeâ€¦zâ€ï¼‰ï¼Œç„¶åé¢„æµ‹ä¸‹ä¸€ä¸ªå­—æ¯ã€‚ ä¾‹å¦‚è¾“å…¥ a, b, c, d, eï¼Œç›®æ ‡è¾“å‡º b, c, d, e, fã€‚è®­ç»ƒå®Œæˆåï¼Œè¾“å…¥ â€˜aâ€™ï¼Œæ¨¡å‹åº”è¯¥èƒ½è¾“å‡º â€˜bâ€™ï¼›è¾“å…¥ â€™mâ€™ï¼Œè¾“å‡º â€™nâ€™ã€‚ ","date":"2025-11-19","objectID":"/posts/rnn/:3:0","series":["DeepLearning"],"tags":["Module","æ·±åº¦å­¦ä¹ "],"title":"RNN","uri":"/posts/rnn/#å®éªŒå†…å®¹"},{"categories":null,"content":" å®éªŒè¿‡ç¨‹1. æ•´ä½“æ€è·¯ å°†è¾“å…¥åºåˆ—è½¬ä¸º 0-25 çš„æ•´å‹æ•°ç»„ä¼ å…¥æ¨¡å‹ æ¨¡å‹å†…éƒ¨é€šè¿‡ embedding-lookup æŸ¥æ‰¾åˆ°å¯¹åº”çš„ one-hot å‘é‡ï¼Œä¾‹å¦‚ a å¯¹åº” [0,0,0,â€¦,0,1] é€šè¿‡ RNN æ¨¡å‹è¿›è¡Œè®­ç»ƒ 2. nn.Module æ¨¡å‹å…·ä½“è®¾è®¡éµå¾ª RNN çš„å˜åŒ–å…¬å¼ï¼š ht=tanh(Wxâ‹…xt+Whâ‹…htâˆ’1+bh) h_t=tanh(Wx \\cdot x_t + W_h \\cdot h_{t-1} + b_h) htâ€‹=tanh(Wxâ‹…xtâ€‹+Whâ€‹â‹…htâˆ’1â€‹+bhâ€‹)æ¨¡å‹çš„å‚æ•°å¦‚ä¸‹ï¼ŒçŸ©é˜µå½¢çŠ¶éœ€è¦æ³¨æ„ï¼šåœ¨ PyTorch ä¸­è®¡ç®—æ—¶å€™æ˜¯ $x \\cdot W$ è€Œä¸æ˜¯ $W \\cdot x$ python class RNN(torch.nn.Module): def __init__( self, embeddings, embed_size, hidden_size, output_size ) -\u003e None: super().__init__() self.embeddings = embeddings self.hidden_size = hidden_size # xt = [batch_size, seq_len * embed_size] # Wx = [seq_len * embed_size, hidden_size] # Wh = [batch_size, hidden_size] self.embed_to_hidden_weight = torch.nn.Parameter(torch.empty(embed_size, hidden_size)) torch.nn.init.xavier_uniform_(self.embed_to_hidden_weight) self.hidden_to_logits_weight = torch.nn.Parameter(torch.empty(hidden_size, output_size)) torch.nn.init.xavier_uniform_(self.hidden_to_logits_weight) self.last_to_new_weight = torch.nn.Parameter(torch.empty(hidden_size, hidden_size)) torch.nn.init.xavier_uniform_(self.last_to_new_weight) embed_to_hidden_bias_tensor = torch.empty(hidden_size) torch.nn.init.uniform_(embed_to_hidden_bias_tensor) self.embed_to_hidden_bias = torch.nn.Parameter(embed_to_hidden_bias_tensor) hidden_to_logits_bias_tensor = torch.empty(output_size) torch.nn.init.uniform_(hidden_to_logits_bias_tensor) self.hidden_to_logits_bias = torch.nn.Parameter(hidden_to_logits_bias_tensor) embedding_lookup çš„è®¾è®¡æˆ‘å‚è€ƒçš„ cs224n çš„è¯å‘é‡åµŒå…¥ï¼Œç”±äº RNN æ¨¡å‹ä¸­å¾ªç¯çš„ç‰¹æ€§ï¼Œæ¯æ¬¡éœ€è¦å–å‡ºå½“å‰ batch çš„ä¸€ä¸ªè¯å‘é‡ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰æŠŠå®ƒå±•å¹³æˆäºŒç»´ã€‚ python def embedding_lookup(self, w): # [batch_size, seq_len] -\u003e [batch_size, seq_len, embed_size] return self.embeddings[w] å‰é¦ˆè®¡ç®—çš„ä»£ç å…¶å®å°±æ˜¯å®ç°å…¬å¼äº†ï¼Œè¿™é‡Œç”¨ torch ä¸­çš„å¼ é‡ç´¢å¼• [:, i: ,] å¯ä»¥å¾ˆå®¹æ˜“å¾—åˆ° batch_size å¤§å°çš„ç¬¬ i ä¸ªè¾“å…¥çš„ one-hot çŸ©é˜µ python def forward(self, w): x = self.embedding_lookup(w) batch_size, seq_len, _ = x.shape ht = torch.zeros(batch_size, self.hidden_size) for i in range(seq_len): inp = x[:, i, :] ht = torch.tanh(torch.matmul(inp, self.embed_to_hidden_weight) + torch.matmul(ht, self.last_to_new_weight) + self.embed_to_hidden_bias) return torch.matmul(ht, self.hidden_to_logits_weight) + self.hidden_to_logits_bias 3. å®éªŒç»“æœ åœ¨ 1000 è½®è®­ç»ƒä¸­å¯ä»¥çœ‹åˆ° loss å·²ç»é™åˆ°éå¸¸å°çš„æ•°æ®äº†ï¼š text ç¬¬ 988/1001 è½®è®­ç»ƒï¼Œloss=2.3454136680811644e-05 ç¬¬ 989/1001 è½®è®­ç»ƒï¼Œloss=2.3394533855025657e-05 ç¬¬ 990/1001 è½®è®­ç»ƒï¼Œloss=2.3357280952041037e-05 ç¬¬ 991/1001 è½®è®­ç»ƒï¼Œloss=2.3320028049056418e-05 ç¬¬ 992/1001 è½®è®­ç»ƒï¼Œloss=2.330512688786257e-05 ç¬¬ 993/1001 è½®è®­ç»ƒï¼Œloss=2.3282778784050606e-05 ç¬¬ 994/1001 è½®è®­ç»ƒï¼Œloss=2.3260427042259835e-05 ä½†æ˜¯åœ¨æµ‹è¯•é›†ä¸Šæ•ˆæœéå¸¸å·®ï¼š text æ­£ç¡®ï¼štensor([14, 12, 3, 22, 19, 9, 22]) é¢„æµ‹ï¼štensor([16, 18, 15, 17, 25, 4, 5]) loss=7.221210956573486 å¤§æ¦‚ç‡æ˜¯æ•°æ®é›†é—®é¢˜ï¼Œä¸è¿‡å®éªŒé¢˜ç›®é™åˆ¶æ•°æ®é›†å°±è¿™ä¹ˆå¤§==ï¼Œæ‰€ä»¥ä»£ç åº”è¯¥æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ ","date":"2025-11-19","objectID":"/posts/rnn/:4:0","series":["DeepLearning"],"tags":["Module","æ·±åº¦å­¦ä¹ "],"title":"RNN","uri":"/posts/rnn/#å®éªŒè¿‡ç¨‹"},{"categories":null,"content":" æ¢¯åº¦ä¸‹é™Î¸jnew:=Î¸joldâˆ’Î·â€‰âˆ‡Î¸J(Î¸) \\theta^{new}_j := \\theta^{old}_j - \\eta \\, \\nabla_{\\theta} J(\\theta) Î¸jnewâ€‹:=Î¸joldâ€‹âˆ’Î·âˆ‡Î¸â€‹J(Î¸)ä¼ ç»Ÿæ¢¯åº¦ä¸‹é™ç®—æ³•çš„ç¼ºç‚¹åœ¨äºï¼š è®¡ç®—æˆæœ¬å¤§ï¼š$J(\\theta) = \\frac{1}{N} \\sum_{i=1}^{N} L(x_i, y_i; \\theta)$ï¼Œè¿™æ„å‘³ç€æ¯ä¸€æ¬¡è®¡ç®—æ¢¯åº¦éƒ½éœ€è¦å…¨éƒ¨æ ·æœ¬å‚ä¸è®¡ç®—ï¼Œå¼€é”€å¾ˆå¤§ å®¹æ˜“é™·å…¥å±€éƒ¨æœ€å°å€¼ ","date":"2025-11-19","objectID":"/posts/cs224n-lecture2/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 2: Word Vectors and Language Models","uri":"/posts/cs224n-lecture2/#æ¢¯åº¦ä¸‹é™"},{"categories":null,"content":" éšæœºæ¢¯åº¦ä¸‹é™ä»…ä»…åœ¨å…¨éƒ¨æ•°æ®é›†ä¸­é€‰å–ä¸€ä¸ªå¾ˆå°çš„å­é›†ï¼Œä¾‹å¦‚16æˆ–32ä¸ªæ•°æ®ï¼Œç”¨è¿™äº›æ•°æ®å……å½“å®Œæ•´çš„æ•°æ®é›†æ¥è®¡ç®—æŸå¤±å‡½æ•°å’Œä¼˜åŒ–æ¢¯åº¦ åœ¨æ·±åº¦å­¦ä¹ ä¸­å‡ºç°å™ªå£°ç»å¸¸ä¼šæœ‰æ›´å¥½çš„æ•ˆæœ ","date":"2025-11-19","objectID":"/posts/cs224n-lecture2/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 2: Word Vectors and Language Models","uri":"/posts/cs224n-lecture2/#éšæœºæ¢¯åº¦ä¸‹é™"},{"categories":null,"content":" è·³å­—è´Ÿé‡‡æ ·Skip-Gramç”¨çš„æ˜¯Softmaxæ¦‚ç‡: P(woâˆ£wi)=expâ¡(vwoâ€²Tvwi)âˆ‘w=1Vexpâ¡(vwâ€²Tvwi) P(w_o \\mid w_i) = \\frac{\\exp(v_{w_o}'^T v_{w_i})}{\\sum_{w=1}^{V} \\exp(v_w'^T v_{w_i})} P(woâ€‹âˆ£wiâ€‹)=âˆ‘w=1Vâ€‹exp(vwâ€²Tâ€‹vwiâ€‹â€‹)exp(vwoâ€‹â€²Tâ€‹vwiâ€‹â€‹)â€‹ ä¹Ÿå°±æ˜¯è¯´ä¼šè®¡ç®—æ•´ä¸ªCorpusçš„åˆ†æ¯ï¼Œè®¡ç®—é‡éå¸¸å¤§ã€‚ è´Ÿé‡‡æ ·çš„æ€æƒ³æ˜¯ï¼Œä¸å†è®¡ç®—æ•´ä¸ªè¯è¡¨çš„æ¦‚ç‡ï¼Œè€Œæ˜¯å•å•åˆ¤æ–­æ­£æ ·æœ¬ï¼ˆä¸Šä¸‹æ–‡ï¼‰å’Œè´Ÿæ ·æœ¬ï¼ˆéšæœºé‡‡æ ·çš„éä¸Šä¸‹æ–‡è¯ï¼‰ å¯¹äºä¸€ä¸ªä¸­å¿ƒè¯$w_i$å’Œä¸€ä¸ªä¸Šä¸‹æ–‡è¯$w_o$ä»¥åŠè´Ÿæ ·æœ¬é›†Kï¼Œç›®æ ‡å‡½æ•°æ˜¯ï¼š J(wi,wo)=âˆ’logâ¡Ïƒ(vwoâ€²â‹…vwi)âˆ’âˆ‘k=1Klogâ¡Ïƒ(âˆ’vwkâ€²â‹…vwi) J(w_i, w_o) = - \\log \\sigma(v_{w_o}' \\cdot v_{w_i}) - \\sum_{k=1}^{K} \\log \\sigma(-v_{w_k}' \\cdot v_{w_i}) J(wiâ€‹,woâ€‹)=âˆ’logÏƒ(vwoâ€‹â€²â€‹â‹…vwiâ€‹â€‹)âˆ’k=1âˆ‘Kâ€‹logÏƒ(âˆ’vwkâ€‹â€²â€‹â‹…vwiâ€‹â€‹)","date":"2025-11-19","objectID":"/posts/cs224n-lecture2/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 2: Word Vectors and Language Models","uri":"/posts/cs224n-lecture2/#è·³å­—è´Ÿé‡‡æ ·"},{"categories":null,"content":" å…±ç°çŸ©é˜µå›é¡¾ä¹‹å‰æåˆ°çš„æ„é€ è¯å‘é‡çš„æ–¹æ³•ï¼šone-hotç¼–ç å’Œword2vecæ€æƒ³ï¼Œè¿˜æœ‰ä¸€ç§æ›´ç®€å•çš„è¡¨ç¤ºæ€è·¯ã€‚è®©ç›¸é‚»çš„è¯çš„å‘é‡è¡¨ç¤ºç›¸ä¼¼ï¼Œç›´æ¥ç»Ÿè®¡å“ªäº›è¯æ˜¯ç»å¸¸ä¸€èµ·å‡ºç°çš„ã€‚ä¸‹é¢å›¾ç‰‡å°±æ˜¯CS224Nè¯¾ç¨‹ä¸­ä¸¾çš„ä¾‹å­ï¼Œæ ¹æ®ä¸‰ä¸ªå¥å­çš„è¯­æ–™åº“æ„é€ çš„å…±ç°çŸ©é˜µã€‚ è¿™æ ·çš„è¡¨ç¤ºæ˜æ˜¾ä¼˜äºone-hotè¡¨ç¤ºï¼Œå› ä¸ºå®ƒçš„æ¯ä¸€ç»´éƒ½æœ‰å«ä¹‰â€”â€”å…±ç°æ¬¡æ•°ï¼Œå› æ­¤è¿™æ ·çš„å‘é‡è¡¨ç¤ºå¯ä»¥æ±‚è¯è¯­ä¹‹é—´çš„ç›¸ä¼¼åº¦ã€‚ ä½†æ˜¯è¿™æ ·è¡¨ç¤ºè¿˜æœ‰æœ‰ä¸€äº›é—®é¢˜ï¼š ç»´åº¦=è¯æ±‡é‡å¤§å°ï¼Œè¿˜æ˜¯å¤ªå¤§äº† è¿˜æ˜¯å¤ªè¿‡äºç¨€ç–ï¼Œåœ¨åšä¸‹æ¸¸ä»»åŠ¡çš„æ—¶å€™ä¾ç„¶ä¸å¤Ÿæ–¹ä¾¿ã€‚ å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜å¯ä»¥é‡‡ç”¨SVDå¥‡å¼‚å€¼åˆ†è§£çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥å°†ä»»æ„çŸ©é˜µåˆ†è§£ä¸ºä¸‰ä¸ªçŸ©é˜µçš„ä¹˜ç§¯ã€‚ä¸ºäº†å‡å°‘å°ºåº¦åŒæ—¶å°½é‡ä¿å­˜æœ‰æ•ˆä¿¡æ¯ï¼Œä¿ç•™å¯¹è§’çŸ©é˜µçš„æœ€å¤§çš„kä¸ªå€¼ï¼Œå¹¶å°†çŸ©é˜µUï¼ŒV çš„ç›¸åº”çš„è¡Œåˆ—ä¿ç•™ã€‚ ","date":"2025-11-19","objectID":"/posts/cs224n-lecture2/:4:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 2: Word Vectors and Language Models","uri":"/posts/cs224n-lecture2/#å…±ç°çŸ©é˜µ"},{"categories":null,"content":" GloVeGloVe=Global+Vectorï¼Œå®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯ï¼šå¦‚æœä¸¤ä¸ªè¯åœ¨è¯­æ–™åº“ä¸­ç»å¸¸å‡ºç°åœ¨ç›¸ä¼¼çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå®ƒä»¬çš„è¯å‘é‡å°±åº”è¯¥ç›¸ä¼¼ã€‚ ä½†ä¸åŒäº Word2Vec çš„ã€Œé¢„æµ‹å¼ã€å­¦ä¹ ï¼ŒGloVe æ˜¯ä¸€ä¸ªã€Œç»Ÿè®¡å¼ã€æ¨¡å‹ï¼Œç›´æ¥åˆ©ç”¨å…±ç°çŸ©é˜µçš„å…¨å±€ç»Ÿè®¡ä¿¡æ¯ã€‚ ","date":"2025-11-19","objectID":"/posts/cs224n-lecture2/:5:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 2: Word Vectors and Language Models","uri":"/posts/cs224n-lecture2/#glove"},{"categories":null,"content":" å…±ç°æ¦‚ç‡äººä¸ºçš„å®šä¹‰å…±ç°æ¦‚ç‡ï¼š P(jâˆ£i)=Pij=XijXi P(j|i)=P_{ij}=\\frac{X_{ij}}{X_i} P(jâˆ£i)=Pijâ€‹=Xiâ€‹Xijâ€‹â€‹ $X_{ij}$æ˜¯è¯jå‡ºç°åœ¨è¯iä¸Šä¸‹æ–‡çš„æ€»æ¬¡æ•° $X_i=\\sum_kX_{ik}$ï¼Œä¹Ÿå°±æ˜¯è¯içš„ä¸Šä¸‹æ–‡æ€»æ•° ä¸¾ä¸ªä¾‹å­ï¼ŒCorpusä¸­æœ‰ä¸‹é¢ä¸¤ä¸ªå¥å­ï¼Œå¹¶ä¸”æˆ‘ä»¬éœ€è¦è®¡ç®—P(I,like)ï¼š text I like A I like B é‚£æˆ‘ä»¬å¯ä»¥å¾—åˆ°å…±ç°çŸ©é˜µ: I like A B I 0 2 0 0 like 2 0 1 1 A 0 1 0 0 B 0 1 0 0 æ ¹æ®å…¬å¼å¯ä»¥å¾—åˆ°ï¼š P(I,like)=XI,likeXI P(I,like)=\\frac{X_{I,like}}{X_I} P(I,like)=XIâ€‹XI,likeâ€‹â€‹ ä»å…±ç°çŸ©é˜µå¯ä»¥çœ‹åˆ°ï¼Œ$X_{I,like}=2$ã€‚å‡è®¾çª—å£å¤§å°ä¸º1ï¼Œé‚£ä¹ˆ$X_I=2$ï¼Œ$P(I,like)=1$ï¼›å‡è®¾çª—å£å¤§å°ä¸º2ï¼Œé‚£ä¹ˆ$P(I,like)=\\frac{1}{2}$ GloVe çš„ä¸€ä¸ªéå¸¸ç›´è§‚çš„å‡ºå‘ç‚¹æ˜¯ï¼š æŸäº›è¯ä¹‹é—´çš„æ„ä¹‰å·®å¼‚å¯ä»¥é€šè¿‡å…±ç°æ¦‚ç‡æ¯”å€¼ä½“ç°ã€‚ P(appleâˆ£red)P(appleâˆ£green)=Pred,applePgreen,appleâ‰¥1 \\frac{P(apple|red)}{P(apple|green)} = \\frac{P_{red,apple}}{P_{green,apple}} \\ge 1 P(appleâˆ£green)P(appleâˆ£red)â€‹=Pgreen,appleâ€‹Pred,appleâ€‹â€‹â‰¥1 é‚£ä¹ˆå°±è®¤ä¸ºredæ¯”greenç›¸å¯¹appleæ›´æœ‰æ„ä¹‰. äºæ˜¯GloVeå¸Œæœ›å­¦ä¹ åˆ°ä¸€ä¸ªå‡½æ•°èƒ½å¤Ÿè¿‘ä¼¼æ¦‚ç‡æ¯”å€¼: F(wi,wj,wk~)=PikPjk F(wi, wj, \\tilde{w_k})=\\frac{P_{ik}}{P_{jk}} F(wi,wj,wkâ€‹~â€‹)=Pjkâ€‹Pikâ€‹â€‹ç»è¿‡ä¸€ç³»åˆ—æ•°å­¦æ¨å¯¼(ä¸‹æ–‡ä¼šè®¡ç®—)ï¼Œè¯å‘é‡çš„ç‚¹ä¹˜å¯ä»¥è¿‘ä¼¼äº: wiTwj+bi+bjâ‰ˆlogâ¡Xij w_i^Tw_j+b_i+b_j \\approx \\log{X_{ij}} wiTâ€‹wjâ€‹+biâ€‹+bjâ€‹â‰ˆlogXijâ€‹æ­¤æ—¶æŸå¤±å‡½æ•°å°±å˜æˆäº†æ‹Ÿåˆè¿™ä¸ªå…³ç³»ï¼Œæˆ‘ä»¬å¸Œæœ›ä»–ä»¬å°½å¯èƒ½ç›¸ç­‰ï¼Œä¹Ÿå°±æ˜¯ wiTwj+bi+bjâˆ’logâ¡Xij w_i^Tw_j+b_i+b_j - \\log{X_{ij}} wiTâ€‹wjâ€‹+biâ€‹+bjâ€‹âˆ’logXijâ€‹ å°½å¯èƒ½ç­‰äº0 \\[ J=\\sum_{i,j}(â€‹{w_i^Tâ€‹w_jâ€‹+b_iâ€‹+b_jâ€‹âˆ’\\log{X_{ij}}â€‹})^2 \\]å¾—åˆ°ç›®æ ‡å‡½æ•°/æŸå¤±å‡½æ•°çš„è¡¨è¾¾å¼åçš„æ“ä½œå°±å¾ˆç®€å•äº†ï¼Œå¯¹å¼å­æ±‚åå¯¼è¿›è¡Œæ¢¯åº¦ä¸‹é™ï¼Œä¼˜åŒ–éšæœºç”Ÿæˆçš„è¯å‘é‡$w_i$å’Œ$w_j$ æŸäº›è¯ï¼ˆæ¯”å¦‚ â€œtheâ€ï¼‰å‡ºç°å¤ªå¤šï¼Œä¼šè®©æŸå¤±è¢«å®ƒä»¬ä¸»å¯¼ã€‚æ‰€ä»¥ GloVe åŠ äº†ä¸€ä¸ªæƒé‡å‡½æ•°$f(X_{ij})$ã€‚$f(x)$ è¶Šå¤§ï¼Œä»£è¡¨è¯çš„é‡è¦æ€§è¶Šé«˜ã€‚ \\[ J=\\sum_{i,j}f(X_{ij})(â€‹{w_i^Tâ€‹w_jâ€‹+b_iâ€‹+b_jâ€‹âˆ’\\log{X_{ij}}â€‹})^2 \\] ä¸Word2Vecçš„ç›®æ ‡å‡½æ•°ç›¸æ¯”ï¼ŒGloVeçš„æŸå¤±å‡½æ•°æ›´åƒå›å½’é—®é¢˜ Glove çš„ä½œè€…è®¤ä¸ºï¼Œå•è¯è¯å‘é‡ç©ºé—´æ˜¯ä¸€ä¸ªçº¿æ€§ç»“æ„ï¼Œä¾‹å¦‚ â€œmanâ€ - â€œwomenâ€ çš„å·®ä¸ â€œkingâ€ - â€œqueenâ€ çš„å·®å¾ˆç›¸è¿‘. ä½œè€…å‡è®¾å­˜åœ¨ä¸€ä¸ªå‡½æ•°ï¼š F(wiâˆ’wj,wk)=PikPjk F(w_i-w_j,w_k)=\\frac{P_{ik}}{P_{jk}} F(wiâ€‹âˆ’wjâ€‹,wkâ€‹)=Pjkâ€‹Pikâ€‹â€‹ å¹¶ä¸”å‡è®¾Fæ˜¯ä¸€ä¸ªç‚¹ä¹˜çš„è®¡ç®—å³ï¼š F(wiâˆ’wj,wk)=wkT(wiâˆ’wj)=logâ¡PikPjk=logâ¡Pikâˆ’logâ¡Pjk F(w_i-w_j,w_k)=w_k^T(w_i-w_j)=\\log{\\frac{P_{ik}}{P_{jk}}}=\\log{P_{ik}}-\\log{P_{jk}} F(wiâ€‹âˆ’wjâ€‹,wkâ€‹)=wkTâ€‹(wiâ€‹âˆ’wjâ€‹)=logPjkâ€‹Pikâ€‹â€‹=logPikâ€‹âˆ’logPjkâ€‹ è¿™ä¸ªå¼å­å¯ä»¥åŒ–ç®€ä¸º: wiTwkâˆ’wjTwk=logâ¡(Pik)âˆ’logâ¡(Pjk) w_i^T w_k - w_j^T w_k = \\log(P_{ik}) - \\log(P_{jk}) wiTâ€‹wkâ€‹âˆ’wjTâ€‹wkâ€‹=log(Pikâ€‹)âˆ’log(Pjkâ€‹) ä»ä¸­å¯ä»¥çœ‹åˆ°å­˜åœ¨è¿™æ ·çš„å…³ç³»ï¼š wiTwkâ‰ˆlogâ¡(Pik)=logâ¡XikXi=logâ¡Xikâˆ’logâ¡(Xi) w_i^T w_k \\approx \\log(P_{ik}) = \\log{\\frac{X_{ik}}{X_i}}=\\log{X_{ik}-\\log(X_i)} wiTâ€‹wkâ€‹â‰ˆlog(Pikâ€‹)=logXiâ€‹Xikâ€‹â€‹=logXikâ€‹âˆ’log(Xiâ€‹) å³ï¼š wiTwk+logâ¡(Xi)â‰ˆlogâ¡Xik w_i^T w_k + \\log(X_i) \\approx \\log{X_{ik}} wiTâ€‹wkâ€‹+log(Xiâ€‹)â‰ˆlogXikâ€‹ æˆ‘ä»¬å¯ä»¥æŠ½è±¡å‡ºä¸€èˆ¬çš„å½¢å¼,$b_i$å’Œ$\\tilde{b_k}$æ˜¯åç½®ï¼Œå¸æ”¶äº†$\\log(X_i)$å’Œå…¶ä»–å¸¸æ•°ï¼š wiTwj+bi+bj~â‰ˆlogâ¡Xij w_i^Tw_j + b_i + \\tilde{b_j} \\approx \\log{X_{ij}} wiTâ€‹wjâ€‹+biâ€‹+bjâ€‹~â€‹â‰ˆlogXijâ€‹å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ GloVe ä¸­ï¼Œæ¯ä¸ªè¯éƒ½æœ‰ä¸¤ä¸ªå‘é‡ï¼š è¯å‘é‡ $w_i$ â€” è¡¨ç¤ºè¿™ä¸ªè¯æœ¬èº« ä¸Šä¸‹æ–‡å‘é‡ $\\tilde{w_j}$ â€” è¡¨ç¤ºå½“è¿™ä¸ªè¯å‡ºç°åœ¨åˆ«çš„è¯çš„ä¸Šä¸‹æ–‡ä¸­æ—¶çš„â€œè§’è‰²â€ å¹¶ä¸æ˜¯æ¯æ¬¡å‡ºç°çš„ä¸Šä¸‹æ–‡è¯ç›´æ¥æ‹¿å¥å­é‡Œçš„å…¶ä»–è¯çš„å‘é‡ï¼Œè€Œæ˜¯æ¯ä¸ªè¯éƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„ä¸Šä¸‹æ–‡å‘é‡ï¼Œç”¨æ¥å‚ä¸ å…±ç°å¯¹çš„é¢„æµ‹ã€‚ æœ€åè®­ç»ƒç»“æŸè¯å‘é‡ä¸€èˆ¬ç›´æ¥ç”¨$w_i$æˆ–è€…å–$w_i$å’Œ$\\tilde{w_i}$çš„å¹³å‡å€¼ ","date":"2025-11-19","objectID":"/posts/cs224n-lecture2/:5:1","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 2: Word Vectors and Language Models","uri":"/posts/cs224n-lecture2/#å…±ç°æ¦‚ç‡"},{"categories":null,"content":" è¯„ä¼°","date":"2025-11-19","objectID":"/posts/cs224n-lecture2/:6:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 2: Word Vectors and Language Models","uri":"/posts/cs224n-lecture2/#è¯„ä¼°"},{"categories":null,"content":" çŸ©é˜µå¾®ç§¯åˆ†âˆ‚âˆ‚x(Wx+b)=W \\frac{\\partial}{\\partial{\\textbf{x}}}(\\textbf{Wx+b})=\\textbf{W} âˆ‚xâˆ‚â€‹(Wx+b)=Wâˆ‚âˆ‚b(Wx+b)=I \\frac{\\partial}{\\partial{\\textbf{b}}}(\\textbf{Wx+b})=\\textbf{I} âˆ‚bâˆ‚â€‹(Wx+b)=Iâˆ‚âˆ‚u(uTh)=hT \\frac{\\partial}{\\partial{\\textbf{u}}}(\\textbf{u}^Th)=\\textbf{h}^T âˆ‚uâˆ‚â€‹(uTh)=hT","date":"2025-11-19","objectID":"/posts/cs224n-lecture3/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 3: Backpropagation, Neural Network","uri":"/posts/cs224n-lecture3/#çŸ©é˜µå¾®ç§¯åˆ†"},{"categories":null,"content":" é›…å…‹æ¯”è¡Œåˆ—å¼ \\[ \\textbf{h}=f(\\textbf{z}) \\\\ h_i=f(z_i) ä¸” \\textbf{h} ,\\textbf{z} \\in R^n \\]å¯ä»¥å¾—åˆ°: (âˆ‚hâˆ‚z)ij=âˆ‚hiâˆ‚zj=âˆ‚f(zi)âˆ‚zj={fâ€²(zi),â€…ifâ€…i=j0,â€…ifâ€…otherwiseâˆ‚hâˆ‚z=(fâ€²(z1)0â‹±0fâ€²(zn))=diagâ¡(fâ€²(z)) (\\frac{\\partial{h}}{\\partial{z}})_{ij}=\\frac{\\partial{h_i}}{\\partial{z_j}}=\\frac{\\partial{f(z_i)}}{\\partial{z_j}}= \\begin{cases} f'(z_i),\\;if\\;i=j\\\\ 0,\\;if\\;otherwise \\end{cases} \\\\ \\frac{\\partial h}{\\partial z} = \\begin{pmatrix} f'(z_1) \u0026 \u0026 0 \\\\ \u0026 \\ddots \u0026 \\\\ 0 \u0026 \u0026 f'(z_n) \\end{pmatrix} = \\operatorname{diag}(f'(z)) (âˆ‚zâˆ‚hâ€‹)ijâ€‹=âˆ‚zjâ€‹âˆ‚hiâ€‹â€‹=âˆ‚zjâ€‹âˆ‚f(ziâ€‹)â€‹={fâ€²(ziâ€‹),ifi=j0,ifotherwiseâ€‹âˆ‚zâˆ‚hâ€‹=â€‹fâ€²(z1â€‹)0â€‹â‹±â€‹0fâ€²(znâ€‹)â€‹â€‹=diag(fâ€²(z))","date":"2025-11-19","objectID":"/posts/cs224n-lecture3/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 3: Backpropagation, Neural Network","uri":"/posts/cs224n-lecture3/#é›…å…‹æ¯”è¡Œåˆ—å¼"},{"categories":null,"content":" åå‘ä¼ æ’­ å‰å‘ä¼ æ’­å°±æ˜¯å•çº¯çš„è®¡ç®— åå‘ä¼ æ’­æ˜¯æ ¹æ®æ¢¯åº¦è¿›è¡Œå­¦ä¹  å•è¾“å…¥å•è¾“å‡ºçš„æƒ…å†µä¸‹,ä¸‹æ¸¸æ¢¯åº¦å°±æ˜¯å±€éƒ¨æ¢¯åº¦ä¸ä¸Šæ¸¸æ¢¯åº¦çš„ä¹˜ç§¯ã€‚ âˆ‚sâˆ‚z=âˆ‚hâˆ‚zÃ—âˆ‚sâˆ‚h \\frac{\\partial{s}}{\\partial{z}}=\\frac{\\partial{h}}{\\partial{z}} \\times \\frac{\\partial{s}}{\\partial{h}} âˆ‚zâˆ‚sâ€‹=âˆ‚zâˆ‚hâ€‹Ã—âˆ‚hâˆ‚sâ€‹ å¤šè¾“å…¥çš„æƒ…å†µä¸‹ä»ç„¶éµå¾ªé“¾å¼æ³•åˆ™ã€‚ å¦‚å›¾æ˜¯ä¸€ç§é”™è¯¯çš„è®¡ç®—åå‘ä¼ æ’­çš„æ–¹å¼ï¼Œå¦‚æœä¾æ¬¡è®¡ç®—$\\frac{\\partial{s}}{\\partial{W}}$å’Œ$\\frac{\\partial{s}}{\\partial{b}}$ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€éƒ¨åˆ†è®¡ç®—æ˜¯é‡å¤çš„ï¼Œå°±å¯¼è‡´åå‘ä¼ æ’­çš„æ•ˆç‡ä¸‹é™ã€‚æ­£ç¡®çš„æ–¹å¼åº”è¯¥æ˜¯å…ˆè®¡ç®—å…¬å…±éƒ¨åˆ†ï¼Œç„¶åå†è®¡ç®—å•ç‹¬çš„éƒ¨åˆ†ï¼Œè¿™å¯ä»¥é€šè¿‡æ‹“æ‰‘æ’åºæ¥å®ç°ã€‚ ","date":"2025-11-19","objectID":"/posts/cs224n-lecture3/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 3: Backpropagation, Neural Network","uri":"/posts/cs224n-lecture3/#åå‘ä¼ æ’­"},{"categories":null,"content":" demoå®ç° python class multiplyGate(): def forward(x, y): self.x = x self.y = y return x*y def backward(dz): dx = self.y * dz # dz/dx * dL/dz dy = self.x * dz return [dx, dy] ","date":"2025-11-19","objectID":"/posts/cs224n-lecture3/:4:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 3: Backpropagation, Neural Network","uri":"/posts/cs224n-lecture3/#demoå®ç°"},{"categories":null,"content":" 1. ç‹¬çƒ­ç¼–ç æ¯ä¸ªä¸åŒçš„å‘é‡ä»£è¡¨ä¸€ä¸ªå•è¯ï¼Œä¾‹å¦‚: text motel = [0 0 0 0 0 0 1] hotel = [0 0 0 0 0 1 0] è¿™ä¸ªæ–¹æ¡ˆçš„ç¼ºç‚¹å¾ˆæ˜æ˜¾: æ²¡æ³•åˆ¤æ–­æ¯ä¸ªå‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼Œè™½ç„¶ä¸Šé¢motelå’Œhotelä»£è¡¨çš„å‘é‡æ˜¯æ­£äº¤çš„ï¼Œä½†å®ƒä»¬ä¹‹é—´ç›¸äº’æœ‰å…³è”ï¼›å…¶æ¬¡è¿™äº›one-bot vectorçš„ç»´åº¦ä¼šéå¸¸å¤§ï¼Œå› ä¸ºè¯æ±‡è¡¨ä¸­å¾€å¾€æœ‰å‡ åä¸‡çš„å•è¯ã€‚ ","date":"2025-11-05","objectID":"/posts/cs224n-lecture1/:1:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 1: Intro and Word Vectors","uri":"/posts/cs224n-lecture1/#1-ç‹¬çƒ­ç¼–ç "},{"categories":null,"content":" 2. è¯å‘é‡åŸºäºå•è¯çš„ä¸Šä¸‹æ–‡è·å¾—å®ƒçš„å«ä¹‰ï¼Œé€šè¿‡å­¦ä¹ å„ä¸ªå•è¯çš„å«ä¹‰å¾—åˆ°æ›´åŠ å¯†é›†çš„è¯å‘é‡ã€‚ text expect = [ 0.286, 0.792 ... ] ","date":"2025-11-05","objectID":"/posts/cs224n-lecture1/:2:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 1: Intro and Word Vectors","uri":"/posts/cs224n-lecture1/#2-è¯å‘é‡"},{"categories":null,"content":" 3. Word2vecé‡è¦å‡è®¾ï¼šæ–‡æœ¬ä¸­é‡Œçš„æœ€è¿‘çš„è¯è¯­ç›¸ä¼¼åº¦è¶Šé«˜ CBOW: ç”¨ä¸­å¿ƒè¯é¢„æµ‹ä¸Šä¸‹æ–‡è¯ skip-gram: ç”¨ä¸Šä¸‹æ–‡è¯é¢„æµ‹ä¸­å¿ƒè¯ ä¸Šä¸‹æ–‡è¯çš„æ•°é‡å–å†³äºçª—å£å¤§å°ï¼Œä¸­å¿ƒè¯æ˜¯æ¯æ¬¡éå†çš„è¯è¯­ã€‚å®æˆ˜ä¸­é™¤äº†ç”¨ä¸Šä¸‹æ–‡æ¥é¢„æµ‹ä¸­å¿ƒè¯ï¼Œè¿˜éœ€è¦ç”¨åˆ°è´Ÿæ ·æœ¬è¯ï¼Œä¹Ÿå°±æ˜¯éä¸Šä¸‹æ–‡è¯ï¼Œå…·ä½“ç”¨å¤šå°‘æˆ–è€…æ˜¯å¦é‡‡ç”¨ï¼Œå–å†³äºè¯­æ–™åº“å¤§å°ã€‚ å¯¹äºæ¯ä¸€ä¸ªä¸­å¿ƒè¯ï¼Œæˆ‘ä»¬ç»™å…¶ä»–è¯å‡ºç°çš„æ¦‚ç‡å®šä¹‰ä¸ºï¼š P(wotherâˆ£wcenter) P(w_{other} \\mid w_{center}) P(wotherâ€‹âˆ£wcenterâ€‹) å‡è®¾jæ˜¯çª—å£å¤§å°ï¼Œå¯¹äºæ¯ä¸ªä¸­å¿ƒè¯ï¼Œå®ƒä¸Šä¸‹æ–‡è¯è¯­å‡ºç°çš„æ¦‚ç‡å³ä¸ºï¼š P(wcenter+jâˆ£wcenter) P(w_{center+j} \\mid w_{center}) P(wcenter+jâ€‹âˆ£wcenterâ€‹) æˆ‘ä»¬å¸Œæœ›P(ä¸Šä¸‹æ–‡è¯âˆ£ä¸­å¿ƒè¯) è¶Šé«˜,è¿™æ ·å°±è¯´æ˜æˆ‘ä»¬é¢„æµ‹è¶Šå‡†ç¡®ã€‚ å¯¹äºå•ä¸ªä¸­å¿ƒè¯çš„ä¼¼ç„¶å‡½æ•°æ˜¯ï¼š Lt=âˆâˆ’câ‰¤jâ‰¤c,jâ‰ 0P(wt+jâˆ£wt) L_t = \\prod_{-c \\le j \\le c, j \\ne 0} P(w_{t+j} \\mid w_t) Ltâ€‹=âˆ’câ‰¤jâ‰¤c,jî€ =0âˆâ€‹P(wt+jâ€‹âˆ£wtâ€‹) å‡è®¾ç©ä¸€ä¸ªé¢„æµ‹æ¸¸æˆ,ä¸­å¿ƒè¯æ˜¯ â€œçŒ«â€ï¼Œçª—å£å†…ä¸Šä¸‹æ–‡è¯æœ‰ä¸¤ä¸ªï¼š[â€œåœ¨â€, â€œç¡è§‰â€]ã€‚æ¨¡å‹é¢„æµ‹ï¼šâ€œåœ¨â€å‡ºç°çš„æ¦‚ç‡ = 0.8ï¼Œâ€œç¡è§‰â€å‡ºç°çš„æ¦‚ç‡ = 0.9ï¼ŒåŒæ—¶çŒœå¯¹ä¸¤ä¸ªè¯çš„æ¦‚ç‡å°±æ˜¯ï¼š0.8Ã—0.9=0.72ï¼Œä¹˜èµ·æ¥ï¼Œå°±æ˜¯â€œä¸¤ä¸ªè¯éƒ½é¢„æµ‹å¯¹çš„æ¦‚ç‡â€ã€‚ æ•´ä¸ªè¯­æ–™åº“çš„ä¼¼ç„¶å‡½æ•°/ç›®æ ‡æŸå¤±å‡½æ•°å°±æ˜¯ï¼š L=âˆt=1Tâˆâˆ’câ‰¤jâ‰¤c,jâ‰ 0P(wt+jâˆ£wt) L = \\prod_{t=1}^{T} \\prod_{-c \\le j \\le c, j \\ne 0} P(w_{t+j} \\mid w_t) L=t=1âˆTâ€‹âˆ’câ‰¤jâ‰¤c,jî€ =0âˆâ€‹P(wt+jâ€‹âˆ£wtâ€‹)ä¸€èˆ¬ä½¿ç”¨ä¸¤ä¸ªæŠ€å·§æ¥ä¼˜åŒ– Loss: ä¸€èˆ¬éƒ½æ˜¯æœ€å°åŒ–è€Œä¸æ˜¯æœ€å¤§åŒ–ï¼Œæ‰€ä»¥å¯¹Losså–è´Ÿæ•°ï¼Œä¹‹åé‡‡ç”¨æ¢¯åº¦ä¸‹é™ é‡‡ç”¨å–å¯¹æ•°å‡å°æ•°å­—å¤§å°ï¼Œæ–¹ä¾¿è®¡ç®— æœ€åçš„ç›®æ ‡æŸå¤±å‡½æ•°å³ä¸ºï¼š J=âˆ’1Tâˆ‘t=1Tâˆ‘âˆ’câ‰¤jâ‰¤c,jâ‰ 0logâ¡P(wt+jâˆ£wt) J = -\\frac{1}{T} \\sum_{t=1}^{T} \\sum_{-c \\le j \\le c, j \\ne 0} \\log P(w_{t+j} \\mid w_t) J=âˆ’T1â€‹t=1âˆ‘Tâ€‹âˆ’câ‰¤jâ‰¤c,jî€ =0âˆ‘â€‹logP(wt+jâ€‹âˆ£wtâ€‹)ç»™å®šä¸­å¿ƒè¯é¢„æµ‹ä¸Šä¸‹æ–‡è¯çš„å…¬å¼å¦‚ä¸‹ï¼š P(woâˆ£wi)=expâ¡(vwoâ€²Tvwi)âˆ‘w=1Vexpâ¡(vwâ€²Tvwi) P(w_o \\mid w_i) = \\frac{\\exp(v_{w_o}'^T v_{w_i})}{\\sum_{w=1}^{V} \\exp(v_w'^T v_{w_i})} P(woâ€‹âˆ£wiâ€‹)=âˆ‘w=1Vâ€‹exp(vwâ€²Tâ€‹vwiâ€‹â€‹)exp(vwoâ€‹â€²Tâ€‹vwiâ€‹â€‹)â€‹ é€šè¿‡ä¸­å¿ƒè¯å’Œä¸Šä¸‹æ–‡è¯çš„å†…ç§¯ï¼Œè®¡ç®—ä»–ä»¬ä¹‹é—´çš„ç›¸ä¼¼åº¦ é€šè¿‡expå–æŒ‡æ•°ï¼Œå®ƒä¿è¯è¾“å‡ºæ˜¯æ­£æ•°ã€‚æ¦‚ç‡éœ€è¦æ˜¯æ­£æ•° é€šè¿‡å½’ä¸€åŒ–ä½¿å¾—å®ƒæ˜¯0-1çš„å°æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´P(woâˆ£wi)=è¯¥è¯åœ¨ä¸Šä¸‹æ–‡iä¸­çš„å¾—åˆ†æ‰€æœ‰è¯åœ¨ä¸Šä¸‹æ–‡iä¸­çš„å¾—åˆ† P(w_o \\mid w_i) = \\frac{\\text{è¯¥è¯åœ¨ä¸Šä¸‹æ–‡iä¸­çš„å¾—åˆ†}}{ \\text{æ‰€æœ‰è¯åœ¨ä¸Šä¸‹æ–‡iä¸­çš„å¾—åˆ†}} P(woâ€‹âˆ£wiâ€‹)=æ‰€æœ‰è¯åœ¨ä¸Šä¸‹æ–‡iä¸­çš„å¾—åˆ†è¯¥è¯åœ¨ä¸Šä¸‹æ–‡iä¸­çš„å¾—åˆ†â€‹ é‚£å‰é¢è¯´çš„ä¸­å¿ƒè¯å’Œä¸Šä¸‹æ–‡è¯çš„å‘é‡æ˜¯å¦‚ä½•å¾—åˆ°çš„å‘¢ï¼Ÿä¸€å¼€å§‹æ¨¡å‹ä¼šä¸ºè¿™äº›è¯éšæœºä¸€ä¸ªå‘é‡ï¼Œç„¶ååœ¨æ¢¯åº¦ä¸‹é™çš„è¿‡ç¨‹ä¸­ä¼˜åŒ–è¿™äº›å‘é‡ã€‚ Word2Vecçš„ç›®æ ‡å‡½æ•°/æŸå¤±å‡½æ•°ä¸æ·±åº¦å­¦ä¹ ä¸­å›å½’é—®é¢˜çš„æŸå¤±å‡½æ•°æœ‰æ‰€ä¸åŒã€‚ å›å½’é—®é¢˜é€šå¸¸æ˜¯ç”¨å¯¹å·²çŸ¥å€¼å’Œé¢„æµ‹å€¼çš„å·®è¿›è¡Œæ‹Ÿåˆ Word2Vecåªæ˜¯è¦æ±‚æ¨¡å‹â€œé¢„æµ‹çš„æ¦‚ç‡åˆ†å¸ƒâ€å°½é‡è®©çœŸå®ä¸Šä¸‹æ–‡è¯çš„æ¦‚ç‡é«˜ Word2Vec çš„æ€æƒ³æ˜¯â€œæœ€å¤§åŒ–æ¦‚ç‡â€ï¼Œå®ƒä¸ç›´æ¥æ¯”è¾ƒé¢„æµ‹å€¼å’ŒçœŸå®å€¼ï¼Œè€Œæ˜¯è¦æ±‚æ¨¡å‹â€œé¢„æµ‹çš„æ¦‚ç‡åˆ†å¸ƒâ€å°½é‡è®©çœŸå®ä¸Šä¸‹æ–‡è¯çš„æ¦‚ç‡é«˜ã€‚ å³ï¼š \\[ max\\prod{P(çœŸå®ä¸Šä¸‹æ–‡è¯âˆ£ä¸­å¿ƒè¯)} \\]å›å½’é—®é¢˜æ˜¯å¸Œæœ›\"é¢„æµ‹å€¼-çœŸå®å€¼\"å°½å¯èƒ½å°ï¼Œè€ŒWord2Vecæ˜¯å¸Œæœ›æ¦‚ç‡å°½å¯èƒ½å¤§ï¼ˆå–è´Ÿæ•°ä¹‹åå°½å¯èƒ½å°ï¼‰ï¼Œä¹Ÿå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªLoss Functionã€‚ ","date":"2025-11-05","objectID":"/posts/cs224n-lecture1/:3:0","series":["CS224N"],"tags":["æ·±åº¦å­¦ä¹ "],"title":"CS224N Lecture 1: Intro and Word Vectors","uri":"/posts/cs224n-lecture1/#3-word2vec"},{"categories":null,"content":" å¦‚ä½•å®ç°ç»™ä¸€ä¸ªç±»æˆå‘˜å‡½æ•°ç»‘å®šäº‹ä»¶ åœºæ™¯ï¼šæ’ä»¶ç³»ç»Ÿä¸­ï¼Œéœ€è¦ç»™æ’ä»¶çš„å‡½æ•°ç»‘å®šon_messageï¼Œå½“æ”¶åˆ°æ¶ˆæ¯æ—¶å€™è°ƒç”¨å‡½æ•°ã€‚ ä¸€åˆ‡éƒ½æ˜¯ç»‘å®šæ–¹æ³•å’Œæœªç»‘å®šæ–¹æ³•çš„å¤„ç† æ–¹æ¡ˆ1ï¼š @on_messageè£…é¥°å™¨ç»™éœ€è¦çš„æ’ä»¶æ·»åŠ metadata åœ¨__init__ä¸­ï¼Œéå†å…¨éƒ¨æˆå‘˜å‡½æ•°ï¼Œå¦‚æœæœ‰metadataï¼Œå°±ä»selfä¸Šgetatträ¸‹æ¥è¿™ä¸ªç»‘å®šæ–¹æ³• åœ¨åŠ è½½æ’ä»¶æ—¶å€™å®ä¾‹åŒ–æ’ä»¶ç±» æ–¹æ¡ˆ2ï¼š @on_messageè£…é¥°å™¨ç›´æ¥è®°å½•æœªç»‘å®šæ–¹æ³•ï¼Œä»¥åŠå®ƒå¯¹åº”çš„æ¨¡å— åœ¨åŠ è½½æ’ä»¶æ—¶å€™ï¼Œæ ¹æ®æ‰€åœ¨æ¨¡å—æ‰¾åˆ°å…¨éƒ¨æœªç»‘å®šæ–¹æ³• å®ä¾‹åŒ–æ’ä»¶ç±»ï¼Œé€šè¿‡functools.partialæŠŠæ’ä»¶å®ä¾‹ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆä¹Ÿå°±æ˜¯selfï¼‰ç»‘å®šåˆ°åŸå§‹å¤„ç†å‡½æ•°ä¸Šï¼Œè¿™æ—¶å€™å°±å¾—åˆ°äº†ç»‘å®šæ–¹æ³• ","date":"2025-10-19","objectID":"/posts/tricks/:1:0","series":["Python æŠ€å·§"],"tags":["Python"],"title":"Python Tricks","uri":"/posts/tricks/#å¦‚ä½•å®ç°ç»™ä¸€ä¸ªç±»æˆå‘˜å‡½æ•°ç»‘å®šäº‹ä»¶"},{"categories":null,"content":" å•ä¾‹æ¨¡å¼","date":"2025-10-19","objectID":"/posts/design/:1:0","series":["Python æŠ€å·§"],"tags":["Python","è®¾è®¡æ¨¡å¼"],"title":"Python è®¾è®¡æ¨¡å¼","uri":"/posts/design/#å•ä¾‹æ¨¡å¼"},{"categories":null,"content":" å®ç°æ–¹å¼ æ¨¡å—å®ç°å•ä¾‹ python # a.py class Singleton: pass singleton = Singleton() # b.py from a import singleton è£…é¥°å™¨å®ç°å•ä¾‹ python def singleton(cls): _instance = {} def decorated(*args, **kwargs): if cls not in _instance: _instance[cls] = cls(*args, **kwargs) return _instance[cls] return decorated ä½¿ç”¨ç±»çš„æ–¹å¼åˆ›å»ºè£…é¥°å™¨ python class Singleton(object): def __init__(self,cls): self._cls = cls self._instance = {} def __call__(self, *args): if self._cls not in self._instance: self._instance[self._cls] = self._cls(*args) return self._instance[self._cls] ä½¿ç”¨ç±»æ–¹æ³•å®ç°å•ä¾‹ python class Person(object): @classmethod def get_instance(cls, *args, **kwargs): if not hasattr(cls, '_instance'): cls._instance = cls(*args, **kwargs) return cls._instance ä½¿ç”¨__new__æ–¹æ³•å®ç°å•ä¾‹ python class Person(object): def __new__(cls, *args, **kwargs): if not hasattr(cls, '_instance'): cls._instance = super().__new__(cls) return cls._instance ä½¿ç”¨å…ƒç±»metaclasså®ç°å•ä¾‹ python class Singleton(type): def __call__(cls, *args, **kwargs): if not hasattr(cls, \"_instance\"): cls._instance = super().__call__(*args, **kwargs) return cls._instance class Person(metaclass=Singleton): def __init__(self,name, age): self.name = name self.age = age Warning åœ¨å¤šçº¿ç¨‹å’Œå¼‚æ­¥çš„ç¯å¢ƒä¸‹ï¼Œæœ‰å¯èƒ½å‡ºç°å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‹¿åˆ°_instance=Noneè¿™ä¸ªå€¼ï¼Œå¯¼è‡´åˆ›å»ºå¤šä¸ªå®ä¾‹ï¼Œè§£å†³åŠæ³•å°±æ˜¯é€šè¿‡é”æ¥é™åˆ¶ã€‚ å¤šçº¿ç¨‹ python class Person(object): _lock = threading.Lock() @classmethod def get_instance(cls, *args, **kwargs): with cls._lock: if not hasattr(cls, '_instance'): cls._instance = cls(*args, **kwargs) return cls._instance å¼‚æ­¥ python class Person(object): _lock = asyncio.Lock() @classmethod def get_instance(cls, *args, **kwargs): async with cls._lock: if not hasattr(cls, '_instance'): cls._instance = cls(*args, **kwargs) return cls._instance ","date":"2025-10-19","objectID":"/posts/design/:1:1","series":["Python æŠ€å·§"],"tags":["Python","è®¾è®¡æ¨¡å¼"],"title":"Python è®¾è®¡æ¨¡å¼","uri":"/posts/design/#å®ç°æ–¹å¼"},{"categories":null,"content":" äº‹ä»¶å¾ªç¯","date":"2025-10-19","objectID":"/posts/async/:1:0","series":["Python æŠ€å·§"],"tags":["Python","å¼‚æ­¥","asyncio"],"title":"Python å¼‚æ­¥ç¼–ç¨‹","uri":"/posts/async/#äº‹ä»¶å¾ªç¯"},{"categories":null,"content":" è·å–å½“å‰äº‹ä»¶å¾ªç¯ æ–¹æ³• é€‚ç”¨åœºæ™¯ æ˜¯å¦è¦æ±‚åç¨‹ä¸­è¿è¡Œ Python 3.10+ è¡Œä¸º asyncio.get_running_loop() åœ¨åç¨‹/ä»»åŠ¡ä¸­è·å–å½“å‰è¿è¡Œçš„äº‹ä»¶å¾ªç¯ âœ… å¿…é¡»åœ¨äº‹ä»¶å¾ªç¯ä¸­è°ƒç”¨ âœ… æ¨è æŠ›é”™å¦‚æœæ²¡æœ‰è¿è¡Œçš„ loop asyncio.get_event_loop() æ—©æœŸé€šç”¨æ–¹å¼ âŒ å¯åœ¨åŒæ­¥ä»£ç ä¸­ç”¨ âš ï¸ ä¸æ¨èæ–°é¡¹ç›®ç”¨ è‡ªåŠ¨åˆ›å»ºäº‹ä»¶å¾ªç¯ï¼ˆæ—§è¡Œä¸ºï¼‰ å®˜æ–¹æ¨èï¼ˆPython 3.10+ï¼‰ åœ¨å¼‚æ­¥ä»£ç ä¸­ï¼Œä¼˜å…ˆä½¿ç”¨ï¼šasyncio.get_running_loop() åœ¨åŒæ­¥ä»£ç ä¸­ï¼Œç”¨ asyncio.new_event_loop() æ˜¾å¼åˆ›å»ºï¼Œå¹¶ç”¨ asyncio.run() ç®¡ç†äº‹ä»¶å¾ªç¯ python import asyncio async def my_async_task(): await asyncio.sleep(1) print(\"ä»»åŠ¡å®Œæˆ\") def main(): # åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶å¾ªç¯ loop = asyncio.new_event_loop() # å¯é€‰ï¼šå°†å…¶è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹é»˜è®¤äº‹ä»¶å¾ªç¯ asyncio.set_event_loop(loop) try: # æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ç›´åˆ°å®Œæˆ loop.run_until_complete(my_async_task()) finally: # æœ€åå…³é—­äº‹ä»¶å¾ªç¯ loop.close() if __name__ == \"__main__\": main() ","date":"2025-10-19","objectID":"/posts/async/:1:1","series":["Python æŠ€å·§"],"tags":["Python","å¼‚æ­¥","asyncio"],"title":"Python å¼‚æ­¥ç¼–ç¨‹","uri":"/posts/async/#è·å–å½“å‰äº‹ä»¶å¾ªç¯"},{"categories":null,"content":" æœ€åŸºæœ¬çš„è£…é¥°å™¨ python def simple_decorator(func): def wrapper(*args, **kwargs): print(\"Before the function runs.\") func(*args, **kwargs) print(\"After the function runs.\") return wrapper def say_hello(): print(\"Hello!\") decorated = simple_decorator(say_hello) decorated() è¾“å‡ºï¼š python Before the function runs. Hello! After the function runs. ","date":"2025-10-19","objectID":"/posts/decorator/:1:0","series":["Python æŠ€å·§"],"tags":["Python","è£…é¥°å™¨"],"title":"Python è£…é¥°å™¨","uri":"/posts/decorator/#æœ€åŸºæœ¬çš„è£…é¥°å™¨"},{"categories":null,"content":" è¯­æ³•ç³–ä¸Šä¾‹å¯ä»¥ç®€åŒ–ä¸ºï¼š python @simple_decorator def say_hello(): print(\"Hello!\") say_hello() ä½¿ç”¨ @decorator_name ç­‰ä»·äºï¼šsay_hello = simple_decorator(say_hello) ","date":"2025-10-19","objectID":"/posts/decorator/:2:0","series":["Python æŠ€å·§"],"tags":["Python","è£…é¥°å™¨"],"title":"Python è£…é¥°å™¨","uri":"/posts/decorator/#è¯­æ³•ç³–"},{"categories":null,"content":" å¸¦å‚æ•°çš„è£…é¥°å™¨ python def repeat(n): def decorator(func): def wrapper(*args, **kwargs): for _ in range(n): func(*args, **kwargs) return wrapper return decorator @repeat(3) def greet(): print(\"Hi!\") greet() ","date":"2025-10-19","objectID":"/posts/decorator/:3:0","series":["Python æŠ€å·§"],"tags":["Python","è£…é¥°å™¨"],"title":"Python è£…é¥°å™¨","uri":"/posts/decorator/#å¸¦å‚æ•°çš„è£…é¥°å™¨"},{"categories":null,"content":" ç±»è£…é¥°å™¨ ç±»è£…é¥°å™¨å¯ä½¿ç”¨ç±»çš„å®ä¾‹å±æ€§è½»æ¾ä¿å­˜çŠ¶æ€ï¼Œå¯ä»¥æ›´å¥½ç»„ç»‡å¤æ‚é€»è¾‘ã€‚ python class Decorator: def __init__(self, func): self.func = func def __call__(self, *args, **kwargs): print(\"Before call\") result = self.func(*args, **kwargs) print(\"After call\") return result @Decorator def greet(name): print(f\"Hello, {name}\") greet(\"Alice\") ","date":"2025-10-19","objectID":"/posts/decorator/:4:0","series":["Python æŠ€å·§"],"tags":["Python","è£…é¥°å™¨"],"title":"Python è£…é¥°å™¨","uri":"/posts/decorator/#ç±»è£…é¥°å™¨"},{"categories":null,"content":" ç±»æˆå‘˜å‡½æ•°è£…é¥°å™¨ è¦è®© Python è£…é¥°å™¨è£…é¥° ç±»çš„æˆå‘˜å‡½æ•° å¹¶è·å–åˆ°å®ƒçš„ selfï¼Œéœ€è¦è®©è£…é¥°å™¨çš„ wrapper æ¥å—å¹¶ä¼ é€’ self å‚æ•° python import functools def my_decorator(func): @functools.wraps(func) def wrapper(self, *args, **kwargs): # æ³¨æ„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ self print(f\"[DEBUG] Before calling {func.__name__}\") result = func(self, *args, **kwargs) # ä¿ç•™ self print(f\"[DEBUG] After calling {func.__name__}\") return result return wrapper ","date":"2025-10-19","objectID":"/posts/decorator/:4:1","series":["Python æŠ€å·§"],"tags":["Python","è£…é¥°å™¨"],"title":"Python è£…é¥°å™¨","uri":"/posts/decorator/#ç±»æˆå‘˜å‡½æ•°è£…é¥°å™¨"},{"categories":null,"content":" ä½¿ç”¨ functools.wraps ä½¿ç”¨è£…é¥°å™¨ä¼šä¸¢å¤±åŸå‡½æ•°çš„å…ƒä¿¡æ¯ï¼Œå¦‚ __name__ã€__doc__ï¼Œå¯ä»¥é€šè¿‡ functools.wraps ä¿®å¤ã€‚ python from functools import wraps def decorator(func): @wraps(func) def wrapper(*args, **kwargs): return func(*args, **kwargs) return wrapper å¦åˆ™: python @decorator def foo(): \"\"\"This is foo.\"\"\" pass print(foo.__name__) # é»˜è®¤ä¼šè¾“å‡º wrapper è€Œä¸æ˜¯ foo ","date":"2025-10-19","objectID":"/posts/decorator/:5:0","series":["Python æŠ€å·§"],"tags":["Python","è£…é¥°å™¨"],"title":"Python è£…é¥°å™¨","uri":"/posts/decorator/#ä½¿ç”¨-functoolswraps"},{"categories":null,"content":"åˆ°åº•éœ€è¦å¤šå°‘ç®—åŠ›æ‰èƒ½éƒ¨ç½²ä¸€ä¸ªæ¨¡å‹ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„é—®é¢˜ã€‚æˆ‘ä»¬å°±ä»è®­ç»ƒå’Œæ¨ç†ä¸¤ä¸ªåœºæ™¯ï¼Œåˆ†æä¸€ä¸‹å¦‚ä½•ä¼°è®¡æ¨¡å‹æ‰€éœ€è¦çš„æ˜¾å­˜ã€‚ ","date":"2025-08-22","objectID":"/posts/llm_vram/:0:0","series":["LLM"],"tags":[],"title":"ä¼°ç®—æ¨¡å‹éœ€è¦çš„æ˜¾å­˜","uri":"/posts/llm_vram/#"},{"categories":null,"content":" è®­ç»ƒè®­ç»ƒæ˜¾å­˜å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å››éƒ¨åˆ†ï¼š æ¨¡å‹æƒé‡ï¼šå–å†³äºå­˜å‚¨çš„ç²¾åº¦ï¼Œå¸¸è§çš„ BF16 å’Œ FP16 å ç”¨å¤§å°ä¸º 2B æ¢¯åº¦ï¼šåå‘ä¼ æ’­è®¡ç®—çš„æ¢¯åº¦ï¼Œå’Œæƒé‡ä¸€æ ·å¸¸è§æƒ…å†µä¸‹å ç”¨ 2B ä¼˜åŒ–å™¨çŠ¶æ€ï¼šå¸¸è§çš„ Adam ä¼šä¸ºæ¯ä¸ªå‚æ•°éƒ½ä¿å­˜å®ƒçš„ Momentumã€Variance å’Œ Master weightsï¼Œç²¾åº¦ä¸º FP32 æ‰€ä»¥æ€»è®¡ 12B ä¸­é—´æ¿€æ´»å€¼ï¼šç®€å•æ¥è¯´å°±æ˜¯ä¸ºäº†è®¡ç®—åå‘ä¼ æ’­çš„æ¢¯åº¦ï¼Œéœ€è¦æŠŠå‰å‘è®¡ç®—çš„ä¸­é—´å€¼å­˜å‚¨èµ·æ¥ï¼Œå…·ä½“è®¡ç®—è§ä¸‹æ–‡ã€‚ å› æ­¤ä½¿ç”¨ AdamW ä¼˜åŒ–å™¨ + æ··åˆç²¾åº¦è®­ç»ƒçš„ç»éªŒå…¬å¼ä¸ºï¼š VRAMtrainâ‰ˆ20Ã—N(Bytes) \\text{VRAM}_{train} \\approx 20 \\times N (Bytes) VRAMtrainâ€‹â‰ˆ20Ã—N(Bytes) ä»¥ 70B çš„æ¨¡å‹ä¸ºä¾‹ï¼Œè®­ç»ƒæ˜¾å­˜éœ€è¦ $\\approx 70 \\times 10^9 \\times 20 \\text{Bytes} = 1400 \\text{GB}$ ï¼Œ80GB çš„ A100 éœ€è¦è‡³å°‘ 18 å¼ å¹¶è¡Œè®­ç»ƒã€‚ ","date":"2025-08-22","objectID":"/posts/llm_vram/:1:0","series":["LLM"],"tags":[],"title":"ä¼°ç®—æ¨¡å‹éœ€è¦çš„æ˜¾å­˜","uri":"/posts/llm_vram/#è®­ç»ƒ"},{"categories":null,"content":" æ¨ç†æ¨ç†åªéœ€è¦å­˜æ¨¡å‹çš„æƒé‡ï¼ˆä¸è€ƒè™‘ KVCache çš„æƒ…å†µï¼‰ï¼š VRAMinferâ‰ˆ2Ã—N(Bytes) \\text{VRAM}_{infer} \\approx 2 \\times N (Bytes) VRAMinferâ€‹â‰ˆ2Ã—N(Bytes)å¦‚æœæ˜¯ 4-bit é‡åŒ–ï¼š VRAMinferâ‰ˆ0.5Ã—N(Bytes) \\text{VRAM}_{infer} \\approx 0.5 \\times N (Bytes) VRAMinferâ€‹â‰ˆ0.5Ã—N(Bytes)è€ƒè™‘ KVCache åŠ é€Ÿæ¨ç†çš„æƒ…å†µä¸‹ï¼Œå¦‚æœç²¾åº¦ä¸º FP16ï¼Œé‚£ä¹ˆé¢å¤–éœ€è¦ï¼š VRAMKVCacheâ‰ˆbÃ—sÃ—lÃ—hÃ—2(Bytes) \\text{VRAM}_{KVCache} \\approx b \\times s \\times l \\times h \\times 2 (Bytes) VRAMKVCacheâ€‹â‰ˆbÃ—sÃ—lÃ—hÃ—2(Bytes) åœ¨é•¿åºåˆ—æ¨ç†ä¸­ï¼Œ KVCache å æ®æ˜¾å­˜éå¸¸å¤§ã€‚ç¤ºä¾‹ï¼šLLaMA-7B (hidden_size=4096, layers=32)ï¼Œbatch=1, seq_len=32k â†’ KV Cache â‰ˆ 32k Ã— 32 Ã— 2 Ã— 4096 Ã— 2 â‰ˆ 8 GBã€‚ seq_len=128k çš„æƒ…å†µä¸‹ä»…ä»… KV Cache ä¼šåˆ° 32 GB+ã€‚ ","date":"2025-08-22","objectID":"/posts/llm_vram/:2:0","series":["LLM"],"tags":[],"title":"ä¼°ç®—æ¨¡å‹éœ€è¦çš„æ˜¾å­˜","uri":"/posts/llm_vram/#æ¨ç†"},{"categories":null,"content":" ä¸­é—´æ¿€æ´»å€¼åˆ†æ","date":"2025-08-22","objectID":"/posts/llm_vram/:3:0","series":["LLM"],"tags":[],"title":"ä¼°ç®—æ¨¡å‹éœ€è¦çš„æ˜¾å­˜","uri":"/posts/llm_vram/#ä¸­é—´æ¿€æ´»å€¼åˆ†æ"},{"categories":null,"content":" ä»€ä¹ˆæ˜¯æ¿€æ´»å€¼è¿™é‡Œçš„æ¿€æ´»å€¼å’Œæ¿€æ´»å‡½æ•°æ²¡æœ‰å•¥å…³ç³»ï¼Œä»¥ä¸€ä¸ªå››ä¸ª Linear çš„æ¨¡å‹ç»“æ„ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚å…¶å‰å‘ä¼ æ’­å’ŒæŸå¤±å‡½æ•°çš„å…¬å¼å¦‚ä¸‹æ‰€ç¤ºï¼š x1=W1x+b1x2=W2x1+b2x3=W3x2+b3x4=W4x3+b4l=(yâˆ’x4)2 \\begin{split} x_1 \u0026= W_1 x + b_1 \\\\ x_2 \u0026= W_2 x_1 + b_2 \\\\ x_3 \u0026= W_3 x_2 + b_3 \\\\ x_4 \u0026= W_4 x_3 + b_4 \\\\ l \u0026= (y - x_4)^2 \\end{split} x1â€‹x2â€‹x3â€‹x4â€‹lâ€‹=W1â€‹x+b1â€‹=W2â€‹x1â€‹+b2â€‹=W3â€‹x2â€‹+b3â€‹=W4â€‹x3â€‹+b4â€‹=(yâˆ’x4â€‹)2â€‹ åœ¨è¯¥å…¬å¼ä¸­ï¼š$x$Â å’ŒÂ $y$Â ä¸ºæ•°æ®çš„ç‰¹å¾å’Œæ ‡ç­¾ï¼›$W_1$ã€$b_1$ã€$W_2$ã€$b_2$ã€$W_3$ã€$b_3$ã€$W_4$ã€$b_4$Â ä¸ºå››ä¸ª Linear å±‚çš„æƒé‡å’Œåç½®ï¼›$x_1$ã€x$_2$ã€$x_3$ã€$x_4$Â éƒ½æ˜¯è®¡ç®—è¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€ã€‚åå‘ä¼ æ’­è¿‡ç¨‹ä¸­è¦å¯¹æƒé‡è¿›è¡Œæ›´æ–°ï¼Œä¹Ÿå°±æ˜¯æ±‚æŸå¤±ç›¸å¯¹äºÂ $W_1$ã€$W_2$ã€$W_3$ã€$W_4$Â çš„åå¯¼ï¼ŒæŒ‰ç…§é“¾å¼æ±‚å¯¼æ³•åˆ™å¾—åˆ°å…¬å¼å¦‚ä¸‹ï¼š âˆ‚lâˆ‚W4=âˆ‚lâˆ‚x4â‹…âˆ‚x4âˆ‚W4=[âˆ’2(yâˆ’x4)]â‹…x3âˆ‚lâˆ‚W3=âˆ‚lâˆ‚x4â‹…âˆ‚x4âˆ‚x3â‹…âˆ‚x3âˆ‚W3=[[âˆ’2(yâˆ’x4)]â‹…W4]â‹…x2âˆ‚lâˆ‚W2=âˆ‚lâˆ‚x4â‹…âˆ‚x4âˆ‚x3â‹…âˆ‚x3âˆ‚x2â‹…âˆ‚x2âˆ‚W2=[[âˆ’2(yâˆ’x4)]â‹…W4â‹…W3]â‹…x1âˆ‚lâˆ‚W1=âˆ‚lâˆ‚x4â‹…âˆ‚x4âˆ‚x3â‹…âˆ‚x3âˆ‚x2â‹…âˆ‚x2âˆ‚x1â‹…âˆ‚x1âˆ‚W1=[[âˆ’2(yâˆ’x4)]â‹…W4â‹…W3â‹…W2]â‹…x \\begin{split} \\frac{\\partial l}{\\partial W_4} \u0026= \\frac{\\partial l}{\\partial x_4} \\cdot \\frac{\\partial x_4}{\\partial W_4} = \\Bigg[ -2(y-x_4)\\Bigg] \\cdot x_3 \\\\ \\frac{\\partial l}{\\partial W_3} \u0026= \\frac{\\partial l}{\\partial x_4} \\cdot \\frac{\\partial x_4}{\\partial x_3} \\cdot \\frac{\\partial x_3}{\\partial W_3} = \\Bigg[ [-2(y-x_4)] \\cdot W_4 \\Bigg] \\cdot x_2 \\\\ \\frac{\\partial l}{\\partial W_2} \u0026= \\frac{\\partial l}{\\partial x_4} \\cdot \\frac{\\partial x_4}{\\partial x_3} \\cdot \\frac{\\partial x_3}{\\partial x_2} \\cdot \\frac{\\partial x_2}{\\partial W_2} = \\Bigg[ [-2(y-x_4)] \\cdot W_4 \\cdot W_3 \\Bigg] \\cdot x_1 \\\\ \\frac{\\partial l}{\\partial W_1} \u0026= \\frac{\\partial l}{\\partial x_4} \\cdot \\frac{\\partial x_4}{\\partial x_3} \\cdot \\frac{\\partial x_3}{\\partial x_2} \\cdot \\frac{\\partial x_2}{\\partial x_1} \\cdot \\frac{\\partial x_1}{\\partial W_1} = \\Bigg[ [-2(y-x_4)] \\cdot W_4 \\cdot W_3 \\cdot W_2 \\Bigg] \\cdot x \\\\ \\end{split} âˆ‚W4â€‹âˆ‚lâ€‹âˆ‚W3â€‹âˆ‚lâ€‹âˆ‚W2â€‹âˆ‚lâ€‹âˆ‚W1â€‹âˆ‚lâ€‹â€‹=âˆ‚x4â€‹âˆ‚lâ€‹â‹…âˆ‚W4â€‹âˆ‚x4â€‹â€‹=[âˆ’2(yâˆ’x4â€‹)]â‹…x3â€‹=âˆ‚x4â€‹âˆ‚lâ€‹â‹…âˆ‚x3â€‹âˆ‚x4â€‹â€‹â‹…âˆ‚W3â€‹âˆ‚x3â€‹â€‹=[[âˆ’2(yâˆ’x4â€‹)]â‹…W4â€‹]â‹…x2â€‹=âˆ‚x4â€‹âˆ‚lâ€‹â‹…âˆ‚x3â€‹âˆ‚x4â€‹â€‹â‹…âˆ‚x2â€‹âˆ‚x3â€‹â€‹â‹…âˆ‚W2â€‹âˆ‚x2â€‹â€‹=[[âˆ’2(yâˆ’x4â€‹)]â‹…W4â€‹â‹…W3â€‹]â‹…x1â€‹=âˆ‚x4â€‹âˆ‚lâ€‹â‹…âˆ‚x3â€‹âˆ‚x4â€‹â€‹â‹…âˆ‚x2â€‹âˆ‚x3â€‹â€‹â‹…âˆ‚x1â€‹âˆ‚x2â€‹â€‹â‹…âˆ‚W1â€‹âˆ‚x1â€‹â€‹=[[âˆ’2(yâˆ’x4â€‹)]â‹…W4â€‹â‹…W3â€‹â‹…W2â€‹]â‹…xâ€‹å¯¹ä¸Šé¢è¿™å››ä¸ªæƒé‡çŸ©é˜µçš„é“¾å¼æ±‚å¯¼å…¬å¼æ‰¾ä¸€ä¸‹è§„å¾‹ï¼Œå¯ä»¥å‘ç°å¯¹äºæƒé‡çŸ©é˜µÂ $W_i$Â çš„æ¢¯åº¦åœ¨è®¡ç®—æ—¶ä¸»è¦æœ‰ä¸¤é¡¹ï¼š ç¬¬ä¸€é¡¹æ˜¯ä¸Šè¿°å…¬å¼ä¸­ä½¿ç”¨ç‰¹åˆ«å¤§çš„ä¸­æ‹¬å·æ‰©èµ·æ¥çš„éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†æ˜¯ç¬¬Â i+1Â å±‚åä¼ å›æ¥çš„å€¼ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¬¦å·Â $i+1$Â æ¥è¡¨ç¤ºè¿™ä¸€é¡¹ï¼› å¦ä¸€é¡¹åˆ™æ˜¯ç¬¬Â $iâˆ’1$Â å±‚è®¡ç®—å‡ºæ¥çš„ä¸­é—´å€¼ï¼Œä½¿ç”¨ç¬¦å·Â $x_{iâˆ’1}$Â æ¥è¡¨ç¤ºï¼› é‚£ä¹ˆå¯¹äºÂ $W_i$Â çš„æ¢¯åº¦è®¡ç®—å…¬å¼å°±å˜ä¸ºäº†Â $\\frac{\\partial l}{\\partial W_i} = l_{i+1} \\cdot x_{i-1}$ï¼Œè¿™é‡Œçš„Â $l_{i+1}$Â æ˜¯ç¬¬ $i+1$Â å±‚åä¼ è¿‡æ¥çš„ï¼Œæ‰€ä»¥è®¡ç®—ç¬¬Â $i$Â å±‚çš„æ¢¯åº¦æ—¶åªéœ€è¦åšä¸€æ¬¡çŸ©é˜µä¹˜æ³•å³å¯ã€‚è¿™é‡Œçš„Â $x_{iâˆ’1}$Â æ­£æ˜¯åœ¨å‰å‘ä¼ æ’­æ—¶è®¡ç®—å‡ºæ¥çš„ä¸­é—´çŠ¶æ€ï¼Œæ¯”è¾ƒå®˜æ–¹çš„æœ¯è¯­ä¸ºÂ ä¸­é—´æ¿€æ´»å€¼ã€‚ ","date":"2025-08-22","objectID":"/posts/llm_vram/:3:1","series":["LLM"],"tags":[],"title":"ä¼°ç®—æ¨¡å‹éœ€è¦çš„æ˜¾å­˜","uri":"/posts/llm_vram/#ä»€ä¹ˆæ˜¯æ¿€æ´»å€¼"},{"categories":null,"content":" æ˜¾å­˜åˆ†æ transformer ç»“æ„è¿™é‡ŒæŠŠ transformer å±‚åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ MHA å±‚ï¼Œä¸€éƒ¨åˆ†æ˜¯ FFN å±‚ã€‚ä¸‹é¢åˆ†åˆ«å†™ä¸€ä¸‹è¿™ä¸¤éƒ¨åˆ†çš„å…¬å¼ã€‚ä¸€èˆ¬çš„èµ„æ–™ä¸­å…³äº transformer çš„å…¬å¼ä»…å†™ä¸»è¦çš„éƒ¨åˆ†ï¼Œåƒdropoutã€normalizeã€æ¿€æ´»å‡½æ•°éƒ½ä¼šè¢«çœç•¥ï¼Œä½†æ˜¯è¿™é‡Œç”±äºéœ€è¦åˆ†æä¸­é—´æ¿€æ´»å€¼çš„æ˜¾å­˜ï¼Œæ‰€ä»¥ä¼šæŠŠæ•´ä¸ª transformer çš„æ‰€æœ‰æ“ä½œéƒ½ä½“ç°åˆ°å…¬å¼ä¸­ï¼Œå¦‚ä¸‹ã€‚ MHA å±‚çš„å…¬å¼å¦‚ä¸‹ï¼š Q=xâ‹…WQ,K=xâ‹…Wk,V=xâ‹…Wvxself=Dropout[softmax(Qâ‹…KTd)]â‹…Vxattn=LN[Dropout(xselfâ‹…wo)+x] \\begin{equation}\\begin{split} Q \u0026= x \\cdot W_Q, \\quad K = x \\cdot W_k, \\quad V = x \\cdot W_v \\\\ x_{\\text{self}} \u0026= \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\cdot V \\\\ x_{\\text{attn}} \u0026= \\text{LN}\\Big[ \\text{Dropout}\\big(x_{\\text{self}} \\cdot w_o \\big) + x \\Big] \\end{split}\\end{equation} Qxselfâ€‹xattnâ€‹â€‹=xâ‹…WQâ€‹,K=xâ‹…Wkâ€‹,V=xâ‹…Wvâ€‹=Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]â‹…V=LN[Dropout(xselfâ€‹â‹…woâ€‹)+x]â€‹â€‹â€‹FFN å±‚çš„å…¬å¼å¦‚ä¸‹ï¼š xffn=GeLU(xattnâ‹…Wff1)â‹…Wff2xo=LN[Dropout(xffn)+xattn] \\begin{equation}\\begin{split} x_{\\text{ffn}} \u0026= \\text{GeLU}(x_{\\text{attn}} \\cdot W_{\\text{ff1}}) \\cdot W_{\\text{ff2}} \\\\ x_o \u0026= \\text{LN}\\Big[\\text{Dropout}\\big(x_{\\text{ffn}} \\big) + x_{\\text{attn}} \\Big] \\end{split}\\end{equation} xffnâ€‹xoâ€‹â€‹=GeLU(xattnâ€‹â‹…Wff1â€‹)â‹…Wff2â€‹=LN[Dropout(xffnâ€‹)+xattnâ€‹]â€‹â€‹â€‹æ€»çš„æ¥è¯´ï¼ŒMHA å±‚çš„è¾“å…¥ä¸ºÂ $x$ï¼Œè¾“å‡ºä¸ºÂ $x_{attn}$ï¼›FFN å±‚çš„è¾“å…¥ä¸ºÂ $x_{attn}$ï¼Œè¾“å‡ºä¸ºÂ $x_o$ï¼› tranformer çš„ä¸­é—´æ¿€æ´»å€¼åˆ†æé¦–å…ˆå®šä¹‰å‡ ä¸ªç¬¦å·ï¼š bï¼šè¡¨ç¤ºbatch_sizeï¼› sï¼šè¡¨ç¤ºseq_lengthï¼Œä¸ºæ–‡æœ¬é•¿åº¦ï¼› hï¼šè¡¨ç¤ºhidden_dimï¼Œä¸ºéšè—å±‚çš„ç»´åº¦ï¼› aï¼šè¡¨ç¤ºå¤šå¤´æ³¨æ„åŠ›ä¸­æœ‰å¤šä¸ªå¤´ï¼› haï¼šè¡¨ç¤ºhidden_dim_per_headï¼Œä¸ºå¤šå¤´æ³¨æ„åŠ›ä¸­æ¯ä¸ªå¤´çš„éšè—å±‚ç»´åº¦ï¼› å¦å¤–ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶ä¸€èˆ¬éƒ½æœ‰Â haâˆ—a=hÂ æˆç«‹ã€‚ MHA å±‚éœ€è¦ä¿å­˜çš„æ¿€æ´»å€¼ï¼Œä»¥åŠæ¯ä¸ªæ¿€æ´»å€¼çš„å¤§å°ï¼š Q=xâ‹…WQ:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚K=xâ‹…Wk:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚V=xâ‹…Wv:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Qâ‹…KT:ç»´åº¦ä¸ºÂ [b,a,s,s],å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚softmax(QTKd):ç»´åº¦ä¸ºÂ [b,a,s,s],å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚Dropout[softmax(Qâ‹…KTd)]:ç»´åº¦ä¸ºÂ [b,a,s,s],DropoutÂ å±‚å¤§å°ä¸ºÂ bas2Â å­—èŠ‚xself=Dropout[softmax(Qâ‹…KTd)]â‹…V:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚xselfâ‹…Wo:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Dropout(xselfâ‹…wo):ç»´åº¦ä¸ºÂ [b,s,h],DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚xattn=LN[Dropout(xselfâ‹…wo)+x]:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚ \\begin{alignat}{10} Q = x \\cdot W_Q \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ K = x \\cdot W_k \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ V = x \\cdot W_v \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ Q \\cdot K^T \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{å¤§å°ä¸º } 2bas^2 \\text{ å­—èŠ‚} \\\\ \\text{softmax}(\\frac{Q^T K}{\\sqrt{d}}) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{å¤§å°ä¸º } 2bas^2 \\text{ å­—èŠ‚} \\\\ \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{Dropout å±‚å¤§å°ä¸º } bas^2 \\text{ å­—èŠ‚} \\\\ x_{\\text{self}} = \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\cdot V \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ x_{\\text{self}} \\cdot W_o \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ \\text{Dropout}\\big(x_{\\text{self} \\cdot w_o} \\big) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{Dropout å±‚å¤§å°ä¸º } bsh \\text{ å­—èŠ‚} \\\\ x_{\\text{attn}} = \\text{LN}\\Big[ \\text{Dropout}\\big(x_{\\text{self}} \\cdot w_o \\big) + x \\Big] \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\end{alignat} Q=xâ‹…WQâ€‹K=xâ‹…Wkâ€‹V=xâ‹…Wvâ€‹Qâ‹…KTsoftmax(dâ€‹QTKâ€‹)Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]xselfâ€‹=Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]â‹…Vxselfâ€‹â‹…Woâ€‹Dropout(xselfâ‹…woâ€‹â€‹)xattnâ€‹=LN[Dropout(xselfâ€‹â‹…woâ€‹)+x]â€‹:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],â€‹å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚DropoutÂ å±‚å¤§å°ä¸ºÂ bas2Â å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚â€‹â€‹FFN å±‚éœ€è¦ä¿å­˜çš„æ¿€æ´»å€¼ï¼Œä»¥åŠæ¯ä¸ªæ¿€æ´»å€¼çš„å¤§å°ï¼š xattnâ‹…Wff1:ç»´åº¦ä¸ºÂ [b,s,4h],å¤§å°ä¸ºÂ 8bshÂ å­—èŠ‚GeLU(xattnâ‹…Wff1):ç»´åº¦ä¸ºÂ [b,s,4h],å¤§å°ä¸ºÂ 8bshÂ å­—èŠ‚xffn=GeLU(xattnâ‹…Wff1)â‹…Wff2:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Dropout(xffn):ç»´åº¦ä¸ºÂ [b,s,h],DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚LN[Dropout(xffn)+xattn]:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚ \\begin{alignat}{2} x_{\\text{attn}} \\cdot W_{\\text{ff1}} \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, 4h], \u0026\\text{å¤§å°ä¸º } 8bsh \\text{ å­—èŠ‚} \\\\ \\text{GeLU} (x_{\\text{attn}} \\cdot W_{\\text{ff1}}) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º","date":"2025-08-22","objectID":"/posts/llm_vram/:3:2","series":["LLM"],"tags":[],"title":"ä¼°ç®—æ¨¡å‹éœ€è¦çš„æ˜¾å­˜","uri":"/posts/llm_vram/#æ˜¾å­˜åˆ†æ"},{"categories":null,"content":" æ˜¾å­˜åˆ†æ transformer ç»“æ„è¿™é‡ŒæŠŠ transformer å±‚åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ MHA å±‚ï¼Œä¸€éƒ¨åˆ†æ˜¯ FFN å±‚ã€‚ä¸‹é¢åˆ†åˆ«å†™ä¸€ä¸‹è¿™ä¸¤éƒ¨åˆ†çš„å…¬å¼ã€‚ä¸€èˆ¬çš„èµ„æ–™ä¸­å…³äº transformer çš„å…¬å¼ä»…å†™ä¸»è¦çš„éƒ¨åˆ†ï¼Œåƒdropoutã€normalizeã€æ¿€æ´»å‡½æ•°éƒ½ä¼šè¢«çœç•¥ï¼Œä½†æ˜¯è¿™é‡Œç”±äºéœ€è¦åˆ†æä¸­é—´æ¿€æ´»å€¼çš„æ˜¾å­˜ï¼Œæ‰€ä»¥ä¼šæŠŠæ•´ä¸ª transformer çš„æ‰€æœ‰æ“ä½œéƒ½ä½“ç°åˆ°å…¬å¼ä¸­ï¼Œå¦‚ä¸‹ã€‚ MHA å±‚çš„å…¬å¼å¦‚ä¸‹ï¼š Q=xâ‹…WQ,K=xâ‹…Wk,V=xâ‹…Wvxself=Dropout[softmax(Qâ‹…KTd)]â‹…Vxattn=LN[Dropout(xselfâ‹…wo)+x] \\begin{equation}\\begin{split} Q \u0026= x \\cdot W_Q, \\quad K = x \\cdot W_k, \\quad V = x \\cdot W_v \\\\ x_{\\text{self}} \u0026= \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\cdot V \\\\ x_{\\text{attn}} \u0026= \\text{LN}\\Big[ \\text{Dropout}\\big(x_{\\text{self}} \\cdot w_o \\big) + x \\Big] \\end{split}\\end{equation} Qxselfâ€‹xattnâ€‹â€‹=xâ‹…WQâ€‹,K=xâ‹…Wkâ€‹,V=xâ‹…Wvâ€‹=Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]â‹…V=LN[Dropout(xselfâ€‹â‹…woâ€‹)+x]â€‹â€‹â€‹FFN å±‚çš„å…¬å¼å¦‚ä¸‹ï¼š xffn=GeLU(xattnâ‹…Wff1)â‹…Wff2xo=LN[Dropout(xffn)+xattn] \\begin{equation}\\begin{split} x_{\\text{ffn}} \u0026= \\text{GeLU}(x_{\\text{attn}} \\cdot W_{\\text{ff1}}) \\cdot W_{\\text{ff2}} \\\\ x_o \u0026= \\text{LN}\\Big[\\text{Dropout}\\big(x_{\\text{ffn}} \\big) + x_{\\text{attn}} \\Big] \\end{split}\\end{equation} xffnâ€‹xoâ€‹â€‹=GeLU(xattnâ€‹â‹…Wff1â€‹)â‹…Wff2â€‹=LN[Dropout(xffnâ€‹)+xattnâ€‹]â€‹â€‹â€‹æ€»çš„æ¥è¯´ï¼ŒMHA å±‚çš„è¾“å…¥ä¸ºÂ $x$ï¼Œè¾“å‡ºä¸ºÂ $x_{attn}$ï¼›FFN å±‚çš„è¾“å…¥ä¸ºÂ $x_{attn}$ï¼Œè¾“å‡ºä¸ºÂ $x_o$ï¼› tranformer çš„ä¸­é—´æ¿€æ´»å€¼åˆ†æé¦–å…ˆå®šä¹‰å‡ ä¸ªç¬¦å·ï¼š bï¼šè¡¨ç¤ºbatch_sizeï¼› sï¼šè¡¨ç¤ºseq_lengthï¼Œä¸ºæ–‡æœ¬é•¿åº¦ï¼› hï¼šè¡¨ç¤ºhidden_dimï¼Œä¸ºéšè—å±‚çš„ç»´åº¦ï¼› aï¼šè¡¨ç¤ºå¤šå¤´æ³¨æ„åŠ›ä¸­æœ‰å¤šä¸ªå¤´ï¼› haï¼šè¡¨ç¤ºhidden_dim_per_headï¼Œä¸ºå¤šå¤´æ³¨æ„åŠ›ä¸­æ¯ä¸ªå¤´çš„éšè—å±‚ç»´åº¦ï¼› å¦å¤–ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶ä¸€èˆ¬éƒ½æœ‰Â haâˆ—a=hÂ æˆç«‹ã€‚ MHA å±‚éœ€è¦ä¿å­˜çš„æ¿€æ´»å€¼ï¼Œä»¥åŠæ¯ä¸ªæ¿€æ´»å€¼çš„å¤§å°ï¼š Q=xâ‹…WQ:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚K=xâ‹…Wk:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚V=xâ‹…Wv:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Qâ‹…KT:ç»´åº¦ä¸ºÂ [b,a,s,s],å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚softmax(QTKd):ç»´åº¦ä¸ºÂ [b,a,s,s],å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚Dropout[softmax(Qâ‹…KTd)]:ç»´åº¦ä¸ºÂ [b,a,s,s],DropoutÂ å±‚å¤§å°ä¸ºÂ bas2Â å­—èŠ‚xself=Dropout[softmax(Qâ‹…KTd)]â‹…V:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚xselfâ‹…Wo:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Dropout(xselfâ‹…wo):ç»´åº¦ä¸ºÂ [b,s,h],DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚xattn=LN[Dropout(xselfâ‹…wo)+x]:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚ \\begin{alignat}{10} Q = x \\cdot W_Q \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ K = x \\cdot W_k \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ V = x \\cdot W_v \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ Q \\cdot K^T \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{å¤§å°ä¸º } 2bas^2 \\text{ å­—èŠ‚} \\\\ \\text{softmax}(\\frac{Q^T K}{\\sqrt{d}}) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{å¤§å°ä¸º } 2bas^2 \\text{ å­—èŠ‚} \\\\ \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{Dropout å±‚å¤§å°ä¸º } bas^2 \\text{ å­—èŠ‚} \\\\ x_{\\text{self}} = \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\cdot V \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ x_{\\text{self}} \\cdot W_o \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ \\text{Dropout}\\big(x_{\\text{self} \\cdot w_o} \\big) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{Dropout å±‚å¤§å°ä¸º } bsh \\text{ å­—èŠ‚} \\\\ x_{\\text{attn}} = \\text{LN}\\Big[ \\text{Dropout}\\big(x_{\\text{self}} \\cdot w_o \\big) + x \\Big] \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\end{alignat} Q=xâ‹…WQâ€‹K=xâ‹…Wkâ€‹V=xâ‹…Wvâ€‹Qâ‹…KTsoftmax(dâ€‹QTKâ€‹)Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]xselfâ€‹=Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]â‹…Vxselfâ€‹â‹…Woâ€‹Dropout(xselfâ‹…woâ€‹â€‹)xattnâ€‹=LN[Dropout(xselfâ€‹â‹…woâ€‹)+x]â€‹:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],â€‹å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚DropoutÂ å±‚å¤§å°ä¸ºÂ bas2Â å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚â€‹â€‹FFN å±‚éœ€è¦ä¿å­˜çš„æ¿€æ´»å€¼ï¼Œä»¥åŠæ¯ä¸ªæ¿€æ´»å€¼çš„å¤§å°ï¼š xattnâ‹…Wff1:ç»´åº¦ä¸ºÂ [b,s,4h],å¤§å°ä¸ºÂ 8bshÂ å­—èŠ‚GeLU(xattnâ‹…Wff1):ç»´åº¦ä¸ºÂ [b,s,4h],å¤§å°ä¸ºÂ 8bshÂ å­—èŠ‚xffn=GeLU(xattnâ‹…Wff1)â‹…Wff2:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Dropout(xffn):ç»´åº¦ä¸ºÂ [b,s,h],DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚LN[Dropout(xffn)+xattn]:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚ \\begin{alignat}{2} x_{\\text{attn}} \\cdot W_{\\text{ff1}} \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, 4h], \u0026\\text{å¤§å°ä¸º } 8bsh \\text{ å­—èŠ‚} \\\\ \\text{GeLU} (x_{\\text{attn}} \\cdot W_{\\text{ff1}}) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º","date":"2025-08-22","objectID":"/posts/llm_vram/:3:2","series":["LLM"],"tags":[],"title":"ä¼°ç®—æ¨¡å‹éœ€è¦çš„æ˜¾å­˜","uri":"/posts/llm_vram/#transformer-ç»“æ„"},{"categories":null,"content":" æ˜¾å­˜åˆ†æ transformer ç»“æ„è¿™é‡ŒæŠŠ transformer å±‚åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ MHA å±‚ï¼Œä¸€éƒ¨åˆ†æ˜¯ FFN å±‚ã€‚ä¸‹é¢åˆ†åˆ«å†™ä¸€ä¸‹è¿™ä¸¤éƒ¨åˆ†çš„å…¬å¼ã€‚ä¸€èˆ¬çš„èµ„æ–™ä¸­å…³äº transformer çš„å…¬å¼ä»…å†™ä¸»è¦çš„éƒ¨åˆ†ï¼Œåƒdropoutã€normalizeã€æ¿€æ´»å‡½æ•°éƒ½ä¼šè¢«çœç•¥ï¼Œä½†æ˜¯è¿™é‡Œç”±äºéœ€è¦åˆ†æä¸­é—´æ¿€æ´»å€¼çš„æ˜¾å­˜ï¼Œæ‰€ä»¥ä¼šæŠŠæ•´ä¸ª transformer çš„æ‰€æœ‰æ“ä½œéƒ½ä½“ç°åˆ°å…¬å¼ä¸­ï¼Œå¦‚ä¸‹ã€‚ MHA å±‚çš„å…¬å¼å¦‚ä¸‹ï¼š Q=xâ‹…WQ,K=xâ‹…Wk,V=xâ‹…Wvxself=Dropout[softmax(Qâ‹…KTd)]â‹…Vxattn=LN[Dropout(xselfâ‹…wo)+x] \\begin{equation}\\begin{split} Q \u0026= x \\cdot W_Q, \\quad K = x \\cdot W_k, \\quad V = x \\cdot W_v \\\\ x_{\\text{self}} \u0026= \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\cdot V \\\\ x_{\\text{attn}} \u0026= \\text{LN}\\Big[ \\text{Dropout}\\big(x_{\\text{self}} \\cdot w_o \\big) + x \\Big] \\end{split}\\end{equation} Qxselfâ€‹xattnâ€‹â€‹=xâ‹…WQâ€‹,K=xâ‹…Wkâ€‹,V=xâ‹…Wvâ€‹=Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]â‹…V=LN[Dropout(xselfâ€‹â‹…woâ€‹)+x]â€‹â€‹â€‹FFN å±‚çš„å…¬å¼å¦‚ä¸‹ï¼š xffn=GeLU(xattnâ‹…Wff1)â‹…Wff2xo=LN[Dropout(xffn)+xattn] \\begin{equation}\\begin{split} x_{\\text{ffn}} \u0026= \\text{GeLU}(x_{\\text{attn}} \\cdot W_{\\text{ff1}}) \\cdot W_{\\text{ff2}} \\\\ x_o \u0026= \\text{LN}\\Big[\\text{Dropout}\\big(x_{\\text{ffn}} \\big) + x_{\\text{attn}} \\Big] \\end{split}\\end{equation} xffnâ€‹xoâ€‹â€‹=GeLU(xattnâ€‹â‹…Wff1â€‹)â‹…Wff2â€‹=LN[Dropout(xffnâ€‹)+xattnâ€‹]â€‹â€‹â€‹æ€»çš„æ¥è¯´ï¼ŒMHA å±‚çš„è¾“å…¥ä¸ºÂ $x$ï¼Œè¾“å‡ºä¸ºÂ $x_{attn}$ï¼›FFN å±‚çš„è¾“å…¥ä¸ºÂ $x_{attn}$ï¼Œè¾“å‡ºä¸ºÂ $x_o$ï¼› tranformer çš„ä¸­é—´æ¿€æ´»å€¼åˆ†æé¦–å…ˆå®šä¹‰å‡ ä¸ªç¬¦å·ï¼š bï¼šè¡¨ç¤ºbatch_sizeï¼› sï¼šè¡¨ç¤ºseq_lengthï¼Œä¸ºæ–‡æœ¬é•¿åº¦ï¼› hï¼šè¡¨ç¤ºhidden_dimï¼Œä¸ºéšè—å±‚çš„ç»´åº¦ï¼› aï¼šè¡¨ç¤ºå¤šå¤´æ³¨æ„åŠ›ä¸­æœ‰å¤šä¸ªå¤´ï¼› haï¼šè¡¨ç¤ºhidden_dim_per_headï¼Œä¸ºå¤šå¤´æ³¨æ„åŠ›ä¸­æ¯ä¸ªå¤´çš„éšè—å±‚ç»´åº¦ï¼› å¦å¤–ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶ä¸€èˆ¬éƒ½æœ‰Â haâˆ—a=hÂ æˆç«‹ã€‚ MHA å±‚éœ€è¦ä¿å­˜çš„æ¿€æ´»å€¼ï¼Œä»¥åŠæ¯ä¸ªæ¿€æ´»å€¼çš„å¤§å°ï¼š Q=xâ‹…WQ:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚K=xâ‹…Wk:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚V=xâ‹…Wv:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Qâ‹…KT:ç»´åº¦ä¸ºÂ [b,a,s,s],å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚softmax(QTKd):ç»´åº¦ä¸ºÂ [b,a,s,s],å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚Dropout[softmax(Qâ‹…KTd)]:ç»´åº¦ä¸ºÂ [b,a,s,s],DropoutÂ å±‚å¤§å°ä¸ºÂ bas2Â å­—èŠ‚xself=Dropout[softmax(Qâ‹…KTd)]â‹…V:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚xselfâ‹…Wo:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Dropout(xselfâ‹…wo):ç»´åº¦ä¸ºÂ [b,s,h],DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚xattn=LN[Dropout(xselfâ‹…wo)+x]:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚ \\begin{alignat}{10} Q = x \\cdot W_Q \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ K = x \\cdot W_k \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ V = x \\cdot W_v \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ Q \\cdot K^T \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{å¤§å°ä¸º } 2bas^2 \\text{ å­—èŠ‚} \\\\ \\text{softmax}(\\frac{Q^T K}{\\sqrt{d}}) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{å¤§å°ä¸º } 2bas^2 \\text{ å­—èŠ‚} \\\\ \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{Dropout å±‚å¤§å°ä¸º } bas^2 \\text{ å­—èŠ‚} \\\\ x_{\\text{self}} = \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\cdot V \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ x_{\\text{self}} \\cdot W_o \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ \\text{Dropout}\\big(x_{\\text{self} \\cdot w_o} \\big) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{Dropout å±‚å¤§å°ä¸º } bsh \\text{ å­—èŠ‚} \\\\ x_{\\text{attn}} = \\text{LN}\\Big[ \\text{Dropout}\\big(x_{\\text{self}} \\cdot w_o \\big) + x \\Big] \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\end{alignat} Q=xâ‹…WQâ€‹K=xâ‹…Wkâ€‹V=xâ‹…Wvâ€‹Qâ‹…KTsoftmax(dâ€‹QTKâ€‹)Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]xselfâ€‹=Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]â‹…Vxselfâ€‹â‹…Woâ€‹Dropout(xselfâ‹…woâ€‹â€‹)xattnâ€‹=LN[Dropout(xselfâ€‹â‹…woâ€‹)+x]â€‹:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],â€‹å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚DropoutÂ å±‚å¤§å°ä¸ºÂ bas2Â å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚â€‹â€‹FFN å±‚éœ€è¦ä¿å­˜çš„æ¿€æ´»å€¼ï¼Œä»¥åŠæ¯ä¸ªæ¿€æ´»å€¼çš„å¤§å°ï¼š xattnâ‹…Wff1:ç»´åº¦ä¸ºÂ [b,s,4h],å¤§å°ä¸ºÂ 8bshÂ å­—èŠ‚GeLU(xattnâ‹…Wff1):ç»´åº¦ä¸ºÂ [b,s,4h],å¤§å°ä¸ºÂ 8bshÂ å­—èŠ‚xffn=GeLU(xattnâ‹…Wff1)â‹…Wff2:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Dropout(xffn):ç»´åº¦ä¸ºÂ [b,s,h],DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚LN[Dropout(xffn)+xattn]:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚ \\begin{alignat}{2} x_{\\text{attn}} \\cdot W_{\\text{ff1}} \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, 4h], \u0026\\text{å¤§å°ä¸º } 8bsh \\text{ å­—èŠ‚} \\\\ \\text{GeLU} (x_{\\text{attn}} \\cdot W_{\\text{ff1}}) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º","date":"2025-08-22","objectID":"/posts/llm_vram/:3:2","series":["LLM"],"tags":[],"title":"ä¼°ç®—æ¨¡å‹éœ€è¦çš„æ˜¾å­˜","uri":"/posts/llm_vram/#tranformer-çš„ä¸­é—´æ¿€æ´»å€¼åˆ†æ"},{"categories":null,"content":" æ˜¾å­˜åˆ†æ transformer ç»“æ„è¿™é‡ŒæŠŠ transformer å±‚åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ MHA å±‚ï¼Œä¸€éƒ¨åˆ†æ˜¯ FFN å±‚ã€‚ä¸‹é¢åˆ†åˆ«å†™ä¸€ä¸‹è¿™ä¸¤éƒ¨åˆ†çš„å…¬å¼ã€‚ä¸€èˆ¬çš„èµ„æ–™ä¸­å…³äº transformer çš„å…¬å¼ä»…å†™ä¸»è¦çš„éƒ¨åˆ†ï¼Œåƒdropoutã€normalizeã€æ¿€æ´»å‡½æ•°éƒ½ä¼šè¢«çœç•¥ï¼Œä½†æ˜¯è¿™é‡Œç”±äºéœ€è¦åˆ†æä¸­é—´æ¿€æ´»å€¼çš„æ˜¾å­˜ï¼Œæ‰€ä»¥ä¼šæŠŠæ•´ä¸ª transformer çš„æ‰€æœ‰æ“ä½œéƒ½ä½“ç°åˆ°å…¬å¼ä¸­ï¼Œå¦‚ä¸‹ã€‚ MHA å±‚çš„å…¬å¼å¦‚ä¸‹ï¼š Q=xâ‹…WQ,K=xâ‹…Wk,V=xâ‹…Wvxself=Dropout[softmax(Qâ‹…KTd)]â‹…Vxattn=LN[Dropout(xselfâ‹…wo)+x] \\begin{equation}\\begin{split} Q \u0026= x \\cdot W_Q, \\quad K = x \\cdot W_k, \\quad V = x \\cdot W_v \\\\ x_{\\text{self}} \u0026= \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\cdot V \\\\ x_{\\text{attn}} \u0026= \\text{LN}\\Big[ \\text{Dropout}\\big(x_{\\text{self}} \\cdot w_o \\big) + x \\Big] \\end{split}\\end{equation} Qxselfâ€‹xattnâ€‹â€‹=xâ‹…WQâ€‹,K=xâ‹…Wkâ€‹,V=xâ‹…Wvâ€‹=Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]â‹…V=LN[Dropout(xselfâ€‹â‹…woâ€‹)+x]â€‹â€‹â€‹FFN å±‚çš„å…¬å¼å¦‚ä¸‹ï¼š xffn=GeLU(xattnâ‹…Wff1)â‹…Wff2xo=LN[Dropout(xffn)+xattn] \\begin{equation}\\begin{split} x_{\\text{ffn}} \u0026= \\text{GeLU}(x_{\\text{attn}} \\cdot W_{\\text{ff1}}) \\cdot W_{\\text{ff2}} \\\\ x_o \u0026= \\text{LN}\\Big[\\text{Dropout}\\big(x_{\\text{ffn}} \\big) + x_{\\text{attn}} \\Big] \\end{split}\\end{equation} xffnâ€‹xoâ€‹â€‹=GeLU(xattnâ€‹â‹…Wff1â€‹)â‹…Wff2â€‹=LN[Dropout(xffnâ€‹)+xattnâ€‹]â€‹â€‹â€‹æ€»çš„æ¥è¯´ï¼ŒMHA å±‚çš„è¾“å…¥ä¸ºÂ $x$ï¼Œè¾“å‡ºä¸ºÂ $x_{attn}$ï¼›FFN å±‚çš„è¾“å…¥ä¸ºÂ $x_{attn}$ï¼Œè¾“å‡ºä¸ºÂ $x_o$ï¼› tranformer çš„ä¸­é—´æ¿€æ´»å€¼åˆ†æé¦–å…ˆå®šä¹‰å‡ ä¸ªç¬¦å·ï¼š bï¼šè¡¨ç¤ºbatch_sizeï¼› sï¼šè¡¨ç¤ºseq_lengthï¼Œä¸ºæ–‡æœ¬é•¿åº¦ï¼› hï¼šè¡¨ç¤ºhidden_dimï¼Œä¸ºéšè—å±‚çš„ç»´åº¦ï¼› aï¼šè¡¨ç¤ºå¤šå¤´æ³¨æ„åŠ›ä¸­æœ‰å¤šä¸ªå¤´ï¼› haï¼šè¡¨ç¤ºhidden_dim_per_headï¼Œä¸ºå¤šå¤´æ³¨æ„åŠ›ä¸­æ¯ä¸ªå¤´çš„éšè—å±‚ç»´åº¦ï¼› å¦å¤–ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶ä¸€èˆ¬éƒ½æœ‰Â haâˆ—a=hÂ æˆç«‹ã€‚ MHA å±‚éœ€è¦ä¿å­˜çš„æ¿€æ´»å€¼ï¼Œä»¥åŠæ¯ä¸ªæ¿€æ´»å€¼çš„å¤§å°ï¼š Q=xâ‹…WQ:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚K=xâ‹…Wk:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚V=xâ‹…Wv:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Qâ‹…KT:ç»´åº¦ä¸ºÂ [b,a,s,s],å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚softmax(QTKd):ç»´åº¦ä¸ºÂ [b,a,s,s],å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚Dropout[softmax(Qâ‹…KTd)]:ç»´åº¦ä¸ºÂ [b,a,s,s],DropoutÂ å±‚å¤§å°ä¸ºÂ bas2Â å­—èŠ‚xself=Dropout[softmax(Qâ‹…KTd)]â‹…V:ç»´åº¦ä¸ºÂ [b,a,s,ha]=[b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚xselfâ‹…Wo:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Dropout(xselfâ‹…wo):ç»´åº¦ä¸ºÂ [b,s,h],DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚xattn=LN[Dropout(xselfâ‹…wo)+x]:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚ \\begin{alignat}{10} Q = x \\cdot W_Q \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ K = x \\cdot W_k \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ V = x \\cdot W_v \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ Q \\cdot K^T \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{å¤§å°ä¸º } 2bas^2 \\text{ å­—èŠ‚} \\\\ \\text{softmax}(\\frac{Q^T K}{\\sqrt{d}}) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{å¤§å°ä¸º } 2bas^2 \\text{ å­—èŠ‚} \\\\ \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, s], \u0026\\text{Dropout å±‚å¤§å°ä¸º } bas^2 \\text{ å­—èŠ‚} \\\\ x_{\\text{self}} = \\text{Dropout}\\Big[ \\text{softmax}\\big(\\frac{Q \\cdot K^T}{\\sqrt{d}} \\big) \\Big] \\cdot V \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, a, s, h_a] = [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ x_{\\text{self}} \\cdot W_o \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\\\ \\text{Dropout}\\big(x_{\\text{self} \\cdot w_o} \\big) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{Dropout å±‚å¤§å°ä¸º } bsh \\text{ å­—èŠ‚} \\\\ x_{\\text{attn}} = \\text{LN}\\Big[ \\text{Dropout}\\big(x_{\\text{self}} \\cdot w_o \\big) + x \\Big] \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, h], \u0026\\text{å¤§å°ä¸º } 2bsh \\text{ å­—èŠ‚} \\end{alignat} Q=xâ‹…WQâ€‹K=xâ‹…Wkâ€‹V=xâ‹…Wvâ€‹Qâ‹…KTsoftmax(dâ€‹QTKâ€‹)Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]xselfâ€‹=Dropout[softmax(dâ€‹Qâ‹…KTâ€‹)]â‹…Vxselfâ€‹â‹…Woâ€‹Dropout(xselfâ‹…woâ€‹â€‹)xattnâ€‹=LN[Dropout(xselfâ€‹â‹…woâ€‹)+x]â€‹:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,s],:ç»´åº¦ä¸ºÂ [b,a,s,haâ€‹]=[b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],:ç»´åº¦ä¸ºÂ [b,s,h],â€‹å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚å¤§å°ä¸ºÂ 2bas2Â å­—èŠ‚DropoutÂ å±‚å¤§å°ä¸ºÂ bas2Â å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚â€‹â€‹FFN å±‚éœ€è¦ä¿å­˜çš„æ¿€æ´»å€¼ï¼Œä»¥åŠæ¯ä¸ªæ¿€æ´»å€¼çš„å¤§å°ï¼š xattnâ‹…Wff1:ç»´åº¦ä¸ºÂ [b,s,4h],å¤§å°ä¸ºÂ 8bshÂ å­—èŠ‚GeLU(xattnâ‹…Wff1):ç»´åº¦ä¸ºÂ [b,s,4h],å¤§å°ä¸ºÂ 8bshÂ å­—èŠ‚xffn=GeLU(xattnâ‹…Wff1)â‹…Wff2:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚Dropout(xffn):ç»´åº¦ä¸ºÂ [b,s,h],DropoutÂ å±‚å¤§å°ä¸ºÂ bshÂ å­—èŠ‚LN[Dropout(xffn)+xattn]:ç»´åº¦ä¸ºÂ [b,s,h],å¤§å°ä¸ºÂ 2bshÂ å­—èŠ‚ \\begin{alignat}{2} x_{\\text{attn}} \\cdot W_{\\text{ff1}} \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º } [b, s, 4h], \u0026\\text{å¤§å°ä¸º } 8bsh \\text{ å­—èŠ‚} \\\\ \\text{GeLU} (x_{\\text{attn}} \\cdot W_{\\text{ff1}}) \\quad \u0026: \\quad \\text{ç»´åº¦ä¸º","date":"2025-08-22","objectID":"/posts/llm_vram/:3:2","series":["LLM"],"tags":[],"title":"ä¼°ç®—æ¨¡å‹éœ€è¦çš„æ˜¾å­˜","uri":"/posts/llm_vram/#embedding-å±‚å’Œè§£ç å±‚"},{"categories":null,"content":" Java SE","date":"2025-08-14","objectID":"/posts/java/:0:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#java-se"},{"categories":null,"content":" ç±»å‹è½¬æ¢ è¡¨è¾¾å¼ç»“æœçš„ç±»å‹=æœ€é«˜ç±»å‹ text byte,short,char -\u003e int -\u003e long -\u003e float -\u003e double char -\u003e int byte,short,charç›´æ¥è½¬æ¢ä¸ºintç±»å‹ java byte i = 1; short j = 30; byte i = 2 * i; // error short k = i + j; // error int k = i + j; // correct åªè¦å‚ä¸è¿ç®—ï¼Œå°±ä¼šæå‡åˆ°intç±»å‹ java byte i = 1; byte j = (byte)2 * (byte)i; // error byte j = (byte)(2 * i); å­—ç¬¦æ“ä½œ java char random_alpha = (char)('a' + rand.nextInt(25)); ","date":"2025-08-14","objectID":"/posts/java/:1:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#ç±»å‹è½¬æ¢"},{"categories":null,"content":" è¿ç®—ç¬¦ ä¸¤ä¸ªæ•´æ•°ç›¸é™¤è¿˜æ˜¯æ•´æ•° java int i = 5; int j = 2; float k = i / j; // k = 2 float k = (float)i / j; // k = 2.5 float k = 1.0 * i / j; // k = 2.5 èµ‹å€¼è¿ç®—ç¬¦å¸¦å¼ºåˆ¶è½¬æ¢ java double a = 10; int b = 30; a += b; // a = (double)(a + b) å‡å¦‚iå’Œjéƒ½æ˜¯byteç±»å‹ï¼Œé‚£ä¹ˆi += jä¸i = i + jç»“æœä¸åŒ i += jä¸­jæ²¡æœ‰å‚ä¸è¿ç®—ï¼Œè¿˜æ˜¯byteç±»å‹ i = i + jä¸­ï¼Œiå’Œjéƒ½å‚ä¸äº†è¿ç®—ï¼Œæå‡åˆ°intç±»å‹ï¼Œint-\u003ebyteéœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢ \u0026ä¸ç®¡å‰é¢æ˜¯å¦ä¸ºfalseï¼Œå…¨éƒ¨statementéƒ½ä¼šæ‰§è¡Œï¼›\u0026\u0026è‹¥é‡åˆ°falseï¼Œåé¢åˆ™ä¸æ‰§è¡Œ ","date":"2025-08-14","objectID":"/posts/java/:2:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#è¿ç®—ç¬¦"},{"categories":null,"content":" åˆ†æ”¯æ§åˆ¶","date":"2025-08-14","objectID":"/posts/java/:3:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#åˆ†æ”¯æ§åˆ¶"},{"categories":null,"content":" Switch è¡¨è¾¾å¼ç±»å‹åªèƒ½æ˜¯byteã€shortã€intã€charï¼ŒJDK5æ”¯æŒæšä¸¾ï¼ŒJDK7æ”¯æŒString java long variable = 100; switch(variable){ // error } æ ‡ç­¾ java OUT: for (int i = 0; i \u003c 100; i++){ for (j = i; j \u003c 100; j++){ if (j == 70){ continue OUT; } } } ","date":"2025-08-14","objectID":"/posts/java/:3:1","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#switch"},{"categories":null,"content":" æ•°ç»„ é™æ€åˆå§‹åŒ– java int[] arr1 = new int(){1, 2, 3, 4}; int[] arr2 = {1, 2, 3, 4}; int arr3[] = new int(){1, 2, 3, 4}; åŠ¨æ€åˆå§‹åŒ– java int[] arr_dynamic = new int[10]; å†…å­˜æ˜ åƒ æ ˆç©ºé—´ä¸­ï¼Œæ•°ç»„å˜é‡åå¯¹åº”æ•°ç»„å¤´å…ƒç´ å­˜å‚¨åœ°å€: arr_dynamic-\u003e[I@119d7047 å †ç©ºé—´ä¸­ï¼Œæ•°ç»„å†…çš„ä¸€ä¸ªä¸ªå…ƒç´ ä¾æ¬¡å­˜å‚¨: [I@119d7047å¼€å§‹ 0, 1, 2â€¦ Javaä¸­ï¼Œæ•°ç»„çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ä¸èƒ½åˆ é™¤å…ƒç´  åˆ›å»ºæ–°æ•°ç»„ï¼Œè·³è¿‡æŒ‡å®šå…ƒç´  æŠŠåˆ é™¤å…ƒç´ ç”¨ç‰¹å®šå­—ç¬¦æ›¿æ¢ ç”¨åˆ—è¡¨ ArrayList ","date":"2025-08-14","objectID":"/posts/java/:4:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æ•°ç»„"},{"categories":null,"content":" å‡½æ•°","date":"2025-08-14","objectID":"/posts/java/:5:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#å‡½æ•°"},{"categories":null,"content":" é‡è½½ åå­—ç›¸åŒï¼Œå½¢å‚ä¸åŒ å½¢å‚ä¸åŒæŒ‡ï¼šä¸ªæ•°ã€ç±»å‹ã€é¡ºåº ","date":"2025-08-14","objectID":"/posts/java/:5:1","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#é‡è½½"},{"categories":null,"content":" ç±»","date":"2025-08-14","objectID":"/posts/java/:6:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#ç±»"},{"categories":null,"content":" æ„é€ å™¨ å¦‚æœæ²¡æœ‰æŒ‡å®šæ„é€ å™¨ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆ å¦‚æœå®šä¹‰äº†æœ‰å‚æ•°çš„æ„é€ å™¨ï¼Œé»˜è®¤æ„é€ å™¨ä¸ä¼šç”Ÿæˆ å­ç±»çš„æ„é€ å™¨éƒ½ä¼šé»˜è®¤è°ƒç”¨çˆ¶ç±»æ„é€ å™¨ï¼Œå¹¶ä¸”è¿™æ˜¯å¿…é¡»çš„ java public class Father{ private Father(){} public Father(String name) {} } public class Son extends Father{ public Son(){ super(\"Java\"); } } ","date":"2025-08-14","objectID":"/posts/java/:6:1","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æ„é€ å™¨"},{"categories":null,"content":" Public ä¸€ä¸ªä»£ç æ–‡ä»¶ä¸­ï¼Œåªèƒ½æœ‰ä¸€ä¸ª public çš„ç±»ï¼Œå¹¶ä¸”ç±»åå’Œæ–‡ä»¶åç›¸åŒ java // Object.java public class Object { String name; int cost; } class Object_A{ } ","date":"2025-08-14","objectID":"/posts/java/:6:2","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#public"},{"categories":null,"content":" Static ç±»ä¸­çš„æˆå‘˜å˜é‡oræˆå‘˜å‡½æ•°ï¼Œåˆ†ä¸ºç±»å˜é‡orå®ä¾‹å˜é‡å’Œç±»å‡½æ•°orå®ä¾‹å‡½æ•° ç±»å˜é‡ï¼šæœ‰ static ä¿®é¥°ï¼Œæ‰€æœ‰ç±»å¯¹è±¡å…±äº«ã€‚ å®ä¾‹å˜é‡ï¼šæ—  static ä¿®é¥°ï¼Œå±äºæ¯ä¸ªå¯¹è±¡ã€‚ ç±»å˜é‡å¯ä»¥ç”¨ï¼šclass.variable è®¿é—®(æ¨è)ï¼Œä¹Ÿå¯ä»¥ç”¨ object.variable è®¿é—®ã€‚ å®ä¾‹å˜é‡åªèƒ½ç”¨ object.variable è®¿é—®ã€‚ å·¥å…·ç±»ä¸€èˆ¬ä¸å…è®¸å®ä¾‹åŒ– java public class Util{ private Util{} public static void PostHttp(){ } } é™æ€ä»£ç å—å¯ä»¥åœ¨ç±»åŠ è½½çš„æ—¶å€™æ‰§è¡Œï¼Œåªæ‰§è¡Œä¸€æ¬¡ï¼Œ java public class Util(){ public static int count; static { count = 1; } } é™æ€ä»£ç å— \u003e å®ä¾‹ä»£ç å— \u003e æ„é€ å™¨ ","date":"2025-08-14","objectID":"/posts/java/:6:3","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#static"},{"categories":null,"content":" æƒé™ä¿®é¥°ç¬¦ private: æœ¬ç±» ç¼ºçœ: æœ¬ç±»ã€åŒä¸€ä¸ª package çš„ç±» protected: æœ¬ç±»ã€åŒä¸€ä¸ª package çš„ä»»æ„ç±»ï¼Œä»»æ„ package çš„ public: æ‰€æœ‰ç±» ","date":"2025-08-14","objectID":"/posts/java/:6:4","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æƒé™ä¿®é¥°ç¬¦"},{"categories":null,"content":" ç»§æ‰¿ ä»»ä½•ç±»éƒ½æ˜¯ Object ç±»çš„å­ç±» Java é‡Œé¢çš„ç±»åªèƒ½å•ç»§æ‰¿ å­ç±»å¯ä»¥å’Œçˆ¶ç±»æœ‰ç›¸åŒçš„æˆå‘˜å˜é‡ï¼Œè®¿é—®éµå¾ªå°±è¿‘åŸåˆ™,å¯ä»¥é€šè¿‡super.variableè®¿é—®çˆ¶ç±»æˆå‘˜ã€‚ æ–¹æ³•é‡å†™ é€šè¿‡ Override æ³¨è§£æ£€æŸ¥é‡å†™æ–¹æ³•çš„æ ¼å¼ java public class Son extends Father{ @Override public void print(){} } é‡å†™æ–¹æ³•è®¿é—®æƒé™å¿…é¡»å¤§ç­‰äºçˆ¶ç±»æ–¹æ³•çš„æƒé™ ç§æœ‰ã€é™æ€æ–¹æ³•ä¸èƒ½è¢«é‡å†™ ","date":"2025-08-14","objectID":"/posts/java/:6:5","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#ç»§æ‰¿"},{"categories":null,"content":" ç»§æ‰¿ ä»»ä½•ç±»éƒ½æ˜¯ Object ç±»çš„å­ç±» Java é‡Œé¢çš„ç±»åªèƒ½å•ç»§æ‰¿ å­ç±»å¯ä»¥å’Œçˆ¶ç±»æœ‰ç›¸åŒçš„æˆå‘˜å˜é‡ï¼Œè®¿é—®éµå¾ªå°±è¿‘åŸåˆ™,å¯ä»¥é€šè¿‡super.variableè®¿é—®çˆ¶ç±»æˆå‘˜ã€‚ æ–¹æ³•é‡å†™ é€šè¿‡ Override æ³¨è§£æ£€æŸ¥é‡å†™æ–¹æ³•çš„æ ¼å¼ java public class Son extends Father{ @Override public void print(){} } é‡å†™æ–¹æ³•è®¿é—®æƒé™å¿…é¡»å¤§ç­‰äºçˆ¶ç±»æ–¹æ³•çš„æƒé™ ç§æœ‰ã€é™æ€æ–¹æ³•ä¸èƒ½è¢«é‡å†™ ","date":"2025-08-14","objectID":"/posts/java/:6:5","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æ–¹æ³•é‡å†™"},{"categories":null,"content":" å¤šæ€ ç¼–è¯‘çœ‹å·¦è¾¹ï¼Œè¿è¡Œçœ‹å³è¾¹å¤šæ€æŒ‡çš„æ˜¯æˆå‘˜æ–¹æ³•çš„å¤šæ€ï¼Œè€Œä¸æ˜¯æˆå‘˜å˜é‡ java People p1 = Teacher(); å‡å¦‚People p1 = Teacher()é‚£ä¹ˆp1.nameæ˜¯ People çš„æˆå‘˜å˜é‡ã€‚ é˜¶æ®µ çœ‹å“ªé‡Œ å†³å®šä»€ä¹ˆ ç¼–è¯‘é˜¶æ®µ å·¦è¾¹ èƒ½è°ƒç”¨å“ªäº›æ–¹æ³•ï¼ˆåŸºäºå¼•ç”¨ç±»å‹ï¼‰ è¿è¡Œé˜¶æ®µ å³è¾¹ å®é™…è°ƒç”¨å“ªä¸ªæ–¹æ³•ï¼ˆåŸºäºå®é™…å¯¹è±¡ç±»å‹ï¼‰ ","date":"2025-08-14","objectID":"/posts/java/:6:6","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#å¤šæ€"},{"categories":null,"content":" PackageÂ· åŒä¸€ä¸ª package ä¸‹çš„ç±»å¯ä»¥ç›´æ¥è®¿é—® å…¶ä»– package ä¸‹çš„ç±»éœ€è¦å¯¼å…¥ java import com.xilyfe.pkg.util.PostHttp; int res = PostHttp(); java.lang ä¸‹é¢çš„åŒ…ä¸éœ€è¦å¯¼å…¥ï¼Œå…¶ä»–éœ€è¦ ä¸åŒ package ä¸‹å¦‚æœæœ‰ç›¸åŒçš„å‡½æ•°/ç±»åï¼Œç¬¬äºŒä¸ªå¼€å§‹è°ƒç”¨éœ€è¦è·¯å¾„ java int res1 = PostHttp(); int res2 = com.xilyfe.pkg.http.PostHttp(); å¤šæ€ä¸‹ä¸èƒ½ä½¿ç”¨å­ç±»ç‹¬æœ‰çš„æˆå‘˜æ–¹æ³• è§£å†³æ–¹æ³•ï¼šå¼ºåˆ¶ç±»å‹è½¬æ¢åï¼Œä½¿ç”¨å­ç±»å¯¹è±¡ä½¿ç”¨æˆå‘˜æ–¹æ³• java People p1 = new Student(); p1.study(); // error Student s1 = (Student)p1; s1.study(); å¼ºåˆ¶ç±»å‹è½¬æ¢éœ€è¦æ³¨æ„ï¼šåªæœ‰å­ç±»å’Œçˆ¶ç±»å¯ä»¥ç›¸äº’è½¬åŒ– java public static void execute(People p){ if (p instanceof Student) p.study(); else if (p instanceof Teacher) p.teach(); } ","date":"2025-08-14","objectID":"/posts/java/:7:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#package"},{"categories":null,"content":" Final final class - ä¸å¯è¢«ç»§æ‰¿ final function - ä¸å¯è¢«é‡å†™ final variable - ä¸å¯è¢«ä¿®æ”¹ final ä¿®é¥°çš„å˜é‡åœ°å€ä¸èƒ½å˜ï¼Œä½†æ˜¯æŒ‡å‘çš„å¯¹è±¡å¯ä»¥å˜(ä¾‹å¦‚finalä¸€ä¸ªclassï¼Œé‡Œé¢çš„æˆå‘˜å˜é‡å¯ä»¥æ”¹å˜) ","date":"2025-08-14","objectID":"/posts/java/:7:1","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#final"},{"categories":null,"content":" æŠ½è±¡ç±» æŠ½è±¡ç±»ä¸ä¸€å®šæœ‰æŠ½è±¡æ–¹æ³•ï¼Œæœ‰æŠ½è±¡æ–¹æ³•ä¸€å®šæ˜¯æŠ½è±¡ç±» æŠ½è±¡ç±»ä¸èƒ½å®ä¾‹åŒ–ï¼Œåªèƒ½ç»§æ‰¿ ç»§æ‰¿äº†æŠ½è±¡ç±»ï¼Œå¿…é¡»å®ç°å…¨éƒ¨æŠ½è±¡æ–¹æ³•ï¼Œå¦åˆ™ä»–ä¹Ÿå¾—å®šä¹‰ä¸ºæŠ½è±¡ç±» ","date":"2025-08-14","objectID":"/posts/java/:7:2","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æŠ½è±¡ç±»"},{"categories":null,"content":" å†…éƒ¨ç±» æˆå‘˜å†…éƒ¨ç±» java public class Outer{ private String name = \"Outer\"; private static int age = 90; public class Inner{ private String name = \"Inner\"; private static int age = 80; private void test(){ String name = \"test\"; System.out.println(name); System.out.println(this.name); System.out.println(Outer.this.name); } } } public static void main(){ // æ–¹æ³•1 Outer.Inner inn = new Outer.new Inner(); // æ–¹æ³•2 Outer out = new Outer(); Outer.Inner inn = out.new Inner(); } JDK16ä¹‹åï¼Œæˆå‘˜å†…éƒ¨ç±»æ‰èƒ½å®šä¹‰é™æ€æˆå‘˜å˜é‡ é™æ€å†…éƒ¨ç±» java public class Outer{ private String name = \"Outer\"; private static int age = 90; public class Inner{ private String name = \"Inner\"; private static int age = 80; private static void test(){ String name = \"test\"; System.out.println(name); System.out.println(this.name); System.out.println(Outer.this.name); // System.out.println(Outer.this.age); } } } public static void main(){ Outer.Inner inn = new Outer.Inner(); } æŠ½è±¡å†…éƒ¨ç±» java abstract class Base{ public abstract void test(); } public static void main(){ Base a = new Base(){ @Override public void test(){ } } } ","date":"2025-08-14","objectID":"/posts/java/:7:3","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#å†…éƒ¨ç±»"},{"categories":null,"content":" æ¥å£ æ‰€æœ‰æˆå‘˜å˜é‡éƒ½æ˜¯å¸¸é‡ - æ³¨æ„å¤§å†™ æ‰€æœ‰æˆå‘˜å‡½æ•°éƒ½æ˜¯æŠ½è±¡å‡½æ•° æ— éœ€å£°æ˜ abstract æˆ–è€… final ","date":"2025-08-14","objectID":"/posts/java/:8:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æ¥å£"},{"categories":null,"content":" å®ç° å¯ä»¥å®ç°å¤šä¸ªæ¥å£ å¿…é¡»å®ç°æ¥å£ä¸­çš„å…¨éƒ¨å‡½æ•°ï¼Œå¦åˆ™è‡ªå·±éœ€è¦å®šä¹‰ä¸ºæŠ½è±¡ç±» java public class Imp implements A, B, C{} é«˜ç‰ˆæœ¬ JDK è¿˜æœ‰å…¶ä»–çš„å®ç°æ–¹å¼ default è™½ç„¶ä¸èƒ½å®ä¾‹åŒ– Interface è°ƒç”¨ default å‡½æ•°ï¼Œä½†æ˜¯å¯ä»¥åœ¨ Interface çš„å®ç°ç±»ä¸­è°ƒç”¨ã€‚ java interface A { default void function(){ // å¯ä»¥æœ‰å‡½æ•°ä½“ } } private ç”¨ private ä¿®é¥°ä¹‹åï¼Œæ¥å£å®ç°ä¹Ÿä¸èƒ½ä½¿ç”¨ï¼Œä¸»è¦ç”¨äº default æ–¹æ³•ä¸­ã€‚ java public interface MyInterface { // public default æ–¹æ³• default void sayHello() { greet(\"Hello\"); } default void sayHi() { greet(\"Hi\"); } // private æ–¹æ³•åªèƒ½è¢«æ¥å£å†…éƒ¨è°ƒç”¨ private void greet(String message) { System.out.println(message); } } static java interface A{ public static void function(){ // ... } } A.function(); ","date":"2025-08-14","objectID":"/posts/java/:8:1","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#å®ç°"},{"categories":null,"content":" å‡½æ•°å¼æ¥å£ å‡½æ•°å¼æ¥å£åœ¨ Java é‡ŒæŒ‡çš„æ˜¯ï¼šåªåŒ…å«ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œå®ƒæ˜¯ Lambda è¡¨è¾¾å¼çš„åŸºç¡€ã€‚ åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼ˆå¯ä»¥æœ‰å¤šä¸ª default æˆ– static æ–¹æ³•ï¼Œä½†æŠ½è±¡çš„åªèƒ½æœ‰ä¸€ä¸ªï¼‰ èƒ½ç”¨ Lambda è¡¨è¾¾å¼ æˆ– æ–¹æ³•å¼•ç”¨ æ¥åˆ›å»ºå®ƒçš„å®ä¾‹ java @FunctionalInterface interface MyPrinter { void print(String msg); // å”¯ä¸€æŠ½è±¡æ–¹æ³• } public class Demo { public static void main(String[] args) { // Lambda å®ç° MyPrinter p = msg -\u003e System.out.println(msg); p.print(\"Hello Functional Interface!\"); } } ","date":"2025-08-14","objectID":"/posts/java/:8:2","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#å‡½æ•°å¼æ¥å£"},{"categories":null,"content":" å¤šç»§æ‰¿ æ¥å£ä¸å‡½æ•°ä¸åŒï¼Œæ˜¯å¯ä»¥å¤šç»§æ‰¿çš„ java interface I1{} interface I2{} interface I3 extends I1, I2{} ç»§æ‰¿äº†çˆ¶ç±»ï¼Œåˆå®ç°äº†æ¥å£ï¼Œå¹¶ä¸”çˆ¶ç±»å’Œå‡ å£æœ‰åŒåçš„é»˜è®¤æ–¹æ³•ï¼Œé»˜è®¤ç”¨çˆ¶ç±»çš„ã€‚ä¸€ä¸ªç±»å®ç°äº†å¤šä¸ªæ¥å£ï¼Œå¹¶ä¸”æ¥å£å­˜åœ¨åŒåçš„é»˜è®¤æ–¹æ³•ï¼Œä¸å†²çªã€‚ ç±»ä¼˜å…ˆçº§å¤§äºæ¥å£ java class Parent { public void hello() { System.out.println(\"Hello from Parent\"); } } interface MyInterface { default void hello() { System.out.println(\"Hello from Interface\"); } } class Child extends Parent implements MyInterface { // ä¸éœ€è¦é‡å†™ hello æ–¹æ³• } public class Main { public static void main(String[] args) { new Child().hello(); // è¾“å‡ºï¼šHello from Parent } } å¤šä¸ªæ¥å£çš„é»˜è®¤æ–¹æ³•å†²çªï¼Œå®ç°ç±»é‡å†™å³å¯ java interface a{ default void print(){ //... } } interface b{ default void print(){ //... } } class c implements a, b{ @Override public void print(){ // å¯ä»¥é€‰æ‹©è°ƒç”¨æŸä¸€ä¸ªæ¥å£çš„é»˜è®¤æ–¹æ³•ï¼š A.super.print(); // æˆ– B.super.print(); } } ","date":"2025-08-14","objectID":"/posts/java/:8:3","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#å¤šç»§æ‰¿"},{"categories":null,"content":" æšä¸¾ æšä¸¾æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»ç¬¬ä¸€è¡Œæ˜¯æšä¸¾çš„ç±»å‹åé¢ä»»æ„éƒ½è¡Œï¼Œä¸ class ä¸€è‡´ java public enum Sex{ MALE, FEMALE } switch (sex){ case Sex.MALE: break; case Sex.FEMALE: break; } æšä¸¾å¦‚ä½•å®ç°çš„ java public final class Sex extends Enum\u003cSex\u003e{ public static final Sex MALE = new Sex(); public static final Sex FEMALE = new Sex(); private Sex(){} public static Sex[] values(){} public static Sex valueof(String){} } å°†æ¯ä¸€ä¸ªæšä¸¾ç±»å‹éƒ½å®šä¹‰ä¸ºä¸€ä¸ªå®ä¾‹åŒ–çš„ç±»å˜é‡ï¼Œè¿™æ ·å¤–éƒ¨å°±ä¸ç”¨å®ä¾‹åŒ–å°±èƒ½ä½¿ç”¨ ç¦ç”¨æ„é€ å‡½æ•°ï¼Œåªèƒ½åœ¨å†…éƒ¨å®ä¾‹åŒ– æŠ½è±¡æšä¸¾ç±» å‡å¦‚æšä¸¾ç±»ä¸­å®šä¹‰äº†æŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒä¸èƒ½è¢«å®ä¾‹åŒ– java public enum Animal{ Dog(){ @Override public void sing(){ //... } }, Cat(){ @Override public void sing(){ //... } } public abstract void sing(); } ","date":"2025-08-14","objectID":"/posts/java/:9:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æšä¸¾"},{"categories":null,"content":" å¸¸ç”¨API","date":"2025-08-14","objectID":"/posts/java/:10:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#å¸¸ç”¨api"},{"categories":null,"content":" String ä¸ c++ å’Œ python ä¸åŒï¼Œå­—ç¬¦ä¸²ä¸èƒ½é€šè¿‡ç´¢å¼•å–æŒ‡å®šä½ç½®å…ƒç´  java String name = \"java\"; System.out.println(name[0]); // error char[] name_arr = name.toCharArray(); System.out.println(name_arr[0]); // correct System.out.println(name.charAt(0)); // correct ä¸èƒ½ç”¨ == åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç›¸åŒï¼Œå› ä¸º String æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œ== æ¯”è¾ƒçš„æ˜¯åœ°å€ java String variable1 = \"java\"; String variable2 = \"python\"; System.out.println(variable1.equals(variable2)); å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜å¯¹è±¡ å¯¹å­—ç¬¦ä¸²è¿›è¡Œåˆå¹¶æ“ä½œï¼Œä¼šåœ¨å †å†…å­˜ä¸­åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œç„¶åå°†å˜é‡æŒ‡å‘å®ƒ ç”¨\"â€œå†™å‡ºçš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œéƒ½ä¼šå­˜å‚¨åˆ°å †åŒºçš„å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œç›¸åŒå†…å®¹åªä¿ç•™ä¸€ä»½ java String name_1 = \"java\"; char[] name_arr = {'j', 'a', 'v', 'a'}; String name_2 = new String(name_arr); ç¼–è¯‘ä¼˜åŒ– java String s1 = \"ab\"; String s2 = s1 + \"c\"; // å †åŒºåˆ›å»º2ä¸ªå¯¹è±¡ // ------------------------------------------- String s3 = \"a\" + \"b\" + \"c\"; // å †åŒºåˆ›å»ºä¸€ä¸ªå¯¹è±¡ ","date":"2025-08-14","objectID":"/posts/java/:10:1","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#string"},{"categories":null,"content":" Arrays java public static String toString(int arr[]); public static \u003cT\u003e[] copyOfRange(\u003cT\u003e[] arr, int sta, int end); // [sta, end) public static \u003cT\u003e[] copyOf(\u003cT\u003e[] arr, int length); // è¶…å‡ºè¡¥0 Arrays.setAll(arr, new IntToDoubleFunction() { @Override public double applyAsDouble(int value){ return prices[value] * 0.8; } }); public static \u003cT\u003e[] sort(\u003cT\u003e[] arr); è‡ªå®šä¹‰æ’åºè§„åˆ™ ç±»å®ç° Comparable æ¥å£ java class Student implements Comparable{ public int age; public double score; public String name; @Override public int compareTo(Student o){ if (score \u003e o.score) return 1; else if (score \u003c o.score) return -1; return 0; } } åœ¨ sort æ–¹æ³•å†…éƒ¨ï¼Œåˆ›å»ºæ¯”è¾ƒå™¨æ¥å£çš„åŒ¿åå†…éƒ¨ç±» java Arrays.sort(students, new Comparator\u003cStudent\u003e() { @Override public int compare(Student s1, Student s2){ return 0; } }); ","date":"2025-08-14","objectID":"/posts/java/:10:2","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#arrays"},{"categories":null,"content":" Arrays java public static String toString(int arr[]); public static [] copyOfRange([] arr, int sta, int end); // [sta, end) public static [] copyOf([] arr, int length); // è¶…å‡ºè¡¥0 Arrays.setAll(arr, new IntToDoubleFunction() { @Override public double applyAsDouble(int value){ return prices[value] * 0.8; } }); public static [] sort([] arr); è‡ªå®šä¹‰æ’åºè§„åˆ™ ç±»å®ç° Comparable æ¥å£ java class Student implements Comparable{ public int age; public double score; public String name; @Override public int compareTo(Student o){ if (score \u003e o.score) return 1; else if (score \u003c o.score) return -1; return 0; } } åœ¨ sort æ–¹æ³•å†…éƒ¨ï¼Œåˆ›å»ºæ¯”è¾ƒå™¨æ¥å£çš„åŒ¿åå†…éƒ¨ç±» java Arrays.sort(students, new Comparator() { @Override public int compare(Student s1, Student s2){ return 0; } }); ","date":"2025-08-14","objectID":"/posts/java/:10:2","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#è‡ªå®šä¹‰æ’åºè§„åˆ™"},{"categories":null,"content":" ObjectJava ä¸­æ‰€æœ‰ç±»éƒ½ç»§æ‰¿è‡ª Object ç±»ï¼Œå¯ä»¥ä½¿ç”¨å®ƒçš„ä¸€äº›æ–¹æ³• toString é»˜è®¤æƒ…å†µä¸‹ï¼ŒObject.toString()è¿”å›çš„æ˜¯ç±»ä¼¼com.xilyfe.java_1.Student@xxxxxxã€‚ å¯ä»¥é€šè¿‡é‡å†™ Class çš„ toStringæ–¹æ³•ä¿®æ”¹è¿”å›å€¼ã€‚ java public class Student { @Override public String toString(){ return \"Student\"; } } equals Object.equalså¯¹æ¯”çš„æ˜¯ä¸¤ä¸ª Object å¯¹è±¡çš„åœ°å€ å¯ä»¥é‡å†™æ¥è‡ªå®šä¹‰æ¯”è¾ƒè§„åˆ™ java public class Student { @Override public boolean equals(const Student\u0026 stu){ if (this == stu) return true; if (stu == null || getClass() != stu.getClass()) return false; return Objects.equals(this.name, stu.name); } } Objects.equals(a, b)å’Œa.equals(b)çš„åŒºåˆ«åœ¨äºï¼Œå‰è€…ä¼šå¯¹ a å…ˆè¿›è¡Œéç©ºåˆ¤æ–­é¿å…æŠ¥é”™ã€‚ clone java public class User implements Cloneable { @Override protected Object clone() throws CloneNotSupportedException { return super.clone(); } } å®ç° Cloneable æ˜¯ä¸€ä¸ªæ ‡è¯†ï¼Œæ„å‘³ç€è¿™ä¸ªç±»å¯ä»¥å…‹éš† Object.cloneé»˜è®¤æ˜¯æ½œå…‹éš†ï¼Œæ„å‘³ç€å®ƒåªæ˜¯æ‹·è´ä¸€ä¸ªåœ°å€ï¼Œå¦‚æœå˜åŒ–äº†å…‹éš†çš„å¯¹è±¡ä¹Ÿä¼šå˜ã€‚ è¦å®ç°æ·±å…‹éš†å°±éœ€è¦å¯¹é™¤äº†åŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²çš„å…¶ä»–å¯¹è±¡ä¹‹å¤–åˆ›å»ºæ–°å¯¹è±¡ java public class User implements Cloneable { @Override protected Object clone() throws CloneNotSupportedException { User u2 = (User)super.clone(); u2.scores = us.scores.clone(); return u2; } } ","date":"2025-08-14","objectID":"/posts/java/:10:3","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#object"},{"categories":null,"content":" ObjectJava ä¸­æ‰€æœ‰ç±»éƒ½ç»§æ‰¿è‡ª Object ç±»ï¼Œå¯ä»¥ä½¿ç”¨å®ƒçš„ä¸€äº›æ–¹æ³• toString é»˜è®¤æƒ…å†µä¸‹ï¼ŒObject.toString()è¿”å›çš„æ˜¯ç±»ä¼¼com.xilyfe.java_1.Student@xxxxxxã€‚ å¯ä»¥é€šè¿‡é‡å†™ Class çš„ toStringæ–¹æ³•ä¿®æ”¹è¿”å›å€¼ã€‚ java public class Student { @Override public String toString(){ return \"Student\"; } } equals Object.equalså¯¹æ¯”çš„æ˜¯ä¸¤ä¸ª Object å¯¹è±¡çš„åœ°å€ å¯ä»¥é‡å†™æ¥è‡ªå®šä¹‰æ¯”è¾ƒè§„åˆ™ java public class Student { @Override public boolean equals(const Student\u0026 stu){ if (this == stu) return true; if (stu == null || getClass() != stu.getClass()) return false; return Objects.equals(this.name, stu.name); } } Objects.equals(a, b)å’Œa.equals(b)çš„åŒºåˆ«åœ¨äºï¼Œå‰è€…ä¼šå¯¹ a å…ˆè¿›è¡Œéç©ºåˆ¤æ–­é¿å…æŠ¥é”™ã€‚ clone java public class User implements Cloneable { @Override protected Object clone() throws CloneNotSupportedException { return super.clone(); } } å®ç° Cloneable æ˜¯ä¸€ä¸ªæ ‡è¯†ï¼Œæ„å‘³ç€è¿™ä¸ªç±»å¯ä»¥å…‹éš† Object.cloneé»˜è®¤æ˜¯æ½œå…‹éš†ï¼Œæ„å‘³ç€å®ƒåªæ˜¯æ‹·è´ä¸€ä¸ªåœ°å€ï¼Œå¦‚æœå˜åŒ–äº†å…‹éš†çš„å¯¹è±¡ä¹Ÿä¼šå˜ã€‚ è¦å®ç°æ·±å…‹éš†å°±éœ€è¦å¯¹é™¤äº†åŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²çš„å…¶ä»–å¯¹è±¡ä¹‹å¤–åˆ›å»ºæ–°å¯¹è±¡ java public class User implements Cloneable { @Override protected Object clone() throws CloneNotSupportedException { User u2 = (User)super.clone(); u2.scores = us.scores.clone(); return u2; } } ","date":"2025-08-14","objectID":"/posts/java/:10:3","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#tostring"},{"categories":null,"content":" ObjectJava ä¸­æ‰€æœ‰ç±»éƒ½ç»§æ‰¿è‡ª Object ç±»ï¼Œå¯ä»¥ä½¿ç”¨å®ƒçš„ä¸€äº›æ–¹æ³• toString é»˜è®¤æƒ…å†µä¸‹ï¼ŒObject.toString()è¿”å›çš„æ˜¯ç±»ä¼¼com.xilyfe.java_1.Student@xxxxxxã€‚ å¯ä»¥é€šè¿‡é‡å†™ Class çš„ toStringæ–¹æ³•ä¿®æ”¹è¿”å›å€¼ã€‚ java public class Student { @Override public String toString(){ return \"Student\"; } } equals Object.equalså¯¹æ¯”çš„æ˜¯ä¸¤ä¸ª Object å¯¹è±¡çš„åœ°å€ å¯ä»¥é‡å†™æ¥è‡ªå®šä¹‰æ¯”è¾ƒè§„åˆ™ java public class Student { @Override public boolean equals(const Student\u0026 stu){ if (this == stu) return true; if (stu == null || getClass() != stu.getClass()) return false; return Objects.equals(this.name, stu.name); } } Objects.equals(a, b)å’Œa.equals(b)çš„åŒºåˆ«åœ¨äºï¼Œå‰è€…ä¼šå¯¹ a å…ˆè¿›è¡Œéç©ºåˆ¤æ–­é¿å…æŠ¥é”™ã€‚ clone java public class User implements Cloneable { @Override protected Object clone() throws CloneNotSupportedException { return super.clone(); } } å®ç° Cloneable æ˜¯ä¸€ä¸ªæ ‡è¯†ï¼Œæ„å‘³ç€è¿™ä¸ªç±»å¯ä»¥å…‹éš† Object.cloneé»˜è®¤æ˜¯æ½œå…‹éš†ï¼Œæ„å‘³ç€å®ƒåªæ˜¯æ‹·è´ä¸€ä¸ªåœ°å€ï¼Œå¦‚æœå˜åŒ–äº†å…‹éš†çš„å¯¹è±¡ä¹Ÿä¼šå˜ã€‚ è¦å®ç°æ·±å…‹éš†å°±éœ€è¦å¯¹é™¤äº†åŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²çš„å…¶ä»–å¯¹è±¡ä¹‹å¤–åˆ›å»ºæ–°å¯¹è±¡ java public class User implements Cloneable { @Override protected Object clone() throws CloneNotSupportedException { User u2 = (User)super.clone(); u2.scores = us.scores.clone(); return u2; } } ","date":"2025-08-14","objectID":"/posts/java/:10:3","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#equals"},{"categories":null,"content":" ObjectJava ä¸­æ‰€æœ‰ç±»éƒ½ç»§æ‰¿è‡ª Object ç±»ï¼Œå¯ä»¥ä½¿ç”¨å®ƒçš„ä¸€äº›æ–¹æ³• toString é»˜è®¤æƒ…å†µä¸‹ï¼ŒObject.toString()è¿”å›çš„æ˜¯ç±»ä¼¼com.xilyfe.java_1.Student@xxxxxxã€‚ å¯ä»¥é€šè¿‡é‡å†™ Class çš„ toStringæ–¹æ³•ä¿®æ”¹è¿”å›å€¼ã€‚ java public class Student { @Override public String toString(){ return \"Student\"; } } equals Object.equalså¯¹æ¯”çš„æ˜¯ä¸¤ä¸ª Object å¯¹è±¡çš„åœ°å€ å¯ä»¥é‡å†™æ¥è‡ªå®šä¹‰æ¯”è¾ƒè§„åˆ™ java public class Student { @Override public boolean equals(const Student\u0026 stu){ if (this == stu) return true; if (stu == null || getClass() != stu.getClass()) return false; return Objects.equals(this.name, stu.name); } } Objects.equals(a, b)å’Œa.equals(b)çš„åŒºåˆ«åœ¨äºï¼Œå‰è€…ä¼šå¯¹ a å…ˆè¿›è¡Œéç©ºåˆ¤æ–­é¿å…æŠ¥é”™ã€‚ clone java public class User implements Cloneable { @Override protected Object clone() throws CloneNotSupportedException { return super.clone(); } } å®ç° Cloneable æ˜¯ä¸€ä¸ªæ ‡è¯†ï¼Œæ„å‘³ç€è¿™ä¸ªç±»å¯ä»¥å…‹éš† Object.cloneé»˜è®¤æ˜¯æ½œå…‹éš†ï¼Œæ„å‘³ç€å®ƒåªæ˜¯æ‹·è´ä¸€ä¸ªåœ°å€ï¼Œå¦‚æœå˜åŒ–äº†å…‹éš†çš„å¯¹è±¡ä¹Ÿä¼šå˜ã€‚ è¦å®ç°æ·±å…‹éš†å°±éœ€è¦å¯¹é™¤äº†åŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²çš„å…¶ä»–å¯¹è±¡ä¹‹å¤–åˆ›å»ºæ–°å¯¹è±¡ java public class User implements Cloneable { @Override protected Object clone() throws CloneNotSupportedException { User u2 = (User)super.clone(); u2.scores = us.scores.clone(); return u2; } } ","date":"2025-08-14","objectID":"/posts/java/:10:3","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#clone"},{"categories":null,"content":" StringBuilder å¯¹å­—ç¬¦ä¸²è¿›è¡Œå¤§é‡æ“ä½œï¼Œä½¿ç”¨ StringBuilder è€Œä¸æ˜¯ String String æ¯æ¬¡æ“ä½œå­—ç¬¦ä¸²éƒ½ä¼šåˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œè€Œ StringBuilder ä¼šåœ¨åŸå¯¹è±¡ä¸Šè¿›è¡Œæ“ä½œï¼Œæ•ˆç‡é«˜éå¸¸å¤š StringBuilder å’Œ StringBuffer åŒºåˆ«æ˜¯åè€…æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ ","date":"2025-08-14","objectID":"/posts/java/:10:4","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#stringbuilder"},{"categories":null,"content":" StringJoiner å¯ä»¥æŒ‡å®šåˆ†éš”ç¬¦ï¼Œå‰ç¼€å’Œåç¼€ï¼šStringJoiner sj = new StringJoiner(delimiter, prefix, suffix) é€šè¿‡sj.add()æ·»åŠ å…ƒç´  ","date":"2025-08-14","objectID":"/posts/java/:10:5","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#stringjoiner"},{"categories":null,"content":" BigDecimal ä½¿ç”¨åŸºæœ¬æµ®ç‚¹ç±»å‹æ“ä½œæµ®ç‚¹æ•°å­˜åœ¨å±€é™æ€§ï¼Œæ²¡æ³•å¤„ç†ç±»ä¼¼0.1+0.2=0.3,å¯¹äºæµ®ç‚¹æ•°è¿ç®—é€ä½è®¡ç®—æ›´å‡†ç¡® java double f1 = 0.1; double f2 = 0.2; // æ–¹æ³•1 BigDecimal bd1 = new BigDecimal(Double.toString(f1)); // æ¨èæ–¹æ³• BigDecimal bd2 = BigDecimal.valueof(f1); æ³¨æ„ä½¿ç”¨new BigDecimal(String)è€Œä¸æ˜¯new BigDecimal(Double),åè€…è¿˜å­˜åœ¨ç²¾åº¦é—®é¢˜ java BigDecimal bd1 = BigDecimal.valueof(0.1); BigDecimal bd2 = BigDecimal.valueof(0.2); BigDecimal bd3 = bd1.add(bd2); BigDecimal bd4 = bd1.multiply(bd2); BigDecimal bd5 = bd1.divide(bd2); æ³¨æ„ BigDecimal è¿›è¡Œé™¤æ³•æ—¶å€™å¦‚æœæ— æ³•æ•´é™¤ä¼šæŠ¥é”™ï¼Œéœ€è¦æŒ‡å®šç²¾åº¦å’Œèˆå…¥æ–¹å¼ã€‚BigDeciaml bd6 = bd1.divide(bd2, 4, RoundingMode.HALF_UP); ","date":"2025-08-14","objectID":"/posts/java/:10:6","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#bigdecimal"},{"categories":null,"content":" æ—¶é—´ç®¡ç†","date":"2025-08-14","objectID":"/posts/java/:11:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æ—¶é—´ç®¡ç†"},{"categories":null,"content":" Date java // è·å–å½“å‰æ—¥æœŸ Date d = new Date(); // è·å–æ¯«ç§’æ•° long time = d.getTime(); // æ¯«ç±³è½¬æ—¥æœŸ long t2 = time + 2 * 1000; Date d2 = new Date(t2); Date d3 = new Date(); d3.setTime(t2); ","date":"2025-08-14","objectID":"/posts/java/:11:1","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#date"},{"categories":null,"content":" SimpleDateFormate è¿™ä¸ªç±»çš„ä½œç”¨æ˜¯æ–¹ä¾¿æ ¼å¼åŒ–è¾“å‡ºæ—¥æœŸ java Date d = new Date(); long time = d.getTime(); SimpleDateFormate sdf = new SimpleDateFormate(\"yyyy-mm-dd HH-mm-ss EEE a\"); System.out.println(sdf.formate(d)); System.out.println(sdf.formate(time)); // æ—¥æœŸè½¬Date String dateStr = \"2002-10-26 10-24-45\" SimpleDateFormate sdf2 = new SimpleDateFormate(\"yyyy-mm-dd HH-mm-ss\"); Date d2 = sdf2.parse(dateStr); ","date":"2025-08-14","objectID":"/posts/java/:11:2","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#simpledateformate"},{"categories":null,"content":" Calendar æ–¹æ³• è¯´æ˜ public static Calendar getInstance() è·å¾—æ—¥å†å•ä¾‹ public int get(field) è·å¾—æ—¥å†æŸä¸ªå­—æ®µä¿¡æ¯ public final Date getTime() è·å¾—Dateå¯¹è±¡ public long getTimeinMillis() è·å¾—æ¯«ç§’æ•° public void set(field, value) ä¿®æ”¹æŸä¸ªå­—æ®µ public void add(field, value) å¢åŠ /å‡å°‘æŸä¸ªå­—æ®µ field æ˜¯ Calendar æä¾›çš„ä¸€ä¸ªæšä¸¾ç±»ï¼Œä¾‹å¦‚ Calendar.MONTH ","date":"2025-08-14","objectID":"/posts/java/:11:3","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#calendar"},{"categories":null,"content":" LocalDate è¡¨ç¤ºï¼šåªæœ‰æ—¥æœŸï¼ˆå¹´ã€æœˆã€æ—¥ï¼‰ï¼Œæ— æ—¶é—´ä¿¡æ¯ã€‚ å¸¸ç”¨æ–¹æ³•ï¼š java import java.time.LocalDate; LocalDate today = LocalDate.now(); // å½“å‰æ—¥æœŸ LocalDate birthday = LocalDate.of(2000, 5, 20); // æŒ‡å®šæ—¥æœŸ LocalDate parsed = LocalDate.parse(\"2025-08-08\"); // å­—ç¬¦ä¸²è§£æ LocalDate tomorrow = today.plusDays(1); // åŠ ä¸€å¤© LocalDate lastWeek = today.minusWeeks(1); // å‡ä¸€å‘¨ int year = today.getYear(); // è·å–å¹´ä»½ int dayOfMonth = today.getDayOfMonth(); // è·å–æ—¥ ","date":"2025-08-14","objectID":"/posts/java/:11:4","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#localdate"},{"categories":null,"content":" LocalTime è¡¨ç¤ºï¼šåªæœ‰æ—¶é—´ï¼ˆæ—¶ã€åˆ†ã€ç§’ã€çº³ç§’ï¼‰ï¼Œæ— æ—¥æœŸä¿¡æ¯ã€‚ å¸¸ç”¨æ–¹æ³•ï¼š java import java.time.LocalTime; LocalTime now = LocalTime.now(); // å½“å‰æ—¶é—´ LocalTime lunch = LocalTime.of(12, 30); // æŒ‡å®šæ—¶é—´ LocalTime parsed = LocalTime.parse(\"08:15:30\"); // å­—ç¬¦ä¸²è§£æ LocalTime nextHour = now.plusHours(1); // åŠ ä¸€å°æ—¶ int hour = now.getHour(); // è·å–å°æ—¶ int minute = now.getMinute(); // è·å–åˆ†é’Ÿ ","date":"2025-08-14","objectID":"/posts/java/:11:5","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#localtime"},{"categories":null,"content":" LocalDateTime è¡¨ç¤ºï¼šæ—¥æœŸ + æ—¶é—´ï¼Œä¸åŒ…å«æ—¶åŒºä¿¡æ¯ å¸¸ç”¨æ–¹æ³• java import java.time.LocalDateTime; LocalDateTime now = LocalDateTime.now(); // å½“å‰æ—¥æœŸæ—¶é—´ LocalDateTime meeting = LocalDateTime.of(2025, 8, 8, 14, 30); // æŒ‡å®šæ—¥æœŸæ—¶é—´ LocalDateTime parsed = LocalDateTime.parse(\"2025-08-08T14:30:00\"); LocalDateTime tomorrowSameTime = now.plusDays(1); // åŠ ä¸€å¤© LocalDate datePart = now.toLocalDate(); // æå–æ—¥æœŸéƒ¨åˆ† LocalTime timePart = now.toLocalTime(); // æå–æ—¶é—´éƒ¨åˆ† å®ƒä»¬éƒ½æ˜¯ ä¸å¯å˜å¯¹è±¡ï¼Œä»»ä½•åŠ å‡æ“ä½œéƒ½ä¼šè¿”å›æ–°çš„å®ä¾‹ã€‚ ","date":"2025-08-14","objectID":"/posts/java/:11:6","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#localdatetime"},{"categories":null,"content":" åŒ…è£…ç±» åŒ…è£…ç±»å°±æ˜¯æŠŠåŸºæœ¬ç±»å‹æ•°æ®åŒ…è£…æˆå¯¹è±¡ java // å®ä¾‹åŒ– Integer a1 = Integer.valueof(1); // è‡ªåŠ¨è£…ç®± Integer a2 = 1; // è‡ªåŠ¨æ‹†ç®± int a3 = a2; // æ³›å‹ä¸æ”¯æŒåŸºæœ¬ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦åŒ…è£…ç±» ArrayList\u003cInteger\u003e list = new ArrayList\u003cInteger\u003e(); list.add(1); int a4 = list.get(1); å­—ç¬¦ä¸²å’Œæ•°å­—çš„ç±»å‹è½¬æ¢ java Integer a = 12; String rs1 = Integer.toString(a); String rs2 = a.toString(); String rs3 = a + \"\"; java String ageStr = \"12\"; Integer a1 = Integer.ParseInt(ageStr); Integer a2 = Integer.valueof(ageStr); String scoreStr = \"12.5\"; Float f1 = Float.ParseFloat(scoreFloat); Float f2 = Float.valueof(scoreFloat); ","date":"2025-08-14","objectID":"/posts/java/:12:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#åŒ…è£…ç±»"},{"categories":null,"content":" è®¾è®¡æ¨¡å¼","date":"2025-08-14","objectID":"/posts/java/:13:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#è®¾è®¡æ¨¡å¼"},{"categories":null,"content":" å•ä¾‹æ¨¡å¼ æ‡’æ±‰å¼ java public class Singleton{ private static instance = new Singleton(); private Singleton(){} public GetInstance(){ return instance; } } é¥¿æ±‰å¼ java public class Singleton{ private static instance; private Singleton(){} public GetInstance(){ if (instance == null){ instance = new Singleton(); } return instance; } } ","date":"2025-08-14","objectID":"/posts/java/:13:1","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#å•ä¾‹æ¨¡å¼"},{"categories":null,"content":" æ¨¡æ¿æ–¹æ³• java public abstract class People{ public void func(){ // é‡å¤ä»»åŠ¡1 this.todo(); // é‡å¤ä»»åŠ¡2 } public abstract void todo(){} } public class Student{ @Override public void todo(){ // ... } } ","date":"2025-08-14","objectID":"/posts/java/:13:2","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æ¨¡æ¿æ–¹æ³•"},{"categories":null,"content":" æ³›å‹","date":"2025-08-14","objectID":"/posts/java/:14:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æ³›å‹"},{"categories":null,"content":" æ³›å‹ç±» java public class ArrayList\u003cE\u003e { private object[] objs = new object[10]; private int size = 0; private ArrayList(); public void add(E e){ objs[size++] = e; } public E get(int index){ return objs[index]; } } ","date":"2025-08-14","objectID":"/posts/java/:14:1","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æ³›å‹ç±»"},{"categories":null,"content":" æ³›å‹æ–¹æ³• java public static \u003cE extends Car\u003e go(ArrayList\u003cE\u003e car){ // ... } java public static void go(ArrayList\u003c? extends Car\u003e car){ // ... } ä¸Šé™: extends å­ç±»ä¸‹é™: super çˆ¶ç±» æ³›å‹æ“¦é™¤ï¼šæ³›å‹å·¥ä½œäºç¼–è¯‘é˜¶æ®µï¼Œå½“ä»£ç ç¼–è¯‘ä¸º class ä¹‹åå°±ä¸å­˜åœ¨æ³›å‹äº†ã€‚ æ³›å‹ä¸æ”¯æŒ Java çš„åŸºæœ¬ç±»å‹ï¼šint, floatç­‰ ","date":"2025-08-14","objectID":"/posts/java/:14:2","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æ³›å‹æ–¹æ³•"},{"categories":null,"content":" Lambda Lambda è¡¨è¾¾å¼åªèƒ½ç®€åŒ–å‡½æ•°å¼æ¥å£çš„åŒ¿åå†…éƒ¨ç±» java public interface Singer{ public void sing(); } Singer singer = () -\u003e { System.out.println(\"singer interface\"); }; ç®€åŒ– å¯ä»¥ä¸å†™ç±»å‹ åªæœ‰ä¸€ä¸ªå‚æ•°å¯ä»¥ä¸åŠ æ‹¬å· ","date":"2025-08-14","objectID":"/posts/java/:15:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#lambda"},{"categories":null,"content":" æ–¹æ³•å¼•ç”¨","date":"2025-08-14","objectID":"/posts/java/:16:0","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#æ–¹æ³•å¼•ç”¨"},{"categories":null,"content":" é™æ€æ–¹æ³•å¼•ç”¨ java public class compareByData { public static int compareTo(Student o1, Student o2){ return o1.getAge() - o2.getAge(); } } // Arrays.sort(students, (o1, o2) -\u003e compareByData.compareTo(o1, o2)); Arrays.sort(students, compareByData::compareTo); è¦æ±‚æ˜¯å‰åå‚æ•°ä¸€è‡´ ","date":"2025-08-14","objectID":"/posts/java/:16:1","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#é™æ€æ–¹æ³•å¼•ç”¨"},{"categories":null,"content":" å®ä¾‹æ–¹æ³•å¼•ç”¨ java public class compareByData { public int compareTo(Student o1, Student o2){ return o1.getAge() - o2.getAge(); } } compareByData cbd = new compareByData(); // Arrays.sort(students, (o1, o2) -\u003e cbd.compareTo(o1, o2)); Arrays.sort(students, cbd::compareTo); ","date":"2025-08-14","objectID":"/posts/java/:16:2","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#å®ä¾‹æ–¹æ³•å¼•ç”¨"},{"categories":null,"content":" ç‰¹å®šç±»å‹æ–¹æ³•å¼•ç”¨ java String names[] = {\"a\", \"b\", \"c\"}; // Arrays.sort(names, (o1, o2) -\u003e o1.compareToIgnore(o2)); Arrays.sort(names, String::compareToIgnore); ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦æ˜¯ä¸»è°ƒ ","date":"2025-08-14","objectID":"/posts/java/:16:3","series":["Java æŠ€å·§"],"tags":["ç¼–ç¨‹è¯­è¨€"],"title":"Java åŸºç¡€çŸ¥è¯†","uri":"/posts/java/#ç‰¹å®šç±»å‹æ–¹æ³•å¼•ç”¨"},{"categories":null,"content":" æ­£åœ¨åŠ è½½è¶³è¿¹... ä¸ç§¯è·¬æ­¥ï¼Œæ— ä»¥è‡³åƒé‡Œã€‚ ","date":"0001-01-01","objectID":"/footprint/:0:0","series":null,"tags":null,"title":"è¶³è¿¹","uri":"/footprint/#"}]